<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ChatOS Design v3</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f6f7fb;
      --card: #fff;
      --ink: #171923;
      --muted: #6b7280;
      --line: #e6e8ef;
      --brand: #2f6df6;
      --brand-soft: #eaf1ff;
      --ok: #10b981;
      --chat-bg: #ece9e1;
      --user: #dff1cd;
      --shadow: 0 8px 30px rgba(13, 19, 33, 0.06);
      --r-xl: 20px;
      --r-lg: 14px;
      --r-md: 10px;
    }
    * { box-sizing: border-box; }
    body { margin: 0; font-family: Manrope, sans-serif; color: var(--ink); background: var(--bg); }
    .shell { min-height: 100vh; display: grid; grid-template-columns: 74px 250px 1fr 330px; gap: 12px; padding: 12px; }
    .panel { background: var(--card); border: 1px solid var(--line); border-radius: var(--r-xl); box-shadow: var(--shadow); }
    .rail { padding: 10px 8px; display: flex; flex-direction: column; gap: 8px; align-items: center; }
    .ico { width: 48px; height: 48px; border-radius: 14px; border: 1px solid var(--line); display: grid; place-items: center; color: #71717a; font-size: 22px; background: #fff; }
    .ico.active { background: #a7c5f9; color: #fff; border-color: #a7c5f9; }
    .left { padding: 14px; display: flex; flex-direction: column; gap: 10px; }
    .agent-title { font-size: 34px; font-weight: 800; line-height: 1.03; }
    .status { color: #22c55e; font-size: 18px; font-weight: 600; }
    .stop { border: 1px solid var(--brand); background: #fff; border-radius: 12px; padding: 11px; font-weight: 700; font-size: 24px; cursor: pointer; }
    .nav, .add-menu { display: grid; gap: 6px; }
    .nav-btn, .add-btn { border-radius: 10px; padding: 10px 12px; border: 1px solid transparent; background: transparent; text-align: left; font-size: 19px; color: #3f4453; cursor: pointer; position: relative; }
    .nav-btn.active { background: #eef2ff; }
    .add-btn { border: 1px solid #edf0f5; background: #fff; }
    .add-btn:hover { border-color: #d8deea; background: #f8faff; }
    .badge { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: #ef4444; color: #fff; border-radius: 999px; font-size: 12px; padding: 1px 7px; font-weight: 700; }
    .left h4 { margin: 12px 0 2px; font-size: 23px; }
    .center { display: grid; grid-template-rows: auto 1fr auto; overflow: hidden; }
    .chat-head { padding: 14px 16px; border-bottom: 1px solid var(--line); display: flex; justify-content: space-between; align-items: center; }
    .chat-head .bot { font-size: 34px; font-weight: 800; }
    .chat-head .meta { font-size: 20px; color: #4b5563; }
    .chat-wrap { background: var(--chat-bg); padding: 16px; overflow: auto; display: grid; align-content: start; gap: 12px; }
    .row { display: flex; }
    .row.user { justify-content: flex-end; }
    .bubble { max-width: 80%; border: 1px solid var(--line); border-radius: 16px; padding: 14px 16px; font-size: 30px; line-height: 1.28; background: #fff; }
    .row.user .bubble { background: var(--user); border-color: #cde6b5; }
    .chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 2px; }
    .chip { border: 1px solid var(--line); background: #fff; border-radius: 999px; padding: 10px 14px; font-size: 24px; }
    .composer { background: #f8f9fc; border-top: 1px solid var(--line); padding: 10px 14px; display: grid; grid-template-columns: 1fr 56px; gap: 8px; }
    .composer input { border: 1px solid var(--line); border-radius: 999px; padding: 14px 16px; font: inherit; font-size: 22px; }
    .send { border: none; border-radius: 999px; background: var(--brand); color: #fff; font-size: 24px; font-weight: 800; }
    .right { padding: 14px; display: grid; grid-template-rows: auto 1fr auto; gap: 10px; }
    .suggestions { overflow: auto; display: grid; gap: 8px; }
    .q { border: 1px solid var(--line); border-radius: 12px; background: #fff; padding: 10px 12px; font-size: 17px; line-height: 1.3; }
    .kpis { border: 1px solid var(--line); border-radius: 12px; padding: 10px; }
    .kpis .t { font-size: 14px; color: var(--muted); }
    .kpis .v { font-size: 24px; font-weight: 800; }

    .overlay { position: fixed; inset: 0; background: rgba(10,16,30,.45); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
    .overlay.open { display: flex; }
    .modal { width: min(1120px, 96vw); max-height: 92vh; overflow: auto; background: #fff; border-radius: 24px; border: 1px solid var(--line); box-shadow: 0 20px 80px rgba(0,0,0,.2); padding: 20px; position: relative; }
    .x { position: absolute; right: 16px; top: 14px; width: 38px; height: 38px; border-radius: 999px; border: 1px solid var(--line); background: #f4f5f9; font-size: 22px; cursor: pointer; }
    .m-title { font-size: 56px; font-weight: 800; margin: 6px 0 14px; }
    .dropzone { border: 2px dashed #d7dbe6; border-radius: 22px; padding: 54px 24px; text-align: center; color: #6b7280; font-size: 22px; }
    .plus { width: 82px; height: 82px; border-radius: 18px; background: #f1f3f9; border: none; font-size: 52px; margin-bottom: 16px; }
    .txt { border: 1px solid #d8deea; border-radius: 18px; min-height: 420px; padding: 18px; font-size: 26px; color: #9aa0ac; position: relative; }
    .voice { position: absolute; right: 20px; bottom: 20px; width: 78px; height: 78px; border-radius: 18px; border: 1px solid var(--line); background: #f3f5fb; font-size: 34px; }
    .m-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-top: 16px; }
    .m-btn { border-radius: 16px; border: 1px solid #d5d9e5; background: #fff; font-size: 48px; padding: 14px; }
    .m-btn.primary { background: #f0f1f7; color: #9ea3b3; }
    .rules-suggest { margin-top: 14px; display: grid; gap: 10px; }
    .rs-item { border: 1px solid var(--line); border-radius: 14px; background: #f7f8fb; padding: 14px; font-size: 18px; }
    .kb-table { border: 1px solid var(--line); border-radius: 14px; overflow: hidden; margin-top: 8px; }
    .kb-row { display: grid; grid-template-columns: 1.6fr .7fr .9fr auto; gap: 10px; padding: 10px 12px; border-bottom: 1px solid var(--line); font-size: 16px; }
    .kb-row:last-child { border-bottom: none; }
    .kb-add { border: 1px solid #d6dbeb; background: #fff; border-radius: 10px; padding: 6px 10px; }

    @media (max-width: 1200px) {
      .shell { grid-template-columns: 62px 220px 1fr; }
      .right { display: none; }
      .bubble { font-size: 22px; }
      .chip { font-size: 18px; }
      .m-title { font-size: 36px; }
      .m-btn { font-size: 32px; }
    }
    @media (max-width: 820px) {
      .shell { grid-template-columns: 1fr; }
      .rail, .left { display: none; }
      .modal { padding: 14px; }
      .m-title { font-size: 28px; }
      .txt { min-height: 260px; font-size: 20px; }
      .m-btn { font-size: 24px; }
    }
  </style>
</head>
<body>
  <div class="shell">
    <aside class="panel rail">
      <div class="ico active">–ü</div>
      <div class="ico">‚åÇ</div>
      <div class="ico">‚ò∞</div>
      <div class="ico">‚¶ø</div>
      <div class="ico">‚óå</div>
      <div class="ico">‚öô</div>
    </aside>

    <aside class="panel left">
      <div class="agent-title">–ò–ò-–∞–≥–µ–Ω—Ç</div>
      <div class="status">‚óè –ê–∫—Ç–∏–≤–µ–Ω</div>
      <button class="stop">–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>

      <div class="nav">
        <button class="nav-btn">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
        <button class="nav-btn active">‚ñ∑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
        <button class="nav-btn">üìñ –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</button>
        <button class="nav-btn">‚ùì –ë–µ–∑ –æ—Ç–≤–µ—Ç–æ–≤ <span class="badge">14</span></button>
      </div>

      <h4>–î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</h4>
      <div class="add-menu">
        <button class="add-btn" data-action="upload-file">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã</button>
        <button class="add-btn" data-action="add-link">üîó –î–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É</button>
        <button class="add-btn" data-action="add-text">‚úç –ù–∞–ø–∏—Å–∞—Ç—å –≤—Ä—É—á–Ω—É—é</button>
        <button class="add-btn" data-action="rules">üìè –ü—Ä–∞–≤–∏–ª–∞ –æ–±—â–µ–Ω–∏—è</button>
        <button class="add-btn" data-action="kb-status">üîç –°—Ç–∞—Ç—É—Å KB</button>
      </div>

      <div class="kpis">
        <div class="t">–ò–ò-–∑–∞–ø—Ä–æ—Å—ã</div>
        <div class="v">15196</div>
        <div class="t">–û—Å—Ç–∞–ª–æ—Å—å</div>
      </div>
    </aside>

    <main class="panel center">
      <div class="chat-head">
        <div>
          <div class="bot">@PitchHunterbot</div>
          <div class="meta">Bot: GulDokonu ¬∑ üóÉ KB: 3 ¬∑ ‚úà TG: –ø–æ–¥–∫–ª—é—á—ë–Ω</div>
        </div>
        <div class="chip">ChatOS</div>
      </div>

      <section class="chat-wrap">
        <div class="row user"><div class="bubble">–¥–∞–≤–∞–π –ø—Ä–æ –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–µ</div></div>
        <div class="row"><div class="bubble">–ö–∞–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤—ã —Ö–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π?</div></div>
        <div class="row user"><div class="bubble">–•–æ—á—É –¥–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π –±–æ—Ç–∞</div></div>
        <div class="row"><div class="bubble">–û—Ç–ª–∏—á–Ω–æ, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É, –∫–æ—Ç–æ—Ä—É—é –≤—ã —Ö–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π.</div></div>

        <div class="chips">
          <button class="chip" data-action="upload-file">üìé –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</button>
          <button class="chip" data-action="add-link">üîó –î–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É</button>
          <button class="chip" data-action="telegram">‚úà Telegram</button>
          <button class="chip" data-action="test">üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
          <button class="chip" data-action="kb-status">üîç –°—Ç–∞—Ç—É—Å KB</button>
        </div>
      </section>

      <div class="composer">
        <input id="v3-input" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" />
        <button class="send" id="v3-send">‚û§</button>
      </div>
    </main>

    <aside class="panel right">
      <h3 style="margin:4px 0 0;font-size:22px;">–ú–æ–∂–µ—Ç–µ –Ω–∞—á–∞—Ç—å —Å —ç—Ç–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤</h3>
      <div class="suggestions">
        <div class="q">–ß—Ç–æ —ç—Ç–æ –∑–∞ –∞–∫–∫–∞—É–Ω—Ç?</div>
        <div class="q">–ö–∞–∫–∏–µ –æ—Å–Ω–æ–≤–Ω—ã–µ –∑–∞–¥–∞—á–∏ —Ä–µ—à–∞–µ—Ç —ç—Ç–æ—Ç –∞–∫–∫–∞—É–Ω—Ç?</div>
        <div class="q">–ö–∞–∫ —É—Å—Ç—Ä–æ–µ–Ω–∞ –º–µ—Ç–æ–¥–∏–∫–∞ –æ—Ü–µ–Ω–∫–∏ —Å—Ç–∞—Ä—Ç–∞–ø–æ–≤?</div>
        <div class="q">–ö–∞–∫ –≤—ã–≥–ª—è–¥–∏—Ç —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –ø–æ–¥–∞–Ω–Ω—ã–π —Å—Ç–∞—Ä—Ç–∞–ø?</div>
        <div class="q">–ö–∞–∫–∏–µ —Ä–∏—Å–∫–∏ –æ—Ü–µ–Ω–∏–≤–∞—é—Ç—Å—è?</div>
      </div>
      <div style="color:#6b7280;font-size:14px;">–≠—Ç–∏ –≤–æ–ø—Ä–æ—Å—ã —Å–æ—Å—Ç–∞–≤–ª–µ–Ω—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –≤–∞—à–µ–π <b>–ë–∞–∑—ã –∑–Ω–∞–Ω–∏–π</b>.</div>
    </aside>
  </div>

  <div class="overlay" id="modal-files">
    <div class="modal">
      <button class="x" data-close>√ó</button>
      <div class="m-title">–ß—Ç–æ —Ö–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å?</div>
      <div class="dropzone">
        <button class="plus">+</button><br>
        <b style="color:#245de6">–ó–∞–≥—Ä—É–∑–∏—Ç–µ</b> –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã –≤ —ç—Ç—É –æ–±–ª–∞—Å—Ç—å.<br>
        DOCX, XLS –∏–ª–∏ PDF, –Ω–µ –±–æ–ª—å—à–µ 30MB.
      </div>
    </div>
  </div>

  <div class="overlay" id="modal-text">
    <div class="modal">
      <button class="x" data-close>√ó</button>
      <div class="m-title">–ß—Ç–æ —Ö–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å?</div>
      <div class="txt"><textarea id="modal-text-content" style="width:100%;min-height:360px;border:0;outline:none;background:transparent;font:inherit;font-size:24px;color:#1f2937;resize:vertical;" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –∏–ª–∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç"></textarea>
        <button class="voice">üé§</button>
      </div>
      <div class="m-actions">
        <button class="m-btn" data-close>–û—Ç–º–µ–Ω–∏—Ç—å</button>
        <button class="m-btn primary" id="modal-text-save">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="modal-link">
    <div class="modal">
      <button class="x" data-close>√ó</button>
      <div class="m-title">–î–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É</div>
      <div class="txt">
        <input id="modal-link-url" type="url" placeholder="https://example.com" style="width:100%;height:62px;border:1px solid #d8deea;border-radius:14px;padding:0 16px;font:inherit;font-size:24px;">
      </div>
      <div class="m-actions">
        <button class="m-btn" data-close>–û—Ç–º–µ–Ω–∏—Ç—å</button>
        <button class="m-btn primary" id="modal-link-save">–î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="modal-rules">
    <div class="modal">
      <button class="x" data-close>√ó</button>
      <div class="m-title">–î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –æ–±—â–µ–Ω–∏—è</div>
      <div class="txt" style="color:#171923; font-size:20px;">
        <textarea id="modal-rules-content" style="width:100%;min-height:300px;border:0;outline:none;background:transparent;font:inherit;font-size:20px;color:#171923;resize:vertical;" placeholder="–û–ø–∏—à–∏—Ç–µ, –∫–∞–∫ –±–æ—Ç –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—á–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º..."></textarea>
        <button class="voice">üé§</button>
      </div>
      <div style="margin-top:14px; color:#6b7280; font-size:17px;">–û–±—ã—á–Ω–æ –¥–æ–±–∞–≤–ª—è—é—Ç</div>
      <div class="rules-suggest">
        <div class="rs-item">üîó –í—ã–¥–∞–π —Å—Å—ã–ª–∫—É –Ω–∞ ..., –µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–¥–ø–∏—Å–∫–∞</div>
        <div class="rs-item">üí¨ –û—Ç–≤–µ—á–∞–π –∫–∞–∫ –º–µ–Ω–µ–¥–∂–µ—Ä —Å–∞–ª–æ–Ω–∞</div>
        <div class="rs-item">‚è± –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç, –Ω–∞–ø–æ–º–Ω–∏ –æ —Å–µ–±–µ —á–µ—Ä–µ–∑ 15 –º–∏–Ω—É—Ç</div>
        <div class="rs-item">üíµ –ï—Å–ª–∏ –∫–ª–∏–µ–Ω—Ç —Å–ø—Ä–æ—Å–∏–ª –ø—Ä–æ —Ü–µ–Ω—ã, —É—Ç–æ—á–Ω–∏ –≥–æ—Ä–æ–¥</div>
      </div>
      <div class="m-actions">
        <button class="m-btn" data-close>–û—Ç–º–µ–Ω–∏—Ç—å</button>
        <button class="m-btn primary" id="modal-rules-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="modal-kb-status">
    <div class="modal" style="width:min(1200px,97vw)">
      <button class="x" data-close>√ó</button>
      <div class="m-title">–í—Å–µ –∑–∞–ø—Ä–æ—Å—ã 14</div>
      <div class="kb-table">
        <div class="kb-row" style="font-weight:700;background:#f8f9fc;"><div>–ó–∞–ø—Ä–æ—Å</div><div>–ö–æ–ª-–≤–æ —á–∞—Ç–æ–≤</div><div>–ü–æ—Å–ª–µ–¥–Ω–∏–π –æ—Ç–≤–µ—Ç</div><div></div></div>
        <div class="kb-row"><div>How do I start using this bot and begin a session?</div><div>20 —á–∞—Ç–æ–≤</div><div>46 –º–∏–Ω—É—Ç –Ω–∞–∑–∞–¥</div><button class="kb-add">–î–æ–±–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç</button></div>
        <div class="kb-row"><div>–ö–∞–∫ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å—Ñ–æ—Ä–º—É–ª–∏—Ä–æ–≤–∞—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ?</div><div>1 —á–∞—Ç</div><div>5 —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥</div><button class="kb-add">–î–æ–±–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç</button></div>
        <div class="kb-row"><div>Salom, hozir sizga qanday yordam berishimni ayta olasizmi?</div><div>2 —á–∞—Ç–∞</div><div>–≤—á–µ—Ä–∞</div><button class="kb-add">–î–æ–±–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç</button></div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const bridge = (window.parent && window.parent !== window && window.parent.ChatOSBridge)
        ? window.parent.ChatOSBridge
        : null;
      const openers = document.querySelectorAll('[data-open]');
      const actionBtns = document.querySelectorAll('[data-action]');
      const closers = document.querySelectorAll('[data-close]');
      const overlays = document.querySelectorAll('.overlay');
      const chatInput = document.getElementById('v3-input');
      const chatSend = document.getElementById('v3-send');
      const textSave = document.getElementById('modal-text-save');
      const linkSave = document.getElementById('modal-link-save');
      const rulesSave = document.getElementById('modal-rules-save');

      function closeAll() {
        overlays.forEach(o => o.classList.remove('open'));
      }

      openers.forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-open');
          const modal = document.getElementById(id);
          if (!modal) return;
          closeAll();
          modal.classList.add('open');
        });
      });

      async function runAction(action) {
        if (!action) return;
        if (action === 'upload-file') {
          if (bridge?.openKbFile) { await bridge.openKbFile(); return; }
          document.getElementById('modal-files')?.classList.add('open');
          return;
        }
        if (action === 'add-link') {
          document.getElementById('modal-link')?.classList.add('open');
          return;
        }
        if (action === 'add-text') {
          document.getElementById('modal-text')?.classList.add('open');
          return;
        }
        if (action === 'rules') {
          document.getElementById('modal-rules')?.classList.add('open');
          return;
        }
        if (action === 'kb-status') {
          if (bridge?.showKbStatus) { await bridge.showKbStatus(); return; }
          document.getElementById('modal-kb-status')?.classList.add('open');
          return;
        }
        if (action === 'telegram') {
          if (bridge?.openTelegram) { await bridge.openTelegram(); return; }
          return;
        }
        if (action === 'test') {
          if (bridge?.openTestMode) { await bridge.openTestMode(); return; }
          return;
        }
      }

      actionBtns.forEach(btn => {
        btn.addEventListener('click', () => {
          const action = btn.getAttribute('data-action');
          runAction(action);
        });
      });

      if (chatSend) {
        chatSend.addEventListener('click', async () => {
          const text = (chatInput?.value || '').trim();
          if (!text) return;
          if (bridge?.sendMessage) {
            await bridge.sendMessage(text);
            chatInput.value = '';
          }
        });
      }
      if (chatInput) {
        chatInput.addEventListener('keydown', async (e) => {
          if (e.key === 'Enter') {
            e.preventDefault();
            chatSend?.click();
          }
        });
      }

      if (textSave) {
        textSave.addEventListener('click', async () => {
          const text = (document.getElementById('modal-text-content')?.value || '').trim();
          if (text.length < 10) return;
          if (bridge?.addKbText) {
            const ok = await bridge.addKbText(text);
            if (ok) closeAll();
          }
        });
      }

      if (linkSave) {
        linkSave.addEventListener('click', async () => {
          const url = (document.getElementById('modal-link-url')?.value || '').trim();
          if (!url) return;
          if (bridge?.addKbLink) {
            const ok = await bridge.addKbLink(url);
            if (ok) closeAll();
          }
        });
      }

      if (rulesSave) {
        rulesSave.addEventListener('click', async () => {
          const text = (document.getElementById('modal-rules-content')?.value || '').trim();
          if (!text) return;
          if (bridge?.saveRules) {
            const ok = await bridge.saveRules(text);
            if (ok) closeAll();
          }
        });
      }

      closers.forEach(btn => btn.addEventListener('click', closeAll));
      overlays.forEach(ov => {
        ov.addEventListener('click', (e) => {
          if (e.target === ov) closeAll();
        });
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeAll();
      });
    })();
  </script>
</body>
</html>
