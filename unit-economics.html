<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–ü—Ä–∞–π—Å–µ—Ä ‚Äî –î–∞—à–±–æ—Ä–¥</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='22' fill='%236366f1'/><text y='74' x='50' text-anchor='middle' font-size='58' font-family='system-ui'>üè∑</text></svg>" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #0a0c12;
      color: #e2e8f0;
      min-height: 100vh;
      padding-left: 0;
    }

    /* ‚îÄ‚îÄ Left Sidebar Rail ‚îÄ‚îÄ */

    /* ‚îÄ‚îÄ Shipment history cards ‚îÄ‚îÄ */
    .shipment-list { padding: 0 10px 10px; display: flex; flex-direction: column; gap: 6px; }
    .shipment-card {
      background: #0b0e1a; border: 1px solid #1e2235; border-radius: 10px;
      padding: 10px 12px; cursor: pointer; transition: border-color 0.15s;
    }
    .shipment-card:hover { border-color: rgba(99,102,241,0.5); }
    .shipment-card-head { display: flex; align-items: center; justify-content: space-between; margin-bottom: 3px; }
    .shipment-badge {
      display: inline-flex; align-items: center; gap: 5px;
      font-size: 0.67rem; font-weight: 700;
    }
    .shipment-badge::before { content: ''; width: 6px; height: 6px; border-radius: 50%; background: currentColor; flex-shrink: 0; }
    .shipment-badge.active   { color: #22c55e; }
    .shipment-badge.cancelled { color: #ef4444; }
    .shipment-num { font-size: 0.7rem; color: #4f5a7a; font-weight: 700; }
    .shipment-date { font-size: 0.7rem; color: #64748b; margin-bottom: 2px; }
    .shipment-meta { font-size: 0.72rem; color: #94a3b8; }
    .shipment-empty { font-size: 0.78rem; color: #4f5a7a; text-align: center; padding: 24px 10px; line-height: 1.5; }
    [data-theme="light"] .shipment-card { background: #f8fafc; border-color: #e2e8f0; }
    [data-theme="light"] .shipment-card:hover { border-color: rgba(99,102,241,0.4); }
    [data-theme="light"] .shipment-date { color: #94a3b8; }
    [data-theme="light"] .shipment-meta { color: #64748b; }
    [data-theme="light"] .shipment-empty { color: #94a3b8; }

    /* ‚îÄ‚îÄ Header ‚îÄ‚îÄ */
    .header {
      background: #111422;
      border-bottom: 1px solid #1e2235;
      padding: 0 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      height: 56px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .logo {
      width: 34px; height: 34px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      border-radius: 9px;
      display: flex; align-items: center; justify-content: center;
      font-size: 16px; flex-shrink: 0;
    }
    .header h1 { font-size: 1rem; font-weight: 700; }

    .header-nav {
      display: flex;
      gap: 2px;
      margin-left: 28px;
    }
    .htab {
      padding: 7px 18px;
      border-radius: 8px;
      font-size: 0.82rem;
      font-weight: 600;
      cursor: pointer;
      border: none;
      background: transparent;
      color: #4f5a7a;
      transition: all 0.2s;
    }
    .htab.active {
      background: rgba(99,102,241,0.18);
      color: #818cf8;
    }
    .htab:hover:not(.active) { color: #94a3b8; }

    .header-right { margin-left: auto; }
    .header-sub { font-size: 0.75rem; color: #4f5a7a; }

    /* ‚îÄ‚îÄ KPI Strip ‚îÄ‚îÄ */
    .kpi-strip {
      background: #0d0f1a;
      border-bottom: 1px solid #1e2235;
      padding: 0 24px;
      display: grid;
      grid-template-columns: repeat(8, 1fr);
    }
    .kpi-card {
      padding: 12px 16px;
      border-right: 1px solid #1e2235;
      display: flex;
      flex-direction: column;
      gap: 3px;
    }
    .kpi-card:last-child { border-right: none; }
    .kpi-label {
      font-size: 0.62rem;
      color: #4f5a7a;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .kpi-value {
      font-size: 1rem;
      font-weight: 800;
      line-height: 1.2;
    }
    .kpi-sub {
      font-size: 0.65rem;
      color: #2d3455;
    }
    .kpi-cyan   { color: #06b6d4; }
    .kpi-yellow { color: #f59e0b; }
    .kpi-purple { color: #6366f1; }
    .kpi-green  { color: #22c55e; }
    .kpi-pink   { color: #ec4899; }
    .kpi-indigo { color: #818cf8; }

    /* ‚îÄ‚îÄ Page wrapper ‚îÄ‚îÄ */
    .page { padding: 20px 24px; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    /* ‚îÄ‚îÄ Shared input styles ‚îÄ‚îÄ */
    input[type="number"], input[type="text"] {
      width: 100%;
      background: #0a0c12;
      border: 1px solid #1e2235;
      border-radius: 9px;
      color: #e2e8f0;
      font-size: 0.88rem;
      padding: 9px 12px;
      outline: none;
      transition: border-color 0.2s;
    }
    input[type="number"] { -moz-appearance: textfield; appearance: textfield; }
    input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; }
    input:focus { border-color: #6366f1; }
    .badge {
      background: #1e2235;
      border-radius: 8px;
      padding: 9px 10px;
      font-size: 0.72rem;
      color: #4f5a7a;
      white-space: nowrap;
      flex-shrink: 0;
    }
    .input-row { display: flex; gap: 6px; }

    /* ‚îÄ‚îÄ Cards ‚îÄ‚îÄ */
    .card {
      background: #111422;
      border: 1px solid #1e2235;
      border-radius: 16px;
      padding: 20px 24px;
      margin-bottom: 20px;
    }
    .card-title {
      font-size: 0.72rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #6366f1;
      margin-bottom: 16px;
    }

    /* ‚îÄ‚îÄ Params ‚îÄ‚îÄ */
    .params-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 14px;
    }
    .param-field label {
      display: block;
      font-size: 0.75rem;
      color: #64748b;
      margin-bottom: 5px;
    }
    .margin-selector { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
    .margin-btn {
      padding: 5px 12px;
      border-radius: 8px;
      font-size: 0.78rem;
      font-weight: 700;
      cursor: pointer;
      border: 1px solid #2d3455;
      background: transparent;
      color: #64748b;
      transition: all 0.2s;
    }
    .margin-btn.active { background: #6366f1; border-color: #6366f1; color: #fff; }

    /* ‚îÄ‚îÄ Products table ‚îÄ‚îÄ */
    .products-card {
      background: #111422;
      border: 1px solid #1e2235;
      border-radius: 16px;
      overflow: hidden;
      margin-bottom: 20px;
    }
    .products-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      border-bottom: 1px solid #1e2235;
    }
    .products-header h2 {
      font-size: 0.72rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #6366f1;
    }
    .btn-add {
      display: flex; align-items: center; gap: 6px;
      background: rgba(99,102,241,0.12);
      border: 1px solid rgba(99,102,241,0.3);
      border-radius: 8px;
      padding: 7px 14px;
      color: #818cf8;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-add:hover { background: rgba(99,102,241,0.2); }
    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
    thead th {
      background: #0a0c14;
      color: #4f5a7a;
      font-size: 0.66rem;
      font-weight: 700;
      letter-spacing: 0.07em;
      text-transform: uppercase;
      padding: 9px 10px;
      text-align: left;
      border-bottom: 2px solid #1e2235;
      white-space: nowrap;
    }
    tbody tr { border-bottom: 1px solid #161928; }
    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: rgba(99,102,241,0.06) !important; }
    td { padding: 5px 10px; vertical-align: middle; }
    td input[type="text"], td input[type="number"] {
      padding: 4px 8px; font-size: 0.82rem;
      background: transparent; border-color: transparent; border-radius: 6px;
      transition: background 0.15s, border-color 0.15s;
    }
    td input[type="text"]:hover, td input[type="number"]:hover {
      background: rgba(99,102,241,0.07); border-color: rgba(99,102,241,0.25);
    }
    td input[type="text"]:focus, td input[type="number"]:focus {
      background: rgba(99,102,241,0.11); border-color: #6366f1;
    }
    td input[type="text"] { min-width: 160px; }
    td input[type="number"] { min-width: 100px; }
    /* Name/code ghost inputs handled by .product-card-info rules above */
    /* Row actions: hidden until hover */
    .row-actions { opacity: 0; transition: opacity 0.18s; }
    tbody tr:hover .row-actions { opacity: 1; }
    /* Sticky header */
    thead th { position: sticky; top: 0; z-index: 4; }

    .col-result { font-weight: 700; white-space: nowrap; color: #e2e8f0; font-size: 0.83rem; }
    .col-price  { font-weight: 800; color: #6366f1; white-space: nowrap; font-size: 0.92rem; }
    .col-profit { font-weight: 700; white-space: nowrap; }
    .col-profit.pos { color: #22c55e; }
    .col-profit.neg { color: #ef4444; }
    /* ‚îÄ‚îÄ Row grouping ‚îÄ‚îÄ */
    tbody tr.group-first td,
    tbody tr.group-middle td,
    tbody tr.group-last  td { background: rgba(99,102,241,0.028); }
    tbody tr.group-first { border-top: 1px solid rgba(99,102,241,0.22) !important; }
    tbody tr.group-last  { border-bottom: 2px solid rgba(99,102,241,0.22) !important; }
    tbody tr.group-first td:nth-child(1),
    tbody tr.group-middle td:nth-child(1),
    tbody tr.group-last  td:nth-child(1) { border-left: 3px solid rgba(99,102,241,0.5); }
    tbody tr.group-child .row-num { color: #818cf8 !important; font-size: 1rem; line-height: 1; }
    .group-count {
      display: block; font-size: 0.58rem; font-weight: 800;
      color: #6366f1; letter-spacing: 0; line-height: 1.2; margin-top: 2px;
    }
    input.group-hidden { opacity: 0 !important; pointer-events: none; }
    /* Group collapse toggle */
    .group-toggle {
      display: block; margin-top: 4px;
      background: rgba(99,102,241,0.12); border: 1px solid rgba(99,102,241,0.28);
      border-radius: 5px; padding: 2px 7px;
      font-size: 0.6rem; font-weight: 700; color: #818cf8;
      cursor: pointer; white-space: nowrap; transition: background 0.15s;
    }
    .group-toggle:hover { background: rgba(99,102,241,0.26); }
    /* When group is collapsed, show bottom border on first row */
    tbody tr.group-first.group-collapsed { border-bottom: 2px solid rgba(99,102,241,0.22) !important; }
    [data-theme="light"] tbody tr.group-first.group-collapsed { border-bottom-color: rgba(99,102,241,0.3) !important; }
    [data-theme="light"] tbody tr.group-first td,
    [data-theme="light"] tbody tr.group-middle td,
    [data-theme="light"] tbody tr.group-last  td { background: rgba(99,102,241,0.04); }
    [data-theme="light"] tbody tr.group-first { border-top-color: rgba(99,102,241,0.3) !important; }
    [data-theme="light"] tbody tr.group-last  { border-bottom-color: rgba(99,102,241,0.3) !important; }

    .btn-del {
      background: none; border: none;
      color: #2d3455; font-size: 16px;
      cursor: pointer; padding: 4px 6px;
      transition: color 0.2s; border-radius: 6px;
    }
    .btn-del:hover { color: #ef4444; background: rgba(239,68,68,0.08); }
    .btn-edit {
      background: none; border: none;
      color: #2d3455; font-size: 13px;
      cursor: pointer; padding: 4px 6px;
      transition: all 0.2s; border-radius: 6px;
    }
    .btn-edit:hover { color: #6366f1; background: rgba(99,102,241,0.1); }
    .row-actions { display: flex; gap: 2px; align-items: center; }
    .empty-table { text-align: center; padding: 40px; color: #2d3455; font-size: 0.85rem; }

    /* ‚îÄ‚îÄ Bulk edit ‚îÄ‚îÄ */
    .bulk-card {
      background: #111422;
      border: 1px solid rgba(99,102,241,0.25);
      border-radius: 16px;
      padding: 16px 20px;
      margin-bottom: 20px;
    }
    .bulk-title {
      font-size: 0.72rem; font-weight: 700;
      letter-spacing: 0.1em; text-transform: uppercase;
      color: #8b5cf6; margin-bottom: 14px;
    }
    .bulk-row { display: flex; flex-wrap: wrap; gap: 16px; align-items: flex-end; }
    .bulk-group { display: flex; flex-direction: column; gap: 6px; }
    .bulk-label { font-size: 0.75rem; color: #64748b; }
    .bulk-inputs { display: flex; gap: 6px; align-items: center; }
    .bulk-inputs input { width: 110px; }
    .bulk-btn {
      padding: 8px 14px;
      background: rgba(99,102,241,0.15);
      border: 1px solid rgba(99,102,241,0.3);
      border-radius: 8px;
      color: #818cf8;
      font-size: 0.78rem; font-weight: 700;
      cursor: pointer; white-space: nowrap;
      transition: all 0.2s;
    }
    .bulk-btn:hover { background: rgba(99,102,241,0.3); }
    .bulk-sep { width: 1px; height: 40px; background: #1e2235; align-self: flex-end; flex-shrink: 0; }

    /* ‚îÄ‚îÄ Action buttons ‚îÄ‚îÄ */
    .actions { display: flex; gap: 12px; flex-wrap: wrap; }
    .btn-calc {
      flex: 1; min-width: 180px;
      padding: 13px 20px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      border: none; border-radius: 11px;
      color: #fff; font-size: 0.92rem; font-weight: 700;
      cursor: pointer; transition: opacity 0.2s, transform 0.1s;
    }
    .btn-calc:hover { opacity: 0.9; }
    .btn-calc:active { transform: scale(0.98); }
    .btn-export {
      padding: 13px 20px;
      background: transparent;
      border: 1px solid #2d3455;
      border-radius: 11px;
      color: #64748b; font-size: 0.88rem; font-weight: 600;
      cursor: pointer; transition: all 0.2s;
    }
    .btn-export:hover { border-color: #4f5a7a; color: #94a3b8; }

    /* ‚îÄ‚îÄ Analytics tab ‚îÄ‚îÄ */
    .analytics-empty {
      text-align: center;
      padding: 100px 40px;
      color: #2d3455;
    }
    .analytics-empty .big-icon { font-size: 3.5rem; margin-bottom: 16px; opacity: 0.4; }

    /* Insight cards */
    .insights-row {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }
    .insight-card {
      background: #111422;
      border: 1px solid #1e2235;
      border-radius: 16px;
      padding: 18px 20px;
    }
    .insight-label {
      font-size: 0.65rem;
      color: #4f5a7a;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 8px;
    }
    .insight-name {
      font-size: 0.8rem;
      font-weight: 600;
      color: #94a3b8;
      margin-bottom: 6px;
      line-height: 1.4;
      min-height: 2.2em;
    }
    .insight-value { font-size: 1.15rem; font-weight: 800; }
    .insight-value.green  { color: #22c55e; }
    .insight-value.red    { color: #ef4444; }
    .insight-value.purple { color: #818cf8; }

    /* Charts grid */
    .charts-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }
    .chart-card {
      background: #111422;
      border: 1px solid #1e2235;
      border-radius: 16px;
      padding: 20px;
    }
    .chart-card.span2 { grid-column: 1 / -1; }
    .chart-title {
      font-size: 0.72rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #6366f1;
      margin-bottom: 16px;
    }
    .chart-wrap { position: relative; height: 280px; }
    .chart-wrap.tall { height: 360px; }

    /* ‚îÄ‚îÄ Add Product Modal ‚îÄ‚îÄ */
    .add-modal-overlay {
      display: none;
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.7);
      z-index: 200;
      align-items: center; justify-content: center;
      backdrop-filter: blur(6px);
      padding: 20px;
    }
    .add-modal-overlay.open { display: flex; }
    .add-modal {
      background: #111422;
      border: 1px solid #2d3455;
      border-radius: 20px;
      width: 100%; max-width: 520px;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 32px 80px rgba(0,0,0,0.7);
      animation: modalIn 0.2s ease;
    }
    .add-modal-head {
      display: flex; align-items: center; justify-content: space-between;
      padding: 20px 24px;
      border-bottom: 1px solid #1e2235;
    }
    .add-modal-head h3 { font-size: 1rem; font-weight: 700; }
    .add-modal-close {
      background: none; border: none; color: #4f5a7a;
      font-size: 1.3rem; cursor: pointer; line-height: 1;
      padding: 4px 8px; border-radius: 6px; transition: all 0.15s;
    }
    .add-modal-close:hover { color: #e2e8f0; background: #1e2235; }
    .add-modal-body { padding: 22px 24px; display: flex; flex-direction: column; gap: 18px; }

    /* Photo upload */
    .photo-upload-area {
      border: 2px dashed #2d3455;
      border-radius: 14px;
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
      min-height: 120px;
      display: flex; align-items: center; justify-content: center; flex-direction: column; gap: 8px;
    }
    .photo-upload-area:hover { border-color: #6366f1; background: rgba(99,102,241,0.04); }
    .photo-upload-area.drag-over { border-color: #6366f1; background: rgba(99,102,241,0.08); }
    .photo-upload-area input[type="file"] { display: none; }
    .photo-upload-icon { font-size: 1.8rem; }
    .photo-upload-text { font-size: 0.82rem; color: #4f5a7a; }
    .photo-upload-hint { font-size: 0.72rem; color: #2d3455; }
    .photo-preview {
      display: none;
      position: relative;
    }
    .photo-preview img {
      width: 100%; max-height: 180px;
      object-fit: cover; border-radius: 10px;
    }
    .photo-preview-remove {
      position: absolute; top: 6px; right: 6px;
      background: rgba(0,0,0,0.7); border: none; border-radius: 50%;
      width: 26px; height: 26px; color: #fff; font-size: 14px;
      cursor: pointer; display: flex; align-items: center; justify-content: center;
      transition: background 0.15s;
    }
    .photo-preview-remove:hover { background: #ef4444; }

    /* Form fields */
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .form-field { display: flex; flex-direction: column; gap: 6px; }
    .form-field label { font-size: 0.75rem; color: #64748b; font-weight: 500; }
    .form-field.full { grid-column: 1 / -1; }

    /* Size chips */
    .size-section { display: flex; flex-direction: column; gap: 10px; }
    .size-label {
      font-size: 0.75rem; color: #64748b; font-weight: 500;
      display: flex; align-items: center; justify-content: space-between;
    }
    .size-manage-btn {
      font-size: 0.7rem; color: #6366f1; background: none; border: none; cursor: pointer;
      text-decoration: underline; text-underline-offset: 2px;
    }
    .size-chips { display: flex; flex-wrap: wrap; gap: 8px; align-items: center; }
    .size-chip {
      display: flex; align-items: center; gap: 5px;
      padding: 6px 12px;
      border-radius: 8px;
      border: 1px solid #2d3455;
      background: transparent;
      color: #64748b;
      font-size: 0.8rem; font-weight: 600;
      cursor: pointer; transition: all 0.15s;
      user-select: none;
    }
    .size-chip:hover { border-color: #6366f1; color: #818cf8; }
    .size-chip.selected { background: rgba(99,102,241,0.18); border-color: #6366f1; color: #c7d2fe; }
    .size-chip-del {
      font-size: 11px; color: #2d3455; line-height: 1;
      background: none; border: none; cursor: pointer;
      display: none; /* shown when manage mode */
      width: 14px; height: 14px; border-radius: 50%;
      align-items: center; justify-content: center;
      transition: all 0.15s;
    }
    .size-chip-del:hover { background: #ef4444; color: #fff; }
    .manage-mode .size-chip-del { display: flex; }
    .manage-mode .size-chip { border-color: rgba(239,68,68,0.3); }
    .size-add-row { display: flex; gap: 8px; align-items: center; margin-top: 2px; }
    .size-add-input {
      width: 100px;
      background: #0a0c12; border: 1px solid #1e2235; border-radius: 8px;
      color: #e2e8f0; font-size: 0.82rem; padding: 6px 10px; outline: none;
    }
    .size-add-input:focus { border-color: #6366f1; }
    .size-add-confirm {
      padding: 6px 12px;
      background: rgba(99,102,241,0.15); border: 1px solid rgba(99,102,241,0.35);
      border-radius: 8px; color: #818cf8; font-size: 0.78rem; font-weight: 700;
      cursor: pointer; white-space: nowrap; transition: all 0.15s;
    }
    .size-add-confirm:hover { background: rgba(99,102,241,0.28); }
    .size-none-selected { font-size: 0.7rem; color: #2d3455; font-style: italic; }

    /* Modal footer */
    .add-modal-foot {
      display: flex; gap: 10px;
      padding: 16px 24px;
      border-top: 1px solid #1e2235;
    }
    .btn-modal-cancel {
      flex: 1; padding: 12px;
      background: transparent; border: 1px solid #2d3455;
      border-radius: 10px; color: #64748b;
      font-size: 0.88rem; font-weight: 600; cursor: pointer; transition: all 0.2s;
    }
    .btn-modal-cancel:hover { border-color: #4f5a7a; color: #94a3b8; }
    .btn-modal-submit {
      flex: 2; padding: 12px;
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      border: none; border-radius: 10px; color: #fff;
      font-size: 0.88rem; font-weight: 700; cursor: pointer; transition: opacity 0.2s;
    }
    .btn-modal-submit:hover { opacity: 0.88; }

    /* ‚îÄ‚îÄ Import modal ‚îÄ‚îÄ */
    .import-modal-overlay {
      display: none; position: fixed; inset: 0;
      background: rgba(0,0,0,0.72); z-index: 300;
      align-items: center; justify-content: center; padding: 16px;
    }
    .import-modal-overlay.open { display: flex; }
    .import-modal {
      width: 100%; max-width: 560px; max-height: 90vh;
      background: #0b0e1a; border: 1px solid #1e2235;
      border-radius: 18px; overflow: hidden;
      display: flex; flex-direction: column;
      box-shadow: 0 32px 80px rgba(0,0,0,0.6);
    }
    .import-modal-head {
      display: flex; align-items: center; justify-content: space-between;
      padding: 18px 24px; border-bottom: 1px solid #1e2235;
    }
    .import-modal-head h3 { font-size: 1rem; font-weight: 700; }
    .import-modal-body {
      padding: 22px 24px; display: flex; flex-direction: column; gap: 16px;
      overflow-y: auto;
    }
    .import-modal-foot {
      display: flex; gap: 10px;
      padding: 16px 24px; border-top: 1px solid #1e2235;
    }
    .import-drop-zone {
      border: 2px dashed #2d3455; border-radius: 12px;
      padding: 28px 20px; text-align: center; cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }
    .import-drop-zone:hover { border-color: #6366f1; background: rgba(99,102,241,0.04); }
    .import-status {
      padding: 12px 16px; border-radius: 10px;
      font-size: 0.83rem; line-height: 1.5; border: 1px solid transparent;
    }
    .import-status.loading { background: rgba(245,158,11,0.1); border-color: rgba(245,158,11,0.3); color: #f59e0b; }
    .import-status.success { background: rgba(34,197,94,0.08); border-color: rgba(34,197,94,0.25); color: #22c55e; }
    .import-status.error   { background: rgba(239,68,68,0.08); border-color: rgba(239,68,68,0.25); color: #ef4444; }
    .import-product-list {
      display: flex; flex-direction: column; gap: 6px;
      max-height: 220px; overflow-y: auto;
    }
    .import-product-item {
      display: flex; flex-direction: column; gap: 8px;
      background: #0d0f1a; border: 1px solid #1e2235;
      border-radius: 10px; padding: 10px 14px; font-size: 0.8rem;
    }
    .ipi-row { display: flex; align-items: center; gap: 10px; }
    .ipi-sizes { display: flex; flex-wrap: wrap; gap: 5px; }
    .import-product-item .ipi-code  { color: #818cf8; font-weight: 700; min-width: 72px; flex-shrink: 0; }
    .import-product-item .ipi-name  { flex: 1; color: #94a3b8; }
    .import-product-item .ipi-price { color: #f59e0b; font-weight: 700; white-space: nowrap; }
    /* Size chips inside import list */
    .imp-size-chip {
      padding: 3px 10px; border-radius: 6px;
      border: 1px solid #2d3455; background: transparent;
      color: #4f5a7a; font-size: 0.68rem; font-weight: 700;
      cursor: pointer; transition: all 0.13s;
    }
    .imp-size-chip:hover  { border-color: #818cf8; color: #818cf8; }
    .imp-size-chip.active { background: rgba(99,102,241,0.16); border-color: rgba(99,102,241,0.5); color: #818cf8; }
    [data-theme="light"] .imp-size-chip { border-color: #dde3ed; color: #94a3b8; }
    [data-theme="light"] .imp-size-chip.active { background: rgba(99,102,241,0.1); border-color: rgba(99,102,241,0.4); color: #6366f1; }

    /* ‚îÄ‚îÄ Product card cell (merged photo + name + code) ‚îÄ‚îÄ */
    .product-card-cell { min-width: 260px; max-width: 340px; padding: 6px 10px !important; }
    .product-card-inner { display: flex; align-items: center; gap: 12px; }
    .product-card-info { flex: 1; min-width: 0; display: flex; flex-direction: column; gap: 1px; }
    .product-card-meta { display: flex; align-items: center; gap: 6px; flex-wrap: wrap; margin-top: 1px; }
    /* Name inside card */
    .product-card-info input[id^="name-"] {
      font-weight: 700; font-size: 0.87rem; color: #f1f5f9;
      background: transparent; border: 1px solid transparent; border-radius: 5px;
      width: 100%; padding: 2px 4px; line-height: 1.3;
    }
    .product-card-info input[id^="name-"]:hover { background: rgba(99,102,241,0.07); border-color: rgba(99,102,241,0.25); }
    .product-card-info input[id^="name-"]:focus { background: rgba(99,102,241,0.11); border-color: #6366f1; outline: none; }
    /* Code inside card */
    .product-card-meta input[id^="code-"] {
      font-size: 0.71rem; color: #4f5a7a; font-weight: 500;
      background: transparent; border: 1px solid transparent; border-radius: 4px;
      padding: 1px 4px;
    }
    .product-card-meta input[id^="code-"]:hover { background: rgba(99,102,241,0.05); border-color: rgba(99,102,241,0.2); }
    .product-card-meta input[id^="code-"]:focus { background: rgba(99,102,241,0.09); border-color: #6366f1; outline: none; }
    /* Light mode overrides for card */
    [data-theme="light"] .product-card-info input[id^="name-"] { color: #0f172a; }
    [data-theme="light"] .product-card-meta input[id^="code-"] { color: #94a3b8; }

    /* Photo thumb in table */
    .row-thumb {
      width: 46px; height: 46px; border-radius: 10px;
      object-fit: cover; display: block;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .row-thumb-empty {
      width: 46px; height: 46px; border-radius: 10px;
      background: #1a1d2e; display: flex; align-items: center; justify-content: center;
      font-size: 18px; color: #2d3455;
      border: 1px solid #1e2235;
    }
    .size-badge {
      display: inline-block;
      padding: 3px 8px; border-radius: 6px;
      background: rgba(99,102,241,0.15);
      color: #818cf8; font-size: 0.72rem; font-weight: 700;
      white-space: nowrap;
    }

    /* ‚îÄ‚îÄ Lightbox ‚îÄ‚îÄ */
    .lightbox {
      display: none;
      position: fixed; inset: 0;
      background: rgba(0,0,0,0.92);
      z-index: 500;
      align-items: center; justify-content: center;
      cursor: zoom-out;
      backdrop-filter: blur(8px);
    }
    .lightbox.open { display: flex; }
    .lightbox img {
      max-width: 90vw; max-height: 90vh;
      border-radius: 14px;
      box-shadow: 0 40px 100px rgba(0,0,0,0.8);
      cursor: default;
      animation: lbIn 0.2s ease;
    }
    @keyframes lbIn {
      from { transform: scale(0.88); opacity: 0; }
      to   { transform: scale(1);    opacity: 1; }
    }
    .lightbox-close {
      position: fixed; top: 20px; right: 24px;
      background: rgba(255,255,255,0.1); border: none;
      border-radius: 50%; width: 40px; height: 40px;
      color: #fff; font-size: 20px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: background 0.2s;
    }
    .lightbox-close:hover { background: rgba(255,255,255,0.22); }
    .row-thumb { cursor: zoom-in; transition: opacity 0.15s; }
    .row-thumb:hover { opacity: 0.8; }

    /* ‚îÄ‚îÄ Checkbox & selection ‚îÄ‚îÄ */
    .row-checkbox {
      width: 17px; height: 17px;
      appearance: none; -webkit-appearance: none;
      border: 2px solid #2d3455; border-radius: 5px;
      background: transparent; cursor: pointer;
      position: relative; transition: all 0.15s; flex-shrink: 0;
      display: block;
    }
    .row-checkbox:hover { border-color: #6366f1; }
    .row-checkbox:checked { background: #6366f1; border-color: #6366f1; }
    .row-checkbox:checked::after {
      content: '';
      position: absolute; left: 4px; top: 1px;
      width: 5px; height: 9px;
      border: 2px solid #fff; border-top: none; border-left: none;
      transform: rotate(45deg);
    }
    .row-checkbox:indeterminate { background: rgba(99,102,241,0.4); border-color: #6366f1; }
    .row-checkbox:indeterminate::after {
      content: '';
      position: absolute; left: 3px; top: 5px;
      width: 7px; height: 2px; background: #fff; border: none;
    }
    tbody tr.row-selected { background: rgba(99,102,241,0.07) !important; }
    tbody tr.row-selected:hover { background: rgba(99,102,241,0.1) !important; }

    /* ‚îÄ‚îÄ Selection bar (floating bottom) ‚îÄ‚îÄ */
    .selection-bar {
      display: none;
      position: fixed; bottom: 28px; left: 50%;
      transform: translateX(-50%) translateY(10px);
      opacity: 0;
      background: #1a1d2e; border: 1px solid #2d3455;
      border-radius: 14px; padding: 12px 20px;
      z-index: 90; gap: 14px; align-items: center;
      box-shadow: 0 20px 50px rgba(0,0,0,0.6);
      white-space: nowrap;
      transition: opacity 0.22s ease, transform 0.22s ease;
    }
    .selection-bar.visible {
      display: flex; opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
    .sel-count { font-size: 0.88rem; color: #94a3b8; font-weight: 600; }
    .sel-count strong { color: #818cf8; font-size: 1rem; }
    .btn-sel-delete {
      padding: 8px 18px;
      background: #ef4444; border: none; border-radius: 9px;
      color: #fff; font-size: 0.82rem; font-weight: 700; cursor: pointer;
      transition: background 0.2s;
    }
    .btn-sel-delete:hover { background: #dc2626; }
    .btn-sel-cancel {
      padding: 8px 14px;
      background: transparent; border: 1px solid #2d3455; border-radius: 9px;
      color: #64748b; font-size: 0.82rem; font-weight: 600; cursor: pointer;
      transition: all 0.2s;
    }
    .btn-sel-cancel:hover { color: #94a3b8; border-color: #4f5a7a; }

    /* ‚îÄ‚îÄ Confirm modal ‚îÄ‚îÄ */
    .modal-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }
    .modal-overlay.open { display: flex; }
    .modal-box {
      background: #111422;
      border: 1px solid #2d3455;
      border-radius: 18px;
      padding: 32px 28px;
      max-width: 380px;
      width: 92%;
      text-align: center;
      box-shadow: 0 24px 60px rgba(0,0,0,0.6);
      animation: modalIn 0.18s ease;
    }
    @keyframes modalIn {
      from { transform: scale(0.92); opacity: 0; }
      to   { transform: scale(1);    opacity: 1; }
    }
    .modal-icon { font-size: 2.2rem; margin-bottom: 14px; }
    .modal-title { font-size: 1rem; font-weight: 700; color: #e2e8f0; margin-bottom: 8px; }
    .modal-sub { font-size: 0.82rem; color: #64748b; line-height: 1.5; margin-bottom: 24px; }
    .modal-btns { display: flex; gap: 10px; justify-content: center; }
    .modal-cancel {
      flex: 1; padding: 11px 18px;
      background: transparent; border: 1px solid #2d3455;
      border-radius: 10px; color: #64748b;
      font-size: 0.88rem; font-weight: 600; cursor: pointer;
      transition: all 0.2s;
    }
    .modal-cancel:hover { border-color: #4f5a7a; color: #94a3b8; }
    .modal-confirm {
      flex: 1; padding: 11px 18px;
      background: #ef4444; border: none;
      border-radius: 10px; color: #fff;
      font-size: 0.88rem; font-weight: 700; cursor: pointer;
      transition: all 0.2s;
    }
    .modal-confirm:hover { background: #dc2626; }

    /* ‚îÄ‚îÄ Archive ‚îÄ‚îÄ */
    .archive-card {
      background: #111422;
      border: 1px solid rgba(239,68,68,0.2);
      border-radius: 16px;
      overflow: hidden;
      margin-bottom: 20px;
    }
    .archive-header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 20px;
      border-bottom: 1px solid rgba(239,68,68,0.12);
    }
    .archive-title {
      font-size: 0.72rem; font-weight: 700;
      letter-spacing: 0.1em; text-transform: uppercase;
      color: #ef4444;
    }
    .archive-item {
      display: flex; align-items: center; justify-content: space-between;
      padding: 12px 20px; gap: 16px;
      border-bottom: 1px solid #161928;
      transition: background 0.15s;
    }
    .archive-item:last-child { border-bottom: none; }
    .archive-item:hover { background: rgba(239,68,68,0.03); }
    .archive-info { display: flex; flex-direction: column; gap: 3px; min-width: 0; flex: 1; }
    .archive-code { font-size: 0.78rem; font-weight: 700; color: #64748b; }
    .archive-name { font-size: 0.82rem; color: #4f5a7a; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .archive-meta { font-size: 0.68rem; color: #2d3455; }
    .btn-restore {
      padding: 7px 14px; flex-shrink: 0;
      background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3);
      border-radius: 8px; color: #22c55e;
      font-size: 0.78rem; font-weight: 700; cursor: pointer; white-space: nowrap;
      transition: all 0.2s;
    }
    .btn-restore:hover { background: rgba(34,197,94,0.22); }

    /* ‚îÄ‚îÄ Sync badge ‚îÄ‚îÄ */
    .sync-badge {
      display: flex; align-items: center; gap: 6px;
      font-size: 0.72rem; color: #4f5a7a;
      padding: 5px 10px; border-radius: 8px;
      border: 1px solid transparent; transition: all 0.3s;
    }
    .sync-badge.syncing { color: #f59e0b; border-color: rgba(245,158,11,0.3); background: rgba(245,158,11,0.06); }
    .sync-badge.synced  { color: #22c55e; border-color: rgba(34,197,94,0.3);  background: rgba(34,197,94,0.06); }
    .sync-badge.error   { color: #ef4444; border-color: rgba(239,68,68,0.3);  background: rgba(239,68,68,0.06); }
    .sync-dot { width: 7px; height: 7px; border-radius: 50%; background: currentColor; flex-shrink: 0; }
    .sync-badge.syncing .sync-dot { animation: pulse 1.1s infinite; }
    @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.25} }

    @media (max-width: 1100px) {
      .charts-grid { grid-template-columns: 1fr; }
      .chart-card.span2 { grid-column: auto; }
    }
    @media (max-width: 900px) {
      .insights-row { grid-template-columns: 1fr; }
      .kpi-strip { grid-template-columns: repeat(4, 1fr); }
      .kpi-card:nth-child(4n) { border-right: none; }
    }
    @media (max-width: 600px) {
      .page { padding: 12px; }
      .params-grid { grid-template-columns: 1fr 1fr; }
      .bulk-sep { display: none; }
      .kpi-strip { display:flex;overflow-x:auto;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch;scrollbar-width:none;grid-template-columns:unset;gap:0; }
      .kpi-strip::-webkit-scrollbar { display:none; }
      .kpi-card { min-width:140px;scroll-snap-align:start;flex-shrink:0;border-right:1px solid #1e2235; }
      .kpi-card:last-child { border-right:none; }
      .header-nav { gap: 0; }
      .htab { padding: 7px 10px; font-size: 0.75rem; }
    }

    /* ‚îÄ‚îÄ Modal info panel (rate + margin) ‚îÄ‚îÄ */
    .am-info-panel {
      display: flex; align-items: flex-start; gap: 16px;
      background: #0d0f1a;
      border: 1px solid #1e2235;
      border-radius: 12px; padding: 14px 16px;
    }
    .am-info-item { display: flex; flex-direction: column; gap: 4px; }
    .am-info-label { font-size: 0.7rem; color: #4f5a7a; text-transform: uppercase; letter-spacing: 0.06em; font-weight: 700; }
    .am-info-value { font-size: 1rem; font-weight: 800; }
    .am-info-sep { width: 1px; background: #1e2235; align-self: stretch; flex-shrink: 0; margin: 0 4px; }
    [data-theme="light"] .am-info-panel { background: #f8fafc; border-color: #dde3ed; }
    [data-theme="light"] .am-info-sep   { background: #dde3ed; }
    [data-theme="light"] .am-info-label { color: #94a3b8; }

    /* Per-row margin badge in table */
    .margin-tag {
      display: inline-block; padding: 2px 7px;
      border-radius: 6px; font-size: 0.68rem; font-weight: 700;
      background: rgba(139,92,246,0.15); color: #a78bfa;
      white-space: nowrap; cursor: pointer;
    }
    .margin-tag:hover { background: rgba(139,92,246,0.3); }

    /* ‚îÄ‚îÄ Theme toggle button ‚îÄ‚îÄ */
    .theme-btn {
      width: 34px; height: 34px;
      background: rgba(255,255,255,0.05);
      border: 1px solid #2d3455;
      border-radius: 9px;
      font-size: 17px; cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0; transition: all 0.2s;
    }
    .theme-btn:hover { background: rgba(255,255,255,0.1); border-color: #4f5a7a; }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       LIGHT MODE OVERRIDES
       Applied when <html data-theme="light">
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    [data-theme="light"] body { background: #f0f4f8; color: #1e293b; }

    /* Header */
    [data-theme="light"] .header { background: #ffffff; border-color: #dde3ed; }
    [data-theme="light"] .header h1 { color: #1e293b; }
    [data-theme="light"] .header-sub { color: #94a3b8; }
    [data-theme="light"] .htab { color: #94a3b8; }
    [data-theme="light"] .htab.active { background: rgba(99,102,241,0.1); color: #6366f1; }
    [data-theme="light"] .htab:hover:not(.active) { color: #475569; }
    [data-theme="light"] .theme-btn { background: rgba(0,0,0,0.04); border-color: #dde3ed; }
    [data-theme="light"] .theme-btn:hover { background: rgba(0,0,0,0.08); }

    /* KPI strip */
    [data-theme="light"] .kpi-strip { background: #f8fafc; border-color: #dde3ed; }
    [data-theme="light"] .kpi-card  { border-color: #dde3ed; }
    [data-theme="light"] .kpi-label { color: #94a3b8; }
    [data-theme="light"] .kpi-sub   { color: #cbd5e1; }

    /* Cards */
    [data-theme="light"] .card,
    [data-theme="light"] .products-card,
    [data-theme="light"] .bulk-card { background: #ffffff; border-color: #dde3ed; }
    [data-theme="light"] .card-title,
    [data-theme="light"] .products-header h2,
    [data-theme="light"] .bulk-title { color: #6366f1; }
    [data-theme="light"] .products-header { border-color: #dde3ed; }
    [data-theme="light"] .bulk-sep { background: #dde3ed; }
    [data-theme="light"] .bulk-label { color: #64748b; }

    /* Inputs (non-table) */
    [data-theme="light"] input[type="number"],
    [data-theme="light"] input[type="text"] { background: #f8fafc; border-color: #dde3ed; color: #1e293b; }
    [data-theme="light"] input:focus { border-color: #6366f1; }
    [data-theme="light"] .badge { background: #f1f5f9; color: #64748b; }
    [data-theme="light"] .param-field label { color: #64748b; }
    [data-theme="light"] .margin-btn { border-color: #dde3ed; color: #94a3b8; }

    /* Table ‚Äî ghost inputs in light mode */
    [data-theme="light"] thead th { background: #f4f6fb; color: #64748b; border-color: #e2e8f0; border-bottom: 2px solid #e2e8f0; }
    [data-theme="light"] tbody tr { border-color: #edf0f7; }
    [data-theme="light"] tbody tr:hover { background: rgba(99,102,241,0.05) !important; }
    [data-theme="light"] td input[type="text"],
    [data-theme="light"] td input[type="number"] { background: transparent; border-color: transparent; color: #0f172a; }
    [data-theme="light"] td input[type="text"]:hover,
    [data-theme="light"] td input[type="number"]:hover { background: rgba(99,102,241,0.06); border-color: rgba(99,102,241,0.22); }
    [data-theme="light"] td input[type="text"]:focus,
    [data-theme="light"] td input[type="number"]:focus { background: rgba(99,102,241,0.08); border-color: #6366f1; }
    /* light-mode name/code handled by .product-card-info rules */
    [data-theme="light"] .col-result { color: #1e293b; }
    [data-theme="light"] .row-thumb-empty { background: #f1f5f9; color: #c7d2e0; border-color: #e2e8f0; }
    [data-theme="light"] .size-badge { background: rgba(99,102,241,0.1); color: #6366f1; }
    [data-theme="light"] .empty-table { color: #94a3b8; }
    [data-theme="light"] tbody tr.row-selected { background: rgba(99,102,241,0.08) !important; }
    [data-theme="light"] tbody tr.row-selected:hover { background: rgba(99,102,241,0.12) !important; }
    [data-theme="light"] .row-checkbox { border-color: #dde3ed; }
    [data-theme="light"] .btn-del  { color: #c7d2e0; }
    [data-theme="light"] .btn-edit { color: #c7d2e0; }

    /* Action buttons */
    [data-theme="light"] .btn-export { border-color: #dde3ed; color: #64748b; }
    [data-theme="light"] .btn-export:hover { border-color: #94a3b8; color: #1e293b; }

    /* Selection bar */
    [data-theme="light"] .selection-bar { background: #ffffff; border-color: #dde3ed; box-shadow: 0 8px 30px rgba(0,0,0,0.12); }
    [data-theme="light"] .sel-count { color: #475569; }
    [data-theme="light"] .btn-sel-cancel { border-color: #dde3ed; color: #64748b; }

    /* Archive */
    [data-theme="light"] .archive-card { background: #ffffff; border-color: rgba(239,68,68,0.18); }
    [data-theme="light"] .archive-header { border-color: rgba(239,68,68,0.1); }
    [data-theme="light"] .archive-item { border-color: #f0f4f8; }
    [data-theme="light"] .archive-item:hover { background: rgba(239,68,68,0.02); }
    [data-theme="light"] .archive-code { color: #475569; }
    [data-theme="light"] .archive-name { color: #94a3b8; }
    [data-theme="light"] .archive-meta { color: #cbd5e1; }

    /* Add product modal */
    [data-theme="light"] .add-modal-overlay { background: rgba(0,0,0,0.4); }
    [data-theme="light"] .add-modal { background: #ffffff; border-color: #dde3ed; box-shadow: 0 32px 80px rgba(0,0,0,0.15); }
    [data-theme="light"] .add-modal-head,
    [data-theme="light"] .add-modal-foot { border-color: #dde3ed; }
    [data-theme="light"] .add-modal-head h3 { color: #1e293b; }
    [data-theme="light"] .add-modal-close { color: #94a3b8; }
    [data-theme="light"] .add-modal-close:hover { background: #f1f5f9; color: #1e293b; }
    [data-theme="light"] .form-field label { color: #64748b; }
    [data-theme="light"] .btn-modal-cancel { border-color: #dde3ed; color: #64748b; }
    [data-theme="light"] .photo-upload-area { border-color: #dde3ed; }
    [data-theme="light"] .photo-upload-area:hover { background: rgba(99,102,241,0.03); }
    [data-theme="light"] .photo-upload-text { color: #94a3b8; }
    [data-theme="light"] .photo-upload-hint { color: #cbd5e1; }
    [data-theme="light"] .size-label { color: #64748b; }
    [data-theme="light"] .size-chip { border-color: #dde3ed; color: #64748b; }
    [data-theme="light"] .size-chip:hover { border-color: #6366f1; color: #6366f1; }
    [data-theme="light"] .size-add-input { background: #f8fafc; border-color: #dde3ed; color: #1e293b; }

    /* Confirm modal */
    [data-theme="light"] .modal-overlay { background: rgba(0,0,0,0.4); }
    [data-theme="light"] .modal-box { background: #ffffff; border-color: #dde3ed; box-shadow: 0 24px 60px rgba(0,0,0,0.12); }
    [data-theme="light"] .modal-title { color: #1e293b; }
    [data-theme="light"] .modal-sub   { color: #64748b; }
    [data-theme="light"] .modal-cancel { border-color: #dde3ed; color: #64748b; }

    /* Import modal */
    [data-theme="light"] .import-modal { background: #ffffff; border-color: #dde3ed; box-shadow: 0 32px 80px rgba(0,0,0,0.15); }
    [data-theme="light"] .import-modal-head,
    [data-theme="light"] .import-modal-foot { border-color: #dde3ed; }
    [data-theme="light"] .import-modal-head h3 { color: #1e293b; }
    [data-theme="light"] .import-drop-zone { border-color: #dde3ed; }
    [data-theme="light"] .import-drop-zone:hover { border-color: #6366f1; background: rgba(99,102,241,0.03); }
    [data-theme="light"] .import-product-item { background: #f8fafc; border-color: #e2e8f0; }
    [data-theme="light"] .import-modal-overlay { background: rgba(0,0,0,0.4); }

    /* Analytics */
    [data-theme="light"] .insight-card,
    [data-theme="light"] .chart-card { background: #ffffff; border-color: #dde3ed; }
    [data-theme="light"] .chart-title { color: #6366f1; }
    [data-theme="light"] .insight-label { color: #64748b; }
    [data-theme="light"] .insight-name  { color: #475569; }
    [data-theme="light"] .analytics-empty { color: #94a3b8; }

    /* Sync badge light */
    [data-theme="light"] .sync-badge { color: #94a3b8; }
    [data-theme="light"] .sync-badge.synced  { color: #16a34a; border-color: rgba(22,163,74,0.3);   background: rgba(22,163,74,0.06); }
    [data-theme="light"] .sync-badge.syncing { color: #d97706; border-color: rgba(217,119,6,0.3);   background: rgba(217,119,6,0.06); }
    [data-theme="light"] .sync-badge.error   { color: #dc2626; border-color: rgba(220,38,38,0.3);   background: rgba(220,38,38,0.06); }

    /* Lightbox stays dark always */
    .lightbox { background: rgba(0,0,0,0.92); }

  /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     WAREHOUSE MODULE
  ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
  .wh-page { display: none; }
  .wh-page.active { display: block; }

  .wh-kpi {
    display: grid; grid-template-columns: repeat(4, 1fr);
    gap: 12px; margin-bottom: 20px;
  }
  .wh-kpi-card {
    background: #111422; border: 1px solid #1e2235;
    border-radius: 12px; padding: 14px 18px;
  }
  .wh-kpi-label {
    font-size: 0.62rem; color: #4f5a7a;
    text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 4px;
  }
  .wh-kpi-val { font-size: 1.05rem; font-weight: 800; line-height: 1.2; }

  .wh-toolbar { display: flex; align-items: center; gap: 10px; margin-bottom: 16px; flex-wrap: wrap; }
  .wh-search {
    flex: 1; min-width: 200px; max-width: 320px;
    background: #111422; border: 1px solid #1e2235;
    border-radius: 9px; color: #e2e8f0;
    font-size: 0.84rem; padding: 8px 12px;
    outline: none; transition: border-color 0.2s;
  }
  .wh-search:focus { border-color: #6366f1; }

  .wh-table-wrap {
    background: #111422; border: 1px solid #1e2235;
    border-radius: 14px; overflow: hidden;
  }
  .wh-table { width: 100%; border-collapse: collapse; font-size: 0.83rem; }
  .wh-table th {
    background: #0d0f1a; padding: 10px 14px; text-align: left;
    font-size: 0.65rem; font-weight: 700; color: #4f5a7a;
    text-transform: uppercase; letter-spacing: 0.06em;
    border-bottom: 1px solid #1e2235; white-space: nowrap;
  }
  .wh-table th.num, .wh-table td.num { text-align: right; font-variant-numeric: tabular-nums; }
  .wh-table td {
    padding: 10px 14px; border-bottom: 1px solid rgba(30,34,53,0.6);
    color: #e2e8f0; vertical-align: middle;
  }
  .wh-table tr:last-child td { border-bottom: none; }
  .wh-table tbody tr:hover td { background: rgba(99,102,241,0.04); }
  .wh-table-footer {
    padding: 10px 14px; border-top: 1px solid #1e2235;
    font-size: 0.72rem; color: #4f5a7a;
    display: flex; justify-content: space-between; align-items: center;
  }

  .wh-badge {
    display: inline-flex; align-items: center;
    padding: 2px 8px; border-radius: 20px; font-size: 0.67rem; font-weight: 700;
  }
  .wh-badge.in     { background: rgba(34,197,94,0.15);  color: #22c55e; }
  .wh-badge.out    { background: rgba(239,68,68,0.15);   color: #ef4444; }
  .wh-badge.adjust { background: rgba(251,191,36,0.15);  color: #fbbf24; }
  .wh-badge.draft  { background: rgba(100,116,139,0.15); color: #64748b; }
  .wh-badge.posted { background: rgba(34,197,94,0.15);   color: #22c55e; }

  .btn-wh {
    padding: 8px 16px; border: none; border-radius: 9px;
    font-size: 0.82rem; font-weight: 700; cursor: pointer;
    transition: opacity 0.15s; white-space: nowrap;
  }
  .btn-wh:hover    { opacity: 0.82; }
  .btn-wh:disabled { opacity: 0.45; cursor: not-allowed; }
  .btn-wh-primary   { background: linear-gradient(135deg, #6366f1, #8b5cf6); color: #fff; }
  .btn-wh-secondary { background: rgba(99,102,241,0.12); color: #818cf8; border: 1px solid rgba(99,102,241,0.25); }
  .btn-wh-danger    { background: rgba(239,68,68,0.12);  color: #ef4444; border: 1px solid rgba(239,68,68,0.25); }
  .btn-wh-ghost     { background: transparent; color: #94a3b8; border: 1px solid rgba(148,163,184,0.3); }
  .btn-wh-ghost:hover { background: rgba(148,163,184,0.08); color: #cbd5e1; }
  .btn-wh-sm { padding: 5px 10px; font-size: 0.75rem; border-radius: 7px; }

  .wh-form-section {
    background: #111422; border: 1px solid #1e2235;
    border-radius: 14px; padding: 18px 20px; margin-bottom: 16px;
  }
  .wh-form-title {
    font-size: 0.72rem; font-weight: 800; color: #4f5a7a;
    text-transform: uppercase; letter-spacing: 0.07em; margin-bottom: 14px;
  }
  .wh-form-grid { display: grid; gap: 12px; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); }
  .wh-form-field { display: flex; flex-direction: column; gap: 5px; }
  .wh-form-label { font-size: 0.72rem; color: #64748b; font-weight: 600; }
  .wh-form-input {
    background: #0a0c12; border: 1px solid #1e2235; border-radius: 9px;
    color: #e2e8f0; font-size: 0.84rem; padding: 8px 12px;
    outline: none; transition: border-color 0.2s; width: 100%;
  }
  .wh-form-input:focus { border-color: #6366f1; }
  .wh-select {
    background: #0a0c12; border: 1px solid #1e2235; border-radius: 9px;
    color: #e2e8f0; font-size: 0.84rem; padding: 8px 12px;
    outline: none; cursor: pointer; width: 100%;
  }
  .wh-select:focus { border-color: #6366f1; }

  .wh-items-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
  .wh-items-list   { display: flex; flex-direction: column; gap: 8px; }
  .wh-item-row {
    background: #0d0f1a; border: 1px solid #1e2235; border-radius: 10px;
    padding: 10px 12px; display: grid; align-items: start; gap: 8px;
  }
  .wh-item-row.supply-row   { grid-template-columns: 1fr 90px 120px 110px auto; }
  .wh-item-row.writeoff-row { grid-template-columns: 1fr 90px 120px auto; }
  .wh-item-sku { font-size: 0.73rem; color: #4f5a7a; margin-top: 2px; }

  .wh-page-hd {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 18px; flex-wrap: wrap; gap: 10px;
  }
  .wh-page-title { font-size: 1.1rem; font-weight: 800; }
  .wh-page-sub   { font-size: 0.75rem; color: #4f5a7a; margin-top: 2px; }
  .wh-empty { text-align: center; padding: 40px 24px; color: #4f5a7a; font-size: 0.84rem; }
  .wh-empty-icon { font-size: 2.5rem; margin-bottom: 12px; }
  .stock-ok   { color: #22c55e; }
  .stock-low  { color: #f59e0b; }
  .stock-zero { color: #ef4444; }

  [data-theme="light"] .wh-kpi-card     { background: #fff; border-color: #e2e8f0; }
  [data-theme="light"] .wh-kpi-label    { color: #94a3b8; }
  [data-theme="light"] .wh-table-wrap   { background: #fff; border-color: #e2e8f0; }
  [data-theme="light"] .wh-table th     { background: #f8fafc; color: #94a3b8; border-color: #e2e8f0; }
  [data-theme="light"] .wh-table td     { color: #1e293b; border-color: rgba(226,232,240,0.7); }
  [data-theme="light"] .wh-table-footer { color: #94a3b8; border-color: #e2e8f0; }
  [data-theme="light"] .wh-form-section { background: #fff; border-color: #e2e8f0; }
  [data-theme="light"] .wh-form-input   { background: #f8fafc; border-color: #e2e8f0; color: #1e293b; }
  [data-theme="light"] .wh-select       { background: #f8fafc; border-color: #e2e8f0; color: #1e293b; }
  [data-theme="light"] .wh-item-row     { background: #f8fafc; border-color: #e2e8f0; }
  [data-theme="light"] .wh-search       { background: #fff; border-color: #e2e8f0; color: #1e293b; }
  [data-theme="light"] .wh-empty        { color: #94a3b8; }
  [data-theme="light"] .wh-form-label   { color: #94a3b8; }
  [data-theme="light"] .btn-wh-secondary { background: rgba(99,102,241,0.08); }

  /* ‚îÄ‚îÄ Auth overlay ‚îÄ‚îÄ */
  .auth-overlay { position:fixed;inset:0;z-index:99999;background:#070910;display:none;align-items:center;justify-content:center; }
  .auth-overlay.show { display:flex; }
  .auth-card { width:340px;background:#111422;border:1px solid #1e2235;border-radius:20px;padding:36px 32px;display:flex;flex-direction:column;gap:18px;align-items:center; }
  .auth-logo { font-size:2.4rem; }
  .auth-brand { font-size:1.1rem;font-weight:800;color:#e2e8f0;margin-top:-6px; }
  .auth-tabs { display:flex;gap:0;background:#0d1020;border-radius:10px;padding:3px;width:100%; }
  .auth-tab { flex:1;background:none;border:none;color:#4f5a7a;font-size:0.82rem;font-weight:600;padding:7px 0;border-radius:8px;cursor:pointer;transition:all 0.18s; }
  .auth-tab.active { background:#1e2235;color:#e2e8f0; }
  .auth-form { display:flex;flex-direction:column;gap:10px;width:100%; }
  .auth-form input { width:100%;background:#0d1020;border:1px solid #1e2235;border-radius:10px;padding:11px 14px;color:#e2e8f0;font-size:0.88rem;outline:none;box-sizing:border-box;transition:border-color 0.18s; }
  .auth-form input:focus { border-color:#6366f1; }
  .auth-error { color:#ef4444;font-size:0.78rem;min-height:18px;text-align:center; }
  .auth-submit { background:#6366f1;border:none;border-radius:10px;color:#fff;font-size:0.9rem;font-weight:700;padding:12px;cursor:pointer;width:100%;transition:opacity 0.18s;margin-top:2px; }
  .auth-submit:hover { opacity:0.88; }
  .auth-submit:disabled { opacity:0.5;cursor:not-allowed; }
  .auth-reset-link { background:none;border:none;color:#4f5a7a;font-size:0.75rem;cursor:pointer;text-decoration:underline;align-self:center;padding:0; }
  .auth-divider { display:flex;align-items:center;gap:10px;width:100%;color:#4f5a7a;font-size:0.72rem; }
  .auth-divider::before,.auth-divider::after { content:'';flex:1;border-top:1px solid #1e2235; }
  .auth-google { display:flex;align-items:center;justify-content:center;gap:10px;width:100%;background:#fff;border:1.5px solid #e2e8f0;border-radius:10px;padding:11px 14px;color:#1e293b;font-size:0.88rem;font-weight:600;cursor:pointer;transition:box-shadow 0.18s; }
  .auth-google:hover { box-shadow:0 2px 12px #0002; }
  .auth-google:disabled { opacity:0.5;cursor:not-allowed; }
  [data-theme="light"] .auth-overlay { background:#f8fafc; }
  [data-theme="light"] .auth-card { background:#fff;border-color:#e2e8f0; }
  [data-theme="light"] .auth-form input { background:#f8fafc;border-color:#e2e8f0;color:#1e293b; }
  [data-theme="light"] .auth-tabs { background:#f1f5f9; }
  [data-theme="light"] .auth-tab.active { background:#fff;color:#1e293b; }

  /* ‚îÄ‚îÄ PIN lock overlay ‚îÄ‚îÄ */
  #pinOverlay {
    position: fixed; inset: 0; z-index: 99998;
    background: #070910; display: none;
    flex-direction: column; align-items: center; justify-content: center; gap: 22px;
  }
  #pinOverlay.show { display: flex; }
  .pin-logo { font-size: 2.4rem; }
  .pin-title { font-size: 1.05rem; font-weight: 700; color: #e2e8f0; }
  .pin-subtitle { font-size: 0.78rem; color: #4f5a7a; margin-top: -14px; }
  .pin-dots { display: flex; gap: 14px; }
  .pin-dot { width: 14px; height: 14px; border-radius: 50%; border: 2px solid #2d3a52; transition: all 0.18s; }
  .pin-dot.filled { background: #6366f1; border-color: #6366f1; transform: scale(1.15); }
  .pin-error { color: #ef4444; font-size: 0.78rem; min-height: 20px; }
  .pin-pad { display: grid; grid-template-columns: repeat(3, 68px); gap: 10px; }
  .pin-key {
    height: 54px; border-radius: 14px; background: #111422; border: 1px solid #1e2235;
    color: #e2e8f0; font-size: 1.25rem; cursor: pointer; transition: all 0.15s;
  }
  .pin-key:hover  { background: rgba(99,102,241,0.15); border-color: #6366f1; color: #818cf8; }
  .pin-key:active { transform: scale(0.93); }
  .pin-key.enter  { background: rgba(99,102,241,0.2); color: #818cf8; }
  .pin-key.back   { color: #ef4444; }
  @keyframes pinShake {
    0%,100% { transform: translateX(0); }
    20%,60%  { transform: translateX(-8px); }
    40%,80%  { transform: translateX(8px); }
  }
  .pin-shake { animation: pinShake 0.4s; }
  /* header lock/print/backup buttons */
  .hdr-btn {
    background: none; border: 1px solid transparent; border-radius: 8px;
    color: #4f5a7a; font-size: 0.88rem; padding: 5px 9px; cursor: pointer;
    transition: all 0.18s; white-space: nowrap;
  }
  .hdr-btn:hover { background: rgba(99,102,241,0.1); color: #818cf8; border-color: rgba(99,102,241,0.25); }
  [data-theme="light"] .hdr-btn { color: #94a3b8; }
  [data-theme="light"] .hdr-btn:hover { color: #6366f1; }

  /* ‚îÄ‚îÄ Category badge ‚îÄ‚îÄ */
  .cat-badge {
    display: inline-block; margin-top: 3px; padding: 1px 7px;
    border-radius: 10px; font-size: 0.65rem; font-weight: 600;
    background: rgba(99,102,241,0.15); color: #818cf8; border: 1px solid rgba(99,102,241,0.25);
    vertical-align: middle; cursor: default;
  }

  /* ‚îÄ‚îÄ Dashboard ‚îÄ‚îÄ */
  .dash-kpi-row { display: grid; grid-template-columns: repeat(4,1fr); gap: 16px; margin-bottom: 24px; }
  .dash-kpi { background: #111422; border: 1px solid #1e2235; border-radius: 16px; padding: 18px 20px; }
  .dash-kpi-icon { font-size: 1.5rem; margin-bottom: 8px; }
  .dash-kpi-label { font-size: 0.65rem; color: #4f5a7a; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 4px; }
  .dash-kpi-val { font-size: 1.3rem; font-weight: 800; }
  .dash-kpi-sub { font-size: 0.68rem; color: #4f5a7a; margin-top: 2px; }
  .dash-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
  .dash-section { background: #111422; border: 1px solid #1e2235; border-radius: 16px; padding: 18px 20px; }
  .dash-section-title { font-size: 0.72rem; font-weight: 700; color: #64748b; text-transform: uppercase; letter-spacing: 0.08em; margin-bottom: 14px; }
  .dash-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; border-bottom: 1px solid #1e2235; font-size: 0.82rem; }
  .dash-row:last-child { border-bottom: none; }
  .dash-row-label { color: #94a3b8; }
  .dash-row-val { font-weight: 700; color: #e2e8f0; }
  .dash-alert { display: flex; align-items: center; gap: 10px; padding: 10px; border-radius: 10px; background: rgba(239,68,68,0.08); border: 1px solid rgba(239,68,68,0.2); margin-bottom: 8px; font-size: 0.8rem; color: #fca5a5; }
  [data-theme="light"] .dash-kpi { background: #fff; border-color: #e2e8f0; }
  [data-theme="light"] .dash-kpi-label { color: #94a3b8; }
  [data-theme="light"] .dash-section { background: #fff; border-color: #e2e8f0; }
  [data-theme="light"] .dash-section-title { color: #94a3b8; }
  [data-theme="light"] .dash-row { border-color: #f1f5f9; }
  [data-theme="light"] .dash-row-label { color: #64748b; }
  [data-theme="light"] .dash-row-val { color: #1e293b; }

  /* ‚îÄ‚îÄ Print styles ‚îÄ‚îÄ */
  @media print {
    .header, .kpi-strip,
    .actions, .bulk-card, .archive-card, .prod-filter-bar,
    #pinOverlay, #toast-container, #prodContextMenu,
    .add-modal-overlay, .import-modal-overlay, .modal-overlay,
    .btn-add, .btn-edit, .btn-del, .btn-dup, .row-actions,
    .wh-toolbar, .wh-page-hd button, #tab-warehouse,
    #tab-analytics, #tab-dashboard { display: none !important; }
    .products-card { border: none; box-shadow: none; }
    #print-header { display: block !important; }
  }

  /* ‚îÄ‚îÄ Product filter bar ‚îÄ‚îÄ */
  .prod-filter-bar {
    display: flex; align-items: center; gap: 10px; padding: 10px 16px;
    border-bottom: 1px solid #1e2235; flex-wrap: wrap;
  }
  .prod-search {
    width: 210px; flex-shrink: 0;
    background: #0a0c12; border: 1px solid #1e2235; border-radius: 9px;
    color: #e2e8f0; font-size: 0.8rem; padding: 6px 11px; outline: none;
    transition: border-color 0.2s;
  }
  .prod-search:focus { border-color: #6366f1; }
  .prod-tags { display: flex; gap: 5px; flex-wrap: wrap; }
  .prod-tag {
    padding: 4px 11px; border-radius: 20px; font-size: 0.73rem; cursor: pointer;
    background: transparent; border: 1px solid #1e2235; color: #4f5a7a;
    transition: all 0.18s; white-space: nowrap;
  }
  .prod-tag:hover  { border-color: #6366f1; color: #818cf8; }
  .prod-tag.active { background: rgba(99,102,241,0.15); border-color: #6366f1; color: #818cf8; }
  .prod-filter-count { margin-left: auto; font-size: 0.7rem; color: #4f5a7a; }
  [data-theme="light"] .prod-search  { background: #f8fafc; border-color: #e2e8f0; color: #1e293b; }
  [data-theme="light"] .prod-tag     { border-color: #e2e8f0; color: #94a3b8; }
  [data-theme="light"] .prod-tag.active { background: rgba(99,102,241,0.08); }
  [data-theme="light"] .prod-filter-bar { border-color: #e2e8f0; }

  /* ‚îÄ‚îÄ KPI info tooltip ‚îÄ‚îÄ */
  .kpi-card { position: relative; }
  .kpi-tip-icon {
    position: absolute; top: 7px; right: 7px;
    width: 14px; height: 14px; border-radius: 50%; background: #1e2235;
    font-size: 0.58rem; font-style: normal; color: #4f5a7a;
    display: flex; align-items: center; justify-content: center; cursor: help;
  }
  .kpi-tip-popup {
    display: none; position: absolute; top: calc(100% + 6px); left: 0; z-index: 200;
    min-width: 190px; background: #1e293b; border: 1px solid #2d3a52;
    border-radius: 9px; padding: 8px 11px; font-size: 0.72rem;
    color: #94a3b8; line-height: 1.5; box-shadow: 0 8px 24px rgba(0,0,0,0.5);
    pointer-events: none;
  }
  .kpi-card:hover .kpi-tip-popup { display: block; }
  [data-theme="light"] .kpi-tip-icon  { background: #e2e8f0; }
  [data-theme="light"] .kpi-tip-popup { background: #fff; border-color: #e2e8f0; color: #64748b; box-shadow: 0 8px 24px rgba(0,0,0,0.1); }

  /* ‚îÄ‚îÄ Duplicate button ‚îÄ‚îÄ */
  .btn-dup {
    background: none; border: none; color: #2d3455; font-size: 13px;
    cursor: pointer; padding: 4px 6px; border-radius: 6px; transition: all 0.2s;
  }
  .btn-dup:hover { color: #22c55e; background: rgba(34,197,94,0.1); }

  /* ‚îÄ‚îÄ Context menu ‚îÄ‚îÄ */
  #prodContextMenu {
    position: fixed; z-index: 9999; min-width: 160px;
    background: #1e293b; border: 1px solid #2d3a52; border-radius: 10px;
    padding: 5px; box-shadow: 0 12px 40px rgba(0,0,0,0.55); display: none;
  }
  .ctx-item {
    display: flex; align-items: center; gap: 9px;
    padding: 8px 12px; border-radius: 7px; cursor: pointer;
    font-size: 0.8rem; color: #e2e8f0; white-space: nowrap;
    transition: background 0.15s;
  }
  .ctx-item:hover         { background: rgba(99,102,241,0.12); color: #818cf8; }
  .ctx-item.ctx-danger:hover { background: rgba(239,68,68,0.1); color: #ef4444; }
  .ctx-divider { height: 1px; background: #2d3a52; margin: 4px 0; }
  [data-theme="light"] #prodContextMenu { background: #fff; border-color: #e2e8f0; box-shadow: 0 12px 40px rgba(0,0,0,0.15); }
  [data-theme="light"] .ctx-item { color: #1e293b; }
  [data-theme="light"] .ctx-divider { background: #e2e8f0; }

  /* ‚îÄ‚îÄ Mobile responsive ‚îÄ‚îÄ */
  @media (max-width: 640px) {
    .wh-kpi { grid-template-columns: repeat(2, 1fr); }
    .wh-page-hd { flex-direction: column; align-items: flex-start; gap: 10px; }
    .wh-page-hd > div:last-child { width: 100%; display: flex; flex-wrap: wrap; gap: 8px; }
    .wh-toolbar { flex-wrap: wrap; gap: 8px; }
    .wh-toolbar .wh-search { width: 100% !important; min-width: unset; }
    .wh-toolbar .wh-select { width: 100% !important; }
    .wh-form-grid { grid-template-columns: 1fr !important; }
    .wh-form-field[style*="grid-column"] { grid-column: span 1 !important; }
    .wh-item-row { flex-direction: column; gap: 10px; }
    .wh-table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    #toast-container { top: 10px; right: 10px; left: 10px; }
    .toast { min-width: unset; max-width: unset; }

    /* Product table ‚Äî hide secondary calc columns, allow horizontal scroll */
    .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    /* Products table: hide less important columns, keep –¢–æ–≤–∞—Ä/–†–∞–∑–º–µ—Ä/–¶–µ–Ω–∞/–ü—Ä–∏–±—ã–ª—å */
    #productsTable th:nth-child(2),  /* checkbox */
    #productsTable td:nth-child(2),
    #productsTable th:nth-child(3),  /* # */
    #productsTable td:nth-child(3),
    #productsTable th:nth-child(7),  /* –ö–æ–ª-–≤–æ */
    #productsTable td:nth-child(7),
    #productsTable th:nth-child(8),  /* –õ–æ–≥–∏—Å—Ç–∏–∫–∞ */
    #productsTable td:nth-child(8),
    #productsTable th:nth-child(9),  /* –ö–æ–º–∏—Å—Å–∏—è */
    #productsTable td:nth-child(9),
    #productsTable th:nth-child(10), /* –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥ */
    #productsTable td:nth-child(10),
    #productsTable th:nth-child(11), /* –°–µ–±–µ—Å—Ç. */
    #productsTable td:nth-child(11),
    #productsTable th:nth-child(12), /* –¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏ */
    #productsTable td:nth-child(12),
    #productsTable th:nth-child(14), /* –ü—Ä–æ–¥–∞–Ω–æ */
    #productsTable td:nth-child(14) { display: none !important; }
    /* Remove min-width on product name column */
    #productsTable th:nth-child(4) { min-width: 120px !important; }
    /* Warehouse sub-nav: scrollable row */
    .wh-subnav { display:flex;overflow-x:auto;gap:6px;padding:0 0 12px;-webkit-overflow-scrolling:touch;scrollbar-width:none; }
    .wh-subnav::-webkit-scrollbar { display:none; }
    .wh-subnav-btn { flex-shrink:0;background:#111422;border:1px solid #1e2235;border-radius:20px;color:#4f5a7a;font-size:0.78rem;font-weight:600;padding:7px 14px;cursor:pointer;white-space:nowrap;transition:all 0.18s; }
    .wh-subnav-btn.active { background:#6366f1;border-color:#6366f1;color:#fff; }
    [data-theme="light"] .wh-subnav-btn { background:#f8fafc;border-color:#e2e8f0;color:#64748b; }
    [data-theme="light"] .wh-subnav-btn.active { background:#6366f1;border-color:#6366f1;color:#fff; }

    /* Header nav ‚Äî wrap to avoid overflow */
    .header-nav { flex-wrap: wrap; }
    .htab { padding: 6px 8px; font-size: 0.72rem; }

    /* Products header ‚Äî stack buttons */
    .products-header { flex-direction: column; gap: 8px; align-items: flex-start; }
    .products-header > div { display: flex; gap: 6px; width: 100%; }
    .products-header .btn-add { flex: 1; justify-content: center; }

    /* Prod filter bar */
    .prod-filter-bar { flex-direction: column; align-items: stretch; }
    .prod-search { width: 100% !important; }
    .prod-tags { flex-wrap: nowrap; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; padding-bottom: 2px; }
    .prod-tags::-webkit-scrollbar { display: none; }
    .prod-filter-bar select { width: 100% !important; }

    /* Paginator */
    #paginator { flex-wrap: wrap; }
    #paginator button { width: 44px; height: 44px; font-size: 1rem; }
  }

  /* ‚îÄ‚îÄ Break-even price ‚îÄ‚îÄ */
  .be-price { font-size: 0.67rem; color: #4f5a7a; display: block; margin-top: 1px; }
  [data-theme="light"] .be-price { color: #94a3b8; }
  /* ACoS hint in profit cell */
  .acos-hint { font-size: 0.63rem; color: #06b6d4; display: block; margin-top: 1px; }
  /* Inventory remaining in sold cell */
  .sold-rem { font-size: 0.65rem; display: block; margin-top: 2px; color: #64748b; }
  .sold-rem.warn { color: #f59e0b; }
  .sold-rem.out  { color: #22c55e; font-weight: 700; }
  /* Top/Bottom ranked cards */
  .top-bottom-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
  .rank-card { background: #0f1117; border: 1px solid #1e2235; border-radius: 12px; padding: 14px 16px; }
  [data-theme="light"] .rank-card { background: #f8fafc; border-color: #e2e8f0; }
  .rank-card-title { font-size: 0.68rem; color: #64748b; font-weight: 700; margin-bottom: 10px; letter-spacing: 0.06em; text-transform: uppercase; }
  .rank-item { display: flex; align-items: center; gap: 8px; padding: 5px 0; border-bottom: 1px solid #1a1d2e; font-size: 0.76rem; }
  .rank-item:last-child { border: none; }
  .rank-pos { font-weight: 700; color: #4f5a7a; width: 16px; flex-shrink: 0; }
  .rank-nm  { flex: 1; color: #94a3b8; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 120px; }
  .rank-vl  { font-weight: 700; flex-shrink: 0; }
  /* Analytics mode toggle */
  .analytics-mode-toggle { display:flex; gap:6px; margin-bottom:14px; }
  .analytics-mode-btn { padding:6px 16px; border-radius:20px; border:1px solid #1e2235; background:transparent; color:#4f5a7a; font-size:0.8rem; font-weight:600; cursor:pointer; transition:all 0.15s; }
  .analytics-mode-btn.active { background:#6366f1; border-color:#6366f1; color:#fff; }
  .analytics-mode-btn:hover:not(.active) { border-color:#6366f1; color:#818cf8; }
  [data-theme="light"] .analytics-mode-btn { border-color:#e2e8f0; color:#64748b; }
  [data-theme="light"] .analytics-mode-btn.active { background:#6366f1; border-color:#6366f1; color:#fff; }
  .analytics-no-data { text-align:center; padding:60px 20px; color:#4f5a7a; font-size:0.9rem; line-height:1.8; }

  /* ‚îÄ‚îÄ ABC analysis badges ‚îÄ‚îÄ */
  .abc-badge { font-size: 0.65rem; font-weight: 800; letter-spacing: 0.03em; }
  .abc-badge.abc-a { color: #22c55e; }
  .abc-badge.abc-b { color: #f59e0b; }
  .abc-badge.abc-c { color: #ef4444; }

  /* ‚îÄ‚îÄ Paginator ‚îÄ‚îÄ */
  #paginator {
    display: none; align-items: center; justify-content: center;
    gap: 10px; padding: 14px 0; border-top: 1px solid #1e2235;
  }
  #paginator button {
    background: #111422; border: 1px solid #1e2235; border-radius: 8px;
    color: #818cf8; font-size: 0.9rem; width: 34px; height: 34px;
    cursor: pointer; transition: background 0.15s;
  }
  #paginator button:hover:not(:disabled) { background: rgba(99,102,241,0.15); }
  #paginator button:disabled { opacity: 0.3; cursor: default; }
  #pagCur { font-size: 0.8rem; color: #4f5a7a; }
  [data-theme="light"] #paginator { border-color: #e2e8f0; }
  [data-theme="light"] #paginator button { background: #f8fafc; border-color: #e2e8f0; }

  /* ‚îÄ‚îÄ Low stock badge ‚îÄ‚îÄ */
  .low-stock-badge {
    display: inline-block; font-size: 0.65rem; font-weight: 700;
    padding: 1px 5px; border-radius: 5px; margin-left: 4px;
    vertical-align: middle; white-space: nowrap;
  }
  .low-stock-badge.warn  { background: rgba(245,158,11,0.15); color: #f59e0b; }
  .low-stock-badge.empty { background: rgba(239,68,68,0.15);  color: #ef4444; }

  /* ‚îÄ‚îÄ Toast notifications ‚îÄ‚îÄ */
  #toast-container {
    position: fixed; top: 18px; right: 18px; z-index: 99999;
    display: flex; flex-direction: column; gap: 10px;
    pointer-events: none;
  }
  .toast {
    display: flex; align-items: flex-start; gap: 10px;
    padding: 13px 16px; border-radius: 12px;
    background: #1e293b; border: 1px solid rgba(255,255,255,0.1);
    box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    min-width: 260px; max-width: 360px;
    animation: toastIn 0.28s cubic-bezier(.22,.68,0,1.2) both;
    pointer-events: all; cursor: pointer;
  }
  .toast.removing { animation: toastOut 0.22s ease forwards; }
  .toast-icon { font-size: 1.1rem; flex-shrink: 0; margin-top: 1px; }
  .toast-body { flex: 1; font-size: 0.84rem; line-height: 1.45; color: #e2e8f0; }
  .toast-title { font-weight: 700; margin-bottom: 2px; font-size: 0.82rem; }
  .toast-msg   { opacity: 0.85; }
  .toast.success { border-color: rgba(34,197,94,0.4); background: #0f2820; }
  .toast.error   { border-color: rgba(239,68,68,0.4);  background: #2a0f0f; }
  .toast.warning { border-color: rgba(251,191,36,0.4); background: #2a1f00; }
  .toast.info    { border-color: rgba(99,102,241,0.4); background: #12122a; }
  .toast-bar {
    position: absolute; bottom: 0; left: 0; height: 3px; border-radius: 0 0 12px 12px;
    animation: toastBar linear both;
  }
  .toast { position: relative; overflow: hidden; }
  .toast.success .toast-bar { background: #22c55e; }
  .toast.error   .toast-bar { background: #ef4444; }
  .toast.warning .toast-bar { background: #fbbf24; }
  .toast.info    .toast-bar { background: #818cf8; }
  [data-theme="light"] .toast { background: #fff; border-color: #e2e8f0; box-shadow: 0 8px 32px rgba(0,0,0,0.12); }
  [data-theme="light"] .toast-body { color: #1e293b; }
  [data-theme="light"] .toast.success { background: #f0fdf4; border-color: rgba(34,197,94,0.4); }
  [data-theme="light"] .toast.error   { background: #fff5f5; border-color: rgba(239,68,68,0.4); }
  [data-theme="light"] .toast.warning { background: #fffbeb; border-color: rgba(251,191,36,0.4); }
  [data-theme="light"] .toast.info    { background: #f5f3ff; border-color: rgba(99,102,241,0.4); }
  @keyframes toastIn  { from { opacity:0; transform:translateX(60px) scale(0.9); } to { opacity:1; transform:none; } }
  @keyframes toastOut { to   { opacity:0; transform:translateX(70px) scale(0.88); } }
  @keyframes toastBar { from { width:100%; } to { width:0%; } }

  /* ‚îÄ‚îÄ Modal Tabs ‚îÄ‚îÄ */
  .modal-tabs { display: flex; border-bottom: 1px solid #1e2235; padding: 0 4px; flex-shrink: 0; }
  .modal-tab { padding: 11px 18px; font-size: 0.79rem; font-weight: 600; cursor: pointer; color: #4f5a7a; border: none; border-bottom: 2px solid transparent; margin-bottom: -1px; background: none; transition: all 0.18s; white-space: nowrap; }
  .modal-tab.active { color: #818cf8; border-bottom-color: #6366f1; }
  .modal-tab:hover:not(.active) { color: #94a3b8; }
  [data-theme="light"] .modal-tabs { border-color: #dde3ed; }
  [data-theme="light"] .modal-tab.active { color: #6366f1; border-bottom-color: #6366f1; }

  /* ‚îÄ‚îÄ Form textarea ‚îÄ‚îÄ */
  .form-textarea { width: 100%; background: #0a0c12; border: 1px solid #1e2235; border-radius: 9px; color: #e2e8f0; font-size: 0.84rem; padding: 9px 12px; outline: none; resize: vertical; min-height: 82px; font-family: inherit; line-height: 1.5; transition: border-color 0.2s; }
  .form-textarea:focus { border-color: #6366f1; }
  [data-theme="light"] .form-textarea { background: #f8fafc; border-color: #dde3ed; color: #1e293b; }

  /* ‚îÄ‚îÄ Char counter ‚îÄ‚îÄ */
  .char-counter { font-size: 0.68rem; color: #4f5a7a; text-align: right; margin-top: 2px; }

  /* ‚îÄ‚îÄ Modal section heading ‚îÄ‚îÄ */
  .modal-section-hd { font-size: 0.72rem; font-weight: 700; color: #818cf8; text-transform: uppercase; letter-spacing: 0.07em; margin: 14px 0 10px; display: flex; align-items: center; gap: 8px; }
  .modal-section-hd::after { content: ''; flex: 1; height: 1px; background: #1e2235; }
  [data-theme="light"] .modal-section-hd { color: #6366f1; }
  [data-theme="light"] .modal-section-hd::after { background: #e2e8f0; }

  /* ‚îÄ‚îÄ Characteristic row ‚îÄ‚îÄ */
  .char-row { display: grid; grid-template-columns: 1fr 1fr 32px; gap: 8px; align-items: center; padding: 5px 0; border-bottom: 1px solid #161928; }
  .char-row:last-child { border-bottom: none; }
  [data-theme="light"] .char-row { border-color: #f0f4f8; }

  /* ‚îÄ‚îÄ Category management ‚îÄ‚îÄ */
  .cat-mgmt-item { display: flex; align-items: center; justify-content: space-between; padding: 10px 20px; border-bottom: 1px solid #1e2235; gap: 12px; transition: background 0.15s; }
  .cat-mgmt-item:hover { background: rgba(99,102,241,0.03); }
  .cat-mgmt-item:last-child { border-bottom: none; }
  .cat-mgmt-name { font-size: 0.84rem; flex: 1; }
  .cat-mgmt-del { background: none; border: none; color: #2d3455; font-size: 16px; cursor: pointer; padding: 3px 7px; border-radius: 6px; transition: all 0.18s; flex-shrink: 0; }
  .cat-mgmt-del:hover { color: #ef4444; background: rgba(239,68,68,0.08); }
  [data-theme="light"] .cat-mgmt-item { border-color: #e2e8f0; }
  [data-theme="light"] .cat-mgmt-del { color: #cbd5e1; }
  [data-theme="light"] .cat-mgmt-item:hover { background: #f8fafc; }

  /* ‚îÄ‚îÄ Messenger chips ‚îÄ‚îÄ */
  .messenger-chips { display: flex; gap: 7px; flex-wrap: wrap; }
  .messenger-chip { display: inline-flex; align-items: center; gap: 5px; padding: 6px 12px; border-radius: 20px; border: 1.5px solid #1e2235; background: none; color: #4f5a7a; font-size: 0.78rem; cursor: pointer; transition: all 0.18s; user-select: none; }
  .messenger-chip:hover { border-color: #6366f1; color: #818cf8; }
  .messenger-chip.selected { background: rgba(99,102,241,0.12); border-color: #6366f1; color: #818cf8; font-weight: 600; }
  [data-theme="light"] .messenger-chip { border-color: #dde3ed; color: #94a3b8; }
  [data-theme="light"] .messenger-chip.selected { background: rgba(99,102,241,0.08); border-color: #6366f1; color: #6366f1; }

  /* ‚îÄ‚îÄ Category select ‚îÄ‚îÄ */
  .am-select { width: 100%; background: #0a0c12; border: 1px solid #1e2235; border-radius: 9px; color: #e2e8f0; font-size: 0.88rem; padding: 9px 12px; outline: none; cursor: pointer; transition: border-color 0.2s; }
  .am-select:focus { border-color: #6366f1; }
  [data-theme="light"] .am-select { background: #f8fafc; border-color: #dde3ed; color: #1e293b; }

  /* ‚îÄ‚îÄ Unified Settings Modal ‚îÄ‚îÄ */
  .settings-modal { display: flex; flex-direction: column; width: 520px; max-width: 95vw; max-height: 86vh; background: #0d0f1a; border: 1px solid #1e2235; border-radius: 16px; overflow: hidden; }
  [data-theme="light"] .settings-modal { background: #fff; border-color: #e2e8f0; }
  .settings-head { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid #1e2235; flex-shrink: 0; }
  [data-theme="light"] .settings-head { border-color: #e2e8f0; }
  .settings-head-title { font-weight: 700; font-size: 0.97rem; color: #e2e8f0; }
  [data-theme="light"] .settings-head-title { color: #1e293b; }
  .settings-tabs { display: flex; border-bottom: 1px solid #1e2235; flex-shrink: 0; }
  [data-theme="light"] .settings-tabs { border-color: #e2e8f0; }
  .settings-tab { flex: 1; padding: 12px 6px; font-size: 0.8rem; font-weight: 600; cursor: pointer; color: #4f5a7a; border: none; border-bottom: 2px solid transparent; margin-bottom: -1px; background: none; transition: all 0.18s; text-align: center; }
  .settings-tab.active { color: #818cf8; border-bottom-color: #6366f1; }
  [data-theme="light"] .settings-tab { color: #94a3b8; }
  [data-theme="light"] .settings-tab.active { color: #6366f1; }
  .settings-body { flex: 1; overflow-y: auto; min-height: 0; }
  .settings-list { list-style: none; margin: 0; padding: 0; }
  .settings-list-item { display: flex; align-items: center; gap: 10px; padding: 10px 20px; border-bottom: 1px solid #1e2235; transition: background 0.15s; }
  .settings-list-item:hover { background: rgba(99,102,241,0.04); }
  [data-theme="light"] .settings-list-item { border-color: #f1f5f9; }
  .settings-list-name { flex: 1; font-size: 0.88rem; color: #e2e8f0; }
  [data-theme="light"] .settings-list-name { color: #1e293b; }
  .settings-list-del { background: none; border: none; color: #2d3455; font-size: 16px; cursor: pointer; padding: 3px 8px; border-radius: 6px; transition: all 0.18s; flex-shrink: 0; line-height: 1; }
  .settings-list-del:hover { color: #ef4444; background: rgba(239,68,68,0.08); }
  .settings-add-row { display: flex; gap: 8px; padding: 14px 20px; border-top: 1px solid #1e2235; flex-shrink: 0; }
  [data-theme="light"] .settings-add-row { border-color: #e2e8f0; }
  .settings-empty { padding: 32px 20px; text-align: center; color: #4f5a7a; font-size: 0.82rem; }

  /* ‚îÄ‚îÄ Filter selects ‚îÄ‚îÄ */
  .prod-filter-sel { background: #0a0c12; border: 1px solid #1e2235; border-radius: 8px; color: #94a3b8; font-size: 0.78rem; padding: 5px 10px; outline: none; cursor: pointer; transition: border-color 0.2s; max-width: 150px; }
  .prod-filter-sel:focus { border-color: #6366f1; }
  [data-theme="light"] .prod-filter-sel { background: #f8fafc; border-color: #dde3ed; color: #64748b; }

  /* ‚îÄ‚îÄ Files dropdown menu ‚îÄ‚îÄ */
  .files-menu-item { display: block; width: 100%; text-align: left; background: none; border: none; color: #94a3b8; font-size: 0.83rem; padding: 7px 10px; border-radius: 7px; cursor: pointer; transition: all 0.15s; white-space: nowrap; }
  .files-menu-item:hover { background: rgba(99,102,241,0.1); color: #e2e8f0; }
  [data-theme="light"] #filesMenu { background: #fff; border-color: #e2e8f0; box-shadow: 0 8px 24px rgba(0,0,0,0.1); }
  [data-theme="light"] .files-menu-item { color: #64748b; }
  [data-theme="light"] .files-menu-item:hover { background: #f1f5f9; color: #1e293b; }

  /* ‚îÄ‚îÄ Margin Alert row highlighting ‚îÄ‚îÄ */
  .row-margin-alert td { background: rgba(245,158,11,0.04) !important; }
  .row-margin-alert td:first-child { box-shadow: inset 3px 0 0 #f59e0b; }
  [data-theme="light"] .row-margin-alert td { background: rgba(245,158,11,0.07) !important; }

  /* ‚îÄ‚îÄ Sales Tracker column ‚îÄ‚îÄ */
  .col-sold { white-space: nowrap; }
  .sold-profit { font-size: 0.63rem; color: #22c55e; display: block; margin-top: 2px; white-space: nowrap; }
  .sold-input { width: 62px !important; min-width: 62px !important; padding: 3px 7px !important; font-size: 0.78rem !important; text-align: center; }
  [data-theme="light"] .sold-profit { color: #16a34a; }

  /* ‚îÄ‚îÄ Mobile improvements (768px) ‚îÄ‚îÄ */
  @media (max-width: 768px) {
    .header { padding: 0 10px; gap: 6px; }
    .header h1 { display: none; }
    .header-nav { margin-left: 6px; }
    .hdr-btn { font-size: 0.78rem; padding: 4px 7px; }
    .theme-btn { width: 30px; height: 30px; font-size: 14px; }

    .page { padding: 10px 12px; }

    /* Full-screen modals on mobile */
    .add-modal-overlay { padding: 0; align-items: flex-end; }
    .add-modal { border-radius: 16px 16px 0 0; max-height: 95vh; max-width: 100%; }
    .modal-overlay { align-items: flex-end; padding: 0; }
    .settings-modal { width: 100% !important; max-width: 100% !important; border-radius: 16px 16px 0 0; max-height: 92vh; }
    .settings-tabs { overflow-x: auto; flex-wrap: nowrap; -webkit-overflow-scrolling: touch; }
    .settings-tab { flex: none; padding: 10px 10px; font-size: 0.72rem; white-space: nowrap; }

    /* Form rows stack vertically on mobile */
    .form-row { grid-template-columns: 1fr; }

    /* Dashboard */
    .dash-kpi-row { grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .dash-grid { grid-template-columns: 1fr; }

    /* KPI strip ‚Äî 4 cols on medium, 2 on small */
    .kpi-strip { grid-template-columns: repeat(4, 1fr); }
    .kpi-card { padding: 10px 12px; }
    .kpi-value { font-size: 0.9rem; }
    .kpi-label { font-size: 0.58rem; }

    /* Warehouse KPIs */
    .wh-kpi { grid-template-columns: repeat(2, 1fr); }
  }
  @media (max-width: 480px) {
    .kpi-strip { grid-template-columns: repeat(2, 1fr); }
    .kpi-card:nth-child(even) { border-right: none; }
    .kpi-card:nth-child(4n) { border-right: 1px solid #1e2235; }
    .header-nav { gap: 0; }
    .htab { padding: 5px 7px; font-size: 0.7rem; }
  }

  /* ‚îÄ‚îÄ Mobile bottom navigation ‚îÄ‚îÄ */
  .mobile-nav { display: none; }
  @media (max-width: 768px) {
    /* Bottom nav bar */
    .mobile-nav {
      display: flex;
      position: fixed;
      bottom: 0; left: 0; right: 0;
      z-index: 9999;
      background: #111422;
      border-top: 1px solid #1e2235;
      padding-bottom: env(safe-area-inset-bottom);
    }
    .mobile-nav-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
      background: none;
      border: none;
      padding: 8px 4px 6px;
      color: #4f5a7a;
      cursor: pointer;
      transition: color 0.18s;
    }
    .mobile-nav-btn.active { color: #6366f1; }
    .mobile-nav-icon { font-size: 1.3rem; line-height: 1; }
    .mobile-nav-label { font-size: 0.6rem; font-weight: 600; }
    /* Hide header nav on mobile */
    .header-nav { display: none !important; }
    .header h1 { display: none !important; }
    .header { padding: 0 12px !important; gap: 8px !important; }
    /* Push page content above bottom nav */
    .page { padding-bottom: 80px !important; }
    /* Touch-friendly buttons */
    .hdr-btn { min-width: 36px; min-height: 36px; display: flex; align-items: center; justify-content: center; }
    /* Sales table: hide "–î–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∏—è" and "SKU" columns */
    #tab-sales .wh-table th:nth-child(3),
    #tab-sales .wh-table td:nth-child(3),
    #tab-sales .wh-table th:nth-child(5),
    #tab-sales .wh-table td:nth-child(5) { display: none; }
  }
  [data-theme="light"] .mobile-nav { background: #fff; border-top-color: #e2e8f0; }
  [data-theme="light"] .mobile-nav-btn { color: #94a3b8; }
  [data-theme="light"] .mobile-nav-btn.active { color: #6366f1; }

  /* ‚îÄ‚îÄ Column sort arrows ‚îÄ‚îÄ */
  thead th.sortable { cursor: pointer; white-space: nowrap; }
  thead th.sortable:hover { color: #818cf8; }
  .sort-arrow { font-size: 0.7em; margin-left: 3px; color: #6366f1; }

  /* ‚îÄ‚îÄ Drag & drop row sorting ‚îÄ‚îÄ */
  .drag-handle { cursor: grab; color: #2d3455; font-size: 0.9rem; padding: 0 6px; user-select: none; display: block; }
  .drag-handle:hover { color: #6366f1; }
  .row-dragging { opacity: 0.42; }
  .row-drag-over td { box-shadow: inset 0 -2px 0 #6366f1; }
  </style>
</head>
<body>

<div id="toast-container"></div>

<!-- ‚ïê‚ïê‚ïê CONTEXT MENU ‚ïê‚ïê‚ïê -->
<div id="prodContextMenu">
  <div class="ctx-item" onclick="ctxEdit()">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
  <div class="ctx-item" onclick="ctxDuplicate()">üìã –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å</div>
  <div class="ctx-divider"></div>
  <div class="ctx-item ctx-danger" onclick="ctxDelete()">üóë –£–¥–∞–ª–∏—Ç—å</div>
</div>

<!-- ‚ïê‚ïê‚ïê AUTH OVERLAY ‚ïê‚ïê‚ïê -->
<div id="authOverlay" class="auth-overlay show">
  <div class="auth-card">
    <div class="auth-logo">üì¶</div>
    <div class="auth-brand">–ü—Ä–∞–π—Å–µ—Ä —Ç–æ–≤–∞—Ä–æ–≤</div>
    <div class="auth-tabs">
      <button class="auth-tab active" onclick="switchAuthTab('login')">–í–æ–π—Ç–∏</button>
      <button class="auth-tab" onclick="switchAuthTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    </div>
    <div class="auth-form">
      <input type="email" id="authEmail" placeholder="Email" autocomplete="email" onkeydown="if(event.key==='Enter')authSubmit()" />
      <input type="password" id="authPass" placeholder="–ü–∞—Ä–æ–ª—å" autocomplete="current-password" onkeydown="if(event.key==='Enter')authSubmit()" />
      <div id="authError" class="auth-error"></div>
      <button class="auth-submit" id="authSubmitBtn" onclick="authSubmit()">–í–æ–π—Ç–∏</button>
      <button class="auth-reset-link" onclick="authResetPassword()">–ó–∞–±—ã–ª–∏ –ø–∞—Ä–æ–ª—å?</button>
      <div class="auth-divider">–∏–ª–∏</div>
      <button class="auth-google" id="authGoogleBtn" onclick="authGoogleSignIn()">
        <svg width="18" height="18" viewBox="0 0 18 18"><path fill="#4285F4" d="M17.64 9.2c0-.637-.057-1.251-.164-1.84H9v3.481h4.844c-.209 1.125-.843 2.078-1.796 2.717v2.258h2.908c1.702-1.567 2.684-3.874 2.684-6.615z"/><path fill="#34A853" d="M9 18c2.43 0 4.467-.806 5.956-2.18l-2.908-2.259c-.806.54-1.837.86-3.048.86-2.344 0-4.328-1.584-5.036-3.711H.957v2.332A8.997 8.997 0 0 0 9 18z"/><path fill="#FBBC05" d="M3.964 10.71A5.41 5.41 0 0 1 3.682 9c0-.593.102-1.17.282-1.71V4.958H.957A8.996 8.996 0 0 0 0 9c0 1.452.348 2.827.957 4.042l3.007-2.332z"/><path fill="#EA4335" d="M9 3.58c1.321 0 2.508.454 3.44 1.345l2.582-2.58C13.463.891 11.426 0 9 0A8.997 8.997 0 0 0 .957 4.958L3.964 6.29C4.672 4.163 6.656 3.58 9 3.58z"/></svg>
        –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
      </button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê PIN LOCK OVERLAY ‚ïê‚ïê‚ïê -->
<div id="pinOverlay">
  <div class="pin-logo">üîê</div>
  <div class="pin-title">–í–≤–µ–¥–∏—Ç–µ PIN-–∫–æ–¥</div>
  <div class="pin-dots">
    <div class="pin-dot" id="pd0"></div>
    <div class="pin-dot" id="pd1"></div>
    <div class="pin-dot" id="pd2"></div>
    <div class="pin-dot" id="pd3"></div>
  </div>
  <div class="pin-error" id="pinError"></div>
  <div class="pin-pad">
    <button class="pin-key" onclick="pinKey('1')">1</button>
    <button class="pin-key" onclick="pinKey('2')">2</button>
    <button class="pin-key" onclick="pinKey('3')">3</button>
    <button class="pin-key" onclick="pinKey('4')">4</button>
    <button class="pin-key" onclick="pinKey('5')">5</button>
    <button class="pin-key" onclick="pinKey('6')">6</button>
    <button class="pin-key" onclick="pinKey('7')">7</button>
    <button class="pin-key" onclick="pinKey('8')">8</button>
    <button class="pin-key" onclick="pinKey('9')">9</button>
    <button class="pin-key back" onclick="pinKey('back')">‚å´</button>
    <button class="pin-key" onclick="pinKey('0')">0</button>
    <button class="pin-key enter" onclick="pinKey('enter')">‚úì</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê BACKUP FILE INPUT ‚ïê‚ïê‚ïê -->
<input type="file" id="backupRestoreInput" accept=".json" style="display:none" onchange="importBackup(this.files[0])">
<input type="file" id="importXlsxInput" accept=".xlsx,.xls,.csv" style="display:none" onchange="importXLSX(this.files[0])">

<!-- ‚ïê‚ïê‚ïê ADD PRODUCT MODAL ‚ïê‚ïê‚ïê -->
<div class="add-modal-overlay" id="addModal">
  <div class="add-modal">
    <div class="add-modal-head">
      <h3>–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä</h3>
      <button class="add-modal-close" onclick="closeAddModal()">√ó</button>
    </div>
    <div class="modal-tabs">
      <button class="modal-tab active" id="amTab1" onclick="switchModalTab('main')">üì¶ –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ</button>
      <button class="modal-tab" id="amTab2" onclick="switchModalTab('desc')">üìù –û–ø–∏—Å–∞–Ω–∏–µ</button>
    </div>
    <div id="am-tab-main" class="add-modal-body">

      <!-- Photo -->
      <div>
        <div style="font-size:0.75rem;color:#64748b;margin-bottom:8px;font-weight:500">–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è —Ç–æ–≤–∞—Ä–∞</div>
        <div class="photo-upload-area" id="photoDropZone" onclick="document.getElementById('photoFileInput').click()">
          <input type="file" id="photoFileInput" accept="image/*" onchange="handlePhotoSelect(event)" />
          <div class="photo-preview" id="photoPreview">
            <img id="photoPreviewImg" src="" alt="preview" />
            <button class="photo-preview-remove" onclick="removePhoto(event)" title="–£–¥–∞–ª–∏—Ç—å —Ñ–æ—Ç–æ">√ó</button>
          </div>
          <div id="photoPlaceholder">
            <div class="photo-upload-icon">üì∑</div>
            <div class="photo-upload-text">–ù–∞–∂–º–∏—Ç–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–æ—Ç–æ</div>
            <div class="photo-upload-hint">JPG, PNG, WEBP –¥–æ 5 –ú–ë</div>
          </div>
        </div>
      </div>

      <!-- Code + Name -->
      <div class="form-row">
        <div class="form-field">
          <label>–ê—Ä—Ç–∏–∫—É–ª / –ö–æ–¥</label>
          <input type="text" id="am-code" placeholder="8516 KAHVE" />
        </div>
        <div class="form-field">
          <label>–¶–µ–Ω–∞ –∑–∞–∫—É–ø–∫–∏, $</label>
          <input type="number" id="am-usd" placeholder="0.00" min="0" step="0.01" />
        </div>
        <div class="form-field full">
          <label>–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</label>
          <input type="text" id="am-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" />
        </div>
        <div class="form-field full">
          <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="am-category" class="am-select" style="flex:1">
              <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é ‚Äî</option>
            </select>
            <button onclick="openSettings('cats')" style="background:none;border:1px solid #1e2235;border-radius:9px;color:#818cf8;font-size:0.78rem;padding:9px 12px;cursor:pointer;white-space:nowrap;flex-shrink:0">‚öô</button>
          </div>
        </div>
        <div class="form-field full">
          <label>–°—Ç—Ä–∞–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞</label>
          <select id="am-country" class="am-select">
            <option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É ‚Äî</option>
          </select>
        </div>
        <div class="form-field full">
          <label>–ü–æ—Å—Ç–∞–≤—â–∏–∫</label>
          <div style="display:flex;gap:8px;align-items:center">
            <select id="am-supplier" class="am-select" style="flex:1">
              <option value="">‚Äî –ë–µ–∑ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ ‚Äî</option>
            </select>
            <button onclick="openSettings('suppliers')" style="background:none;border:1px solid #1e2235;border-radius:9px;color:#818cf8;font-size:0.78rem;padding:9px 12px;cursor:pointer;white-space:nowrap;flex-shrink:0">‚öô</button>
          </div>
        </div>
      </div>

      <!-- Size selector -->
      <div class="size-section">
        <div class="size-label">
          <span>–†–∞–∑–º–µ—Ä / –í–æ–∑—Ä–∞—Å—Ç <span style="color:#2d3455;font-weight:400">(–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ)</span></span>
          <div style="display:flex;gap:8px;align-items:center">
            <button class="size-manage-btn" id="sizeSelAllBtn" onclick="selectAllSizes()" style="color:#06b6d4">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ</button>
            <button class="size-manage-btn" onclick="openSettings('sizes')">‚öô –†–∞–∑–º–µ—Ä—ã</button>
          </div>
        </div>
        <div class="size-chips" id="sizeChipsContainer"></div>
        <div id="sizeSelHint" style="font-size:0.72rem;color:#4f5a7a;margin-top:2px;transition:color 0.2s"></div>
      </div>

      <!-- Qty -->
      <div class="form-row">
        <div class="form-field">
          <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ (–≤ —É–ø–∞–∫–æ–≤–∫–µ)</label>
          <input type="number" id="am-qty" placeholder="6" min="1" value="6" />
        </div>
        <div class="form-field" style="justify-content:flex-end">
          <label>&nbsp;</label>
          <div style="font-size:0.75rem;color:#2d3455;padding:9px 0">–ö–æ–ª-–≤–æ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–∞—Å—á—ë—Ç –ª–æ–≥–∏—Å—Ç–∏–∫–∏ –Ω–∞ —é–Ω–∏—Ç</div>
        </div>
      </div>

      <!-- Rate + Logistics + Margin panel -->
      <div class="am-info-panel" style="flex-direction:column;gap:14px">

        <!-- Exchange rate + Logistics (side by side) -->
        <div class="form-row">
          <div class="form-field">
            <label>–ö—É—Ä—Å –¥–æ–ª–ª–∞—Ä–∞ (—Å—É–º/$)</label>
            <div class="input-row">
              <input type="number" id="am-rate" placeholder="12519" min="1" step="1"
                oninput="onModalRateInput()" />
              <span class="badge">—Å—É–º/$</span>
            </div>
          </div>
          <div class="form-field">
            <label>–õ–æ–≥–∏—Å—Ç–∏–∫–∞ –Ω–∞ —é–Ω–∏—Ç <span style="color:#2d3455;font-weight:400">(—Å—É–º)</span></label>
            <div class="input-row">
              <input type="number" id="am-logistics" placeholder="0" min="0" step="1" />
              <span class="badge">—Å—É–º</span>
            </div>
            <div style="font-size:0.68rem;color:#4f5a7a;margin-top:3px">0 = –∏–∑ –æ–±—â–µ–π –ª–æ–≥–∏—Å—Ç–∏–∫–∏</div>
          </div>
        </div>

        <!-- Margin -->
        <div class="form-field" style="width:100%">
          <label>–ú–∞—Ä–∂–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Ç–æ–≤–∞—Ä–∞</label>
          <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-top:4px">
            <div class="margin-selector" id="am-margin-selector" style="flex-wrap:wrap">
              <button class="margin-btn" onclick="setModalMargin(20,this)">20%</button>
              <button class="margin-btn" onclick="setModalMargin(25,this)">25%</button>
              <button class="margin-btn" onclick="setModalMargin(30,this)">30%</button>
              <button class="margin-btn" onclick="setModalMargin(40,this)">40%</button>
              <button class="margin-btn" onclick="setModalMargin(50,this)">50%</button>
              <button class="margin-btn" onclick="setModalMargin(60,this)">60%</button>
            </div>
            <div style="display:flex;align-items:center;gap:4px">
              <input type="number" id="am-margin-input" min="1" max="99" step="1" placeholder="30"
                style="width:64px;padding:5px 8px;font-size:0.82rem"
                oninput="onModalMarginInput()" />
              <span class="badge" style="padding:5px 8px">%</span>
            </div>
          </div>
        </div>

      </div>

    </div><!-- /am-tab-main -->

    <!-- ‚ïê‚ïê‚ïê DESCRIPTION TAB ‚ïê‚ïê‚ïê -->
    <div id="am-tab-desc" class="add-modal-body" style="display:none">

      <!-- Names -->
      <div class="modal-section-hd">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</div>
      <div class="form-field full">
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ (—É–∑–±–µ–∫—Å–∫–∏–π) <span style="color:#4f5a7a;font-weight:400">–º–∞–∫—Å. 90 —Å–∏–º–≤–æ–ª–æ–≤</span></label>
        <input type="text" id="am-name-uz" placeholder="Mahsulot nomi (UZ)" maxlength="90"
          oninput="updateCharCount(this,'am-cnt-nameuz',90)" />
        <div class="char-counter"><span id="am-cnt-nameuz">0</span>/90</div>
      </div>
      <div class="form-field full">
        <label>–ù–∞–∑–≤–∞–Ω–∏–µ (—Ä—É—Å—Å–∫–∏–π) <span style="color:#4f5a7a;font-weight:400">–º–∞–∫—Å. 90 —Å–∏–º–≤–æ–ª–æ–≤</span></label>
        <input type="text" id="am-name-ru" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ (RU)" maxlength="90"
          oninput="updateCharCount(this,'am-cnt-nameru',90)" />
        <div class="char-counter"><span id="am-cnt-nameru">0</span>/90</div>
      </div>

      <!-- Short descriptions -->
      <div class="modal-section-hd">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</div>
      <div class="form-field full">
        <label>–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (—É–∑–±–µ–∫—Å–∫–∏–π) <span style="color:#4f5a7a;font-weight:400">–º–∞–∫—Å. 390 —Å–∏–º–≤–æ–ª–æ–≤</span></label>
        <textarea id="am-desc-uz" class="form-textarea" maxlength="390" placeholder="Mahsulot haqida qisqacha..."
          oninput="updateCharCount(this,'am-cnt-descuz',390)"></textarea>
        <div class="char-counter"><span id="am-cnt-descuz">0</span>/390</div>
      </div>
      <div class="form-field full">
        <label>–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ (—Ä—É—Å—Å–∫–∏–π) <span style="color:#4f5a7a;font-weight:400">–º–∞–∫—Å. 390 —Å–∏–º–≤–æ–ª–æ–≤</span></label>
        <textarea id="am-desc-ru" class="form-textarea" maxlength="390" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞..."
          oninput="updateCharCount(this,'am-cnt-descru',390)"></textarea>
        <div class="char-counter"><span id="am-cnt-descru">0</span>/390</div>
      </div>

      <!-- Full description -->
      <div class="modal-section-hd">–ü–æ–ª–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ</div>
      <div class="form-field full">
        <textarea id="am-full-desc" class="form-textarea" style="min-height:100px" placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞..."></textarea>
      </div>

      <!-- Characteristics -->
      <div class="modal-section-hd">–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ <span style="color:#2d3455;font-size:0.7rem;font-weight:400;text-transform:none;letter-spacing:0">(–º–∞–∫—Å. 5)</span></div>
      <div id="am-char-rows"></div>
      <button onclick="addCharRow()" style="background:none;border:1px dashed #2d3455;border-radius:8px;color:#4f5a7a;font-size:0.78rem;padding:7px 14px;cursor:pointer;width:100%;margin-top:6px;transition:all 0.18s"
        onmouseover="this.style.borderColor='#818cf8';this.style.color='#818cf8'"
        onmouseout="this.style.borderColor='#2d3455';this.style.color='#4f5a7a'">+ –î–æ–±–∞–≤–∏—Ç—å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫—É</button>

    </div><!-- /am-tab-desc -->

    <div class="add-modal-foot">
      <button class="btn-modal-cancel" onclick="closeAddModal()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn-modal-submit" onclick="submitAddModal()">+ –î–æ–±–∞–≤–∏—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê IMPORT MODAL ‚ïê‚ïê‚ïê -->
<div class="import-modal-overlay" id="importModalOverlay">
  <div class="import-modal">
    <div class="import-modal-head">
      <h3>üìÑ –ò–º–ø–æ—Ä—Ç –∏–∑ —Å—á—ë—Ç–∞</h3>
      <button class="add-modal-close" onclick="closeImportModal()">√ó</button>
    </div>
    <div class="import-modal-body">

      <!-- Photo upload -->
      <div>
        <div class="import-drop-zone" id="importDropZone"
          onclick="document.getElementById('importFileInput').click()"
          ondragover="event.preventDefault()"
          ondrop="handleImportDrop(event)">
          <div class="photo-upload-text">üì∏ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ —Å—á—ë—Ç–∞</div>
          <div class="photo-upload-hint">JPG, PNG, WEBP ‚Äî –ø–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ</div>
        </div>
        <input type="file" id="importFileInput" accept="image/*" style="display:none" onchange="handleImportFile(event)" />
        <div id="importPreviewWrap" style="display:none;position:relative;margin-top:12px">
          <img id="importPreview" src="" alt=""
            style="width:100%;border-radius:10px;max-height:220px;object-fit:contain;border:1px solid #1e2235;background:#0d0f1a" />
          <button onclick="removeImportPhoto()"
            style="position:absolute;top:6px;right:6px;background:rgba(0,0,0,0.72);border:none;color:#fff;border-radius:6px;padding:3px 9px;cursor:pointer;font-size:0.8rem">‚úï</button>
        </div>
      </div>


      <!-- Rate + Logistics -->
      <div class="form-row">
        <div class="form-field">
          <label>–ö—É—Ä—Å –¥–æ–ª–ª–∞—Ä–∞</label>
          <div class="input-row">
            <input type="number" id="import-rate" placeholder="12519" min="1" step="1" />
            <span class="badge">—Å—É–º/$</span>
          </div>
        </div>
        <div class="form-field">
          <label>–õ–æ–≥–∏—Å—Ç–∏–∫–∞ (–æ–±—â–∞—è)</label>
          <div class="input-row">
            <input type="number" id="import-logistics" placeholder="0" min="0" step="1" />
            <span class="badge">—Å—É–º</span>
          </div>
          <div style="font-size:0.67rem;color:#4f5a7a;margin-top:3px">–¥–µ–ª–∏—Ç—Å—è –ø–æ—Ä–æ–≤–Ω—É –º–µ–∂–¥—É —Ç–æ–≤–∞—Ä–∞–º–∏</div>
        </div>
      </div>

      <!-- Margin -->
      <div class="form-field">
        <label>–ú–∞—Ä–∂–∞</label>
        <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;margin-top:4px">
          <div class="margin-selector" id="import-margin-selector">
            <button class="margin-btn" onclick="setImportMargin(20,this)">20%</button>
            <button class="margin-btn" onclick="setImportMargin(25,this)">25%</button>
            <button class="margin-btn active" onclick="setImportMargin(30,this)">30%</button>
            <button class="margin-btn" onclick="setImportMargin(40,this)">40%</button>
            <button class="margin-btn" onclick="setImportMargin(50,this)">50%</button>
            <button class="margin-btn" onclick="setImportMargin(60,this)">60%</button>
          </div>
          <div style="display:flex;align-items:center;gap:4px">
            <input type="number" id="import-margin-input" min="1" max="99" step="1" placeholder="30"
              style="width:64px;padding:5px 8px;font-size:0.82rem"
              oninput="onImportMarginInput()" />
            <span class="badge" style="padding:5px 8px">%</span>
          </div>
        </div>
      </div>

      <!-- Category / Country / Supplier -->
      <div class="form-row" style="margin-top:4px">
        <div class="form-field full">
          <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
          <select id="import-category" class="am-select">
            <option value="">‚Äî –ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Äî</option>
          </select>
        </div>
        <div class="form-field full">
          <label>–°—Ç—Ä–∞–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞</label>
          <select id="import-country" class="am-select">
            <option value="">‚Äî –ù–µ —É–∫–∞–∑–∞–Ω–∞ ‚Äî</option>
          </select>
        </div>
        <div class="form-field full">
          <label>–ü–æ—Å—Ç–∞–≤—â–∏–∫</label>
          <select id="import-supplier" class="am-select">
            <option value="">‚Äî –ë–µ–∑ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ ‚Äî</option>
          </select>
        </div>
      </div>

      <!-- Status message -->
      <div id="importStatus" class="import-status" style="display:none"></div>

      <!-- Detected products preview -->
      <div id="importProductsWrap" style="display:none">
        <div style="font-size:0.78rem;color:#64748b;margin-bottom:8px">
          –ù–∞–π–¥–µ–Ω–æ –ø–æ–∑–∏—Ü–∏–π: <strong id="importProductCount">0</strong>
        </div>
        <div id="importProductsList" class="import-product-list"></div>
      </div>

    </div>
    <div class="import-modal-foot">
      <button class="btn-modal-cancel" onclick="closeImportModal()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn-modal-submit" id="importRunBtn" onclick="runImport()">üîç –†–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å—á—ë—Ç</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê SELECTION BAR ‚ïê‚ïê‚ïê -->
<div class="selection-bar" id="selectionBar">
  <span class="sel-count"><strong id="selCount">0</strong> –≤—ã–±—Ä–∞–Ω–æ</span>
  <button class="btn-sel-delete" onclick="deleteSelected()">üóë –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
  <button class="btn-sel-cancel"  onclick="clearSelection()">–û—Ç–º–µ–Ω–∏—Ç—å</button>
</div>

<!-- ‚ïê‚ïê‚ïê LIGHTBOX ‚ïê‚ïê‚ïê -->
<div class="lightbox" id="lightbox" onclick="closeLightbox()">
  <button class="lightbox-close" onclick="closeLightbox()">√ó</button>
  <img id="lightboxImg" src="" alt="" onclick="event.stopPropagation()" />
</div>

<!-- ‚ïê‚ïê‚ïê SNAPSHOTS COMPARE MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="snapshotsModal" onclick="if(event.target===this)closeSnapshotsModal()">
  <div class="settings-modal" style="width:640px;max-width:96vw">
    <div class="settings-head">
      <div class="settings-head-title">üîÑ –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø–∞—Ä—Ç–∏–π</div>
      <button onclick="closeSnapshotsModal()" style="background:none;border:none;color:#4f5a7a;font-size:1.3rem;cursor:pointer;line-height:1;padding:2px 8px;border-radius:6px">√ó</button>
    </div>
    <div style="padding:16px 20px;border-bottom:1px solid #1e2235;display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <select id="snapSelA" class="am-select" style="flex:1;min-width:160px">
        <option value="">‚Äî –°–Ω–∏–º–æ–∫ A ‚Äî</option>
      </select>
      <span style="color:#4f5a7a;font-size:1.1rem">‚Üî</span>
      <select id="snapSelB" class="am-select" style="flex:1;min-width:160px">
        <option value="">‚Äî –°–Ω–∏–º–æ–∫ B (–∏–ª–∏ —Ç–µ–∫—É—â–∏–π) ‚Äî</option>
      </select>
      <button class="btn-modal-submit" onclick="runSnapshotCompare()" style="flex:none;padding:9px 16px;font-size:0.84rem">–°—Ä–∞–≤–Ω–∏—Ç—å</button>
    </div>
    <div id="snapCompareResult" class="settings-body" style="padding:16px 20px;font-size:0.84rem">
      <div style="color:#4f5a7a;text-align:center;padding:20px">–í—ã–±–µ—Ä–∏—Ç–µ –¥–≤–∞ —Å–Ω–∏–º–∫–∞ –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è</div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê UNIFIED SETTINGS MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="settingsModal" onclick="if(event.target===this)closeSettings()">
  <div class="settings-modal">
    <div class="settings-head">
      <div class="settings-head-title">‚öô –ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
      <button onclick="closeSettings()" style="background:none;border:none;color:#4f5a7a;font-size:1.3rem;cursor:pointer;line-height:1;padding:2px 8px;border-radius:6px">√ó</button>
    </div>
    <div class="settings-tabs">
      <button class="settings-tab active" id="stab-cats"      onclick="switchSettingsTab('cats')">üóÇ –ö–∞—Ç–µ–≥–æ—Ä–∏–∏</button>
      <button class="settings-tab"        id="stab-countries" onclick="switchSettingsTab('countries')">üåç –°—Ç—Ä–∞–Ω—ã</button>
      <button class="settings-tab"        id="stab-sizes"     onclick="switchSettingsTab('sizes')">üìê –†–∞–∑–º–µ—Ä—ã</button>
      <button class="settings-tab"        id="stab-suppliers" onclick="switchSettingsTab('suppliers')">üè≠ –ü–æ—Å—Ç–∞–≤—â–∏–∫–∏</button>
      <button class="settings-tab"        id="stab-tg"        onclick="switchSettingsTab('tg')">üîî Telegram</button>
      <button class="settings-tab"        id="stab-alerts"    onclick="switchSettingsTab('alerts')">‚ö° –ê–ª–µ—Ä—Ç—ã</button>
    </div>

    <!-- Categories tab -->
    <div id="spanel-cats" class="settings-body">
      <ul class="settings-list" id="set-cat-list"></ul>
      <div class="settings-add-row">
        <input type="text" id="set-cat-input" placeholder="–ù–æ–≤–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è..." style="flex:1"
          onkeydown="if(event.key==='Enter')settingsAddCat()" />
        <button class="btn-modal-submit" onclick="settingsAddCat()"
          style="flex:none;padding:9px 16px;white-space:nowrap;font-size:0.84rem">+ –î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </div>

    <!-- Countries tab -->
    <div id="spanel-countries" class="settings-body" style="display:none">
      <ul class="settings-list" id="set-country-list"></ul>
      <div class="settings-add-row">
        <input type="text" id="set-country-input" placeholder="–ù–æ–≤–∞—è —Å—Ç—Ä–∞–Ω–∞..." style="flex:1"
          onkeydown="if(event.key==='Enter')settingsAddCountry()" />
        <button class="btn-modal-submit" onclick="settingsAddCountry()"
          style="flex:none;padding:9px 16px;white-space:nowrap;font-size:0.84rem">+ –î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </div>

    <!-- Sizes tab -->
    <div id="spanel-sizes" class="settings-body" style="display:none">
      <ul class="settings-list" id="set-size-list"></ul>
      <div class="settings-add-row">
        <input type="text" id="set-size-input" placeholder="–ù–æ–≤—ã–π —Ä–∞–∑–º–µ—Ä (–Ω–∞–ø—Ä. 11-12)..." style="flex:1"
          onkeydown="if(event.key==='Enter')settingsAddSize()" />
        <button class="btn-modal-submit" onclick="settingsAddSize()"
          style="flex:none;padding:9px 16px;white-space:nowrap;font-size:0.84rem">+ –î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </div>

    <!-- Suppliers tab -->
    <div id="spanel-suppliers" class="settings-body" style="display:none">
      <ul class="settings-list" id="set-supplier-list"></ul>
      <div class="settings-add-row" style="flex-direction:column;gap:12px">

        <!-- Name -->
        <input type="text" id="set-sup-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ / –∏–º—è –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞" style="width:100%" />

        <!-- Phone / username -->
        <input type="text" id="set-sup-contact" placeholder="–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –∏–ª–∏ @username" style="width:100%" />

        <!-- Messenger multi-select chips -->
        <div>
          <div style="font-size:0.72rem;color:#4f5a7a;margin-bottom:8px;font-weight:600;text-transform:uppercase;letter-spacing:.05em">–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä—ã (–º–æ–∂–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ)</div>
          <div class="messenger-chips" id="sup-messengers">
            <button type="button" class="messenger-chip" data-val="Telegram"   onclick="toggleMessengerChip(this)">‚úà Telegram</button>
            <button type="button" class="messenger-chip" data-val="WhatsApp"   onclick="toggleMessengerChip(this)">üí¨ WhatsApp</button>
            <button type="button" class="messenger-chip" data-val="IMO"        onclick="toggleMessengerChip(this)">üì± IMO</button>
            <button type="button" class="messenger-chip" data-val="WeChat"     onclick="toggleMessengerChip(this)">üü¢ WeChat</button>
            <button type="button" class="messenger-chip" data-val="Instagram"  onclick="toggleMessengerChip(this)">üì∏ Instagram</button>
          </div>
        </div>

        <!-- Country select -->
        <select id="set-sup-country" class="am-select">
          <option value="">‚Äî –°—Ç—Ä–∞–Ω–∞ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ ‚Äî</option>
        </select>

        <button class="btn-modal-submit" onclick="settingsAddSupplier()"
          style="align-self:flex-end;padding:9px 20px;font-size:0.84rem">+ –î–æ–±–∞–≤–∏—Ç—å</button>
      </div>
    </div>

    <!-- Telegram tab -->
    <div id="spanel-tg" class="settings-body" style="display:none;padding:20px;display:none">
      <div style="display:flex;flex-direction:column;gap:14px">
        <div class="form-field full">
          <label>Bot Token (–æ—Ç @BotFather)</label>
          <input type="text" id="tgToken" placeholder="123456:AABBcc..." oninput="saveTgSettings()" />
        </div>
        <div class="form-field full">
          <label>Chat ID</label>
          <input type="text" id="tgChat" placeholder="-100123456789" oninput="saveTgSettings()" />
        </div>
        <button class="btn-modal-submit" onclick="testTgNotify()" style="align-self:flex-start;padding:9px 20px">üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç</button>
        <div style="font-size:0.73rem;color:#4f5a7a;line-height:1.5">
          –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏—Ö–æ–¥—è—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –Ω—É–ª–µ–≤–æ–º –æ—Å—Ç–∞—Ç–∫–µ –Ω–∞ —Å–∫–ª–∞–¥–µ.
        </div>
      </div>
    </div>

    <!-- Alerts tab -->
    <div id="spanel-alerts" class="settings-body" style="display:none;padding:20px">
      <div style="display:flex;flex-direction:column;gap:18px">
        <div>
          <div style="font-size:0.75rem;font-weight:600;color:#64748b;margin-bottom:8px">–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –º–∞—Ä–∂–∞ (–∞–ª–µ—Ä—Ç)</div>
          <div style="display:flex;align-items:center;gap:8px">
            <input type="number" id="set-margin-alert" min="0" max="99" step="1" placeholder="0 = –≤—ã–∫–ª—é—á–µ–Ω–æ"
              style="width:130px" oninput="setMarginAlert(this.value)" />
            <span class="badge">%</span>
          </div>
          <div style="font-size:0.72rem;color:#4f5a7a;margin-top:6px;line-height:1.6">
            –°—Ç—Ä–æ–∫–∏ —Å –º–∞—Ä–∂–æ–π <strong>–Ω–∏–∂–µ</strong> —ç—Ç–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è –≤—ã–¥–µ–ª—è—é—Ç—Å—è –∂—ë–ª—Ç—ã–º.<br>
            –£—Å—Ç–∞–Ω–æ–≤–∏ 0 —á—Ç–æ–±—ã –æ—Ç–∫–ª—é—á–∏—Ç—å –∞–ª–µ—Ä—Ç.
          </div>
        </div>
        <div style="height:1px;background:#1e2235"></div>
        <div>
          <div style="font-size:0.75rem;font-weight:600;color:#64748b;margin-bottom:8px">–¢—Ä–µ–∫–µ—Ä –ø—Ä–æ–¥–∞–∂</div>
          <div style="font-size:0.72rem;color:#4f5a7a;line-height:1.6">
            –í —Ç–∞–±–ª–∏—Ü–µ —Ç–æ–≤–∞—Ä–æ–≤ –µ—Å—Ç—å –∫–æ–ª–æ–Ω–∫–∞ <strong>–ü—Ä–æ–¥–∞–Ω–æ</strong>.<br>
            –í–≤–µ–¥–∏ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ ‚Äî KPI ¬´–ü—Ä–æ–¥–∞–Ω–æ (—Ñ–∞–∫—Ç)¬ª –∏ ¬´–ü—Ä–∏–±—ã–ª—å (—Ñ–∞–∫—Ç)¬ª –æ–±–Ω–æ–≤—è—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê XLSX IMPORT MODAL ‚ïê‚ïê‚ïê -->
<div class="add-modal-overlay" id="xlsxImportModal" onclick="if(event.target===this)closeXlsxImportModal()">
  <div class="add-modal" style="max-width:420px">
    <div class="add-modal-head">
      <h3>üì• –ò–º–ø–æ—Ä—Ç –∏–∑ Excel/CSV</h3>
      <button class="add-modal-close" onclick="closeXlsxImportModal()">√ó</button>
    </div>
    <div class="add-modal-body" style="padding:20px">
      <div id="xlsxImportCount" style="font-size:0.85rem;color:#94a3b8;margin-bottom:18px"></div>
      <div class="form-row">
        <div class="form-field full">
          <label>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
          <select id="xlsxImportCat" class="am-select">
            <option value="">‚Äî –ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Äî</option>
          </select>
        </div>
        <div class="form-field full">
          <label>–°—Ç—Ä–∞–Ω–∞ –ø—Ä–æ–∏–∑–≤–æ–¥—Å—Ç–≤–∞</label>
          <select id="xlsxImportCountry" class="am-select">
            <option value="">‚Äî –ù–µ —É–∫–∞–∑–∞–Ω–∞ ‚Äî</option>
          </select>
        </div>
        <div class="form-field full">
          <label>–ü–æ—Å—Ç–∞–≤—â–∏–∫</label>
          <select id="xlsxImportSupplier" class="am-select">
            <option value="">‚Äî –ë–µ–∑ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ ‚Äî</option>
          </select>
        </div>
      </div>
    </div>
    <div class="add-modal-footer" style="display:flex;gap:10px;justify-content:flex-end;padding:14px 20px;border-top:1px solid #1e2235">
      <button class="btn-modal-cancel" onclick="closeXlsxImportModal()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn-modal-submit" onclick="doXlsxImport()">‚úì –ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê ADD SALE MODAL ‚ïê‚ïê‚ïê -->
<div class="add-modal-overlay" id="saleModal" onclick="if(event.target===this)closeSaleModal()">
  <div class="add-modal" style="max-width:520px">
    <div class="add-modal-head">
      <h3>üí∞ –ù–æ–≤–∞—è –ø—Ä–æ–¥–∞–∂–∞</h3>
      <button class="add-modal-close" onclick="closeSaleModal()">√ó</button>
    </div>
    <div class="add-modal-body" style="padding:20px">
      <div style="display:flex;gap:8px;margin-bottom:20px">
        <button id="slStatusDelivered" class="btn-wh btn-wh-primary" onclick="setSaleStatus('delivered')" style="flex:1;justify-content:center">‚úÖ –î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</button>
        <button id="slStatusReturned"  class="btn-wh btn-wh-ghost"   onclick="setSaleStatus('returned')"  style="flex:1;justify-content:center">‚ùå –í–æ–∑–≤—Ä–∞—Ç</button>
      </div>
      <div class="form-row">
        <div class="form-field"><label>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è *</label><input type="datetime-local" id="slCreatedAt" /></div>
        <div class="form-field"><label>–î–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∏—è</label><input type="datetime-local" id="slReceivedAt" /></div>
        <div class="form-field"><label>‚Ññ –∑–∞–∫–∞–∑–∞</label><input type="text" id="slOrderNum" placeholder="84748360" /></div>
        <div class="form-field">
          <label>SKU / –ê—Ä—Ç–∏–∫—É–ª</label>
          <input type="text" id="slSku" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑ —Å–∫–ª–∞–¥–∞..." oninput="slAutoFillName()" list="slSkuList" />
          <datalist id="slSkuList"></datalist>
          <div id="slStockHint" style="font-size:0.72rem;margin-top:3px;min-height:16px"></div>
        </div>
        <div class="form-field full"><label>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ *</label><input type="text" id="slName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" /></div>
        <div class="form-field"><label>–ö–æ–ª-–≤–æ</label><input type="number" id="slQty" placeholder="1" min="1" value="1" oninput="slCheckStock()" /></div>
        <div class="form-field"><label>–¶–µ–Ω–∞, —Å—É–º</label><input type="number" id="slPrice" placeholder="420 000" min="0" /></div>
        <div class="form-field"><label>–ö –≤—ã–≤–æ–¥—É, —Å—É–º</label><input type="number" id="slPayout" placeholder="380 000" min="0" /></div>
      </div>
    </div>
    <div class="add-modal-footer" style="display:flex;gap:10px;justify-content:flex-end;padding:14px 20px;border-top:1px solid #1e2235">
      <button class="btn-modal-cancel" onclick="closeSaleModal()">–û—Ç–º–µ–Ω–∞</button>
      <button class="btn-modal-submit" onclick="submitSaleModal()">‚úì –î–æ–±–∞–≤–∏—Ç—å</button>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê CONFIRM MODAL ‚ïê‚ïê‚ïê -->
<!-- Price History Modal -->
<div class="modal-overlay" id="priceHistModal" onclick="if(event.target===this)closePriceHist()">
  <div class="modal-box" style="max-width:460px;padding:0">
    <div style="display:flex;align-items:center;justify-content:space-between;padding:18px 20px;border-bottom:1px solid #1e2235">
      <div style="font-weight:700;font-size:1rem">üïê –ò—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω</div>
      <button class="modal-close" onclick="closePriceHist()" style="background:transparent;border:none;font-size:1.3rem;cursor:pointer;color:#4f5a7a;line-height:1">√ó</button>
    </div>
    <div id="priceHistTitle" style="padding:10px 20px 0;font-size:0.8rem;color:#4f5a7a"></div>
    <div id="priceHistContent" style="padding:12px 20px 20px;max-height:380px;overflow-y:auto">
      <div style="color:#4f5a7a;font-size:0.84rem">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
    </div>
  </div>
</div>

<div class="modal-overlay" id="confirmModal">
  <div class="modal-box">
    <div class="modal-icon">üóë</div>
    <div class="modal-title">–£–¥–∞–ª–∏—Ç—å —Ç–æ–≤–∞—Ä?</div>
    <div class="modal-sub" id="confirmModalSub">–¢–æ–≤–∞—Ä –±—É–¥–µ—Ç –ø–µ—Ä–µ–º–µ—â—ë–Ω –≤ –∞—Ä—Ö–∏–≤ ‚Äî –≤—ã —Å–º–æ–∂–µ—Ç–µ –µ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å.</div>
    <div class="modal-btns">
      <button class="modal-cancel" id="confirmNo">–û—Ç–º–µ–Ω–∞</button>
      <button class="modal-confirm" id="confirmYes">–£–¥–∞–ª–∏—Ç—å</button>
    </div>
  </div>
</div>




<!-- ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê -->
<div class="header">
  <div class="logo">üì¶</div>
  <h1>–ü—Ä–∞–π—Å–µ—Ä —Ç–æ–≤–∞—Ä–æ–≤</h1>
  <nav class="header-nav">
    <button class="htab active" onclick="showTab('dashboard',this)">üè† –ì–ª–∞–≤–Ω–∞—è</button>
    <button class="htab" onclick="showTab('products',this)">üìã –¢–æ–≤–∞—Ä—ã</button>
    <button class="htab" onclick="showTab('analytics',this)">üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
    <button class="htab" onclick="showTab('warehouse',this)">üì¶ –°–∫–ª–∞–¥</button>
    <button class="htab" onclick="showTab('sales',this)">üí∞ –ü—Ä–æ–¥–∞–∂–∏</button>
  </nav>
  <div id="syncBadge" class="sync-badge">
    <div class="sync-dot"></div>
    <span id="syncText">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...</span>
  </div>
  <div style="display:flex;align-items:center;gap:4px;margin-left:8px;position:relative">
    <!-- Files dropdown -->
    <div style="position:relative" id="filesMenuWrap">
      <button class="hdr-btn" onclick="toggleFilesMenu()" id="filesMenuBtn">–§–∞–π–ª—ã ‚ñæ</button>
      <div id="filesMenu" style="display:none;position:absolute;top:calc(100% + 6px);right:0;background:#0d0f1a;border:1px solid #1e2235;border-radius:10px;padding:6px;min-width:170px;z-index:200;box-shadow:0 8px 32px rgba(0,0,0,0.5)">
        <button onclick="printPriceList();closeFilesMenu()" class="files-menu-item">üñ® –ü–µ—á–∞—Ç—å –ø—Ä–∞–π—Å–∞</button>
        <button onclick="openPublicLink();closeFilesMenu()" class="files-menu-item">üîó –ü—É–±–ª–∏—á–Ω—ã–π –ø—Ä–∞–π—Å</button>
        <button onclick="exportXLSX();closeFilesMenu()" class="files-menu-item">üìä –°–∫–∞—á–∞—Ç—å Excel</button>
        <button onclick="document.getElementById('importXlsxInput').click();closeFilesMenu()" class="files-menu-item">üì• –ò–º–ø–æ—Ä—Ç –∏–∑ Excel/CSV</button>
        <button onclick="exportPDF();closeFilesMenu()" class="files-menu-item">üìÑ –°–∫–∞—á–∞—Ç—å PDF</button>
        <div style="height:1px;background:#1e2235;margin:4px 0"></div>
        <button onclick="saveBatchSnapshot();closeFilesMenu()" class="files-menu-item">üì∏ –°–Ω–∏–º–æ–∫ –ø–∞—Ä—Ç–∏–∏</button>
        <button onclick="openSnapshotsModal();closeFilesMenu()" class="files-menu-item">üîÑ –°—Ä–∞–≤–Ω–∏—Ç—å –ø–∞—Ä—Ç–∏–∏</button>
        <div style="height:1px;background:#1e2235;margin:4px 0"></div>
        <button onclick="exportBackup();closeFilesMenu()" class="files-menu-item">‚¨á –ë—ç–∫–∞–ø</button>
        <button onclick="document.getElementById('backupRestoreInput').click();closeFilesMenu()" class="files-menu-item">‚¨Ü –ò–º–ø–æ—Ä—Ç</button>
      </div>
    </div>
    <button class="hdr-btn" onclick="openSettings('cats')" title="–ù–∞—Å—Ç—Ä–æ–π–∫–∏">‚öô</button>
    <button class="hdr-btn" id="pinBtn" onclick="managePinCode()" title="PIN">üîê</button>
  </div>
  <button class="theme-btn" id="themeBtn" onclick="toggleTheme()" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É"></button>
  <div class="header-right" style="display:flex;align-items:center;gap:8px">
    <span id="headerUserEmail" style="font-size:0.7rem;color:#4f5a7a;max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap"></span>
    <button class="hdr-btn" onclick="authLogout()" title="–í—ã–π—Ç–∏" style="color:#ef4444;font-size:0.85rem">‚èè –í—ã–π—Ç–∏</button>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê KPI STRIP ‚ïê‚ïê‚ïê -->
<div class="kpi-strip">
  <div class="kpi-card">
    <i class="kpi-tip-icon">?</i>
    <div class="kpi-tip-popup">–°—É–º–º–∞—Ä–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —à—Ç—É–∫ –ø–æ –≤—Å–µ–º —Ç–æ–≤–∞—Ä–∞–º –ø–∞—Ä—Ç–∏–∏. –ù–∏–∂–µ ‚Äî –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö SKU.</div>
    <div class="kpi-label">–í—Å–µ–≥–æ –µ–¥–∏–Ω–∏—Ü</div>
    <div class="kpi-value kpi-cyan" id="kpiUnits">‚Äî</div>
    <div class="kpi-sub" id="kpiSku">‚Äî SKU</div>
  </div>
  <div class="kpi-card">
    <i class="kpi-tip-icon">?</i>
    <div class="kpi-tip-popup">–ü–æ–ª–Ω–∞—è —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å –ø–∞—Ä—Ç–∏–∏: –∑–∞–∫—É–ø–∫–∞ + –ª–æ–≥–∏—Å—Ç–∏–∫–∞ + –º–∞—Ä–∫–µ—Ç–∏–Ω–≥ + –∫–æ–º–∏—Å—Å–∏—è. –ù–∏–∂–µ ‚Äî —Å—Ä–µ–¥–Ω—è—è –Ω–∞ –æ–¥–Ω—É –µ–¥–∏–Ω–∏—Ü—É.</div>
    <div class="kpi-label">–û–±—â–∞—è —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å</div>
    <div class="kpi-value kpi-yellow" id="kpiCogs">‚Äî</div>
    <div class="kpi-sub" id="kpiCogsUnit">‚Äî / —é–Ω–∏—Ç</div>
  </div>
  <div class="kpi-card">
    <i class="kpi-tip-icon">?</i>
    <div class="kpi-tip-popup">–ü–ª–∞–Ω–æ–≤–∞—è –≤—ã—Ä—É—á–∫–∞ –ø—Ä–∏ –ø—Ä–æ–¥–∞–∂–µ –≤—Å–µ–π –ø–∞—Ä—Ç–∏–∏ –ø–æ —Ä–∞—Å—á—ë—Ç–Ω—ã–º —Ü–µ–Ω–∞–º –ø—Ä–æ–¥–∞–∂–∏. –ù–∏–∂–µ ‚Äî —Å—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏ –Ω–∞ –µ–¥–∏–Ω–∏—Ü—É.</div>
    <div class="kpi-label">–í—ã—Ä—É—á–∫–∞ (–ø–ª–∞–Ω)</div>
    <div class="kpi-value kpi-purple" id="kpiRevenue">‚Äî</div>
    <div class="kpi-sub" id="kpiRevUnit">‚Äî / —é–Ω–∏—Ç</div>
  </div>
  <div class="kpi-card">
    <i class="kpi-tip-icon">?</i>
    <div class="kpi-tip-popup">–ü–ª–∞–Ω–æ–≤–∞—è —á–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å = –í—ã—Ä—É—á–∫–∞ ‚àí –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å. –ù–∏–∂–µ ‚Äî —Å—Ä–µ–¥–Ω—è—è –ø—Ä–∏–±—ã–ª—å –Ω–∞ –æ–¥–Ω—É –µ–¥–∏–Ω–∏—Ü—É.</div>
    <div class="kpi-label">–ü—Ä–∏–±—ã–ª—å (–ø–ª–∞–Ω)</div>
    <div class="kpi-value kpi-green" id="kpiProfit">‚Äî</div>
    <div class="kpi-sub" id="kpiProfUnit">‚Äî / —é–Ω–∏—Ç</div>
  </div>
  <div class="kpi-card">
    <i class="kpi-tip-icon">?</i>
    <div class="kpi-tip-popup">ROI (Return on Investment) = –ü—Ä–∏–±—ã–ª—å √∑ –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å √ó 100%. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —Å–∫–æ–ª—å–∫–æ –ø—Ä–∏–±—ã–ª–∏ –ø—Ä–∏–Ω–æ—Å–∏—Ç –∫–∞–∂–¥—ã–π –≤–ª–æ–∂–µ–Ω–Ω—ã–π —Å—É–º.</div>
    <div class="kpi-label">ROI</div>
    <div class="kpi-value kpi-pink" id="kpiRoi">‚Äî</div>
    <div class="kpi-sub">–ø—Ä–∏–±—ã–ª—å / –≤–ª–æ–∂–µ–Ω–∏—è</div>
  </div>
  <div class="kpi-card">
    <i class="kpi-tip-icon">?</i>
    <div class="kpi-tip-popup">–°—Ä–µ–¥–Ω—è—è –º–∞—Ä–∂–∞ = –ü—Ä–∏–±—ã–ª—å √∑ –í—ã—Ä—É—á–∫–∞ √ó 100%. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫—É—é –¥–æ–ª—é –æ—Ç –ø—Ä–æ–¥–∞–∂–Ω–æ–π —Ü–µ–Ω—ã —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç —á–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å.</div>
    <div class="kpi-label">–°—Ä–µ–¥–Ω—è—è –º–∞—Ä–∂–∞</div>
    <div class="kpi-value kpi-indigo" id="kpiMargin">‚Äî</div>
    <div class="kpi-sub">% –æ—Ç –≤—ã—Ä—É—á–∫–∏</div>
  </div>
  <div class="kpi-card">
    <i class="kpi-tip-icon">?</i>
    <div class="kpi-tip-popup">–§–∞–∫—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ (–≤–≤–µ–¥–∏—Ç–µ –≤ –∫–æ–ª–æ–Ω–∫–µ ¬´–ü—Ä–æ–¥–∞–Ω–æ¬ª). –ù–∏–∂–µ ‚Äî —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –≤—ã—Ä—É—á–∫–∞.</div>
    <div class="kpi-label">–ü—Ä–æ–¥–∞–Ω–æ (—Ñ–∞–∫—Ç)</div>
    <div class="kpi-value" style="color:#06b6d4" id="kpiSold">‚Äî</div>
    <div class="kpi-sub" id="kpiSoldRevenue">‚Äî –≤—ã—Ä—É—á–∫–∞</div>
  </div>
  <div class="kpi-card">
    <i class="kpi-tip-icon">?</i>
    <div class="kpi-tip-popup">–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–∏–±—ã–ª—å = –ø—Ä–∏–±—ã–ª—å/—é–Ω–∏—Ç √ó —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–∞–Ω–Ω–æ–µ –∫–æ–ª-–≤–æ. –ù–∏–∂–µ ‚Äî % –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø–ª–∞–Ω–∞.</div>
    <div class="kpi-label">–ü—Ä–∏–±—ã–ª—å (—Ñ–∞–∫—Ç)</div>
    <div class="kpi-value kpi-green" id="kpiSoldProfit">‚Äî</div>
    <div class="kpi-sub" id="kpiSoldPct">‚Äî –æ—Ç –ø–ª–∞–Ω–∞</div>
  </div>
</div>


<!-- ‚ïê‚ïê‚ïê TAB: –ì–õ–ê–í–ù–ê–Ø (DASHBOARD) ‚ïê‚ïê‚ïê -->
<div id="tab-dashboard" class="page tab-content active">
  <div style="display:flex;align-items:center;gap:10px;padding:0 0 14px">
    <span style="font-size:0.78rem;color:#4f5a7a">–ö–∞—Ç–µ–≥–æ—Ä–∏—è:</span>
    <select id="dashCatFilter" onchange="renderDashboard()"
      style="background:#111422;border:1px solid #1e2235;border-radius:8px;color:#94a3b8;font-size:0.8rem;padding:5px 10px;cursor:pointer">
      <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
    </select>
  </div>
  <div class="dash-kpi-row" id="dashKpiRow">
    <div class="dash-kpi">
      <div class="dash-kpi-icon">üìã</div>
      <div class="dash-kpi-label">–¢–æ–≤–∞—Ä–æ–≤ –≤ –ø–∞—Ä—Ç–∏–∏</div>
      <div class="dash-kpi-val kpi-cyan" id="dashProdCount">‚Äî</div>
      <div class="dash-kpi-sub" id="dashProdUnits">‚Äî –µ–¥.</div>
    </div>
    <div class="dash-kpi">
      <div class="dash-kpi-icon">üí∞</div>
      <div class="dash-kpi-label">–ü—Ä–æ–¥–∞–∂–∏ (—Ñ–∞–∫—Ç)</div>
      <div class="dash-kpi-val kpi-green" id="dashSalesCount">‚Äî</div>
      <div class="dash-kpi-sub" id="dashSalesRevenue">‚Äî –≤—ã—Ä—É—á–∫–∞</div>
    </div>
    <div class="dash-kpi">
      <div class="dash-kpi-icon">üì¶</div>
      <div class="dash-kpi-label">–ü–æ–∑–∏—Ü–∏–π –Ω–∞ —Å–∫–ª–∞–¥–µ</div>
      <div class="dash-kpi-val kpi-purple" id="dashStockSkus">‚Äî</div>
      <div class="dash-kpi-sub" id="dashStockUnits">‚Äî —à—Ç. –Ω–∞ —Ä—É–∫–∞—Ö</div>
    </div>
    <div class="dash-kpi">
      <div class="dash-kpi-icon">üè∑</div>
      <div class="dash-kpi-label">–°—Ç–æ–∏–º–æ—Å—Ç—å —Å–∫–ª–∞–¥–∞</div>
      <div class="dash-kpi-val kpi-yellow" id="dashStockVal">‚Äî</div>
      <div class="dash-kpi-sub" id="dashLowStock" style="color:#ef4444"></div>
    </div>
  </div>

  <!-- –ö—É—Ä—Å –≤–∞–ª—é—Ç –¶–ë –†–£–∑ -->
  <div id="dashRateBar" style="display:flex;align-items:center;gap:14px;padding:10px 16px;margin-bottom:18px;background:#111422;border:1px solid #1e2235;border-radius:12px;flex-wrap:wrap">
    <span style="font-size:0.67rem;color:#4f5a7a;text-transform:uppercase;letter-spacing:0.08em">–ö—É—Ä—Å –¶–ë –†–£–∑</span>
    <span style="font-size:0.95rem;font-weight:800;color:#f59e0b" id="dashRateUSD">–∑–∞–≥—Ä—É–∑–∫–∞...</span>
    <span style="font-size:0.88rem;font-weight:700;color:#818cf8" id="dashRateEUR"></span>
    <span style="font-size:0.88rem;font-weight:700;color:#06b6d4" id="dashRateRUB"></span>
    <span style="font-size:0.67rem;color:#4f5a7a;margin-left:auto" id="dashRateDate"></span>
  </div>

  <div class="dash-grid">
    <div class="dash-section">
      <div class="dash-section-title">‚ö†Ô∏è –ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</div>
      <div id="dashAlerts"><div style="color:#4f5a7a;font-size:0.82rem">–î–∞–Ω–Ω—ã–µ —Å–∫–ª–∞–¥–∞ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...</div></div>
    </div>
    <div class="dash-section">
      <div class="dash-section-title">üöõ –ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ—Å—Ç–∞–≤–∫–∏</div>
      <div id="dashSupplies"><div style="color:#4f5a7a;font-size:0.82rem">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div></div>
    </div>
    <div class="dash-section">
      <div class="dash-section-title">üóë –ü–æ—Å–ª–µ–¥–Ω–∏–µ —Å–ø–∏—Å–∞–Ω–∏—è</div>
      <div id="dashWriteoffs"><div style="color:#4f5a7a;font-size:0.82rem">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div></div>
    </div>
    <div class="dash-section">
      <div class="dash-section-title">üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø–∞—Ä—Ç–∏–∏</div>
      <div id="dashBatchDetails"><div style="color:#4f5a7a;font-size:0.82rem">–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –≤–æ –≤–∫–ª–∞–¥–∫–µ –¢–æ–≤–∞—Ä—ã</div></div>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê TAB: –¢–û–í–ê–†–´ ‚ïê‚ïê‚ïê -->
<div id="tab-products" class="page tab-content">

  <!-- Global params (compact collapsible bar) -->
  <div class="card" style="padding:0;overflow:hidden">
    <button onclick="toggleParamsBar()" id="paramsBarToggle"
      style="width:100%;display:flex;align-items:center;justify-content:space-between;padding:10px 16px;background:none;border:none;cursor:pointer;text-align:left;gap:12px">
      <span class="card-title" style="margin:0;font-size:0.72rem">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–∞—Ä—Ç–∏–∏</span>
      <div id="paramsBarSummary" style="font-size:0.75rem;color:#4f5a7a;flex:1;text-align:left">–õ–æ–≥–∏—Å—Ç–∏–∫–∞: 0 —Å—É–º ¬∑ –ö–æ–º–∏—Å—Å–∏—è: 0% ¬∑ –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥: 0 —Å—É–º</div>
      <span id="paramsBarChevron" style="color:#4f5a7a;font-size:0.8rem;flex-shrink:0">‚ñæ</span>
    </button>
    <div id="paramsBarBody" style="display:none;padding:0 16px 14px">
      <div class="params-grid" style="margin-top:4px">
        <div class="param-field">
          <label>–û–±—â–∞—è –ª–æ–≥–∏—Å—Ç–∏–∫–∞ –ø–∞—Ä—Ç–∏–∏</label>
          <div class="input-row">
            <input type="number" id="totalLogistics" placeholder="0" oninput="recalc();updateParamsSummary()" />
            <span class="badge">—Å—É–º</span>
          </div>
        </div>
        <div class="param-field">
          <label>–ö–æ–º–∏—Å—Å–∏—è / —ç–∫–≤–∞–π—Ä–∏–Ω–≥</label>
          <div class="input-row">
            <input type="number" id="commission" placeholder="0" min="0" max="100" oninput="recalc();updateParamsSummary()" />
            <span class="badge">%</span>
          </div>
        </div>
        <div class="param-field">
          <label>–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥ –Ω–∞ —é–Ω–∏—Ç</label>
          <div class="input-row">
            <input type="number" id="marketing" placeholder="0" min="0" oninput="recalc();updateParamsSummary()" />
            <span class="badge">—Å—É–º</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Simulator card -->
  <div class="card" id="simCard" style="display:none;margin-bottom:12px;padding:14px 16px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div class="card-title" style="margin:0">üéØ –°–∏–º—É–ª—è—Ç–æ—Ä —Ü–µ–Ω</div>
      <button onclick="toggleSimCard()" style="background:none;border:none;color:#4f5a7a;font-size:1.1rem;cursor:pointer;line-height:1">√ó</button>
    </div>
    <div style="display:flex;gap:20px;flex-wrap:wrap;align-items:flex-start">
      <div>
        <div style="font-size:0.72rem;color:#64748b;margin-bottom:6px">–°–∫–∏–¥–∫–∞ %</div>
        <div style="display:flex;align-items:center;gap:10px">
          <input type="range" id="simDiscountRange" min="0" max="70" value="0"
            oninput="simDiscount=+this.value;document.getElementById('simDiscountVal').textContent=this.value+'%';updateSimulator();"
            style="width:110px;accent-color:#6366f1">
          <span id="simDiscountVal" style="font-weight:700;color:#f59e0b;min-width:34px">0%</span>
        </div>
      </div>
      <div>
        <div style="font-size:0.72rem;color:#64748b;margin-bottom:6px">–¶–µ–ª–µ–≤–∞—è –≤—ã—Ä—É—á–∫–∞ (—Å—É–º)</div>
        <input type="number" id="simTarget" placeholder="50 000 000" oninput="updateSimulator()"
          style="width:160px">
      </div>
      <div id="simResults" style="font-size:0.78rem;line-height:2;color:#94a3b8;align-self:center"></div>
    </div>
  </div>

  <!-- Products table -->
  <div class="products-card">
    <div class="products-header">
      <h2>–¢–æ–≤–∞—Ä—ã –ø–∞—Ä—Ç–∏–∏</h2>
      <div style="display:flex;gap:8px">
        <button class="btn-add" onclick="toggleSimCard()" style="background:rgba(99,102,241,0.08);border-color:rgba(99,102,241,0.3);color:#818cf8" title="–°–∏–º—É–ª—è—Ç–æ—Ä —Ü–µ–Ω">üéØ –°–∏–º—É–ª—è—Ç–æ—Ä</button>
        <button class="btn-add" onclick="openImportModal()" style="background:rgba(6,182,212,0.1);border-color:rgba(6,182,212,0.3);color:#06b6d4">üìÑ –ò–º–ø–æ—Ä—Ç –∏–∑ —Å—á—ë—Ç–∞</button>
        <button class="btn-add" onclick="openAddModal()">+ –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä</button>
      </div>
    </div>
    <div class="prod-filter-bar">
      <input type="text" class="prod-search" id="prodSearch"
        placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –∫–æ–¥—É..." oninput="prodPage=0;applyProdFilter()">
      <div class="prod-tags">
        <button class="prod-tag active" onclick="setProdFilter('all',this)">–í—Å–µ</button>
        <button class="prod-tag" onclick="setProdFilter('profit',this)">‚úÖ –ü—Ä–∏–±—ã–ª—å–Ω—ã–µ</button>
        <button class="prod-tag" onclick="setProdFilter('loss',this)">‚ùå –£–±—ã—Ç–æ—á–Ω—ã–µ</button>
        <button class="prod-tag" onclick="setProdFilter('margin30',this)">üî• –ú–∞—Ä–∂–∞ &gt;30%</button>
      </div>
      <select id="filterCat" class="prod-filter-sel" onchange="prodPage=0;applyProdFilter()" title="–§–∏–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏">
        <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
      </select>
      <select id="filterCountry" class="prod-filter-sel" onchange="prodPage=0;applyProdFilter()" title="–§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç—Ä–∞–Ω–µ">
        <option value="">–í—Å–µ —Å—Ç—Ä–∞–Ω—ã</option>
      </select>
      <span class="prod-filter-count" id="prodFilterCount"></span>
    </div>

    <div class="table-wrap">
      <table id="productsTable">
        <thead>
          <tr>
            <th style="width:16px"></th>
            <th style="width:36px;text-align:center">
              <input type="checkbox" class="row-checkbox" id="selectAllCheck" onclick="toggleSelectAll()" title="–í—ã–±—Ä–∞—Ç—å –≤—Å–µ" />
            </th>
            <th>#</th>
            <th class="sortable" onclick="sortTable('name')" style="min-width:260px">–¢–æ–≤–∞—Ä<span class="sort-arrow" id="sarr-name"></span></th>
            <th>–†–∞–∑–º–µ—Ä</th>
            <th class="sortable" onclick="sortTable('usd')">–¶–µ–Ω–∞ USD<span class="sort-arrow" id="sarr-usd"></span></th>
            <th class="sortable" onclick="sortTable('qty')">–ö–æ–ª-–≤–æ<span class="sort-arrow" id="sarr-qty"></span></th>
            <th>–õ–æ–≥–∏—Å—Ç–∏–∫–∞/—é–Ω–∏—Ç</th>
            <th>–ö–æ–º–∏—Å—Å–∏—è/—é–Ω–∏—Ç</th>
            <th>–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥/—é–Ω–∏—Ç</th>
            <th class="sortable" onclick="sortTable('cogs')">–°–µ–±–µ—Å—Ç. (—Å—É–º)<span class="sort-arrow" id="sarr-cogs"></span></th>
            <th class="sortable" onclick="sortTable('price')">–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏<span class="sort-arrow" id="sarr-price"></span></th>
            <th class="sortable" onclick="sortTable('profit')">–ü—Ä–∏–±—ã–ª—å/—é–Ω–∏—Ç<span class="sort-arrow" id="sarr-profit"></span></th>
            <th class="sortable" onclick="sortTable('sold')">–ü—Ä–æ–¥–∞–Ω–æ<span class="sort-arrow" id="sarr-sold"></span></th>
            <th></th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
      <div class="empty-table" id="emptyHint">–ù–∞–∂–º–∏ ¬´+ –î–æ–±–∞–≤–∏—Ç—å —Ç–æ–≤–∞—Ä¬ª —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å</div>
    </div>
    <div id="paginator">
      <button id="pagPrev" onclick="changeProdPage(-1)">‚Äπ</button>
      <span id="pagCur"></span>
      <button id="pagNext" onclick="changeProdPage(1)">‚Ä∫</button>
    </div>
  </div>

  <!-- Bulk edit -->
  <div class="bulk-card">
    <button onclick="toggleBulkCard()" style="width:100%;display:flex;align-items:center;justify-content:space-between;background:none;border:none;cursor:pointer;padding:0;margin-bottom:0;gap:8px">
      <div class="bulk-title" style="margin:0">‚ö° –û–ø—Ç–æ–≤–æ–µ –∏–∑–º–µ–Ω–µ–Ω–∏–µ</div>
      <span id="bulkChevron" style="color:#4f5a7a;font-size:0.8rem;flex-shrink:0">‚ñ∏</span>
    </button>
    <div id="bulkCardBody" style="display:none;margin-top:16px">
    <div class="bulk-row">
      <div class="bulk-group">
        <div class="bulk-label">–î–æ–±–∞–≤–∏—Ç—å –∫ —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç–∏ –≤—Å–µ—Ö</div>
        <div class="bulk-inputs">
          <input type="number" id="bulkAddCost" placeholder="0" />
          <span class="badge">—Å—É–º</span>
          <button class="bulk-btn" onclick="bulkAddCost()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
      </div>
      <div class="bulk-sep"></div>
      <div class="bulk-group">
        <div class="bulk-label">–ò–∑–º–µ–Ω–∏—Ç—å –≤—Å–µ USD —Ü–µ–Ω—ã –Ω–∞ %</div>
        <div class="bulk-inputs">
          <input type="number" id="bulkUsdPct" placeholder="0" />
          <span class="badge">%</span>
          <button class="bulk-btn" onclick="bulkChangeUsd()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
      </div>
      <div class="bulk-sep"></div>
      <div class="bulk-group">
        <div class="bulk-label">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ–º –æ–¥–Ω—É USD —Ü–µ–Ω—É</div>
        <div class="bulk-inputs">
          <input type="number" id="bulkSetUsd" placeholder="0" step="0.01" />
          <span class="badge">$</span>
          <button class="bulk-btn" onclick="bulkSetUsd()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
      </div>
      <div class="bulk-sep"></div>
      <div class="bulk-group">
        <div class="bulk-label">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ–º –æ–¥–Ω–æ –∫–æ–ª-–≤–æ</div>
        <div class="bulk-inputs">
          <input type="number" id="bulkSetQty" placeholder="6" min="1" />
          <span class="badge">—à—Ç</span>
          <button class="bulk-btn" onclick="bulkSetQty()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
      </div>
      <div class="bulk-sep"></div>
      <div class="bulk-group">
        <div class="bulk-label">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –≤—Å–µ–º –ª–æ–≥–∏—Å—Ç–∏–∫—É/—é–Ω–∏—Ç</div>
        <div class="bulk-inputs">
          <input type="number" id="bulkSetLogistics" placeholder="0" min="0" step="1" />
          <span class="badge">—Å—É–º</span>
          <button class="bulk-btn" onclick="bulkSetLogistics()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
        </div>
      </div>
    </div>
    </div><!-- /bulkCardBody -->
  </div>

  <!-- Archive -->
  <div class="archive-card" id="archiveSection" style="display:none">
    <div class="archive-header">
      <div class="archive-title">üóÉ –ê—Ä—Ö–∏–≤ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤</div>
      <button class="bulk-btn" onclick="clearArchive()" style="color:#ef4444;border-color:rgba(239,68,68,0.3)">–û—á–∏—Å—Ç–∏—Ç—å –∞—Ä—Ö–∏–≤</button>
    </div>
    <div id="archiveList"></div>
  </div>

  <!-- Actions -->
  <div class="actions">
    <button class="btn-calc" onclick="recalc()">‚ö° –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å –≤—Å–µ —Ü–µ–Ω—ã</button>
    <button class="btn-export" onclick="exportCSV()">üì• –°–∫–∞—á–∞—Ç—å CSV</button>
    <button class="btn-export" onclick="clearAll()">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
  </div>

</div>


<!-- ‚ïê‚ïê‚ïê TAB: –ê–ù–ê–õ–ò–¢–ò–ö–ê ‚ïê‚ïê‚ïê -->
<div id="tab-analytics" class="page tab-content">

  <!-- Empty state -->
  <div class="analytics-empty" id="analyticsEmpty">
    <div class="big-icon">üìä</div>
    <div style="font-size:1rem; margin-bottom:8px">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞</div>
    <div style="font-size:0.82rem; color:#2d3455">–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –≤–æ –≤–∫–ª–∞–¥–∫–µ ¬´–¢–æ–≤–∞—Ä—ã¬ª</div>
  </div>

  <!-- Content -->
  <div id="analyticsContent" style="display:none">

    <!-- No sales data state (real mode) -->
    <div id="analyticsNoSales" class="analytics-no-data" style="display:none">
      üì¶ –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø—Ä–æ–¥–∞–∂–∞—Ö<br>
      <span style="font-size:0.78rem">–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–æ–¥–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–æ–ª–æ–Ω–∫–µ <b>–ü—Ä–æ–¥–∞–Ω–æ</b> ‚Äî<br>–∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å</span><br><br>
      <button class="analytics-mode-btn" onclick="setAnalyticsMode('forecast')" style="margin-top:8px">üîÆ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ–≥–Ω–æ–∑</button>
    </div>

    <!-- Mode toggle -->
    <div class="analytics-mode-toggle">
      <button id="modeRealBtn" class="analytics-mode-btn active" onclick="setAnalyticsMode('real')">üìä –§–∞–∫—Ç</button>
      <button id="modeForecastBtn" class="analytics-mode-btn" onclick="setAnalyticsMode('forecast')">üîÆ –ü—Ä–æ–≥–Ω–æ–∑</button>
    </div>

    <!-- Top / Bottom ranking -->
    <div class="top-bottom-grid">
      <div class="rank-card">
        <div class="rank-card-title" id="rankTopTitle">üèÜ –¢–æ–ø-5 –ø–æ –ø—Ä–∏–±—ã–ª–∏</div>
        <div id="rankTop">‚Äî</div>
      </div>
      <div class="rank-card">
        <div class="rank-card-title" id="rankBottomTitle">üìâ –ù–∞–∏–º–µ–Ω–µ–µ –ø—Ä–∏–±—ã–ª—å–Ω—ã–µ</div>
        <div id="rankBottom">‚Äî</div>
      </div>
    </div>

    <!-- Charts -->
    <div class="charts-grid">

      <!-- Chart 1: Profit per unit -->
      <div class="chart-card">
        <div class="chart-title">–ü—Ä–∏–±—ã–ª—å / —é–Ω–∏—Ç –ø–æ —Ç–æ–≤–∞—Ä–∞–º</div>
        <div class="chart-wrap">
          <canvas id="chartProfitUnit"></canvas>
        </div>
      </div>

      <!-- Chart 2: Cost structure donut -->
      <div class="chart-card">
        <div class="chart-title">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∑–∞—Ç—Ä–∞—Ç –ø–∞—Ä—Ç–∏–∏</div>
        <div class="chart-wrap">
          <canvas id="chartCostDonut"></canvas>
        </div>
      </div>

      <!-- Chart 3: Revenue vs COGS ‚Äî full width -->
      <div class="chart-card span2">
        <div class="chart-title">–í—ã—Ä—É—á–∫–∞ vs –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å (–ø–æ —Ç–æ–≤–∞—Ä–∞–º, —Å —É—á—ë—Ç–æ–º –∫–æ–ª-–≤–∞)</div>
        <div class="chart-wrap tall">
          <canvas id="chartRevenueVsCogs"></canvas>
        </div>
      </div>

      <!-- Chart 4: Margin % -->
      <div class="chart-card">
        <div class="chart-title">–ú–∞—Ä–∂–∞ % –ø–æ —Ç–æ–≤–∞—Ä–∞–º</div>
        <div class="chart-wrap">
          <canvas id="chartMarginPct"></canvas>
        </div>
      </div>

      <!-- Chart 5: Price vs COGS per unit -->
      <div class="chart-card">
        <div class="chart-title">–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏ vs –°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å / —é–Ω–∏—Ç</div>
        <div class="chart-wrap">
          <canvas id="chartPriceVsCogs"></canvas>
        </div>
      </div>

      <!-- Chart 6: Profit by category -->
      <div class="chart-card span2">
        <div class="chart-title">–ü—Ä–∏–±—ã–ª—å –ø–æ –∫–∞—Ç–µ–≥–æ—Ä–∏—è–º</div>
        <div class="chart-wrap">
          <canvas id="chartCategoryProfit"></canvas>
        </div>
      </div>

      <!-- Chart 7: Inventory Health (sold vs remaining) -->
      <div class="chart-card span2">
        <div class="chart-title">üì¶ –û–±–æ—Ä–∞—á–∏–≤–∞–µ–º–æ—Å—Ç—å ‚Äî –ü—Ä–æ–¥–∞–Ω–æ vs –û—Å—Ç–∞—Ç–æ–∫</div>
        <div class="chart-wrap tall">
          <canvas id="chartInventory"></canvas>
        </div>
      </div>

      <!-- Chart 8: Break-even ACoS per product -->
      <div class="chart-card span2">
        <div class="chart-title">üí∞ Max ACoS (—Ä–µ–∫–ª–∞–º–Ω—ã–π –±—é–¥–∂–µ—Ç –±–µ–∑ —É–±—ã—Ç–∫–∞)</div>
        <div class="chart-wrap tall">
          <canvas id="chartAcos"></canvas>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê WAREHOUSE TAB ‚ïê‚ïê‚ïê -->
<div id="tab-warehouse" class="page tab-content">

  <!-- ‚îÄ‚îÄ‚îÄ WAREHOUSE SUB-NAVIGATION ‚îÄ‚îÄ‚îÄ -->
  <div class="wh-subnav" id="whSubnav">
    <button class="wh-subnav-btn active" onclick="showWhPage('wh-stock')" data-wh="wh-stock">üì¶ –û—Å—Ç–∞—Ç–∫–∏</button>
    <button class="wh-subnav-btn" onclick="showWhPage('wh-moves')" data-wh="wh-moves">‚ÜïÔ∏è –î–≤–∏–∂–µ–Ω–∏—è</button>
    <button class="wh-subnav-btn" onclick="showWhPage('wh-supplies')" data-wh="wh-supplies">üì• –ü–æ—Å—Ç–∞–≤–∫–∏</button>
    <button class="wh-subnav-btn" onclick="showWhPage('wh-writeoffs')" data-wh="wh-writeoffs">üóë –°–ø–∏—Å–∞–Ω–∏—è</button>
    <button class="wh-subnav-btn" onclick="showWhPage('wh-inventories')" data-wh="wh-inventories">üîç –ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è</button>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ STOCK PAGE ‚îÄ‚îÄ‚îÄ -->
  <div id="wh-stock" class="wh-page active">
    <div class="wh-page-hd">
      <div>
        <div class="wh-page-title">–û—Å—Ç–∞—Ç–∫–∏ –Ω–∞ —Å–∫–ª–∞–¥–µ</div>
        <div class="wh-page-sub">–¢–µ–∫—É—â–∏–µ –∑–∞–ø–∞—Å—ã –ø–æ SKU –∏ —Ä–∞–∑–º–µ—Ä–∞–º</div>
      </div>
      <button class="btn-wh btn-wh-primary" onclick="whImportFromProducts()" title="–°–æ–∑–¥–∞—Ç—å –Ω–∞—á–∞–ª—å–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –¢–æ–≤–∞—Ä–æ–≤">üì• –°–æ–∑–¥–∞—Ç—å –∏–∑ —Ç–æ–≤–∞—Ä–æ–≤</button>
    </div>

    <div class="wh-kpi">
      <div class="wh-kpi-card">
        <div class="wh-kpi-label">–ü–æ–∑–∏—Ü–∏–π (SKU)</div>
        <div class="wh-kpi-val kpi-cyan" id="whKpiSku">‚Äî</div>
      </div>
      <div class="wh-kpi-card">
        <div class="wh-kpi-label">–û–±—â–∏–π –æ—Å—Ç–∞—Ç–æ–∫ (—à—Ç.)</div>
        <div class="wh-kpi-val kpi-yellow" id="whKpiTotal">‚Äî</div>
      </div>
      <div class="wh-kpi-card">
        <div class="wh-kpi-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–ø–∞—Å–æ–≤</div>
        <div class="wh-kpi-val kpi-green" id="whKpiValue">‚Äî</div>
      </div>
      <div class="wh-kpi-card">
        <div class="wh-kpi-label">–°—Ä. —Å–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å</div>
        <div class="wh-kpi-val kpi-purple" id="whKpiAvgCost">‚Äî</div>
      </div>
      <div class="wh-kpi-card" style="cursor:pointer" onclick="document.getElementById('whStockFilter').value='zero';renderWhStock()" title="–ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–∑–∏—Ü–∏–∏ –±–µ–∑ –æ—Å—Ç–∞—Ç–∫–∞">
        <div class="wh-kpi-label">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</div>
        <div class="wh-kpi-val" style="color:#ef4444" id="whKpiLowStock">‚Äî</div>
      </div>
    </div>

    <div class="wh-toolbar">
      <input type="text" class="wh-search" id="whStockSearch"
        placeholder="–ü–æ–∏—Å–∫ –ø–æ SKU –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—é..." oninput="renderWhStock()">
      <select class="wh-select" id="whStockFilter" onchange="renderWhStock()" style="width:160px">
        <option value="">–í—Å–µ –ø–æ–∑–∏—Ü–∏–∏</option>
        <option value="positive">–í –Ω–∞–ª–∏—á–∏–∏</option>
        <option value="zero">–ù–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏</option>
      </select>
      <button class="btn-wh btn-wh-ghost btn-wh-sm" onclick="whExportStockCSV()" title="–°–∫–∞—á–∞—Ç—å CSV">‚¨á CSV</button>
    </div>

    <div class="wh-table-wrap">
      <table class="wh-table">
        <thead>
          <tr>
            <th>–ù–∞–∑–≤–∞–Ω–∏–µ / SKU</th>
            <th>–†–∞–∑–º–µ—Ä</th>
            <th class="num">–û—Å—Ç–∞—Ç–æ–∫</th>
            <th class="num">–°—Ä. —Å–µ–±–µ—Å—Ç. (UZS)</th>
            <th class="num">–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–ø–∞—Å–æ–≤ (UZS)</th>
          </tr>
        </thead>
        <tbody id="whStockBody">
          <tr><td colspan="5" class="wh-empty">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</td></tr>
        </tbody>
      </table>
      <div class="wh-table-footer">
        <span id="whStockFooter">‚Äî</span>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ MOVES PAGE ‚îÄ‚îÄ‚îÄ -->
  <div id="wh-moves" class="wh-page">
    <div class="wh-page-hd">
      <div>
        <div class="wh-page-title">–î–≤–∏–∂–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤</div>
        <div class="wh-page-sub">–ñ—É—Ä–Ω–∞–ª –≤—Å–µ—Ö —Å–∫–ª–∞–¥—Å–∫–∏—Ö –æ–ø–µ—Ä–∞—Ü–∏–π (—Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ)</div>
      </div>
    </div>

    <div class="wh-toolbar">
      <input type="text" class="wh-search" id="whMovesSearch"
        placeholder="–ü–æ–∏—Å–∫ –ø–æ SKU –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏—é..." oninput="renderWhMoves()">
      <select class="wh-select" id="whMovesTypeFilter" onchange="renderWhMoves()" style="width:150px">
        <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
        <option value="IN">–ü—Ä–∏—Ö–æ–¥ (IN)</option>
        <option value="OUT">–°–ø–∏—Å–∞–Ω–∏–µ (OUT)</option>
        <option value="ADJUST">–ö–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞</option>
      </select>
      <input type="date" class="wh-form-input" id="whMovesDateFrom"
        onchange="renderWhMoves()" style="width:150px" placeholder="–î–∞—Ç–∞ –æ—Ç">
      <input type="date" class="wh-form-input" id="whMovesDateTo"
        onchange="renderWhMoves()" style="width:150px" placeholder="–î–∞—Ç–∞ –¥–æ">
    </div>

    <div class="wh-table-wrap">
      <table class="wh-table">
        <thead>
          <tr>
            <th>–î–∞—Ç–∞</th>
            <th>–¢–∏–ø</th>
            <th>–ù–∞–∑–≤–∞–Ω–∏–µ / SKU</th>
            <th>–†–∞–∑–º–µ—Ä</th>
            <th class="num">–ö–æ–ª-–≤–æ</th>
            <th class="num">–¶–µ–Ω–∞ (UZS)</th>
            <th class="num">–°—É–º–º–∞ (UZS)</th>
            <th>–û—Å–Ω–æ–≤–∞–Ω–∏–µ</th>
          </tr>
        </thead>
        <tbody id="whMovesBody">
          <tr><td colspan="8" class="wh-empty">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
        </tbody>
      </table>
      <div class="wh-table-footer">
        <span id="whMovesFooter">‚Äî</span>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ SUPPLIES LIST PAGE ‚îÄ‚îÄ‚îÄ -->
  <div id="wh-supplies" class="wh-page">
    <div class="wh-page-hd">
      <div>
        <div class="wh-page-title">–ü–æ—Å—Ç–∞–≤–∫–∏ (–ü—Ä–∏—Ö–æ–¥)</div>
        <div class="wh-page-sub">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–µ–º —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ —Å–∫–ª–∞–¥</div>
      </div>
      <button class="btn-wh btn-wh-primary" onclick="whNewSupply()">‚ûï –ù–æ–≤–∞—è –ø–æ—Å—Ç–∞–≤–∫–∞</button>
    </div>

    <div class="wh-table-wrap">
      <table class="wh-table">
        <thead>
          <tr>
            <th>–î–∞—Ç–∞</th>
            <th>–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
            <th>–ù–∞–∫–ª–∞–¥–Ω–∞—è</th>
            <th class="num">–ü–æ–∑–∏—Ü–∏–π</th>
            <th class="num">–°—É–º–º–∞ (UZS)</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="whSuppliesBody">
          <tr><td colspan="9" class="wh-empty">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ SUPPLY FORM PAGE ‚îÄ‚îÄ‚îÄ -->
  <div id="wh-supply-form" class="wh-page">
    <div class="wh-page-hd">
      <div>
        <div class="wh-page-title" id="whSupplyFormTitle">–ù–æ–≤–∞—è –ø–æ—Å—Ç–∞–≤–∫–∞</div>
        <div class="wh-page-sub">–ß–µ—Ä–Ω–æ–≤–∏–∫ ‚Äî –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∏ –ø—Ä–æ–≤–µ–¥–∏—Ç–µ</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn-wh btn-wh-secondary" onclick="showWhPage('wh-supplies')">‚Üê –ù–∞–∑–∞–¥</button>
        <button class="btn-wh btn-wh-ghost" id="whSupplyDraftBtn" onclick="whSaveDraftSupply()">üíæ –ß–µ—Ä–Ω–æ–≤–∏–∫</button>
        <button class="btn-wh btn-wh-primary" id="whSupplyPostBtn" onclick="whPostSupply()">‚úì –ü—Ä–æ–≤–µ—Å—Ç–∏</button>
      </div>
    </div>

    <div class="wh-form-section">
      <div class="wh-form-title">–û–±—â–∏–µ —Å–≤–µ–¥–µ–Ω–∏—è</div>
      <div class="wh-form-grid">
        <div class="wh-form-field">
          <label class="wh-form-label">–î–∞—Ç–∞</label>
          <input type="date" class="wh-form-input" id="whSupplyDate">
        </div>
        <div class="wh-form-field">
          <label class="wh-form-label">–í–∞–ª—é—Ç–∞ –∑–∞–∫—É–ø–∞</label>
          <select class="wh-select" id="whSupplyCurrency" onchange="whUpdateSupplyCurrency()">
            <option value="UZS">UZS</option>
            <option value="USD">USD</option>
          </select>
        </div>
        <div class="wh-form-field" id="whSupplyRateField" style="display:none">
          <label class="wh-form-label">–ö—É—Ä—Å (1 USD = ? UZS)</label>
          <input type="number" class="wh-form-input" id="whSupplyRate"
            placeholder="12500" min="1" oninput="renderWhSupplyItems()">
        </div>
        <div class="wh-form-field">
          <label class="wh-form-label">–î–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã (–¥–æ—Å—Ç–∞–≤–∫–∞, UZS)</label>
          <input type="number" class="wh-form-input" id="whSupplyExpenses"
            placeholder="0" min="0" oninput="updateWhSupplySummary()">
        </div>
        <div class="wh-form-field">
          <label class="wh-form-label">–ü–æ—Å—Ç–∞–≤—â–∏–∫</label>
          <input type="text" class="wh-form-input" id="whSupplySupplier" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞">
        </div>
        <div class="wh-form-field">
          <label class="wh-form-label">–ù–æ–º–µ—Ä –Ω–∞–∫–ª–∞–¥–Ω–æ–π / –¥–æ–∫—É–º–µ–Ω—Ç–∞</label>
          <input type="text" class="wh-form-input" id="whSupplyInvoice" placeholder="‚Ññ –Ω–∞–∫–ª–∞–¥–Ω–æ–π">
        </div>
        <div class="wh-form-field" style="grid-column:span 2">
          <label class="wh-form-label">–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ</label>
          <input type="text" class="wh-form-input" id="whSupplyNote" placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...">
        </div>
      </div>
    </div>

    <div class="wh-form-section">
      <div class="wh-items-header">
        <div class="wh-form-title" style="margin-bottom:0">–ü–æ–∑–∏—Ü–∏–∏</div>
        <button class="btn-wh btn-wh-secondary btn-wh-sm" onclick="whAddSupplyItem()">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é</button>
      </div>
      <div class="wh-items-list" id="whSupplyItemsList">
        <div class="wh-empty" style="padding:20px">–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –ø–æ–∑–∏—Ü–∏—é</div>
      </div>
    </div>

    <div class="wh-form-section">
      <div class="wh-form-title">–ò—Ç–æ–≥–æ</div>
      <div style="display:flex;gap:28px;flex-wrap:wrap">
        <div>
          <div class="wh-form-label">–ö–æ–ª-–≤–æ (—à—Ç.)</div>
          <div style="font-size:1.05rem;font-weight:800;color:#818cf8;margin-top:4px" id="whSupplySumQty">0</div>
        </div>
        <div>
          <div class="wh-form-label">–°—É–º–º–∞ –∑–∞–∫—É–ø–∞</div>
          <div style="font-size:1.05rem;font-weight:800;color:#22c55e;margin-top:4px" id="whSupplySumPurchase">0 —Å—É–º</div>
        </div>
        <div>
          <div class="wh-form-label">–î–æ–ø. —Ä–∞—Å—Ö–æ–¥—ã</div>
          <div style="font-size:1.05rem;font-weight:800;color:#f59e0b;margin-top:4px" id="whSupplySumExpenses">0 —Å—É–º</div>
        </div>
        <div>
          <div class="wh-form-label">Landed cost (–∏—Ç–æ–≥–æ)</div>
          <div style="font-size:1.05rem;font-weight:800;color:#22c55e;margin-top:4px" id="whSupplySumTotal">0 —Å—É–º</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ WRITE-OFFS LIST PAGE ‚îÄ‚îÄ‚îÄ -->
  <div id="wh-writeoffs" class="wh-page">
    <div class="wh-page-hd">
      <div>
        <div class="wh-page-title">–°–ø–∏—Å–∞–Ω–∏—è</div>
        <div class="wh-page-sub">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∞–Ω–∏–µ–º —Ç–æ–≤–∞—Ä–æ–≤ —Å–æ —Å–∫–ª–∞–¥–∞</div>
      </div>
      <button class="btn-wh btn-wh-primary" onclick="whNewWriteoff()">‚ûï –ù–æ–≤–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ</button>
    </div>

    <div class="wh-table-wrap">
      <table class="wh-table">
        <thead>
          <tr>
            <th>–î–∞—Ç–∞</th>
            <th>–¢–∏–ø</th>
            <th>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</th>
            <th class="num">–ö–æ–ª-–≤–æ (—à—Ç.)</th>
            <th class="num">–°—É–º–º–∞ (UZS)</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="whWriteoffsBody">
          <tr><td colspan="7" class="wh-empty">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ WRITE-OFF FORM PAGE ‚îÄ‚îÄ‚îÄ -->
  <div id="wh-writeoff-form" class="wh-page">
    <div class="wh-page-hd">
      <div>
        <div class="wh-page-title" id="whWriteoffFormTitle">–ù–æ–≤–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ</div>
        <div class="wh-page-sub">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn-wh btn-wh-secondary" onclick="showWhPage('wh-writeoffs')">‚Üê –ù–∞–∑–∞–¥</button>
        <button class="btn-wh btn-wh-ghost" id="whWriteoffDraftBtn" onclick="whSaveDraftWriteoff()">üíæ –ß–µ—Ä–Ω–æ–≤–∏–∫</button>
        <button class="btn-wh btn-wh-primary" id="whWriteoffPostBtn" onclick="whPostWriteoff()">‚úì –ü—Ä–æ–≤–µ—Å—Ç–∏</button>
      </div>
    </div>

    <div class="wh-form-section">
      <div class="wh-form-title">–û–±—â–∏–µ —Å–≤–µ–¥–µ–Ω–∏—è</div>
      <div class="wh-form-grid">
        <div class="wh-form-field">
          <label class="wh-form-label">–î–∞—Ç–∞</label>
          <input type="date" class="wh-form-input" id="whWriteoffDate">
        </div>
        <div class="wh-form-field">
          <label class="wh-form-label">–¢–∏–ø —Å–ø–∏—Å–∞–Ω–∏—è</label>
          <select class="wh-select" id="whWriteoffType">
            <option value="–±—Ä–∞–∫">–ë—Ä–∞–∫</option>
            <option value="—É—Ç–µ—Ä—è">–£—Ç–µ—Ä—è</option>
            <option value="–≤–æ–∑–≤—Ä–∞—Ç">–í–æ–∑–≤—Ä–∞—Ç –ø–æ—Å—Ç–∞–≤—â–∏–∫—É</option>
            <option value="–º–∞—Ä–∫–µ—Ç–∏–Ω–≥">–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥ / –ø—Ä–æ–º–æ</option>
            <option value="–ø—Ä–æ—á–µ–µ">–ü—Ä–æ—á–µ–µ</option>
          </select>
        </div>
        <div class="wh-form-field" style="grid-column:span 2">
          <label class="wh-form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
          <input type="text" class="wh-form-input" id="whWriteoffComment"
            placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...">
        </div>
      </div>
    </div>

    <div class="wh-form-section">
      <div class="wh-items-header">
        <div class="wh-form-title" style="margin-bottom:0">–ü–æ–∑–∏—Ü–∏–∏</div>
        <button class="btn-wh btn-wh-secondary btn-wh-sm" onclick="whAddWriteoffItem()">+ –î–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∏—Ü–∏—é</button>
      </div>
      <div class="wh-items-list" id="whWriteoffItemsList">
        <div class="wh-empty" style="padding:20px">–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –ø–æ–∑–∏—Ü–∏—é</div>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ INVENTORIES LIST PAGE ‚îÄ‚îÄ‚îÄ -->
  <div id="wh-inventories" class="wh-page">
    <div class="wh-page-hd">
      <div>
        <div class="wh-page-title">–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è</div>
        <div class="wh-page-sub">–ü–µ—Ä–µ—Å—á—ë—Ç —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö –æ—Å—Ç–∞—Ç–∫–æ–≤ –Ω–∞ —Å–∫–ª–∞–¥–µ</div>
      </div>
      <button class="btn-wh btn-wh-primary" onclick="whNewInventory()">‚ûï –ù–æ–≤–∞—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è</button>
    </div>

    <div class="wh-table-wrap">
      <table class="wh-table">
        <thead>
          <tr>
            <th>–î–∞—Ç–∞</th>
            <th class="num">–ü–æ–∑–∏—Ü–∏–π</th>
            <th class="num">–†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–π</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="whInventoriesBody">
          <tr><td colspan="5" class="wh-empty">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ‚îÄ INVENTORY FORM PAGE ‚îÄ‚îÄ‚îÄ -->
  <div id="wh-inventory-form" class="wh-page">
    <div class="wh-page-hd">
      <div>
        <div class="wh-page-title">–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è</div>
        <div class="wh-page-sub">–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –æ—Å—Ç–∞—Ç–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏</div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button class="btn-wh btn-wh-secondary" onclick="showWhPage('wh-inventories')">‚Üê –ù–∞–∑–∞–¥</button>
        <button class="btn-wh btn-wh-primary" id="whInventoryPostBtn" onclick="whPostInventory()">‚úì –ü—Ä–æ–≤–µ—Å—Ç–∏</button>
      </div>
    </div>

    <div class="wh-form-section">
      <div class="wh-form-field" style="max-width:200px">
        <label class="wh-form-label">–î–∞—Ç–∞ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏</label>
        <input type="date" class="wh-form-input" id="whInventoryDate">
      </div>
    </div>

    <div class="wh-form-section">
      <div class="wh-form-title">–û—Å—Ç–∞—Ç–∫–∏ –ø–æ –ø–æ–∑–∏—Ü–∏—è–º</div>
      <div class="wh-table-wrap" style="border-radius:10px;margin-top:0">
        <table class="wh-table">
          <thead>
            <tr>
              <th>–ù–∞–∑–≤–∞–Ω–∏–µ / SKU</th>
              <th>–†–∞–∑–º–µ—Ä</th>
              <th class="num">–ü–æ —Å–∏—Å—Ç–µ–º–µ</th>
              <th class="num">–§–∞–∫—Ç (–≤–≤–æ–¥)</th>
              <th class="num">–†–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ</th>
            </tr>
          </thead>
          <tbody id="whInventoryItemsBody">
            <tr><td colspan="5" class="wh-empty">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–∑–∏—Ü–∏–π...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div><!-- /tab-warehouse -->

<!-- ‚ïê‚ïê‚ïê SALES TAB ‚ïê‚ïê‚ïê -->
<div id="tab-sales" class="page tab-content">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px">
    <div>
      <div style="font-size:1.1rem;font-weight:700">–ü—Ä–æ–¥–∞–∂–∏</div>
      <div style="font-size:0.75rem;color:#64748b;margin-top:2px">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤</div>
    </div>
    <button class="btn-wh btn-wh-primary" onclick="openSaleModal()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥–∞–∂—É</button>
  </div>

  <div class="wh-kpi" style="grid-template-columns:repeat(4,1fr)">
    <div class="wh-kpi-card"><div class="wh-kpi-label">–í—Å–µ–≥–æ –∑–∞–∫–∞–∑–æ–≤</div><div class="wh-kpi-val kpi-cyan" id="slKpiTotal">‚Äî</div></div>
    <div class="wh-kpi-card"><div class="wh-kpi-label">–í—ã—Ä—É—á–∫–∞ (–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ)</div><div class="wh-kpi-val kpi-green" id="slKpiRevenue">‚Äî</div></div>
    <div class="wh-kpi-card"><div class="wh-kpi-label">–ö –≤—ã–≤–æ–¥—É</div><div class="wh-kpi-val kpi-purple" id="slKpiPayout">‚Äî</div></div>
    <div class="wh-kpi-card"><div class="wh-kpi-label">–í–æ–∑–≤—Ä–∞—Ç–æ–≤</div><div class="wh-kpi-val" style="color:#ef4444" id="slKpiReturns">‚Äî</div></div>
  </div>

  <div style="display:flex;gap:10px;margin-bottom:14px">
    <input id="slSearch" type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ SKU, –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ ‚Ññ –∑–∞–∫–∞–∑–∞..." oninput="renderSales()" style="flex:1;max-width:320px" />
    <select id="slFilter" onchange="renderSales()" class="wh-select" style="width:170px">
      <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
      <option value="delivered">‚úÖ –î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</option>
      <option value="returned">‚ùå –í–æ–∑–≤—Ä–∞—Ç</option>
    </select>
  </div>

  <div class="wh-table-wrap">
    <table class="wh-table" style="width:100%">
      <thead>
        <tr>
          <th style="width:36px"></th>
          <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th>
          <th>–î–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∏—è</th>
          <th>‚Ññ –∑–∞–∫–∞–∑–∞</th>
          <th>SKU</th>
          <th>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</th>
          <th class="num">–ö–æ–ª-–≤–æ</th>
          <th class="num">–¶–µ–Ω–∞, —Å—É–º</th>
          <th class="num">–ö –≤—ã–≤–æ–¥—É, —Å—É–º</th>
          <th style="width:36px"></th>
        </tr>
      </thead>
      <tbody id="slBody"></tbody>
    </table>
    <div class="wh-table-footer" id="slFooter">–ü–æ–∫–∞–∑–∞–Ω–æ 0 –ø—Ä–æ–¥–∞–∂</div>
  </div>
</div><!-- /tab-sales -->


<script>
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  //  Utilities
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function escH(s) {
    return String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  // ‚îÄ‚îÄ Lightbox ‚îÄ‚îÄ
  function openLightbox(src) {
    document.getElementById('lightboxImg').src = src;
    document.getElementById('lightbox').classList.add('open');
  }
  function closeLightbox() {
    document.getElementById('lightbox').classList.remove('open');
  }
  document.addEventListener('keydown', e => {
    if (e.key === 'Escape') closeLightbox();
  });

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  //  State
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let rows = [];
  let marginPct = 30;
  let rowCounter = 0;
  let activeTab = 'dashboard';
  let lastChartData = null;
  let archive = [];
  let sales = [];
  let salesCounter = 0;
  let _saleStatus = 'delivered';
  let pendingConfirmCallback = null;
  let sizeOptions = ['2-3', '3-4', '4-5', '5-6', '7-8', '9-10'];
  let selectedSizes = [];   // multi-select array
  let currentPhoto = null; // base64 data URL
  let editingRowId = null; // null = add mode, id = edit mode
  let currentModalMargin = 30;
  let defaultRate = 12519; // remembers last used rate for next new product
  let expandedGroups = new Set(); // group keys (code|name) that are expanded
  let shipments = [];             // shipment history records
  let shipmentCounter = 0;        // sequential shipment number
  let publicToken = null;         // token for public price list URL
  let tgBotToken  = '';           // Telegram bot token
  let tgChatId    = '';           // Telegram chat ID
  let categories  = ['–û–±—É–≤—å', '–û–¥–µ–∂–¥–∞', '–ê–∫—Å–µ—Å—Å—É–∞—Ä—ã', '–ò–≥—Ä—É—à–∫–∏', '–î—Ä—É–≥–æ–µ'];
  let minMarginAlert = 0;    // margin threshold ‚Äî rows below this % are highlighted
  let simDiscount = 0;       // simulator discount %
  let analyticsMode = 'real'; // 'real' | 'forecast'
  let _xlsxPendingData = null, _xlsxPendingCols = null; // xlsx import staging
  let marginAlertState = {}; // id ‚Üí boolean: was below threshold on previous recalc
  let tableSortCol = null, tableSortDir = 1; // column sort state
  let countries   = ['–ö–∏—Ç–∞–π', '–¢—É—Ä—Ü–∏—è', '–£–∑–±–µ–∫–∏—Å—Ç–∞–Ω', '–†–æ—Å—Å–∏—è', '–ë–∞–Ω–≥–ª–∞–¥–µ—à', '–í—å–µ—Ç–Ω–∞–º', '–ò–Ω–¥–∏—è', '–ü–∞–∫–∏—Å—Ç–∞–Ω', '–Æ–∂–Ω–∞—è –ö–æ—Ä–µ—è', '–ò—Ç–∞–ª–∏—è', '–ì–µ—Ä–º–∞–Ω–∏—è', '–ü–æ–ª—å—à–∞'];
  let productExtras = {};         // rowId ‚Üí { nameUz, nameRu, descUz, descRu, fullDesc, chars }
  let currentCharRows = [];       // working buffer for characteristics in modal

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  //  Add Product Modal
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function _fillModalInfoPanel(rowRate, rowMargin, rowLogistics) {
    // Rate input
    const rateVal = rowRate != null ? rowRate : defaultRate;
    const rateInput = document.getElementById('am-rate');
    if (rateInput) rateInput.value = rateVal;
    // Logistics input
    const logInput = document.getElementById('am-logistics');
    if (logInput) logInput.value = rowLogistics > 0 ? rowLogistics : '';
    // Margin
    currentModalMargin = rowMargin != null ? rowMargin : 30;
    _syncModalMarginUI();
  }

  function _syncModalMarginUI() {
    document.querySelectorAll('#am-margin-selector .margin-btn').forEach(btn => {
      btn.classList.toggle('active', parseInt(btn.textContent) === currentModalMargin);
    });
    const inp = document.getElementById('am-margin-input');
    if (inp && parseInt(inp.value) !== currentModalMargin) inp.value = currentModalMargin;
  }

  function setModalMargin(val, btn) {
    currentModalMargin = val;
    _syncModalMarginUI();
  }

  function onModalMarginInput() {
    const inp = document.getElementById('am-margin-input');
    const val = parseInt(inp.value);
    if (val > 0 && val < 100) {
      currentModalMargin = val;
      // Deselect buttons that don't match
      document.querySelectorAll('#am-margin-selector .margin-btn').forEach(btn => {
        btn.classList.toggle('active', parseInt(btn.textContent) === val);
      });
    }
  }

  function onModalRateInput() {
    // nothing special needed, value is read on submit
  }

  function openAddModal() {
    editingRowId = null;
    document.querySelector('.add-modal-head h3').textContent = '–ù–æ–≤—ã–π —Ç–æ–≤–∞—Ä';
    document.querySelector('.btn-modal-submit').textContent = '+ –î–æ–±–∞–≤–∏—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É';
    // Reset form
    document.getElementById('am-code').value = '';
    document.getElementById('am-name').value = '';
    document.getElementById('am-usd').value  = '';
    document.getElementById('am-qty').value  = '6';
    removePhoto(null, true);
    selectedSizes = [];
    renderSizeChips();
    _fillModalInfoPanel(null, null, 0);
    populateCategoryDropdown();
    populateCountryDropdown();
    populateSupplierDropdown();
    resetModalExtras();
    switchModalTab('main');
    document.getElementById('addModal').classList.add('open');
    setTimeout(() => document.getElementById('am-code').focus(), 120);
  }

  function openEditModal(id) {
    const codeEl = document.getElementById('code-' + id);
    const nameEl = document.getElementById('name-' + id);
    const usdEl  = document.getElementById('usd-'  + id);
    const qtyEl  = document.getElementById('qty-'  + id);
    const tr     = document.getElementById('row-'  + id);
    const imgEl  = tr?.querySelector('img.row-thumb');
    const sizeEl = tr?.querySelector('.size-badge');

    // Pre-fill fields
    document.getElementById('am-code').value = codeEl?.value || '';
    document.getElementById('am-name').value = nameEl?.value || '';
    document.getElementById('am-usd').value  = usdEl?.value  || '';
    document.getElementById('am-qty').value  = qtyEl?.value  || '6';

    // Photo
    removePhoto(null, true);
    if (imgEl && imgEl.src && imgEl.src.startsWith('data:')) {
      currentPhoto = imgEl.src;
      document.getElementById('photoPreviewImg').src = currentPhoto;
      document.getElementById('photoPreview').style.display = 'block';
      document.getElementById('photoPlaceholder').style.display = 'none';
    }

    // Sizes (read from data-sizes attribute on the size cell)
    const sizesData = tr?.querySelector('.row-size-cell')?.getAttribute('data-sizes') || '';
    selectedSizes = sizesData ? sizesData.split(',').filter(Boolean) : [];
    renderSizeChips();

    // Per-row rate and margin
    const tr2 = document.getElementById('row-' + id);
    const savedRate      = tr2 ? (parseFloat(tr2.getAttribute('data-rate'))      || defaultRate) : defaultRate;
    const savedMargin    = tr2 ? (parseInt(tr2.getAttribute('data-margin'))      || 30)          : 30;
    const savedLogistics = tr2 ? (parseFloat(tr2.getAttribute('data-logistics')) || 0)           : 0;
    _fillModalInfoPanel(savedRate, savedMargin, savedLogistics);

    // Category + Country + Supplier
    populateCategoryDropdown();
    populateCountryDropdown();
    populateSupplierDropdown();
    const catEl = document.getElementById('am-category');
    if (catEl) catEl.value = document.getElementById('row-' + id)?.getAttribute('data-category') || '';
    const countryEl = document.getElementById('am-country');
    if (countryEl) countryEl.value = document.getElementById('row-' + id)?.getAttribute('data-country') || '';
    const supEl = document.getElementById('am-supplier');
    if (supEl) supEl.value = document.getElementById('row-' + id)?.getAttribute('data-supplier') || '';

    // Extras (descriptions, characteristics)
    fillModalExtras(productExtras[id] || {});
    switchModalTab('main');

    // Mode
    editingRowId = id;
    document.querySelector('.add-modal-head h3').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä';
    document.querySelector('.btn-modal-submit').textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è';

    document.getElementById('addModal').classList.add('open');
    setTimeout(() => document.getElementById('am-name').focus(), 120);
  }

  function closeAddModal() {
    document.getElementById('addModal').classList.remove('open');
  }

  // Close by clicking outside
  document.getElementById('addModal').addEventListener('click', e => {
    if (e.target === document.getElementById('addModal')) closeAddModal();
  });

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  //  Modal Tabs
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function switchModalTab(tab) {
    const mainEl = document.getElementById('am-tab-main');
    const descEl = document.getElementById('am-tab-desc');
    const tab1   = document.getElementById('amTab1');
    const tab2   = document.getElementById('amTab2');
    if (tab === 'main') {
      mainEl.style.display = '';
      descEl.style.display = 'none';
      tab1.classList.add('active');
      tab2.classList.remove('active');
    } else {
      mainEl.style.display = 'none';
      descEl.style.display = '';
      tab1.classList.remove('active');
      tab2.classList.add('active');
    }
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  //  Char counter
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function updateCharCount(el, counterId, max) {
    const cnt = document.getElementById(counterId);
    if (!cnt) return;
    const len = (el.value || '').length;
    cnt.textContent = len;
    cnt.style.color = len >= max ? '#ef4444' : '';
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  //  Characteristic rows
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderCharRows() {
    const container = document.getElementById('am-char-rows');
    if (!container) return;
    container.innerHTML = '';
    currentCharRows.forEach((row, idx) => {
      const div = document.createElement('div');
      div.className = 'char-row';
      div.innerHTML = `
        <input type="text" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" value="${escH(row.key||'')}"
          oninput="currentCharRows[${idx}].key=this.value"
          style="background:#0a0c12;border:1px solid #1e2235;border-radius:8px;color:#e2e8f0;font-size:0.82rem;padding:7px 10px;outline:none" />
        <input type="text" placeholder="–ó–Ω–∞—á–µ–Ω–∏–µ" value="${escH(row.val||'')}"
          oninput="currentCharRows[${idx}].val=this.value"
          style="background:#0a0c12;border:1px solid #1e2235;border-radius:8px;color:#e2e8f0;font-size:0.82rem;padding:7px 10px;outline:none" />
        <button onclick="removeCharRow(${idx})"
          style="background:none;border:none;color:#ef4444;font-size:1.1rem;cursor:pointer;padding:0;line-height:1;text-align:center">√ó</button>
      `;
      container.appendChild(div);
    });
  }

  function addCharRow() {
    if (currentCharRows.length >= 5) { showToast('–ú–∞–∫—Å–∏–º—É–º 5 —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫', 'warning'); return; }
    currentCharRows.push({ key: '', val: '' });
    renderCharRows();
    // Focus last key input
    const inputs = document.getElementById('am-char-rows')?.querySelectorAll('input');
    if (inputs?.length) inputs[inputs.length - 2].focus();
  }

  function removeCharRow(idx) {
    currentCharRows.splice(idx, 1);
    renderCharRows();
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  //  Modal extras get/set/reset
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function getModalExtras() {
    return {
      nameUz:   (document.getElementById('am-name-uz')?.value   || '').trim(),
      nameRu:   (document.getElementById('am-name-ru')?.value   || '').trim(),
      descUz:   (document.getElementById('am-desc-uz')?.value   || '').trim(),
      descRu:   (document.getElementById('am-desc-ru')?.value   || '').trim(),
      fullDesc: (document.getElementById('am-full-desc')?.value || '').trim(),
      chars:    currentCharRows.filter(r => r.key || r.val).map(r => ({ key: r.key, val: r.val }))
    };
  }

  function fillModalExtras(extras) {
    const set = (id, val) => { const el = document.getElementById(id); if (el) el.value = val || ''; };
    set('am-name-uz',   extras.nameUz   || '');
    set('am-name-ru',   extras.nameRu   || '');
    set('am-desc-uz',   extras.descUz   || '');
    set('am-desc-ru',   extras.descRu   || '');
    set('am-full-desc', extras.fullDesc || '');
    // Update char counters
    ['am-name-uz','am-name-ru','am-desc-uz','am-desc-ru'].forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      const map = { 'am-name-uz':'am-cnt-nameuz','am-name-ru':'am-cnt-nameru','am-desc-uz':'am-cnt-descuz','am-desc-ru':'am-cnt-descru' };
      const max = id.includes('name') ? 90 : 390;
      updateCharCount(el, map[id], max);
    });
    currentCharRows = Array.isArray(extras.chars) ? extras.chars.map(c => ({ key: c.key||'', val: c.val||'' })) : [];
    renderCharRows();
  }

  function resetModalExtras() {
    fillModalExtras({});
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  //  Unified Settings Modal
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let _settingsTab = 'cats';

  function openSettings(tab) {
    _settingsTab = tab || 'cats';
    switchSettingsTab(_settingsTab);
    document.getElementById('settingsModal').classList.add('open');
  }

  function closeSettings() {
    document.getElementById('settingsModal').classList.remove('open');
    populateCategoryDropdown();
    populateCountryDropdown();
    populateSupplierDropdown();
    populateFilterDropdowns();
    renderSizeChips();
  }

  function switchSettingsTab(tab) {
    _settingsTab = tab;
    ['cats','countries','sizes','suppliers','tg','alerts'].forEach(t => {
      document.getElementById('stab-' + t)?.classList.toggle('active', t === tab);
      const p = document.getElementById('spanel-' + t);
      if (p) p.style.display = t === tab ? '' : 'none';
    });
    if (tab === 'cats')      renderSettingsCats();
    if (tab === 'countries') renderSettingsCountries();
    if (tab === 'sizes')     renderSettingsSizes();
    if (tab === 'suppliers') renderSettingsSuppliers();
  }

  // ‚îÄ‚îÄ Categories ‚îÄ‚îÄ
  function renderSettingsCats() {
    const ul = document.getElementById('set-cat-list');
    if (!ul) return;
    if (!categories.length) {
      ul.innerHTML = '<li class="settings-empty">–ù–µ—Ç –∫–∞—Ç–µ–≥–æ—Ä–∏–π</li>';
      return;
    }
    ul.innerHTML = categories.map((c, i) => `
      <li class="settings-list-item">
        <span class="settings-list-name">${escH(c)}</span>
        <button class="settings-list-del" onclick="settingsDelCat(${i})" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
      </li>`).join('');
  }

  function settingsAddCat() {
    const inp = document.getElementById('set-cat-input');
    const val = (inp?.value || '').trim();
    if (!val) return;
    if (categories.includes(val)) { showToast('–¢–∞–∫–∞—è –∫–∞—Ç–µ–≥–æ—Ä–∏—è —É–∂–µ –µ—Å—Ç—å', 'warning'); return; }
    categories.push(val);
    inp.value = '';
    renderSettingsCats();
    scheduleSave();
  }

  function settingsDelCat(idx) {
    showConfirm(`–£–¥–∞–ª–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é ¬´${categories[idx]}¬ª?`, () => {
      categories.splice(idx, 1);
      renderSettingsCats();
      scheduleSave();
    });
  }

  // ‚îÄ‚îÄ Countries ‚îÄ‚îÄ
  function renderSettingsCountries() {
    const ul = document.getElementById('set-country-list');
    if (!ul) return;
    if (!countries.length) {
      ul.innerHTML = '<li class="settings-empty">–ù–µ—Ç —Å—Ç—Ä–∞–Ω</li>';
      return;
    }
    ul.innerHTML = countries.map((c, i) => `
      <li class="settings-list-item">
        <span class="settings-list-name">${escH(c)}</span>
        <button class="settings-list-del" onclick="settingsDelCountry(${i})" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
      </li>`).join('');
  }

  function settingsAddCountry() {
    const inp = document.getElementById('set-country-input');
    const val = (inp?.value || '').trim();
    if (!val) return;
    if (countries.includes(val)) { showToast('–¢–∞–∫–∞—è —Å—Ç—Ä–∞–Ω–∞ —É–∂–µ –µ—Å—Ç—å', 'warning'); return; }
    countries.push(val);
    inp.value = '';
    renderSettingsCountries();
    scheduleSave();
  }

  function settingsDelCountry(idx) {
    showConfirm(`–£–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–∞–Ω—É ¬´${countries[idx]}¬ª?`, () => {
      countries.splice(idx, 1);
      renderSettingsCountries();
      scheduleSave();
    });
  }

  // ‚îÄ‚îÄ Sizes ‚îÄ‚îÄ
  function renderSettingsSizes() {
    const ul = document.getElementById('set-size-list');
    if (!ul) return;
    if (!sizeOptions.length) {
      ul.innerHTML = '<li class="settings-empty">–ù–µ—Ç —Ä–∞–∑–º–µ—Ä–æ–≤</li>';
      return;
    }
    ul.innerHTML = sizeOptions.map((s, i) => `
      <li class="settings-list-item">
        <span class="settings-list-name">${escH(s)}</span>
        <button class="settings-list-del" onclick="settingsDelSize(${i})" title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
      </li>`).join('');
  }

  function settingsAddSize() {
    const inp = document.getElementById('set-size-input');
    const val = (inp?.value || '').trim();
    if (!val) return;
    if (sizeOptions.includes(val)) { showToast('–¢–∞–∫–æ–π —Ä–∞–∑–º–µ—Ä —É–∂–µ –µ—Å—Ç—å', 'warning'); return; }
    sizeOptions.push(val);
    inp.value = '';
    renderSettingsSizes();
    renderSizeChips();
    scheduleSave();
  }

  function settingsDelSize(idx) {
    const s = sizeOptions[idx];
    showConfirm(`–£–¥–∞–ª–∏—Ç—å —Ä–∞–∑–º–µ—Ä ¬´${s}¬ª?`, () => {
      sizeOptions = sizeOptions.filter(x => x !== s);
      selectedSizes = selectedSizes.filter(x => x !== s);
      renderSettingsSizes();
      renderSizeChips();
      scheduleSave();
    });
  }

  // ‚îÄ‚îÄ Dropdown helpers ‚îÄ‚îÄ
  function populateCategoryDropdown() {
    const sel = document.getElementById('am-category');
    if (!sel) return;
    const current = sel.value;
    sel.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é ‚Äî</option>';
    categories.forEach(cat => {
      const opt = document.createElement('option');
      opt.value = cat; opt.textContent = cat;
      sel.appendChild(opt);
    });
    sel.value = categories.includes(current) ? current : '';
  }

  function populateCountryDropdown() {
    const sel = document.getElementById('am-country');
    if (!sel) return;
    const current = sel.value;
    sel.innerHTML = '<option value="">‚Äî –í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç—Ä–∞–Ω—É ‚Äî</option>';
    countries.forEach(c => {
      const opt = document.createElement('option');
      opt.value = c; opt.textContent = c;
      sel.appendChild(opt);
    });
    sel.value = countries.includes(current) ? current : '';
  }

  // backward-compat stub (catMgmtModal no longer exists)
  function openCatMgmt() { openSettings('cats'); }
  function closeCatMgmt() { closeSettings(); }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  //  Suppliers (settings tab)
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let suppliers = []; // [{ name, contact, country }]

  function toggleMessengerChip(btn) {
    btn.classList.toggle('selected');
  }

  function getSelectedMessengers() {
    return [...document.querySelectorAll('#sup-messengers .messenger-chip.selected')]
      .map(b => b.getAttribute('data-val'));
  }

  function resetMessengerChips() {
    document.querySelectorAll('#sup-messengers .messenger-chip').forEach(b => b.classList.remove('selected'));
  }

  function populateSupplierCountrySelect() {
    const sel = document.getElementById('set-sup-country');
    if (!sel) return;
    const cur = sel.value;
    sel.innerHTML = '<option value="">‚Äî –°—Ç—Ä–∞–Ω–∞ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ ‚Äî</option>';
    countries.forEach(c => {
      const o = document.createElement('option');
      o.value = c; o.textContent = c;
      sel.appendChild(o);
    });
    sel.value = countries.includes(cur) ? cur : '';
  }

  const MESSENGER_ICONS = { Telegram:'‚úà', WhatsApp:'üí¨', IMO:'üì±', WeChat:'üü¢', Instagram:'üì∏' };

  function renderSettingsSuppliers() {
    populateSupplierCountrySelect();
    const ul = document.getElementById('set-supplier-list');
    if (!ul) return;
    if (!suppliers.length) {
      ul.innerHTML = '<li class="settings-empty">–ù–µ—Ç –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤</li>';
      return;
    }
    ul.innerHTML = suppliers.map((s, i) => {
      const messengers = Array.isArray(s.messengers) && s.messengers.length
        ? s.messengers.map(m => `<span style="font-size:0.72rem;background:rgba(99,102,241,0.1);color:#818cf8;border-radius:10px;padding:2px 8px">${MESSENGER_ICONS[m]||''} ${escH(m)}</span>`).join('')
        : '';
      return `
      <li class="settings-list-item" style="flex-direction:column;align-items:flex-start;gap:4px">
        <div style="display:flex;align-items:center;justify-content:space-between;width:100%">
          <span class="settings-list-name" style="font-weight:700">${escH(s.name)}</span>
          <button class="settings-list-del" onclick="settingsDelSupplier(${i})">√ó</button>
        </div>
        ${s.contact ? `<span style="font-size:0.78rem;color:#94a3b8">üìû ${escH(s.contact)}</span>` : ''}
        ${messengers ? `<div style="display:flex;gap:4px;flex-wrap:wrap;margin-top:2px">${messengers}</div>` : ''}
        ${s.country ? `<span style="font-size:0.72rem;color:#6366f1">üåç ${escH(s.country)}</span>` : ''}
      </li>`;
    }).join('');
  }

  function settingsAddSupplier() {
    const name      = (document.getElementById('set-sup-name')?.value    || '').trim();
    const contact   = (document.getElementById('set-sup-contact')?.value || '').trim();
    const country   = (document.getElementById('set-sup-country')?.value || '').trim();
    const messengers = getSelectedMessengers();
    if (!name) { showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞', 'warning'); return; }
    suppliers.push({ name, contact, country, messengers });
    document.getElementById('set-sup-name').value    = '';
    document.getElementById('set-sup-contact').value = '';
    document.getElementById('set-sup-country').value = '';
    resetMessengerChips();
    renderSettingsSuppliers();
    scheduleSave();
  }

  function settingsDelSupplier(idx) {
    showConfirm(`–£–¥–∞–ª–∏—Ç—å –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ ¬´${suppliers[idx]?.name}¬ª?`, () => {
      suppliers.splice(idx, 1);
      renderSettingsSuppliers();
      scheduleSave();
    });
  }

  function populateSupplierDropdown() {
    const sel = document.getElementById('am-supplier');
    if (!sel) return;
    const cur = sel.value;
    sel.innerHTML = '<option value="">‚Äî –ë–µ–∑ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ ‚Äî</option>';
    suppliers.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.name; opt.textContent = s.name + (s.country ? ` (${s.country})` : '');
      sel.appendChild(opt);
    });
    sel.value = suppliers.some(s => s.name === cur) ? cur : '';
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  //  Filter by category / country
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function populateFilterDropdowns() {
    const selCat = document.getElementById('filterCat');
    const selCtry = document.getElementById('filterCountry');
    if (selCat) {
      const cur = selCat.value;
      selCat.innerHTML = '<option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>';
      categories.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; selCat.appendChild(o); });
      selCat.value = categories.includes(cur) ? cur : '';
    }
    if (selCtry) {
      const cur = selCtry.value;
      selCtry.innerHTML = '<option value="">–í—Å–µ —Å—Ç—Ä–∞–Ω—ã</option>';
      countries.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; selCtry.appendChild(o); });
      selCtry.value = countries.includes(cur) ? cur : '';
    }
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  //  PDF export (print-based)
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function exportPDF() {
    if (rows.length === 0) { showToast('–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning'); return; }
    const totalLog = parseFloat(document.getElementById('totalLogistics')?.value) || 0;
    const commPct  = parseFloat(document.getElementById('commission')?.value)     || 0;
    const mktUnit  = parseFloat(document.getElementById('marketing')?.value)      || 0;

    const tableRows = rows.map(id => {
      const tr     = document.getElementById('row-' + id);
      const code   = document.getElementById('code-' + id)?.value || '';
      const name   = document.getElementById('name-' + id)?.value || '';
      const usd    = parseFloat(document.getElementById('usd-' + id)?.value)  || 0;
      const qty    = parseInt(document.getElementById('qty-' + id)?.value)    || 6;
      const priceEl = document.getElementById('price-' + id);
      const profEl  = document.getElementById('profit-' + id);
      const price  = priceEl?.querySelector('span')?.textContent || priceEl?.textContent || '‚Äî';
      const profit = profEl?.firstChild?.textContent || profEl?.textContent || '‚Äî';
      const cat    = tr?.getAttribute('data-category') || '';
      const country= tr?.getAttribute('data-country')  || '';
      const abc    = document.getElementById('abc-' + id)?.textContent || '';
      return `<tr>
        <td>${escH(code)}</td>
        <td>${escH(name)}</td>
        <td>${escH(cat)}</td>
        <td>$${usd}</td>
        <td>${qty}</td>
        <td>${price}</td>
        <td style="color:${profit.includes('-') ? '#ef4444' : '#22c55e'};font-weight:600">${profit}</td>
        <td><span style="font-weight:800;color:${abc==='A'?'#22c55e':abc==='B'?'#f59e0b':'#ef4444'}">${abc}</span></td>
      </tr>`;
    }).join('');

    const html = `<!DOCTYPE html><html><head><meta charset="UTF-8">
    <title>–û—Ç—á—ë—Ç –ø–∞—Ä—Ç–∏–∏ ‚Äî ${new Date().toLocaleDateString('ru-RU')}</title>
    <style>
      body{font-family:system-ui,sans-serif;padding:24px;color:#1e293b;font-size:13px}
      h1{font-size:1.3rem;font-weight:800;margin-bottom:4px}
      .meta{color:#64748b;font-size:0.8rem;margin-bottom:20px}
      .kpi{display:flex;gap:16px;margin-bottom:24px;flex-wrap:wrap}
      .kpi-item{background:#f8fafc;border:1px solid #e2e8f0;border-radius:8px;padding:10px 16px;min-width:120px}
      .kpi-label{font-size:0.72rem;color:#64748b;text-transform:uppercase;letter-spacing:.05em}
      .kpi-val{font-size:1.1rem;font-weight:700;margin-top:2px}
      table{width:100%;border-collapse:collapse;font-size:12px}
      th{background:#f1f5f9;padding:8px 10px;text-align:left;font-weight:600;font-size:0.72rem;text-transform:uppercase;letter-spacing:.04em;color:#64748b}
      td{padding:8px 10px;border-bottom:1px solid #f1f5f9}
      tr:hover td{background:#f8fafc}
      @media print{body{padding:0}}
    </style></head><body>
    <h1>–û—Ç—á—ë—Ç –ø–∞—Ä—Ç–∏–∏ —Ç–æ–≤–∞—Ä–æ–≤</h1>
    <div class="meta">–°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω: ${new Date().toLocaleString('ru-RU')} ¬∑ –õ–æ–≥–∏—Å—Ç–∏–∫–∞: ${totalLog.toLocaleString('ru')} —Å—É–º ¬∑ –ö–æ–º–∏—Å—Å–∏—è: ${commPct}% ¬∑ –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥: ${mktUnit.toLocaleString('ru')} —Å—É–º</div>
    <table>
      <thead><tr><th>–ö–æ–¥</th><th>–ù–∞–∑–≤–∞–Ω–∏–µ</th><th>–ö–∞—Ç–µ–≥–æ—Ä–∏—è</th><th>USD</th><th>–ö–æ–ª-–≤–æ</th><th>–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏</th><th>–ü—Ä–∏–±—ã–ª—å/—é–Ω–∏—Ç</th><th>ABC</th></tr></thead>
      <tbody>${tableRows}</tbody>
    </table>
    <script>window.onload=()=>window.print()<\/script>
    </body></html>`;

    const w = window.open('', '_blank');
    if (w) { w.document.write(html); w.document.close(); }
    else showToast('–†–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –¥–ª—è PDF', 'warning');
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  //  Batch Snapshots & Compare
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let _snapshots = []; // loaded from Firestore

  function saveBatchSnapshot() {
    if (!db) { showToast('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö', 'error'); return; }
    if (rows.length === 0) { showToast('–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–Ω–∏–º–∫–∞', 'warning'); return; }
    const snap = {
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      label: new Date().toLocaleString('ru-RU', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' }),
      rows: rows.map(id => {
        const tr = document.getElementById('row-' + id);
        return {
          code:   document.getElementById('code-' + id)?.value || '',
          name:   document.getElementById('name-' + id)?.value || '',
          usd:    parseFloat(document.getElementById('usd-' + id)?.value)  || 0,
          qty:    parseInt(document.getElementById('qty-' + id)?.value)    || 6,
          margin: parseInt(tr?.getAttribute('data-margin')) || 30,
          category: tr?.getAttribute('data-category') || '',
          priceText: document.getElementById('price-' + id)?.querySelector('span')?.textContent || '‚Äî',
          profitText: document.getElementById('profit-' + id)?.firstChild?.textContent || '‚Äî'
        };
      })
    };
    col('snapshots').add(snap)
      .then(() => showToast('–°–Ω–∏–º–æ–∫ –ø–∞—Ä—Ç–∏–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω', 'success'))
      .catch(e => showToast('–û—à–∏–±–∫–∞: ' + e.message, 'error'));
  }

  function openSnapshotsModal() {
    if (!db) { showToast('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö', 'error'); return; }
    document.getElementById('snapshotsModal').classList.add('open');
    loadSnapshotsList();
  }

  function closeSnapshotsModal() {
    document.getElementById('snapshotsModal').classList.remove('open');
  }

  function loadSnapshotsList() {
    const selA = document.getElementById('snapSelA');
    const selB = document.getElementById('snapSelB');
    if (!selA || !selB) return;
    selA.innerHTML = '<option value="">‚Äî –ó–∞–≥—Ä—É–∑–∫–∞... ‚Äî</option>';
    selB.innerHTML = '<option value="">‚Äî –¢–µ–∫—É—â–∏–π ‚Äî</option>';
    col('snapshots').orderBy('createdAt','desc').limit(20).get()
      .then(snap => {
        _snapshots = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        selA.innerHTML = '<option value="">‚Äî –°–Ω–∏–º–æ–∫ A ‚Äî</option>';
        _snapshots.forEach(s => {
          const la = document.createElement('option'); la.value = s.id; la.textContent = s.label || s.id;
          selA.appendChild(la);
          const lb = la.cloneNode(true);
          selB.appendChild(lb);
        });
      })
      .catch(e => { selA.innerHTML = `<option>–û—à–∏–±–∫–∞: ${e.message}</option>`; });
  }

  function runSnapshotCompare() {
    const idA = document.getElementById('snapSelA')?.value;
    const idB = document.getElementById('snapSelB')?.value;
    const container = document.getElementById('snapCompareResult');
    if (!container) return;
    if (!idA) { container.innerHTML = '<div style="color:#ef4444;padding:12px">–í—ã–±–µ—Ä–∏—Ç–µ —Å–Ω–∏–º–æ–∫ A</div>'; return; }

    const snapA = _snapshots.find(s => s.id === idA);
    const snapB = idB ? _snapshots.find(s => s.id === idB) : null;

    // Current state as "B" if no snapshot B selected
    const rowsB = snapB ? snapB.rows : rows.map(id => {
      const tr = document.getElementById('row-' + id);
      return {
        code:  document.getElementById('code-' + id)?.value || '',
        name:  document.getElementById('name-' + id)?.value || '',
        usd:   parseFloat(document.getElementById('usd-' + id)?.value) || 0,
        qty:   parseInt(document.getElementById('qty-' + id)?.value) || 6,
        priceText: document.getElementById('price-' + id)?.querySelector('span')?.textContent || '‚Äî',
        profitText: document.getElementById('profit-' + id)?.firstChild?.textContent || '‚Äî'
      };
    });
    const labelB = snapB ? (snapB.label || '–°–Ω–∏–º–æ–∫ B') : '–¢–µ–∫—É—â–∏–π';

    // Build map by code for comparison
    const mapA = {}; (snapA?.rows || []).forEach(r => { mapA[r.code || r.name] = r; });
    const mapB = {}; rowsB.forEach(r => { mapB[r.code || r.name] = r; });
    const allKeys = [...new Set([...Object.keys(mapA), ...Object.keys(mapB)])].sort();

    const rows2 = allKeys.map(key => {
      const a = mapA[key]; const b = mapB[key];
      if (!a) return `<tr style="background:rgba(34,197,94,0.06)"><td>${escH(key)}</td><td colspan="3" style="color:#22c55e">–î–æ–±–∞–≤–ª–µ–Ω</td><td>$${b.usd}</td><td>${b.priceText}</td></tr>`;
      if (!b) return `<tr style="background:rgba(239,68,68,0.06)"><td>${escH(key)}</td><td colspan="3" style="color:#ef4444">–£–¥–∞–ª—ë–Ω</td><td>$${a.usd}</td><td>${a.priceText}</td></tr>`;
      const usdDiff = (b.usd - a.usd).toFixed(2);
      const sign = parseFloat(usdDiff) >= 0 ? '+' : '';
      const changed = a.usd !== b.usd;
      return `<tr style="${changed?'background:rgba(99,102,241,0.05)':''}">
        <td>${escH(key)}</td>
        <td>${a.name !== b.name ? `<span style="color:#ef4444">${escH(a.name)}</span> ‚Üí <span style="color:#22c55e">${escH(b.name)}</span>` : escH(a.name)}</td>
        <td>$${a.usd}${changed ? ` ‚Üí <b>$${b.usd}</b> <span style="color:${parseFloat(usdDiff)>=0?'#22c55e':'#ef4444'}">(${sign}${usdDiff})</span>` : ''}</td>
        <td>${a.priceText} ‚Üí ${b.priceText}</td>
        <td>${a.profitText} ‚Üí ${b.profitText}</td>
      </tr>`;
    }).join('');

    container.innerHTML = `
      <div style="margin-bottom:12px;font-size:0.78rem;color:#4f5a7a">
        <b style="color:#e2e8f0">${snapA?.label || 'A'}</b> ‚Üí <b style="color:#e2e8f0">${labelB}</b>
      </div>
      <table style="width:100%;border-collapse:collapse;font-size:0.8rem">
        <thead><tr style="border-bottom:1px solid #1e2235">
          <th style="text-align:left;padding:6px 8px;color:#4f5a7a;font-weight:600">–ö–æ–¥</th>
          <th style="text-align:left;padding:6px 8px;color:#4f5a7a;font-weight:600">–ù–∞–∑–≤–∞–Ω–∏–µ</th>
          <th style="text-align:left;padding:6px 8px;color:#4f5a7a;font-weight:600">–¶–µ–Ω–∞ USD</th>
          <th style="text-align:left;padding:6px 8px;color:#4f5a7a;font-weight:600">–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏</th>
          <th style="text-align:left;padding:6px 8px;color:#4f5a7a;font-weight:600">–ü—Ä–∏–±—ã–ª—å</th>
        </tr></thead>
        <tbody>${rows2}</tbody>
      </table>`;
  }

  function submitAddModal() {
    const code = document.getElementById('am-code').value.trim();
    const name = document.getElementById('am-name').value.trim();
    const usd  = parseFloat(document.getElementById('am-usd').value) || 0;
    const qty  = parseInt(document.getElementById('am-qty').value)   || 6;
    if (!name && !code) {
      document.getElementById('am-name').focus();
      document.getElementById('am-name').style.borderColor = '#ef4444';
      setTimeout(() => document.getElementById('am-name').style.borderColor = '', 1200);
      return;
    }
    // price is optional ‚Äî skip validation
    const rate      = parseFloat(document.getElementById('am-rate').value)      || defaultRate;
    const margin    = currentModalMargin || 30;
    const logistics = parseFloat(document.getElementById('am-logistics').value) || 0;
    const category  = (document.getElementById('am-category')?.value  || '').trim();
    const country   = (document.getElementById('am-country')?.value   || '').trim();
    const supplier  = (document.getElementById('am-supplier')?.value  || '').trim();
    const extras    = getModalExtras();
    defaultRate = rate; // remember for next new product
    if (editingRowId !== null) {
      updateRow(editingRowId, { code, name, usd, qty, sizes: [...selectedSizes], photo: currentPhoto, margin, rate, logistics, category, country, supplier, extras });
    } else if (selectedSizes.length > 1) {
      const ids = selectedSizes.map(sz =>
        addRow({ code, name, usd, qty, sizes: [sz], photo: currentPhoto, margin, rate, logistics, category, country, supplier, extras })
      );
      createShipment(ids, rate);
    } else {
      const id = addRow({ code, name, usd, qty, sizes: [...selectedSizes], photo: currentPhoto, margin, rate, logistics, category, country, supplier, extras });
      createShipment([id], rate);
    }
    closeAddModal();
  }

  function updateRow(id, data) {
    const tr = document.getElementById('row-' + id);
    if (!tr) return;
    // Photo
    tr.querySelector('.row-photo-cell').innerHTML = data.photo
      ? `<img class="row-thumb" src="${data.photo}" alt="" onclick="openLightbox(this.src)" title="–ù–∞–∂–º–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞" />`
      : `<div class="row-thumb-empty">üì¶</div>`;
    // Code
    const codeEl = document.getElementById('code-' + id);
    if (codeEl) codeEl.value = data.code || '';
    // Name
    const nameEl = document.getElementById('name-' + id);
    if (nameEl) nameEl.value = data.name || '';
    // Sizes
    const sizesArr2 = Array.isArray(data.sizes) ? data.sizes : (data.size ? [data.size] : []);
    const sizeCell = tr.querySelector('.row-size-cell');
    sizeCell.setAttribute('data-sizes', sizesArr2.join(','));
    sizeCell.innerHTML = sizesArr2.length > 0
      ? sizesArr2.map(s => `<span class="size-badge">${escH(s)}</span>`).join(' ')
      : `<span style="color:#2d3455;font-size:0.75rem">‚Äî</span>`;
    // USD ‚Äî log price change to Firestore
    const usdEl = document.getElementById('usd-' + id);
    const oldUsd = parseFloat(usdEl?.value) || 0;
    const newUsd = parseFloat(data.usd) || 0;
    if (db && oldUsd > 0 && newUsd > 0 && oldUsd !== newUsd) {
      col('price_history').add({
        rowId: id,
        code: data.code || document.getElementById('code-' + id)?.value || '',
        name: data.name || '',
        oldUsd, newUsd,
        changedAt: firebase.firestore.FieldValue.serverTimestamp()
      }).catch(e => console.warn('price_history write:', e));
    }
    if (usdEl) usdEl.value = data.usd || '';
    // Qty
    const qtyEl = document.getElementById('qty-' + id);
    if (qtyEl) qtyEl.value = data.qty || 6;
    // Margin
    const rowM = data.margin ?? 30;
    tr.setAttribute('data-margin', rowM);
    const mtagEl = document.getElementById('mtag-' + id);
    if (mtagEl) mtagEl.textContent = rowM + '%';
    // Rate
    const rowR = data.rate ?? defaultRate;
    tr.setAttribute('data-rate', rowR);
    // Logistics
    const rowL = data.logistics ?? 0;
    tr.setAttribute('data-logistics', rowL);
    // Category + Country + Supplier
    setRowCategory(id, data.category || '');
    const rowTr = document.getElementById('row-' + id);
    if (rowTr) rowTr.setAttribute('data-country',  data.country  || '');
    if (rowTr) rowTr.setAttribute('data-supplier', data.supplier || '');
    // Extras
    if (data.extras !== undefined) productExtras[id] = { ...data.extras };
    recalc();
  }

  // ‚îÄ‚îÄ Photo upload ‚îÄ‚îÄ
  function handlePhotoSelect(event) {
    const file = event.target.files[0];
    if (!file) return;
    loadPhoto(file);
  }

  function loadPhoto(file) {
    if (!file.type.startsWith('image/')) return;
    if (file.size > 10 * 1024 * 1024) { showToast('–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å. 10 –ú–ë)', 'warning'); return; }
    const reader = new FileReader();
    reader.onload = e => {
      const originalDataUrl = e.target.result;
      compressImage(originalDataUrl, compressed => {
        currentPhoto = compressed;
        document.getElementById('photoPreviewImg').src = compressed;
        document.getElementById('photoPreview').style.display = 'block';
        document.getElementById('photoPlaceholder').style.display = 'none';
      });
      // Extract product data from image via Claude Vision
      extractFromPhoto(originalDataUrl, file.type);
    };
    reader.readAsDataURL(file);
  }

  async function extractFromPhoto(dataUrl, mimeType) {
    const base64 = dataUrl.split(',')[1];
    const hint = document.getElementById('photoPlaceholder');
    const prevHintHtml = hint ? hint.innerHTML : '';
    if (hint) hint.innerHTML = '<div style="color:#818cf8;font-size:0.8rem">‚è≥ –ß–∏—Ç–∞—é –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–æ—Ç–æ...</div>';

    try {
      const resp = await fetch('/api/claude-proxy', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({
          model: 'claude-opus-4-6',
          max_tokens: 2048,
          messages: [{
            role: 'user',
            content: [
              { type: 'image', source: { type: 'base64', media_type: mimeType || 'image/jpeg', data: base64 } },
              { type: 'text', text: 'This is a supplier invoice or product label. Extract ALL product line items. Return ONLY a valid JSON array (no markdown): [{"code":"SKU/article","name":"product name","usd":price_as_number,"qty":quantity_as_number}]. If it is a single product label, return array with one element.' }
            ]
          }]
        })
      });
      if (!resp.ok) return;
      const data = await resp.json();
      const text = data.content?.[0]?.text || '';
      let products = null;
      try { products = JSON.parse(text); } catch {
        const m = text.match(/\[[\s\S]*\]/);
        if (m) try { products = JSON.parse(m[0]); } catch { /* ignore */ }
      }
      if (!Array.isArray(products) || products.length === 0) return;

      if (products.length === 1) {
        // Single product ‚Äî fill form fields
        const p = products[0];
        const codeEl = document.getElementById('am-code');
        const nameEl = document.getElementById('am-name');
        const usdEl  = document.getElementById('am-usd');
        let filled = [];
        if (codeEl && !codeEl.value && p.code) { codeEl.value = p.code; filled.push('–∞—Ä—Ç–∏–∫—É–ª'); }
        if (nameEl && !nameEl.value && p.name) { nameEl.value = p.name; filled.push('–Ω–∞–∑–≤–∞–Ω–∏–µ'); }
        if (usdEl  && (!usdEl.value || usdEl.value === '0') && p.usd > 0) { usdEl.value = p.usd; filled.push('—Ü–µ–Ω—É'); }
        if (filled.length) showToast('–ò–∑ —Ñ–æ—Ç–æ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ: ' + filled.join(', '), 'success', 3000);
      } else {
        // Multiple products ‚Äî close add modal, open bulk import with pre-filled data
        document.getElementById('addModalOverlay')?.classList.remove('open');
        // openImportModal resets everything + populates dropdowns + opens modal
        openImportModal();
        // Re-inject photo (openImportModal clears it)
        importPhotoBase64 = base64;
        importPhotoMime   = mimeType || 'image/jpeg';
        document.getElementById('importPreview').src = dataUrl;
        document.getElementById('importDropZone').style.display = 'none';
        document.getElementById('importPreviewWrap').style.display = 'block';
        // Pre-populate extracted products
        parsedImportProducts = products.map(p => ({
          ...p, selectedSizes: sizeOptions.slice(0, Math.max(1, +p.qty || 1))
        }));
        // Render product list
        const listEl = document.getElementById('importProductsList');
        if (listEl) {
          listEl.innerHTML = parsedImportProducts.map((p, idx) => {
            const chips = sizeOptions.map(sz => {
              const on = p.selectedSizes.includes(sz);
              return `<button class="imp-size-chip${on?' active':''}" onclick="toggleImportSize(${idx},'${sz}',this)">${sz}</button>`;
            }).join('');
            return `<div class="import-product-item">
              <div class="ipi-row">
                <span class="ipi-code">${_escHtml(p.code||'‚Äî')}</span>
                <span class="ipi-name">${_escHtml(p.name||'‚Äî')}</span>
                <span class="ipi-price">$${(+p.usd||0).toFixed(2)}</span>
              </div>
              <div class="ipi-sizes">${chips}</div>
            </div>`;
          }).join('');
          document.getElementById('importProductCount').textContent = products.length;
          document.getElementById('importProductsWrap').style.display = '';
        }
        setImportStatus('success', '‚úì –ù–∞–π–¥–µ–Ω–æ ' + products.length + ' –ø–æ–∑–∏—Ü–∏–π. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–ø–∏—Å–æ–∫ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–î–æ–±–∞–≤–∏—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É¬ª.');
        const btn = document.getElementById('importRunBtn');
        if (btn) { btn.textContent = '‚úÖ –î–æ–±–∞–≤–∏—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É'; btn.onclick = confirmImport; btn.disabled = false; }
        showToast('–ù–∞–π–¥–µ–Ω–æ ' + products.length + ' —Ç–æ–≤–∞—Ä–æ–≤ ‚Äî –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –∏ –¥–æ–±–∞–≤—å—Ç–µ', 'success', 4000);
      }
    } catch { /* silent fail */ } finally {
      if (hint && prevHintHtml) hint.innerHTML = prevHintHtml;
    }
  }

  function compressImage(dataUrl, cb) {
    const img = new Image();
    img.onload = () => {
      const MAX = 400;
      let w = img.width, h = img.height;
      if (w > MAX || h > MAX) {
        if (w >= h) { h = Math.round(h * MAX / w); w = MAX; }
        else        { w = Math.round(w * MAX / h); h = MAX; }
      }
      const c = document.createElement('canvas');
      c.width = w; c.height = h;
      c.getContext('2d').drawImage(img, 0, 0, w, h);
      cb(c.toDataURL('image/jpeg', 0.72));
    };
    img.src = dataUrl;
  }

  function removePhoto(e, silent) {
    if (e) e.stopPropagation();
    currentPhoto = null;
    document.getElementById('photoPreviewImg').src = '';
    document.getElementById('photoPreview').style.display = 'none';
    document.getElementById('photoPlaceholder').style.display = '';
    if (!silent) document.getElementById('photoFileInput').value = '';
  }

  // Drag & drop
  const dropZone = document.getElementById('photoDropZone');
  dropZone.addEventListener('dragover',  e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
  dropZone.addEventListener('dragleave', () => dropZone.classList.remove('drag-over'));
  dropZone.addEventListener('drop', e => {
    e.preventDefault(); dropZone.classList.remove('drag-over');
    const file = e.dataTransfer.files[0];
    if (file) loadPhoto(file);
  });

  // ‚îÄ‚îÄ Size chips ‚îÄ‚îÄ
  function renderSizeChips() {
    const container = document.getElementById('sizeChipsContainer');
    if (!container) return;

    container.className = 'size-chips';
    container.innerHTML = sizeOptions.map(s => `
      <button class="size-chip ${selectedSizes.includes(s) ? 'selected' : ''}"
        onclick="selectSize('${escH(s)}')">
        ${escH(s)}
      </button>
    `).join('');

    // Show selected count hint
    const hint = document.getElementById('sizeSelHint');
    if (hint) {
      if (selectedSizes.length === 0) {
        hint.style.color = '#4f5a7a';
        hint.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑–º–µ—Ä–æ–≤';
      } else if (selectedSizes.length === 1) {
        hint.style.color = '#4f5a7a';
        hint.textContent = `–í—ã–±—Ä–∞–Ω: ${selectedSizes[0]}`;
      } else {
        hint.style.color = '#22c55e';
        hint.textContent = `–í—ã–±—Ä–∞–Ω–æ ${selectedSizes.length} —Ä–∞–∑–º. ‚Äî —Å–æ–∑–¥–∞—Å—Ç—Å—è ${selectedSizes.length} —Å—Ç—Ä–æ–∫–∏ –≤ —Ç–∞–±–ª–∏—Ü–µ`;
      }
    }

    // Select-all / clear button
    const selAllBtn = document.getElementById('sizeSelAllBtn');
    if (selAllBtn) {
      const allSelected = sizeOptions.length > 0 && sizeOptions.every(s => selectedSizes.includes(s));
      selAllBtn.textContent = allSelected ? '–°–Ω—è—Ç—å –≤—Å–µ' : '–í—ã–±—Ä–∞—Ç—å –≤—Å–µ';
    }
  }

  function selectSize(s) {
    const idx = selectedSizes.indexOf(s);
    if (idx === -1) selectedSizes.push(s);
    else selectedSizes.splice(idx, 1);
    renderSizeChips();
  }

  function selectAllSizes() {
    const allSelected = sizeOptions.every(s => selectedSizes.includes(s));
    selectedSizes = allSelected ? [] : [...sizeOptions];
    renderSizeChips();
  }

  function removeSize(s) {
    // called from old references; now handled via settings panel
    settingsDelSize(sizeOptions.indexOf(s));
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  //  Multi-select
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let selectedRows = new Set();

  function toggleRowSelect(id) {
    const cb = document.getElementById('check-' + id);
    const tr = document.getElementById('row-' + id);
    if (!cb) return;
    if (cb.checked) { selectedRows.add(id); tr.classList.add('row-selected'); }
    else            { selectedRows.delete(id); tr.classList.remove('row-selected'); }
    updateSelBar();
    syncHeaderCheck();
  }

  function toggleSelectAll() {
    const allCb = document.getElementById('selectAllCheck');
    rows.forEach(id => {
      const cb = document.getElementById('check-' + id);
      const tr = document.getElementById('row-' + id);
      if (!cb) return;
      cb.checked = allCb.checked;
      if (allCb.checked) { selectedRows.add(id); tr.classList.add('row-selected'); }
      else               { selectedRows.delete(id); tr.classList.remove('row-selected'); }
    });
    updateSelBar();
  }

  function syncHeaderCheck() {
    const allCb = document.getElementById('selectAllCheck');
    if (!allCb || rows.length === 0) return;
    const allSel  = rows.every(id => selectedRows.has(id));
    const noneSel = rows.every(id => !selectedRows.has(id));
    allCb.checked = allSel;
    allCb.indeterminate = !allSel && !noneSel;
  }

  function updateSelBar() {
    const bar = document.getElementById('selectionBar');
    document.getElementById('selCount').textContent = selectedRows.size;
    if (selectedRows.size > 0) bar.classList.add('visible');
    else                       bar.classList.remove('visible');
  }

  function clearSelection() {
    selectedRows.clear();
    rows.forEach(id => {
      const cb = document.getElementById('check-' + id);
      const tr = document.getElementById('row-' + id);
      if (cb) cb.checked = false;
      if (tr) tr.classList.remove('row-selected');
    });
    const allCb = document.getElementById('selectAllCheck');
    if (allCb) { allCb.checked = false; allCb.indeterminate = false; }
    updateSelBar();
  }

  function deleteSelected() {
    if (selectedRows.size === 0) return;
    const count = selectedRows.size;
    showConfirm(
      `–£–¥–∞–ª–∏—Ç—å ${count} –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤? –û–Ω–∏ –±—É–¥—É—Ç –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã –≤ –∞—Ä—Ö–∏–≤.`,
      () => {
        const toDelete = [...selectedRows];
        const ts = Date.now();
        toDelete.forEach((id, i) => {
          const code  = document.getElementById('code-' + id)?.value || '';
          const name  = document.getElementById('name-' + id)?.value || '';
          const usd   = parseFloat(document.getElementById('usd-' + id)?.value) || 0;
          const qty   = parseInt(document.getElementById('qty-' + id)?.value)   || 6;
          const trEl  = document.getElementById('row-' + id);
          const photo = trEl?.querySelector('img.row-thumb')?.src || null;
          const sizeEl= trEl?.querySelector('.size-badge');
          const size  = sizeEl ? sizeEl.textContent.trim() : null;
          archive.unshift({ archiveId: ts + i, code, name, usd, qty, photo, size,
            deletedAt: new Date().toLocaleTimeString('ru-RU', { hour:'2-digit', minute:'2-digit' }) });
          rows = rows.filter(r => r !== id);
          if (trEl) trEl.remove();
        });
        selectedRows.clear();
        renumberRows();
        recalc();
        if (rows.length === 0) document.getElementById('emptyHint').style.display = 'block';
        renderArchive();
        updateSelBar();
        const allCb = document.getElementById('selectAllCheck');
        if (allCb) { allCb.checked = false; allCb.indeterminate = false; }
      }
    );
  }

  // Chart instances
  let chProfitUnit = null;
  let chCostDonut = null;
  let chRevenueVsCogs = null;
  let chMarginPct = null;
  let chPriceVsCogs = null;
  let chCategoryProfit = null;
  let chInventory = null, chAcos = null;

  // Chart.js global defaults for dark theme
  Chart.defaults.color = '#4f5a7a';
  Chart.defaults.borderColor = '#1e2235';
  Chart.defaults.font.family = "-apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif";
  Chart.defaults.font.size = 11;

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  //  Tab switching
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function showTab(name, btn) {
    document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.htab').forEach(b => b.classList.remove('active'));
    document.getElementById('tab-' + name).classList.add('active');
    if (btn) btn.classList.add('active');
    else {
      // Sync the header htab when called from sidebar
      const htab = document.querySelector(`.htab[onclick*="'${name}'"]`);
      if (htab) htab.classList.add('active');
    }
    activeTab = name;
    // Sync mobile bottom nav
    document.querySelectorAll('.mobile-nav-btn').forEach(b =>
      b.classList.toggle('active', b.dataset.tab === name));
    if (name === 'analytics' && lastChartData) {
      setTimeout(() => renderCharts(lastChartData), 30);
    }
    if (name === 'warehouse' && !whInitialized) {
      whInitialized = true;
      initWarehouse();
    }
    if (name === 'dashboard') {
      if (!whInitialized) { whInitialized = true; initWarehouse(); }
      setTimeout(renderDashboard, 300);
      fetchExchangeRate();
    }
    if (name === 'sales') renderSales();
  }


  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  //  Helpers
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function g(id) { return parseFloat(document.getElementById(id).value) || 0; }

  function fmtS(n) {
    if (!isFinite(n) || n == null) return '‚Äî';
    return Math.round(n).toLocaleString('ru-RU') + ' —Å—É–º';
  }
  function fmtK(n) {
    if (!isFinite(n)) return '‚Äî';
    return (Math.round(n / 1000)).toLocaleString('ru-RU') + 'K';
  }
  function fmtM(n) {
    if (!isFinite(n) || n === 0) return '‚Äî';
    if (Math.abs(n) >= 1e9) return (n / 1e9).toFixed(1) + 'B';
    if (Math.abs(n) >= 1e6) return (n / 1e6).toFixed(1) + 'M';
    return fmtK(n);
  }
  function shortLabel(code, name) {
    const s = code || name;
    return s.length > 14 ? s.substring(0, 14) + '‚Ä¶' : s;
  }

  function setMargin(val, btn) {
    marginPct = val;
    document.querySelectorAll('.margin-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    recalc();
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  //  Add / delete rows
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function addRow(data) {
    rowCounter++;
    const id = rowCounter;
    rows.push(id);
    const tbody = document.getElementById('tableBody');
    const tr = document.createElement('tr');
    tr.id = 'row-' + id;
    const thumbHtml = data?.photo
      ? `<img class="row-thumb" src="${data.photo}" alt="" onclick="openLightbox(this.src)" title="–ù–∞–∂–º–∏ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞" />`
      : `<div class="row-thumb-empty">üì¶</div>`;
    const rowMargin    = data?.margin    ?? 30;
    const rowRate      = data?.rate      ?? defaultRate;
    const rowLogistics = data?.logistics ?? 0;
    const sizesArr = Array.isArray(data?.sizes) ? data.sizes : (data?.size ? [data.size] : []);
    const sizeHtml = sizesArr.length > 0
      ? sizesArr.map(s => `<span class="size-badge">${escH(s)}</span>`).join(' ')
      : `<span style="color:#2d3455;font-size:0.75rem">‚Äî</span>`;
    tr.setAttribute('data-margin', rowMargin);
    tr.setAttribute('data-rate', rowRate);
    tr.setAttribute('data-logistics', rowLogistics);
    tr.innerHTML = `
      <td style="padding:0 4px"><span class="drag-handle" draggable="true">‚†ø</span></td>
      <td style="text-align:center"><input type="checkbox" class="row-checkbox" id="check-${id}" onclick="toggleRowSelect(${id})" /></td>
      <td class="row-num" style="color:#4f5a7a;font-size:0.75rem">${rows.length}<br><span class="abc-badge" id="abc-${id}"></span></td>
      <td class="product-card-cell">
        <div class="product-card-inner">
          <div class="row-photo-cell">${thumbHtml}</div>
          <div class="product-card-info">
            <input type="text" id="name-${id}" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞" value="${escH(data?.name||'')}" oninput="recalc()" />
            <div class="product-card-meta">
              <input type="text" id="code-${id}" placeholder="SKU / –ê—Ä—Ç–∏–∫—É–ª" value="${escH(data?.code||'')}" oninput="recalc()" style="min-width:70px;width:auto" />
              <span class="low-stock-badge" id="lowbadge-${id}" style="display:none"></span>
            </div>
          </div>
        </div>
      </td>
      <td class="row-size-cell" data-sizes="${escH(sizesArr.join(','))}">${sizeHtml}</td>
      <td><input type="number" id="usd-${id}" placeholder="0.00" min="0" step="0.01" value="${data?.usd||''}" oninput="recalc()" /></td>
      <td><input type="number" id="qty-${id}" placeholder="1" min="1" value="${data?.qty||6}" oninput="recalc()" /></td>
      <td class="col-result" id="logunit-${id}" style="color:#f59e0b">‚Äî</td>
      <td class="col-result" id="communit-${id}" style="color:#ef4444">‚Äî</td>
      <td class="col-result" id="mktunit-${id}" style="color:#f59e0b">‚Äî</td>
      <td class="col-result" id="cogs-${id}">‚Äî</td>
      <td class="col-price"><span id="price-${id}">‚Äî</span><small class="be-price" id="be-${id}"></small></td>
      <td class="col-profit" id="profit-${id}">‚Äî<br><span class="margin-tag" id="mtag-${id}" onclick="editInlineMargin(${id})" title="–ù–∞–∂–º–∏ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–∞—Ä–∂–∏">${rowMargin}%</span><small class="acos-hint" id="acos-${id}"></small></td>
      <td class="col-sold">
        <input type="number" class="sold-input" id="sold-${id}" placeholder="0" min="0" value="${data?.sold||0}"
          oninput="recalc()" title="–í–≤–µ–¥–∏—Ç–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–∞–Ω–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ" />
        <small class="sold-profit" id="soldp-${id}"></small>
        <small class="sold-rem" id="soldr-${id}"></small>
      </td>
      <td><div class="row-actions">
        <button class="btn-edit" onclick="openEditModal(${id})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">‚úè</button>
        <button class="btn-dup"  onclick="duplicateRow(${id})"  title="–î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å">‚ßâ</button>
        <button class="btn-dup"  onclick="openPriceHist(${id})" title="–ò—Å—Ç–æ—Ä–∏—è —Ü–µ–Ω">üïê</button>
        <button class="btn-del"  onclick="delRow(${id})"        title="–£–¥–∞–ª–∏—Ç—å">√ó</button>
      </div></td>
    `;
    tbody.appendChild(tr);
    document.getElementById('emptyHint').style.display = 'none';
    if (data?.category) setRowCategory(id, data.category);
    if (data?.country)  tr.setAttribute('data-country',  data.country);
    if (data?.supplier) tr.setAttribute('data-supplier', data.supplier);
    if (data?.extras) productExtras[id] = { ...data.extras };
    recalc();
    return id; // allow callers to collect the new row ID
  }

  // ‚îÄ‚îÄ Confirm modal ‚îÄ‚îÄ
  function showConfirm(subText, onConfirm) {
    document.getElementById('confirmModalSub').textContent = subText;
    document.getElementById('confirmModal').classList.add('open');
    pendingConfirmCallback = onConfirm;
  }
  document.getElementById('confirmYes').addEventListener('click', () => {
    document.getElementById('confirmModal').classList.remove('open');
    if (pendingConfirmCallback) { pendingConfirmCallback(); pendingConfirmCallback = null; }
  });
  document.getElementById('confirmNo').addEventListener('click', () => {
    document.getElementById('confirmModal').classList.remove('open');
    pendingConfirmCallback = null;
  });
  document.getElementById('confirmModal').addEventListener('click', (e) => {
    if (e.target === document.getElementById('confirmModal')) {
      document.getElementById('confirmModal').classList.remove('open');
      pendingConfirmCallback = null;
    }
  });

  function delRow(id) {
    const code = document.getElementById('code-' + id)?.value || '';
    const name = document.getElementById('name-' + id)?.value || '';
    const label = (code || name).substring(0, 36) || '—Ç–æ–≤–∞—Ä';

    showConfirm(
      `¬´${label}¬ª –±—É–¥–µ—Ç –ø–µ—Ä–µ–º–µ—â—ë–Ω –≤ –∞—Ä—Ö–∏–≤ ‚Äî –≤—ã —Å–º–æ–∂–µ—Ç–µ –µ–≥–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å.`,
      () => {
        const usd      = parseFloat(document.getElementById('usd-' + id)?.value) || 0;
        const qty      = parseInt(document.getElementById('qty-' + id)?.value)   || 6;
        const tr2      = document.getElementById('row-' + id);
        const photo    = tr2?.querySelector('img.row-thumb')?.src || null;
        const sizesStr = tr2?.querySelector('.row-size-cell')?.getAttribute('data-sizes') || '';
        const sizes    = sizesStr ? sizesStr.split(',').filter(Boolean) : [];
        const margin   = parseInt(tr2?.getAttribute('data-margin'))    || 30;
        const rate     = parseFloat(tr2?.getAttribute('data-rate'))    || defaultRate;
        const logistics= parseFloat(tr2?.getAttribute('data-logistics')) || 0;
        const category = tr2?.getAttribute('data-category') || '';
        const archiveId = Date.now();
        archive.unshift({
          archiveId,
          code, name, usd, qty, photo, sizes, margin, rate, logistics, category,
          deletedAt: new Date().toLocaleTimeString('ru-RU', { hour:'2-digit', minute:'2-digit' })
        });
        rows = rows.filter(r => r !== id);
        const tr = document.getElementById('row-' + id);
        if (tr) tr.remove();
        renumberRows();
        recalc();
        selectedRows.delete(id);
        if (rows.length === 0) document.getElementById('emptyHint').style.display = 'block';
        renderArchive();
        updateSelBar();
        syncHeaderCheck();
        showUndoToast({ archiveId, code, name, usd, qty, sizes, margin, rate, logistics, category });
      }
    );
  }

  // ‚îÄ‚îÄ Archive ‚îÄ‚îÄ
  function renderArchive() {
    const section = document.getElementById('archiveSection');
    const list    = document.getElementById('archiveList');
    if (archive.length === 0) { section.style.display = 'none'; return; }
    section.style.display = 'block';
    list.innerHTML = archive.map(item => `
      <div class="archive-item">
        ${item.photo
          ? `<img src="${item.photo}" style="width:36px;height:36px;border-radius:8px;object-fit:cover;flex-shrink:0" />`
          : `<div style="width:36px;height:36px;border-radius:8px;background:#1e2235;display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;color:#2d3455">üì¶</div>`}
        <div class="archive-info">
          <span class="archive-code">${escH(item.code || '‚Äî')}${item.size ? ` ¬∑ <span style="color:#818cf8">${escH(item.size)}</span>` : ''}</span>
          <span class="archive-name">${escH(item.name || '‚Äî')}</span>
          <span class="archive-meta">$${item.usd} ¬∑ ${item.qty} —à—Ç ¬∑ —É–¥–∞–ª—ë–Ω –≤ ${item.deletedAt}</span>
        </div>
        <div style="display:flex;gap:6px">
          <button class="btn-restore" onclick="restoreRow(${item.archiveId})">‚Ü© –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>
          <button class="btn-del" onclick="permDeleteFromArchive(${item.archiveId})" title="–£–¥–∞–ª–∏—Ç—å –Ω–∞–≤—Å–µ–≥–¥–∞" style="padding:4px 8px;font-size:0.8rem">üóë</button>
        </div>
      </div>
    `).join('');
  }

  function restoreRow(archiveId) {
    const item = archive.find(a => a.archiveId === archiveId);
    if (!item) return;
    archive = archive.filter(a => a.archiveId !== archiveId);
    addRow({ code: item.code, name: item.name, usd: item.usd, qty: item.qty });
    renderArchive();
  }

  function permDeleteFromArchive(archiveId) {
    archive = archive.filter(a => a.archiveId !== archiveId);
    renderArchive();
    scheduleSave();
  }

  function clearArchive() {
    if (archive.length === 0) return;
    showConfirm('–ü–æ–ª–Ω–æ—Å—Ç—å—é –æ—á–∏—Å—Ç–∏—Ç—å –∞—Ä—Ö–∏–≤ —É–¥–∞–ª—ë–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤?', () => {
      archive = [];
      renderArchive();
      saveToFirestore();
    });
  }

  function renumberRows() {
    rows.forEach((id, idx) => {
      const tr = document.getElementById('row-' + id);
      if (tr) { const n = tr.querySelector('.row-num'); if (n) n.textContent = idx + 1; }
    });
  }

  // ‚îÄ‚îÄ Column sort ‚îÄ‚îÄ
  function sortTable(col) {
    if (tableSortCol === col) {
      tableSortDir *= -1;
    } else {
      tableSortCol = col;
      tableSortDir = 1;
    }
    const getVal = id => {
      const tr = document.getElementById('row-' + id);
      switch (col) {
        case 'name':   return (document.getElementById('name-' + id)?.value || '').toLowerCase();
        case 'code':   return (document.getElementById('code-' + id)?.value || '').toLowerCase();
        case 'usd':    return parseFloat(document.getElementById('usd-'  + id)?.value) || 0;
        case 'qty':    return parseFloat(document.getElementById('qty-'  + id)?.value) || 0;
        case 'sold':   return parseFloat(document.getElementById('sold-' + id)?.value) || 0;
        case 'price':  return parseFloat(tr?.dataset.priceVal)  || 0;
        case 'profit': return parseFloat(tr?.dataset.profitVal) || 0;
        case 'cogs':   return parseFloat(tr?.dataset.cogsVal)   || 0;
        default: return 0;
      }
    };
    rows.sort((a, b) => {
      const va = getVal(a), vb = getVal(b);
      return tableSortDir * (typeof va === 'string' ? va.localeCompare(vb) : (va - vb));
    });
    const tbody = document.getElementById('tableBody');
    rows.forEach(id => { const tr = document.getElementById('row-' + id); if (tr) tbody.appendChild(tr); });
    renumberRows();
    // Update arrow indicators
    document.querySelectorAll('.sort-arrow').forEach(el => el.textContent = '');
    const arr = document.getElementById('sarr-' + col);
    if (arr) arr.textContent = tableSortDir === 1 ? ' ‚Üë' : ' ‚Üì';
  }

  // ‚îÄ‚îÄ Drag & drop row sorting ‚îÄ‚îÄ
  (function initDragDrop() {
    let dragSrcId = null;
    const tBody = document.getElementById('tableBody');
    if (!tBody) return;
    tBody.addEventListener('dragstart', e => {
      const handle = e.target.closest('.drag-handle');
      if (!handle) return;
      const tr = handle.closest('tr[id^="row-"]');
      if (!tr) return;
      dragSrcId = parseInt(tr.id.replace('row-', ''));
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/plain', String(dragSrcId));
      requestAnimationFrame(() => tr.classList.add('row-dragging'));
    });
    tBody.addEventListener('dragover', e => {
      e.preventDefault();
      const tr = e.target.closest('tr[id^="row-"]');
      if (!tr) return;
      document.querySelectorAll('.row-drag-over').forEach(r => r.classList.remove('row-drag-over'));
      if (parseInt(tr.id.replace('row-', '')) !== dragSrcId) tr.classList.add('row-drag-over');
    });
    tBody.addEventListener('dragleave', e => {
      if (!tBody.contains(e.relatedTarget))
        document.querySelectorAll('.row-drag-over').forEach(r => r.classList.remove('row-drag-over'));
    });
    tBody.addEventListener('drop', e => {
      e.preventDefault();
      const targetTr = e.target.closest('tr[id^="row-"]');
      if (!targetTr || dragSrcId == null) return;
      const targetId = parseInt(targetTr.id.replace('row-', ''));
      if (targetId === dragSrcId) return;
      targetTr.classList.remove('row-drag-over');
      const si = rows.indexOf(dragSrcId), ti = rows.indexOf(targetId);
      if (si < 0 || ti < 0) return;
      rows.splice(si, 1);
      rows.splice(ti, 0, dragSrcId);
      rows.forEach(id => { const tr = document.getElementById('row-' + id); if (tr) tBody.appendChild(tr); });
      renumberRows();
      scheduleSave();
    });
    tBody.addEventListener('dragend', () => {
      document.querySelectorAll('.row-dragging, .row-drag-over').forEach(r =>
        r.classList.remove('row-dragging', 'row-drag-over'));
      dragSrcId = null;
    });
  })();

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  //  Main recalc  (RAF-debounced ‚Äî multiple rapid
  //  oninput calls collapse into one frame)
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let _recalcPending = false;
  function recalc() {
    if (_recalcPending) return;
    _recalcPending = true;
    requestAnimationFrame(() => { _recalcPending = false; _recalcNow(); });
  }
  function _recalcNow() {
    const totalLog   = g('totalLogistics');
    const commPct    = g('commission');
    const marketUnit = g('marketing');
    const comm       = commPct / 100;

    // Total units
    let totalUnits = 0;
    rows.forEach(id => {
      totalUnits += parseFloat(document.getElementById('qty-' + id)?.value) || 0;
    });
    const logPerUnit = totalUnits > 0 && totalLog > 0 ? totalLog / totalUnits : 0;

    // Per-product calculation + collect chart data
    let sumCogs = 0, sumRevenue = 0, sumProfit = 0;
    let sumSoldQty = 0, sumSoldRevenue = 0, sumSoldProfit = 0;
    let totalPurchaseCost = 0, totalLogCost = 0, totalCommCost = 0, totalMktCost = 0;

    const cd = {
      labels: [], fullNames: [],
      profitPerUnit: [], cogsPerUnit: [], pricePerUnit: [],
      revenueTotal: [], cogsTotal: [],
      marginPcts: [],
      categoryProfits: {},
      stockRemaining: [], stockSold: [],
      revenueActual: [], profitActual: [], cogsActual: []
    };

    rows.forEach(id => {
      const usd = parseFloat(document.getElementById('usd-' + id)?.value) || 0;
      const qty = parseFloat(document.getElementById('qty-' + id)?.value) || 1;
      const code = document.getElementById('code-' + id)?.value || '';
      const name = document.getElementById('name-' + id)?.value || '';

      // Per-row margin, rate, logistics
      const trEl2        = document.getElementById('row-' + id);
      const rowMarginVal = trEl2 ? (parseInt(trEl2.getAttribute('data-margin'))    || 30)          : 30;
      const rowRate      = trEl2 ? (parseFloat(trEl2.getAttribute('data-rate'))    || defaultRate) : defaultRate;
      const rowLogUnit   = trEl2 ? (parseFloat(trEl2.getAttribute('data-logistics')) || 0)         : 0;
      const denom = 1 - (rowMarginVal / 100) - comm;

      // Use per-row logistics if set, otherwise fall back to global (divided by total units)
      const effectiveLog = rowLogUnit > 0 ? rowLogUnit : logPerUnit;

      const purchaseUnit = usd * rowRate;
      const cogs = purchaseUnit + effectiveLog + marketUnit;

      let price = null, profit = null, commPerUnit = 0;

      if (denom > 0 && cogs > 0) {
        price = cogs / denom;
        commPerUnit = price * comm;
        profit = price - cogs - commPerUnit;
      } else if (denom > 0 && cogs === 0) {
        price = null; profit = null;
      }

      // Update table cells
      const setEl = (elId, val) => { const el = document.getElementById(elId); if (el) el.textContent = val; };
      setEl('logunit-' + id,  effectiveLog > 0 ? fmtS(effectiveLog) + (rowLogUnit > 0 ? ' ‚òÖ' : '') : '‚Äî');
      setEl('communit-' + id, commPct > 0 && price ? fmtS(commPerUnit) : '0 —Å—É–º');
      setEl('mktunit-' + id,  marketUnit > 0 ? fmtS(marketUnit) : '0 —Å—É–º');
      setEl('cogs-' + id,  cogs > 0 ? fmtS(cogs) : '‚Äî');
      setEl('price-' + id, price ? fmtS(price) : '‚Äî');
      const bePrice = (1 - comm) > 0 && cogs > 0 ? cogs / (1 - comm) : null;
      setEl('be-' + id, bePrice && price ? '–º–∏–Ω: ' + fmtS(bePrice) : '');

      const profEl = document.getElementById('profit-' + id);
      if (profEl) {
        profEl.textContent = profit != null ? fmtS(profit) : '‚Äî';
        profEl.className = 'col-profit ' + (profit != null ? (profit >= 0 ? 'pos' : 'neg') : '');
      }
      // Store computed margin% on row element for quick filtering + column sort
      const trEl3 = document.getElementById('row-' + id);
      if (trEl3) {
        const marginPctVal = price && profit != null ? profit / price * 100 : 0;
        trEl3.dataset.marginPct  = marginPctVal.toFixed(1);
        trEl3.dataset.profitSign = profit != null ? (profit >= 0 ? 'pos' : 'neg') : '';
        trEl3.dataset.priceVal   = price  ? Math.round(price)  : 0;
        trEl3.dataset.profitVal  = profit != null ? Math.round(profit) : 0;
        trEl3.dataset.cogsVal    = cogs   ? Math.round(cogs)   : 0;
        // Margin alert highlighting + Telegram notification on state change
        const isBelow = minMarginAlert > 0 && price != null && profit != null && marginPctVal < minMarginAlert;
        trEl3.classList.toggle('row-margin-alert', isBelow);
        if (isBelow && marginAlertState[id] === false) {
          const nm = document.getElementById('name-' + id)?.value || document.getElementById('code-' + id)?.value || '—Ç–æ–≤–∞—Ä';
          sendTgNotify(`‚ö†Ô∏è –ú–∞—Ä–∂–∞ —É–ø–∞–ª–∞!\n<b>${nm}</b>: ${marginPctVal.toFixed(1)}% &lt; ${minMarginAlert}%`);
        }
        marginAlertState[id] = isBelow;
      }

      // Sales tracker ‚Äî per-row sold display
      const soldQtyRow = parseFloat(document.getElementById('sold-' + id)?.value) || 0;
      const soldPEl = document.getElementById('soldp-' + id);
      if (soldPEl) {
        soldPEl.textContent = profit != null && soldQtyRow > 0 ? fmtS(profit * soldQtyRow) : '';
      }
      // Remaining stock indicator
      const remainQty = Math.max(0, qty - soldQtyRow);
      const soldRemEl = document.getElementById('soldr-' + id);
      if (soldRemEl) {
        if (soldQtyRow > 0) {
          if (remainQty === 0) {
            soldRemEl.textContent = '‚úì –†–∞—Å–ø—Ä–æ–¥–∞–Ω–æ';
            soldRemEl.className = 'sold-rem out';
          } else {
            const soldPct = soldQtyRow / qty;
            soldRemEl.textContent = `–û—Å—Ç: ${remainQty} —à—Ç`;
            soldRemEl.className = 'sold-rem' + (soldPct >= 0.7 ? '' : ' warn');
          }
        } else {
          soldRemEl.textContent = '';
          soldRemEl.className = 'sold-rem';
        }
      }
      // ACoS hint (break-even ad spend %)
      const acosEl = document.getElementById('acos-' + id);
      if (acosEl) {
        const maxAcos = price > 0 && profit != null ? (profit / price * 100) : null;
        acosEl.textContent = maxAcos !== null && maxAcos > 0 ? `Max ACoS: ${maxAcos.toFixed(1)}%` : '';
      }
      // Push to chart data
      cd.stockRemaining.push(remainQty);
      cd.stockSold.push(soldQtyRow);
      cd.revenueActual.push(price && soldQtyRow > 0 ? Math.round(price  * soldQtyRow) : 0);
      cd.profitActual.push( profit != null && soldQtyRow > 0 ? Math.round(profit * soldQtyRow) : 0);
      cd.cogsActual.push(   soldQtyRow > 0 ? Math.round(cogs * soldQtyRow) : 0);
      // Accumulate sold totals
      if (price && soldQtyRow > 0) {
        sumSoldQty += soldQtyRow;
        sumSoldRevenue += price * soldQtyRow;
        if (profit != null) sumSoldProfit += profit * soldQtyRow;
      }

      // Accumulate totals
      if (price && cogs > 0) {
        sumCogs    += cogs * qty;
        sumRevenue += price * qty;
        sumProfit  += profit * qty;
        totalPurchaseCost += purchaseUnit * qty;
        totalLogCost      += logPerUnit * qty;
        totalCommCost     += commPerUnit * qty;
        totalMktCost      += marketUnit * qty;
        // Category breakdown
        const cat = trEl2?.getAttribute('data-category') || '–ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏';
        if (!cd.categoryProfits[cat]) cd.categoryProfits[cat] = { profit: 0, revenue: 0 };
        cd.categoryProfits[cat].profit  += profit * qty;
        cd.categoryProfits[cat].revenue += price  * qty;
      }

      // Chart data
      cd.labels.push(shortLabel(code, name));
      cd.fullNames.push((code ? code + ' ¬∑ ' : '') + name.substring(0, 40));
      cd.profitPerUnit.push(profit != null ? Math.round(profit) : 0);
      cd.cogsPerUnit.push(Math.round(cogs));
      cd.pricePerUnit.push(price ? Math.round(price) : 0);
      cd.revenueTotal.push(price ? Math.round(price * qty) : 0);
      cd.cogsTotal.push(Math.round(cogs * qty));
      cd.marginPcts.push(price && profit != null ? parseFloat((profit / price * 100).toFixed(1)) : 0);
    });

    // Attach cost structure totals
    cd.purchaseCostTotal = totalPurchaseCost;
    cd.logisticsTotal    = totalLogCost;
    cd.commissionTotal   = totalCommCost;
    cd.marketingTotal    = totalMktCost;

    // ‚îÄ‚îÄ Update KPI strip ‚îÄ‚îÄ
    const roi = sumCogs > 0 ? (sumProfit / sumCogs * 100) : 0;
    const avgMargin = sumRevenue > 0 ? (sumProfit / sumRevenue * 100) : 0;
    const avgCogsPerUnit = totalUnits > 0 ? sumCogs / totalUnits : 0;
    const avgRevPerUnit  = totalUnits > 0 ? sumRevenue / totalUnits : 0;
    const avgProfPerUnit = totalUnits > 0 ? sumProfit / totalUnits : 0;

    const kpi = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
    kpi('kpiUnits',   totalUnits > 0 ? totalUnits + ' —à—Ç' : '‚Äî');
    kpi('kpiSku',     rows.length + ' SKU');
    kpi('kpiCogs',    sumCogs > 0 ? fmtM(sumCogs) + ' —Å—É–º' : '‚Äî');
    kpi('kpiCogsUnit',avgCogsPerUnit > 0 ? fmtK(avgCogsPerUnit) + ' / —é–Ω–∏—Ç' : '‚Äî');
    kpi('kpiRevenue', sumRevenue > 0 ? fmtM(sumRevenue) + ' —Å—É–º' : '‚Äî');
    kpi('kpiRevUnit', avgRevPerUnit > 0 ? fmtK(avgRevPerUnit) + ' / —é–Ω–∏—Ç' : '‚Äî');
    kpi('kpiProfit',  sumProfit != 0 ? fmtM(sumProfit) + ' —Å—É–º' : '‚Äî');
    kpi('kpiProfUnit',avgProfPerUnit != 0 ? fmtK(avgProfPerUnit) + ' / —é–Ω–∏—Ç' : '‚Äî');
    kpi('kpiRoi',     roi !== 0 ? roi.toFixed(1) + '%' : '‚Äî');
    kpi('kpiMargin',  avgMargin !== 0 ? avgMargin.toFixed(1) + '%' : '‚Äî');

    // ‚îÄ‚îÄ Sales tracker KPI ‚îÄ‚îÄ
    kpi('kpiSold',        sumSoldQty > 0 ? sumSoldQty + ' —à—Ç' : '‚Äî');
    kpi('kpiSoldRevenue', sumSoldRevenue > 0 ? fmtM(sumSoldRevenue) + ' —Å—É–º' : '‚Äî');
    kpi('kpiSoldProfit',  sumSoldProfit !== 0 ? fmtM(sumSoldProfit) + ' —Å—É–º' : '‚Äî');
    const soldPlanPct = sumProfit > 0 && sumSoldProfit > 0 ? Math.round(sumSoldProfit / sumProfit * 100) : 0;
    kpi('kpiSoldPct',     soldPlanPct > 0 ? soldPlanPct + '% –æ—Ç –ø–ª–∞–Ω–∞' : '‚Äî');

    // Store chart data
    lastChartData = rows.length > 0 ? cd : null;

    // Update charts if analytics tab is active
    if (activeTab === 'analytics') {
      setTimeout(() => renderCharts(lastChartData), 0);
    }

    scheduleSave();
    regroup();
    applyProdFilter();
    runAbcAnalysis();
  }

  function runAbcAnalysis() {
    // Collect rows with positive total profit
    const items = [];
    rows.forEach(id => {
      const qty = parseFloat(document.getElementById('qty-' + id)?.value) || 0;
      const trEl = document.getElementById('row-' + id);
      const marginPct = parseFloat(trEl?.dataset.marginPct || '0');
      const priceEl = document.getElementById('price-' + id);
      const priceText = priceEl?.querySelector ? priceEl.querySelector('span')?.textContent : priceEl?.textContent;
      const priceVal = parseFloat((priceText || '').replace(/[^\d.-]/g, '')) || 0;
      const profitTotal = priceVal > 0 ? (marginPct / 100) * priceVal * qty : 0;
      items.push({ id, total: profitTotal });
    });
    const positive = items.filter(i => i.total > 0).sort((a, b) => b.total - a.total);
    const grandTotal = positive.reduce((s, i) => s + i.total, 0);
    const abcMap = {};
    let cumulative = 0;
    positive.forEach(i => {
      cumulative += i.total;
      const pct = grandTotal > 0 ? cumulative / grandTotal : 0;
      abcMap[i.id] = pct <= 0.80 ? 'A' : pct <= 0.95 ? 'B' : 'C';
    });
    items.filter(i => i.total <= 0).forEach(i => { abcMap[i.id] = 'C'; });
    rows.forEach(id => {
      const el = document.getElementById('abc-' + id);
      if (!el) return;
      const cls = abcMap[id];
      if (!cls) { el.textContent = ''; el.className = 'abc-badge'; return; }
      el.textContent = cls;
      el.className = `abc-badge abc-${cls.toLowerCase()}`;
    });
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  //  Row grouping (same code+name ‚Üí visual group)
  //  Children are collapsed by default; toggle with button.
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function regroup() {
    // 1. Reset all group state
    rows.forEach((id, idx) => {
      const tr = document.getElementById('row-' + id);
      if (!tr) return;
      tr.classList.remove('group-first','group-middle','group-last','group-child','group-collapsed');
      tr.style.display = '';
      const codeInp = document.getElementById('code-' + id);
      const nameInp = document.getElementById('name-' + id);
      if (codeInp) codeInp.classList.remove('group-hidden');
      if (nameInp) nameInp.classList.remove('group-hidden');
      const numEl = tr.querySelector('.row-num');
      if (numEl) numEl.innerHTML = idx + 1;
    });

    if (rows.length < 2) return;

    // 2. Find consecutive rows with same code+name and apply grouping
    let i = 0;
    while (i < rows.length) {
      const id   = rows[i];
      const code = (document.getElementById('code-' + id)?.value || '').trim();
      const name = (document.getElementById('name-' + id)?.value || '').trim();

      if (!code && !name) { i++; continue; }

      let j = i + 1;
      while (j < rows.length) {
        const c2 = (document.getElementById('code-' + rows[j])?.value || '').trim();
        const n2 = (document.getElementById('name-' + rows[j])?.value || '').trim();
        if (c2 === code && n2 === name) j++;
        else break;
      }

      if (j > i + 1) {
        const count    = j - i;
        const groupKey = code + '|' + name;
        const isExpanded = expandedGroups.has(groupKey);
        const safeKey  = encodeURIComponent(groupKey);

        for (let k = i; k < j; k++) {
          const tr = document.getElementById('row-' + rows[k]);
          if (!tr) continue;
          const numEl = tr.querySelector('.row-num');

          if (k === i) {
            // First row of group
            tr.classList.add('group-first');
            if (!isExpanded) tr.classList.add('group-collapsed');
            const toggleLabel = isExpanded ? '‚ñ≤ –°–≤–µ—Ä–Ω—É—Ç—å' : '‚ñ∂ –ü–æ–∫–∞–∑–∞—Ç—å';
            const attrKey = groupKey.replace(/&/g,'&amp;').replace(/"/g,'&quot;');
            if (numEl) numEl.innerHTML =
              `${k+1}<span class="group-count">${count} —Ä–∞–∑–º.</span>` +
              `<button class="group-toggle" data-gkey="${attrKey}">${toggleLabel}</button>`;
          } else {
            // Child rows
            tr.classList.add('group-child');
            if (k === j - 1) tr.classList.add('group-last');
            else             tr.classList.add('group-middle');
            const codeInp = document.getElementById('code-' + rows[k]);
            const nameInp = document.getElementById('name-' + rows[k]);
            if (codeInp) codeInp.classList.add('group-hidden');
            if (nameInp) nameInp.classList.add('group-hidden');
            if (numEl) numEl.innerHTML = k === j - 1 ? '‚îî' : '‚îú';
            // Collapse: hide child rows unless expanded
            tr.style.display = isExpanded ? '' : 'none';
          }
        }
      }

      i = j;
    }
  }

  function toggleGroup(key) {
    if (expandedGroups.has(key)) expandedGroups.delete(key);
    else                         expandedGroups.add(key);
    regroup();
  }

  // Delegated click handler for group-toggle buttons
  document.addEventListener('click', function(e) {
    const btn = e.target.closest('.group-toggle');
    if (!btn) return;
    e.stopPropagation();
    toggleGroup(btn.dataset.gkey);
  });

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  //  Chart rendering
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderCharts(cd) {
    try {
    const empty   = document.getElementById('analyticsEmpty');
    const content = document.getElementById('analyticsContent');

    if (!cd || cd.labels.length === 0) {
      empty.style.display = 'block';
      content.style.display = 'none';
      return;
    }
    empty.style.display = 'none';
    content.style.display = 'block';

    // ‚îÄ‚îÄ Shared helpers ‚îÄ‚îÄ
    const FONT = { size: 12, family: 'inherit' };
    const axisStyle = {
      grid: { color: 'rgba(30,34,53,0.8)' },
      ticks: { color: '#64748b', font: FONT }
    };

    // ‚îÄ‚îÄ Aggregate per unique product (deduplicate sizes) ‚îÄ‚îÄ
    const isReal = analyticsMode === 'real';
    const prodMap = new Map();
    cd.fullNames.forEach((fn, i) => {
      if (!prodMap.has(fn)) {
        prodMap.set(fn, {
          label: cd.labels[i], fullName: fn,
          profitPerUnit: cd.profitPerUnit[i],
          cogsPerUnit:   cd.cogsPerUnit[i],
          pricePerUnit:  cd.pricePerUnit[i],
          marginPct:     cd.marginPcts[i],
          revenueTotal:  0, cogsTotal: 0,
          revenueActual: 0, profitActual: 0, cogsActual: 0,
          stockSold: 0, stockRemaining: 0
        });
      }
      const p = prodMap.get(fn);
      p.revenueTotal   += cd.revenueTotal[i];
      p.cogsTotal      += cd.cogsTotal[i];
      p.revenueActual  += cd.revenueActual[i];
      p.profitActual   += cd.profitActual[i];
      p.cogsActual     += cd.cogsActual[i];
      p.stockSold      += cd.stockSold[i];
      p.stockRemaining += cd.stockRemaining[i];
    });

    // In 'real' mode: only products with actual sales; in 'forecast': all with revenue
    const allProds = [...prodMap.values()].filter(p => isReal ? p.revenueActual > 0 : p.revenueTotal > 0);

    // No-data state for 'real' mode when nothing sold yet
    const noSalesEl = document.getElementById('analyticsNoSales');
    if (isReal && allProds.length === 0) {
      if (noSalesEl) noSalesEl.style.display = 'block';
      document.querySelector('.charts-grid').style.display = 'none';
      document.querySelector('.top-bottom-grid').style.display = 'none';
      return;
    } else {
      if (noSalesEl) noSalesEl.style.display = 'none';
      document.querySelector('.charts-grid').style.display = '';
      document.querySelector('.top-bottom-grid').style.display = '';
    }

    // Sort and slice
    allProds.sort((a, b) => isReal
      ? b.revenueActual - a.revenueActual
      : b.revenueTotal  - a.revenueTotal);
    const uProds = allProds;
    const top20  = uProds.slice(0, 20);

    // ‚îÄ‚îÄ Chart 1: Profit (total actual or per-unit forecast) ‚îÄ‚îÄ
    if (chProfitUnit) chProfitUnit.destroy();
    const ch1Data  = isReal ? top20.map(p => p.profitActual) : top20.map(p => p.profitPerUnit);
    const ch1Title = isReal ? '–§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–∏–±—ã–ª—å (—Å—É–º)' : '–ü—Ä–∏–±—ã–ª—å / —é–Ω–∏—Ç (–ø–ª–∞–Ω)';
    document.querySelector('#chartProfitUnit')?.closest('.chart-card')?.querySelector('.chart-title') && (document.querySelector('#chartProfitUnit').closest('.chart-card').querySelector('.chart-title').textContent = ch1Title);
    chProfitUnit = new Chart(document.getElementById('chartProfitUnit'), {
      type: 'bar',
      data: {
        labels: top20.map(p => p.label),
        datasets: [{ label: ch1Title,
          data: ch1Data,
          backgroundColor: ch1Data.map(v => v >= 0 ? 'rgba(34,197,94,0.85)' : 'rgba(239,68,68,0.85)'),
          borderRadius: 6, borderSkipped: false }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => fmtS(ctx.parsed.y) } } },
        scales: {
          x: { ...axisStyle, ticks: { ...axisStyle.ticks, maxRotation: 45, maxTicksLimit: 20 } },
          y: { ...axisStyle, ticks: { ...axisStyle.ticks, callback: v => Math.round(v/1000) + 'K' } }
        }
      }
    });

    // ‚îÄ‚îÄ Chart 2: Cost structure donut ‚îÄ‚îÄ
    if (chCostDonut) chCostDonut.destroy();
    chCostDonut = new Chart(document.getElementById('chartCostDonut'), {
      type: 'doughnut',
      data: {
        labels: ['–ó–∞–∫—É–ø–∫–∞', '–õ–æ–≥–∏—Å—Ç–∏–∫–∞', '–ö–æ–º–∏—Å—Å–∏—è', '–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥'],
        datasets: [{ data: [cd.purchaseCostTotal, cd.logisticsTotal, cd.commissionTotal, cd.marketingTotal],
          backgroundColor: ['#6366f1','#06b6d4','#ef4444','#f59e0b'],
          borderColor: '#111422', borderWidth: 4, hoverOffset: 10 }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { display: true, position: 'bottom', labels: { color: '#94a3b8', font: FONT, padding: 14, boxWidth: 12 } },
          tooltip: { callbacks: { label: ctx => `${ctx.label}: ${fmtS(ctx.parsed)}` } }
        },
        cutout: '62%'
      }
    });

    // ‚îÄ‚îÄ Chart 3: Revenue vs COGS ‚îÄ‚îÄ
    if (chRevenueVsCogs) chRevenueVsCogs.destroy();
    chRevenueVsCogs = new Chart(document.getElementById('chartRevenueVsCogs'), {
      type: 'bar',
      data: {
        labels: top20.map(p => p.label),
        datasets: [
          { label: isReal ? '–í—ã—Ä—É—á–∫–∞ (—Ñ–∞–∫—Ç)' : '–í—ã—Ä—É—á–∫–∞ (–ø–ª–∞–Ω)',       data: top20.map(p => isReal ? p.revenueActual : p.revenueTotal), backgroundColor: 'rgba(99,102,241,0.85)', borderRadius: 5, borderSkipped: false },
          { label: isReal ? '–°–µ–±–µ—Å—Ç. (—Ñ–∞–∫—Ç)' : '–°–µ–±–µ—Å—Ç. (–ø–ª–∞–Ω)', data: top20.map(p => isReal ? p.cogsActual    : p.cogsTotal),    backgroundColor: 'rgba(239,68,68,0.6)',  borderRadius: 5, borderSkipped: false }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { display: true, labels: { color: '#94a3b8', font: FONT, boxWidth: 12 } },
          tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${fmtS(ctx.parsed.y)}` } }
        },
        scales: {
          x: { ...axisStyle, ticks: { ...axisStyle.ticks, maxRotation: 45, maxTicksLimit: 20 } },
          y: { ...axisStyle, ticks: { ...axisStyle.ticks, callback: v => fmtM(v) } }
        }
      }
    });

    // ‚îÄ‚îÄ Chart 4: Margin % (top 20, sorted by margin desc) ‚îÄ‚îÄ
    if (chMarginPct) chMarginPct.destroy();
    const marginSorted = [...uProds].sort((a, b) => b.marginPct - a.marginPct).slice(0, 20);
    chMarginPct = new Chart(document.getElementById('chartMarginPct'), {
      type: 'bar',
      data: {
        labels: marginSorted.map(p => p.label),
        datasets: [{ label: '–ú–∞—Ä–∂–∞ %',
          data: marginSorted.map(p => p.marginPct),
          backgroundColor: marginSorted.map(p => p.marginPct >= 40 ? 'rgba(34,197,94,0.85)' : p.marginPct >= 25 ? 'rgba(251,191,36,0.85)' : 'rgba(239,68,68,0.85)'),
          borderRadius: 6, borderSkipped: false }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => ctx.parsed.y.toFixed(1) + '%' } } },
        scales: {
          x: { ...axisStyle, ticks: { ...axisStyle.ticks, maxRotation: 45, maxTicksLimit: 20 } },
          y: { ...axisStyle, min: 0, ticks: { ...axisStyle.ticks, callback: v => v + '%' } }
        }
      }
    });

    // ‚îÄ‚îÄ Chart 5: Price vs COGS per unit (top 20) ‚îÄ‚îÄ
    if (chPriceVsCogs) chPriceVsCogs.destroy();
    chPriceVsCogs = new Chart(document.getElementById('chartPriceVsCogs'), {
      type: 'bar',
      data: {
        labels: top20.map(p => p.label),
        datasets: [
          { label: '–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏',  data: top20.map(p => p.pricePerUnit), backgroundColor: 'rgba(99,102,241,0.85)', borderRadius: 5, borderSkipped: false },
          { label: '–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å', data: top20.map(p => p.cogsPerUnit),  backgroundColor: 'rgba(6,182,212,0.65)',  borderRadius: 5, borderSkipped: false }
        ]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { display: true, labels: { color: '#94a3b8', font: FONT, boxWidth: 12 } },
          tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${fmtS(ctx.parsed.y)}` } }
        },
        scales: {
          x: { ...axisStyle, ticks: { ...axisStyle.ticks, maxRotation: 45, maxTicksLimit: 20 } },
          y: { ...axisStyle, ticks: { ...axisStyle.ticks, callback: v => Math.round(v/1000) + 'K' } }
        }
      }
    });

    // ‚îÄ‚îÄ Chart 6: Profit by category ‚îÄ‚îÄ
    if (chCategoryProfit) chCategoryProfit.destroy();
    const catData   = cd.categoryProfits || {};
    const catLabels = Object.keys(catData).filter(k => catData[k].profit > 0);
    if (catLabels.length > 0) {
      catLabels.sort((a, b) => catData[b].profit - catData[a].profit);
      chCategoryProfit = new Chart(document.getElementById('chartCategoryProfit'), {
        type: 'bar',
        data: {
          labels: catLabels,
          datasets: [{ label: '–ü—Ä–∏–±—ã–ª—å',
            data: catLabels.map(k => Math.round(catData[k].profit)),
            backgroundColor: catLabels.map((_, i) => ['rgba(99,102,241,0.85)','rgba(6,182,212,0.85)','rgba(34,197,94,0.85)','rgba(245,158,11,0.85)','rgba(239,68,68,0.85)'][i % 5]),
            borderRadius: 6, borderSkipped: false }]
        },
        options: {
          indexAxis: 'y', responsive: true, maintainAspectRatio: false,
          plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => fmtS(ctx.parsed.x) } } },
          scales: {
            x: { ...axisStyle, ticks: { ...axisStyle.ticks, callback: v => Math.round(v/1000) + 'K' } },
            y: { ...axisStyle }
          }
        }
      });
    }

    // ‚îÄ‚îÄ Top / Bottom ranking ‚îÄ‚îÄ
    const rankKey = isReal ? 'profitActual' : 'marginPct';
    const ranked  = [...uProds].sort((a, b) => b[rankKey] - a[rankKey]);
    const topTitle = document.getElementById('rankTopTitle');
    const botTitle = document.getElementById('rankBottomTitle');
    if (topTitle) topTitle.textContent = isReal ? 'üèÜ –¢–æ–ø-5 –ø–æ –ø—Ä–∏–±—ã–ª–∏ (—Ñ–∞–∫—Ç)' : 'üèÜ –¢–æ–ø-5 –ø–æ –º–∞—Ä–∂–µ';
    if (botTitle) botTitle.textContent = isReal ? 'üìâ –ù–∞–∏–º–µ–Ω–µ–µ –ø—Ä–∏–±—ã–ª—å–Ω—ã–µ' : '‚ö†Ô∏è –ê—É—Ç—Å–∞–π–¥–µ—Ä—ã –ø–æ –º–∞—Ä–∂–µ';
    const mkRankItem = (x, i, valStr, color) =>
      `<div class="rank-item"><span class="rank-pos">${i+1}</span><span class="rank-nm" title="${x.fullName}">${x.label}</span><span class="rank-vl" style="color:${color}">${valStr}</span></div>`;
    const topEl = document.getElementById('rankTop');
    const botEl = document.getElementById('rankBottom');
    if (topEl) topEl.innerHTML = ranked.slice(0, 5).map((x, i) => {
      const v = isReal ? x.profitActual : x.marginPct;
      const str = isReal ? fmtS(v) : v.toFixed(1) + '%';
      const col = isReal ? (v > 0 ? '#22c55e' : '#ef4444') : (v >= 25 ? '#22c55e' : v >= 15 ? '#f59e0b' : '#ef4444');
      return mkRankItem(x, i, str, col);
    }).join('') || '<span style="color:#4f5a7a;font-size:0.8rem">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>';
    if (botEl) botEl.innerHTML = [...ranked].reverse().slice(0, 5).map((x, i) => {
      const v = isReal ? x.profitActual : x.marginPct;
      const str = isReal ? fmtS(v) : v.toFixed(1) + '%';
      const col = isReal ? '#ef4444' : (v < 10 ? '#ef4444' : v < 20 ? '#f59e0b' : '#94a3b8');
      return mkRankItem(x, i, str, col);
    }).join('') || '<span style="color:#4f5a7a;font-size:0.8rem">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>';

    // ‚îÄ‚îÄ Chart 7: Inventory ‚Äî sold vs remaining (unique products with sold data) ‚îÄ‚îÄ
    if (chInventory) chInventory.destroy();
    const invProds = [...uProds].filter(p => p.stockSold > 0 || p.stockRemaining > 0)
      .sort((a, b) => (b.stockSold / Math.max(b.stockSold + b.stockRemaining, 1)) - (a.stockSold / Math.max(a.stockSold + a.stockRemaining, 1)))
      .slice(0, 20);
    const invCanvas = document.getElementById('chartInventory');
    if (invCanvas) {
      if (invProds.length > 0 && invProds.some(p => p.stockSold > 0)) {
        chInventory = new Chart(invCanvas, {
          type: 'bar',
          data: {
            labels: invProds.map(p => p.label),
            datasets: [
              { label: '–ü—Ä–æ–¥–∞–Ω–æ', data: invProds.map(p => p.stockSold),     backgroundColor: 'rgba(34,197,94,0.85)', borderRadius: 4, borderSkipped: false },
              { label: '–û—Å—Ç–∞—Ç–æ–∫', data: invProds.map(p => p.stockRemaining), backgroundColor: 'rgba(99,102,241,0.45)', borderRadius: 4, borderSkipped: false }
            ]
          },
          options: {
            indexAxis: 'y', responsive: true, maintainAspectRatio: false,
            plugins: {
              legend: { display: true, labels: { color: '#94a3b8', font: FONT, boxWidth: 12 } },
              tooltip: { callbacks: { label: ctx => `${ctx.dataset.label}: ${ctx.parsed.x} —à—Ç` } }
            },
            scales: {
              x: { ...axisStyle, stacked: true, ticks: { ...axisStyle.ticks, callback: v => v + ' —à—Ç' } },
              y: { ...axisStyle, stacked: true }
            }
          }
        });
      } else {
        invCanvas.style.display = 'none';
        invCanvas.closest('.chart-wrap').innerHTML = '<div style="text-align:center;padding:40px;color:#4f5a7a;font-size:0.85rem">–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –æ –ø—Ä–æ–¥–∞–∂–∞—Ö<br>–≤ –∫–æ–ª–æ–Ω–∫–µ <b style="color:#94a3b8">–ü—Ä–æ–¥–∞–Ω–æ</b> ‚Äî –≥—Ä–∞—Ñ–∏–∫ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å</div>';
      }
    }

    // ‚îÄ‚îÄ Chart 8: Max ACoS (unique products, sorted by ACoS asc = worst first) ‚îÄ‚îÄ
    if (chAcos) chAcos.destroy();
    const acosProds = [...uProds].filter(p => p.marginPct > 0).sort((a, b) => a.marginPct - b.marginPct).slice(0, 20);
    const acosCanvas = document.getElementById('chartAcos');
    if (acosCanvas && acosProds.length > 0) {
      chAcos = new Chart(acosCanvas, {
        type: 'bar',
        data: {
          labels: acosProds.map(p => p.label),
          datasets: [{
            label: 'Max ACoS %',
            data: acosProds.map(p => parseFloat(p.marginPct.toFixed(1))),
            backgroundColor: acosProds.map(p => p.marginPct >= 30 ? 'rgba(34,197,94,0.85)' : p.marginPct >= 20 ? 'rgba(245,158,11,0.85)' : 'rgba(239,68,68,0.85)'),
            borderRadius: 5, borderSkipped: false
          }]
        },
        options: {
          indexAxis: 'y', responsive: true, maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: ctx => `Max ACoS: ${ctx.parsed.x}% ‚Äî –º–æ–∂–Ω–æ —Ç—Ä–∞—Ç–∏—Ç—å –Ω–∞ —Ä–µ–∫–ª–∞–º—É –¥–æ ${ctx.parsed.x}% –æ—Ç –≤—ã—Ä—É—á–∫–∏ –±–µ–∑ —É–±—ã—Ç–∫–∞` } }
          },
          scales: {
            x: { ...axisStyle, ticks: { ...axisStyle.ticks, callback: v => v + '%' } },
            y: { ...axisStyle }
          }
        }
      });
    }
    } catch(err) {
      console.error('renderCharts error:', err);
      showToast('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏: ' + err.message, 'error');
    }
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  //  Bulk operations
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function bulkAddCost() {
    const val = parseFloat(document.getElementById('bulkAddCost').value) || 0;
    if (val === 0) return;
    const cur = parseFloat(document.getElementById('marketing').value) || 0;
    document.getElementById('marketing').value = (cur + val).toFixed(0);
    document.getElementById('bulkAddCost').value = '';
    flash('bulkAddCost');
    recalc();
  }

  function bulkChangeUsd() {
    const pct = parseFloat(document.getElementById('bulkUsdPct').value) || 0;
    if (pct === 0) return;
    const factor = 1 + pct / 100;
    rows.forEach(id => {
      const el = document.getElementById('usd-' + id);
      if (el) el.value = ((parseFloat(el.value) || 0) * factor).toFixed(2);
    });
    document.getElementById('bulkUsdPct').value = '';
    recalc();
  }

  function bulkSetUsd() {
    const val = parseFloat(document.getElementById('bulkSetUsd').value);
    if (!val || val <= 0) return;
    rows.forEach(id => {
      const el = document.getElementById('usd-' + id);
      if (el) el.value = val.toFixed(2);
    });
    document.getElementById('bulkSetUsd').value = '';
    recalc();
  }

  function bulkSetQty() {
    const val = parseInt(document.getElementById('bulkSetQty').value);
    if (!val || val <= 0) return;
    rows.forEach(id => {
      const el = document.getElementById('qty-' + id);
      if (el) el.value = val;
    });
    document.getElementById('bulkSetQty').value = '';
    recalc();
  }

  function bulkSetLogistics() {
    const val = parseFloat(document.getElementById('bulkSetLogistics').value);
    if (isNaN(val) || val < 0) return;
    rows.forEach(id => {
      const tr = document.getElementById('row-' + id);
      if (tr) tr.setAttribute('data-logistics', val);
    });
    document.getElementById('bulkSetLogistics').value = '';
    flash('bulkSetLogistics');
    recalc(); scheduleSave();
  }

  function flash(inputId) {
    const el = document.getElementById(inputId);
    if (!el) return;
    el.style.borderColor = '#22c55e';
    setTimeout(() => { el.style.borderColor = ''; }, 1000);
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  //  Clear / Export
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function clearAll() {
    if (rows.length === 0) return;
    showConfirm('–û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã? –û–Ω–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –∞—Ä—Ö–∏–≤.', () => {
      // Move all to archive
      rows.forEach(id => {
        const code  = document.getElementById('code-' + id)?.value || '';
        const name  = document.getElementById('name-' + id)?.value || '';
        const usd   = parseFloat(document.getElementById('usd-' + id)?.value) || 0;
        const qty   = parseInt(document.getElementById('qty-' + id)?.value)   || 6;
        const trEl  = document.getElementById('row-' + id);
        const photo = trEl?.querySelector('img.row-thumb')?.src || null;
        const sizeEl= trEl?.querySelector('.size-badge');
        const size  = sizeEl ? sizeEl.textContent.trim() : null;
        archive.unshift({ archiveId: Date.now() + Math.random(), code, name, usd, qty, photo, size,
          deletedAt: new Date().toLocaleTimeString('ru-RU', { hour:'2-digit', minute:'2-digit' }) });
      });
      rows = []; rowCounter = 0;
      document.getElementById('tableBody').innerHTML = '';
      document.getElementById('emptyHint').style.display = 'block';
      lastChartData = null;
      recalc();
      renderArchive();
    });
  }

  function exportCSV() {
    const totalLog   = g('totalLogistics');
    const commPct    = g('commission');
    const marketUnit = g('marketing');
    const comm       = commPct / 100;
    let totalUnits = 0;
    rows.forEach(id => { totalUnits += parseFloat(document.getElementById('qty-' + id)?.value) || 0; });
    const logPerUnit = totalUnits > 0 && totalLog > 0 ? totalLog / totalUnits : 0;

    let csv = '–ö–æ–¥;–ù–∞–∑–≤–∞–Ω–∏–µ;–¶–µ–Ω–∞ USD;–ö—É—Ä—Å;–ö–æ–ª-–≤–æ;–ú–∞—Ä–∂–∞%;–õ–æ–≥–∏—Å—Ç–∏–∫–∞/—é–Ω–∏—Ç;–ö–æ–º–∏—Å—Å–∏—è/—é–Ω–∏—Ç;–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥/—é–Ω–∏—Ç;–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å;–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏;–ü—Ä–∏–±—ã–ª—å/—é–Ω–∏—Ç\n';
    rows.forEach(id => {
      const trEl  = document.getElementById('row-' + id);
      const code  = document.getElementById('code-' + id)?.value || '';
      const name  = document.getElementById('name-' + id)?.value || '';
      const usd   = parseFloat(document.getElementById('usd-' + id)?.value) || 0;
      const qty   = parseFloat(document.getElementById('qty-' + id)?.value) || 1;
      const rowR  = parseFloat(trEl?.getAttribute('data-rate'))      || defaultRate;
      const rowMp = parseInt(trEl?.getAttribute('data-margin'))       || 30;
      const rowLg = parseFloat(trEl?.getAttribute('data-logistics'))  || 0;
      const effLog = rowLg > 0 ? rowLg : logPerUnit;
      const denom = 1 - (rowMp / 100) - comm;
      const cogs = (usd * rowR) + effLog + marketUnit;
      const price = denom > 0 && cogs > 0 ? cogs / denom : 0;
      const commAmt = price * comm;
      const profit = price - cogs - commAmt;
      csv += `"${code}";"${name}";${usd};${rowR};${qty};${rowMp}%;${Math.round(effLog)};${Math.round(commAmt)};${Math.round(marketUnit)};${Math.round(cogs)};${Math.round(price)};${Math.round(profit)}\n`;
    });
    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = '–ø—Ä–∞–π—Å_—Ç–æ–≤–∞—Ä–æ–≤.csv';
    a.click();
  }

  // ‚îÄ‚îÄ Files dropdown ‚îÄ‚îÄ
  function toggleFilesMenu() {
    const m = document.getElementById('filesMenu');
    if (!m) return;
    const isOpen = m.style.display !== 'none';
    m.style.display = isOpen ? 'none' : '';
    if (!isOpen) {
      setTimeout(() => document.addEventListener('click', _filesMenuOutside, { once: true }), 10);
    }
  }
  function _filesMenuOutside(e) {
    if (!document.getElementById('filesMenuWrap')?.contains(e.target)) closeFilesMenu();
  }
  function closeFilesMenu() {
    const m = document.getElementById('filesMenu');
    if (m) m.style.display = 'none';
  }

  // ‚îÄ‚îÄ Params bar toggle ‚îÄ‚îÄ
  function toggleParamsBar() {
    const body = document.getElementById('paramsBarBody');
    const chevron = document.getElementById('paramsBarChevron');
    if (!body) return;
    const open = body.style.display !== 'none';
    body.style.display = open ? 'none' : '';
    if (chevron) chevron.textContent = open ? '‚ñæ' : '‚ñ¥';
  }
  function updateParamsSummary() {
    const log = parseFloat(document.getElementById('totalLogistics')?.value) || 0;
    const com = parseFloat(document.getElementById('commission')?.value)     || 0;
    const mkt = parseFloat(document.getElementById('marketing')?.value)      || 0;
    const el = document.getElementById('paramsBarSummary');
    if (el) el.textContent = `–õ–æ–≥–∏—Å—Ç–∏–∫–∞: ${log.toLocaleString('ru')} —Å—É–º ¬∑ –ö–æ–º–∏—Å—Å–∏—è: ${com}% ¬∑ –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥: ${mkt.toLocaleString('ru')} —Å—É–º`;
  }

  // ‚îÄ‚îÄ Bulk card toggle ‚îÄ‚îÄ
  function toggleBulkCard() {
    const body = document.getElementById('bulkCardBody');
    const chevron = document.getElementById('bulkChevron');
    if (!body) return;
    const open = body.style.display !== 'none';
    body.style.display = open ? 'none' : '';
    if (chevron) chevron.textContent = open ? '‚ñ∏' : '‚ñæ';
  }

  function setMarginAlert(val) {
    minMarginAlert = parseFloat(val) || 0;
    recalc();
    scheduleSave();
  }

  function editInlineMargin(id) {
    const tag = document.getElementById('mtag-' + id);
    if (!tag || tag.querySelector('input')) return; // already editing
    const tr = document.getElementById('row-' + id);
    const current = parseInt(tr?.getAttribute('data-margin')) || 30;
    const input = document.createElement('input');
    input.type = 'number'; input.value = current; input.min = 1; input.max = 99;
    input.style.cssText = 'width:42px;font-size:0.72rem;padding:1px 4px;border-radius:4px;border:1px solid #6366f1;background:#1a1d2e;color:#e2e8f0;text-align:center;outline:none';
    const commit = () => {
      const val = Math.max(1, Math.min(99, parseInt(input.value) || current));
      if (tr) tr.setAttribute('data-margin', val);
      tag.textContent = val + '%';
      recalc(); scheduleSave();
    };
    input.addEventListener('blur', commit);
    input.addEventListener('keydown', e => {
      if (e.key === 'Enter')  { e.preventDefault(); commit(); input.blur(); }
      if (e.key === 'Escape') { tag.textContent = current + '%'; }
    });
    tag.textContent = '';
    tag.appendChild(input);
    input.focus(); input.select();
  }

  function setAnalyticsMode(mode) {
    analyticsMode = mode;
    document.getElementById('modeRealBtn')?.classList.toggle('active', mode === 'real');
    document.getElementById('modeForecastBtn')?.classList.toggle('active', mode === 'forecast');
    if (lastChartData) renderCharts(lastChartData);
  }

  function toggleSimCard() {
    const c = document.getElementById('simCard');
    if (c) c.style.display = c.style.display === 'none' ? '' : 'none';
  }

  function updateSimulator() {
    const cd = lastChartData;
    const el = document.getElementById('simResults');
    if (!el) return;
    if (!cd || cd.labels.length === 0) { el.innerHTML = '<span style="color:#4f5a7a">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</span>'; return; }
    const disc   = parseFloat(document.getElementById('simDiscountRange')?.value) || 0;
    const target = parseFloat(document.getElementById('simTarget')?.value) || 0;
    const totalRevenue = cd.revenueTotal.reduce((s, v) => s + v, 0);
    let html = '';
    if (disc > 0) {
      let discRevenue = 0, discProfit = 0;
      cd.pricePerUnit.forEach((price, i) => {
        if (!price) return;
        const qty      = cd.revenueTotal[i] / price;
        const cogs     = price - cd.profitPerUnit[i];
        const newPrice = price * (1 - disc / 100);
        discRevenue   += newPrice * qty;
        discProfit    += (newPrice - cogs) * qty;
      });
      const marginPct = discRevenue > 0 ? (discProfit / discRevenue * 100).toFixed(1) : '‚Äî';
      html += `<span style="color:#818cf8">–°–∫–∏–¥–∫–∞ ${disc}%:</span> –≤—ã—Ä—É—á–∫–∞ <b>${fmtM(discRevenue)} —Å—É–º</b> ¬∑ –ø—Ä–∏–±—ã–ª—å <b style="color:${discProfit >= 0 ? '#22c55e' : '#ef4444'}">${fmtM(discProfit)} —Å—É–º</b> ¬∑ –º–∞—Ä–∂–∞ <b>${marginPct}%</b><br>`;
    }
    if (target > 0 && totalRevenue > 0) {
      const ratio      = target / totalRevenue;
      const neededQty  = cd.pricePerUnit.reduce((s, price, i) => s + (price > 0 ? Math.ceil(cd.revenueTotal[i] / price * ratio) : 0), 0);
      html += `<span style="color:#06b6d4">–¶–µ–ª—å ${fmtM(target)} —Å—É–º:</span> –Ω—É–∂–Ω–æ ~<b>${neededQty} —à—Ç</b> (${Math.round(ratio * 100)}% –ø–∞—Ä—Ç–∏–∏)`;
    }
    el.innerHTML = html || '<span style="color:#4f5a7a">–í–≤–µ–¥–∏—Ç–µ —Å–∫–∏–¥–∫—É –∏–ª–∏ —Ü–µ–ª–µ–≤—É—é –≤—ã—Ä—É—á–∫—É</span>';
  }

  function exportXLSX() {
    if (typeof XLSX === 'undefined') { showToast('XLSX –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞', 'error'); return; }
    if (rows.length === 0) { showToast('–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞', 'warning'); return; }
    const totalLog   = g('totalLogistics');
    const commPct    = g('commission');
    const marketUnit = g('marketing');
    const comm = commPct / 100;
    let totalUnits = 0;
    rows.forEach(id => { totalUnits += parseFloat(document.getElementById('qty-' + id)?.value) || 0; });
    const logPerUnit = totalUnits > 0 && totalLog > 0 ? totalLog / totalUnits : 0;

    const header = ['–ö–æ–¥','–ù–∞–∑–≤–∞–Ω–∏–µ','–†–∞–∑–º–µ—Ä','–¶–µ–Ω–∞ USD','–ö—É—Ä—Å','–ö–æ–ª-–≤–æ','–ú–∞—Ä–∂–∞ %','–õ–æ–≥–∏—Å—Ç–∏–∫–∞/—é–Ω–∏—Ç','–ö–æ–º–∏—Å—Å–∏—è/—é–Ω–∏—Ç','–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥/—é–Ω–∏—Ç','–°–µ–±–µ—Å—Ç–æ–∏–º–æ—Å—Ç—å','–¶–µ–Ω–∞ –ø—Ä–æ–¥–∞–∂–∏','–ü—Ä–∏–±—ã–ª—å/—é–Ω–∏—Ç'];
    const dataRows = rows.map(id => {
      const trEl  = document.getElementById('row-' + id);
      const code  = document.getElementById('code-' + id)?.value || '';
      const name  = document.getElementById('name-' + id)?.value || '';
      const usd   = parseFloat(document.getElementById('usd-' + id)?.value) || 0;
      const qty   = parseFloat(document.getElementById('qty-' + id)?.value) || 1;
      const sizesStr = trEl?.querySelector('.row-size-cell')?.getAttribute('data-sizes') || '';
      const sizes = sizesStr ? sizesStr.split(',').filter(Boolean).join(', ') : '‚Äî';
      const rowR  = parseFloat(trEl?.getAttribute('data-rate'))     || defaultRate;
      const rowMp = parseInt(trEl?.getAttribute('data-margin'))     || 30;
      const rowLg = parseFloat(trEl?.getAttribute('data-logistics')) || 0;
      const effLog = rowLg > 0 ? rowLg : logPerUnit;
      const denom = 1 - (rowMp / 100) - comm;
      const cogs  = (usd * rowR) + effLog + marketUnit;
      const price = denom > 0 && cogs > 0 ? cogs / denom : 0;
      const commAmt = price * comm;
      const profit  = price - cogs - commAmt;
      return [code, name, sizes, usd, rowR, qty, rowMp, Math.round(effLog), Math.round(commAmt), Math.round(marketUnit), Math.round(cogs), Math.round(price), Math.round(profit)];
    });

    const ws = XLSX.utils.aoa_to_sheet([header, ...dataRows]);
    // Column widths
    ws['!cols'] = [10,28,10,10,10,8,8,14,14,14,14,14,14].map(w => ({ wch: w }));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, '–ü—Ä–∞–π—Å');
    XLSX.writeFile(wb, '–ø—Ä–∞–π—Å_—Ç–æ–≤–∞—Ä–æ–≤.xlsx');
    showToast('Excel —Ñ–∞–π–ª —Å–∫–∞—á–∞–Ω', 'success');
  }

  function importXLSX(file) {
    if (!file) return;
    document.getElementById('importXlsxInput').value = '';
    if (typeof XLSX === 'undefined') { showToast('XLSX –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω', 'error'); return; }
    const reader = new FileReader();
    reader.onload = e => {
      try {
        const wb = XLSX.read(new Uint8Array(e.target.result), { type: 'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const rows2d = XLSX.utils.sheet_to_json(ws, { header: 1 });
        if (!rows2d.length) { showToast('–§–∞–π–ª –ø—É—Å—Ç–æ–π', 'warning'); return; }
        const headers = rows2d[0].map(h => String(h || '').toLowerCase());
        const findCol = (...kw) => headers.findIndex(h => kw.some(k => h.includes(k)));
        const colCode   = findCol('–∫–æ–¥', 'code', '–∞—Ä—Ç–∏–∫—É–ª', 'sku');
        const colName   = findCol('–Ω–∞–∏–º', '–Ω–∞–∑–≤', '—Ç–æ–≤–∞—Ä', 'name');
        const colUsd    = findCol('usd', '–¥–æ–ª–ª', '$', '—Ü–µ–Ω–∞', 'price');
        const colQty    = findCol('–∫–æ–ª', 'qty', '–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ');
        const colMargin = findCol('–º–∞—Ä–∂–∞', 'margin');
        if (colName < 0 && colCode < 0) {
          showToast('–ù–µ –Ω–∞–π–¥–µ–Ω—ã –∫–æ–ª–æ–Ω–∫–∏ —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º –∏–ª–∏ –∫–æ–¥–æ–º', 'error'); return;
        }
        const data = rows2d.slice(1).filter(r => r.some(Boolean));
        if (!data.length) { showToast('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–º–ø–æ—Ä—Ç–∞', 'warning'); return; }
        _xlsxPendingData = data;
        _xlsxPendingCols = { colCode, colName, colUsd, colQty, colMargin };
        openXlsxImportModal(data.length);
      } catch(err) {
        showToast('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞', 'error');
        console.error('importXLSX:', err);
      }
    };
    reader.readAsArrayBuffer(file);
  }

  function openXlsxImportModal(count) {
    const countEl = document.getElementById('xlsxImportCount');
    if (countEl) countEl.textContent = `–ë—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–æ ${count} —Ç–æ–≤–∞—Ä–æ–≤. –£–∫–∞–∂–∏—Ç–µ –æ–±—â–∏–µ –∞—Ç—Ä–∏–±—É—Ç—ã:`;

    const catSel = document.getElementById('xlsxImportCat');
    if (catSel) {
      catSel.innerHTML = '<option value="">‚Äî –ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Äî</option>';
      categories.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; catSel.appendChild(o); });
    }
    const ctySel = document.getElementById('xlsxImportCountry');
    if (ctySel) {
      ctySel.innerHTML = '<option value="">‚Äî –ù–µ —É–∫–∞–∑–∞–Ω–∞ ‚Äî</option>';
      countries.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; ctySel.appendChild(o); });
    }
    const supSel = document.getElementById('xlsxImportSupplier');
    if (supSel) {
      supSel.innerHTML = '<option value="">‚Äî –ë–µ–∑ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ ‚Äî</option>';
      suppliers.forEach(s => { const o = document.createElement('option'); o.value = s.name || s; o.textContent = s.name || s; supSel.appendChild(o); });
    }

    const modal = document.getElementById('xlsxImportModal');
    if (modal) modal.classList.add('open');
  }

  function closeXlsxImportModal() {
    const modal = document.getElementById('xlsxImportModal');
    if (modal) modal.classList.remove('open');
    _xlsxPendingData = null;
    _xlsxPendingCols = null;
  }

  function doXlsxImport() {
    if (!_xlsxPendingData || !_xlsxPendingCols) return;
    const { colCode, colName, colUsd, colQty, colMargin } = _xlsxPendingCols;
    const category = document.getElementById('xlsxImportCat')?.value   || '';
    const country  = document.getElementById('xlsxImportCountry')?.value || '';
    const supplier = document.getElementById('xlsxImportSupplier')?.value || '';
    let added = 0;
    _xlsxPendingData.forEach(r => {
      const code   = colCode   >= 0 ? String(r[colCode]   || '') : '';
      const name   = colName   >= 0 ? String(r[colName]   || '') : '';
      const usd    = colUsd    >= 0 ? parseFloat(r[colUsd])   || 0 : 0;
      const qty    = colQty    >= 0 ? parseInt(r[colQty])     || 6 : 6;
      const margin = colMargin >= 0 ? parseInt(r[colMargin])  || 30 : 30;
      if (!name && !code) return;
      addRow({ code, name, usd, qty, margin, category, country, supplier });
      added++;
    });
    closeXlsxImportModal();
    showToast(`–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–æ ${added} —Ç–æ–≤–∞—Ä–æ–≤`, 'success');
    recalc(); scheduleSave();
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  //  Telegram notifications
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function saveTgSettings() {
    tgBotToken = (document.getElementById('tgToken')?.value || '').trim();
    tgChatId   = (document.getElementById('tgChat')?.value  || '').trim();
    scheduleSave();
  }

  async function sendTgNotify(message) {
    if (!tgBotToken || !tgChatId) return;
    try {
      await fetch('/api/telegram-notify', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({ botToken: tgBotToken, chatId: tgChatId, message }),
      });
    } catch (e) {
      console.warn('Telegram notify failed:', e);
    }
  }

  async function testTgNotify() {
    if (!tgBotToken || !tgChatId) {
      showToast('–ó–∞–ø–æ–ª–Ω–∏ Bot Token –∏ Chat ID', 'warning'); return;
    }
    showToast('–û—Ç–ø—Ä–∞–≤–∫–∞...', 'info');
    const resp = await fetch('/api/telegram-notify', {
      method: 'POST',
      headers: { 'content-type': 'application/json' },
      body: JSON.stringify({ botToken: tgBotToken, chatId: tgChatId, message: '‚úÖ –ü—Ä–∞–π—Å–µ—Ä –ø–æ–¥–∫–ª—é—á—ë–Ω! –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω—É–ª–µ–≤–æ–º –æ—Å—Ç–∞—Ç–∫–µ –±—É–¥—É—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å —Å—é–¥–∞.' }),
    });
    const data = await resp.json();
    if (data.ok) showToast('–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!', 'success');
    else showToast('–û—à–∏–±–∫–∞: ' + (data.description || '–Ω–µ–≤–µ—Ä–Ω—ã–π —Ç–æ–∫–µ–Ω/chat_id'), 'error');
  }

  // Track zero-stock set across inventory snapshots
  let _prevZeroSet = new Set();
  function checkZeroStockAlerts(inventory) {
    if (!tgBotToken || !tgChatId) return;
    const currentZero = new Set(inventory.filter(i => (i.onHand || 0) <= 0).map(i => i.id));
    const newZeros = [...currentZero].filter(id => !_prevZeroSet.has(id));
    if (newZeros.length > 0) {
      const names = newZeros.map(id => {
        const item = inventory.find(i => i.id === id);
        return item ? `‚Ä¢ ${item.name || item.sku}${item.size ? ' (' + item.size + ')' : ''}` : id;
      }).join('\n');
      sendTgNotify(`‚ö†Ô∏è <b>–ù—É–ª–µ–≤–æ–π –æ—Å—Ç–∞—Ç–æ–∫!</b>\n${names}`);
    }
    _prevZeroSet = currentZero;
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  //  Public price list
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function openPublicLink() {
    if (!publicToken) {
      publicToken = Math.random().toString(36).slice(2, 14);
      saveToFirestore();
    }
    const url = `${location.origin}/public.html?t=${publicToken}`;
    navigator.clipboard.writeText(url).then(() => {
      showToast('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞! –û—Ç–ø—Ä–∞–≤—å –∫–ª–∏–µ–Ω—Ç–∞–º.', 'success');
    }).catch(() => {
      prompt('–°–∫–æ–ø–∏—Ä—É–π —Å—Å—ã–ª–∫—É:', url);
    });
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  //  Price history
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function openPriceHist(id) {
    const code = document.getElementById('code-' + id)?.value || '';
    const name = document.getElementById('name-' + id)?.value || '';
    const titleEl   = document.getElementById('priceHistTitle');
    const contentEl = document.getElementById('priceHistContent');
    if (titleEl) titleEl.textContent = (code || name) || '–¢–æ–≤–∞—Ä';
    if (contentEl) contentEl.innerHTML = '<div style="color:#4f5a7a;font-size:0.84rem">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
    document.getElementById('priceHistModal').classList.add('open');

    if (!db) { contentEl.innerHTML = '<div style="color:#4f5a7a">Firebase –Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω</div>'; return; }
    col('price_history')
      .where('rowId', '==', id)
      .orderBy('changedAt', 'desc')
      .limit(30)
      .get()
      .then(snap => {
        if (!contentEl) return;
        if (snap.empty) {
          contentEl.innerHTML = '<div style="color:#4f5a7a;font-size:0.84rem;padding:8px 0">–ò–∑–º–µ–Ω–µ–Ω–∏–π —Ü–µ–Ω—ã –ø–æ–∫–∞ –Ω–µ—Ç</div>';
          return;
        }
        contentEl.innerHTML = snap.docs.map(d => {
          const h  = d.data();
          const dt = h.changedAt?.toDate ? h.changedAt.toDate().toLocaleString('ru-RU', { day:'2-digit', month:'2-digit', year:'numeric', hour:'2-digit', minute:'2-digit' }) : '‚Äî';
          const diff  = (h.newUsd - h.oldUsd).toFixed(2);
          const sign  = h.newUsd >= h.oldUsd ? '+' : '';
          const color = h.newUsd >= h.oldUsd ? '#22c55e' : '#ef4444';
          return `<div style="display:flex;justify-content:space-between;align-items:center;padding:9px 0;border-bottom:1px solid #1e2235;font-size:0.82rem;gap:12px">
            <span style="color:#4f5a7a;white-space:nowrap">${dt}</span>
            <span style="color:#94a3b8">$${h.oldUsd} ‚Üí <span style="color:#e2e8f0;font-weight:700">$${h.newUsd}</span>
              <span style="color:${color};margin-left:4px">(${sign}${diff})</span></span>
          </div>`;
        }).join('');
      })
      .catch(e => {
        if (contentEl) contentEl.innerHTML = `<div style="color:#ef4444;font-size:0.82rem">${escH(e.message)}</div>`;
      });
  }

  function closePriceHist() {
    document.getElementById('priceHistModal').classList.remove('open');
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  //  Firebase Firestore Sync
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const SESSION_ID = Math.random().toString(36).slice(2, 10);
  let isLoading = false;
  let saveTimer = null;
  let db = null;

  const firebaseConfig = {
    apiKey: "AIzaSyC2C4sTSXcJby_fCCsUic3IObmAp4epHnQ",
    authDomain: "finance-93c77.firebaseapp.com",
    projectId: "finance-93c77",
    storageBucket: "finance-93c77.firebasestorage.app",
    messagingSenderId: "508049353884",
    appId: "1:508049353884:web:ace50988daf50905c91159",
    measurementId: "G-H2LHRQR4LB"
  };

  firebase.initializeApp(firebaseConfig);
  db = firebase.firestore();

  let auth;
  let currentUser = null;

  // Per-user Firestore collection helper
  function col(name) {
    return db.collection('users').doc(currentUser.uid).collection(name);
  }

  function setSyncStatus(state, text) {
    const badge  = document.getElementById('syncBadge');
    const textEl = document.getElementById('syncText');
    if (!badge || !textEl) return;
    badge.className = 'sync-badge ' + state;
    textEl.textContent = text;
  }

  function scheduleSave() {
    if (isLoading) return;
    clearTimeout(saveTimer);
    setSyncStatus('syncing', '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...');
    saveTimer = setTimeout(saveToFirestore, 900);
  }

  function saveToFirestore() {
    if (!db) return;

    // Collect products without photos (Firestore 1 MB limit)
    const products = rows.map(id => {
      const sizeCell = document.getElementById('row-' + id)?.querySelector('.row-size-cell');
      const sizesStr = sizeCell?.getAttribute('data-sizes') || '';
      return {
        id,
        code:  document.getElementById('code-' + id)?.value || '',
        name:  document.getElementById('name-' + id)?.value || '',
        usd:   parseFloat(document.getElementById('usd-'  + id)?.value) || 0,
        qty:   parseInt(document.getElementById('qty-'    + id)?.value)  || 6,
        sizes:     sizesStr ? sizesStr.split(',').filter(Boolean) : [],
        margin:    parseInt(document.getElementById('row-'  + id)?.getAttribute('data-margin'))    || 30,
        rate:      parseFloat(document.getElementById('row-' + id)?.getAttribute('data-rate'))     || defaultRate,
        logistics: parseFloat(document.getElementById('row-' + id)?.getAttribute('data-logistics')) || 0,
        category:  document.getElementById('row-' + id)?.getAttribute('data-category') || '',
        country:   document.getElementById('row-' + id)?.getAttribute('data-country')  || '',
        supplier:  document.getElementById('row-' + id)?.getAttribute('data-supplier') || '',
        extras:    productExtras[id] || null,
        sold:      parseFloat(document.getElementById('sold-' + id)?.value) || 0
      };
    });

    // Archive ‚Äî strip photos
    const archiveClean = archive.map(item => ({ ...item, photo: null }));

    const payload = {
      params: {
        totalLogistics: parseFloat(document.getElementById('totalLogistics').value) || 0,
        commission:     parseFloat(document.getElementById('commission').value)     || 0,
        marketing:      parseFloat(document.getElementById('marketing').value)      || 0,
        defaultRate
      },
      products,
      archive:     archiveClean,
      shipments,
      shipmentCounter,
      sales,
      salesCounter,
      sizeOptions,
      rowCounter,
      publicToken: publicToken || null,
      tgBotToken:    tgBotToken    || '',
      tgChatId:      tgChatId      || '',
      minMarginAlert: minMarginAlert || 0,
      theme:       localStorage.getItem('theme') || 'dark',
      categories:  categories,
      countries:   countries,
      suppliers:   suppliers,
      updatedBy:   SESSION_ID,
      updatedAt:   firebase.firestore.FieldValue.serverTimestamp()
    };

    col('praicer').doc('workspace').set(payload)
      .then(() => setSyncStatus('synced', '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ ‚úì'))
      .catch(err => {
        console.error('Firestore save error:', err);
        setSyncStatus('error', '–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
      });
  }

  function loadFromFirestore(data) {
    isLoading = true;

    // Restore params
    if (data.params) {
      const p = data.params;
      document.getElementById('totalLogistics').value = p.totalLogistics ?? 0;
      document.getElementById('commission').value     = p.commission     ?? 0;
      document.getElementById('marketing').value      = p.marketing      ?? 0;
      if (p.defaultRate) defaultRate = p.defaultRate;
    }

    // Restore size options
    if (Array.isArray(data.sizeOptions) && data.sizeOptions.length > 0) {
      sizeOptions = data.sizeOptions;
    }

    // Restore rowCounter so new rows don't collide
    if (data.rowCounter) rowCounter = data.rowCounter;

    // Clear table
    rows = [];
    selectedRows.clear();
    document.getElementById('tableBody').innerHTML = '';

    // Restore categories
    if (Array.isArray(data.categories) && data.categories.length > 0) {
      categories = data.categories;
    }
    // Restore countries
    if (Array.isArray(data.countries) && data.countries.length > 0) {
      countries = data.countries;
    }
    // Restore suppliers
    if (Array.isArray(data.suppliers)) {
      suppliers = data.suppliers;
    }

    // Restore products
    productExtras = {};
    if (Array.isArray(data.products)) {
      data.products.forEach(p => {
        addRow({ code: p.code, name: p.name, usd: p.usd, qty: p.qty, sizes: p.sizes || [], margin: p.margin ?? 30, rate: p.rate ?? defaultRate, logistics: p.logistics ?? 0, category: p.category || '', country: p.country || '', supplier: p.supplier || '', extras: p.extras || null, sold: p.sold || 0 });
      });
    }

    // Restore archive
    archive = Array.isArray(data.archive) ? data.archive : [];
    renderArchive();

    // Restore shipment history
    if (Array.isArray(data.shipments)) shipments = data.shipments;
    if (data.shipmentCounter) shipmentCounter = data.shipmentCounter;
    renderShipmentHistory();

    // Restore sales
    if (Array.isArray(data.sales)) { sales = data.sales; salesCounter = data.salesCounter || 0; }
    renderSales();

    // Restore public token + Telegram settings
    if (data.publicToken) publicToken = data.publicToken;
    if (data.tgBotToken)  { tgBotToken = data.tgBotToken; const el = document.getElementById('tgToken'); if (el) el.value = tgBotToken; }
    if (data.tgChatId)    { tgChatId   = data.tgChatId;   const el = document.getElementById('tgChat');  if (el) el.value = tgChatId; }
    if (data.minMarginAlert != null) {
      minMarginAlert = data.minMarginAlert || 0;
      const alertEl = document.getElementById('set-margin-alert');
      if (alertEl) alertEl.value = minMarginAlert || '';
    }
    // Sync theme across devices
    if (data.theme) {
      applyTheme(data.theme);
      localStorage.setItem('theme', data.theme);
    }

    if (rows.length === 0) {
      document.getElementById('emptyHint').style.display = 'block';
    } else {
      document.getElementById('emptyHint').style.display = 'none';
    }

    isLoading = false;
    // Always collapse all groups on load ‚Äî never restore expanded state across refreshes
    expandedGroups.clear();
    regroup();
    recalc();
    updateParamsSummary();
    populateFilterDropdowns();
    if (activeTab === 'dashboard') setTimeout(renderDashboard, 100);
  }

  function startFirebaseSync() {
    setSyncStatus('syncing', '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
    col('praicer').doc('workspace').onSnapshot(
      snap => {
        if (!snap.exists) {
          // Brand new database ‚Äî nothing saved yet
          setSyncStatus('synced', '–ì–æ—Ç–æ–≤–æ (–ø—É—Å—Ç–æ)');
          isLoading = false;
          return;
        }
        const data = snap.data();
        // Skip update triggered by this very session
        if (data.updatedBy === SESSION_ID) {
          setSyncStatus('synced', '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ ‚úì');
          return;
        }
        loadFromFirestore(data);
        setSyncStatus('synced', '–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ ‚úì');
      },
      err => {
        console.error('Firestore listener error:', err);
        setSyncStatus('error', '–ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
      }
    );
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  //  Theme toggle (light / dark)
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function applyTheme(theme) {
    document.documentElement.setAttribute('data-theme', theme);
    const btn = document.getElementById('themeBtn');
    if (btn) btn.textContent = theme === 'light' ? 'üåô' : '‚òÄÔ∏è';
  }

  function toggleTheme() {
    const current = document.documentElement.getAttribute('data-theme') || 'dark';
    const next = current === 'dark' ? 'light' : 'dark';
    applyTheme(next);
    localStorage.setItem('theme', next);
  }

  // Load saved theme on startup
  applyTheme(localStorage.getItem('theme') || 'dark');

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  //  Import from photo (Claude Vision)
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let importPhotoBase64 = null;
  let importPhotoMime   = 'image/jpeg';
  let importMarginVal   = 30;
  let parsedImportProducts = [];

  function openImportModal() {
    document.getElementById('import-rate').value = defaultRate || 12519;
    document.getElementById('import-logistics').value = '';
    importMarginVal = 30;
    _syncImportMarginUI();
    setImportStatus('', '');
    document.getElementById('importProductsWrap').style.display = 'none';
    // Reset photo state
    importPhotoBase64 = null;
    document.getElementById('importDropZone').style.display = '';
    document.getElementById('importPreviewWrap').style.display = 'none';
    document.getElementById('importPreview').src = '';
    // Populate category/country/supplier dropdowns
    const catSel = document.getElementById('import-category');
    if (catSel) {
      catSel.innerHTML = '<option value="">‚Äî –ë–µ–∑ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ ‚Äî</option>';
      categories.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; catSel.appendChild(o); });
    }
    const ctySel = document.getElementById('import-country');
    if (ctySel) {
      ctySel.innerHTML = '<option value="">‚Äî –ù–µ —É–∫–∞–∑–∞–Ω–∞ ‚Äî</option>';
      countries.forEach(c => { const o = document.createElement('option'); o.value = c; o.textContent = c; ctySel.appendChild(o); });
    }
    const supSel = document.getElementById('import-supplier');
    if (supSel) {
      supSel.innerHTML = '<option value="">‚Äî –ë–µ–∑ –ø–æ—Å—Ç–∞–≤—â–∏–∫–∞ ‚Äî</option>';
      suppliers.forEach(s => { const o = document.createElement('option'); o.value = s.name || s; o.textContent = s.name || s; supSel.appendChild(o); });
    }
    // Reset button
    const btn = document.getElementById('importRunBtn');
    btn.textContent = 'üîç –†–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å—á—ë—Ç';
    btn.onclick = runImport;
    btn.disabled = false;
    document.getElementById('importModalOverlay').classList.add('open');
  }

  function closeImportModal() {
    document.getElementById('importModalOverlay').classList.remove('open');
  }

  function handleImportDrop(e) {
    e.preventDefault();
    const file = e.dataTransfer.files[0];
    if (file) _loadImportFile(file);
  }

  function handleImportFile(e) {
    const file = e.target.files[0];
    if (file) _loadImportFile(file);
    e.target.value = '';
  }

  function _loadImportFile(file) {
    if (!file.type.startsWith('image/')) { showToast('–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (JPG, PNG, WEBP)', 'warning'); return; }
    importPhotoMime = file.type;
    const reader = new FileReader();
    reader.onload = ev => {
      const result = ev.target.result;
      importPhotoBase64 = result.split(',')[1];
      document.getElementById('importPreview').src = result;
      document.getElementById('importDropZone').style.display = 'none';
      document.getElementById('importPreviewWrap').style.display = 'block';
    };
    reader.readAsDataURL(file);
  }

  function removeImportPhoto() {
    importPhotoBase64 = null;
    document.getElementById('importPreview').src = '';
    document.getElementById('importDropZone').style.display = '';
    document.getElementById('importPreviewWrap').style.display = 'none';
  }


  function setImportMargin(val, btn) {
    importMarginVal = val;
    _syncImportMarginUI();
  }

  function onImportMarginInput() {
    const v = parseInt(document.getElementById('import-margin-input').value);
    if (!isNaN(v) && v >= 1 && v <= 99) {
      importMarginVal = v;
      document.querySelectorAll('#import-margin-selector .margin-btn').forEach(b => b.classList.remove('active'));
    }
  }

  function _syncImportMarginUI() {
    document.querySelectorAll('#import-margin-selector .margin-btn').forEach(b => {
      b.classList.toggle('active', parseInt(b.textContent) === importMarginVal);
    });
    document.getElementById('import-margin-input').value = importMarginVal;
  }

  function setImportStatus(type, msg) {
    const el = document.getElementById('importStatus');
    if (!type) { el.style.display = 'none'; el.className = 'import-status'; el.textContent = ''; return; }
    el.style.display = '';
    el.className = 'import-status ' + type;
    el.textContent = msg;
  }

  function _escHtml(str) {
    return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  async function runImport() {
    if (!importPhotoBase64) { setImportStatus('error', '–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–æ—Ç–æ —Å—á—ë—Ç–∞'); return; }

    const rate     = parseFloat(document.getElementById('import-rate').value)     || defaultRate || 12519;
    const btn = document.getElementById('importRunBtn');
    btn.disabled  = true;
    btn.textContent = '‚è≥ –†–∞—Å–ø–æ–∑–Ω–∞—ë–º...';
    setImportStatus('loading', '–ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ñ–æ—Ç–æ —Å—á—ë—Ç–∞ —á–µ—Ä–µ–∑ Claude AI...');
    document.getElementById('importProductsWrap').style.display = 'none';

    const prompt = `You are analyzing a supplier invoice/receipt image. Extract every product line item.
Return ONLY a valid JSON array with no markdown fences or explanation. Each element must be:
{"code":"article or stock code","name":"product name","usd":unit_price_as_number,"qty":quantity_as_number}
- If price is not in USD, still put the numeric value in "usd" and append the currency symbol to "name".
- Extract ALL line items visible. Do not skip any row.`;

    try {
      const resp = await fetch('/api/claude-proxy', {
        method: 'POST',
        headers: { 'content-type': 'application/json' },
        body: JSON.stringify({
          model: 'claude-opus-4-6',
          max_tokens: 2048,
          messages: [{
            role: 'user',
            content: [
              { type: 'image', source: { type: 'base64', media_type: importPhotoMime, data: importPhotoBase64 } },
              { type: 'text', text: prompt }
            ]
          }]
        })
      });

      if (!resp.ok) {
        const errData = await resp.json().catch(() => ({}));
        throw new Error(errData?.error?.message || 'HTTP ' + resp.status);
      }

      const data = await resp.json();
      const text = data.content?.[0]?.text || '';

      // Parse JSON array from response
      let products = [];
      try {
        products = JSON.parse(text);
      } catch {
        const match = text.match(/\[[\s\S]*\]/);
        if (match) { try { products = JSON.parse(match[0]); } catch { products = []; } }
      }

      if (!Array.isArray(products) || products.length === 0) {
        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Ç–æ–≤–∞—Ä—ã ‚Äî –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–µ —Ñ–æ—Ç–æ –∏–ª–∏ —É–ª—É—á—à–∏—Ç–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ.');
      }

      // Attach selectedSizes to each product (qty ‚Üí pre-select that many sizes)
      parsedImportProducts = products.map(p => {
        const qty = Math.max(1, +p.qty || 1);
        return { ...p, selectedSizes: sizeOptions.slice(0, qty) };
      });

      // Show preview list with editable size chips
      const listEl = document.getElementById('importProductsList');
      listEl.innerHTML = parsedImportProducts.map((p, idx) => {
        const chips = sizeOptions.map(sz => {
          const on = p.selectedSizes.includes(sz);
          return `<button class="imp-size-chip${on ? ' active' : ''}" onclick="toggleImportSize(${idx},'${sz}',this)">${sz}</button>`;
        }).join('');
        return `<div class="import-product-item">
          <div class="ipi-row">
            <span class="ipi-code">${_escHtml(p.code || '‚Äî')}</span>
            <span class="ipi-name">${_escHtml(p.name || '‚Äî')}</span>
            <span class="ipi-price">$${(+p.usd || 0).toFixed(2)}</span>
          </div>
          <div class="ipi-sizes">${chips}</div>
        </div>`;
      }).join('');
      document.getElementById('importProductCount').textContent = products.length;
      document.getElementById('importProductsWrap').style.display = '';

      setImportStatus('success', '‚úì –ù–∞–π–¥–µ–Ω–æ ' + products.length + ' –ø–æ–∑–∏—Ü–∏–π. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å–ø–∏—Å–æ–∫ –∏ –Ω–∞–∂–º–∏—Ç–µ ¬´–î–æ–±–∞–≤–∏—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É¬ª.');
      btn.textContent = '‚úÖ –î–æ–±–∞–≤–∏—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É';
      btn.onclick = confirmImport;
      btn.disabled = false;

    } catch (e) {
      setImportStatus('error', '‚ùå ' + e.message);
      btn.textContent = 'üîç –†–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å—á—ë—Ç';
      btn.onclick = runImport;
      btn.disabled = false;
    }
  }

  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  //  Shipment history
  // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function createShipment(rowIds, rate) {
    if (!rowIds || rowIds.length === 0) return;
    shipmentCounter++;
    // Calculate totals from rows
    let totalQty = 0, totalUZS = 0;
    rowIds.forEach(id => {
      const usd = parseFloat(document.getElementById('usd-' + id)?.value) || 0;
      const qty = parseFloat(document.getElementById('qty-' + id)?.value) || 1;
      const r   = parseFloat(document.getElementById('row-' + id)?.getAttribute('data-rate')) || rate || 12519;
      totalQty += qty;
      totalUZS += usd * qty * r;
    });
    shipments.unshift({
      id:        's' + shipmentCounter,
      num:       shipmentCounter,
      createdAt: new Date().toISOString(),
      status:    'active',
      rowIds:    [...rowIds],
      qty:       totalQty,
      totalUZS:  Math.round(totalUZS)
    });
    renderShipmentHistory();
    scheduleSave();
  }

  function renderShipmentHistory() {
    const el = document.getElementById('shipmentHistoryList');
    if (!el) return;
    if (shipments.length === 0) {
      el.innerHTML = '<div class="shipment-empty">–ü–æ—Å—Ç–∞–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç.<br>–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é –ø–æ—Å—Ç–∞–≤–∫—É.</div>';
      return;
    }
    el.innerHTML = shipments.map(s => {
      const d = new Date(s.createdAt);
      const dateStr = d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
      const timeStr = d.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
      const cost = s.totalUZS >= 1e6
        ? (s.totalUZS / 1e6).toFixed(1) + 'M'
        : (s.totalUZS / 1e3).toFixed(0) + 'K';
      return `<div class="shipment-card" onclick="highlightShipment('${s.id}')">
        <div class="shipment-card-head">
          <span class="shipment-badge active">–ü—Ä–∏–Ω—è—Ç–∞</span>
          <span class="shipment-num">#${String(s.num).padStart(3,'0')}</span>
        </div>
        <div class="shipment-date">${dateStr}, ${timeStr}</div>
        <div class="shipment-meta">${s.qty} —à—Ç &nbsp;¬∑&nbsp; ${cost} —Å—É–º</div>
      </div>`;
    }).join('');
  }

  // ‚îÄ‚îÄ Sales tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function setSaleStatus(s) {
    _saleStatus = s;
    document.getElementById('slStatusDelivered').className = 'btn-wh ' + (s==='delivered' ? 'btn-wh-primary' : 'btn-wh-ghost');
    document.getElementById('slStatusReturned').className  = 'btn-wh ' + (s==='returned'  ? 'btn-wh-primary' : 'btn-wh-ghost');
  }

  function slAutoFillName() {
    const sku = (document.getElementById('slSku')?.value||'').toLowerCase();
    const match = rows.find(id => (document.getElementById('code-'+id)?.value||'').toLowerCase() === sku);
    if (match) document.getElementById('slName').value = document.getElementById('name-'+match)?.value || '';
  }

  function openSaleModal() {
    _saleStatus = 'delivered';
    setSaleStatus('delivered');
    ['slCreatedAt','slReceivedAt','slOrderNum','slSku','slName'].forEach(id => { const el=document.getElementById(id); if(el) el.value=''; });
    ['slQty','slPrice','slPayout'].forEach(id => { const el=document.getElementById(id); if(el) el.value=''; });
    document.getElementById('slQty').value = '1';
    const dl = document.getElementById('slSkuList');
    if (dl) dl.innerHTML = rows.map(id => `<option value="${escH(document.getElementById('code-'+id)?.value||'')}">`).join('');
    document.getElementById('saleModal').classList.add('open');
  }

  function closeSaleModal() {
    document.getElementById('saleModal').classList.remove('open');
  }

  function submitSaleModal() {
    const createdAt  = document.getElementById('slCreatedAt')?.value.trim() || '';
    const orderNum   = document.getElementById('slOrderNum')?.value.trim()  || '';
    const name       = document.getElementById('slName')?.value.trim()      || '';
    if (!createdAt) { showToast('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É —Å–æ–∑–¥–∞–Ω–∏—è', 'warning'); return; }
    if (!name && !orderNum) { showToast('–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –∏–ª–∏ ‚Ññ –∑–∞–∫–∞–∑–∞', 'warning'); return; }
    salesCounter++;
    sales.unshift({
      id:         salesCounter,
      status:     _saleStatus,
      createdAt,
      receivedAt: document.getElementById('slReceivedAt')?.value.trim() || '',
      orderNum,
      sku:        document.getElementById('slSku')?.value.trim()   || '',
      name,
      qty:        parseInt(document.getElementById('slQty')?.value)   || 1,
      price:      parseFloat(document.getElementById('slPrice')?.value)  || 0,
      payout:     parseFloat(document.getElementById('slPayout')?.value) || 0,
    });
    closeSaleModal();
    renderSales();
    scheduleSave();
    showToast('–ü—Ä–æ–¥–∞–∂–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞', 'success', 2500);
  }

  function deleteSale(id) {
    showConfirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø—Ä–æ–¥–∞–∂—É?', () => {
      sales = sales.filter(s => s.id !== id);
      renderSales();
      scheduleSave();
    });
  }

  function renderSales() {
    const search = (document.getElementById('slSearch')?.value||'').toLowerCase();
    const filter = document.getElementById('slFilter')?.value || '';
    const items = sales.filter(s => {
      if (filter && s.status !== filter) return false;
      if (search && !((s.sku||'').toLowerCase().includes(search) || (s.name||'').toLowerCase().includes(search) || (s.orderNum||'').includes(search))) return false;
      return true;
    });

    const delivered = sales.filter(s => s.status === 'delivered');
    const set = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v; };
    set('slKpiTotal',   sales.length);
    set('slKpiRevenue', delivered.reduce((acc,i) => acc + (i.price||0)*(i.qty||1), 0).toLocaleString('ru-RU') + ' —Å—É–º');
    set('slKpiPayout',  delivered.reduce((acc,i) => acc + (i.payout||0), 0).toLocaleString('ru-RU') + ' —Å—É–º');
    set('slKpiReturns', sales.filter(s => s.status === 'returned').length);

    const body = document.getElementById('slBody');
    if (!body) return;

    if (items.length === 0) {
      body.innerHTML = `<tr><td colspan="10"><div class="wh-empty"><div class="wh-empty-icon">üí∞</div><div>${sales.length===0?'–ù–µ—Ç –ø—Ä–æ–¥–∞–∂ ‚Äî –Ω–∞–∂–º–∏—Ç–µ ‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–¥–∞–∂—É':'–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'}</div></div></td></tr>`;
    } else {
      body.innerHTML = items.map(s => `<tr>
        <td>${s.status==='delivered' ? '<span style="color:#22c55e;font-size:1.1rem">‚úÖ</span>' : '<span style="color:#ef4444;font-size:1.1rem">‚ùå</span>'}</td>
        <td style="white-space:nowrap;font-size:0.8rem">${escH(s.createdAt||'‚Äî')}</td>
        <td style="white-space:nowrap;font-size:0.8rem;color:#64748b">${escH(s.receivedAt||'‚Äî')}</td>
        <td style="font-size:0.8rem;color:#818cf8">${escH(s.orderNum||'‚Äî')}</td>
        <td style="font-size:0.78rem;color:#06b6d4">${escH(s.sku||'‚Äî')}</td>
        <td style="font-size:0.82rem;max-width:200px">${escH(s.name||'‚Äî')}</td>
        <td class="num">${s.qty||1}</td>
        <td class="num">${(s.price||0).toLocaleString('ru-RU')}</td>
        <td class="num" style="color:#22c55e">${(s.payout||0).toLocaleString('ru-RU')}</td>
        <td><button class="btn-del" onclick="deleteSale(${s.id})" title="–£–¥–∞–ª–∏—Ç—å">√ó</button></td>
      </tr>`).join('');
    }
    const footer = document.getElementById('slFooter');
    if (footer) footer.textContent = `–ü–æ–∫–∞–∑–∞–Ω–æ ${items.length} –∏–∑ ${sales.length} –ø—Ä–æ–¥–∞–∂`;
  }
  // ‚îÄ‚îÄ End Sales tab ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  // ‚îÄ‚îÄ Dashboard: batch structure expand/collapse ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function dashRenderBatch(showAll) {
    const sorted = window._batchSorted;
    const esc    = window._batchEscH || (s => s);
    const el     = document.getElementById('dashBatchDetails');
    if (!sorted || !el) return;
    const list   = showAll ? sorted : sorted.slice(0, 6);
    let html = list.map(g =>
      '<div class="dash-row"><span>' + esc(g.label) + '</span>' +
      '<span style="color:#818cf8">' + g.qty + ' —à—Ç ¬∑ ' + Math.round(g.totalCogs).toLocaleString('ru-RU') + ' —Å—É–º</span></div>'
    ).join('');
    if (sorted.length > 6) {
      if (showAll) {
        html += '<button onclick="dashRenderBatch(false)" style="background:none;border:none;color:#4f5a7a;font-size:0.78rem;cursor:pointer;padding:4px 0 0;display:block">‚ñ≤ –°–≤–µ—Ä–Ω—É—Ç—å</button>';
      } else {
        html += '<button onclick="dashRenderBatch(true)" style="background:none;border:none;color:#818cf8;font-size:0.78rem;cursor:pointer;padding:4px 0 0;display:block;text-decoration:underline">‚Üì –µ—â—ë ' + (sorted.length - 6) + ' —Ç–æ–≤–∞—Ä–æ–≤</button>';
      }
    }
    el.innerHTML = html;
  }

  // ‚îÄ‚îÄ –ö—É—Ä—Å –≤–∞–ª—é—Ç –¶–ë –†–£–∑ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function fetchExchangeRate() {
    const usdEl  = document.getElementById('dashRateUSD');
    const eurEl  = document.getElementById('dashRateEUR');
    const rubEl  = document.getElementById('dashRateRUB');
    const dateEl = document.getElementById('dashRateDate');
    if (!usdEl) return;
    try {
      const res  = await fetch('https://cbu.uz/uz/arkhiv-kursov-valyut/json/');
      const data = await res.json();
      const usd  = data.find(c => c.Ccy === 'USD');
      const eur  = data.find(c => c.Ccy === 'EUR');
      const rub  = data.find(c => c.Ccy === 'RUB');
      if (usd) usdEl.textContent  = '1 $ = ' + Math.round(parseFloat(usd.Rate)).toLocaleString('ru-RU') + ' —Å—É–º';
      if (eur && eurEl) eurEl.textContent = '¬∑ 1 ‚Ç¨ = ' + Math.round(parseFloat(eur.Rate)).toLocaleString('ru-RU') + ' —Å—É–º';
      if (rub && rubEl) rubEl.textContent = '¬∑ 1 ‚ÇΩ = ' + parseFloat(rub.Rate).toFixed(2) + ' —Å—É–º';
      if (usd && dateEl) dateEl.textContent = usd.Date;
    } catch(e) {
      if (usdEl) usdEl.textContent = '–Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö';
      console.warn('Rate fetch:', e);
    }
  }

  function highlightShipment(shipmentId) {
    const s = shipments.find(x => x.id === shipmentId);
    if (!s) return;
    showTab('products');
    // Scroll to first row of this shipment
    setTimeout(() => {
      const firstId = s.rowIds[0];
      const tr = document.getElementById('row-' + firstId);
      if (tr) tr.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }, 80);
  }

  function toggleImportSize(idx, size, btn) {
    const p = parsedImportProducts[idx];
    if (!p) return;
    const i = p.selectedSizes.indexOf(size);
    if (i >= 0) p.selectedSizes.splice(i, 1);
    else        p.selectedSizes.push(size);
    btn.classList.toggle('active', p.selectedSizes.includes(size));
  }

  function confirmImport() {
    const rate     = parseFloat(document.getElementById('import-rate').value)     || defaultRate || 12519;
    const totalLog = parseFloat(document.getElementById('import-logistics').value) || 0;
    const category = document.getElementById('import-category')?.value  || '';
    const country  = document.getElementById('import-country')?.value   || '';
    const supplier = document.getElementById('import-supplier')?.value  || '';
    const totalUnits = parsedImportProducts.reduce((s, p) => s + Math.max(1, p.selectedSizes.length), 0);
    const newIds = [];

    parsedImportProducts.forEach(p => {
      const sizes      = p.selectedSizes.length > 0 ? p.selectedSizes : [null];
      const logPerUnit = totalUnits > 0 ? Math.round(totalLog / totalUnits) : 0;
      sizes.forEach(sz => {
        const id = addRow({
          code:      p.code || '',
          name:      p.name || '',
          usd:       +p.usd || 0,
          qty:       1,
          sizes:     sz ? [sz] : [],
          margin:    importMarginVal,
          rate:      rate,
          logistics: logPerUnit,
          category,
          country,
          supplier
        });
        newIds.push(id);
      });
    });

    createShipment(newIds, rate);
    closeImportModal();
    const btn = document.getElementById('importRunBtn');
    btn.textContent = 'üîç –†–∞—Å–ø–æ–∑–Ω–∞—Ç—å —Å—á—ë—Ç';
    btn.onclick = runImport;
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  WAREHOUSE MODULE
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  // ‚îÄ‚îÄ State ‚îÄ‚îÄ
  let whInventory   = [];   // { id, sku, name, size, onHand, avgCostUZS }
  let whMoves       = [];   // stock move docs
  let whSupplies    = [];   // supply docs
  let whWriteoffs   = [];   // write-off docs
  let whInventories = [];   // inventory count docs
  let whCurrentPage = 'wh-stock';
  let whInitialized = false;

  // Session identifier for audit trail (persisted in sessionStorage)
  const WH_SESSION_ID = (() => {
    const key = 'wh_session_id';
    let id = sessionStorage.getItem(key);
    if (!id) { id = 'u_' + Date.now().toString(36); sessionStorage.setItem(key, id); }
    return id;
  })();

  // Working buffers for forms
  let whSupplyItems   = [];
  let whWriteoffItems = [];
  let whInvFormItems  = [];

  // Current edit IDs (null = new)
  let whCurrentSupplyId    = null;
  let whCurrentWriteoffId  = null;
  let whCurrentInventoryId = null;

  // ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ
  const whEsc = escH; // alias ‚Äî same implementation, unified
  function whFmt(n) {
    if (n == null || !isFinite(n)) return '‚Äî';
    return Math.round(n).toLocaleString('ru-RU') + ' —Å—É–º';
  }
  function whToday() {
    return new Date().toISOString().slice(0, 10);
  }

  // ‚îÄ‚îÄ Navigation ‚îÄ‚îÄ
  function showWhPage(page) {
    document.querySelectorAll('.wh-page').forEach(p => p.classList.remove('active'));
    const el = document.getElementById(page);
    if (el) el.classList.add('active');
    whCurrentPage = page;
    // Sync sub-nav active state (only for top-level pages)
    document.querySelectorAll('.wh-subnav-btn').forEach(b =>
      b.classList.toggle('active', b.dataset.wh === page));
  }

  function updateLowStockBadges() {
    rows.forEach(id => {
      const badge = document.getElementById('lowbadge-' + id);
      if (!badge) return;
      const code = (document.getElementById('code-' + id)?.value || '').toLowerCase().trim();
      const name = (document.getElementById('name-' + id)?.value || '').toLowerCase().trim();
      const inv = whInventory.find(i =>
        (i.sku && i.sku.toLowerCase() === code) ||
        (i.name && i.name.toLowerCase() === name)
      );
      if (!inv) { badge.style.display = 'none'; return; }
      const onHand = inv.onHand || 0;
      if (onHand <= 0) {
        badge.textContent = '‚ö† –Ω–µ—Ç'; badge.className = 'low-stock-badge empty'; badge.style.display = '';
      } else if (onHand <= 5) {
        badge.textContent = `‚ö† ${onHand} —à—Ç`; badge.className = 'low-stock-badge warn'; badge.style.display = '';
      } else {
        badge.style.display = 'none';
      }
    });
  }

  // ‚îÄ‚îÄ Import initial stock from Products table ‚îÄ‚îÄ
  async function whImportFromProducts() {
    if (!db) return;
    if (!rows || rows.length === 0) { showToast('–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ –≤ —Ç–∞–±–ª–∏—Ü–µ –¢–æ–≤–∞—Ä–æ–≤', 'warning'); return; }

    // Collect product rows
    const items = rows.map(id => {
      const tr       = document.getElementById('row-' + id);
      const code     = document.getElementById('code-' + id)?.value?.trim() || '';
      const name     = document.getElementById('name-' + id)?.value?.trim() || '';
      const qty      = parseInt(document.getElementById('qty-' + id)?.value) || 0;
      const cogsEl   = document.getElementById('cogs-' + id);
      const cogsText = cogsEl?.textContent?.replace(/[^\d.]/g, '') || '0';
      const cogsUZS  = parseFloat(cogsText) || 0;
      const sizesStr = tr?.querySelector('.row-size-cell')?.getAttribute('data-sizes') || '';
      const firstSize = sizesStr ? sizesStr.split(',')[0] : '';
      return { code, name, qty, cogsUZS, size: firstSize };
    }).filter(i => i.name && i.qty > 0);

    if (items.length === 0) { showToast('–ù–µ—Ç —Ç–æ–≤–∞—Ä–æ–≤ —Å –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º –∏–º–µ–Ω–µ–º –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º', 'warning'); return; }

    showConfirm(
      `–°–æ–∑–¥–∞—Ç—å –Ω–∞—á–∞–ª—å–Ω—ã–µ –æ—Å—Ç–∞—Ç–∫–∏ –¥–ª—è ${items.length} –ø–æ–∑–∏—Ü–∏–π –∏–∑ —Ç–∞–±–ª–∏—Ü—ã –¢–æ–≤–∞—Ä–æ–≤? –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω—ã.`,
      async () => {
        try {
          const batch = db.batch();
          items.forEach(item => {
            const rawKey = `${item.code || item.name}_${item.size}`.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_\-]/g, '') || `inv_${Date.now()}_${Math.random().toString(36).slice(2,6)}`;
            const ref = col('wh_inventory').doc(rawKey);
            batch.set(ref, {
              sku:        item.code,
              name:       item.name,
              size:       item.size,
              onHand:     item.qty,
              avgCostUZS: Math.round(item.cogsUZS)
            }, { merge: true });
          });
          await batch.commit();
          showToast(`–°–æ–∑–¥–∞–Ω–æ ${items.length} –ø–æ–∑–∏—Ü–∏–π –Ω–∞ —Å–∫–ª–∞–¥–µ`, 'success');
        } catch (err) {
          console.error('whImportFromProducts:', err);
          showToast('–û—à–∏–±–∫–∞: ' + err.message, 'error');
        }
      }
    );
  }

  // ‚îÄ‚îÄ Firebase init ‚îÄ‚îÄ
  function initWarehouse() {
    // wh_inventory ‚Äî real-time (no orderBy to avoid missing-index errors; sort client-side)
    col('wh_inventory').onSnapshot(snap => {
      whInventory = snap.docs.map(d => ({ id: d.id, ...d.data() }))
        .sort((a, b) => (a.name || '').localeCompare(b.name || '', 'ru'));
      renderWhStock();
      updateLowStockBadges();
      checkZeroStockAlerts(whInventory);
      if (whCurrentPage === 'wh-inventory-form') buildInventoryRows();
    }, e => { console.error('wh_inventory:', e); showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–∫–ª–∞–¥–∞: ' + e.message, 'error'); });

    // wh_moves ‚Äî last 300 (sort client-side)
    col('wh_moves').limit(300).onSnapshot(snap => {
      whMoves = snap.docs.map(d => ({ id: d.id, ...d.data() }))
        .sort((a, b) => (b.date || '').localeCompare(a.date || ''));
      renderWhMoves();
    }, e => { console.error('wh_moves:', e); showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–≤–∏–∂–µ–Ω–∏–π: ' + e.message, 'error'); });

    // wh_supplies (sort client-side)
    col('wh_supplies').onSnapshot(snap => {
      whSupplies = snap.docs.map(d => ({ id: d.id, ...d.data() }))
        .sort((a, b) => ((b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)));
      renderWhSupplies();
    }, e => { console.error('wh_supplies:', e); showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–∞–≤–æ–∫: ' + e.message, 'error'); });

    // wh_writeoffs (sort client-side)
    col('wh_writeoffs').onSnapshot(snap => {
      whWriteoffs = snap.docs.map(d => ({ id: d.id, ...d.data() }))
        .sort((a, b) => ((b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)));
      renderWhWriteoffs();
    }, e => { console.error('wh_writeoffs:', e); showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∞–Ω–∏–π: ' + e.message, 'error'); });

    // wh_inventories (sort client-side)
    col('wh_inventories').onSnapshot(snap => {
      whInventories = snap.docs.map(d => ({ id: d.id, ...d.data() }))
        .sort((a, b) => ((b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0)));
      renderWhInventories();
    }, e => { console.error('wh_inventories:', e); showToast('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–π: ' + e.message, 'error'); });
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  STOCK PAGE
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function renderWhStock() {
    const search = (document.getElementById('whStockSearch')?.value || '').toLowerCase();
    const filter = document.getElementById('whStockFilter')?.value || '';

    let items = [...whInventory];
    if (search) items = items.filter(i =>
      (i.sku || '').toLowerCase().includes(search) ||
      (i.name || '').toLowerCase().includes(search));
    if (filter === 'positive') items = items.filter(i => (i.onHand || 0) > 0);
    if (filter === 'zero')     items = items.filter(i => (i.onHand || 0) <= 0);

    const body = document.getElementById('whStockBody');
    if (!body) return;

    if (items.length === 0) {
      body.innerHTML = `<tr><td colspan="5">
        <div class="wh-empty"><div class="wh-empty-icon">üì¶</div>
        <div>${whInventory.length === 0 ? '–°–∫–ª–∞–¥ –ø—É—Å—Ç ‚Äî –ø—Ä–æ–≤–µ–¥–∏—Ç–µ –ø–µ—Ä–≤—É—é –ø–æ—Å—Ç–∞–≤–∫—É' : '–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ'}</div></div>
      </td></tr>`;
    } else {
      body.innerHTML = items.map(item => {
        const val = (item.onHand || 0) * (item.avgCostUZS || 0);
        const cls = item.onHand > 5 ? 'stock-ok' : item.onHand > 0 ? 'stock-low' : 'stock-zero';
        return `<tr>
          <td><div style="font-weight:600">${whEsc(item.name)}</div>
              <div class="wh-item-sku">${whEsc(item.sku || '‚Äî')}</div></td>
          <td>${whEsc(item.size || '‚Äî')}</td>
          <td class="num ${cls}">${item.onHand || 0}</td>
          <td class="num">${whFmt(item.avgCostUZS)}</td>
          <td class="num">${whFmt(val)}</td>
        </tr>`;
      }).join('');
    }

    // KPI
    const totalSku   = whInventory.length;
    const totalUnits = whInventory.reduce((s, i) => s + (i.onHand || 0), 0);
    const totalValue = whInventory.reduce((s, i) => s + (i.onHand || 0) * (i.avgCostUZS || 0), 0);
    const avgCost    = totalUnits > 0 ? totalValue / totalUnits : 0;

    const lowStockCount = whInventory.filter(i => (i.onHand || 0) <= 0).length;
    const set = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v; };
    set('whKpiSku',       totalSku);
    set('whKpiTotal',     totalUnits.toLocaleString('ru-RU'));
    set('whKpiValue',     whFmt(totalValue));
    set('whKpiAvgCost',   whFmt(avgCost));
    set('whKpiLowStock',  lowStockCount);
    set('whStockFooter', `–ü–æ–∫–∞–∑–∞–Ω–æ ${items.length} –∏–∑ ${whInventory.length} –ø–æ–∑–∏—Ü–∏–π`);
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  MOVES PAGE
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function renderWhMoves() {
    const search   = (document.getElementById('whMovesSearch')?.value || '').toLowerCase();
    const typeF    = document.getElementById('whMovesTypeFilter')?.value || '';
    const dateFrom = document.getElementById('whMovesDateFrom')?.value || '';
    const dateTo   = document.getElementById('whMovesDateTo')?.value || '';

    let items = [...whMoves];
    if (search)   items = items.filter(i =>
      (i.sku || '').toLowerCase().includes(search) ||
      (i.name || '').toLowerCase().includes(search));
    if (typeF)    items = items.filter(i => i.type === typeF);
    if (dateFrom) items = items.filter(i => (i.date || '') >= dateFrom);
    if (dateTo)   items = items.filter(i => (i.date || '') <= dateTo);

    const body = document.getElementById('whMovesBody');
    if (!body) return;

    if (items.length === 0) {
      body.innerHTML = `<tr><td colspan="8"><div class="wh-empty">–î–≤–∏–∂–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div></td></tr>`;
    } else {
      body.innerHTML = items.map(m => {
        const tc  = m.type === 'IN' ? 'in' : m.type === 'OUT' ? 'out' : 'adjust';
        const sgn = m.type === 'IN' ? '+' : m.type === 'OUT' ? '‚àí' : '¬±';
        const qc  = m.type === 'IN' ? '#22c55e' : m.type === 'OUT' ? '#ef4444' : '#fbbf24';
        let refLabel, refClick;
        if (m.refType === 'supply') {
          refLabel = 'üì¶ –ü–æ—Å—Ç–∞–≤–∫–∞';
          refClick = m.refId ? `onclick="whGoToDoc('supply','${whEsc(m.refId)}')" style="cursor:pointer;text-decoration:underline dotted"` : '';
        } else if (m.refType === 'writeoff') {
          refLabel = 'üóë –°–ø–∏—Å–∞–Ω–∏–µ';
          refClick = m.refId ? `onclick="whGoToDoc('writeoff','${whEsc(m.refId)}')" style="cursor:pointer;text-decoration:underline dotted"` : '';
        } else {
          refLabel = 'üîç –ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è';
          refClick = '';
        }
        return `<tr>
          <td style="white-space:nowrap">${whEsc(m.date || '‚Äî')}</td>
          <td><span class="wh-badge ${tc}">${m.type}</span></td>
          <td><div style="font-weight:600">${whEsc(m.name || '')}</div>
              <div class="wh-item-sku">${whEsc(m.sku || '')}</div></td>
          <td>${whEsc(m.size || '‚Äî')}</td>
          <td class="num" style="color:${qc}">${sgn}${Math.abs(m.qty || 0)}</td>
          <td class="num">${whFmt(m.unitCostUZS)}</td>
          <td class="num">${whFmt(m.totalUZS)}</td>
          <td style="font-size:0.75rem;color:#64748b" ${refClick}>${refLabel}</td>
        </tr>`;
      }).join('');
    }
    const footer = document.getElementById('whMovesFooter');
    if (footer) footer.textContent = `${items.length} –∑–∞–ø–∏—Å–µ–π`;
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  SUPPLIES
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function renderWhSupplies() {
    const body = document.getElementById('whSuppliesBody');
    if (!body) return;

    if (whSupplies.length === 0) {
      body.innerHTML = `<tr><td colspan="9"><div class="wh-empty">
        <div class="wh-empty-icon">üöõ</div>–ü–æ—Å—Ç–∞–≤–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</div></td></tr>`;
      return;
    }

    body.innerHTML = whSupplies.map(s => {
      const rate = s.rate || 1;
      const totalPurchaseUZS = (s.items || []).reduce((sum, it) => {
        const p = s.currency === 'USD' ? it.purchasePrice * rate : it.purchasePrice;
        return sum + p * (it.qty || 0);
      }, 0);
      const totalUZS = totalPurchaseUZS + (s.expenses || 0);
      const stCls   = s.status === 'posted' ? 'posted' : 'draft';
      const stLabel = s.status === 'posted' ? '–ü—Ä–æ–≤–µ–¥–µ–Ω–æ' : '–ß–µ—Ä–Ω–æ–≤–∏–∫';
      return `<tr>
        <td style="white-space:nowrap">${whEsc(s.date || '‚Äî')}</td>
        <td style="font-size:0.8rem">${whEsc(s.supplier || s.note || '‚Äî')}</td>
        <td style="font-size:0.8rem;color:#64748b">${whEsc(s.invoice || '‚Äî')}</td>
        <td class="num">${(s.items || []).length}</td>
        <td class="num">${whFmt(totalUZS)}</td>
        <td><span class="wh-badge ${stCls}">${stLabel}</span></td>
        <td style="text-align:right;white-space:nowrap;display:flex;gap:4px;justify-content:flex-end">
          ${s.status !== 'posted'
            ? `<button class="btn-wh btn-wh-secondary btn-wh-sm" onclick="whEditSupply('${s.id}')">‚úèÔ∏è –ò–∑–º–µ–Ω–∏—Ç—å</button>`
            : ''}
          <button class="btn-wh btn-wh-secondary btn-wh-sm" onclick="printSupplyDoc('${s.id}')" title="–ü–µ—á–∞—Ç—å / PDF">üñ®</button>
        </td>
      </tr>`;
    }).join('');
  }

  function whNewSupply() {
    whCurrentSupplyId = null;
    whSupplyItems = [{ name:'', sku:'', size:'', qty:1, purchasePrice:0 }];
    document.getElementById('whSupplyFormTitle').textContent = '–ù–æ–≤–∞—è –ø–æ—Å—Ç–∞–≤–∫–∞';
    document.getElementById('whSupplyDate').value        = whToday();
    document.getElementById('whSupplyCurrency').value    = 'UZS';
    document.getElementById('whSupplyRate').value        = '';
    document.getElementById('whSupplyExpenses').value    = '';
    document.getElementById('whSupplySupplier').value    = '';
    document.getElementById('whSupplyInvoice').value     = '';
    document.getElementById('whSupplyNote').value        = '';
    document.getElementById('whSupplyRateField').style.display = 'none';
    document.getElementById('whSupplyPostBtn').disabled  = false;
    document.getElementById('whSupplyPostBtn').textContent = '‚úì –ü—Ä–æ–≤–µ—Å—Ç–∏';
    document.getElementById('whSupplyDraftBtn').disabled  = false;
    renderWhSupplyItems();
    showWhPage('wh-supply-form');
  }

  function whEditSupply(id) {
    const sup = whSupplies.find(s => s.id === id);
    if (!sup) return;
    whCurrentSupplyId = id;
    whSupplyItems = (sup.items || []).map(i => ({ ...i }));
    document.getElementById('whSupplyFormTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ—Å—Ç–∞–≤–∫—É';
    document.getElementById('whSupplyDate').value        = sup.date || whToday();
    document.getElementById('whSupplyCurrency').value    = sup.currency || 'UZS';
    document.getElementById('whSupplyRate').value        = sup.rate || '';
    document.getElementById('whSupplyExpenses').value    = sup.expenses || '';
    document.getElementById('whSupplySupplier').value    = sup.supplier || '';
    document.getElementById('whSupplyInvoice').value     = sup.invoice || '';
    document.getElementById('whSupplyNote').value        = sup.note || '';
    document.getElementById('whSupplyRateField').style.display = sup.currency === 'USD' ? '' : 'none';
    document.getElementById('whSupplyPostBtn').disabled  = false;
    document.getElementById('whSupplyPostBtn').textContent = '‚úì –ü—Ä–æ–≤–µ—Å—Ç–∏';
    document.getElementById('whSupplyDraftBtn').disabled  = false;
    renderWhSupplyItems();
    showWhPage('wh-supply-form');
  }

  function whUpdateSupplyCurrency() {
    const cur = document.getElementById('whSupplyCurrency').value;
    document.getElementById('whSupplyRateField').style.display = cur === 'USD' ? '' : 'none';
    renderWhSupplyItems();
  }

  function whAddSupplyItem() {
    whSupplyItems.push({ name:'', sku:'', size:'', qty:1, purchasePrice:0 });
    renderWhSupplyItems();
  }

  function whRemoveSupplyItem(idx) {
    whSupplyItems.splice(idx, 1);
    renderWhSupplyItems();
  }

  function renderWhSupplyItems() {
    const list = document.getElementById('whSupplyItemsList');
    if (!list) return;
    const currency = document.getElementById('whSupplyCurrency')?.value || 'UZS';
    const rate     = parseFloat(document.getElementById('whSupplyRate')?.value) || 1;

    if (whSupplyItems.length === 0) {
      list.innerHTML = `<div class="wh-empty" style="padding:20px">–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –ø–æ–∑–∏—Ü–∏—é</div>`;
      updateWhSupplySummary();
      return;
    }

    list.innerHTML = whSupplyItems.map((item, idx) => {
      const lineUZS = (currency === 'USD' ? item.purchasePrice * rate : item.purchasePrice) * (item.qty || 0);
      return `<div class="wh-item-row supply-row">
        <div style="display:flex;flex-direction:column;gap:4px">
          <input type="text" class="wh-form-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ *"
            value="${whEsc(item.name)}"
            oninput="whSupplyItems[${idx}].name=this.value">
          <div style="display:flex;gap:6px">
            <input type="text" class="wh-form-input" placeholder="SKU"
              value="${whEsc(item.sku)}"
              oninput="whSupplyItems[${idx}].sku=this.value"
              style="width:50%;font-size:0.75rem">
            <input type="text" class="wh-form-input" placeholder="–†–∞–∑–º–µ—Ä"
              value="${whEsc(item.size)}"
              oninput="whSupplyItems[${idx}].size=this.value"
              style="width:50%;font-size:0.75rem">
          </div>
        </div>
        <div class="wh-form-field">
          <label class="wh-form-label">–ö–æ–ª-–≤–æ</label>
          <input type="number" class="wh-form-input" min="1" value="${item.qty || 1}"
            oninput="whSupplyItems[${idx}].qty=+this.value||1;updateWhSupplySummary()">
        </div>
        <div class="wh-form-field">
          <label class="wh-form-label">–¶–µ–Ω–∞ (${currency})</label>
          <input type="number" class="wh-form-input" min="0" value="${item.purchasePrice || 0}"
            oninput="whSupplyItems[${idx}].purchasePrice=+this.value||0;updateWhSupplySummary()">
        </div>
        <div class="wh-form-field">
          <label class="wh-form-label">–°—É–º–º–∞ (UZS)</label>
          <div style="font-size:0.84rem;font-weight:700;color:#22c55e;padding:8px 0">${whFmt(lineUZS)}</div>
        </div>
        <button class="btn-wh btn-wh-danger btn-wh-sm" onclick="whRemoveSupplyItem(${idx})" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button>
      </div>`;
    }).join('');

    updateWhSupplySummary();
  }

  function updateWhSupplySummary() {
    const currency = document.getElementById('whSupplyCurrency')?.value || 'UZS';
    const rate     = parseFloat(document.getElementById('whSupplyRate')?.value) || 1;
    const expenses = parseFloat(document.getElementById('whSupplyExpenses')?.value) || 0;

    const totalQty = whSupplyItems.reduce((s, i) => s + (i.qty || 0), 0);
    const totalPurchaseUZS = whSupplyItems.reduce((s, i) => {
      const p = currency === 'USD' ? i.purchasePrice * rate : i.purchasePrice;
      return s + p * (i.qty || 0);
    }, 0);

    const set = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v; };
    set('whSupplySumQty',      totalQty);
    set('whSupplySumPurchase', whFmt(totalPurchaseUZS));
    set('whSupplySumExpenses', whFmt(expenses));
    set('whSupplySumTotal',    whFmt(totalPurchaseUZS + expenses));
  }

  function whReadSupplyHeader() {
    return {
      date:     document.getElementById('whSupplyDate').value,
      currency: document.getElementById('whSupplyCurrency').value,
      rate:     parseFloat(document.getElementById('whSupplyRate').value) || 1,
      expenses: parseFloat(document.getElementById('whSupplyExpenses').value) || 0,
      supplier: document.getElementById('whSupplySupplier').value.trim(),
      invoice:  document.getElementById('whSupplyInvoice').value.trim(),
      note:     document.getElementById('whSupplyNote').value.trim(),
    };
  }

  async function whSaveDraftSupply() {
    const h = whReadSupplyHeader();
    if (!h.date) { showToast('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –ø–æ—Å—Ç–∞–≤–∫–∏', 'warning'); return; }
    const btn = document.getElementById('whSupplyDraftBtn');
    btn.disabled = true; btn.textContent = '–°–æ—Ö—Ä–∞–Ω—è–µ–º...';
    try {
      const payload = {
        status: 'draft', ...h,
        items: whSupplyItems.map(i => ({ ...i })),
        createdBy: WH_SESSION_ID,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      };
      if (whCurrentSupplyId) {
        await col('wh_supplies').doc(whCurrentSupplyId).update(payload);
      } else {
        const ref = await col('wh_supplies').add({ ...payload, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        whCurrentSupplyId = ref.id;
      }
      showToast('–ß–µ—Ä–Ω–æ–≤–∏–∫ –ø–æ—Å—Ç–∞–≤–∫–∏ —Å–æ—Ö—Ä–∞–Ω—ë–Ω', 'success');
      showWhPage('wh-supplies');
    } catch (err) {
      showToast('–û—à–∏–±–∫–∞: ' + err.message, 'error');
      btn.disabled = false; btn.textContent = 'üíæ –ß–µ—Ä–Ω–æ–≤–∏–∫';
    }
  }

  async function whPostSupply() {
    const h = whReadSupplyHeader();
    const { date, currency, rate, expenses, supplier, invoice, note } = h;

    if (!date) { showToast('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É –ø–æ—Å—Ç–∞–≤–∫–∏', 'warning'); return; }
    if (whSupplyItems.length === 0) { showToast('–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –ø–æ–∑–∏—Ü–∏—é', 'warning'); return; }
    for (const it of whSupplyItems) {
      if (!it.name.trim()) { showToast('–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –¥–ª—è –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π', 'warning'); return; }
      if ((it.qty || 0) < 1) { showToast('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å ‚â• 1', 'warning'); return; }
    }

    const btn = document.getElementById('whSupplyPostBtn');
    btn.disabled = true; btn.textContent = '–ü—Ä–æ–≤–æ–¥–∏–º...';

    try {
      const now = firebase.firestore.FieldValue.serverTimestamp();

      // Total purchase value in UZS (for expense distribution)
      const totalPurchaseUZS = whSupplyItems.reduce((s, i) => {
        return s + (currency === 'USD' ? i.purchasePrice * rate : i.purchasePrice) * i.qty;
      }, 0);
      const totalLanded = totalPurchaseUZS + expenses;

      const batch = db.batch();

      for (const item of whSupplyItems) {
        const priceUZS   = currency === 'USD' ? item.purchasePrice * rate : item.purchasePrice;
        const lineUZS    = priceUZS * item.qty;
        // Distribute expenses proportionally to purchase value
        const share      = totalPurchaseUZS > 0 ? lineUZS / totalPurchaseUZS : 1 / whSupplyItems.length;
        const lineExpenses = expenses * share;
        const landedTotal  = lineUZS + lineExpenses;
        const unitLanded   = item.qty > 0 ? landedTotal / item.qty : 0;

        // Inventory doc key
        const rawKey = `${item.sku || item.name}_${item.size || ''}`.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_\-]/g, '');
        const invKey = rawKey || `inv_${Date.now()}`;
        const invRef = col('wh_inventory').doc(invKey);

        // Read current inventory (must be outside batch)
        const invSnap = await invRef.get();
        const oldQty  = invSnap.exists ? (invSnap.data().onHand || 0) : 0;
        const oldAvg  = invSnap.exists ? (invSnap.data().avgCostUZS || 0) : 0;

        const newQty = oldQty + item.qty;
        // Weighted average: newAvg = (oldAvg*oldQty + unitLanded*inQty) / (oldQty+inQty)
        const newAvg = newQty > 0 ? (oldAvg * oldQty + unitLanded * item.qty) / newQty : unitLanded;

        batch.set(invRef, {
          sku: item.sku || '',
          name: item.name.trim(),
          size: item.size || '',
          onHand: newQty,
          avgCostUZS: Math.round(newAvg)
        }, { merge: true });

        // Stock move
        const moveRef = col('wh_moves').doc();
        batch.set(moveRef, {
          date,
          type: 'IN',
          sku: item.sku || '',
          name: item.name.trim(),
          size: item.size || '',
          qty: item.qty,
          unitCostUZS: Math.round(unitLanded),
          totalUZS: Math.round(landedTotal),
          refType: 'supply',
          refId: whCurrentSupplyId || '',
          createdBy: WH_SESSION_ID,
          createdAt: now
        });
      }

      // Save supply document
      const supplyPayload = {
        status: 'posted', date, currency, rate, expenses,
        supplier, invoice, note,
        items: whSupplyItems.map(i => ({ ...i })),
        postedAt: now, createdAt: now,
        createdBy: WH_SESSION_ID,
      };

      if (whCurrentSupplyId) {
        batch.update(col('wh_supplies').doc(whCurrentSupplyId), supplyPayload);
      } else {
        batch.set(col('wh_supplies').doc(), supplyPayload);
      }

      await batch.commit();
      showToast('–ü–æ—Å—Ç–∞–≤–∫–∞ –ø—Ä–æ–≤–µ–¥–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ', 'success');
      showWhPage('wh-supplies');

    } catch (err) {
      console.error('whPostSupply:', err);
      showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–∏: ' + err.message, 'error');
      btn.disabled = false; btn.textContent = '‚úì –ü—Ä–æ–≤–µ—Å—Ç–∏';
    }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  WRITE-OFFS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function renderWhWriteoffs() {
    const body = document.getElementById('whWriteoffsBody');
    if (!body) return;

    if (whWriteoffs.length === 0) {
      body.innerHTML = `<tr><td colspan="7"><div class="wh-empty">
        <div class="wh-empty-icon">üóë</div>–°–ø–∏—Å–∞–Ω–∏–π –Ω–µ—Ç</div></td></tr>`;
      return;
    }

    body.innerHTML = whWriteoffs.map(w => {
      const totalQty = (w.items || []).reduce((s, i) => s + (i.qty || 0), 0);
      const totalUZS = (w.items || []).reduce((s, i) => {
        const inv = whInventory.find(iv => iv.name === i.name && iv.size === (i.size || ''));
        return s + (inv?.avgCostUZS || 0) * (i.qty || 0);
      }, 0);
      const stCls  = w.status === 'posted' ? 'posted' : 'draft';
      // Support both old (reason text) and new (type + comment) format
      const typeLabel = w.type || w.reason || '‚Äî';
      return `<tr>
        <td style="white-space:nowrap">${whEsc(w.date || '‚Äî')}</td>
        <td><span style="text-transform:capitalize">${whEsc(typeLabel)}</span></td>
        <td style="font-size:0.78rem;color:#64748b">${whEsc(w.comment || '')}</td>
        <td class="num">${totalQty}</td>
        <td class="num">${whFmt(totalUZS)}</td>
        <td><span class="wh-badge ${stCls}">${w.status === 'posted' ? '–ü—Ä–æ–≤–µ–¥–µ–Ω–æ' : '–ß–µ—Ä–Ω–æ–≤–∏–∫'}</span></td>
        <td style="text-align:right;white-space:nowrap;display:flex;gap:4px;justify-content:flex-end">
          ${w.status !== 'posted'
            ? `<button class="btn-wh btn-wh-secondary btn-wh-sm" onclick="whEditWriteoff('${w.id}')">‚úèÔ∏è</button>`
            : ''}
          <button class="btn-wh btn-wh-secondary btn-wh-sm" onclick="printWriteoffDoc('${w.id}')" title="–ü–µ—á–∞—Ç—å / PDF">üñ®</button>
        </td>
      </tr>`;
    }).join('');
  }

  function whNewWriteoff() {
    whCurrentWriteoffId = null;
    whWriteoffItems = [{ name:'', sku:'', size:'', qty:1 }];
    document.getElementById('whWriteoffFormTitle').textContent = '–ù–æ–≤–æ–µ —Å–ø–∏—Å–∞–Ω–∏–µ';
    document.getElementById('whWriteoffDate').value    = whToday();
    document.getElementById('whWriteoffType').value    = '–±—Ä–∞–∫';
    document.getElementById('whWriteoffComment').value = '';
    document.getElementById('whWriteoffPostBtn').disabled   = false;
    document.getElementById('whWriteoffPostBtn').textContent = '‚úì –ü—Ä–æ–≤–µ—Å—Ç–∏';
    document.getElementById('whWriteoffDraftBtn').disabled   = false;
    renderWhWriteoffItems();
    showWhPage('wh-writeoff-form');
  }

  function whEditWriteoff(id) {
    const wo = whWriteoffs.find(w => w.id === id);
    if (!wo) return;
    whCurrentWriteoffId = id;
    whWriteoffItems = (wo.items || []).map(i => ({ ...i }));
    document.getElementById('whWriteoffFormTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–ø–∏—Å–∞–Ω–∏–µ';
    document.getElementById('whWriteoffDate').value    = wo.date || whToday();
    document.getElementById('whWriteoffType').value    = wo.type || '–±—Ä–∞–∫';
    document.getElementById('whWriteoffComment').value = wo.comment || wo.reason || '';
    document.getElementById('whWriteoffPostBtn').disabled   = false;
    document.getElementById('whWriteoffPostBtn').textContent = '‚úì –ü—Ä–æ–≤–µ—Å—Ç–∏';
    document.getElementById('whWriteoffDraftBtn').disabled   = false;
    renderWhWriteoffItems();
    showWhPage('wh-writeoff-form');
  }

  function whAddWriteoffItem() {
    whWriteoffItems.push({ name:'', sku:'', size:'', qty:1 });
    renderWhWriteoffItems();
  }

  function whRemoveWriteoffItem(idx) {
    whWriteoffItems.splice(idx, 1);
    renderWhWriteoffItems();
  }

  function renderWhWriteoffItems() {
    const list = document.getElementById('whWriteoffItemsList');
    if (!list) return;

    if (whWriteoffItems.length === 0) {
      list.innerHTML = `<div class="wh-empty" style="padding:20px">–î–æ–±–∞–≤—å—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –ø–æ–∑–∏—Ü–∏—é</div>`;
      return;
    }

    list.innerHTML = whWriteoffItems.map((item, idx) => {
      const inv = whInventory.find(i => i.name === item.name.trim() && i.size === (item.size || ''));
      const available = inv ? inv.onHand : null;
      const lineCost  = inv ? whFmt(inv.avgCostUZS * item.qty) : '‚Äî';
      return `<div class="wh-item-row writeoff-row">
        <div style="display:flex;flex-direction:column;gap:4px">
          <input type="text" class="wh-form-input" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ *"
            value="${whEsc(item.name)}"
            oninput="whWriteoffItems[${idx}].name=this.value;renderWhWriteoffItems()">
          <div style="display:flex;gap:6px">
            <input type="text" class="wh-form-input" placeholder="SKU"
              value="${whEsc(item.sku)}"
              oninput="whWriteoffItems[${idx}].sku=this.value"
              style="width:50%;font-size:0.75rem">
            <input type="text" class="wh-form-input" placeholder="–†–∞–∑–º–µ—Ä"
              value="${whEsc(item.size)}"
              oninput="whWriteoffItems[${idx}].size=this.value;renderWhWriteoffItems()"
              style="width:50%;font-size:0.75rem">
          </div>
          ${available !== null
            ? `<div style="font-size:0.72rem;color:${available>0?'#64748b':'#ef4444'}">
                –í –Ω–∞–ª–∏—á–∏–∏: ${available} —à—Ç.
               </div>`
            : (item.name ? `<div style="font-size:0.72rem;color:#ef4444">–ù–µ –Ω–∞–π–¥–µ–Ω–æ –Ω–∞ —Å–∫–ª–∞–¥–µ</div>` : '')}
        </div>
        <div class="wh-form-field">
          <label class="wh-form-label">–ö–æ–ª-–≤–æ</label>
          <input type="number" class="wh-form-input" min="1" value="${item.qty || 1}"
            oninput="whWriteoffItems[${idx}].qty=+this.value||1">
        </div>
        <div class="wh-form-field">
          <label class="wh-form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å (UZS)</label>
          <div style="font-size:0.84rem;font-weight:700;color:#ef4444;padding:8px 0">${lineCost}</div>
        </div>
        <button class="btn-wh btn-wh-danger btn-wh-sm" onclick="whRemoveWriteoffItem(${idx})">‚úï</button>
      </div>`;
    }).join('');
  }

  function whReadWriteoffHeader() {
    return {
      date:    document.getElementById('whWriteoffDate').value,
      type:    document.getElementById('whWriteoffType').value,
      comment: document.getElementById('whWriteoffComment').value.trim(),
    };
  }

  async function whSaveDraftWriteoff() {
    const h = whReadWriteoffHeader();
    if (!h.date) { showToast('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É', 'warning'); return; }
    const btn = document.getElementById('whWriteoffDraftBtn');
    btn.disabled = true; btn.textContent = '–°–æ—Ö—Ä–∞–Ω—è–µ–º...';
    try {
      const payload = {
        status: 'draft', ...h,
        items: whWriteoffItems.map(i => ({ ...i })),
        createdBy: WH_SESSION_ID,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      };
      if (whCurrentWriteoffId) {
        await col('wh_writeoffs').doc(whCurrentWriteoffId).update(payload);
      } else {
        const ref = await col('wh_writeoffs').add({ ...payload, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
        whCurrentWriteoffId = ref.id;
      }
      showToast('–ß–µ—Ä–Ω–æ–≤–∏–∫ —Å–ø–∏—Å–∞–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω—ë–Ω', 'success');
      showWhPage('wh-writeoffs');
    } catch (err) {
      showToast('–û—à–∏–±–∫–∞: ' + err.message, 'error');
      btn.disabled = false; btn.textContent = 'üíæ –ß–µ—Ä–Ω–æ–≤–∏–∫';
    }
  }

  async function whPostWriteoff() {
    const { date, type, comment } = whReadWriteoffHeader();

    if (!date) { showToast('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É', 'warning'); return; }
    if (whWriteoffItems.length === 0) { showToast('–î–æ–±–∞–≤—å—Ç–µ –ø–æ–∑–∏—Ü–∏–∏ –¥–ª—è —Å–ø–∏—Å–∞–Ω–∏—è', 'warning'); return; }

    // Validate each item
    for (const item of whWriteoffItems) {
      if (!item.name.trim()) { showToast('–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö –ø–æ–∑–∏—Ü–∏–π', 'warning'); return; }
      if ((item.qty || 0) < 1) { showToast('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å ‚â• 1', 'warning'); return; }
      const inv = whInventory.find(i => i.name === item.name.trim() && i.size === (item.size || ''));
      if (!inv) { showToast(`–¢–æ–≤–∞—Ä "${item.name}" (—Ä–∞–∑–º–µ—Ä: ${item.size || '‚Äî'}) –Ω–µ –Ω–∞–π–¥–µ–Ω –Ω–∞ —Å–∫–ª–∞–¥–µ`, 'error'); return; }
      if ((inv.onHand || 0) < item.qty) {
        showToast(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ "${item.name}". –ù–∞ —Å–∫–ª–∞–¥–µ: ${inv.onHand}, –Ω—É–∂–Ω–æ: ${item.qty}`, 'error');
        return;
      }
    }
    const reason = type; // backward compat alias

    const btn = document.getElementById('whWriteoffPostBtn');
    btn.disabled = true; btn.textContent = '–ü—Ä–æ–≤–æ–¥–∏–º...';

    try {
      const now   = firebase.firestore.FieldValue.serverTimestamp();
      const batch = db.batch();

      for (const item of whWriteoffItems) {
        const inv    = whInventory.find(i => i.name === item.name.trim() && i.size === (item.size || ''));
        const invRef = col('wh_inventory').doc(inv.id);

        const newQty = (inv.onHand || 0) - item.qty;
        batch.update(invRef, { onHand: newQty });

        const moveRef = col('wh_moves').doc();
        batch.set(moveRef, {
          date, type: 'OUT',
          sku: inv.sku || '',
          name: inv.name,
          size: inv.size || '',
          qty: item.qty,
          unitCostUZS: inv.avgCostUZS || 0,
          totalUZS: (inv.avgCostUZS || 0) * item.qty,
          refType: 'writeoff',
          refId: whCurrentWriteoffId || '',
          createdBy: WH_SESSION_ID,
          createdAt: now
        });
      }

      const woPayload = {
        status: 'posted', date,
        type, comment, reason,   // reason kept for backward compat
        items: whWriteoffItems.map(i => ({ ...i })),
        postedAt: now, createdAt: now,
        createdBy: WH_SESSION_ID,
      };
      if (whCurrentWriteoffId) {
        batch.update(col('wh_writeoffs').doc(whCurrentWriteoffId), woPayload);
      } else {
        batch.set(col('wh_writeoffs').doc(), woPayload);
      }

      await batch.commit();
      showToast('–°–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–≤–µ–¥–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ', 'success');
      showWhPage('wh-writeoffs');

    } catch (err) {
      console.error('whPostWriteoff:', err);
      showToast('–û—à–∏–±–∫–∞: ' + err.message, 'error');
      btn.disabled = false; btn.textContent = '‚úì –ü—Ä–æ–≤–µ—Å—Ç–∏';
    }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  INVENTORIES (STOCK COUNT)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function renderWhInventories() {
    const body = document.getElementById('whInventoriesBody');
    if (!body) return;

    if (whInventories.length === 0) {
      body.innerHTML = `<tr><td colspan="5"><div class="wh-empty">
        <div class="wh-empty-icon">üîç</div>–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–π –Ω–µ—Ç</div></td></tr>`;
      return;
    }

    body.innerHTML = whInventories.map(inv => {
      const diffs = (inv.items || []).filter(i => (i.diff || 0) !== 0).length;
      const stCls = inv.status === 'posted' ? 'posted' : 'draft';
      return `<tr>
        <td>${whEsc(inv.date || '‚Äî')}</td>
        <td class="num">${(inv.items || []).length}</td>
        <td class="num" style="color:${diffs > 0 ? '#f59e0b' : '#22c55e'}">${diffs}</td>
        <td><span class="wh-badge ${stCls}">${inv.status === 'posted' ? '–ü—Ä–æ–≤–µ–¥–µ–Ω–æ' : '–ß–µ—Ä–Ω–æ–≤–∏–∫'}</span></td>
        <td style="text-align:right">
          ${inv.status !== 'posted'
            ? `<button class="btn-wh btn-wh-secondary btn-wh-sm" onclick="whEditInventory('${inv.id}')">‚úèÔ∏è</button>`
            : ''}
        </td>
      </tr>`;
    }).join('');
  }

  function whNewInventory() {
    whCurrentInventoryId = null;
    document.getElementById('whInventoryDate').value = whToday();
    document.getElementById('whInventoryPostBtn').disabled  = false;
    document.getElementById('whInventoryPostBtn').textContent = '‚úì –ü—Ä–æ–≤–µ—Å—Ç–∏';
    buildInventoryRows(null);
    showWhPage('wh-inventory-form');
  }

  function whEditInventory(id) {
    const inv = whInventories.find(i => i.id === id);
    if (!inv) return;
    whCurrentInventoryId = id;
    document.getElementById('whInventoryDate').value = inv.date || whToday();
    buildInventoryRows(inv.items || null);
    showWhPage('wh-inventory-form');
  }

  function buildInventoryRows(savedItems) {
    // Use current wh_inventory as base; overlay saved actual quantities if editing
    const savedMap = {};
    if (savedItems) savedItems.forEach(i => { savedMap[i.id || (i.name + '_' + i.size)] = i; });

    whInvFormItems = whInventory.map(inv => {
      const key = inv.id || (inv.name + '_' + inv.size);
      const saved = savedMap[key];
      const actual = saved != null ? (saved.actualQty ?? inv.onHand) : inv.onHand;
      return {
        id:         inv.id,
        sku:        inv.sku || '',
        name:       inv.name,
        size:       inv.size || '',
        currentQty: inv.onHand || 0,
        actualQty:  actual,
        diff:       actual - (inv.onHand || 0)
      };
    });

    renderInventoryTable();
  }

  function renderInventoryTable() {
    const body = document.getElementById('whInventoryItemsBody');
    if (!body) return;

    if (whInvFormItems.length === 0) {
      body.innerHTML = `<tr><td colspan="5" class="wh-empty">
        –°–∫–ª–∞–¥ –ø—É—Å—Ç ‚Äî —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ–¥–∏—Ç–µ –ø–æ—Å—Ç–∞–≤–∫—É</td></tr>`;
      return;
    }

    body.innerHTML = whInvFormItems.map((item, idx) => {
      const diff    = item.diff || 0;
      const diffCls = diff > 0 ? 'stock-ok' : diff < 0 ? 'stock-zero' : '';
      return `<tr>
        <td><div style="font-weight:600">${whEsc(item.name)}</div>
            <div class="wh-item-sku">${whEsc(item.sku || '')}</div></td>
        <td>${whEsc(item.size || '‚Äî')}</td>
        <td class="num">${item.currentQty}</td>
        <td class="num">
          <input type="number" class="wh-form-input" min="0" value="${item.actualQty}"
            oninput="whUpdateActual(${idx},+this.value)"
            style="width:80px;text-align:right;padding:5px 8px">
        </td>
        <td class="num ${diffCls}" id="invdiff-${idx}">
          ${diff >= 0 ? '+' : ''}${diff}
        </td>
      </tr>`;
    }).join('');
  }

  function whUpdateActual(idx, val) {
    if (!whInvFormItems[idx]) return;
    whInvFormItems[idx].actualQty = val;
    whInvFormItems[idx].diff = val - whInvFormItems[idx].currentQty;
    const el = document.getElementById(`invdiff-${idx}`);
    if (el) {
      const d = whInvFormItems[idx].diff;
      el.textContent = (d >= 0 ? '+' : '') + d;
      el.className = 'num ' + (d > 0 ? 'stock-ok' : d < 0 ? 'stock-zero' : '');
    }
  }

  async function whPostInventory() {
    const date = document.getElementById('whInventoryDate').value;
    if (!date) { showToast('–£–∫–∞–∂–∏—Ç–µ –¥–∞—Ç—É', 'warning'); return; }
    if (whInvFormItems.length === 0) { showToast('–ù–µ—Ç –ø–æ–∑–∏—Ü–∏–π –¥–ª—è –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏–∏ ‚Äî —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ–¥–∏—Ç–µ –ø–æ—Å—Ç–∞–≤–∫—É', 'warning'); return; }

    const btn = document.getElementById('whInventoryPostBtn');
    btn.disabled = true; btn.textContent = '–ü—Ä–æ–≤–æ–¥–∏–º...';

    try {
      const now   = firebase.firestore.FieldValue.serverTimestamp();
      const batch = db.batch();

      for (const item of whInvFormItems) {
        if (item.diff === 0) continue;  // no change ‚Äî skip

        const invRef = col('wh_inventory').doc(item.id);
        batch.update(invRef, { onHand: item.actualQty });

        const moveRef = col('wh_moves').doc();
        const inv     = whInventory.find(i => i.id === item.id);
        batch.set(moveRef, {
          date, type: 'ADJUST',
          sku: item.sku || '',
          name: item.name,
          size: item.size || '',
          qty: item.diff,           // positive = surplus, negative = shortage
          unitCostUZS: inv?.avgCostUZS || 0,
          totalUZS: (inv?.avgCostUZS || 0) * Math.abs(item.diff),
          refType: 'inventory',
          refId: whCurrentInventoryId || '',
          createdBy: WH_SESSION_ID,
          createdAt: now
        });
      }

      const invPayload = {
        status: 'posted', date,
        items: whInvFormItems.map(i => ({ ...i })),
        postedAt: now, createdAt: now,
        createdBy: WH_SESSION_ID,
      };
      if (whCurrentInventoryId) {
        batch.update(col('wh_inventories').doc(whCurrentInventoryId), invPayload);
      } else {
        batch.set(col('wh_inventories').doc(), invPayload);
      }

      await batch.commit();
      showToast('–ò–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–æ–≤–µ–¥–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ', 'success');
      showWhPage('wh-inventories');

    } catch (err) {
      console.error('whPostInventory:', err);
      showToast('–û—à–∏–±–∫–∞: ' + err.message, 'error');
      btn.disabled = false; btn.textContent = '‚úì –ü—Ä–æ–≤–µ—Å—Ç–∏';
    }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  PRODUCT SEARCH + QUICK FILTER
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  let prodFilterMode = 'all';

  let prodPage = 0;
  const PAGE_SIZE = 50;

  function setProdFilter(mode, btn) {
    prodFilterMode = mode;
    prodPage = 0; // reset to first page on filter change
    document.querySelectorAll('.prod-tag').forEach(t => t.classList.remove('active'));
    if (btn) btn.classList.add('active');
    applyProdFilter();
  }

  function changeProdPage(delta) {
    prodPage += delta;
    applyProdFilter();
  }

  function applyProdFilter() {
    const search   = (document.getElementById('prodSearch')?.value    || '').toLowerCase().trim();
    const filterCat   = document.getElementById('filterCat')?.value    || '';
    const filterCtry  = document.getElementById('filterCountry')?.value || '';

    // Collect matching row IDs
    const matched = [];
    rows.forEach(id => {
      const tr = document.getElementById('row-' + id);
      if (!tr) return;
      const name    = (document.getElementById('name-' + id)?.value || '').toLowerCase();
      const code    = (document.getElementById('code-' + id)?.value || '').toLowerCase();
      const rowCat  = tr.getAttribute('data-category') || '';
      const rowCtry = tr.getAttribute('data-country')  || '';
      let visible = true;

      if (search && !name.includes(search) && !code.includes(search)) visible = false;
      if (filterCat  && rowCat  !== filterCat)  visible = false;
      if (filterCtry && rowCtry !== filterCtry) visible = false;

      if (visible) {
        if (prodFilterMode === 'profit')      visible = tr.dataset.profitSign === 'pos';
        else if (prodFilterMode === 'loss')   visible = tr.dataset.profitSign === 'neg';
        else if (prodFilterMode === 'margin30') visible = parseFloat(tr.dataset.marginPct || '0') >= 30;
      }

      if (visible) matched.push(id);
      else tr.style.display = 'none';
    });

    // Clamp page
    const totalPages = Math.max(1, Math.ceil(matched.length / PAGE_SIZE));
    if (prodPage >= totalPages) prodPage = totalPages - 1;
    if (prodPage < 0) prodPage = 0;

    // Show only rows in current page slice
    matched.forEach((id, idx) => {
      const tr = document.getElementById('row-' + id);
      if (!tr) return;
      tr.style.display = (idx >= prodPage * PAGE_SIZE && idx < (prodPage + 1) * PAGE_SIZE) ? '' : 'none';
    });

    // Count label
    const countEl = document.getElementById('prodFilterCount');
    if (countEl) {
      countEl.textContent = (search || prodFilterMode !== 'all')
        ? `${matched.length} –∏–∑ ${rows.length}`
        : (rows.length > PAGE_SIZE ? `${matched.length} —Ç–æ–≤–∞—Ä–æ–≤` : '');
    }

    // Paginator
    const pag = document.getElementById('paginator');
    if (pag) {
      if (totalPages <= 1) {
        pag.style.display = 'none';
      } else {
        pag.style.display = 'flex';
        const cur = document.getElementById('pagCur');
        if (cur) cur.textContent = `–°—Ç—Ä. ${prodPage + 1} –∏–∑ ${totalPages} ¬∑ ${matched.length} —Ç–æ–≤–∞—Ä–æ–≤`;
        const prev = document.getElementById('pagPrev');
        const next = document.getElementById('pagNext');
        if (prev) prev.disabled = prodPage === 0;
        if (next) next.disabled = prodPage >= totalPages - 1;
      }
    }

    const hint = document.getElementById('emptyHint');
    if (hint) hint.style.display = rows.length === 0 ? '' : 'none';
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  DUPLICATE ROW
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function duplicateRow(id) {
    const tr = document.getElementById('row-' + id);
    if (!tr) return;
    const code     = document.getElementById('code-' + id)?.value || '';
    const name     = document.getElementById('name-' + id)?.value || '';
    const usd      = parseFloat(document.getElementById('usd-' + id)?.value)  || 0;
    const qty      = parseFloat(document.getElementById('qty-' + id)?.value)  || 6;
    const margin   = parseInt(tr.getAttribute('data-margin'))   || 30;
    const rate     = parseFloat(tr.getAttribute('data-rate'))   || defaultRate;
    const logistics= parseFloat(tr.getAttribute('data-logistics')) || 0;
    const sizesStr = tr.querySelector('.row-size-cell')?.getAttribute('data-sizes') || '';
    const sizes    = sizesStr ? sizesStr.split(',') : [];
    const photo    = tr.querySelector('.row-thumb')?.src || null;
    const category = tr.getAttribute('data-category') || '';
    addRow({ code: code + ' (–∫–æ–ø–∏—è)', name, usd, qty, sizes, photo: photo && photo.startsWith('data:') ? photo : null, margin, rate, logistics, category });
    showToast('–¢–æ–≤–∞—Ä –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω', 'success', 2500);
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  CONTEXT MENU (right-click on product rows)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  let ctxRowId = null;

  document.addEventListener('contextmenu', e => {
    const tr = e.target.closest('tr[id^="row-"]');
    const menu = document.getElementById('prodContextMenu');
    if (!tr || !menu) return;
    e.preventDefault();
    ctxRowId = parseInt(tr.id.replace('row-', ''));
    menu.style.display = 'block';
    const x = Math.min(e.clientX, window.innerWidth  - menu.offsetWidth  - 8);
    const y = Math.min(e.clientY, window.innerHeight - menu.offsetHeight - 8);
    menu.style.left = x + 'px';
    menu.style.top  = y + 'px';
  });

  document.addEventListener('click', () => {
    const menu = document.getElementById('prodContextMenu');
    if (menu) menu.style.display = 'none';
  });

  function ctxEdit()      { if (ctxRowId) openEditModal(ctxRowId); }
  function ctxDuplicate() { if (ctxRowId) duplicateRow(ctxRowId);  }
  function ctxDelete()    { if (ctxRowId) delRow(ctxRowId);        }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  TOAST NOTIFICATION SYSTEM
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const TOAST_ICONS = { success:'‚úÖ', error:'‚ùå', warning:'‚ö†Ô∏è', info:'‚ÑπÔ∏è' };
  const TOAST_TITLES = { success:'–ì–æ—Ç–æ–≤–æ', error:'–û—à–∏–±–∫–∞', warning:'–í–Ω–∏–º–∞–Ω–∏–µ', info:'–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è' };

  function showToast(message, type = 'info', durationMs = 4000) {
    const container = document.getElementById('toast-container');
    if (!container) return;

    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
      <div class="toast-icon">${TOAST_ICONS[type] || '‚ÑπÔ∏è'}</div>
      <div class="toast-body">
        <div class="toast-title">${TOAST_TITLES[type] || type}</div>
        <div class="toast-msg">${String(message).replace(/</g,'&lt;')}</div>
      </div>
      <div class="toast-bar" style="animation-duration:${durationMs}ms"></div>`;

    const dismiss = () => {
      toast.classList.add('removing');
      toast.addEventListener('animationend', () => toast.remove(), { once: true });
    };
    toast.addEventListener('click', dismiss);
    container.appendChild(toast);
    setTimeout(dismiss, durationMs);
  }

  // ‚îÄ‚îÄ Navigate from moves journal to source document ‚îÄ‚îÄ
  function whGoToDoc(type, id) {
    if (type === 'supply') {
      const sup = whSupplies.find(s => s.id === id);
      if (sup) { whEditSupply(id); return; }
      // If not found it may be posted ‚Äî just go to list
      showWhPage('wh-supplies');
    } else if (type === 'writeoff') {
      const wo = whWriteoffs.find(w => w.id === id);
      if (wo) { whEditWriteoff(id); return; }
      showWhPage('wh-writeoffs');
    }
  }

  // ‚îÄ‚îÄ CSV export for stock page ‚îÄ‚îÄ
  function whExportStockCSV() {
    const search = (document.getElementById('whStockSearch')?.value || '').toLowerCase();
    const filter = document.getElementById('whStockFilter')?.value || '';

    let items = [...whInventory];
    if (search) items = items.filter(i =>
      (i.sku || '').toLowerCase().includes(search) ||
      (i.name || '').toLowerCase().includes(search));
    if (filter === 'positive') items = items.filter(i => (i.onHand || 0) > 0);
    if (filter === 'zero')     items = items.filter(i => (i.onHand || 0) <= 0);

    const rows = [['–ù–∞–∑–≤–∞–Ω–∏–µ', 'SKU', '–†–∞–∑–º–µ—Ä', '–û—Å—Ç–∞—Ç–æ–∫ (—à—Ç)', '–°—Ä. —Å–µ–±–µ—Å—Ç. (UZS)', '–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–ø–∞—Å–æ–≤ (UZS)']];
    items.forEach(i => {
      rows.push([
        i.name || '',
        i.sku || '',
        i.size || '',
        i.onHand || 0,
        Math.round(i.avgCostUZS || 0),
        Math.round((i.onHand || 0) * (i.avgCostUZS || 0))
      ]);
    });

    const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(',')).join('\r\n');
    const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement('a');
    a.href     = url;
    a.download = `ostatok_${whToday()}.csv`;
    a.click();
    URL.revokeObjectURL(url);
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  1. PIN PROTECTION
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  const PIN_KEY      = 'praicer_pin';
  const PIN_AUTH_KEY = 'praicer_pin_auth'; // timestamp of last successful unlock
  const PIN_TTL      = 60 * 60 * 1000;    // 1 hour in ms
  let pinBuffer = '';
  let pinMode   = 'check'; // 'check' | 'set' | 'confirm'
  let pinFirst  = '';

  // ‚îÄ‚îÄ Auth ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let _authMode = 'login';

  function initAuth() {
    auth = firebase.auth();
    // –ù–∞ staging ‚Äî –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –ª–æ–≥–∏–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –∞–∫–∫–∞—É–Ω—Ç
    if (location.hostname === 'praicer-staging.netlify.app') {
      currentUser = { uid: 'staging-preview-user', email: 'staging@preview', displayName: 'üß™ Staging' };
      document.getElementById('authOverlay').classList.remove('show');
      const el = document.getElementById('headerUserEmail');
      if (el) el.textContent = 'üß™ Staging';
      startFirebaseSync();
      fetchExchangeRate();
      initPinProtection();
      return;
    }
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        document.getElementById('authOverlay').classList.remove('show');
        const el = document.getElementById('headerUserEmail');
        if (el) el.textContent = user.displayName || user.email || '';
        startFirebaseSync();
        fetchExchangeRate();
        initPinProtection();
      } else {
        currentUser = null;
        document.getElementById('authOverlay').classList.add('show');
      }
    });
  }

  function switchAuthTab(mode) {
    _authMode = mode;
    document.querySelectorAll('.auth-tab').forEach((t, i) =>
      t.classList.toggle('active', (i===0 && mode==='login') || (i===1 && mode==='register')));
    document.getElementById('authSubmitBtn').textContent = mode === 'login' ? '–í–æ–π—Ç–∏' : '–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è';
    document.getElementById('authError').textContent = '';
  }

  function authSubmit() {
    const email = (document.getElementById('authEmail')?.value || '').trim();
    const pass  = document.getElementById('authPass')?.value || '';
    const errEl = document.getElementById('authError');
    const btn   = document.getElementById('authSubmitBtn');
    if (!email || !pass) { errEl.textContent = '–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å'; return; }
    btn.disabled = true;
    const op = _authMode === 'login'
      ? auth.signInWithEmailAndPassword(email, pass)
      : auth.createUserWithEmailAndPassword(email, pass);
    op.catch(e => { errEl.textContent = translateAuthError(e.code); btn.disabled = false; });
  }

  function authGoogleSignIn() {
    const btn = document.getElementById('authGoogleBtn');
    const errEl = document.getElementById('authError');
    if (btn) btn.disabled = true;
    errEl.textContent = '';
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider)
      .catch(e => {
        errEl.textContent = translateAuthError(e.code);
        if (btn) btn.disabled = false;
      });
  }

  function authResetPassword() {
    const email = (document.getElementById('authEmail')?.value || '').trim();
    if (!email) { document.getElementById('authError').textContent = '–í–≤–µ–¥–∏—Ç–µ email –¥–ª—è —Å–±—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è'; return; }
    auth.sendPasswordResetEmail(email)
      .then(() => showToast('–ü–∏—Å—å–º–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ ' + email, 'success', 4000))
      .catch(e => document.getElementById('authError').textContent = translateAuthError(e.code));
  }

  function authLogout() {
    showConfirm('–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?', () => {
      auth.signOut().then(() => window.location.reload());
    });
  }

  function translateAuthError(code) {
    const map = {
      'auth/invalid-email':           '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email',
      'auth/user-not-found':          '–ê–∫–∫–∞—É–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω',
      'auth/wrong-password':          '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å',
      'auth/invalid-credential':      '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å',
      'auth/email-already-in-use':    'Email —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è',
      'auth/weak-password':           '–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)',
      'auth/too-many-requests':       '–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –ø–æ–ø—ã—Ç–æ–∫, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ',
      'auth/network-request-failed':  '–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ç–∏',
      'auth/popup-closed-by-user':    '–û–∫–Ω–æ –≤—Ö–æ–¥–∞ –∑–∞–∫—Ä—ã—Ç–æ, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞',
      'auth/popup-blocked':           '–ë—Ä–∞—É–∑–µ—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –≤—Å–ø–ª—ã–≤–∞—é—â–µ–µ –æ–∫–Ω–æ ‚Äî —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö',
      'auth/cancelled-popup-request': '',
      'auth/configuration-not-found': '–ü—Ä–æ–≤–∞–π–¥–µ—Ä –≤—Ö–æ–¥–∞ –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –≤ Firebase Console',
      'auth/operation-not-allowed':   '–≠—Ç–æ—Ç —Å–ø–æ—Å–æ–± –≤—Ö–æ–¥–∞ –Ω–µ –≤–∫–ª—é—á—ë–Ω –≤ Firebase Console',
    };
    return map[code] || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + code;
  }
  // ‚îÄ‚îÄ End Auth ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  function initPinProtection() {
    const stored = localStorage.getItem(PIN_KEY);
    if (!stored) return; // no PIN set ‚Äî skip
    const lastAuth = parseInt(localStorage.getItem(PIN_AUTH_KEY) || '0', 10);
    if (Date.now() - lastAuth < PIN_TTL) return; // unlocked less than 1 hour ago ‚Äî skip
    document.getElementById('pinOverlay').classList.add('show');
  }

  function pinKey(k) {
    const overlay = document.getElementById('pinOverlay');
    if (k === 'back') {
      pinBuffer = pinBuffer.slice(0, -1);
      updatePinDots();
      return;
    }
    if (k === 'enter') {
      pinSubmit();
      return;
    }
    if (pinBuffer.length >= 4) return;
    pinBuffer += k;
    updatePinDots();
    if (pinBuffer.length === 4) setTimeout(pinSubmit, 120);
  }

  function updatePinDots() {
    for (let i = 0; i < 4; i++) {
      const dot = document.getElementById('pd' + i);
      if (dot) dot.classList.toggle('filled', i < pinBuffer.length);
    }
  }

  function pinSubmit() {
    const stored = localStorage.getItem(PIN_KEY);
    if (pinMode === 'check') {
      if (pinBuffer === stored) {
        localStorage.setItem(PIN_AUTH_KEY, Date.now().toString()); // remember unlock time
        document.getElementById('pinOverlay').classList.remove('show');
        pinBuffer = '';
        updatePinDots();
        document.getElementById('pinError').textContent = '';
      } else {
        document.getElementById('pinError').textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π PIN';
        document.getElementById('pinOverlay').querySelector('.pin-dots').classList.add('shake');
        setTimeout(() => {
          document.getElementById('pinOverlay').querySelector('.pin-dots').classList.remove('shake');
        }, 500);
        pinBuffer = '';
        updatePinDots();
      }
    } else if (pinMode === 'set') {
      pinFirst = pinBuffer;
      pinBuffer = '';
      updatePinDots();
      document.getElementById('pinOverlay').querySelector('.pin-title').textContent = '–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ PIN-–∫–æ–¥';
      document.getElementById('pinError').textContent = '';
      pinMode = 'confirm';
    } else if (pinMode === 'confirm') {
      if (pinBuffer === pinFirst) {
        localStorage.setItem(PIN_KEY, pinBuffer);
        pinMode = 'check';
        pinFirst = '';
        pinBuffer = '';
        updatePinDots();
        document.getElementById('pinOverlay').classList.remove('show');
        document.getElementById('pinOverlay').querySelector('.pin-title').textContent = '–í–≤–µ–¥–∏—Ç–µ PIN-–∫–æ–¥';
        showToast('PIN-–∫–æ–¥ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω', 'success');
      } else {
        document.getElementById('pinError').textContent = 'PIN –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞';
        pinMode = 'set';
        pinFirst = '';
        pinBuffer = '';
        updatePinDots();
        document.getElementById('pinOverlay').querySelector('.pin-title').textContent = '–°–æ–∑–¥–∞–π—Ç–µ PIN-–∫–æ–¥';
      }
    }
  }

  function managePinCode() {
    const stored = localStorage.getItem(PIN_KEY);
    if (stored) {
      showConfirm('–£–¥–∞–ª–∏—Ç—å —Ç–µ–∫—É—â–∏–π PIN-–∫–æ–¥? –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ –±–µ–∑ –ø–∞—Ä–æ–ª—è.', () => {
        localStorage.removeItem(PIN_KEY);
        showToast('PIN-–∫–æ–¥ —É–¥–∞–ª—ë–Ω', 'info');
      });
    } else {
      pinMode = 'set';
      pinBuffer = '';
      pinFirst = '';
      updatePinDots();
      document.getElementById('pinOverlay').querySelector('.pin-title').textContent = '–°–æ–∑–¥–∞–π—Ç–µ PIN-–∫–æ–¥';
      document.getElementById('pinError').textContent = '';
      document.getElementById('pinOverlay').classList.add('show');
    }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  2. PRINT PRICE LIST
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function printPriceList() {
    const rate = defaultRate || 12700;
    const items = rows.map(id => {
      const name    = document.getElementById('name-' + id)?.value || '';
      const code    = document.getElementById('code-' + id)?.value || '';
      // price-${id} now contains a <span>; get only span text
      const priceSpan = document.querySelector('#price-' + id + ' span') || document.getElementById('price-' + id);
      const price   = priceSpan ? priceSpan.textContent.trim() : '‚Äî';
      const tr      = document.getElementById('row-' + id);
      const sizeCell = tr?.querySelector('.row-size-cell');
      const sizesStr = sizeCell?.getAttribute('data-sizes') || '';
      const sizes   = sizesStr ? sizesStr.split(',').filter(Boolean) : [];
      const photo   = tr?.querySelector('img.row-thumb')?.src || null;
      return { name, code, price, sizes, photo };
    }).filter(i => i.name || i.code);

    const tableRows = items.map(i => {
      const qrData  = encodeURIComponent([i.code, i.name, i.price].filter(Boolean).join(' | '));
      const qrUrl   = `https://api.qrserver.com/v1/create-qr-code/?size=72x72&data=${qrData}`;
      return `
      <tr>
        <td style="padding:10px 14px;border-bottom:1px solid #e2e8f0;width:52px">
          ${i.photo ? `<img src="${i.photo}" style="width:44px;height:44px;border-radius:8px;object-fit:cover">` : ''}
        </td>
        <td style="padding:10px 14px;border-bottom:1px solid #e2e8f0">
          <strong>${i.code || ''}</strong>${i.code && i.name ? ' ‚Äî ' : ''}${i.name || ''}
        </td>
        <td style="padding:10px 14px;border-bottom:1px solid #e2e8f0;color:#64748b;font-size:0.85rem">${i.sizes.join(', ') || '‚Äî'}</td>
        <td style="padding:10px 14px;border-bottom:1px solid #e2e8f0;font-weight:700;color:#1e293b;text-align:right;white-space:nowrap">${i.price}</td>
        <td style="padding:10px 14px;border-bottom:1px solid #e2e8f0;text-align:center;width:80px">
          <img src="${qrUrl}" style="width:56px;height:56px" alt="QR" />
        </td>
      </tr>`;
    }).join('');

    const html = `<!DOCTYPE html><html><head><meta charset="utf-8">
      <title>–ü—Ä–∞–π—Å-–ª–∏—Å—Ç</title>
      <style>
        body { font-family: -apple-system, sans-serif; margin: 24px; color: #1e293b; }
        h1 { font-size: 1.4rem; margin-bottom: 4px; }
        p.sub { color: #64748b; font-size: 0.85rem; margin: 0 0 20px; }
        table { width: 100%; border-collapse: collapse; }
        th { padding: 10px 14px; background: #f8fafc; text-align: left; font-size: 0.78rem; color: #94a3b8; text-transform: uppercase; letter-spacing: .05em; }
        tr:last-child td { border-bottom: none; }
        @media print { body { margin: 0; } }
      </style></head><body>
      <h1>–ü—Ä–∞–π—Å-–ª–∏—Å—Ç</h1>
      <p class="sub">–î–∞—Ç–∞: ${new Date().toLocaleDateString('ru-RU')} &nbsp;|&nbsp; –ö—É—Ä—Å: ${rate} —Å—É–º/$</p>
      <table>
        <thead><tr>
          <th></th><th>–¢–æ–≤–∞—Ä</th><th>–†–∞–∑–º–µ—Ä—ã</th><th style="text-align:right">–¶–µ–Ω–∞</th><th style="text-align:center">QR</th>
        </tr></thead>
        <tbody>${tableRows}</tbody>
      </table>
      <script>window.onload=()=>{ setTimeout(()=>window.print(), 800); }<\/script>
    </body></html>`;

    const w = window.open('', '_blank');
    if (w) { w.document.write(html); w.document.close(); }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  3. PRODUCT CATEGORIES (stored in data-category on tr)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function getRowCategory(id) {
    return document.getElementById('row-' + id)?.getAttribute('data-category') || '';
  }

  function setRowCategory(id, cat) {
    const tr = document.getElementById('row-' + id);
    if (!tr) return;
    tr.setAttribute('data-category', cat || '');
    // Append badge into product-card-meta (inline next to code), fallback to td
    const meta = tr.querySelector('.product-card-meta');
    const container = meta || document.getElementById('name-' + id)?.closest('td');
    if (!container) return;
    let badge = container.querySelector('.cat-badge');
    if (cat) {
      if (!badge) {
        badge = document.createElement('span');
        badge.className = 'cat-badge';
        container.appendChild(badge);
      }
      badge.textContent = cat;
    } else {
      if (badge) badge.remove();
    }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  4. UNDO LAST DELETION
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  let _undoData = null;
  let _undoTimer = null;

  function showUndoToast(data) {
    _undoData = data;
    if (_undoTimer) clearTimeout(_undoTimer);

    const container = document.getElementById('toast-container');
    if (!container) return;

    // Remove existing undo toast if any
    const existing = document.getElementById('undoToast');
    if (existing) existing.remove();

    const toast = document.createElement('div');
    toast.id = 'undoToast';
    toast.className = 'toast warning';
    toast.innerHTML = `
      <div class="toast-icon">üóë</div>
      <div class="toast-body">
        <div class="toast-title">–£–¥–∞–ª–µ–Ω–æ: ¬´${(data.code || data.name || '—Ç–æ–≤–∞—Ä').substring(0,24)}¬ª</div>
        <div class="toast-msg"><button onclick="undoDelete()" style="background:none;border:1px solid #f59e0b;color:#f59e0b;border-radius:6px;padding:2px 10px;cursor:pointer;font-size:0.8rem">‚Ü© –û—Ç–º–µ–Ω–∞</button></div>
      </div>
      <div class="toast-bar" style="animation-duration:8000ms;background:#f59e0b"></div>`;

    const dismiss = () => {
      toast.classList.add('removing');
      toast.addEventListener('animationend', () => toast.remove(), { once: true });
      _undoData = null;
    };
    container.appendChild(toast);
    _undoTimer = setTimeout(dismiss, 8000);
  }

  function undoDelete() {
    const existing = document.getElementById('undoToast');
    if (existing) existing.remove();
    if (_undoTimer) clearTimeout(_undoTimer);
    if (!_undoData) return;
    const d = _undoData;
    _undoData = null;
    // Remove from archive (it was added there by delRow)
    archive = archive.filter(a => a.archiveId !== d.archiveId);
    renderArchive();
    // Re-add to table
    const newId = addRow({ code: d.code, name: d.name, usd: d.usd, qty: d.qty, sizes: d.sizes || [], photo: null, margin: d.margin || 30, rate: d.rate || defaultRate, logistics: d.logistics || 0 });
    if (d.category) setRowCategory(newId, d.category);
    saveToFirestore();
    showToast('–£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ', 'success', 3000);
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  5. DASHBOARD RENDERING
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function renderDashboard() {
    // ‚îÄ‚îÄ Category filter ‚îÄ‚îÄ
    const catSel = document.getElementById('dashCatFilter');
    const allCats = [...new Set(rows.map(id =>
      document.getElementById('row-' + id)?.getAttribute('data-category') || ''
    ).filter(Boolean))].sort();
    const savedCat = catSel ? catSel.value : '';
    if (catSel) {
      catSel.innerHTML = '<option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>' +
        allCats.map(c => `<option value="${escH(c)}"${c === savedCat ? ' selected' : ''}>${escH(c)}</option>`).join('');
    }
    const activeCat = catSel ? catSel.value : '';

    // ‚îÄ‚îÄ KPI: Products count from main table ‚îÄ‚îÄ
    let prodCount = 0, totalUnits = 0;
    rows.forEach(id => {
      if (activeCat && document.getElementById('row-' + id)?.getAttribute('data-category') !== activeCat) return;
      const qty = parseInt(document.getElementById('qty-' + id)?.value) || 0;
      totalUnits += qty;
      prodCount++;
    });

    const fmtNum = n => n >= 1e6 ? (n/1e6).toFixed(1)+'M' : n >= 1e3 ? (n/1e3).toFixed(0)+'K' : Math.round(n).toString();

    const el = id => document.getElementById(id);
    if (el('dashProdCount'))  el('dashProdCount').textContent  = prodCount;
    if (el('dashProdUnits'))  el('dashProdUnits').textContent  = totalUnits + ' –µ–¥.';

    // ‚îÄ‚îÄ KPI: Actual sales ‚îÄ‚îÄ
    const deliveredSales = sales.filter(s => s.status === 'delivered');
    const factRevenue    = deliveredSales.reduce((acc, s) => acc + (s.price || 0) * (s.qty || 1), 0);
    const factPayout     = deliveredSales.reduce((acc, s) => acc + (s.payout || 0), 0);
    if (el('dashSalesCount'))   el('dashSalesCount').textContent   = deliveredSales.length ? deliveredSales.length + ' –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ' : '‚Äî';
    if (el('dashSalesRevenue')) el('dashSalesRevenue').textContent = factRevenue > 0 ? fmtNum(factRevenue) + ' —Å—É–º –≤—ã—Ä—É—á–∫–∞' : '–Ω–µ—Ç –ø—Ä–æ–¥–∞–∂';

    // ‚îÄ‚îÄ KPI: Warehouse stock ‚îÄ‚îÄ
    let skuCount = 0, totalOnHand = 0, totalStockVal = 0, lowCount = 0;
    whInventory.forEach(i => {
      if ((i.onHand || 0) > 0) { skuCount++; totalOnHand += i.onHand; totalStockVal += (i.onHand || 0) * (i.avgCostUZS || 0); }
      if ((i.onHand || 0) <= 0) lowCount++;
    });
    if (el('dashStockSkus'))  el('dashStockSkus').textContent  = skuCount + ' SKU';
    if (el('dashStockUnits')) el('dashStockUnits').textContent = totalOnHand + ' —à—Ç. –Ω–∞ —Ä—É–∫–∞—Ö';
    if (el('dashStockVal'))   el('dashStockVal').textContent   = fmtNum(totalStockVal) + ' —Å—É–º';
    if (el('dashLowStock'))   el('dashLowStock').textContent   = lowCount > 0 ? lowCount + ' –ø–æ–∑–∏—Ü–∏–π –Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏' : '';

    // ‚îÄ‚îÄ Section: Zero-stock alerts ‚îÄ‚îÄ
    const zeroItems = whInventory.filter(i => (i.onHand || 0) <= 0);
    const alertsEl = el('dashAlerts');
    if (alertsEl) {
      if (zeroItems.length === 0) {
        alertsEl.innerHTML = '<div style="color:#22c55e;font-size:0.82rem">–í—Å—ë –≤ –Ω–∞–ª–∏—á–∏–∏ ‚úì</div>';
      } else {
        alertsEl.innerHTML = zeroItems.slice(0, 8).map(i => `
          <div class="dash-row">
            <span>${escH(i.name || i.sku || '‚Äî')}${i.size ? ' <span class="size-badge">' + escH(i.size) + '</span>' : ''}</span>
            <span style="color:#ef4444">0 —à—Ç.</span>
          </div>`).join('') + (zeroItems.length > 8 ? `<div style="color:#4f5a7a;font-size:0.78rem;margin-top:6px">–∏ –µ—â—ë ${zeroItems.length-8}...</div>` : '');
      }
    }

    // ‚îÄ‚îÄ Section: Recent supplies ‚îÄ‚îÄ
    const suppliesEl = el('dashSupplies');
    if (suppliesEl) {
      const recent = [...whSupplies].sort((a,b) => (b.date||'').localeCompare(a.date||'')).slice(0,5);
      if (recent.length === 0) {
        suppliesEl.innerHTML = '<div style="color:#4f5a7a;font-size:0.82rem">–ù–µ—Ç –ø–æ—Å—Ç–∞–≤–æ–∫</div>';
      } else {
        suppliesEl.innerHTML = recent.map(s => `
          <div class="dash-row">
            <span>${escH(s.supplier || s.date || '‚Äî')}<br><span style="font-size:0.75rem;color:#4f5a7a">${escH(s.date||'')} ¬∑ ${(s.items||[]).length} –ø–æ–∑.</span></span>
            <span style="color:#06b6d4">${escH(s.status||'—á–µ—Ä–Ω–æ–≤–∏–∫')}</span>
          </div>`).join('');
      }
    }

    // ‚îÄ‚îÄ Section: Recent writeoffs ‚îÄ‚îÄ
    const writeoffsEl = el('dashWriteoffs');
    if (writeoffsEl) {
      const recent = [...whWriteoffs].sort((a,b) => (b.date||'').localeCompare(a.date||'')).slice(0,5);
      if (recent.length === 0) {
        writeoffsEl.innerHTML = '<div style="color:#4f5a7a;font-size:0.82rem">–ù–µ—Ç —Å–ø–∏—Å–∞–Ω–∏–π</div>';
      } else {
        writeoffsEl.innerHTML = recent.map(w => `
          <div class="dash-row">
            <span>${escH(w.type || w.reason || '‚Äî')}<br><span style="font-size:0.75rem;color:#4f5a7a">${escH(w.date||'')} ¬∑ ${(w.items||[]).length} –ø–æ–∑.</span></span>
            <span style="color:#f59e0b">${escH(w.status||'—á–µ—Ä–Ω–æ–≤–∏–∫')}</span>
          </div>`).join('');
      }
    }

    // ‚îÄ‚îÄ Section: Batch structure (grouped by product) ‚îÄ‚îÄ
    const batchEl = el('dashBatchDetails');
    if (batchEl) {
      if (rows.length === 0) {
        batchEl.innerHTML = '<div style="color:#4f5a7a;font-size:0.82rem">–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä—ã –≤–æ –≤–∫–ª–∞–¥–∫–µ –¢–æ–≤–∞—Ä—ã</div>';
      } else {
        // Group rows by code||name, sum qty and total cost
        const groups = {};
        rows.forEach(id => {
          const name  = document.getElementById('name-' + id)?.value || '';
          const code  = document.getElementById('code-' + id)?.value || '';
          const qty   = parseInt(document.getElementById('qty-' + id)?.value) || 0;
          const cogsText = document.getElementById('cogs-' + id)?.textContent?.replace(/[^\d.-]/g,'') || '0';
          const cogs  = parseFloat(cogsText) || 0;
          const key   = (code || name).trim();
          if (!key) return;
          if (!groups[key]) groups[key] = { label: key, qty: 0, totalCogs: 0 };
          groups[key].qty      += qty;
          groups[key].totalCogs += cogs * qty;
        });
        const sorted = Object.values(groups).sort((a, b) => b.totalCogs - a.totalCogs);
        // Store data globally so named onclick handler can access it without toString() serialization
        window._batchSorted = sorted;
        window._batchEscH   = escH;
        dashRenderBatch(false);
      }
    }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  6. PDF EXPORT FOR SUPPLY / WRITEOFF DOCUMENTS
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  function printSupplyDoc(id) {
    const s = whSupplies.find(x => x.id === id);
    if (!s) return;
    const tableRows = (s.items || []).map(i => `
      <tr>
        <td>${escH(i.name||'‚Äî')}</td>
        <td style="text-align:center">${escH(i.sku||'‚Äî')}</td>
        <td style="text-align:center">${i.qty||0}</td>
        <td style="text-align:right">${Math.round(i.unitLandedUZS||0).toLocaleString('ru-RU')}</td>
        <td style="text-align:right">${Math.round((i.qty||0)*(i.unitLandedUZS||0)).toLocaleString('ru-RU')}</td>
      </tr>`).join('');
    const total = (s.items||[]).reduce((acc, i) => acc + (i.qty||0)*(i.unitLandedUZS||0), 0);
    const html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>–ü–æ—Å—Ç–∞–≤–∫–∞</title>
      <style>body{font-family:-apple-system,sans-serif;margin:24px;color:#1e293b}
      h1{font-size:1.2rem;margin-bottom:2px} .sub{color:#64748b;font-size:.82rem;margin:0 0 18px}
      table{width:100%;border-collapse:collapse;font-size:.88rem}
      th{background:#f8fafc;padding:8px 12px;text-align:left;color:#94a3b8;font-size:.75rem;text-transform:uppercase}
      td{padding:8px 12px;border-bottom:1px solid #e2e8f0}
      .total{text-align:right;font-weight:700;font-size:1rem;margin-top:12px}
      @media print{body{margin:0}}</style></head><body>
      <h1>–ü–æ—Å—Ç–∞–≤–∫–∞ #${escH(s.invoice||id.slice(-6))}</h1>
      <p class="sub">–î–∞—Ç–∞: ${escH(s.date||'‚Äî')} &nbsp;|&nbsp; –ü–æ—Å—Ç–∞–≤—â–∏–∫: ${escH(s.supplier||'‚Äî')} &nbsp;|&nbsp; –°—Ç–∞—Ç—É—Å: ${escH(s.status||'‚Äî')}</p>
      <table><thead><tr><th>–¢–æ–≤–∞—Ä</th><th style="text-align:center">SKU</th><th style="text-align:center">–ö–æ–ª-–≤–æ</th><th style="text-align:right">–¶–µ–Ω–∞/–µ–¥ (—Å—É–º)</th><th style="text-align:right">–°—É–º–º–∞</th></tr></thead>
      <tbody>${tableRows}</tbody></table>
      <div class="total">–ò—Ç–æ–≥–æ: ${Math.round(total).toLocaleString('ru-RU')} —Å—É–º</div>
      <script>window.onload=()=>{window.print()}<\/script></body></html>`;
    const w = window.open('', '_blank');
    if (w) { w.document.write(html); w.document.close(); }
  }

  function printWriteoffDoc(id) {
    const wo = whWriteoffs.find(x => x.id === id);
    if (!wo) return;
    const tableRows = (wo.items || []).map(i => `
      <tr>
        <td>${escH(i.name||'‚Äî')}</td>
        <td style="text-align:center">${escH(i.sku||'‚Äî')}</td>
        <td style="text-align:center">${i.qty||0}</td>
        <td style="text-align:right">${Math.round(i.avgCostUZS||0).toLocaleString('ru-RU')}</td>
        <td style="text-align:right">${Math.round((i.qty||0)*(i.avgCostUZS||0)).toLocaleString('ru-RU')}</td>
      </tr>`).join('');
    const total = (wo.items||[]).reduce((acc, i) => acc + (i.qty||0)*(i.avgCostUZS||0), 0);
    const html = `<!DOCTYPE html><html><head><meta charset="utf-8"><title>–°–ø–∏—Å–∞–Ω–∏–µ</title>
      <style>body{font-family:-apple-system,sans-serif;margin:24px;color:#1e293b}
      h1{font-size:1.2rem;margin-bottom:2px} .sub{color:#64748b;font-size:.82rem;margin:0 0 18px}
      table{width:100%;border-collapse:collapse;font-size:.88rem}
      th{background:#f8fafc;padding:8px 12px;text-align:left;color:#94a3b8;font-size:.75rem;text-transform:uppercase}
      td{padding:8px 12px;border-bottom:1px solid #e2e8f0}
      .total{text-align:right;font-weight:700;font-size:1rem;margin-top:12px}
      @media print{body{margin:0}}</style></head><body>
      <h1>–°–ø–∏—Å–∞–Ω–∏–µ: ${escH(wo.type||wo.reason||'‚Äî')}</h1>
      <p class="sub">–î–∞—Ç–∞: ${escH(wo.date||'‚Äî')} &nbsp;|&nbsp; –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π: ${escH(wo.comment||'‚Äî')}</p>
      <table><thead><tr><th>–¢–æ–≤–∞—Ä</th><th style="text-align:center">SKU</th><th style="text-align:center">–ö–æ–ª-–≤–æ</th><th style="text-align:right">–°–µ–±–µ—Å—Ç. (—Å—É–º)</th><th style="text-align:right">–°—É–º–º–∞</th></tr></thead>
      <tbody>${tableRows}</tbody></table>
      <div class="total">–ò—Ç–æ–≥–æ: ${Math.round(total).toLocaleString('ru-RU')} —Å—É–º</div>
      <script>window.onload=()=>{window.print()}<\/script></body></html>`;
    const w = window.open('', '_blank');
    if (w) { w.document.write(html); w.document.close(); }
  }

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  //  7. BACKUP / RESTORE JSON
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  async function exportBackup() {
    showToast('–°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏...', 'info', 3000);
    try {
      const backup = { exportedAt: new Date().toISOString(), version: 2 };

      // Main workspace
      const ws = await col('praicer').doc('workspace').get();
      backup.workspace = ws.exists ? ws.data() : null;

      // Warehouse collections
      const colNames = ['wh_inventory', 'wh_moves', 'wh_supplies', 'wh_writeoffs', 'wh_inventories'];
      for (const col of colNames) {
        const snap = await db.collection(col).get();
        backup[col] = snap.docs.map(d => ({ _id: d.id, ...d.data() }));
      }

      const json  = JSON.stringify(backup, null, 2);
      const blob  = new Blob([json], { type: 'application/json' });
      const url   = URL.createObjectURL(blob);
      const a     = document.createElement('a');
      a.href      = url;
      a.download  = `praicer_backup_${new Date().toISOString().slice(0,10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–∫–∞—á–∞–Ω–∞', 'success');
    } catch (err) {
      console.error('exportBackup:', err);
      showToast('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞: ' + err.message, 'error');
    }
  }

  async function importBackup(file) {
    if (!file) return;
    // Reset input so same file can be re-selected
    document.getElementById('backupRestoreInput').value = '';

    let backup;
    try {
      const text = await file.text();
      backup = JSON.parse(text);
    } catch {
      showToast('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —Ñ–∞–π–ª', 'error'); return;
    }
    if (!backup.workspace && !backup.wh_inventory) {
      showToast('–§–∞–π–ª –Ω–µ —è–≤–ª—è–µ—Ç—Å—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–µ–π Praicer', 'error'); return;
    }

    showConfirm('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞? –¢–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –±—É–¥—É—Ç –∑–∞–º–µ–Ω–µ–Ω—ã.', async () => {
      showToast('–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ...', 'info', 6000);
      try {
        const batch = db.batch();

        // Main workspace
        if (backup.workspace) {
          batch.set(col('praicer').doc('workspace'), backup.workspace);
        }

        // Warehouse collections ‚Äî delete not supported in batch, so use individual writes
        const colNames = ['wh_inventory', 'wh_moves', 'wh_supplies', 'wh_writeoffs', 'wh_inventories'];
        for (const col of colNames) {
          const items = backup[col];
          if (!Array.isArray(items)) continue;
          for (const item of items) {
            const { _id, ...data } = item;
            if (_id) {
              batch.set(db.collection(col).doc(_id), data);
            }
          }
        }

        await batch.commit();
        showToast('–î–∞–Ω–Ω—ã–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.', 'success', 8000);
      } catch (err) {
        console.error('importBackup:', err);
        showToast('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: ' + err.message, 'error');
      }
    });
  }

  // ‚îÄ‚îÄ Start: Auth triggers sync + PIN + exchange rate after login ‚îÄ‚îÄ
  initAuth();
</script>

<!-- ‚ïê‚ïê‚ïê MOBILE BOTTOM NAVIGATION ‚ïê‚ïê‚ïê -->
<nav class="mobile-nav" id="mobileNav">
  <button class="mobile-nav-btn active" onclick="showTab('dashboard',this)" data-tab="dashboard">
    <span class="mobile-nav-icon">üè†</span><span class="mobile-nav-label">–ì–ª–∞–≤–Ω–∞—è</span>
  </button>
  <button class="mobile-nav-btn" onclick="showTab('products',this)" data-tab="products">
    <span class="mobile-nav-icon">üìã</span><span class="mobile-nav-label">–¢–æ–≤–∞—Ä—ã</span>
  </button>
  <button class="mobile-nav-btn" onclick="showTab('analytics',this)" data-tab="analytics">
    <span class="mobile-nav-icon">üìä</span><span class="mobile-nav-label">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</span>
  </button>
  <button class="mobile-nav-btn" onclick="showTab('warehouse',this)" data-tab="warehouse">
    <span class="mobile-nav-icon">üì¶</span><span class="mobile-nav-label">–°–∫–ª–∞–¥</span>
  </button>
  <button class="mobile-nav-btn" onclick="showTab('sales',this)" data-tab="sales">
    <span class="mobile-nav-icon">üí∞</span><span class="mobile-nav-label">–ü—Ä–æ–¥–∞–∂–∏</span>
  </button>
</nav>
</body>
</html>
