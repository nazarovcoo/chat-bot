<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport"
    content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
  <title>BotPanel ‚Äî –°–æ–∑–¥–∞–π—Ç–µ AI-–±–æ—Ç–∞ –¥–ª—è Telegram –∑–∞ 5 –º–∏–Ω—É—Ç</title>

  <script>
    window.BUILD_VERSION = "2026-02-28.4";
    window.FORCE_PROJECTS_MAIN = true;
    (function initMiniAppIosFixFlag() {
      try {
        const qp = new URLSearchParams(window.location.search);
        const qpFlag = qp.get('miniapp_ios_fix');
        const lsFlag = localStorage.getItem('MINIAPP_IOS_FIX');
        let enabled = true;
        if (lsFlag === '0' || lsFlag === 'false') enabled = false;
        if (lsFlag === '1' || lsFlag === 'true') enabled = true;
        if (qpFlag === '0') enabled = false;
        if (qpFlag === '1') enabled = true;
        window.MINIAPP_IOS_FIX = enabled;
      } catch (_) {
        window.MINIAPP_IOS_FIX = true;
      }
    })();
    // GLOBAL ERROR HANDLING
    function logClientError(msg, source, lineno, colno, error, type = "Error") {
      try {
        if (!firebase || !firebase.firestore) return;
        const uid = window.resolvedUid || null;
        const targetColl = uid ? `users/${uid}/client_errors` : 'public_client_errors';
        firebase.firestore().collection(targetColl).add({
          buildVersion: window.BUILD_VERSION,
          type: type,
          message: msg,
          source: source,
          line: lineno,
          col: colno,
          stack: error && error.stack ? error.stack : null,
          url: window.location.href,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).catch(e => console.error("Failed to log to Firestore", e));

        // Show friendly toast to user
        const toast = document.createElement('div');
        toast.className = 'error-toast';
        toast.style.cssText = "position:fixed;bottom:20px;left:50%;transform:translateX(-50%);background:#ff3b30;color:#fff;padding:12px 20px;border-radius:8px;z-index:999999;font-weight:600;box-shadow:0 10px 30px rgba(255,59,48,0.3);text-align:center;animation:slideUp 0.3s ease-out;";
        toast.innerHTML = `–û—à–∏–±–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞. <br><button onclick="window.location.reload()" style="margin-top:8px;background:#fff;color:#ff3b30;border:none;border-radius:6px;padding:6px 12px;cursor:pointer;font-weight:bold;">–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É</button>`;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 10000);
      } catch (e) {
        console.error("Critical error in error logger:", e);
      }
    }
    window.onerror = function (msg, source, lineno, colno, error) {
      logClientError(msg, source, lineno, colno, error, "Uncaught Exception");
      return false; // let browser log it as well
    };
    window.addEventListener('unhandledrejection', function (event) {
      logClientError(event.reason ? (typeof event.reason === 'string' ? event.reason : event.reason.message) : "Promise rejected", null, 0, 0, event.reason, "Unhandled Rejection");
    });
  </script>

  <link rel="icon"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='22' fill='%23000000'/><text y='74' x='50' text-anchor='middle' font-size='58' font-family='system-ui'>ü§ñ</text></svg>" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:ital,wght@0,400;0,500;0,600;0,700;0,800;0,900;1,400;1,500;1,600;1,700;1,800;1,900&display=swap"
    rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <link rel="stylesheet" href="./css/miniapp.css?v=2026-02-28.1">
  <script src="./js/miniapp.js?v=2026-02-28.1"></script>
  <script src="./js/state.js"></script>
  <script src="./js/api.js"></script>
  <script src="./js/ui.js"></script>
  <script src="./js/i18n.js"></script>
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* ‚ïê‚ïê CHATPLACE THEME ‚ïê‚ïê */
    :root {
      --bg: #FFFFFF;
      --surface: #FFFFFF;
      --surface2: #F8F8F8;
      --border: #E8E8E8;
      --border2: #F3F3F3;
      --primary: #000000;
      --primary-dark: #000000;
      --primary-dim: rgba(0, 0, 0, 0.05);
      --primary-brd: rgba(0, 0, 0, 0.15);
      --indigo: #000000;
      --text: #171717;
      --text-sec: #737373;
      --text-dim: #A3A3A3;
      --green: #22c55e;
      --red: #ef4444;
      --yellow: #f59e0b;
      --cyan: #06b6d4;
      --shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
      --radius-pill: 9999px;
      --radius-card: 20px;
      --radius-btn: 12px;
      --radius-input: 12px;
    }

    [data-theme="dark"] {
      --bg: #0a0a0a;
      --surface: #141414;
      --surface2: #0f0f0f;
      --border: #262626;
      --border2: #1a1a1a;
      --primary: #FFFFFF;
      --primary-dim: rgba(255, 255, 255, 0.08);
      --primary-brd: rgba(255, 255, 255, 0.2);
      --indigo: #FFFFFF;
      --text: #f5f5f5;
      --text-sec: #a3a3a3;
      --text-dim: #525252;
      --shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
    }

    [data-theme="dark"] .btn-primary,
    [data-theme="dark"] .btn-modal-ok,
    [data-theme="dark"] .create-agent-btn {
      color: #000;
    }

    [data-theme="dark"] .btn-primary:hover,
    [data-theme="dark"] .btn-modal-ok:hover {
      background: #e0e0e0;
    }

    [data-theme="dark"] .pb-fill {
      background: linear-gradient(90deg, #fff 40%, #ccc 55%, #fff 70%);
      background-size: 200% 100%;
    }

    [data-theme="dark"] .form-input:focus {
      border-color: #fff;
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.08);
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      height: 100vh;
      display: flex;
      overflow: hidden;
    }

    ::-webkit-scrollbar {
      width: 4px;
      height: 4px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 4px;
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       SIDEBAR
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    .sidebar {
      width: 230px;
      min-width: 230px;
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      transition: background 0.25s, border-color 0.25s;
    }

    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 9px;
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }

    .logo-box {
      width: 30px;
      height: 30px;
      border-radius: 8px;
      background: #000000;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }

    .logo-text {
      font-size: 0.88rem;
      font-weight: 800;
    }

    /* Main top-level nav tabs */
    .top-nav {
      display: flex;
      border-bottom: 1px solid var(--border);
    }

    .top-nav-btn {
      flex: 1;
      padding: 10px 8px;
      font-size: 0.75rem;
      font-weight: 700;
      border: none;
      background: transparent;
      color: var(--text-dim);
      cursor: pointer;
      letter-spacing: 0.04em;
      border-bottom: 2px solid transparent;
      transition: all 0.15s;
    }

    .top-nav-btn.active {
      color: var(--indigo);
      border-bottom-color: var(--primary);
    }

    .top-nav-btn:hover:not(.active) {
      color: var(--text-sec);
    }

    .sidebar-scroll {
      flex: 1;
      overflow-y: auto;
      padding: 8px;
    }

    .nav-label {
      font-size: 0.58rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--text-dim);
      padding: 10px 8px 5px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--text-sec);
      cursor: pointer;
      transition: all 0.15s;
      margin-bottom: 1px;
      border: 1px solid transparent;
    }

    .nav-item:hover {
      background: var(--primary-dim);
      color: var(--text);
    }

    .nav-item.active {
      background: var(--primary-dim);
      color: var(--indigo);
      border-color: var(--primary-brd);
    }

    .nav-item:active {
      animation: jelly 0.35s ease;
    }

    .nav-ico {
      font-size: 13px;
      width: 16px;
      text-align: center;
      flex-shrink: 0;
    }

    .nav-badge {
      margin-left: auto;
      background: var(--red);
      color: #fff;
      border-radius: 12px;
      font-size: 0.58rem;
      font-weight: 800;
      padding: 2px 6px;
    }

    .nav-count {
      margin-left: auto;
      font-size: 0.65rem;
      color: var(--text-dim);
    }

    /* ‚ïê‚ïê KB NAV GROUP ‚ïê‚ïê */
    .nav-kb-group {
      margin-bottom: 2px;
    }

    .nav-sub-list {
      padding-left: 10px;
      margin-top: 1px;
    }

    .nav-item.nav-sub {
      font-size: 0.75rem;
      padding: 5px 10px;
    }

    .nav-sub-sep {
      height: 1px;
      background: var(--border2);
      margin: 4px 10px;
    }

    /* ‚îÄ‚îÄ Create Agent button ‚îÄ‚îÄ */
    .create-agent-btn {
      width: calc(100% - 16px);
      margin: 10px 8px 6px;
      padding: 10px 14px;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: var(--radius-pill);
      font-size: 0.82rem;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
      user-select: none;
    }

    .create-agent-btn:hover {
      opacity: 0.88;
    }

    .create-agent-btn:active {
      animation: jelly 0.4s ease;
    }

    /* ‚îÄ‚îÄ Bot nav list ‚îÄ‚îÄ */
    .bot-nav-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 8px;
      font-size: 0.8rem;
      color: var(--text-sec);
      cursor: pointer;
      transition: all 0.15s;
      margin-bottom: 2px;
      border: 1px solid transparent;
    }

    .bot-nav-item:hover {
      background: var(--primary-dim);
      color: var(--text);
    }

    .bot-nav-item.active {
      background: var(--primary-dim);
      color: var(--indigo);
      border-color: var(--primary-brd);
    }

    .bot-nav-av {
      width: 22px;
      height: 22px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 700;
      color: #fff;
      flex-shrink: 0;
      overflow: hidden;
    }

    .bot-nav-av img,
    .ov-bot-av img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: inherit;
    }

    /* ‚îÄ‚îÄ Home screen ‚îÄ‚îÄ */
    .home-hero {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 60px 40px;
      gap: 16px;
      max-width: 520px;
      margin: 0 auto;
    }

    .home-hero-icon {
      font-size: 64px;
      margin-bottom: 4px;
    }

    .home-hero-title {
      font-size: 1.5rem;
      font-weight: 800;
      color: var(--text);
    }

    .home-hero-sub {
      font-size: 0.88rem;
      color: var(--text-sec);
      line-height: 1.6;
      max-width: 360px;
    }

    .home-steps {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 8px;
      width: 100%;
      text-align: left;
    }

    .home-step {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px;
    }

    .home-step-ico {
      font-size: 22px;
      margin-bottom: 8px;
    }

    .home-step-ttl {
      font-size: 0.78rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 3px;
    }

    .home-step-sub {
      font-size: 0.7rem;
      color: var(--text-sec);
      line-height: 1.4;
    }

    /* ‚îÄ‚îÄ Bot overview ‚îÄ‚îÄ */
    .ov-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 20px 22px;
      margin-bottom: 14px;
      position: sticky;
      top: 0;
      z-index: 20;
    }

    .ov-bot-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .ov-bot-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .ov-bot-av {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      font-weight: 800;
      color: #fff;
      flex-shrink: 0;
    }

    .ov-bot-name {
      font-size: 1.05rem;
      font-weight: 800;
      color: var(--text);
    }

    .ov-bot-username {
      font-size: 0.78rem;
      color: var(--text-sec);
      margin-top: 2px;
    }

    .ov-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
    }

    /* ‚ïê‚ïê‚ïê ONBOARDING GUIDE TIPS ‚ïê‚ïê‚ïê */
    .guide-tip {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.08), rgba(59, 130, 246, 0.06));
      border: 1px solid rgba(99, 102, 241, 0.2);
      border-radius: 12px;
      padding: 14px 16px;
      margin-bottom: 16px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
      animation: guideFadeIn 0.3s ease;
    }

    [data-theme="dark"] .guide-tip {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.12), rgba(59, 130, 246, 0.08));
      border-color: rgba(99, 102, 241, 0.3);
    }

    @keyframes guideFadeIn {
      from {
        opacity: 0;
        transform: translateY(-8px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .guide-tip-icon {
      font-size: 1.3rem;
      flex-shrink: 0;
      margin-top: 1px;
    }

    .guide-tip-body {
      flex: 1;
      min-width: 0;
    }

    .guide-tip-title {
      font-weight: 700;
      font-size: 0.85rem;
      margin-bottom: 4px;
      color: var(--text);
    }

    .guide-tip-text {
      font-size: 0.78rem;
      color: var(--text-sec);
      line-height: 1.5;
    }

    .guide-tip-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      align-items: center;
    }

    .guide-tip-next {
      background: var(--primary);
      color: var(--bg);
      border: none;
      border-radius: 8px;
      padding: 6px 14px;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      transition: opacity 0.15s;
    }

    .guide-tip-next:hover {
      opacity: 0.85;
    }

    .guide-tip-dismiss {
      background: none;
      border: none;
      color: var(--text-dim);
      font-size: 0.72rem;
      cursor: pointer;
      padding: 4px 8px;
    }

    .guide-tip-dismiss:hover {
      color: var(--text-sec);
    }

    .guide-tip-close {
      background: none;
      border: none;
      color: var(--text-dim);
      cursor: pointer;
      position: absolute;
      top: 10px;
      right: 10px;
    }

    /* ‚ïê‚ïê KB DRAWER, STATUS BAR & CONFIRM (scoped to chat overlay) ‚ïê‚ïê */

    /* Status bar */
    #onboarding-chat-overlay .chatos-statusbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 5px 14px;
      background: #fff;
      border-bottom: 1px solid rgba(15, 23, 42, .07);
      flex-shrink: 0;
    }

    #onboarding-chat-overlay .cs-left {
      display: flex;
      align-items: center;
      gap: 5px;
      flex-wrap: wrap;
    }

    #onboarding-chat-overlay .cs-pill {
      font-size: 11px;
      font-weight: 600;
      color: #475569;
      background: transparent;
      border: none;
      padding: 2px 0;
      white-space: nowrap;
    }

    #onboarding-chat-overlay .cs-pill+.cs-pill::before {
      content: '¬∑';
      margin-right: 5px;
      color: #cbd5e1;
    }

    #onboarding-chat-overlay .cs-right {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    #onboarding-chat-overlay .cs-iconbtn {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #3390ec;
    }

    #onboarding-chat-overlay .cs-iconbtn:hover {
      background: rgba(51, 144, 236, .08);
    }

    /* KB backdrop */
    #onboarding-chat-overlay .kb-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, .35);
      z-index: 80;
    }

    #onboarding-chat-overlay .kb-backdrop.hidden {
      display: none !important;
    }

    /* KB drawer */
    #onboarding-chat-overlay .kb-drawer {
      position: fixed;
      top: 0;
      right: 0;
      height: 100dvh;
      width: min(420px, 92vw);
      z-index: 90;
      background: #fff;
      border-left: 1px solid rgba(15, 23, 42, .08);
      box-shadow: -20px 0 40px rgba(15, 23, 42, .12);
      display: flex;
      flex-direction: column;
    }

    #onboarding-chat-overlay .kb-drawer.hidden {
      display: none !important;
    }

    #onboarding-chat-overlay .kb-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(15, 23, 42, .08);
    }

    #onboarding-chat-overlay .kb-title {
      font-size: 14.5px;
      font-weight: 750;
      color: #0f172a;
    }

    #onboarding-chat-overlay .kb-close {
      width: 34px;
      height: 34px;
      border-radius: 10px;
      border: 1px solid rgba(15, 23, 42, .10);
      background: #fff;
      cursor: pointer;
    }

    #onboarding-chat-overlay .kb-close:hover {
      background: rgba(15, 23, 42, .04);
    }

    #onboarding-chat-overlay .kb-body {
      padding: 14px;
      overflow: auto;
      flex: 1 1 auto;
    }

    #onboarding-chat-overlay .kb-empty {
      border: 1px dashed rgba(15, 23, 42, .18);
      border-radius: 14px;
      padding: 16px;
      background: rgba(15, 23, 42, .02);
    }

    #onboarding-chat-overlay .kb-empty-title {
      font-weight: 750;
      font-size: 13.5px;
      color: #0f172a;
    }

    #onboarding-chat-overlay .kb-empty-sub {
      margin-top: 5px;
      font-size: 12.5px;
      color: #475569;
      line-height: 1.4;
    }

    #onboarding-chat-overlay .kb-empty-actions {
      margin-top: 12px;
      display: flex;
      gap: 8px;
    }

    #onboarding-chat-overlay .kb-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    #onboarding-chat-overlay .kb-item {
      border: 1px solid rgba(15, 23, 42, .08);
      border-radius: 14px;
      padding: 12px;
      background: #fff;
    }

    #onboarding-chat-overlay .kb-item-title {
      font-weight: 700;
      font-size: 13px;
      color: #0f172a;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    #onboarding-chat-overlay .kb-item-sub {
      margin-top: 4px;
      font-size: 12px;
      color: #64748b;
      display: flex;
      justify-content: space-between;
      gap: 8px;
    }

    #onboarding-chat-overlay .kb-item-actions {
      margin-top: 10px;
      display: flex;
      gap: 8px;
    }

    #onboarding-chat-overlay .kb-btn {
      border-radius: 10px;
      border: 1px solid rgba(15, 23, 42, .12);
      background: #fff;
      padding: 7px 11px;
      cursor: pointer;
      font-weight: 700;
      font-size: 12px;
    }

    #onboarding-chat-overlay .kb-btn:hover {
      background: rgba(15, 23, 42, .04);
    }

    #onboarding-chat-overlay .kb-btn-delete {
      color: #ef4444;
      border-color: rgba(239, 68, 68, .25);
    }

    #onboarding-chat-overlay .kb-btn-delete:hover {
      background: rgba(239, 68, 68, .05);
    }

    #onboarding-chat-overlay .kb-refresh-btn {
      border-radius: 10px;
      border: 1px solid rgba(15, 23, 42, .12);
      background: #fff;
      padding: 8px 12px;
      cursor: pointer;
      font-weight: 700;
      font-size: 12.5px;
    }

    #onboarding-chat-overlay .kb-refresh-btn:hover {
      background: rgba(15, 23, 42, .04);
    }

    /* ‚ïê‚ïê CHAT OS UX v2 ‚ïê‚ïê */

    /* 1. Animated typing indicator */
    #chat-os-typing {
      padding: 10px 14px !important;
      display: flex !important;
      align-items: center;
      gap: 4px;
    }

    .cos-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #94a3b8;
      animation: cosDotBounce 1.2s infinite ease-in-out;
      flex-shrink: 0;
    }

    .cos-dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .cos-dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    @keyframes cosDotBounce {

      0%,
      60%,
      100% {
        transform: translateY(0);
        opacity: 0.55;
      }

      30% {
        transform: translateY(-7px);
        opacity: 1;
      }
    }

    /* 2. Timestamps */
    .cos-time {
      font-size: 11px;
      color: #8d9ea9;
      text-align: right;
      margin-top: 4px;
      line-height: 1;
      user-select: none;
    }

    .msg-user .cos-time {
      color: #5fa377;
    }

    /* 3. Message grouping */
    .msg-grp.msg-bot {
      border-top-left-radius: 2px;
      margin-top: 1px;
    }

    .msg-grp.msg-user {
      border-top-right-radius: 2px;
      margin-top: 1px;
    }

    /* 5. Markdown */
    .cos-code {
      font-family: 'SF Mono', 'Fira Code', monospace;
      background: rgba(15, 23, 42, .08);
      padding: 1px 5px;
      border-radius: 4px;
      font-size: 0.87em;
    }

    .cos-pre {
      background: rgba(15, 23, 42, .07);
      border-radius: 8px;
      padding: 10px 12px;
      margin: 4px 0;
      overflow-x: auto;
      font-family: 'SF Mono', monospace;
      font-size: 0.84em;
    }

    .msg-bot ul,
    .msg-user ul {
      margin: 5px 0 2px 14px;
      padding: 0;
    }

    .msg-bot li,
    .msg-user li {
      margin-bottom: 3px;
    }

    /* 6. Scroll-to-bottom button */
    .cos-scroll-btn {
      position: sticky;
      bottom: 10px;
      right: 0;
      align-self: flex-end;
      width: 34px;
      height: 34px;
      border-radius: 50%;
      background: #fff;
      border: none;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.22);
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 5;
      transition: opacity .2s, transform .2s;
      margin-right: 4px;
    }

    .cos-scroll-btn.hidden {
      opacity: 0;
      pointer-events: none;
      transform: scale(0.7);
    }

    /* 7. Empty state */
    .cos-empty {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 10px;
      text-align: center;
      padding: 40px 20px;
      pointer-events: none;
      user-select: none;
    }

    .cos-empty.hidden {
      display: none;
    }

    .cos-empty-icon {
      font-size: 44px;
      opacity: 0.35;
    }

    .cos-empty-title {
      font-weight: 700;
      font-size: 15px;
      color: #0f172a;
      opacity: 0.5;
    }

    .cos-empty-sub {
      font-size: 12.5px;
      color: #64748b;
      opacity: 0.65;
      line-height: 1.45;
      max-width: 200px;
    }

    /* 8. Copy button */
    .cos-copy-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      opacity: 0;
      transition: opacity .15s;
      background: rgba(15, 23, 42, .07);
      border: none;
      border-radius: 6px;
      padding: 2px 6px;
      cursor: pointer;
      font-size: 12px;
      color: #475569;
      line-height: 1.4;
    }

    .msg-bot:hover .cos-copy-btn {
      opacity: 1;
    }

    /* 9. Reactions */
    .cos-reactions {
      display: flex;
      gap: 4px;
      margin-top: 3px;
      align-self: flex-start;
      margin-bottom: 6px;
    }

    .cos-react {
      background: #fff;
      border: 1px solid rgba(0, 0, 0, .1);
      border-radius: 14px;
      padding: 2px 9px;
      cursor: pointer;
      font-size: 14px;
      transition: all .15s;
      line-height: 1.6;
    }

    .cos-react:hover {
      border-color: rgba(0, 0, 0, .22);
      transform: scale(1.08);
    }

    .cos-react.active {
      background: #effdde;
      border-color: #4caf50;
    }

    /* 4. Textarea auto-grow */
    textarea.chat-ob-input {
      resize: none;
      overflow: hidden;
      max-height: 120px;
      line-height: 1.4;
      padding-top: 8px;
      padding-bottom: 8px;
      display: block;
    }

    /* In-chat confirm modal */
    #onboarding-chat-overlay .chat-confirm {
      position: fixed;
      inset: 0;
      z-index: 120;
      background: rgba(2, 6, 23, .35);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 18px;
    }

    #onboarding-chat-overlay .chat-confirm.hidden {
      display: none !important;
    }

    #onboarding-chat-overlay .cc-card {
      width: min(380px, 92vw);
      background: #fff;
      border-radius: 18px;
      border: 1px solid rgba(15, 23, 42, .08);
      box-shadow: 0 20px 50px rgba(15, 23, 42, .18);
      padding: 18px;
    }

    #onboarding-chat-overlay .cc-title {
      font-weight: 800;
      font-size: 14.5px;
      color: #0f172a;
    }

    #onboarding-chat-overlay .cc-text {
      margin-top: 7px;
      font-size: 13px;
      color: #475569;
      line-height: 1.4;
    }

    #onboarding-chat-overlay .cc-actions {
      margin-top: 14px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    #onboarding-chat-overlay .cc-btn {
      border-radius: 10px;
      border: 1px solid rgba(15, 23, 42, .12);
      background: #fff;
      padding: 9px 14px;
      cursor: pointer;
      font-weight: 800;
      font-size: 13px;
    }

    #onboarding-chat-overlay .cc-btn--ghost:hover {
      background: rgba(15, 23, 42, .04);
    }

    #onboarding-chat-overlay .cc-btn--danger {
      border-color: rgba(239, 68, 68, .3);
      color: #ef4444;
    }

    #onboarding-chat-overlay .cc-btn--danger:hover {
      background: rgba(239, 68, 68, .06);
    }

    .hidden {
      display: none !important;
    }

    /* ‚îÄ‚îÄ Skeleton loader ‚îÄ‚îÄ */
    .cos-skeleton-wrap {
      display: flex;
      flex-direction: column;
      gap: 7px;
      max-width: 68%;
      align-self: flex-start;
      padding: 10px 14px;
      background: #fff;
      border-radius: 0 10px 10px 10px;
    }

    .cos-skeleton-wrap+.cos-skeleton-wrap {
      margin-top: 4px;
      border-top-left-radius: 3px;
    }

    .cos-skeleton-line {
      height: 13px;
      border-radius: 6px;
      background: linear-gradient(90deg, #f0f2f5 25%, #e4e8ec 50%, #f0f2f5 75%);
      background-size: 200% 100%;
      animation: cosSkeletonShimmer 1.6s infinite;
    }

    @keyframes cosSkeletonShimmer {
      0% {
        background-position: 200% 0;
      }

      100% {
        background-position: -200% 0;
      }
    }

    /* ‚îÄ‚îÄ Connection status ‚îÄ‚îÄ */
    #cos-conn-status {
      display: none;
      text-align: center;
      font-size: 11.5px;
      color: #707579;
      padding: 5px 12px;
      background: rgba(255, 193, 7, .1);
      border-bottom: 1px solid rgba(255, 193, 7, .25);
    }

    #cos-conn-status.visible {
      display: block;
    }

    /* ‚îÄ‚îÄ Message send-status ‚îÄ‚îÄ */
    .cos-send-status {
      display: inline-block;
      font-size: 10px;
      color: #a8b8c0;
      margin-left: 3px;
      vertical-align: middle;
      user-select: none;
    }

    .cos-send-status.failed {
      color: #ef4444;
      cursor: pointer;
      text-decoration: underline dotted;
    }

    /* ‚îÄ‚îÄ Refresh button ‚îÄ‚îÄ */
    #refresh-chat-btn {
      font-size: 15px;
    }

    /* ‚îÄ‚îÄ Welcome config card ‚îÄ‚îÄ */
    .welcome-config-card {
      background: #fff;
      border: 1px solid rgba(51, 144, 236, .22);
      border-radius: 14px;
      padding: 14px;
      margin: 4px 0;
      font-size: 13px;
    }

    .welcome-config-title {
      font-weight: 700;
      font-size: 14px;
      color: #3390ec;
      margin-bottom: 8px;
    }

    .welcome-preview-label {
      font-size: 11px;
      color: #8d9ea9;
      text-transform: uppercase;
      letter-spacing: .04em;
      margin-bottom: 5px;
    }

    .welcome-tg-preview {
      background: #effdde;
      border-radius: 0 10px 10px 10px;
      padding: 10px 13px;
      font-size: 13px;
      line-height: 1.55;
      white-space: pre-wrap;
      word-break: break-word;
      max-height: 130px;
      overflow-y: auto;
      margin-bottom: 6px;
    }

    .welcome-kb-preview {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      margin-bottom: 10px;
      min-height: 22px;
    }

    .welcome-kb-btn {
      background: #fff;
      border: 1px solid rgba(51, 144, 236, .35);
      border-radius: 16px;
      padding: 3px 10px;
      font-size: 12px;
      font-weight: 600;
      color: #3390ec;
    }

    .welcome-field-label {
      font-size: 11px;
      color: #8d9ea9;
      margin-bottom: 4px;
    }

    .welcome-edit-area {
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 8px;
      font-size: 13px;
      font-family: inherit;
      resize: vertical;
      min-height: 72px;
    }

    .welcome-edit-area:focus {
      outline: none;
      border-color: #3390ec;
    }

    .welcome-kb-inputs {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin: 6px 0;
    }

    .welcome-kb-input {
      width: calc(50% - 3px);
      box-sizing: border-box;
      border: 1px solid #e2e8f0;
      border-radius: 6px;
      padding: 5px 8px;
      font-size: 12.5px;
      font-family: inherit;
    }

    .welcome-kb-input:focus {
      outline: none;
      border-color: #3390ec;
    }

    .welcome-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
    }

    .welcome-save-btn {
      background: #3390ec;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 18px;
      font-weight: 700;
      cursor: pointer;
      font-size: 13px;
    }

    .welcome-save-btn:hover {
      background: #2778d0;
    }

    .welcome-save-btn:disabled {
      opacity: .6;
      cursor: default;
    }

    .welcome-ai-btn {
      background: none;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 8px 14px;
      cursor: pointer;
      font-size: 13px;
    }

    .welcome-ai-btn:hover {
      background: #f8f9fa;
    }

    .welcome-status {
      font-size: 11.5px;
      color: #4caf50;
      margin-top: 6px;
      display: none;
    }

    .welcome-status.visible {
      display: block;
    }

    /* ‚îÄ‚îÄ Test Mode / Test Report card ‚îÄ‚îÄ */
    .test-report-card {
      background: #fff;
      border: 1px solid rgba(76, 175, 80, .25);
      border-radius: 14px;
      padding: 14px;
      margin: 6px 0;
    }

    .tr-title {
      font-weight: 700;
      font-size: 14px;
      color: #2e7d32;
      margin-bottom: 10px;
    }

    .tr-stats {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 10px;
    }

    .tr-stat {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12.5px;
      padding: 4px 0;
      border-bottom: 1px solid #f0f2f5;
    }

    .tr-stat:last-child {
      border-bottom: none;
    }

    .tr-stat-label {
      color: #64748b;
    }

    .tr-stat-val {
      font-weight: 600;
    }

    .tr-ok {
      color: #4caf50;
    }

    .tr-warn {
      color: #f59e0b;
    }

    .tr-section {
      margin-bottom: 10px;
    }

    .tr-label {
      font-size: 11.5px;
      font-weight: 700;
      color: #64748b;
      text-transform: uppercase;
      letter-spacing: .04em;
      margin-bottom: 4px;
    }

    .tr-rec {
      font-size: 12.5px;
      color: #374151;
      line-height: 1.5;
      padding: 2px 0;
    }

    .tr-rec.ok-text {
      color: #4caf50;
    }

    .tr-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .tr-btn {
      border: 1px solid #e2e8f0;
      background: none;
      border-radius: 8px;
      padding: 7px 14px;
      cursor: pointer;
      font-size: 12.5px;
      transition: background .15s;
    }

    .tr-btn:hover {
      background: #f8f9fa;
    }

    .tr-btn-primary {
      background: #3390ec;
      color: #fff;
      border-color: #3390ec;
      font-weight: 700;
    }

    .tr-btn-primary:hover {
      background: #2778d0;
      border-color: #2778d0;
    }

    /* ‚îÄ‚îÄ Info ‚ìò button ‚îÄ‚îÄ */
    .info-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: rgba(51, 144, 236, .12);
      color: #3390ec;
      font-size: 11px;
      font-weight: 800;
      cursor: pointer;
      border: 1.5px solid rgba(51, 144, 236, .25);
      flex-shrink: 0;
      transition: background .15s;
      vertical-align: middle;
    }

    .info-btn:hover {
      background: rgba(51, 144, 236, .22);
    }

    /* ‚îÄ‚îÄ Info popover overlay (bottom sheet) ‚îÄ‚îÄ */
    .info-popover-overlay {
      position: fixed;
      inset: 0;
      z-index: 8500;
      background: rgba(0, 0, 0, .38);
      display: flex;
      align-items: flex-end;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease;
    }

    .info-popover-overlay.visible {
      opacity: 1;
      pointer-events: auto;
    }

    .info-popover {
      background: #fff;
      border-radius: 18px 18px 0 0;
      padding: 16px 20px 36px;
      width: 100%;
      max-width: 520px;
      max-height: 78vh;
      overflow-y: auto;
      transform: translateY(48px);
      transition: transform .18s ease;
      box-shadow: 0 -8px 40px rgba(0, 0, 0, .14);
    }

    .info-popover-overlay.visible .info-popover {
      transform: translateY(0);
    }

    .ip-handle {
      width: 40px;
      height: 4px;
      border-radius: 2px;
      background: #e2e8f0;
      margin: 0 auto 16px;
    }

    .ip-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
    }

    .ip-title {
      font-size: 15px;
      font-weight: 700;
      color: #0f172a;
      flex: 1;
      line-height: 1.4;
    }

    .ip-close {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 22px;
      color: #94a3b8;
      line-height: 1;
      padding: 0 4px;
      flex-shrink: 0;
    }

    .ip-close:hover {
      color: #475569;
    }

    .ip-section {
      margin-bottom: 12px;
    }

    .ip-section-label {
      font-size: 10.5px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: .07em;
      color: #64748b;
      margin-bottom: 6px;
    }

    .ip-section-body {
      font-size: 13.5px;
      color: #374151;
      line-height: 1.65;
    }

    .ip-section-body ol {
      margin: 2px 0 0 18px;
      padding: 0;
    }

    .ip-section-body li {
      margin-bottom: 4px;
    }

    .ip-divider {
      border: none;
      border-top: 1px solid #f1f5f9;
      margin: 12px 0;
    }

    /* ‚îÄ‚îÄ Page label row (for ‚ìò placement) ‚îÄ‚îÄ */
    .page-label-row {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 16px;
    }

    .page-label-row .page-label {
      margin: 0;
    }

    /* ‚îÄ‚îÄ Field caption ‚îÄ‚îÄ */
    .field-caption {
      font-size: 11.5px;
      color: #94a3b8;
      margin-top: 5px;
      line-height: 1.5;
    }

    /* ‚îÄ‚îÄ KB Status Card (in chat) ‚îÄ‚îÄ */
    .kb-status-card {
      background: #fff;
      border: 1px solid rgba(51, 144, 236, .2);
      border-radius: 12px;
      padding: 12px 14px;
      margin: 4px 0;
      font-size: 13px;
    }

    .ksc-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 6px;
    }

    .ksc-icon {
      font-size: 16px;
      flex-shrink: 0;
    }

    .ksc-title {
      font-weight: 700;
      color: #374151;
      flex: 1;
      font-size: 13.5px;
    }

    .ksc-badge {
      font-size: 11px;
      font-weight: 700;
      padding: 2px 9px;
      border-radius: 20px;
      flex-shrink: 0;
    }

    .ksc-badge.pending {
      background: rgba(59, 130, 246, .1);
      color: #3b82f6;
    }

    .ksc-badge.ready {
      background: rgba(34, 197, 94, .12);
      color: #16a34a;
    }

    .ksc-badge.warn {
      background: rgba(245, 158, 11, .1);
      color: #d97706;
    }

    .ksc-badge.error {
      background: rgba(239, 68, 68, .1);
      color: #dc2626;
    }

    .ksc-body {
      font-size: 12.5px;
      color: #64748b;
      margin-bottom: 8px;
      line-height: 1.5;
    }

    .ksc-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .ksc-btn {
      border: 1px solid rgba(51, 144, 236, .3);
      background: none;
      border-radius: 8px;
      padding: 5px 12px;
      font-size: 12px;
      cursor: pointer;
      color: #3390ec;
      transition: background .15s;
    }

    .ksc-btn:hover {
      background: rgba(51, 144, 236, .06);
    }

    .ksc-btn-ghost {
      border-color: rgba(0, 0, 0, .1);
      color: #374151;
    }

    .guide-tip-close:hover {
      color: var(--text);
    }

    /* ‚ïê‚ïê‚ïê CHAT OS (Default App Interface) ‚ïê‚ïê‚ïê */
    /* ‚ïê‚ïê‚ïê CHAT OS (Standalone Messenger UI) ‚ïê‚ïê‚ïê */
    #onboarding-chat-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: #f0f2f5;
      /* Neutral light gray/beige page background */
      z-index: 10000;
      display: flex;
      /* Active by default */
      flex-direction: column;
      align-items: center;
      /* Center horizontally */
      justify-content: center;
      /* Center vertically on desktop */
      padding: 0;
      /* Add padding later via media query if needed for mobile */
    }

    /* Wrap the inner content to restrict width for better readability */
    .chat-ob-wrapper {
      width: 100%;
      max-width: 800px;
      height: 100%;
      background: #ffffff;
      /* Pure white chat body */
      display: flex;
      flex-direction: column;
      position: relative;
    }

    /* Desktop distinct floating window */
    @media (min-width: 768px) {
      .chat-ob-wrapper {
        height: 90vh;
        /* Don't stretch full screen, float inside */
        max-height: 900px;
        min-height: 500px;
        border-radius: 16px;
        /* Rounded corners */
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
        /* Soft shadow per requirements */
        border: 1px solid rgba(0, 0, 0, 0.05);
        /* Subtle border */
        overflow: hidden;
        /* Keep children inside border radius */
      }
    }

    .chat-ob-header {
      width: 100%;
      padding: 10px 16px;
      background: #fff;
      border-bottom: 1px solid rgba(0, 0, 0, 0.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
      min-height: 56px;
      flex-shrink: 0;
      z-index: 10;
    }

    .chat-header-btn {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: none;
      background: transparent;
      color: rgba(15, 23, 42, .55);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      flex-shrink: 0;
      transition: background .12s ease;
    }

    .chat-header-btn:hover {
      background: rgba(15, 23, 42, .06);
    }

    .chat-header-btn:active {
      transform: translateY(1px);
    }

    .chat-ob-messages {
      flex: 1;
      width: 100%;
      overflow-y: auto;
      padding: 12px 14px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      -webkit-overflow-scrolling: touch;
      background-color: #efeae2;
    }

    .msg-bot,
    .msg-user {
      max-width: 78%;
      padding: 7px 12px 8px;
      font-size: 0.94rem;
      line-height: 1.45;
      animation: msgPop 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28) both;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.13);
      position: relative;
      word-break: break-word;
    }

    .msg-bot {
      background: #fff;
      color: #000;
      align-self: flex-start;
      border-radius: 0 8px 8px 8px;
      margin-bottom: 2px;
    }

    .msg-user {
      background: #effdde;
      color: #000;
      align-self: flex-end;
      border-radius: 8px 8px 0 8px;
      margin-bottom: 2px;
    }

    @keyframes msgPop {
      0% {
        opacity: 0;
        transform: translateY(10px) scale(0.95);
      }

      100% {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    /* ===== Upload Bubble (Telegram-style) ===== */
    .upload-bubble {
      align-self: flex-end;
      width: min(400px, 85%);
      border-radius: 18px;
      border: 1px solid #e5e7eb;
      background:
        radial-gradient(120% 120% at 0% 0%, rgba(88, 166, 255, .18) 0%, rgba(255, 255, 255, .72) 55%, rgba(255, 255, 255, .92) 100%),
        linear-gradient(180deg, rgba(255, 255, 255, .78), rgba(255, 255, 255, .92));
      box-shadow: 0 12px 28px rgba(15, 23, 42, .10);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 12px 12px 10px;
      animation: msgPop 0.2s cubic-bezier(0.18, 0.89, 0.32, 1.28) both;
    }

    .ub-row {
      display: flex;
      gap: 12px;
      align-items: flex-start;
    }

    .ub-icon {
      width: 44px;
      height: 44px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 12px;
      color: #fff;
      box-shadow: 0 8px 18px rgba(0, 0, 0, .12);
      user-select: none;
      flex: 0 0 auto;
    }

    .ub-icon[data-kind="pdf"] {
      background: linear-gradient(135deg, #ff4d4d, #d11b1b);
    }

    .ub-icon[data-kind="doc"] {
      background: linear-gradient(135deg, #2f80ff, #1f5eff);
    }

    .ub-icon[data-kind="img"] {
      background: linear-gradient(135deg, #8b5cf6, #6d28d9);
    }

    .ub-icon[data-kind="zip"] {
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .ub-icon[data-kind="txt"] {
      background: linear-gradient(135deg, #10b981, #059669);
    }

    .ub-icon[data-kind="csv"] {
      background: linear-gradient(135deg, #10b981, #059669);
    }

    .ub-main {
      flex: 1 1 auto;
      min-width: 0;
    }

    .ub-title {
      font-size: 14px;
      font-weight: 650;
      color: #0f172a;
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-top: 2px;
    }

    .ub-sub {
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      color: #64748b;
      font-size: 12px;
    }

    .ub-status {
      font-weight: 600;
    }

    .ub-meta {
      white-space: nowrap;
    }

    .ub-bar {
      margin-top: 8px;
      width: 100%;
      height: 7px;
      border-radius: 999px;
      background: rgba(15, 23, 42, .08);
      overflow: hidden;
    }

    .ub-bar-fill {
      height: 100%;
      border-radius: 999px;
      background: linear-gradient(90deg, #2f80ff, #58a6ff);
      box-shadow: 0 4px 12px rgba(47, 128, 255, .22);
      transition: width .18s ease;
    }

    .ub-x {
      flex: 0 0 auto;
      width: 28px;
      height: 28px;
      border-radius: 8px;
      border: 1px solid rgba(15, 23, 42, .10);
      background: rgba(255, 255, 255, .55);
      color: rgba(15, 23, 42, .55);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      transition: background .12s ease;
    }

    .ub-x:hover {
      background: rgba(255, 255, 255, .9);
    }

    .ub-processing,
    .ub-done,
    .ub-error {
      display: none;
      margin-top: 10px;
      font-size: 12px;
      gap: 8px;
      align-items: center;
    }

    .ub-done {
      color: rgba(16, 185, 129, .95);
      font-weight: 600;
    }

    .ub-error {
      color: rgba(239, 68, 68, .95);
      font-weight: 600;
    }

    .ub-spinner {
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 2px solid rgba(47, 128, 255, .25);
      border-top-color: rgba(47, 128, 255, .95);
      display: inline-block;
      animation: ubSpin .8s linear infinite;
    }

    @keyframes ubSpin {
      to {
        transform: rotate(360deg);
      }
    }

    .ub-check,
    .ub-warn {
      width: 18px;
      height: 18px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
    }

    .ub-check {
      background: rgba(16, 185, 129, .15);
      border: 1px solid rgba(16, 185, 129, .35);
    }

    .ub-warn {
      background: rgba(239, 68, 68, .12);
      border: 1px solid rgba(239, 68, 68, .35);
    }

    /* State machine */
    .upload-bubble[data-state="uploading"] .ub-bar {
      display: block;
    }

    .upload-bubble[data-state="uploading"] .ub-sub {
      display: flex;
    }

    .upload-bubble[data-state="uploading"] .ub-x {
      display: flex;
    }

    .upload-bubble[data-state="processing"] .ub-bar {
      display: none;
    }

    .upload-bubble[data-state="processing"] .ub-sub {
      display: none;
    }

    .upload-bubble[data-state="processing"] .ub-x {
      display: none;
    }

    .upload-bubble[data-state="processing"] .ub-processing {
      display: flex;
    }

    .upload-bubble[data-state="done"] .ub-bar {
      display: none;
    }

    .upload-bubble[data-state="done"] .ub-sub {
      display: none;
    }

    .upload-bubble[data-state="done"] .ub-x {
      display: none;
    }

    .upload-bubble[data-state="done"] .ub-done {
      display: flex;
    }

    .upload-bubble[data-state="error"] .ub-bar {
      display: none;
    }

    .upload-bubble[data-state="error"] .ub-sub {
      display: none;
    }

    .upload-bubble[data-state="error"] .ub-x {
      display: none;
    }

    .upload-bubble[data-state="error"] .ub-error {
      display: flex;
    }

    .chat-ob-chips {
      padding: 8px 14px 6px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      background: #efeae2;
    }

    .ob-chip {
      background: #fff;
      border: none;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.15);
      color: #3390ec;
      padding: 7px 14px;
      border-radius: 20px;
      font-size: 0.84rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
    }

    .ob-chip:hover {
      background: #f0f7ff;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.12);
    }

    .ob-chip.active {
      background: #3390ec;
      color: #fff;
      box-shadow: 0 1px 4px rgba(51, 144, 236, .3);
    }

    /* ‚îÄ‚îÄ KB Add Panel ‚îÄ‚îÄ */
    .kb-add-panel {
      background: #fff;
      border-top: 1px solid rgba(0, 0, 0, .06);
      padding: 10px 14px 12px;
      animation: kap-in .18s ease;
    }

    .kb-add-panel.hidden {
      display: none;
    }

    @keyframes kap-in {
      from {
        opacity: 0;
        transform: translateY(6px)
      }

      to {
        opacity: 1;
        transform: translateY(0)
      }
    }

    .kap-btns {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    .kap-btn {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      padding: 10px 8px;
      background: #f7f8fa;
      border: 1.5px solid #e8edf1;
      border-radius: 12px;
      cursor: pointer;
      font-size: 11.5px;
      font-weight: 600;
      color: var(--text, #1a1a2e);
      transition: all .15s;
    }

    .kap-btn:hover {
      background: #eef4ff;
      border-color: #93c5fd;
    }

    .kap-btn:active {
      transform: scale(0.97);
    }

    .kap-icon {
      font-size: 22px;
    }

    .kap-hint-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      flex-wrap: wrap;
    }

    .kap-hint {
      font-size: 11px;
      color: #94a3b8;
      line-height: 1.5;
    }

    .kap-help-btn {
      background: none;
      border: none;
      font-size: 11px;
      color: #3390ec;
      cursor: pointer;
      padding: 2px 0;
      white-space: nowrap;
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    .kap-url-input,
    .kap-textarea {
      width: 100%;
      border: 1.5px solid #e2e8f0;
      border-radius: 10px;
      padding: 9px 12px;
      font-size: 13px;
      outline: none;
      margin-bottom: 8px;
      transition: border-color .15s;
      box-sizing: border-box;
    }

    .kap-url-input:focus,
    .kap-textarea:focus {
      border-color: #3390ec;
    }

    .kap-url-input.kap-error {
      border-color: #ef4444;
    }

    .kap-textarea {
      resize: none;
      min-height: 80px;
      max-height: 140px;
      line-height: 1.5;
    }

    .kap-actions-row {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      margin-bottom: 8px;
    }

    .kap-submit-btn {
      background: #3390ec;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background .15s;
    }

    .kap-submit-btn:hover {
      background: #2271c3;
    }

    .kap-submit-btn:disabled {
      background: #a0c4f1;
      cursor: not-allowed;
    }

    .kap-status-bar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 10px;
      font-size: 12.5px;
      margin-bottom: 8px;
    }

    .kap-status-bar.kap-pending {
      background: rgba(51, 144, 236, .1);
      color: #2563eb;
    }

    .kap-status-bar.kap-success {
      background: rgba(34, 197, 94, .1);
      color: #16a34a;
    }

    .kap-status-bar.kap-error {
      background: rgba(239, 68, 68, .08);
      color: #dc2626;
    }

    .kap-done-row {
      display: flex;
      gap: 8px;
    }

    .kap-ghost-btn {
      flex: 1;
      background: none;
      border: 1.5px solid #e2e8f0;
      border-radius: 10px;
      padding: 8px 12px;
      font-size: 12.5px;
      cursor: pointer;
      color: var(--text, #1a1a2e);
      transition: border-color .15s;
    }

    .kap-ghost-btn:hover {
      border-color: #94a3b8;
    }

    .kap-primary-btn {
      flex: 1;
      background: #3390ec;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 8px 12px;
      font-size: 12.5px;
      font-weight: 600;
      cursor: pointer;
    }

    .kap-back-link {
      display: inline-block;
      font-size: 11.5px;
      color: #94a3b8;
      cursor: pointer;
      margin-top: 4px;
    }

    .kap-back-link:hover {
      color: #3390ec;
    }

    /* ‚îÄ‚îÄ üëé Feedback form ‚îÄ‚îÄ */
    .cos-feedback-form {
      margin: 4px 0 8px;
      background: #fff;
      border-radius: 10px;
      padding: 10px 12px;
      box-shadow: 0 1px 5px rgba(0, 0, 0, .10);
      max-width: 320px;
    }

    .cos-feedback-label {
      font-size: 12px;
      color: #707579;
      margin-bottom: 6px;
    }

    .cos-feedback-input {
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #dde1e7;
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 0.83rem;
      resize: none;
      font-family: inherit;
      line-height: 1.4;
    }

    .cos-feedback-input:focus {
      outline: none;
      border-color: #3390ec;
    }

    .cos-feedback-btns {
      display: flex;
      gap: 6px;
      margin-top: 7px;
    }

    .cos-fb-send,
    .cos-fb-cancel {
      font-size: 0.8rem;
      padding: 5px 12px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }

    .cos-fb-send {
      background: #3390ec;
      color: #fff;
      font-weight: 600;
    }

    .cos-fb-send:hover {
      background: #2778d0;
    }

    .cos-fb-cancel {
      background: #f0f2f5;
      color: #707579;
    }

    /* ‚îÄ‚îÄ KB Suggestions section ‚îÄ‚îÄ */
    #onboarding-chat-overlay .kb-sug-divider {
      border: none;
      border-top: 1px solid rgba(15, 23, 42, .07);
      margin: 10px 0;
    }

    #onboarding-chat-overlay .kb-suggestions {
      padding: 0 14px 10px;
    }

    #onboarding-chat-overlay .kb-suggestions-hdr {
      font-size: 11.5px;
      font-weight: 700;
      color: #8d9ea9;
      text-transform: uppercase;
      letter-spacing: .04em;
      margin-bottom: 10px;
    }

    #onboarding-chat-overlay .kb-sug-card {
      background: #fff;
      border: 1px solid rgba(15, 23, 42, .08);
      border-radius: 12px;
      padding: 10px 12px;
      margin-bottom: 8px;
    }

    #onboarding-chat-overlay .kb-sug-meta {
      font-size: 11px;
      color: #8d9ea9;
      margin-bottom: 4px;
    }

    #onboarding-chat-overlay .kb-sug-text {
      font-size: 13px;
      color: #0f172a;
      line-height: 1.4;
      margin-bottom: 8px;
    }

    #onboarding-chat-overlay .kb-sug-actions {
      display: flex;
      gap: 6px;
    }

    #onboarding-chat-overlay .kb-sug-btn {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 8px;
      border: 1px solid rgba(15, 23, 42, .12);
      background: #fff;
      cursor: pointer;
      font-weight: 600;
    }

    #onboarding-chat-overlay .kb-sug-btn.approve {
      background: #dcf8c6;
      border-color: #4caf50;
      color: #2e7d32;
    }

    #onboarding-chat-overlay .kb-sug-btn.reject {
      background: #fef0f0;
      border-color: #ef4444;
      color: #b91c1c;
    }

    #onboarding-chat-overlay .kb-sug-btn:hover {
      opacity: .85;
    }

    .chat-ob-input-area {
      width: 100%;
      padding: 8px 10px 12px;
      background: #fff;
      display: flex;
      justify-content: center;
      border-top: 1px solid rgba(0, 0, 0, 0.08);
      flex-shrink: 0;
    }

    .chat-ob-input-row {
      width: 100%;
      display: flex;
      gap: 4px;
      background: #f0f2f5;
      border-radius: 24px;
      padding: 4px 4px 4px 14px;
      align-items: center;
    }

    .chat-ob-input {
      flex: 1;
      border: none;
      background: transparent;
      outline: none;
      color: #000;
      font-size: 1rem;
      font-family: inherit;
    }

    .chat-ob-input::placeholder {
      color: #999;
    }

    .chat-ob-send {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background: #3390ec;
      color: #fff;
      border: none;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background 0.15s;
      flex-shrink: 0;
    }

    .chat-ob-send svg {
      width: 20px;
      height: 20px;
    }

    .chat-ob-send:hover:not(:disabled) {
      background: #2778d0;
    }

    .chat-ob-send:disabled {
      background: #c9d6e4;
      cursor: default;
    }

    /* ‚ïê‚ïê‚ïê STEP TABS ‚ïê‚ïê‚ïê */
    .step-tabs {
      display: flex;
      gap: 4px;
      margin-top: 16px;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      padding-bottom: 2px;
    }

    .step-tabs::-webkit-scrollbar {
      display: none;
    }

    .step-tab {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border: 1px solid var(--border);
      border-radius: 20px;
      background: var(--surface);
      color: var(--text-sec);
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.2s;
    }

    .step-tab:hover {
      background: var(--surface2);
      border-color: var(--text-dim);
    }

    .step-tab.active {
      background: #1a1a1a;
      color: #fff;
      border-color: #1a1a1a;
    }

    .step-num {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: #000;
      color: #fff;
      font-size: 0.7rem;
      font-weight: 700;
    }

    .step-tab.active .step-num {
      background: rgba(255, 255, 255, 0.25);
    }

    [data-theme="dark"] .step-tab.active {
      background: #ffffff;
      color: #0a0a0a;
      border-color: #ffffff;
    }

    [data-theme="dark"] .step-tab.active .step-num {
      background: rgba(0, 0, 0, 0.2);
    }

    @media (max-width: 600px) {

      /* Step tabs ‚Üí horizontal scroll pills */
      .step-tabs {
        flex-wrap: nowrap;
        overflow-x: auto;
        gap: 6px;
        padding: 4px 0 8px;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
      }

      .step-tab {
        min-width: max-content;
        padding: 7px 12px;
        font-size: 0.7rem;
        gap: 5px;
        flex: 0 0 auto;
        scroll-snap-align: start;
        border-radius: 20px;
        min-height: 36px;
      }

      .step-num {
        width: 18px;
        height: 18px;
        font-size: 0.6rem;
      }

      /* OV card ‚Äî compact */
      .ov-card {
        padding: 12px;
        border-radius: 12px;
        position: relative;
      }

      .ov-bot-av {
        width: 36px;
        height: 36px;
        border-radius: 10px;
        font-size: 15px;
      }

      .ov-bot-name {
        font-size: 0.92rem;
      }

      .ov-bot-username {
        font-size: 0.72rem;
      }

      /* KPI ‚Äî 3 in a row */
      .kpi-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 6px;
      }

      .kpi-card {
        padding: 10px 8px;
      }

      .kpi-lbl {
        font-size: 0.58rem;
      }

      .kpi-val {
        font-size: 1.1rem;
      }

      /* Topbar ‚Äî compact */
      .topbar {
        height: 44px;
        padding: 0 10px;
      }

      .topbar-title {
        font-size: 0.8rem;
      }

      .theme-btn {
        padding: 4px 8px;
        font-size: 12px;
      }

      /* Forms ‚Äî full-width, prevent iOS zoom */
      .form-input,
      .form-textarea,
      .form-select {
        width: 100%;
        font-size: 16px;
      }
    }

    /* ‚îÄ‚îÄ Wizard template cards ‚îÄ‚îÄ */
    .wz-tpl-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
      margin: 12px 0;
    }

    .wz-tpl-card {
      padding: 12px 14px;
      background: var(--surface2);
      border: 1.5px solid var(--border);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.15s;
      font-size: 0.8rem;
    }

    .wz-tpl-card:hover {
      border-color: var(--primary-brd);
      background: var(--primary-dim);
    }

    .wz-tpl-card.selected {
      border-color: var(--primary);
      background: var(--primary-dim);
      color: var(--indigo);
    }

    .wz-tpl-ico {
      font-size: 20px;
      margin-bottom: 4px;
    }

    .wz-tpl-name {
      font-weight: 700;
      color: var(--text);
    }

    .wz-tpl-sub {
      font-size: 0.68rem;
      color: var(--text-sec);
      margin-top: 2px;
    }

    /* Account list items */
    .acc-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 7px 10px;
      border-radius: 8px;
      font-size: 0.78rem;
      color: var(--text-sec);
      cursor: pointer;
      transition: all 0.15s;
      margin-bottom: 1px;
    }

    .acc-item:hover {
      background: var(--primary-dim);
      color: var(--text);
    }

    .acc-item.active {
      background: var(--primary-dim);
      color: var(--indigo);
    }

    /* ‚îÄ‚îÄ Bot switcher ‚îÄ‚îÄ */
    .bot-switcher {
      position: relative;
      display: none;
    }

    .bot-sw-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 5px 10px 5px 6px;
      border-radius: 10px;
      cursor: pointer;
      border: 1.5px solid var(--border);
      background: var(--surface);
      transition: all 0.15s;
      user-select: none;
    }

    .bot-sw-btn:hover {
      border-color: var(--primary);
      background: var(--primary-dim);
    }

    .bot-sw-av {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      color: #fff;
      flex-shrink: 0;
    }

    .bot-sw-name {
      font-size: 0.82rem;
      font-weight: 600;
      color: var(--text);
      max-width: 140px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .bot-sw-arrow {
      font-size: 10px;
      color: var(--text-dim);
      transition: transform 0.2s;
    }

    .bot-sw-arrow.open {
      transform: rotate(180deg);
    }

    .bot-sw-dropdown {
      position: absolute;
      top: calc(100% + 6px);
      left: 0;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.18);
      min-width: 220px;
      z-index: 999;
      padding: 6px;
      display: none;
    }

    .bot-sw-dropdown.visible {
      display: block;
    }

    .bot-sw-item {
      display: flex;
      align-items: center;
      gap: 9px;
      padding: 8px 10px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.8rem;
      color: var(--text);
      transition: background 0.12s;
    }

    .bot-sw-item:hover {
      background: var(--primary-dim);
    }

    .bot-sw-item.current {
      background: var(--primary-dim);
      color: var(--indigo);
      font-weight: 600;
    }

    .acc-av {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      font-weight: 700;
      color: #fff;
      flex-shrink: 0;
    }

    .acc-name {
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .sidebar-footer {
      border-top: 1px solid var(--border);
      padding: 10px 8px;
    }

    .ai-requests {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.15s;
    }

    .ai-requests:hover {
      background: var(--primary-dim);
    }

    .ai-req-label {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text);
    }

    .ai-req-sub {
      font-size: 0.65rem;
      color: var(--text-sec);
      margin-top: 1px;
    }

    .ai-req-bar {
      height: 4px;
      background: var(--border);
      border-radius: 2px;
      margin-top: 6px;
      overflow: hidden;
    }

    .ai-req-fill {
      height: 100%;
      background: var(--green);
      border-radius: 2px;
      width: 85%;
    }

    .v3-frame-wrap {
      height: calc(100vh - 180px);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--border);
      background: #fff;
    }

    .v3-frame {
      width: 100%;
      height: 100%;
      border: none;
      display: block;
      background: #fff;
    }

    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       MAIN
    ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê    /* Main content hidden for Chat OS natively */
    #main-content {
      display: none !important;
    }

    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .topbar {
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      height: 52px;
      flex-shrink: 0;
      transition: background 0.25s, box-shadow 0.25s;
    }

    [data-theme="light"] .topbar {
      box-shadow: 0 1px 6px rgba(0, 0, 0, 0.07);
    }

    .topbar-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .topbar-title {
      font-size: 0.95rem;
      font-weight: 700;
    }

    .topbar-count {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--indigo);
    }

    .topbar-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .search-box {
      display: flex;
      align-items: center;
      gap: 7px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 6px 12px;
      font-size: 0.78rem;
      color: var(--text-dim);
      cursor: text;
      width: 200px;
    }

    .search-box input {
      background: transparent;
      border: none;
      outline: none;
      font-size: 0.78rem;
      color: var(--text);
      width: 100%;
      font-family: inherit;
    }

    .search-box input::placeholder {
      color: var(--text-dim);
    }

    .theme-btn {
      background: var(--primary-dim);
      border: 1px solid var(--primary-brd);
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.15s;
      color: var(--text);
    }

    .theme-btn:hover {
      background: rgba(99, 102, 241, 0.25);
    }

    @keyframes jelly {
      0% {
        transform: scale(1);
      }

      30% {
        transform: scale(0.88, 0.92);
      }

      55% {
        transform: scale(1.06, 0.97);
      }

      75% {
        transform: scale(0.97, 1.03);
      }

      90% {
        transform: scale(1.02, 0.99);
      }

      100% {
        transform: scale(1);
      }
    }

    @keyframes pb-shimmer {
      0% {
        background-position: -200% center;
      }

      100% {
        background-position: 200% center;
      }
    }

    .pb-fill {
      height: 100%;
      border-radius: 3px;
      background: linear-gradient(90deg, #000 40%, #333 55%, #000 70%);
      background-size: 200% 100%;
      animation: pb-shimmer 1.6s linear infinite;
      transition: width 0.6s ease;
    }

    .btn-primary {
      display: flex;
      align-items: center;
      gap: 6px;
      background: var(--primary);
      border: none;
      border-radius: var(--radius-pill);
      padding: 8px 18px;
      font-size: 0.78rem;
      font-weight: 700;
      color: #fff;
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
    }

    .btn-primary:hover {
      background: #262626;
      transform: translateY(-1px);
    }

    .btn-primary:active {
      animation: jelly 0.4s ease;
    }

    .btn-secondary {
      display: flex;
      align-items: center;
      gap: 6px;
      background: var(--surface);
      border: 1.5px solid var(--border);
      border-radius: var(--radius-pill);
      padding: 8px 18px;
      font-size: 0.78rem;
      font-weight: 600;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s;
      user-select: none;
    }

    .btn-secondary:hover {
      border-color: var(--text);
    }

    .btn-secondary:active {
      animation: jelly 0.4s ease;
    }

    .content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }

    /* Sidebar hidden for Chat OS */
    .sidebar {
      display: none !important;
    }

    /* ‚ïê‚ïê SCREENS ‚ïê‚ïê */
    .screen {
      display: none;
    }

    .screen.active {
      display: block;
    }

    /* ‚ïê‚ïê EMPTY STATE ‚ïê‚ïê */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      text-align: center;
    }

    .empty-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-title {
      font-size: 0.95rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 6px;
    }

    .empty-sub {
      font-size: 0.78rem;
      color: var(--text-sec);
      max-width: 280px;
      line-height: 1.55;
    }

    /* ‚ïê‚ïê AUTOMATIONS GRID ‚ïê‚ïê */
    .auto-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 12px;
    }

    .auto-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px 18px;
      cursor: pointer;
      transition: all 0.15s;
      position: relative;
    }

    .auto-card:hover {
      border-color: var(--primary-brd);
      box-shadow: var(--shadow);
    }

    .auto-card-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .auto-name-row {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .auto-logo {
      font-size: 16px;
      color: var(--primary);
    }

    .auto-name {
      font-size: 0.88rem;
      font-weight: 700;
      color: var(--text);
    }

    .auto-more {
      color: var(--text-dim);
      cursor: pointer;
      font-size: 16px;
      padding: 0 4px;
    }

    .auto-stats {
      display: flex;
      gap: 28px;
      margin-bottom: 12px;
    }

    .auto-stat-label {
      font-size: 0.6rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: var(--text-dim);
      margin-bottom: 3px;
    }

    .auto-stat-val {
      font-size: 1.2rem;
      font-weight: 800;
      color: var(--text);
    }

    .auto-account {
      display: flex;
      align-items: center;
      gap: 7px;
      font-size: 0.72rem;
      color: var(--text-sec);
    }

    .auto-acc-av {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 9px;
      font-weight: 700;
      color: #fff;
      flex-shrink: 0;
    }

    /* Promo card */
    .auto-promo {
      background: linear-gradient(135deg, rgba(99, 102, 241, 0.18), rgba(139, 92, 246, 0.12));
      border: 1px solid var(--primary-brd);
      border-radius: 12px;
      padding: 16px 18px;
      cursor: pointer;
      transition: all 0.15s;
      position: relative;
      overflow: hidden;
    }

    .auto-promo:hover {
      border-color: var(--primary);
    }

    .promo-badge {
      display: inline-block;
      background: var(--yellow);
      color: #000;
      font-size: 0.62rem;
      font-weight: 800;
      border-radius: 5px;
      padding: 2px 7px;
      margin-bottom: 10px;
    }

    .promo-title {
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 6px;
    }

    .promo-sub {
      font-size: 0.75rem;
      color: var(--text-sec);
      line-height: 1.45;
    }

    .promo-arrow {
      position: absolute;
      top: 16px;
      right: 18px;
      color: var(--text-dim);
      font-size: 18px;
    }

    /* ‚ïê‚ïê ANALYTICS ‚ïê‚ïê */
    .page-label {
      font-size: 0.65rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--text);
      margin-bottom: 16px;
    }

    .tab-row {
      display: flex;
      gap: 4px;
      margin-bottom: 16px;
    }

    .tab-btn {
      padding: 5px 14px;
      border-radius: 7px;
      font-size: 0.75rem;
      font-weight: 600;
      cursor: pointer;
      border: 1px solid transparent;
      background: transparent;
      color: var(--text-dim);
      transition: all 0.15s;
    }

    .tab-btn:hover {
      color: var(--text);
    }

    .tab-btn.active {
      background: var(--primary-dim);
      color: var(--indigo);
      border-color: var(--primary-brd);
    }

    .tab-btn:active {
      animation: jelly 0.35s ease;
    }

    .hero-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 20px 24px;
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 28px;
    }

    .donut-wrap {
      position: relative;
      width: 120px;
      height: 64px;
      flex-shrink: 0;
      overflow: hidden;
    }

    .donut-wrap svg {
      width: 120px;
      height: 120px;
      position: absolute;
      top: -58px;
    }

    .donut-label {
      position: absolute;
      bottom: 0;
      width: 100%;
      text-align: center;
    }

    .donut-pct {
      font-size: 1.4rem;
      font-weight: 800;
    }

    .stat-rows {
      flex: 1;
    }

    .stat-row {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.78rem;
      color: var(--text-sec);
      padding: 5px 0;
      border-bottom: 1px solid var(--border2);
    }

    .stat-row:last-child {
      border-bottom: none;
    }

    .stat-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .stat-val {
      margin-left: auto;
      font-weight: 700;
      color: var(--text);
    }

    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    .kpi-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px 16px;
    }

    .kpi-lbl {
      font-size: 0.62rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-dim);
      margin-bottom: 5px;
    }

    .kpi-val {
      font-size: 1.5rem;
      font-weight: 800;
    }

    .kpi-sub {
      font-size: 0.62rem;
      color: var(--text-dim);
      margin-top: 3px;
    }

    .section-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 12px;
    }

    .section-lbl {
      font-size: 0.62rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-dim);
    }

    .link-btn {
      font-size: 0.72rem;
      color: var(--indigo);
      background: none;
      border: none;
      cursor: pointer;
    }

    .link-btn:hover {
      text-decoration: underline;
    }

    .q-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-bottom: 20px;
    }

    .q-card {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
    }

    .q-text {
      font-size: 0.78rem;
      color: var(--text);
      line-height: 1.5;
      margin-bottom: 10px;
    }

    .q-foot {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .q-count {
      font-size: 0.68rem;
      color: var(--text-dim);
    }

    .btn-sm {
      background: var(--primary-dim);
      border: 1px solid var(--primary-brd);
      border-radius: 6px;
      padding: 3px 9px;
      font-size: 0.68rem;
      font-weight: 600;
      color: var(--indigo);
      cursor: pointer;
      transition: all 0.15s;
    }

    .btn-sm:hover {
      background: rgba(99, 102, 241, 0.25);
    }

    /* ‚ïê‚ïê CHAT ‚ïê‚ïê */
    .chat-layout {
      display: flex;
      gap: 16px;
    }

    .chat-box {
      flex: 1;
      max-width: 420px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      display: flex;
      flex-direction: column;
      min-height: 420px;
      max-height: 520px;
      overflow: hidden;
    }

    .chat-head {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 13px 15px;
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }

    .chat-av {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: #000000;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      color: #fff;
      flex-shrink: 0;
    }

    .chat-head-name {
      font-size: 0.82rem;
      font-weight: 700;
    }

    .chat-head-online {
      font-size: 0.65rem;
      color: var(--green);
    }

    .chat-msgs {
      flex: 1;
      overflow-y: auto;
      padding: 14px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .date-sep {
      text-align: center;
      font-size: 0.65rem;
      color: var(--text-dim);
    }

    .msg-row {
      display: flex;
      flex-direction: column;
    }

    .msg-row.user {
      align-items: flex-end;
    }

    .bubble {
      max-width: 70%;
      padding: 9px 13px;
      border-radius: 14px 14px 14px 4px;
      font-size: 0.8rem;
      line-height: 1.55;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      word-break: break-word;
      overflow-wrap: break-word;
    }

    .bubble.user {
      background: var(--primary);
      border-color: var(--primary);
      border-radius: 14px 14px 4px 14px;
      color: #fff;
    }

    .msg-time {
      font-size: 0.6rem;
      color: var(--text-dim);
      margin-top: 3px;
    }

    .chat-foot {
      padding: 10px 13px;
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 7px;
      flex-shrink: 0;
    }

    .chat-inp {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      font-size: 0.8rem;
      color: var(--text);
      font-family: inherit;
    }

    .chat-inp::placeholder {
      color: var(--text-dim);
    }

    .icon-btn {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-dim);
      font-size: 14px;
    }

    .send-btn {
      background: var(--primary);
      border: none;
      border-radius: 7px;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 12px;
      color: #fff;
      flex-shrink: 0;
      transition: opacity 0.15s;
    }

    .send-btn:hover {
      opacity: 0.85;
    }

    .send-btn:active {
      animation: jelly 0.35s ease;
    }

    .sug-panel {
      width: 240px;
      flex-shrink: 0;
    }

    .sug-label {
      font-size: 0.68rem;
      color: var(--text-sec);
      text-align: center;
      margin-bottom: 10px;
    }

    .sug-list {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .sug-item {
      display: flex;
      align-items: flex-start;
      gap: 7px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 9px;
      padding: 9px 11px;
      font-size: 0.75rem;
      color: var(--text);
      cursor: pointer;
      transition: all 0.15s;
      line-height: 1.45;
    }

    .sug-item:hover {
      border-color: var(--primary-brd);
      color: var(--indigo);
      background: var(--primary-dim);
    }

    .sug-ico {
      font-size: 11px;
      flex-shrink: 0;
      margin-top: 1px;
      color: var(--yellow);
    }

    .sug-foot {
      text-align: center;
      margin-top: 8px;
      font-size: 0.65rem;
      color: var(--text-dim);
    }

    .sug-foot a {
      color: var(--indigo);
    }

    /* ‚ïê‚ïê KNOWLEDGE ‚ïê‚ïê */
    .kb-wrap {
      max-width: 460px;
    }

    .kb-big-title {
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 16px;
    }

    .kb-option {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 11px;
      padding: 14px 16px;
      margin-bottom: 9px;
      cursor: pointer;
      transition: all 0.15s;
    }

    .kb-option:hover {
      border-color: var(--primary-brd);
      background: var(--primary-dim);
    }

    .kb-opt-left {
      display: flex;
      align-items: center;
      gap: 11px;
    }

    .kb-ico {
      width: 34px;
      height: 34px;
      border-radius: 8px;
      background: var(--primary-dim);
      border: 1px solid var(--primary-brd);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
    }

    .kb-opt-name {
      font-size: 0.85rem;
      font-weight: 600;
    }

    .kb-commons-label {
      font-size: 0.6rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--text-dim);
      margin: 18px 0 8px;
    }

    .kb-common {
      display: flex;
      align-items: center;
      gap: 9px;
      padding: 10px 0;
      font-size: 0.8rem;
      color: var(--text-sec);
      border-bottom: 1px solid var(--border2);
      cursor: pointer;
      transition: color 0.15s;
    }

    .kb-common:hover {
      color: var(--indigo);
    }

    .kb-common:last-child {
      border-bottom: none;
    }

    /* ‚ïê‚ïê UNANSWERED ‚ïê‚ïê */
    .unans-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 9px;
    }

    .unans-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 13px;
    }

    .unans-text {
      font-size: 0.78rem;
      color: var(--text);
      line-height: 1.5;
      margin-bottom: 10px;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .unans-foot {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .btn-add {
      display: flex;
      align-items: center;
      gap: 4px;
      background: var(--primary-dim);
      border: 1px solid var(--primary-brd);
      border-radius: 6px;
      padding: 4px 9px;
      font-size: 0.68rem;
      font-weight: 600;
      color: var(--indigo);
      cursor: pointer;
      transition: all 0.15s;
    }

    .btn-add:hover {
      background: rgba(99, 102, 241, 0.25);
    }

    .topic-dropdown {
      position: absolute;
      right: 0;
      top: 100%;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
      z-index: 100;
      min-width: 180px;
      padding: 4px;
    }

    .topic-dropdown button {
      display: block;
      width: 100%;
      text-align: left;
      background: none;
      border: none;
      padding: 8px 12px;
      font-size: 0.78rem;
      cursor: pointer;
      border-radius: 6px;
      color: var(--text);
    }

    .topic-dropdown button:hover {
      background: var(--surface2);
    }

    .link-btn {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 0.78rem;
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    /* ‚ïê‚ïê TOPICS TABLE ‚ïê‚ïê */
    .table-wrap {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }

    .data-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    .data-table thead th {
      background: var(--surface2);
      color: var(--text-dim);
      font-size: 0.6rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      padding: 10px 12px;
      text-align: left;
      border-bottom: 2px solid var(--border);
      position: sticky;
      top: 0;
    }

    .data-table tbody tr {
      border-bottom: 1px solid var(--border2);
    }

    .data-table tbody tr:last-child {
      border-bottom: none;
    }

    .data-table tbody tr:hover {
      background: var(--primary-dim);
    }

    .data-table td {
      padding: 10px 12px;
      vertical-align: middle;
    }

    .td-name {
      display: flex;
      align-items: center;
      gap: 9px;
      color: var(--text);
    }

    .td-link {
      color: var(--indigo);
      cursor: pointer;
      font-size: 0.75rem;
    }

    .td-link:hover {
      text-decoration: underline;
    }

    .td-muted {
      color: var(--text-sec);
      font-size: 0.75rem;
    }

    .bar-icon {
      display: flex;
      align-items: flex-end;
      gap: 2px;
      height: 13px;
      flex-shrink: 0;
    }

    .bar-icon span {
      width: 3px;
      border-radius: 1px;
    }

    .bar-icon.hot span {
      background: var(--yellow);
    }

    .bar-icon.cold span {
      background: var(--text-dim);
    }

    .bar-icon span:nth-child(1) {
      height: 4px;
    }

    .bar-icon span:nth-child(2) {
      height: 8px;
    }

    .bar-icon span:nth-child(3) {
      height: 12px;
    }

    /* ‚ïê‚ïê MODAL ‚ïê‚ïê */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.55);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }

    .modal-overlay.open {
      opacity: 1;
      pointer-events: all;
    }

    .modal {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 28px;
      width: 420px;
      max-width: 95vw;
      box-shadow: var(--shadow);
      transform: translateY(16px);
      transition: transform 0.2s;
    }

    .modal-overlay.open .modal {
      transform: translateY(0);
    }

    .modal-title {
      font-size: 1rem;
      font-weight: 800;
      margin-bottom: 6px;
    }

    .modal-sub {
      font-size: 0.78rem;
      color: var(--text-sec);
      margin-bottom: 20px;
      line-height: 1.5;
    }

    .form-label {
      font-size: 0.68rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: var(--text-dim);
      margin-bottom: 6px;
      display: block;
    }

    .form-input {
      width: 100%;
      background: var(--surface);
      border: 1.5px solid var(--border);
      border-radius: var(--radius-input);
      color: var(--text);
      font-size: 0.82rem;
      padding: 10px 12px;
      outline: none;
      transition: border-color 0.2s;
      font-family: inherit;
      margin-bottom: 14px;
    }

    .form-input:focus {
      border-color: #000000;
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
    }

    .form-input::placeholder {
      color: var(--text-dim);
    }

    .modal-footer {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .btn-ghost {
      background: transparent;
      border: 1.5px solid var(--border);
      border-radius: var(--radius-pill);
      padding: 8px 16px;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-sec);
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-ghost:hover {
      border-color: var(--text);
      color: var(--text);
    }

    .btn-modal-ok {
      background: var(--primary);
      border: none;
      border-radius: var(--radius-pill);
      padding: 8px 20px;
      font-size: 0.8rem;
      font-weight: 700;
      color: #fff;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-modal-ok:hover {
      background: #262626;
      transform: translateY(-1px);
    }

    .color-dot {
      width: 7px;
      height: 7px;
      border-radius: 50%;
      background: var(--green);
      box-shadow: 0 0 5px var(--green);
    }

    .auth-overlay {
      position: fixed;
      inset: 0;
      background: var(--bg);
      z-index: 10001;
      transition: opacity 0.3s;
      overflow-y: auto;
      scroll-behavior: smooth;
    }

    .auth-overlay.has-landing {
      display: block;
    }

    .auth-overlay:not(.has-landing) {
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .auth-overlay.hidden {
      opacity: 0;
      pointer-events: none;
      display: none !important;
    }

    /* ‚ïê‚ïê LANDING PAGE ‚ïê‚ïê */
    @keyframes gradientShift {

      0%,
      100% {
        background-position: 0% 50%;
      }

      50% {
        background-position: 100% 50%;
      }
    }

    @keyframes float {

      0%,
      100% {
        transform: translateY(0);
      }

      50% {
        transform: translateY(-12px);
      }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes pulse {

      0%,
      100% {
        opacity: .4
      }

      50% {
        opacity: .8
      }
    }

    .lp-hero {
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding: 60px 24px 40px;
      position: relative;
      overflow: hidden;
    }

    .lp-hero::before {
      content: '';
      position: absolute;
      inset: -50%;
      background: radial-gradient(circle at 30% 40%, rgba(0, 0, 0, 0.03) 0%, transparent 50%),
        radial-gradient(circle at 70% 60%, rgba(0, 0, 0, 0.02) 0%, transparent 50%);
      animation: gradientShift 8s ease infinite;
      background-size: 200% 200%;
      z-index: 0;
    }

    .lp-hero>* {
      position: relative;
      z-index: 1;
    }

    .lp-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #000000;
      border: none;
      border-radius: 50px;
      padding: 8px 18px;
      font-size: 0.72rem;
      font-weight: 600;
      color: #FFFFFF;
      margin-bottom: 24px;
      animation: fadeInUp 0.6s ease both;
    }

    .lp-title {
      font-size: clamp(2rem, 5vw, 3.2rem);
      font-weight: 900;
      font-style: italic;
      line-height: 1.15;
      margin-bottom: 18px;
      color: #000000;
      animation: fadeInUp 0.6s ease 0.1s both;
    }

    .lp-sub {
      font-size: clamp(0.9rem, 2vw, 1.15rem);
      color: var(--text-sec);
      max-width: 540px;
      line-height: 1.6;
      margin-bottom: 32px;
      animation: fadeInUp 0.6s ease 0.2s both;
    }

    .lp-cta {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: var(--radius-pill);
      padding: 14px 32px;
      font-size: 1rem;
      font-weight: 700;
      font-style: italic;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.15);
      animation: fadeInUp 0.6s ease 0.3s both;
    }

    .lp-cta:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
    }

    .lp-cta:active {
      transform: scale(0.97);
    }

    .lp-scroll-hint {
      margin-top: 48px;
      font-size: 0.72rem;
      color: var(--text-dim);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      animation: fadeInUp 0.6s ease 0.5s both;
    }

    .lp-scroll-hint span {
      animation: float 2s ease infinite;
    }

    .lp-section {
      padding: 72px 24px;
      max-width: 960px;
      margin: 0 auto;
    }

    .lp-section-title {
      font-size: clamp(1.4rem, 3vw, 2rem);
      font-weight: 800;
      font-style: italic;
      text-align: center;
      margin-bottom: 8px;
      color: var(--text);
    }

    .lp-section-sub {
      text-align: center;
      color: var(--text-sec);
      font-size: 0.9rem;
      margin-bottom: 40px;
    }

    /* Integrations bar */
    .lp-integrations {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 32px;
      flex-wrap: wrap;
      padding: 24px;
      border-top: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
    }

    .lp-int-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.82rem;
      font-weight: 600;
      color: var(--text-dim);
      opacity: 0.7;
      transition: opacity 0.2s;
    }

    .lp-int-item:hover {
      opacity: 1;
    }

    .lp-int-icon {
      font-size: 1.3rem;
    }

    /* Features grid */
    .lp-features {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
    }

    .lp-feat-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      transition: all 0.3s;
    }

    .lp-feat-card:hover {
      border-color: var(--primary-brd);
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.08);
    }

    .lp-feat-icon {
      font-size: 2rem;
      margin-bottom: 12px;
    }

    .lp-feat-title {
      font-size: 0.95rem;
      font-weight: 700;
      margin-bottom: 6px;
      color: var(--text);
    }

    .lp-feat-desc {
      font-size: 0.78rem;
      color: var(--text-sec);
      line-height: 1.5;
    }

    /* Demo chat */
    .lp-demo {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      overflow: hidden;
      max-width: 480px;
      margin: 0 auto;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08);
    }

    .lp-demo-header {
      background: #000000;
      padding: 14px 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      color: #fff;
      font-weight: 700;
      font-size: 0.9rem;
    }

    .lp-demo-av {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }

    .lp-demo-msgs {
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .lp-demo-msg {
      max-width: 80%;
      padding: 10px 14px;
      border-radius: 14px;
      font-size: 0.82rem;
      line-height: 1.5;
    }

    .lp-demo-msg.user {
      align-self: flex-end;
      background: var(--primary);
      color: #fff;
      border-bottom-right-radius: 4px;
    }

    .lp-demo-msg.bot {
      align-self: flex-start;
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text);
      border-bottom-left-radius: 4px;
    }

    .lp-demo-typing {
      align-self: flex-start;
      padding: 10px 18px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 14px;
      display: flex;
      gap: 4px;
    }

    .lp-demo-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--text-dim);
      animation: pulse 1.2s ease infinite;
    }

    .lp-demo-dot:nth-child(2) {
      animation-delay: 0.2s;
    }

    .lp-demo-dot:nth-child(3) {
      animation-delay: 0.4s;
    }

    /* Pricing */
    .lp-pricing {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      max-width: 700px;
      margin: 0 auto;
    }

    .lp-price-card {
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid var(--border);
      transition: all 0.3s;
    }

    .lp-price-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.08);
    }

    .lp-price-card.featured {
      border-color: var(--primary-brd);
    }

    .lp-price-head {
      padding: 24px;
      position: relative;
    }

    .lp-price-card.featured .lp-price-head {
      background: linear-gradient(135deg, #1E1044, #2d1a6e);
    }

    .lp-price-card:not(.featured) .lp-price-head {
      background: linear-gradient(135deg, #2563EB, #1d4ed8);
    }

    .lp-price-tag {
      position: absolute;
      top: 14px;
      right: 14px;
      font-size: 0.6rem;
      font-weight: 700;
      padding: 3px 10px;
      border-radius: 50px;
      color: #fff;
    }

    .lp-price-card.featured .lp-price-tag {
      background: var(--primary);
      color: #fff;
    }

    .lp-price-card:not(.featured) .lp-price-tag {
      background: #3b82f6;
    }

    .lp-price-name {
      font-size: 1rem;
      font-weight: 800;
      color: #fff;
      margin-bottom: 4px;
    }

    .lp-price-amount {
      font-size: 2rem;
      font-weight: 800;
      color: #fff;
    }

    .lp-price-period {
      font-size: 0.75rem;
      opacity: 0.6;
      color: #fff;
    }

    .lp-price-body {
      padding: 20px;
      background: var(--surface);
      border-top: 1px solid var(--border);
      font-size: 0.78rem;
      color: var(--text-sec);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .lp-price-cta {
      margin: 0 20px 20px;
      padding: 10px;
      border-radius: var(--radius-pill);
      border: none;
      font-size: 0.85rem;
      font-weight: 700;
      font-style: italic;
      cursor: pointer;
      width: calc(100% - 40px);
      transition: all 0.2s;
    }

    .lp-price-card.featured .lp-price-cta {
      background: var(--primary);
      color: #fff;
    }

    .lp-price-card:not(.featured) .lp-price-cta {
      background: var(--surface2);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .lp-price-cta:hover {
      transform: translateY(-1px);
      opacity: 0.9;
    }

    /* Stats bar */
    .lp-stats {
      display: flex;
      justify-content: center;
      gap: 48px;
      flex-wrap: wrap;
      padding: 32px 24px;
    }

    .lp-stat {
      text-align: center;
    }

    .lp-stat-val {
      font-size: 1.8rem;
      font-weight: 900;
      font-style: italic;
      color: var(--text);
    }

    .lp-stat-lbl {
      font-size: 0.75rem;
      color: var(--text-dim);
      margin-top: 2px;
    }

    /* Footer */
    .lp-footer {
      border-top: 1px solid var(--border);
      padding: 32px 24px;
      text-align: center;
      color: var(--text-dim);
      font-size: 0.75rem;
    }

    .lp-footer-links {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }

    .lp-footer-links a {
      color: var(--text-sec);
      text-decoration: none;
      transition: color 0.2s;
    }

    .lp-footer-links a:hover {
      color: var(--indigo);
    }

    /* Auth section within landing */
    .lp-auth-section {
      min-height: 80vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px 24px;
    }

    /* Reveal animation */
    .lp-reveal {
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.6s ease;
    }

    .lp-reveal.visible {
      opacity: 1;
      transform: translateY(0);
    }

    /* Modal animations */
    @keyframes modalFadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes modalSlideUp {
      from {
        opacity: 0;
        transform: translateY(20px) scale(0.97);
      }

      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .modal-overlay.open {
      animation: modalFadeIn 0.2s ease;
    }

    .modal-overlay.open .modal {
      animation: modalSlideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @media (max-width: 640px) {
      .lp-pricing {
        grid-template-columns: 1fr;
      }

      .lp-stats {
        gap: 24px;
      }

      .lp-integrations {
        gap: 16px;
      }
    }

    .auth-spinner {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      animation: spin 0.7s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .auth-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 36px;
      width: 380px;
      max-width: 95vw;
      box-shadow: var(--shadow);
    }

    .auth-logo {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      margin-bottom: 24px;
    }

    .auth-logo-icon {
      width: 40px;
      height: 40px;
      border-radius: 12px;
      background: #000000;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .auth-logo-text {
      font-size: 1.2rem;
      font-weight: 800;
    }

    .auth-title {
      font-size: 1.05rem;
      font-weight: 700;
      text-align: center;
      margin-bottom: 6px;
    }

    .auth-sub {
      font-size: 0.78rem;
      color: var(--text-sec);
      text-align: center;
      margin-bottom: 22px;
    }

    .auth-tabs {
      display: flex;
      background: var(--bg);
      border-radius: 9px;
      padding: 3px;
      margin-bottom: 20px;
    }

    .auth-tab {
      flex: 1;
      text-align: center;
      padding: 7px;
      border-radius: 7px;
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      color: var(--text-dim);
      transition: all 0.15s;
      border: none;
      background: transparent;
    }

    .auth-tab.active {
      background: var(--surface);
      color: var(--text);
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.2);
    }

    .auth-error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 8px;
      padding: 9px 12px;
      font-size: 0.75rem;
      color: var(--red);
      margin-bottom: 12px;
      display: none;
    }

    .auth-error.show {
      display: block;
    }

    .btn-google {
      width: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 9px;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 9px;
      padding: 11px;
      font-size: 0.82rem;
      font-weight: 600;
      color: var(--text);
      cursor: pointer;
      transition: all 0.15s;
      margin-bottom: 14px;
    }

    .btn-google:hover {
      border-color: var(--primary-brd);
    }

    .auth-divider {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 14px;
    }

    .auth-divider-line {
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    .auth-divider-text {
      font-size: 0.7rem;
      color: var(--text-dim);
    }

    .btn-auth {
      width: 100%;
      background: var(--primary);
      border: none;
      border-radius: 9px;
      padding: 11px;
      font-size: 0.85rem;
      font-weight: 700;
      color: #fff;
      cursor: pointer;
      transition: opacity 0.15s;
      margin-top: 4px;
    }

    .btn-auth:hover {
      opacity: 0.88;
    }

    /* ‚ïê‚ïê USER AVATAR in topbar ‚ïê‚ïê */
    .user-pill {
      display: flex;
      align-items: center;
      gap: 7px;
      cursor: pointer;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 20px;
      padding: 4px 10px 4px 4px;
      transition: all 0.15s;
    }

    .user-pill:hover {
      border-color: var(--primary-brd);
    }

    .user-av-sm {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      background: #000000;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 700;
      color: #fff;
      flex-shrink: 0;
    }

    .user-email {
      font-size: 0.72rem;
      color: var(--text-sec);
      max-width: 140px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .logout-btn {
      font-size: 0.68rem;
      color: var(--red);
      background: none;
      border: none;
      cursor: pointer;
      padding: 0 0 0 4px;
    }

    .logout-btn:hover {
      text-decoration: underline;
    }

    /* ‚ïê‚ïê AVATAR DROPDOWN ‚ïê‚ïê */
    .user-pill {
      position: relative;
    }

    .av-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      min-width: 200px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      box-shadow: var(--shadow);
      z-index: 9000;
      overflow: hidden;
      display: none;
    }

    .av-dropdown.open {
      display: block;
    }

    .av-dd-header {
      padding: 12px 14px;
      border-bottom: 1px solid var(--border);
    }

    .av-dd-name {
      font-size: 0.8rem;
      font-weight: 700;
      color: var(--text);
    }

    .av-dd-email {
      font-size: 0.68rem;
      color: var(--text-dim);
      margin-top: 2px;
    }

    .av-dd-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      font-size: 0.78rem;
      color: var(--text-sec);
      cursor: pointer;
      transition: background 0.12s;
    }

    .av-dd-item:hover {
      background: var(--surface2);
      color: var(--text);
    }

    .av-dd-item .av-dd-ico {
      font-size: 15px;
      width: 20px;
      text-align: center;
    }

    .av-dd-sep {
      height: 1px;
      background: var(--border);
      margin: 4px 0;
    }

    .av-dd-item.danger {
      color: var(--red);
    }

    /* ‚ïê‚ïê SETTINGS OVERLAY ‚ïê‚ïê */
    .settings-overlay {
      position: fixed;
      inset: 0;
      z-index: 10005;
      background: var(--bg);
      display: none;
      flex-direction: row;
    }

    .settings-overlay.open {
      display: flex;
    }

    .settings-sidebar {
      width: 240px;
      min-width: 240px;
      background: var(--surface);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      padding: 0;
      overflow-y: auto;
    }

    .settings-header {
      padding: 20px 18px 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .settings-back {
      width: 30px;
      height: 30px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: none;
      cursor: pointer;
      color: var(--text-sec);
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .settings-back:hover {
      background: var(--surface2);
      color: var(--text);
    }

    .settings-logo {
      font-size: 0.9rem;
      font-weight: 800;
      color: var(--text);
    }

    .settings-nav-group {
      padding: 10px 10px 0;
    }

    .settings-nav-label {
      font-size: 0.6rem;
      font-weight: 700;
      color: var(--text-dim);
      letter-spacing: 0.08em;
      text-transform: uppercase;
      padding: 8px 8px 4px;
    }

    .settings-nav-item {
      display: flex;
      align-items: center;
      gap: 9px;
      padding: 9px 10px;
      border-radius: 8px;
      font-size: 0.78rem;
      color: var(--text-sec);
      cursor: pointer;
      transition: all 0.12s;
      margin-bottom: 1px;
    }

    .settings-nav-item:hover {
      background: var(--surface2);
      color: var(--text);
    }

    .settings-nav-item.active {
      background: var(--primary-dim);
      color: var(--indigo);
      font-weight: 700;
    }

    .settings-nav-item .s-ico {
      font-size: 14px;
      width: 18px;
      text-align: center;
    }

    .settings-nav-sub {
      display: flex;
      align-items: center;
      gap: 9px;
      padding: 7px 10px 7px 36px;
      border-radius: 8px;
      font-size: 0.75rem;
      color: var(--text-sec);
      cursor: pointer;
      transition: all 0.12s;
      margin-bottom: 1px;
    }

    .settings-nav-sub:hover {
      background: var(--surface2);
      color: var(--text);
    }

    .settings-nav-sub.active {
      background: var(--primary-dim);
      color: var(--indigo);
      font-weight: 700;
    }

    .settings-content {
      flex: 1;
      overflow-y: auto;
      padding: 32px 40px;
      max-width: 860px;
    }

    .s-section {
      display: none;
    }

    .s-section.active {
      display: block;
    }

    .s-title {
      font-size: 1.2rem;
      font-weight: 800;
      color: var(--text);
      margin-bottom: 6px;
    }

    .s-subtitle {
      font-size: 0.78rem;
      color: var(--text-dim);
      margin-bottom: 24px;
    }

    .s-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 20px;
      margin-bottom: 16px;
    }

    .s-card-title {
      font-size: 0.85rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 14px;
    }

    .s-field {
      margin-bottom: 14px;
    }

    .s-label {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 5px;
    }

    .s-input {
      width: 100%;
      padding: 9px 12px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.82rem;
      outline: none;
      transition: border-color 0.15s;
    }

    .s-input:focus {
      border-color: var(--primary-brd);
    }

    .s-input[readonly] {
      opacity: 0.5;
      cursor: default;
    }

    .s-row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .s-btn {
      padding: 9px 20px;
      border-radius: 8px;
      border: none;
      font-size: 0.78rem;
      font-weight: 700;
      cursor: pointer;
      transition: opacity 0.15s;
    }

    .s-btn:hover {
      opacity: 0.85;
    }

    .s-btn-primary {
      background: var(--primary);
      color: #fff;
    }

    .s-btn-secondary {
      background: var(--surface2);
      border: 1px solid var(--border);
      color: var(--text-sec);
    }

    .s-btn-danger {
      background: rgba(239, 68, 68, 0.12);
      color: var(--red);
      border: 1px solid rgba(239, 68, 68, 0.25);
    }

    .s-stat-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .s-stat-card {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      text-align: center;
    }

    .s-stat-val {
      font-size: 1.4rem;
      font-weight: 800;
      color: var(--indigo);
    }

    .s-stat-lbl {
      font-size: 0.68rem;
      color: var(--text-dim);
      margin-top: 4px;
    }

    .s-prog-wrap {
      background: var(--border);
      border-radius: 6px;
      height: 8px;
      overflow: hidden;
      margin: 8px 0;
    }

    .s-prog-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--indigo), #8b5cf6);
      border-radius: 6px;
      transition: width 0.5s;
    }

    .s-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.77rem;
    }

    .s-table th {
      padding: 8px 10px;
      text-align: left;
      color: var(--text-dim);
      font-size: 0.68rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 1px solid var(--border);
    }

    .s-table td {
      padding: 10px 10px;
      border-bottom: 1px solid var(--border2);
      color: var(--text-sec);
    }

    .s-table tr:last-child td {
      border-bottom: none;
    }

    .s-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 20px;
      font-size: 0.65rem;
      font-weight: 700;
    }

    .s-badge-green {
      background: rgba(34, 197, 94, 0.12);
      color: var(--green);
    }

    .s-badge-red {
      background: rgba(239, 68, 68, 0.12);
      color: var(--red);
    }

    .s-limit-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid var(--border2);
      font-size: 0.8rem;
    }

    .s-limit-row:last-child {
      border-bottom: none;
    }

    .s-copy-wrap {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .s-copy-input {
      flex: 1;
      padding: 9px 12px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-sec);
      font-size: 0.75rem;
      outline: none;
    }

    .s-copy-btn {
      padding: 9px 14px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.75rem;
      color: var(--text-sec);
      white-space: nowrap;
    }

    .s-copy-btn:hover {
      border-color: var(--primary-brd);
      color: var(--indigo);
    }

    /* ‚ïê‚ïê STATUS TOGGLE ‚ïê‚ïê */
    .status-toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 10px 4px;
    }

    .status-lbl {
      font-size: 0.58rem;
      font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--text-dim);
    }

    .toggle-wrap {
      display: flex;
      align-items: center;
      gap: 7px;
      cursor: pointer;
      user-select: none;
    }

    .toggle-wrap:active {
      animation: jelly 0.35s ease;
    }

    .toggle-text {
      font-size: 0.65rem;
      font-weight: 700;
    }

    .toggle-text.on {
      color: var(--green);
    }

    .toggle-text.off {
      color: var(--text-dim);
    }

    .toggle-sw {
      width: 32px;
      height: 17px;
      border-radius: 9px;
      background: var(--border);
      position: relative;
      transition: background 0.2s;
    }

    .toggle-sw.on {
      background: var(--green);
    }

    .toggle-sw::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 13px;
      height: 13px;
      border-radius: 50%;
      background: #fff;
      transition: left 0.2s;
    }

    .toggle-sw.on::after {
      left: 17px;
    }

    /* ‚ïê‚ïê RULES SCREEN ‚ïê‚ïê */
    .rules-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 20px;
      margin-bottom: 14px;
    }

    .rules-card-title {
      font-size: 0.88rem;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .rules-card-sub {
      font-size: 0.75rem;
      color: var(--text-sec);
      line-height: 1.55;
      margin-bottom: 14px;
    }

    .rules-textarea {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.8rem;
      padding: 12px;
      outline: none;
      transition: border-color 0.2s;
      font-family: inherit;
      resize: vertical;
      min-height: 180px;
      line-height: 1.6;
    }

    .rules-textarea:focus {
      border-color: var(--primary);
    }

    .rules-textarea::placeholder {
      color: var(--text-dim);
    }

    .rules-actions {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .check-row {
      display: flex;
      gap: 8px;
      align-items: flex-start;
      font-size: 0.78rem;
      color: var(--text-sec);
      margin-bottom: 6px;
    }

    .check-ico {
      color: var(--green);
      font-size: 12px;
      flex-shrink: 0;
      margin-top: 2px;
    }

    /* ‚ïê‚ïê INACTIVE BANNER ‚ïê‚ïê */
    .inactive-banner {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 10px;
      padding: 12px 16px;
      margin-bottom: 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 0.8rem;
      color: var(--red);
    }

    /* ‚ïê‚ïê FILE DROP ZONE ‚ïê‚ïê */
    .drop-zone {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 30px 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      margin-bottom: 14px;
    }

    .drop-zone:hover,
    .drop-zone.drag-over {
      border-color: var(--primary);
      background: var(--primary-dim);
    }

    .drop-zone-ico {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .drop-zone-text {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--text);
      margin-bottom: 4px;
    }

    .drop-zone-sub {
      font-size: 0.72rem;
      color: var(--text-dim);
    }

    .file-list {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 14px;
    }

    .file-item {
      display: flex;
      align-items: center;
      gap: 8px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 0.78rem;
    }

    .file-item-name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: var(--text);
    }

    .file-item-size {
      color: var(--text-dim);
      font-size: 0.65rem;
    }

    .file-item-rm {
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-dim);
      font-size: 13px;
    }

    /* ‚ïê‚ïê TOAST ‚ïê‚ïê */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(60px);
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 20px;
      font-size: 0.78rem;
      color: var(--text);
      z-index: 9999;
      box-shadow: var(--shadow);
      transition: transform 0.25s;
      pointer-events: none;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
    }

    /* ‚ïê‚ïê CHAT CONTROLS ‚ïê‚ïê */
    .chat-ctrl-btn {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 7px;
      padding: 4px 10px;
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-sec);
      cursor: pointer;
      transition: all 0.15s;
    }

    .chat-ctrl-btn:hover {
      border-color: var(--primary-brd);
      color: var(--indigo);
    }

    /* ‚ïê‚ïê KB ITEM STATUS ‚ïê‚ïê */
    .kb-status {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.62rem;
      font-weight: 700;
      border-radius: 5px;
      padding: 2px 7px;
    }

    .kb-status.ready {
      background: rgba(34, 197, 94, 0.12);
      color: var(--green);
    }

    .kb-status.file {
      background: rgba(99, 102, 241, 0.12);
      color: var(--indigo);
    }

    /* ‚ïê‚ïê TARIFF ‚ïê‚ïê */
    .tariff-toggle-btn {
      padding: 7px 16px;
      border-radius: 8px;
      border: 1.5px solid var(--border);
      background: var(--surface);
      color: var(--text-sec);
      font-size: 0.8rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s;
    }

    .tariff-toggle-btn.active {
      border-color: var(--primary);
      background: var(--primary-dim);
      color: var(--indigo);
    }

    .tariff-feature-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 9px 14px;
      border-bottom: 1px solid var(--border);
      font-size: 0.75rem;
      color: var(--text-sec);
    }

    .tariff-feature-row b {
      color: var(--text);
      font-size: 0.78rem;
    }

    /* ‚ïê‚ïê AI SETTINGS ‚ïê‚ïê */
    .provider-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 18px;
    }

    .provider-card {
      background: var(--surface);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 14px;
      cursor: pointer;
      transition: all 0.15s;
      text-align: center;
    }

    .provider-card:hover {
      border-color: var(--primary-brd);
      background: var(--primary-dim);
    }

    .provider-card.selected {
      border-color: var(--primary);
      background: var(--primary-dim);
    }

    .provider-ico {
      font-size: 28px;
      margin-bottom: 6px;
    }

    .provider-name {
      font-size: 0.82rem;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 2px;
    }

    .provider-sub {
      font-size: 0.65rem;
      color: var(--text-dim);
    }

    .model-select {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.82rem;
      padding: 10px 12px;
      outline: none;
      margin-bottom: 14px;
      font-family: inherit;
      cursor: pointer;
    }

    .model-select:focus {
      border-color: var(--primary);
    }

    .api-key-wrap {
      position: relative;
      margin-bottom: 14px;
    }

    .api-key-wrap .form-input {
      margin-bottom: 0;
      padding-right: 40px;
      font-family: monospace;
      font-size: 0.75rem;
    }

    .api-key-toggle {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-dim);
      font-size: 14px;
    }

    .uid-box {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px 12px;
      font-family: monospace;
      font-size: 0.72rem;
      color: var(--text-dim);
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 6px;
    }

    .copy-btn {
      background: var(--primary-dim);
      border: 1px solid var(--primary-brd);
      border-radius: 6px;
      padding: 3px 9px;
      font-size: 0.68rem;
      font-weight: 600;
      color: var(--indigo);
      cursor: pointer;
      white-space: nowrap;
      user-select: none;
    }

    .copy-btn:hover {
      background: rgba(99, 102, 241, 0.25);
    }

    .copy-btn:active {
      animation: jelly 0.35s ease;
    }

    .setup-steps {
      counter-reset: step;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .setup-step {
      display: flex;
      gap: 12px;
      align-items: flex-start;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 14px;
    }

    .step-num {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background: var(--primary);
      color: #fff;
      font-size: 0.72rem;
      font-weight: 800;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .step-text {
      font-size: 0.78rem;
      color: var(--text-sec);
      line-height: 1.55;
    }

    .step-text b {
      color: var(--text);
    }

    .step-code {
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 6px 10px;
      font-family: monospace;
      font-size: 0.72rem;
      color: var(--indigo);
      margin-top: 5px;
      display: block;
      cursor: pointer;
    }

    .step-code:hover {
      border-color: var(--primary-brd);
    }

    /* ‚ïê‚ïê CHATS SCREEN ‚ïê‚ïê */
    #screen-chats.active {
      display: flex !important;
    }

    .chat-list-item {
      padding: 12px 14px;
      cursor: pointer;
      border-bottom: 1px solid var(--border2);
      transition: background 0.12s;
    }

    .chat-list-item:hover {
      background: var(--primary-dim);
    }

    .chat-list-item.active {
      background: var(--primary-dim);
      border-left: 3px solid var(--primary);
    }

    .chat-list-av {
      width: 38px;
      height: 38px;
      border-radius: 50%;
      background: var(--primary-dim);
      border: 1.5px solid var(--primary-brd);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
      font-weight: 700;
      color: var(--indigo);
      flex-shrink: 0;
    }

    .chat-list-name {
      font-size: 0.82rem;
      font-weight: 700;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-list-preview {
      font-size: 0.7rem;
      color: var(--text-sec);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-top: 1px;
    }

    .chat-list-time {
      font-size: 0.62rem;
      color: var(--text-dim);
      white-space: nowrap;
      flex-shrink: 0;
    }

    /* ‚ïê‚ïê USER CARD ‚ïê‚ïê */
    .user-card-av {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
      font-weight: 700;
      color: #fff;
      flex-shrink: 0;
    }

    .user-card-meta {
      display: flex;
      gap: 12px;
      margin-top: 3px;
      font-size: 0.68rem;
      color: var(--text-sec);
      flex-wrap: wrap;
    }

    .notes-area {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: var(--surface2);
      color: var(--text);
      font-size: 0.75rem;
      padding: 7px 10px;
      resize: none;
      outline: none;
      font-family: inherit;
      box-sizing: border-box;
      transition: border-color 0.15s;
    }

    .notes-area:focus {
      border-color: var(--primary-brd);
    }

    /* ‚ïê‚ïê BROADCAST ‚ïê‚ïê */
    .bc-seg-label {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.78rem;
      cursor: pointer;
      padding: 5px 10px;
      border-radius: 7px;
      border: 1px solid var(--border);
      background: var(--surface2);
    }

    .bc-seg-label input {
      accent-color: var(--primary);
    }

    .msg-bubble-user {
      align-self: flex-end;
      background: var(--primary);
      color: #fff;
      padding: 9px 13px;
      border-radius: 14px 14px 3px 14px;
      font-size: 0.82rem;
      line-height: 1.5;
      max-width: 75%;
    }

    .msg-bubble-bot {
      align-self: flex-start;
      background: var(--surface);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 9px 13px;
      border-radius: 14px 14px 14px 3px;
      font-size: 0.82rem;
      line-height: 1.5;
      max-width: 75%;
    }

    .msg-role-label {
      font-size: 0.62rem;
      color: var(--text-dim);
      margin-bottom: 2px;
    }

    /* ‚ïê‚ïê HANDOFF MODE BADGE ‚ïê‚ïê */
    .mode-badge {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      font-size: 0.68rem;
      font-weight: 700;
      border-radius: 20px;
      padding: 4px 10px;
      transition: all 0.3s;
      white-space: nowrap;
    }

    .mode-badge.ai {
      background: var(--primary-dim);
      color: var(--indigo);
      border: 1px solid var(--primary-brd);
    }

    .mode-badge.human {
      background: rgba(34, 197, 94, 0.12);
      color: var(--green);
      border: 1px solid rgba(34, 197, 94, 0.3);
    }

    .admin-reply-input {
      flex: 1;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      font-size: 0.82rem;
      padding: 9px 12px;
      outline: none;
      resize: none;
      font-family: inherit;
      min-height: 40px;
      max-height: 120px;
      transition: border-color 0.2s;
      line-height: 1.4;
    }

    .admin-reply-input:focus {
      border-color: var(--primary);
    }

    .admin-reply-input::placeholder {
      color: var(--text-dim);
    }

    /* ‚ïê‚ïê AI KPI grid (5-col desktop, 2-col mobile) ‚ïê‚ïê */
    .aiu-kpi-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin-bottom: 20px;
    }

    .aiu-tables-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      margin-bottom: 20px;
    }

    /* ‚ïê‚ïê MOBILE OVERLAY ‚ïê‚ïê */
    .mob-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.45);
      z-index: 900;
      backdrop-filter: blur(1px);
    }

    .mob-overlay.open {
      display: block;
    }

    /* ‚ïê‚ïê MOBILE HAMBURGER (hidden on desktop) ‚ïê‚ïê */
    .mob-menu-btn {
      display: none;
      background: var(--primary-dim);
      border: 1px solid var(--primary-brd);
      border-radius: 8px;
      width: 36px;
      height: 36px;
      font-size: 16px;
      cursor: pointer;
      color: var(--indigo);
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    /* ‚ïê‚ïê MOBILE STICKY CTA (hidden on desktop) ‚ïê‚ïê */
    .mob-cta {
      display: none;
      position: fixed;
      bottom: calc(12px + env(safe-area-inset-bottom, 0px));
      left: 50%;
      transform: translateX(-50%);
      width: calc(100% - 32px);
      max-width: 400px;
      z-index: 200;
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: var(--radius-pill);
      padding: 14px 20px;
      font-size: 0.9rem;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.25);
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .mob-cta:active {
      opacity: 0.88;
    }

    /* ‚ïê‚ïê MOBILE RESPONSIVE ‚ïê‚ïê */
    @media (max-width: 768px) {
      body {
        overflow: auto;
      }

      /* Sidebar ‚Üí left drawer */
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        bottom: 0;
        width: 260px;
        min-width: unset;
        height: 100vh;
        flex-direction: column;
        border-right: 1px solid var(--border);
        border-top: none;
        z-index: 1000;
        overflow-y: auto;
        overflow-x: hidden;
        transform: translateX(-100%);
        transition: transform 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: none;
      }

      .sidebar.mob-open {
        transform: translateX(0);
        box-shadow: 4px 0 24px rgba(0, 0, 0, 0.25);
      }

      /* Restore vertical nav items */
      #nav-agent {
        display: block;
        padding: 0;
      }

      .nav-item {
        min-width: unset;
        min-height: 44px;
        white-space: normal;
        flex-direction: row;
        align-items: center;
        font-size: 0.8rem;
        padding: 8px 10px;
        border-radius: 8px;
        border: 1px solid transparent;
        gap: 8px;
      }

      .acc-item {
        min-height: 44px;
      }

      .nav-ico {
        font-size: 13px;
      }

      .nav-label {
        display: block !important;
      }

      .sidebar-logo {
        display: flex !important;
      }

      .status-toggle-row {
        display: flex !important;
      }

      .sidebar-footer {
        display: flex !important;
      }

      /* Main area ‚Äî space for sticky CTA at bottom */
      .main {
        margin-left: 0;
        padding-bottom: 76px;
      }

      /* Content ‚Äî tighter horizontal padding */
      .content {
        padding: 14px 10px;
      }

      /* Topbar */
      .topbar {
        padding: 10px 12px;
      }

      .topbar-title {
        font-size: 0.85rem;
      }

      /* Hamburger visible on mobile */
      .mob-menu-btn {
        display: flex;
      }

      /* Mobile sticky CTA */
      .mob-cta {
        display: flex;
      }

      /* Screen */
      .screen {
        padding: 12px;
      }

      /* Analytics: KPI grids handled in 600px query */

      .aiu-kpi-grid {
        grid-template-columns: repeat(2, 1fr);
      }

      .aiu-tables-grid {
        grid-template-columns: 1fr;
      }

      /* Hide secondary tables on mobile (collapsible) */
      .mob-collapsible {
        display: none;
      }

      /* Chats layout */
      #screen-chats>div {
        flex-direction: column;
      }

      #screen-chats>div>div:first-child {
        width: 100%;
        min-width: unset;
        max-height: 200px;
        border-right: none;
        border-bottom: 1px solid var(--border);
      }

      /* Settings */
      .settings-overlay {
        flex-direction: column;
      }

      .settings-sidebar {
        width: 100%;
        min-width: unset;
        border-right: none;
        border-bottom: 1px solid var(--border);
        max-height: 200px;
        overflow-y: auto;
      }

      /* Modals */
      .modal {
        width: 95vw !important;
        max-width: 95vw !important;
      }

      /* Misc */
      .home-hero {
        padding: 40px 16px;
      }

      .home-steps {
        grid-template-columns: 1fr;
      }

      .ov-actions {
        flex-wrap: wrap;
      }

      .wz-tpl-grid {
        grid-template-columns: 1fr 1fr;
      }

      /* Search ‚Äî hide on mobile (icon-only topbar) */
      .search-box {
        display: none;
      }

      /* Chat testing ‚Äî full-width, hide suggestions panel */
      .chat-layout {
        flex-direction: column;
      }

      .sug-panel {
        display: none !important;
      }

      .chat-box {
        min-height: 65vh;
      }

      .bubble {
        max-width: 88%;
      }

      /* Chat messages real view */
      .msg-bubble-user,
      .msg-bubble-bot {
        max-width: 85%;
        word-break: break-word;
      }

      /* Bot switcher ‚Äî truncate long names */
      .bot-sw-name {
        max-width: 120px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
    }
  </style>
</head>

<body>
  <div id="projects-ui-root" style="display:none;"></div>

  <!-- Mobile overlay -->
  <div class="mob-overlay" id="mob-overlay" onclick="closeMobileSidebar()"></div>

  <!-- Mobile sticky CTA -->
  <button class="mob-cta" onclick="showAddBotModal()">Ôºã –°–æ–∑–¥–∞—Ç—å AI-–∞–≥–µ–Ω—Ç–∞</button>

  <!-- ‚ïê‚ïê SIDEBAR ‚ïê‚ïê -->
  <!-- ‚ïê‚ïê CHAT ONBOARDING WIZARD ‚ïê‚ïê -->
  <div id="onboarding-chat-overlay">
    <div class="chat-ob-wrapper">
      <div class="chat-ob-header">
        <div style="display:flex;align-items:center;gap:10px;">
          <div
            style="width:40px;height:40px;background:linear-gradient(135deg,#3390ec,#2778d0);border-radius:50%;color:#fff;display:flex;align-items:center;justify-content:center;font-weight:800;font-size:15px;flex-shrink:0;letter-spacing:-0.5px;">
            AI</div>
          <div>
            <div style="font-weight:700;font-size:0.97rem;color:#000;line-height:1.2;">–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</div>
            <div style="font-size:0.76rem;color:#3390ec;font-weight:500;margin-top:1px;">–æ–Ω–ª–∞–π–Ω</div>
          </div>
        </div>
        <div style="display:flex;align-items:center;gap:2px;">
          <button id="btn-open-kb" class="chat-header-btn" title="–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π" aria-label="–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π"
            style="color:#3390ec;" onclick="openKBDrawer()">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M4 19.5v-15A2.5 2.5 0 0 1 6.5 2H20v20H6.5a2.5 2.5 0 0 1 0-5H20"></path>
            </svg>
          </button>
          <button class="chat-header-btn" title="–ù–æ–≤—ã–π –¥–∏–∑–∞–π–Ω (v3)" aria-label="–ù–æ–≤—ã–π –¥–∏–∑–∞–π–Ω (v3)"
            onclick="openDesignV3Preview()">
            üß©
          </button>
          <button id="refresh-chat-btn" class="chat-header-btn" title="–û–±–Ω–æ–≤–∏—Ç—å —á–∞—Ç"
            aria-label="–û–±–Ω–æ–≤–∏—Ç—å —á–∞—Ç">‚Üª</button>
          <button id="clear-chat-btn" class="chat-header-btn" title="–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç" aria-label="–û—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
              <path d="M9 3h6m-8 4h10m-9 0 1 16h6l1-16" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round" />
            </svg>
          </button>
          <button class="chat-header-btn"
            style="font-size:0.78rem;width:auto;padding:0 10px;color:#707579;border-radius:20px;"
            onclick="auth.signOut()">–í—ã–π—Ç–∏</button>
        </div>
      </div>

      <!-- ‚ïê‚ïê CONNECTION STATUS ‚ïê‚ïê -->
      <div id="cos-conn-status"></div>

      <!-- ‚ïê‚ïê STATUS BAR ‚ïê‚ïê -->
      <div id="chatos-statusbar" class="chatos-statusbar">
        <div class="cs-left">
          <span class="cs-pill" id="cs-activebot">‚óè Bot: ‚Äî</span>
          <span class="cs-pill" id="cs-kb">üìö KB: ‚Äî</span>
          <span class="cs-pill" id="cs-tg">‚úà TG: ‚Äî</span>
        </div>
      </div>

      <!-- ‚ïê‚ïê KB DRAWER & BACKDROP ‚ïê‚ïê -->
      <div id="kb-backdrop" class="kb-backdrop hidden"></div>
      <aside id="kb-drawer" class="kb-drawer hidden" aria-hidden="true">
        <div class="kb-header">
          <div class="kb-title">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</div>
          <button id="kb-close" class="kb-close" type="button" aria-label="–ó–∞–∫—Ä—ã—Ç—å">‚úï</button>
        </div>
        <div class="kb-body">
          <div id="kb-empty" class="kb-empty">
            <div class="kb-empty-title">–ó–¥–µ—Å—å –ø–æ—è–≤—è—Ç—Å—è –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∑–Ω–∞–Ω–∏–π</div>
            <div class="kb-empty-sub">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç ‚Äî –∏ –±–æ—Ç –Ω–∞—á–Ω—ë—Ç –æ—Ç–≤–µ—á–∞—Ç—å —Ç–æ—á–Ω–µ–µ.</div>
            <div class="kb-empty-actions">
              <button id="kb-refresh" class="kb-refresh-btn" type="button">–û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
          </div>
          <div id="kb-list" class="kb-list hidden"></div>
          <hr class="kb-sug-divider" id="kb-sug-divider" style="display:none">
          <div id="kb-suggestions-section" class="kb-suggestions hidden">
            <div class="kb-suggestions-hdr" id="kb-sug-title">–ù–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ</div>
            <div id="kb-suggestions-list"></div>
          </div>
        </div>
      </aside>

      <div class="chat-ob-messages" id="chat-ob-messages">
        <!-- 7. Empty state -->
        <div id="cos-empty" class="cos-empty">
          <div class="cos-empty-icon">üí¨</div>
          <div class="cos-empty-title">–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥</div>
          <div class="cos-empty-sub">–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ–º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å –∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤–∞—à–µ–≥–æ –±–æ—Ç–∞</div>
        </div>
        <!-- 6. Scroll-to-bottom -->
        <button id="cos-scroll-btn" class="cos-scroll-btn hidden" type="button" aria-label="–ü—Ä–æ–∫—Ä—É—Ç–∏—Ç—å –≤–Ω–∏–∑">‚Üì</button>
      </div>

      <div class="chat-ob-chips" id="chat-ob-chips">
        <!-- Fast options injected via JS -->
      </div>

      <div id="kb-add-panel" class="kb-add-panel hidden"></div>

      <div class="chat-ob-input-area">
        <div id="chat-ob-attachment-pill"
          style="display:none; padding:8px 12px; background:#f0f2f5; border-radius:12px; margin-bottom:8px; align-items:center; justify-content:space-between; font-size:0.85rem;">
          <div style="display:flex; align-items:center; gap:8px;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path>
              <polyline points="13 2 13 9 20 9"></polyline>
            </svg>
            <span id="chat-ob-attachment-name"
              style="font-weight:600; color:#000; max-width:150px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;"></span>
            <span id="chat-ob-attachment-size" style="color:#707579;"></span>
          </div>
          <button onclick="clearChatAttachment()"
            style="background:none; border:none; color:#ff3b30; cursor:pointer; padding:4px; display:flex;">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18"></line>
              <line x1="6" y1="6" x2="18" y2="18"></line>
            </svg>
          </button>
        </div>
        <div class="chat-ob-input-row" style="display:flex;align-items:center;">
          <button id="chat-ob-attach-btn"
            style="background:none;border:none;color:#8e8e93;cursor:pointer;padding:8px 4px 8px 8px;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
              stroke-linecap="round" stroke-linejoin="round">
              <path
                d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48">
              </path>
            </svg>
          </button>
          <input type="file" id="chat-ob-file-input" style="display:none" accept=".txt,.pdf,.csv,.docx,.md,.jpg,.png">
          <textarea id="chat-ob-input" class="chat-ob-input" placeholder="–ü–æ–¥–∫–ª—é—á–∞–µ–º –∞–∫–∫–∞—É–Ω—Ç..." autocomplete="off"
            disabled rows="1"></textarea>
          <button id="chat-ob-send" class="chat-ob-send" disabled>
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
            </svg>
          </button>
        </div>
      </div>

      <!-- In-chat confirm modal -->
      <div id="chat-confirm" class="chat-confirm hidden" role="dialog" aria-modal="true">
        <div class="cc-card">
          <div class="cc-title" id="cc-title">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ</div>
          <div class="cc-text" id="cc-text">–í—ã —É–≤–µ—Ä–µ–Ω—ã?</div>
          <div class="cc-actions">
            <button id="cc-cancel" class="cc-btn cc-btn--ghost" type="button">–û—Ç–º–µ–Ω–∞</button>
            <button id="cc-ok" class="cc-btn cc-btn--danger" type="button">–û–ö</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="sidebar">
    <div class="sidebar-logo">
      <div class="logo-box">ü§ñ</div>
      <span class="logo-text">BotPanel</span>
    </div>

    <!-- UNIFIED NAV -->
    <div class="sidebar-scroll" id="nav-agent">

      <!-- Create AI Agent CTA -->
      <button class="create-agent-btn" onclick="startCreateWizard()">
        <span style="font-size:16px;font-weight:400;line-height:1;">+</span> –°–æ–∑–¥–∞—Ç—å AI-–∞–≥–µ–Ω—Ç–∞
      </button>

      <!-- My Bots list -->
      <div class="nav-label">–ú–û–ò –ë–û–¢–´</div>
      <div id="bot-nav-list">
        <div style="padding:8px 10px;font-size:0.72rem;color:var(--text-dim);">–ù–µ—Ç –±–æ—Ç–æ–≤</div>
      </div>

      <!-- Bot-specific: overview + testing (shown when bot selected) -->
      <div id="bot-context-nav" style="display:none;">
        <div style="height:1px;background:var(--border);margin:6px 4px;"></div>
        <div class="nav-item" id="nav-overview" onclick="goAgentScreen('bot-overview')">
          <span class="nav-ico">üìä</span> –û–±–∑–æ—Ä
        </div>
      </div>

      <!-- Account section ‚Äî always visible -->
      <div style="height:1px;background:var(--border);margin:8px 4px 2px;"></div>
      <div class="nav-item" onclick="openSettings('billing')"><span class="nav-ico">üí≥</span> <span
          data-i18n="nav.billing">–û–ø–ª–∞—Ç–∞ –∏ —Ç–∞—Ä–∏—Ñ—ã</span></div>
      <div class="nav-item" onclick="openSettings('account')"><span class="nav-ico">üë§</span> <span
          data-i18n="nav.my_account">–ú–æ–π –∞–∫–∫–∞—É–Ω—Ç</span></div>
      <div class="nav-item" onclick="openSettings('partner')"><span class="nav-ico">ü§ù</span> <span
          data-i18n="nav.partner">–ö–∞–±–∏–Ω–µ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–∞</span></div>
      <div class="nav-item" onclick="openSettings('general')"><span class="nav-ico">üåê</span> <span
          data-i18n="nav.language">–Ø–∑—ã–∫</span></div>
      <div class="nav-item" id="nav-designv3" onclick="goAgentScreen('design-v3')"><span class="nav-ico">üß©</span>
        <span>–ù–æ–≤—ã–π –¥–∏–∑–∞–π–Ω (v3)</span>
      </div>
      <div class="nav-item" onclick="openProjectsUiV1()"><span class="nav-ico">üìÅ</span>
        <span>Projects UI v1</span>
      </div>
      <div class="nav-item" onclick="showToast(T[LANG]['help.soon'])"><span class="nav-ico">‚ùì</span> <span
          data-i18n="nav.help">–ü–æ–º–æ—â—å</span></div>
      <div class="nav-item" onclick="signOut()" style="color:var(--red);"><span class="nav-ico">üö™</span> <span
          data-i18n="nav.signout">–í—ã–π—Ç–∏</span></div>

      <!-- Hidden: kept for JS compatibility -->
      <div id="advanced-nav-list" style="display:none;"></div>

      <!-- Hidden elements kept for JS compatibility -->
      <div id="acc-list" style="display:none;"></div>
    </div>

    <div class="sidebar-footer">
      <div class="ai-requests">
        <div>
          <div class="ai-req-label" data-i18n="footer.ai_requests">–ò–ò-–∑–∞–ø—Ä–æ—Å—ã ‚ìò</div>
          <div class="ai-req-sub"><span data-i18n="footer.remaining">–û—Å—Ç–∞–ª–æ—Å—å</span> <span id="ai-count">0</span></div>
        </div>
        <span style="color:var(--text-dim);font-size:14px;">‚Ä∫</span>
      </div>
      <div class="ai-req-bar">
        <div class="ai-req-fill" id="ai-bar"></div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê MAIN ‚ïê‚ïê -->
  <div class="main">
    <div class="topbar">
      <div class="topbar-left">
        <button class="mob-menu-btn" onclick="toggleMobileSidebar()" aria-label="–ú–µ–Ω—é">‚ò∞</button>
        <span class="topbar-title" id="topbar-title">–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏</span>
        <span class="topbar-count" id="topbar-count"></span>
        <div class="bot-switcher" id="bot-switcher">
          <div class="bot-sw-btn" onclick="toggleBotDropdown(event)">
            <div class="bot-sw-av" id="sw-av">?</div>
            <span class="bot-sw-name" id="sw-name">–í—ã–±–µ—Ä–∏—Ç–µ –±–æ—Ç–∞</span>
            <span class="bot-sw-arrow" id="sw-arrow">‚ñæ</span>
          </div>
          <div class="bot-sw-dropdown" id="sw-dropdown"></div>
        </div>
      </div>
      <div class="topbar-right">
        <div class="search-box">
          <span>üîç</span>
          <input id="global-search" oninput="onSearch()">
        </div>
        <button class="theme-btn" onclick="toggleTheme()" title="–°–º–µ–Ω–∏—Ç—å —Ç–µ–º—É" id="theme-icon">üåô</button>
        <div class="user-pill" id="user-pill" style="display:none;" onclick="toggleAvDropdown(event)">
          <div class="user-av-sm" id="user-av">?</div>
          <span class="user-email" id="user-email-lbl"></span>
          <span style="color:var(--text-dim);font-size:11px;margin-left:2px;">‚ñæ</span>
          <!-- Dropdown -->
          <div class="av-dropdown" id="av-dropdown" onclick="event.stopPropagation()">
            <div class="av-dd-header">
              <div class="av-dd-name" id="av-dd-name">‚Äî</div>
              <div class="av-dd-email" id="av-dd-email">‚Äî</div>
            </div>
            <div class="av-dd-item" onclick="openSettings('account');closeAvDropdown()"><span
                class="av-dd-ico">üë§</span> –ú–æ–π –∞–∫–∫–∞—É–Ω—Ç</div>
            <div class="av-dd-item" onclick="openSettings('billing');closeAvDropdown()"><span
                class="av-dd-ico">üí≥</span> –û–ø–ª–∞—Ç–∞ –∏ —Ç–∞—Ä–∏—Ñ—ã</div>
            <div class="av-dd-item" onclick="openSettings('partner');closeAvDropdown()"><span
                class="av-dd-ico">ü§ù</span> –ö–∞–±–∏–Ω–µ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–∞</div>
            <div class="av-dd-sep"></div>
            <div class="av-dd-item" onclick="closeAvDropdown()"><span class="av-dd-ico">üåê</span> –Ø–∑—ã–∫</div>
            <div class="av-dd-item" onclick="closeAvDropdown()"><span class="av-dd-ico">‚ùì</span> –ü–æ–º–æ—â—å</div>
            <div class="av-dd-sep"></div>
            <div class="av-dd-item danger" onclick="signOut()"><span class="av-dd-ico">üö™</span> –í—ã–π—Ç–∏</div>
          </div>
        </div>
      </div>
    </div>

    <div class="content">

      <!-- ‚ïê‚ïê HOME ‚ïê‚ïê -->
      <div class="screen" id="screen-home">
        <div class="home-hero">
          <div class="home-hero-icon">ü§ñ</div>
          <div class="home-hero-title">–°–æ–∑–¥–∞–π—Ç–µ —Å–≤–æ–µ–≥–æ AI-–∞–≥–µ–Ω—Ç–∞</div>
          <div class="home-hero-sub">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ Telegram-–±–æ—Ç–∞, –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ –æ–±—â–µ–Ω–∏—è –∏ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π ‚Äî –ò–ò –Ω–∞—á–Ω—ë—Ç
            –æ—Ç–≤–µ—á–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>
          <button class="btn-primary" style="font-size:0.88rem;padding:12px 28px;margin-top:4px;"
            onclick="startCreateWizard()">
            + –°–æ–∑–¥–∞—Ç—å AI-–∞–≥–µ–Ω—Ç–∞
          </button>
          <div class="home-steps">
            <div class="home-step">
              <div class="home-step-ico">ü§ñ</div>
              <div class="home-step-ttl">1. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ –±–æ—Ç–∞</div>
              <div class="home-step-sub">–í—Å—Ç–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω –æ—Ç @BotFather ‚Äî –∑–∞–π–º—ë—Ç 1 –º–∏–Ω—É—Ç—É</div>
            </div>
            <div class="home-step">
              <div class="home-step-ico">üìö</div>
              <div class="home-step-ttl">2. –î–æ–±–∞–≤—å—Ç–µ –∑–Ω–∞–Ω–∏—è</div>
              <div class="home-step-sub">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã –∏–ª–∏ —Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ –≤–∞—à–µ–º –±–∏–∑–Ω–µ—Å–µ</div>
            </div>
            <div class="home-step">
              <div class="home-step-ico">üöÄ</div>
              <div class="home-step-ttl">3. –ó–∞–ø—É—Å—Ç–∏—Ç–µ</div>
              <div class="home-step-sub">–ë–æ—Ç –Ω–∞—á–Ω—ë—Ç –æ—Ç–≤–µ—á–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞–º –≤ Telegram</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê DESIGN V3 ‚ïê‚ïê -->
      <div class="screen" id="screen-design-v3" style="padding:12px;">
        <div class="v3-frame-wrap">
          <iframe class="v3-frame" src="/kb-design-v3.html" title="ChatOS Design v3"></iframe>
        </div>
      </div>

      <!-- ‚ïê‚ïê BOT OVERVIEW ‚ïê‚ïê -->
      <div class="screen" id="screen-bot-overview">
        <div class="page-label">–û–±–∑–æ—Ä –∞–≥–µ–Ω—Ç–∞</div>
        <div class="ov-card">
          <div class="ov-bot-row">
            <div class="ov-bot-info">
              <div class="ov-bot-av" id="ov-bot-av" style="background:#6366f1;">ü§ñ</div>
              <div>
                <div class="ov-bot-name" id="ov-bot-name">‚Äî</div>
                <div class="ov-bot-username" id="ov-bot-username">‚Äî</div>
              </div>
            </div>
            <!-- Status toggle -->
            <div class="toggle-wrap" onclick="toggleAgentStatus()">
              <span class="toggle-text on" id="ov-status-lbl">–ê–∫—Ç–∏–≤–µ–Ω</span>
              <div class="toggle-sw on" id="ov-status-sw"></div>
            </div>
          </div>

          <!-- ‚ïê‚ïê‚ïê STEP TABS ‚ïê‚ïê‚ïê -->
          <div class="step-tabs" id="step-tabs">
            <button class="step-tab active" data-step="rules" onclick="goStep('rules')">
              <span class="step-num">1</span> –ü—Ä–∞–≤–∏–ª–∞
            </button>
            <button class="step-tab" data-step="topics" onclick="goStep('topics')">
              <span class="step-num">2</span> –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π
            </button>
            <button class="step-tab" data-step="testing" onclick="goStep('testing')">
              <span class="step-num">3</span> –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
            </button>
            <button class="step-tab" data-step="launch" onclick="goStep('launch')">
              <span class="step-num">4</span> –ó–∞–ø—É—Å–∫
            </button>
            <button class="step-tab" data-step="autoreplies" onclick="goStep('autoreplies')">
              <span class="step-num">5</span> –ê–≤—Ç–æ–æ—Ç–≤–µ—Ç—ã
            </button>
            <button class="step-tab" data-step="flows" onclick="goStep('flows')">
              <span class="step-num">‚ö°</span> –°—Ü–µ–Ω–∞—Ä–∏–∏
            </button>
            <button class="step-tab" data-step="chats" onclick="goStep('chats')">
              <span class="step-num">6</span> –ß–∞—Ç—ã
            </button>
            <button class="step-tab" data-step="analytics" onclick="goStep('analytics')">
              <span class="step-num">7</span> –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
            </button>
          </div>
        </div>

        <!-- Quick stats -->
        <div class="kpi-grid">
          <div class="kpi-card">
            <div class="kpi-lbl">–ß–∞—Ç—ã –∑–∞ –º–µ—Å—è—Ü</div>
            <div class="kpi-val" style="color:var(--cyan);" id="ov-chats">0</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-lbl">AI-–∑–∞–ø—Ä–æ—Å—ã</div>
            <div class="kpi-val" style="color:var(--green);" id="ov-requests">0</div>
            <div class="kpi-sub" id="ov-req-sub"></div>
          </div>
          <div class="kpi-card">
            <div class="kpi-lbl">–ü–∞—Ä Q&amp;A</div>
            <div class="kpi-val" style="color:var(--yellow);" id="ov-kb">0</div>
          </div>
        </div>

        <!-- Step content: screens loaded here -->
        <div id="step-content-area" style="margin-top:16px;"></div>

        <!-- Inline test chat (for step 4: testing) -->
        <div id="ov-test-wrap" style="display:none;margin-top:14px;">
          <div class="chat-box"
            style="height:400px;border-radius:14px;border:1px solid var(--border);overflow:hidden;display:flex;flex-direction:column;">
            <div class="chat-head" style="flex-shrink:0;">
              <div class="chat-av">AI</div>
              <div>
                <div class="chat-head-name">–ò–ò-–∞–≥–µ–Ω—Ç</div>
                <div class="chat-head-online">‚óè –æ–Ω–ª–∞–π–Ω</div>
              </div>
              <div style="margin-left:auto;display:flex;gap:6px;">
                <button class="chat-ctrl-btn" onclick="clearChat('ov-chat-msgs')">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
                <button class="chat-ctrl-btn" onclick="goStep('ai-settings')">‚úï</button>
              </div>
            </div>
            <div class="chat-msgs" id="ov-chat-msgs" style="flex:1;overflow-y:auto;">
              <div class="date-sep">–°–µ–≥–æ–¥–Ω—è</div>
              <div class="msg-row">
                <div class="bubble">üëã –ü—Ä–∏–≤–µ—Ç! –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞–∫ —è –æ—Ç–≤–µ—á–∞—é –∫–ª–∏–µ–Ω—Ç–∞–º. –ù–∞–ø–∏—à–∏—Ç–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å.
                </div>
                <div class="msg-time"></div>
              </div>
            </div>
            <div class="chat-foot" style="flex-shrink:0;">
              <input class="chat-inp" id="ov-chat-input" placeholder="...
                onkeydown="if(event.key==='Enter')sendChat('ov-chat-input','ov-chat-msgs')">
              <button class="send-btn" onclick="sendChat('ov-chat-input','ov-chat-msgs')">‚û§</button>
            </div>
          </div>
        </div>
      </div>


      <!-- ‚ïê‚ïê AUTOMATIONS ‚ïê‚ïê -->
      <div class="screen" id="screen-automations">
        <div class="auto-grid" id="auto-grid">
        </div>
        <div id="auto-empty" class="empty-state" style="display:none;">
          <div class="empty-icon">ü§ñ</div>
          <div class="empty-title">–ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–π</div>
          <div class="empty-sub">–î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ Telegram Bot API —Ç–æ–∫–µ–Ω</div>
          <button class="btn-primary" style="margin-top:16px;" onclick="openModal()">+ –°–æ–∑–¥–∞—Ç—å</button>
        </div>
      </div>

      <!-- ‚ïê‚ïê CHATS ‚ïê‚ïê -->
      <div class="screen" id="screen-chats" style="padding:0;height:100%;display:none;">
        <div style="display:flex;height:100%;overflow:hidden;">
          <!-- Chat list -->
          <div
            style="width:300px;min-width:300px;border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden;">
            <div
              style="padding:12px 14px 10px;border-bottom:1px solid var(--border);flex-shrink:0;display:flex;align-items:center;justify-content:space-between;gap:8px;">
              <div
                style="font-size:0.75rem;font-weight:700;color:var(--text-dim);letter-spacing:0.06em;text-transform:uppercase;">
                –ß–∞—Ç—ã</div>
              <button onclick="openBroadcastModal()"
                style="font-size:0.7rem;padding:4px 10px;border-radius:7px;background:var(--primary);color:#fff;border:none;cursor:pointer;font-weight:600;white-space:nowrap;">üì£
                –†–∞—Å—Å—ã–ª–∫–∞</button>
            </div>
            <div id="chat-list-panel" style="flex:1;overflow-y:auto;"></div>
          </div>
          <!-- Chat messages -->
          <div style="flex:1;display:flex;flex-direction:column;overflow:hidden;">
            <div id="chat-view-header" style="border-bottom:1px solid var(--border);flex-shrink:0;display:none;">
              <!-- User card -->
              <div style="padding:12px 16px 10px;display:flex;align-items:center;gap:12px;">
                <div id="chat-card-av" class="user-card-av">?</div>
                <div style="flex:1;min-width:0;">
                  <div style="display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
                    <div id="chat-view-name" style="font-size:0.9rem;font-weight:700;"></div>
                    <a id="chat-view-username" href="#" target="_blank"
                      style="font-size:0.72rem;color:var(--primary);margin-top:1px;text-decoration:none;"></a>
                  </div>
                  <div class="user-card-meta">
                    <span>üìÖ <span id="chat-card-date">‚Äî</span></span>
                    <span>üí¨ <span id="chat-card-msgs">‚Äî</span> —Å–æ–æ–±—â.</span>
                  </div>
                </div>
                <div style="display:flex;flex-direction:column;align-items:flex-end;gap:5px;flex-shrink:0;">
                  <div style="display:flex;align-items:center;gap:8px;">
                    <button id="resume-ai-btn" onclick="resumeAI()"
                      style="display:none;font-size:0.68rem;padding:4px 10px;border-radius:7px;background:var(--primary-dim);color:var(--indigo);border:1px solid var(--primary-brd);cursor:pointer;font-weight:600;">‚ñ∂
                      –í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å –ò–ò</button>
                    <div id="chat-mode-badge" class="mode-badge ai">ü§ñ –ò–ò –æ—Ç–≤–µ—á–∞–µ—Ç</div>
                  </div>
                  <div id="handoff-timer" style="display:none;font-size:0.62rem;color:var(--text-sec);"></div>
                </div>
              </div>
              <!-- Operator notes -->
              <div style="padding:0 16px 10px;">
                <textarea id="chat-notes-input" class="notes-area"
                  placeholder="–ó–∞–º–µ—Ç–∫–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ (—Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏)..." rows="1"
                  oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,80)+'px'"
                  onblur="saveNotes(this.value)"></textarea>
              </div>
            </div>
            <div id="chat-view-messages"
              style="flex:1;overflow-y:auto;padding:16px 20px;display:flex;flex-direction:column;gap:8px;">
              <div class="empty-state" style="margin:auto;">
                <div class="empty-icon" style="font-size:32px;">üí¨</div>
                <div class="empty-sub">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç —Å–ª–µ–≤–∞</div>
              </div>
            </div>
            <!-- Admin reply area ‚Äî hidden until a chat is selected -->
            <div id="admin-reply-area"
              style="display:none;border-top:1px solid var(--border);padding:12px 16px;flex-shrink:0;">
              <div style="display:flex;gap:8px;align-items:flex-end;">
                <textarea id="admin-reply-input" class="admin-reply-input" rows="1"
                  placeholder="–û—Ç–≤–µ—Ç–∏—Ç—å –∫–ª–∏–µ–Ω—Ç—É –Ω–∞–ø—Ä—è–º—É—é (Enter ‚Äî –æ—Ç–ø—Ä–∞–≤–∏—Ç—å)..."
                  oninput="this.style.height='auto';this.style.height=Math.min(this.scrollHeight,120)+'px'"
                  onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendAdminMessage();}"></textarea>
                <button onclick="sendAdminMessage()"
                  style="background:var(--primary);border:none;border-radius:8px;width:38px;height:38px;display:flex;align-items:center;justify-content:center;cursor:pointer;color:#fff;font-size:13px;flex-shrink:0;transition:opacity 0.15s;"
                  onmouseover="this.style.opacity='.85'" onmouseout="this.style.opacity='1'"
                  title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å">‚û§</button>
              </div>
              <div style="font-size:0.6rem;color:var(--text-dim);margin-top:5px;">Shift+Enter ‚Äî –ø–µ—Ä–µ–Ω–æ—Å ¬∑ –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
                –ò–ò –≤—ã–∫–ª—é—á–∏—Ç—Å—è –Ω–∞ 5 –º–∏–Ω—É—Ç</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê ANALYTICS (unified: AI stats + request analytics) ‚ïê‚ïê -->
      <div class="screen" id="screen-analytics">




        <!-- ‚îÄ‚îÄ Request Analytics section ‚îÄ‚îÄ -->
        <div
          style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:8px;">
          <div class="page-label" style="margin:0;">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤</div>
          <button class="info-btn" onclick="showInfoPopover('analytics')" title="–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?">‚ìò</button>
        </div>
        <div class="tab-row">
          <button class="tab-btn" onclick="setTab(this)">7 –¥–Ω–µ–π</button>
          <button class="tab-btn" onclick="setTab(this)">30 –¥–Ω–µ–π</button>
          <button class="tab-btn active" onclick="setTab(this)">90 –¥–Ω–µ–π</button>
        </div>

        <div class="hero-card">
          <div class="donut-wrap">
            <svg viewBox="0 0 120 120">
              <circle cx="60" cy="60" r="44" fill="none" stroke="var(--border)" stroke-width="16" />
              <circle cx="60" cy="60" r="44" fill="none" stroke="var(--primary)" stroke-width="16"
                stroke-dasharray="276.5" stroke-dashoffset="0" stroke-linecap="round" transform="rotate(-180 60 60)" />
            </svg>
            <div class="donut-label">
              <div class="donut-pct" id="an-pct">0%</div>
            </div>
          </div>
          <div class="stat-rows" style="flex:1;">
            <div style="font-size:0.7rem;color:var(--text-sec);margin-bottom:8px;">—Å–æ–æ–±—â–µ–Ω–∏–π –æ–±—Ä–∞–±–æ—Ç–∞–ª –ò–ò-–∞–≥–µ–Ω—Ç</div>
            <div class="stat-row">
              <div class="stat-dot" style="background:var(--primary);"></div><span>–û—Ç–≤–µ—Ç–∏–ª –ò–ò-–∞–≥–µ–Ω—Ç</span><span
                class="stat-val" id="an-ai">0</span>
            </div>
            <div class="stat-row">
              <div class="stat-dot" style="background:var(--text-dim);"></div><span>–û—Ç–≤–µ—Ç—ã –≤—Ä—É—á–Ω—É—é</span><span
                class="stat-val" id="an-manual">0</span>
            </div>
          </div>
        </div>

        <div class="kpi-grid">
          <div class="kpi-card">
            <div class="kpi-lbl">–î–∏–∞–ª–æ–≥–∏</div>
            <div class="kpi-val" style="color:var(--cyan);" id="an-dialogs">0</div>
            <div class="kpi-sub">–∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-lbl">–ú–∏–Ω—É—Ç —Å—ç–∫–æ–Ω–æ–º–ª–µ–Ω–æ</div>
            <div class="kpi-val" style="color:var(--green);" id="an-mins">0</div>
            <div class="kpi-sub">–∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-lbl">–õ–∏–¥—ã</div>
            <div class="kpi-val" style="color:var(--yellow);" id="an-leads">0</div>
            <div class="kpi-sub">–∑–∞ –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥</div>
          </div>
        </div>

        <div class="section-head">
          <span class="section-lbl">–ë–µ–∑ –æ—Ç–≤–µ—Ç–∞ <span id="an-unans-count"
              style="font-weight:400;color:var(--text-dim);"></span></span>
          <button class="link-btn" onclick="goAgentScreen('unanswered')">–í—Å–µ ‚Üí</button>
        </div>
        <div class="q-grid" id="an-unans-preview">
          <div class="q-card" style="grid-column:1/-1;">
            <div class="empty-state" style="padding:20px;">
              <div class="empty-sub">–ü–æ–∫–∞ –Ω–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤ –±–µ–∑ –æ—Ç–≤–µ—Ç–∞</div>
            </div>
          </div>
        </div>

        <div class="section-head">
          <span class="section-lbl">–ü–æ–ø—É–ª—è—Ä–Ω—ã–µ —Ç–µ–º—ã <span id="an-topics-count"
              style="font-weight:400;color:var(--text-dim);"></span></span>
          <button class="link-btn" onclick="goAgentScreen('topics')">–í—Å–µ ‚Üí</button>
        </div>
        <div class="q-grid" id="an-topics-preview">
          <div class="q-card" style="grid-column:1/-1;">
            <div class="empty-state" style="padding:20px;">
              <div class="empty-sub">–¢–µ–º –ø–æ–∫–∞ –Ω–µ—Ç</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê TESTING ‚ïê‚ïê -->
      <div class="screen" id="screen-testing">
        <div class="page-label-row">
          <div class="page-label">–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
          <button class="info-btn" onclick="showInfoPopover('testing')" title="–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?">‚ìò</button>
        </div>
        <div class="guide-tip" id="guide-testing">
          <div class="guide-tip-icon">üß™</div>
          <div class="guide-tip-body">
            <div class="guide-tip-title">–®–∞–≥ 3: –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –±–æ—Ç–∞</div>
            <div class="guide-tip-text">–ù–∞–ø–∏—à–∏—Ç–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å –≤ —á–∞—Ç –∏ –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –∫–∞–∫ –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç. –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ
              —É—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç ‚Äî –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –∫ –ü—Ä–∞–≤–∏–ª–∞–º –∏–ª–∏ –ë–∞–∑–µ –∑–Ω–∞–Ω–∏–π –∏ –¥–æ—Ä–∞–±–æ—Ç–∞–π—Ç–µ.</div>
            <div class="guide-tip-actions">
              <button class="guide-tip-next" onclick="goStep('launch')">–î–∞–ª–µ–µ: –ó–∞–ø—É—Å–∫ ‚Üí</button>
            </div>
          </div>
          <button class="guide-tip-close" onclick="dismissGuide('testing')">&times;</button>
        </div>
        <div class="chat-layout">
          <div class="chat-box">
            <div class="chat-head">
              <div class="chat-av">AI</div>
              <div>
                <div class="chat-head-name">–ò–ò-–∞–≥–µ–Ω—Ç</div>
                <div class="chat-head-online" id="chat-head-status">‚óè –æ–Ω–ª–∞–π–Ω</div>
              </div>
              <div style="margin-left:auto;display:flex;gap:6px;">
                <button class="chat-ctrl-btn" onclick="clearChat()">üóë –û—á–∏—Å—Ç–∏—Ç—å</button>
                <button class="chat-ctrl-btn" onclick="restartAgent()">‚Ü∫ –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å</button>
              </div>
            </div>
            <div class="chat-msgs" id="chat-msgs">
              <div class="date-sep">–°–µ–≥–æ–¥–Ω—è</div>
              <div class="msg-row">
                <div class="bubble">üëã –ü—Ä–∏–≤–µ—Ç! –Ø ‚Äî –≤–∞—à –ò–ò-–∞–≥–µ–Ω—Ç. –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞–∫ —è –æ—Ç–≤–µ—á–∞—é –∫–ª–∏–µ–Ω—Ç–∞–º. –ù–∞–ø–∏—à–∏—Ç–µ
                  –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å.</div>
                <div class="msg-time" id="bot-first-time"></div>
              </div>
            </div>
            <div class="chat-foot">
              <input class="chat-inp" id="chat-input" placeholder="...
                onkeydown="if(event.key==='Enter')sendChat()">
              <button class="icon-btn">üôÇ</button>
              <button class="icon-btn">üé§</button>
              <button class="send-btn" onclick="sendChat()">‚û§</button>
            </div>
          </div>

          <div class="sug-panel">
            <div class="sug-label">–ù–∞—á–Ω–∏—Ç–µ —Å —ç—Ç–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤</div>
            <div class="sug-list" id="sug-list">
              <div class="empty-state" style="padding:20px;text-align:center;">
                <div class="empty-sub">–î–æ–±–∞–≤—å—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π, —á—Ç–æ–±—ã –ø–æ—è–≤–∏–ª–∏—Å—å –ø–æ–¥—Å–∫–∞–∑–∫–∏</div>
              </div>
            </div>
            <div class="sug-foot">–ù–∞ –æ—Å–Ω–æ–≤–µ <a href="#" onclick="goAgentScreen('knowledge');return false;">–ë–∞–∑—ã
                –∑–Ω–∞–Ω–∏–π</a></div>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê KNOWLEDGE ‚ïê‚ïê -->
      <div class="screen" id="screen-knowledge">
        <div class="page-label">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</div>
        <div class="guide-tip" id="guide-knowledge">
          <div class="guide-tip-icon">üìö</div>
          <div class="guide-tip-body">
            <div class="guide-tip-title">–®–∞–≥ 2: –û–±—É—á–∏—Ç–µ –±–æ—Ç–∞</div>
            <div class="guide-tip-text">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã, –¥–æ–±–∞–≤—å—Ç–µ —Ç–µ–∫—Å—Ç –∏–ª–∏ YouTube-–≤–∏–¥–µ–æ ‚Äî –±–æ—Ç –∏–∑—É—á–∏—Ç –º–∞—Ç–µ—Ä–∏–∞–ª –∏ –±—É–¥–µ—Ç
              –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–µ–π –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π.</div>
            <div class="guide-tip-actions">
              <button class="guide-tip-next" onclick="goStep('testing')">–î–∞–ª–µ–µ: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å ‚Üí</button>
            </div>
          </div>
          <button class="guide-tip-close" onclick="dismissGuide('knowledge')">&times;</button>
        </div>
        <div class="kb-wrap">
          <div class="kb-big-title">–û–±—É—á–∏—Ç–µ –ò–ò-–∞–≥–µ–Ω—Ç–∞</div>
          <div class="kb-option" onclick="openFileUpload()">
            <div class="kb-opt-left">
              <div class="kb-ico">üì§</div><span class="kb-opt-name">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã</span>
            </div>
            <span style="color:var(--text-dim);">‚Üí</span>
          </div>
          <div class="kb-option" onclick="showKbModal('text')">
            <div class="kb-opt-left">
              <div class="kb-ico">‚úèÔ∏è</div><span class="kb-opt-name">–†–∞—Å—Å–∫–∞–∑–∞—Ç—å —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏</span>
            </div>
            <span style="color:var(--text-dim);">‚Üí</span>
          </div>
          <div class="kb-option" onclick="openTranscribeModal()"
            style="border-color:rgba(239,68,68,0.35);background:linear-gradient(135deg,rgba(239,68,68,0.08),rgba(168,85,247,0.08));">
            <div class="kb-opt-left">
              <div class="kb-ico">üé¨</div><span class="kb-opt-name">–¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä–æ–≤–∞—Ç—å YouTube</span>
            </div>
            <span
              style="font-size:0.65rem;font-weight:700;color:#ef4444;background:rgba(239,68,68,0.12);border:1px solid rgba(239,68,68,0.3);border-radius:20px;padding:2px 8px;">–ù–û–í–û–ï</span>
          </div>
          <div class="kb-commons-label">–ß—Ç–æ –æ–±—ã—á–Ω–æ –¥–æ–±–∞–≤–ª—è—é—Ç</div>
          <div>
            <div class="kb-common"><span>üè¢</span> –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–º–ø–∞–Ω–∏–∏</div>
            <div class="kb-common"><span>üí∞</span> –û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–æ–≤, –∏—Ö –æ—Ç–ª–∏—á–∏–π –∏ —Ü–µ–Ω</div>
            <div class="kb-common"><span>üéÅ</span> –ê–∫—Ü–∏–∏ –∏ –≤—ã–≥–æ–¥–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</div>
            <div class="kb-common"><span>‚ùì</span> –û—Ç–≤–µ—Ç—ã –Ω–∞ —á–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã</div>
          </div>

          <!-- kb items added by user -->
          <div id="kb-items" style="margin-top:16px;display:flex;flex-direction:column;gap:8px;"></div>
        </div>
      </div>

      <!-- ‚ïê‚ïê UNANSWERED (redirects to topics tab) ‚ïê‚ïê -->
      <div class="screen" id="screen-unanswered"></div>

      <!-- ‚ïê‚ïê RULES ‚ïê‚ïê -->
      <div class="screen" id="screen-rules">
        <div class="page-label-row">
          <div class="page-label">–ü—Ä–∞–≤–∏–ª–∞ –æ–±—â–µ–Ω–∏—è</div>
          <button class="info-btn" onclick="showInfoPopover('rules')" title="–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?">‚ìò</button>
        </div>
        <div class="guide-tip" id="guide-rules">
          <div class="guide-tip-icon">üìã</div>
          <div class="guide-tip-body">
            <div class="guide-tip-title">–®–∞–≥ 1: –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø—Ä–∞–≤–∏–ª–∞</div>
            <div class="guide-tip-text">–ó–∞–¥–∞–π—Ç–µ –∏–º—è –±–æ—Ç–∞, —Ä–æ–ª—å –∏ —Å—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è. –ù–∞–ø–∏—à–∏—Ç–µ –ø—Ä–æ–º–ø—Ç ‚Äî –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –∫–∞–∫ –±–æ—Ç
              –¥–æ–ª–∂–µ–Ω –æ—Ç–≤–µ—á–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞–º. –ß–µ–º —Ç–æ—á–Ω–µ–µ ‚Äî —Ç–µ–º –ª—É—á—à–µ!</div>
            <div class="guide-tip-actions">
              <button class="guide-tip-next" onclick="goStep('topics')">–î–∞–ª–µ–µ: –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π ‚Üí</button>
            </div>
          </div>
          <button class="guide-tip-close" onclick="dismissGuide('rules')">&times;</button>
        </div>
        <div id="rules-no-rules-warn" class="inactive-banner" style="display:none;">
          ‚ö†Ô∏è –ë–µ–∑ –ø—Ä–∞–≤–∏–ª –æ–±—â–µ–Ω–∏—è –∞–≥–µ–Ω—Ç –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª–µ –Ω–∏–∂–µ.
        </div>
        <div class="rules-card">
          <div class="rules-card-title">–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç</div>
          <div class="rules-card-sub">–û–ø–∏—à–∏—Ç–µ: –∫—Ç–æ –≤–∞—à –±–æ—Ç, –¥–ª—è –∫–æ–≥–æ –æ–Ω, —Ç–æ–Ω –æ–±—â–µ–Ω–∏—è, —á—Ç–æ –¥–µ–ª–∞—Ç—å –µ—Å–ª–∏ –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞, —á—Ç–æ
            –∑–∞–ø—Ä–µ—â–µ–Ω–æ.</div>
          <!-- Templates -->
          <div style="margin-bottom:10px;">
            <div
              style="font-size:0.68rem;font-weight:700;color:var(--text-dim);letter-spacing:0.06em;text-transform:uppercase;margin-bottom:6px;">
              –ë—ã—Å—Ç—Ä—ã–µ —à–∞–±–ª–æ–Ω—ã</div>
            <div style="display:flex;gap:6px;flex-wrap:wrap;">
              <button class="btn-secondary" style="font-size:0.7rem;padding:4px 10px;"
                onclick="applyRuleTemplate('shop')">üõçÔ∏è –ú–∞–≥–∞–∑–∏–Ω</button>
              <button class="btn-secondary" style="font-size:0.7rem;padding:4px 10px;"
                onclick="applyRuleTemplate('restaurant')">üçï –†–µ—Å—Ç–æ—Ä–∞–Ω</button>
              <button class="btn-secondary" style="font-size:0.7rem;padding:4px 10px;"
                onclick="applyRuleTemplate('corporate')">üíº –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π</button>
              <button class="btn-secondary" style="font-size:0.7rem;padding:4px 10px;"
                onclick="applyRuleTemplate('medical')">üè• –ú–µ–¥–∏—Ü–∏–Ω–∞</button>
              <button class="btn-secondary" style="font-size:0.7rem;padding:4px 10px;"
                onclick="applyRuleTemplate('education')">üéì –û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</button>
            </div>
          </div>
          <textarea class="rules-textarea" id="rules-ta"
            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –¢—ã ‚Äî –≤–µ–∂–ª–∏–≤—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∫–æ–º–ø–∞–Ω–∏–∏ ¬´–ê–ª–∏—Ñ–¢–µ—Ö¬ª. –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π. –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å –æ—Ç–≤–µ—Ç–∞ ‚Äî –Ω–∞–ø–∏—à–∏: ¬´–£—Ç–æ—á–Ω–∏—Ç–µ —É –º–µ–Ω–µ–¥–∂–µ—Ä–∞¬ª. –ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é. –¢–æ–Ω: –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π."></textarea>
          <div class="field-caption">–ß–µ–º –ø–æ–¥—Ä–æ–±–Ω–µ–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è ‚Äî —Ç–µ–º —Ç–æ—á–Ω–µ–µ –æ—Ç–≤–µ—Ç—ã –±–æ—Ç–∞. –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º 200+ —Å–∏–º–≤–æ–ª–æ–≤.</div>
          <div class="rules-actions">
            <button class="btn-primary" onclick="saveRules()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            <button class="btn-secondary" onclick="autoGenerateRules()">‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π</button>
          </div>
        </div>
        <div class="rules-card">
          <div class="rules-card-title">–û–±—è–∑–∞—Ç–µ–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–∞–≤–∏–ª</div>
          <div class="rules-card-sub">–•–æ—Ä–æ—à–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –≤–∫–ª—é—á–∞—é—Ç –≤—Å–µ –ø—É–Ω–∫—Ç—ã:</div>
          <div style="margin-top:8px;">
            <div class="check-row"><span class="check-ico">‚úì</span><span><b style="color:var(--text);">–†–æ–ª—å:</b> –∫—Ç–æ
                —ç—Ç–æ—Ç –±–æ—Ç, –∫–∞–∫ –µ–≥–æ –∑–æ–≤—É—Ç</span></div>
            <div class="check-row"><span class="check-ico">‚úì</span><span><b style="color:var(--text);">–ê—É–¥–∏—Ç–æ—Ä–∏—è:</b>
                –¥–ª—è –∫–æ–≥–æ –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç</span></div>
            <div class="check-row"><span class="check-ico">‚úì</span><span><b style="color:var(--text);">–¢–æ–Ω:</b>
                —Ñ–æ—Ä–º–∞–ª—å–Ω—ã–π / –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π / —Å—Ç—Ä–æ–≥–∏–π</span></div>
            <div class="check-row"><span class="check-ico">‚úì</span><span><b style="color:var(--text);">–ï—Å–ª–∏ –Ω–µ—Ç
                  –æ—Ç–≤–µ—Ç–∞:</b> —á—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</span></div>
            <div class="check-row"><span class="check-ico">‚úì</span><span><b style="color:var(--text);">–ó–∞–ø—Ä–µ—Ç—ã:</b> —á—Ç–æ
                –Ω–µ–ª—å–∑—è –¥–µ–ª–∞—Ç—å (–Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞—Ç—å, –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç—å –∑–∞ —Ç–µ–º—É)</span></div>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê AUTO-REPLIES ‚ïê‚ïê -->
      <div class="screen" id="screen-autoreplies">
        <div class="page-label">–ê–≤—Ç–æ–æ—Ç–≤–µ—Ç—ã</div>
        <div class="rules-card">
          <div class="rules-card-title">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –æ—Ç–≤–µ—Ç—ã –±–µ–∑ AI</div>
          <div class="rules-card-sub">–ï—Å–ª–∏ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ ‚Äî –±–æ—Ç –æ—Ç–≤–µ—Ç–∏—Ç –∑–∞–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º, –Ω–µ
            —Ç—Ä–∞—Ç—è AI-–∑–∞–ø—Ä–æ—Å—ã.</div>
          <button class="btn-primary" style="margin-top:10px;" onclick="showAddAutoReply()">+ –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ</button>
        </div>
        <!-- Add/Edit form -->
        <div id="ar-form" class="rules-card" style="display:none;">
          <div class="rules-card-title" id="ar-form-title">–ù–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ</div>
          <div style="display:flex;flex-direction:column;gap:12px;">
            <div>
              <div class="form-label">–ö–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ / —Ñ—Ä–∞–∑–∞</div>
              <input class="form-input" id="ar-keyword" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Ü–µ–Ω–∞, –ø—Ä–∞–π—Å, —Å—Ç–æ–∏–º–æ—Å—Ç—å"
                style="margin-bottom:0;">
            </div>
            <div style="display:flex;gap:10px;">
              <label
                style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:0.78rem;color:var(--text-sec);">
                <input type="radio" name="ar-match" value="contains" checked> –°–æ–¥–µ—Ä–∂–∏—Ç
              </label>
              <label
                style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:0.78rem;color:var(--text-sec);">
                <input type="radio" name="ar-match" value="exact"> –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
              </label>
            </div>
            <div>
              <div class="form-label">–û—Ç–≤–µ—Ç –±–æ—Ç–∞</div>
              <textarea class="form-input" id="ar-response" rows="3"
                placeholder="–¢–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–ª—É—á–∏—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å..."
                style="margin-bottom:0;resize:vertical;"></textarea>
            </div>
            <div style="display:flex;gap:8px;">
              <button class="btn-primary" onclick="saveAutoReply()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button class="btn-secondary" onclick="cancelAutoReply()">–û—Ç–º–µ–Ω–∞</button>
            </div>
          </div>
        </div>
        <!-- Rules list -->
        <div id="ar-list"></div>
      </div>

      <!-- ‚ïê‚ïê FLOWS (–°—Ü–µ–Ω–∞—Ä–∏–∏) ‚ïê‚ïê -->
      <div class="screen" id="screen-flows">
        <div class="page-label">–°—Ü–µ–Ω–∞—Ä–∏–∏</div>
        <div class="rules-card">
          <div class="rules-card-title">Flow Builder ‚Äî –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏</div>
          <div class="rules-card-sub">–ö–æ–≥–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏—Ç –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ ‚Äî –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∫–Ω–æ–ø–∫–∏ —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –æ—Ç–≤–µ—Ç–æ–≤. –ù–∞–∂–∞–≤ –∫–Ω–æ–ø–∫—É, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç –Ω—É–∂–Ω—ã–π –æ—Ç–≤–µ—Ç.</div>
          <button class="btn-primary" style="margin-top:10px;" onclick="showAddFlow()">+ –î–æ–±–∞–≤–∏—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π</button>
        </div>
        <!-- Flow add/edit form -->
        <div id="flow-form" class="rules-card" style="display:none;">
          <div class="rules-card-title" id="flow-form-title">–ù–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π</div>
          <div style="display:flex;flex-direction:column;gap:14px;">
            <div>
              <div class="form-label">–¢—Ä–∏–≥–≥–µ—Ä (–∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ)</div>
              <input class="form-input" id="flow-trigger" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: —Ü–µ–Ω–∞, –ø—Ä–∞–π—Å, —Ç–∞—Ä–∏—Ñ" style="margin-bottom:0;">
            </div>
            <div style="display:flex;gap:10px;">
              <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:0.78rem;color:var(--text-sec);">
                <input type="radio" name="flow-match" value="contains" checked> –°–æ–¥–µ—Ä–∂–∏—Ç
              </label>
              <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:0.78rem;color:var(--text-sec);">
                <input type="radio" name="flow-match" value="exact"> –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
              </label>
            </div>
            <div>
              <div class="form-label">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å –∫–Ω–æ–ø–∫–∞–º–∏</div>
              <textarea class="form-input" id="flow-text" rows="2" placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∏–Ω—Ç–µ—Ä–µ—Å—É—é—â–∏–π –≤–∞—Ä–∏–∞–Ω—Ç:" style="margin-bottom:0;resize:vertical;"></textarea>
            </div>
            <div>
              <div class="form-label" style="margin-bottom:8px;">–ö–Ω–æ–ø–∫–∏</div>
              <div id="flow-buttons-list" style="display:flex;flex-direction:column;gap:8px;"></div>
              <button class="btn-secondary" style="margin-top:8px;font-size:0.72rem;" onclick="addFlowButton()">+ –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É</button>
            </div>
            <div style="display:flex;gap:8px;">
              <button class="btn-primary" onclick="saveFlow()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button class="btn-secondary" onclick="cancelFlow()">–û—Ç–º–µ–Ω–∞</button>
            </div>
          </div>
        </div>
        <!-- Flows list -->
        <div id="flows-list"></div>
      </div>

      <!-- ‚ïê‚ïê TOPICS (–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π) ‚ïê‚ïê -->
      <div class="screen" id="screen-topics">
        <div style="display:flex;align-items:center;gap:10px;margin-bottom:14px;flex-wrap:wrap;">
          <div class="page-label" style="margin:0;">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</div>
          <button class="info-btn" onclick="showInfoPopover('topics')" title="–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?">‚ìò</button>
          <div id="kb-action-btns" style="display:flex;gap:6px;">
            <button class="btn-secondary" onclick="openFileUpload()" style="font-size:0.72rem;padding:5px 11px;">üì§
              –ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
            <button class="btn-secondary" onclick="showKbModal('text')" style="font-size:0.72rem;padding:5px 11px;">‚úèÔ∏è
              –ù–∞–ø–∏—Å–∞—Ç—å</button>
            <button class="btn-secondary" onclick="openTranscribeModal()"
              style="font-size:0.72rem;padding:5px 11px;border-color:rgba(239,68,68,0.35);">üé¨ YouTube</button>
          </div>
        </div>
        <!-- Internal tab bar -->
        <div class="tab-row">
          <button class="tab-btn active" id="kb-tab-topics" onclick="switchKbTab('topics')">üìã –í—Å–µ —Ç–µ–º—ã <span
              id="topics-count" style="font-size:0.68rem;"></span></button>
          <button class="tab-btn" id="kb-tab-unans" onclick="switchKbTab('unanswered')">‚ùì –ë–µ–∑ –æ—Ç–≤–µ—Ç–æ–≤ <span
              id="unans-count-tab" style="font-size:0.68rem;"></span></button>
        </div>
        <!-- TOPICS tab content -->
        <div id="kb-content-topics">
          <!-- Active job progress (shown only during uploads) -->
          <div id="kb-jobs-inline" style="margin-bottom:12px;display:flex;flex-direction:column;gap:6px;"></div>
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;">
            <input class="form-input" style="max-width:240px;margin:0;" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ —Ç–µ–º–µ" id="topic-search"
              oninput="_dRenderTopics()">
            <span style="font-size:0.72rem;color:var(--text-dim);">‚Üë‚Üì –ü–æ–ø—É–ª—è—Ä–Ω–æ—Å—Ç—å</span>
          </div>
          <div class="table-wrap">
            <table class="data-table">
              <thead>
                <tr>
                  <th>–¢–µ–º–∞</th>
                  <th>–°–ø—Ä–æ—Å–∏–ª–∏</th>
                  <th>–ò—Å—Ç–æ—á–Ω–∏–∫</th>
                  <th></th>
                </tr>
              </thead>
              <tbody id="topics-body">
                <tr>
                  <td colspan="4">
                    <div class="empty-state" style="padding:30px;">
                      <div class="empty-icon" style="font-size:28px;">üìã</div>
                      <div class="empty-sub">–¢–µ–º –ø–æ–∫–∞ –Ω–µ—Ç. –î–æ–±–∞–≤—å—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π.</div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <!-- UNANSWERED tab content -->
        <div id="kb-content-unans" style="display:none;">
          <div style="font-size:0.72rem;color:var(--text-sec);margin-bottom:14px;">–í–æ–ø—Ä–æ—Å—ã –≤–Ω–µ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π ¬∑ –û–¥–æ–±—Ä–∏—Ç–µ
            —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π</div>
          <div class="unans-grid" id="unans-grid">
            <div style="grid-column:1/-1;">
              <div class="empty-state">
                <div class="empty-icon">‚úÖ</div>
                <div class="empty-title">–û—Ç–ª–∏—á–Ω–æ!</div>
                <div class="empty-sub">–í—Å–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ–ª—É—á–∏–ª–∏ –æ—Ç–≤–µ—Ç</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- screen-ai-usage is now merged into screen-analytics -->

      <!-- ‚ïê‚ïê AI SETTINGS ‚ïê‚ïê -->
      <div class="screen" id="screen-ai-settings">
        <div class="page-label">–ü—Ä–æ–≤–∞–π–¥–µ—Ä –ò–ò</div>
        <div class="guide-tip" id="guide-ai-settings">
          <div class="guide-tip-icon">‚öôÔ∏è</div>
          <div class="guide-tip-body">
            <div class="guide-tip-title">AI –ù–∞—Å—Ç—Ä–æ–π–∫–∏: –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</div>
            <div class="guide-tip-text">–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞–∫–æ–π AI –±—É–¥–µ—Ç –æ—Ç–≤–µ—á–∞—Ç—å –≤–∞—à–∏–º –∫–ª–∏–µ–Ω—Ç–∞–º ‚Äî OpenAI, Gemini –∏–ª–∏ Claude.
              –ú–æ–∂–µ—Ç–µ –≤–∫–ª—é—á–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ ‚Äî –∫–ª–∏–µ–Ω—Ç —Å–∞–º –≤—ã–±–µ—Ä–µ—Ç –≤ Telegram.</div>
            <div class="guide-tip-actions">
              <button class="guide-tip-next" onclick="goStep('rules')">–û–ö, –ø–æ–Ω—è—Ç–Ω–æ</button>
            </div>
          </div>
          <button class="guide-tip-close" onclick="dismissGuide('ai-settings')">&times;</button>
        </div>

        <div class="rules-card">
          <div class="rules-card-title">–í—ã–±–æ—Ä AI –¥–ª—è –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
          <div class="rules-card-sub">–í–∫–ª—é—á–∏—Ç–µ –æ–¥–∏–Ω –∏–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤. –ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ ‚Äî –∫–ª–∏–µ–Ω—Ç —Å–∞–º
            –≤—ã–±–µ—Ä–µ—Ç –Ω—É–∂–Ω—ã–π –ø—Ä—è–º–æ –≤ Telegram —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫–∏.</div>

          <!-- OpenAI -->
          <div
            style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:10px;">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
              <div style="display:flex;align-items:center;gap:10px;">
                <span style="font-size:20px;">üü¢</span>
                <div>
                  <div style="font-size:0.85rem;font-weight:700;">OpenAI GPT</div>
                  <div style="font-size:0.65rem;color:var(--text-dim);">GPT-4o-mini, GPT-4o</div>
                </div>
              </div>
              <div class="toggle-wrap" onclick="toggleProviderEnabled('openai')">
                <span class="toggle-text" id="openai-lbl">–í—ã–∫–ª</span>
                <div class="toggle-sw" id="openai-sw"></div>
              </div>
            </div>
            <div id="openai-fields" style="display:none;">
              <label class="form-label">–ú–æ–¥–µ–ª—å</label>
              <select class="model-select" id="openai-model">
                <option value="gpt-4o-mini">gpt-4o-mini (–±—ã—Å—Ç—Ä—ã–π, –¥–µ—à—ë–≤—ã–π)</option>
                <option value="gpt-4o">gpt-4o (—É–º–Ω—ã–π)</option>
                <option value="gpt-3.5-turbo">gpt-3.5-turbo</option>
              </select>
            </div>
          </div>

          <!-- Gemini -->
          <div
            style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:10px;">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
              <div style="display:flex;align-items:center;gap:10px;">
                <span style="font-size:20px;">üîµ</span>
                <div>
                  <div style="font-size:0.85rem;font-weight:700;">Google Gemini</div>
                  <div style="font-size:0.65rem;color:var(--text-dim);">Gemini 1.5 Flash/Pro</div>
                </div>
              </div>
              <div class="toggle-wrap" onclick="toggleProviderEnabled('gemini')">
                <span class="toggle-text" id="gemini-lbl">–í—ã–∫–ª</span>
                <div class="toggle-sw" id="gemini-sw"></div>
              </div>
            </div>
            <div id="gemini-fields" style="display:none;">
              <label class="form-label">–ú–æ–¥–µ–ª—å</label>
              <select class="model-select" id="gemini-model">
                <option value="gemini-1.5-flash">gemini-1.5-flash (–±—ã—Å—Ç—Ä—ã–π)</option>
                <option value="gemini-1.5-pro">gemini-1.5-pro (—É–º–Ω—ã–π)</option>
                <option value="gemini-2.0-flash">gemini-2.0-flash (–Ω–æ–≤—ã–π)</option>
              </select>
            </div>
          </div>

          <!-- Claude -->
          <div
            style="background:var(--surface2);border:1px solid var(--border);border-radius:10px;padding:14px;margin-bottom:14px;">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;">
              <div style="display:flex;align-items:center;gap:10px;">
                <span style="font-size:20px;">üü†</span>
                <div>
                  <div style="font-size:0.85rem;font-weight:700;">Anthropic Claude</div>
                  <div style="font-size:0.65rem;color:var(--text-dim);">Claude Haiku, Sonnet</div>
                </div>
              </div>
              <div class="toggle-wrap" onclick="toggleProviderEnabled('claude')">
                <span class="toggle-text" id="claude-lbl">–í—ã–∫–ª</span>
                <div class="toggle-sw" id="claude-sw"></div>
              </div>
            </div>
            <div id="claude-fields" style="display:none;">
              <label class="form-label">–ú–æ–¥–µ–ª—å</label>
              <select class="model-select" id="claude-model">
                <option value="claude-haiku-4-5-20251001">claude-haiku (–±—ã—Å—Ç—Ä—ã–π)</option>
                <option value="claude-sonnet-4-6">claude-sonnet (—É–º–Ω—ã–π)</option>
              </select>
            </div>
          </div>

          <button class="btn-primary" style="width:100%;justify-content:center;" onclick="saveAllProviders()">üíæ
            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</button>
        </div>

        <div class="rules-card">
          <div class="rules-card-title">–ö–∞–∫ –≤–∏–¥–∏—Ç –∫–ª–∏–µ–Ω—Ç</div>
          <div class="rules-card-sub">–ï—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤ ‚Äî –∫–ª–∏–µ–Ω—Ç –≤ Telegram –ø–æ–ª—É—á–∏—Ç –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞:
          </div>
          <div
            style="background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:14px;font-size:0.8rem;color:var(--text-sec);line-height:1.8;">
            <div style="color:var(--text);font-weight:600;margin-bottom:6px;">ü§ñ –í—ã–±–µ—Ä–∏—Ç–µ AI –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞:</div>
            <div style="display:flex;gap:6px;flex-wrap:wrap;">
              <span
                style="background:var(--primary-dim);border:1px solid var(--primary-brd);border-radius:6px;padding:4px 12px;color:var(--indigo);font-size:0.75rem;">üü¢
                OpenAI GPT</span>
              <span
                style="background:var(--primary-dim);border:1px solid var(--primary-brd);border-radius:6px;padding:4px 12px;color:var(--indigo);font-size:0.75rem;">üü†
                Claude</span>
            </div>
            <div style="margin-top:8px;font-size:0.72rem;color:var(--text-dim);">–ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ ‚Äî –∫–ª–∏–µ–Ω—Ç –≤—Å–µ–≥–¥–∞ –æ–±—â–∞–µ—Ç—Å—è —Å
              –≤—ã–±—Ä–∞–Ω–Ω—ã–º AI. –ú–æ–∂–µ—Ç —Å–º–µ–Ω–∏—Ç—å —á–µ—Ä–µ–∑ /ai</div>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê LAUNCH ‚ïê‚ïê -->
      <div class="screen" id="screen-launch">
        <div class="page-label-row">
          <div class="page-label">–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞</div>
          <button class="info-btn" onclick="showInfoPopover('launch')" title="–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?">‚ìò</button>
        </div>
        <div class="guide-tip" id="guide-launch">
          <div class="guide-tip-icon">üöÄ</div>
          <div class="guide-tip-body">
            <div class="guide-tip-title">–®–∞–≥ 4: –ó–∞–ø—É—Å—Ç–∏—Ç–µ –±–æ—Ç–∞!</div>
            <div class="guide-tip-text">–í—Å—Ç–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω Telegram-–±–æ—Ç–∞ –æ—Ç @BotFather, –Ω–∞–∂–º–∏—Ç–µ ¬´–ü–æ–¥–∫–ª—é—á–∏—Ç—å¬ª ‚Äî –∏ –≤–∞—à –±–æ—Ç
              –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç! –ö–ª–∏–µ–Ω—Ç—ã —Å–º–æ–≥—É—Ç –ø–∏—Å–∞—Ç—å –µ–º—É –≤ Telegram.</div>
            <div class="guide-tip-actions">
              <button class="guide-tip-next" onclick="goStep('autoreplies')">–î–∞–ª–µ–µ: –ê–≤—Ç–æ–æ—Ç–≤–µ—Ç—ã ‚Üí</button>
            </div>
          </div>
          <button class="guide-tip-close" onclick="dismissGuide('launch')">&times;</button>
        </div>

        <div class="rules-card">
          <div class="rules-card-title">–í–∞—à User ID</div>
          <div class="rules-card-sub">–°–∫–æ–ø–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç ID ‚Äî –æ–Ω –Ω—É–∂–µ–Ω –¥–ª—è —Å–∫—Ä–∏–ø—Ç–∞ –±–æ—Ç–∞.</div>
          <div class="uid-box">
            <span id="launch-uid" style="overflow:hidden;text-overflow:ellipsis;">‚Äî</span>
            <button class="copy-btn" onclick="copyUID()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>
        </div>

        <div class="rules-card">
          <div class="rules-card-title">–ê–∫—Ç–∏–≤–∞—Ü–∏—è Telegram –±–æ—Ç–∞</div>
          <div class="rules-card-sub">–ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ –æ–±–ª–∞–∫–æ ‚Äî –Ω–∏–∫–∞–∫–∏—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤ –Ω–µ –Ω—É–∂–Ω–æ. –ù–∞–∂–º–∏—Ç–µ
            –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ —á—Ç–æ–±—ã –ø–æ–¥–∫–ª—é—á–∏—Ç—å –±–æ—Ç–∞.</div>
          <div id="webhook-bots-list" style="margin-top:12px;display:flex;flex-direction:column;gap:8px;"></div>
          <button class="btn-primary" id="btn-activate-bots" onclick="activateAllBots()"
            style="margin-top:14px;width:100%;padding:12px;">
            ‚ö° –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–∞
          </button>
          <div id="webhook-status-msg" style="margin-top:8px;font-size:0.8rem;color:var(--text-sec);text-align:center;">
          </div>
        </div>

        <div class="rules-card">
          <div class="rules-card-title">–¢–µ–∫—É—â–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è</div>
          <div id="launch-config"
            style="display:flex;flex-direction:column;gap:8px;font-size:0.8rem;color:var(--text-sec);">
            –ó–∞–≥—Ä—É–∑–∫–∞...
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê TARIFF ‚ïê‚ïê -->
      <div class="screen" id="screen-tariff">
        <div class="page-label">–¢–∞—Ä–∏—Ñ—ã</div>

        <!-- Current plan -->
        <div class="rules-card"
          style="display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px;">
          <div>
            <div class="rules-card-title" style="margin-bottom:4px;">–¢–µ–∫—É—â–∏–π –ø–ª–∞–Ω: <span style="color:var(--indigo);"
                id="plan-name-lbl">‚Äî</span></div>
            <div class="rules-card-sub" id="plan-desc-lbl">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
          </div>
          <div id="plan-status-badge"
            style="background:var(--primary-dim);border:1px solid var(--primary-brd);border-radius:8px;padding:5px 14px;font-size:0.75rem;font-weight:700;color:var(--indigo);white-space:nowrap;">
            ‚Äî</div>
        </div>

        <!-- Billing toggle -->
        <div style="display:flex;gap:10px;margin-bottom:16px;">
          <button class="tariff-toggle-btn active" id="tbtn-year" onclick="setTariffBilling('year')">–ù–∞ –≥–æ–¥ <span
              style="background:#22c55e;color:#fff;font-size:0.6rem;padding:2px 6px;border-radius:20px;margin-left:4px;">‚àí20%</span></button>
          <button class="tariff-toggle-btn" id="tbtn-month" onclick="setTariffBilling('month')">–ü–æ–º–µ—Å—è—á–Ω–æ</button>
        </div>

        <!-- Plans grid: Trial + Starter / Pro + Business -->
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px;">

          <!-- Trial -->
          <div style="border-radius:14px;overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,0.10);">
            <div style="background:linear-gradient(135deg,#374151,#1f2937);padding:18px;position:relative;">
              <div style="font-size:1rem;font-weight:800;color:#fff;margin-bottom:4px;">Trial</div>
              <div style="font-size:0.68rem;color:rgba(255,255,255,0.55);margin-bottom:12px;line-height:1.4;">–ü–æ–ø—Ä–æ–±—É–π
                –±–µ—Å–ø–ª–∞—Ç–Ω–æ</div>
              <div style="font-size:0.75rem;color:rgba(255,255,255,0.3);text-decoration:line-through;min-height:16px;">
              </div>
              <div style="font-size:1.8rem;font-weight:800;color:#fff;line-height:1;">–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</div>
              <div style="font-size:0.62rem;color:rgba(255,255,255,0.4);margin-top:2px;margin-bottom:14px;">2 000
                AI-–∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞–≤—Å–µ–≥–¥–∞</div>
              <button
                style="width:100%;padding:9px;border-radius:8px;border:none;background:rgba(255,255,255,0.12);color:rgba(255,255,255,0.45);font-size:0.78rem;font-weight:600;cursor:default;"
                id="trial-btn">–¢–µ–∫—É—â–∏–π –ø–ª–∞–Ω</button>
            </div>
            <div style="background:var(--surface2);border:1px solid var(--border);border-top:none;">
              <div class="tariff-feature-row"><span>ü§ñ Telegram –±–æ—Ç–æ–≤</span><b>1</b></div>
              <div class="tariff-feature-row"><span>üí¨ –î–∏–∞–ª–æ–≥–æ–≤</span><b>‚àû</b></div>
              <div class="tariff-feature-row"><span>üìö –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</span><b>50 –∑–∞–ø–∏—Å–µ–π</b></div>
              <div class="tariff-feature-row"><span>üß† –ú–æ–¥–µ–ª–∏ AI</span><b>GPT / Gemini</b></div>
              <div class="tariff-feature-row"><span>‚ö° AI-–∑–∞–ø—Ä–æ—Å–æ–≤/–º–µ—Å</span><b>2 000</b></div>
              <div class="tariff-feature-row" style="border-bottom:none;"><span>üì£ –†–∞—Å—Å—ã–ª–∫–∞</span><b
                  style="color:var(--text-dim);">‚Äî</b></div>
            </div>
          </div>

          <!-- Starter -->
          <div style="border-radius:14px;overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,0.12);">
            <div style="background:linear-gradient(135deg,#1d4ed8,#1e40af);padding:18px;position:relative;">
              <div style="font-size:1rem;font-weight:800;color:#fff;margin-bottom:4px;">Starter</div>
              <div style="font-size:0.68rem;color:rgba(255,255,255,0.6);margin-bottom:12px;line-height:1.4;">–î–ª—è —Å—Ç–∞—Ä—Ç–∞
                –∏ –Ω–µ–±–æ–ª—å—à–∏—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤</div>
              <div style="font-size:0.75rem;color:rgba(255,255,255,0.35);text-decoration:line-through;min-height:16px;"
                id="starter-old-t">$19</div>
              <div style="font-size:1.8rem;font-weight:800;color:#fff;line-height:1;" id="starter-price-t">$15 <span
                  style="font-size:0.78rem;font-weight:400;opacity:0.7;">/ –≤ –º–µ—Å—è—Ü</span></div>
              <div style="font-size:0.62rem;color:rgba(255,255,255,0.45);margin-top:2px;margin-bottom:14px;"
                id="starter-note-t">–ø—Ä–∏ –æ–ø–ª–∞—Ç–µ –∑–∞ –≥–æ–¥</div>
              <button
                style="width:100%;padding:9px;border-radius:8px;border:none;background:rgba(255,255,255,0.2);color:#fff;font-size:0.78rem;font-weight:700;cursor:pointer;"
                onclick="showToast(I18n.t('paymentSoon'))">–í—ã–±—Ä–∞—Ç—å Starter</button>
            </div>
            <div style="background:var(--surface2);border:1px solid var(--border);border-top:none;">
              <div class="tariff-feature-row"><span>ü§ñ Telegram –±–æ—Ç–æ–≤</span><b>1</b></div>
              <div class="tariff-feature-row"><span>üí¨ –î–∏–∞–ª–æ–≥–æ–≤</span><b>‚àû</b></div>
              <div class="tariff-feature-row"><span>üìö –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</span><b>200 –∑–∞–ø–∏—Å–µ–π</b></div>
              <div class="tariff-feature-row"><span>üß† –ú–æ–¥–µ–ª–∏ AI</span><b>GPT / Gemini</b></div>
              <div class="tariff-feature-row"><span>‚ö° AI-–∑–∞–ø—Ä–æ—Å–æ–≤/–º–µ—Å</span><b>5 000</b></div>
              <div class="tariff-feature-row" style="border-bottom:none;"><span>üì£ –†–∞—Å—Å—ã–ª–∫–∞</span><b
                  style="color:var(--green);">‚úì</b></div>
            </div>
          </div>

          <!-- Pro -->
          <div style="border-radius:14px;overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,0.12);">
            <div style="background:linear-gradient(135deg,#4f2d7f,#3b1f6e);padding:18px;position:relative;">
              <div
                style="position:absolute;top:12px;right:12px;background:#a3e635;color:#1a1a2e;font-size:0.58rem;font-weight:700;padding:2px 8px;border-radius:20px;">
                –ü–æ–ø—É–ª—è—Ä–Ω—ã–π</div>
              <div style="font-size:1rem;font-weight:800;color:#fff;margin-bottom:4px;">Pro</div>
              <div style="font-size:0.68rem;color:rgba(255,255,255,0.6);margin-bottom:12px;line-height:1.4;">–î–ª—è
                —Ä–∞—Å—Ç—É—â–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞</div>
              <div style="font-size:0.75rem;color:rgba(255,255,255,0.35);text-decoration:line-through;min-height:16px;"
                id="pro-old-t">$49</div>
              <div style="font-size:1.8rem;font-weight:800;color:#fff;line-height:1;" id="pro-price-t">$39 <span
                  style="font-size:0.78rem;font-weight:400;opacity:0.7;">/ –≤ –º–µ—Å—è—Ü</span></div>
              <div style="font-size:0.62rem;color:rgba(255,255,255,0.45);margin-top:2px;margin-bottom:14px;"
                id="pro-note-t">–ø—Ä–∏ –æ–ø–ª–∞—Ç–µ –∑–∞ –≥–æ–¥</div>
              <button
                style="width:100%;padding:9px;border-radius:8px;border:none;background:rgba(255,255,255,0.2);color:#fff;font-size:0.78rem;font-weight:700;cursor:pointer;"
                onclick="showToast(I18n.t('paymentSoon'))">–í—ã–±—Ä–∞—Ç—å Pro</button>
            </div>
            <div style="background:var(--surface2);border:1px solid var(--border);border-top:none;">
              <div class="tariff-feature-row"><span>ü§ñ Telegram –±–æ—Ç–æ–≤</span><b>3</b></div>
              <div class="tariff-feature-row"><span>üí¨ –î–∏–∞–ª–æ–≥–æ–≤</span><b>‚àû</b></div>
              <div class="tariff-feature-row"><span>üìö –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</span><b>‚àû</b></div>
              <div class="tariff-feature-row"><span>üß† –ú–æ–¥–µ–ª–∏ AI</span><b style="color:var(--green);">–í—Å–µ –º–æ–¥–µ–ª–∏</b>
              </div>
              <div class="tariff-feature-row"><span>‚ö° AI-–∑–∞–ø—Ä–æ—Å–æ–≤/–º–µ—Å</span><b>20 000</b></div>
              <div class="tariff-feature-row" style="border-bottom:none;"><span>üì£ –†–∞—Å—Å—ã–ª–∫–∞</span><b
                  style="color:var(--green);">‚úì</b></div>
            </div>
          </div>

          <!-- Business -->
          <div style="border-radius:14px;overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,0.12);">
            <div style="background:linear-gradient(135deg,#92400e,#78350f);padding:18px;position:relative;">
              <div
                style="position:absolute;top:12px;right:12px;background:#fbbf24;color:#1a1a2e;font-size:0.58rem;font-weight:700;padding:2px 8px;border-radius:20px;">
                –ú–∞–∫—Å–∏–º—É–º</div>
              <div style="font-size:1rem;font-weight:800;color:#fff;margin-bottom:4px;">Business</div>
              <div style="font-size:0.68rem;color:rgba(255,255,255,0.6);margin-bottom:12px;line-height:1.4;">–î–ª—è
                –∞–≥–µ–Ω—Ç—Å—Ç–≤ –∏ –∫—Ä—É–ø–Ω–æ–≥–æ –±–∏–∑–Ω–µ—Å–∞</div>
              <div style="font-size:0.75rem;color:rgba(255,255,255,0.35);text-decoration:line-through;min-height:16px;"
                id="business-old-t">$149</div>
              <div style="font-size:1.8rem;font-weight:800;color:#fff;line-height:1;" id="business-price-t">$119 <span
                  style="font-size:0.78rem;font-weight:400;opacity:0.7;">/ –≤ –º–µ—Å—è—Ü</span></div>
              <div style="font-size:0.62rem;color:rgba(255,255,255,0.45);margin-top:2px;margin-bottom:14px;"
                id="business-note-t">–ø—Ä–∏ –æ–ø–ª–∞—Ç–µ –∑–∞ –≥–æ–¥</div>
              <button
                style="width:100%;padding:9px;border-radius:8px;border:none;background:#fbbf24;color:#1a1a2e;font-size:0.78rem;font-weight:700;cursor:pointer;"
                onclick="showToast(I18n.t('paymentSoon'))">–í—ã–±—Ä–∞—Ç—å Business</button>
            </div>
            <div style="background:var(--surface2);border:1px solid var(--border);border-top:none;">
              <div class="tariff-feature-row"><span>ü§ñ Telegram –±–æ—Ç–æ–≤</span><b>10</b></div>
              <div class="tariff-feature-row"><span>üí¨ –î–∏–∞–ª–æ–≥–æ–≤</span><b>‚àû</b></div>
              <div class="tariff-feature-row"><span>üìö –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</span><b>‚àû</b></div>
              <div class="tariff-feature-row"><span>üß† –ú–æ–¥–µ–ª–∏ AI</span><b style="color:var(--green);">–í—Å–µ –º–æ–¥–µ–ª–∏</b>
              </div>
              <div class="tariff-feature-row"><span>‚ö° AI-–∑–∞–ø—Ä–æ—Å–æ–≤/–º–µ—Å</span><b>100 000</b></div>
              <div class="tariff-feature-row" style="border-bottom:none;"><span>üì£ –†–∞—Å—Å—ã–ª–∫–∞</span><b
                  style="color:var(--green);">‚úì + White-label</b></div>
            </div>
          </div>

        </div>

        <!-- Usage -->
        <div class="rules-card">
          <div class="rules-card-title">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ</div>
          <div style="margin-top:10px;">
            <div style="display:flex;justify-content:space-between;font-size:0.78rem;margin-bottom:6px;">
              <span style="color:var(--text-sec);">AI-–∑–∞–ø—Ä–æ—Å—ã</span>
              <span style="font-weight:700;color:var(--text);"><span id="ai-count-used">0</span> / <span
                  id="ai-count-limit">2 000</span></span>
            </div>
            <div style="background:var(--border);border-radius:6px;height:8px;overflow:hidden;">
              <div id="ai-usage-bar"
                style="height:100%;background:linear-gradient(90deg,var(--indigo),#8b5cf6);border-radius:6px;width:0%;transition:width 0.5s;">
              </div>
            </div>
            <div style="font-size:0.68rem;color:var(--text-dim);margin-top:4px;">–°–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è 1-–≥–æ —á–∏—Å–ª–∞ –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞
            </div>
          </div>
        </div>

      </div>

    </div><!-- /content -->
  </div><!-- /main -->

  <!-- ‚ïê‚ïê SETTINGS OVERLAY ‚ïê‚ïê -->
  <div class="settings-overlay" id="settings-overlay">
    <!-- Sidebar -->
    <div class="settings-sidebar">
      <div class="settings-header">
        <button class="settings-back" onclick="closeSettings()">‚Üê</button>
        <span class="settings-logo" data-i18n="settings.title">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</span>
      </div>
      <div class="settings-nav-group">
        <div class="settings-nav-label" data-i18n="settings.group.account">–ê–∫–∫–∞—É–Ω—Ç</div>
        <div class="settings-nav-item" id="snav-account" onclick="goSettings('account')"><span class="s-ico">üë§</span>
          <span data-i18n="settings.my_account">–ú–æ–π –∞–∫–∫–∞—É–Ω—Ç</span>
        </div>
        <div class="settings-nav-item" id="snav-general" onclick="goSettings('general')"><span class="s-ico">‚öôÔ∏è</span>
          <span data-i18n="settings.general">–û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</span>
        </div>
      </div>
      <div class="settings-nav-group">
        <div class="settings-nav-label" data-i18n="settings.group.billing">–ë–∏–ª–ª–∏–Ω–≥</div>
        <div class="settings-nav-item" id="snav-billing" onclick="goSettings('billing')"><span class="s-ico">üí≥</span>
          <span data-i18n="settings.billing">–û–ø–ª–∞—Ç–∞ –∏ —Ç–∞—Ä–∏—Ñ—ã</span>
        </div>
        <div class="settings-nav-item" id="snav-limits" onclick="goSettings('limits')"><span class="s-ico">üìä</span>
          <span data-i18n="settings.limits">–õ–∏–º–∏—Ç—ã</span>
        </div>
        <div class="settings-nav-item" id="snav-bonuses" onclick="goSettings('bonuses')"><span class="s-ico">üéÅ</span>
          <span data-i18n="settings.bonuses">–ë–æ–Ω—É—Å—ã</span>
        </div>
      </div>
      <div class="settings-nav-group">
        <div class="settings-nav-label">–î—Ä—É–≥–æ–µ</div>
        <div class="settings-nav-item" id="snav-notifications" onclick="goSettings('notifications')"><span
            class="s-ico">üîî</span> –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
        <div class="settings-nav-label" data-i18n="settings.group.partner">–ü–∞—Ä—Ç–Ω—ë—Ä–∞–º</div>
        <div class="settings-nav-item" id="snav-partner" onclick="goSettings('partner')"><span class="s-ico">ü§ù</span>
          –ö–∞–±–∏–Ω–µ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–∞</div>
        <div class="settings-nav-sub" id="snav-partner-clients" onclick="goSettings('partner-clients')">–ü—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã–µ
          –∫–ª–∏–µ–Ω—Ç—ã</div>
      </div>
    </div>

    <!-- Content -->
    <div class="settings-content">

      <!-- ‚îÄ‚îÄ –ú–æ–π –∞–∫–∫–∞—É–Ω—Ç ‚îÄ‚îÄ -->
      <div class="s-section" id="ss-account">
        <div class="s-title">–ú–æ–π –∞–∫–∫–∞—É–Ω—Ç</div>
        <div class="s-subtitle">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∞—à–µ–º –ø—Ä–æ—Ñ–∏–ª–µ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</div>
        <div class="s-card">
          <div class="s-card-title">–ü—Ä–æ—Ñ–∏–ª—å</div>
          <div style="display:flex;align-items:center;gap:16px;margin-bottom:20px;">
            <div
              style="width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,#6366f1,#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:22px;font-weight:800;color:#fff;"
              id="s-av-big">?</div>
            <div>
              <div style="font-size:0.9rem;font-weight:700;color:var(--text);" id="s-profile-name">‚Äî</div>
              <div style="font-size:0.75rem;color:var(--text-dim);margin-top:2px;" id="s-profile-email">‚Äî</div>
              <div style="font-size:0.68rem;color:var(--indigo);margin-top:4px;" id="s-plan-badge">‚Äî</div>
            </div>
          </div>
        </div>
        <!-- Phone card ‚Äî shown only for Telegram users -->
        <div class="s-card" id="s-phone-card" style="display:none;">
          <div class="s-card-title">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</div>
          <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;">
            <div style="font-size:0.9rem;font-weight:600;color:var(--text);" id="s-phone-value">‚Äî</div>
            <button class="s-btn" onclick="openPhoneModal()" style="font-size:0.8rem;padding:6px 14px;">–ò–∑–º–µ–Ω–∏—Ç—å
              –Ω–æ–º–µ—Ä</button>
          </div>
        </div>
        <div class="s-card">
          <div class="s-card-title">–°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏</div>
          <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;">
            <div>
              <div style="font-size:0.95rem;font-weight:700;color:var(--text);" id="s-plan-name">‚Äî</div>
              <div style="font-size:0.75rem;color:var(--text-dim);margin-top:2px;" id="s-plan-info">‚Äî</div>
            </div>
            <button class="s-btn s-btn-primary" onclick="goSettings('billing')">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∞—Ä–∏—Ñ–æ–º</button>
          </div>
          <div style="margin-top:14px;">
            <div style="display:flex;justify-content:space-between;font-size:0.75rem;margin-bottom:6px;">
              <span style="color:var(--text-sec);">AI-–∑–∞–ø—Ä–æ—Å—ã –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ</span>
              <span style="font-weight:700;color:var(--text);"><span id="s-used">0</span> / <span id="s-limit">2
                  000</span></span>
            </div>
            <div class="s-prog-wrap">
              <div class="s-prog-fill" id="s-prog" style="width:0%"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ –û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ ‚îÄ‚îÄ -->
      <div class="s-section" id="ss-general">
        <div class="s-title" data-i18n="settings.general">–û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</div>
        <div class="s-subtitle" data-i18n="settings.general.sub">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</div>
        <!-- Language picker -->
        <div class="s-card">
          <div class="s-card-title" data-i18n="lang.card.title">–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞</div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:4px;">
            <button class="lang-btn" id="lang-btn-ru" onclick="setLang('ru')"
              style="display:flex;align-items:center;gap:8px;padding:10px 18px;border-radius:10px;border:2px solid var(--border);background:var(--surface2);cursor:pointer;font-size:0.85rem;font-weight:600;color:var(--text);transition:all 0.15s;">
              <span style="font-size:1.2rem;">üá∑üá∫</span> –†—É—Å—Å–∫–∏–π
            </button>
            <button class="lang-btn" id="lang-btn-en" onclick="setLang('en')"
              style="display:flex;align-items:center;gap:8px;padding:10px 18px;border-radius:10px;border:2px solid var(--border);background:var(--surface2);cursor:pointer;font-size:0.85rem;font-weight:600;color:var(--text);transition:all 0.15s;">
              <span style="font-size:1.2rem;">üá¨üáß</span> English
            </button>
            <button class="lang-btn" id="lang-btn-uz" onclick="setLang('uz')"
              style="display:flex;align-items:center;gap:8px;padding:10px 18px;border-radius:10px;border:2px solid var(--border);background:var(--surface2);cursor:pointer;font-size:0.85rem;font-weight:600;color:var(--text);transition:all 0.15s;">
              <span style="font-size:1.2rem;">üá∫üáø</span> O'zbekcha
            </button>
          </div>
        </div>
        <div class="s-card">
          <div class="s-card-title" data-i18n="settings.company.title">–î–∞–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏</div>
          <div class="s-field">
            <div class="s-label">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ / –∫–æ–º–ø–∞–Ω–∏–∏</div>
            <input class="s-input" id="s-company-name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: MyShop">
          </div>
          <div class="s-field">
            <div class="s-label">Email</div>
            <input class="s-input" id="s-company-email" readonly>
          </div>
          <div class="s-field" style="display:flex;align-items:center;gap:10px;">
            <input type="checkbox" id="s-newsletter" style="width:16px;height:16px;cursor:pointer;">
            <label for="s-newsletter" style="font-size:0.8rem;color:var(--text-sec);cursor:pointer;">–ü–æ–ª—É—á–∞—Ç—å –Ω–æ–≤–æ—Å—Ç–Ω—ã–µ
              —Ä–∞—Å—Å—ã–ª–∫–∏</label>
          </div>
          <button class="s-btn s-btn-primary" onclick="saveGeneralSettings()">–û–±–Ω–æ–≤–∏—Ç—å</button>
        </div>
        <div class="s-card">
          <div class="s-card-title">–ü–∞—Ä–æ–ª—å</div>
          <div class="s-field">
            <div class="s-label">–°—Ç–∞—Ä—ã–π –ø–∞—Ä–æ–ª—å</div>
            <input class="s-input" type="password" id="s-old-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
          </div>
          <div class="s-field">
            <div class="s-label">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</div>
            <input class="s-input" type="password" id="s-new-pass" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
          </div>
          <button class="s-btn s-btn-primary" onclick="changePassword()">–ò–∑–º–µ–Ω–∏—Ç—å –ø–∞—Ä–æ–ª—å</button>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ –û–ø–ª–∞—Ç–∞ –∏ —Ç–∞—Ä–∏—Ñ—ã ‚îÄ‚îÄ -->
      <div class="s-section" id="ss-billing">
        <div class="s-title">–û–ø–ª–∞—Ç–∞ –∏ —Ç–∞—Ä–∏—Ñ—ã</div>
        <div class="s-subtitle">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–æ–π –∏ –∏—Å—Ç–æ—Ä–∏–µ–π –ø–ª–∞—Ç–µ–∂–µ–π</div>
        <div class="s-card">
          <div class="s-card-title">–¢–µ–∫—É—â–∏–π —Ç–∞—Ä–∏—Ñ</div>
          <div
            style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:14px;">
            <div>
              <div style="font-size:1rem;font-weight:800;color:var(--text);" id="sb-plan-name">Pro (–ø—Ä–æ–±–Ω—ã–π)</div>
              <div style="font-size:0.75rem;color:var(--text-dim);margin-top:3px;" id="sb-plan-desc">14 –¥–Ω–µ–π –±–µ—Å–ø–ª–∞—Ç–Ω–æ
              </div>
            </div>
            <div style="display:flex;gap:8px;">
              <button class="s-btn s-btn-secondary" onclick="openChangePlanModal()">–ò–∑–º–µ–Ω–∏—Ç—å —Ç–∞—Ä–∏—Ñ</button>
              <button class="s-btn s-btn-danger"
                onclick="document.getElementById('modal-cancel-sub').classList.add('open')">–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</button>
            </div>
          </div>
        </div>
        <div class="s-card">
          <div class="s-card-title">AI-–∑–∞–ø—Ä–æ—Å—ã</div>
          <div style="display:flex;justify-content:space-between;font-size:0.8rem;margin-bottom:8px;">
            <span style="color:var(--text-sec);">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ –≤ —ç—Ç–æ–º –º–µ—Å—è—Ü–µ</span>
            <span style="font-weight:700;color:var(--text);"><span id="sb-used">0</span> –∏–∑ <span id="sb-limit">2
                000</span></span>
          </div>
          <div class="s-prog-wrap">
            <div class="s-prog-fill" id="sb-prog" style="width:0%"></div>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;margin-top:10px;">
            <span style="font-size:0.68rem;color:var(--text-dim);">–°–±—Ä–∞—Å—ã–≤–∞–µ—Ç—Å—è 1-–≥–æ —á–∏—Å–ª–∞ –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞</span>
            <button class="s-btn s-btn-secondary" style="font-size:0.7rem;padding:6px 12px;"
              onclick="openBuyRequestsModal()">–ö—É–ø–∏—Ç—å –µ—â—ë</button>
          </div>
        </div>
        <div class="s-card">
          <div class="s-card-title">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</div>
          <!-- Card exists state -->
          <div id="card-exists" style="display:none;flex-direction:column;gap:12px;">
            <div style="display:flex;align-items:center;justify-content:space-between;">
              <div style="display:flex;align-items:center;gap:10px;">
                <div id="card-logo"
                  style="width:44px;height:28px;border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:9px;color:#fff;font-weight:700;background:#1a1a6e;">
                  VISA</div>
                <div>
                  <div style="font-size:0.82rem;color:var(--text);font-weight:600;">‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ <span
                      id="card-last4">‚Äî</span></div>
                  <div style="font-size:0.68rem;color:var(--text-dim);" id="card-holder">‚Äî</div>
                </div>
              </div>
              <button class="s-btn s-btn-danger" style="font-size:0.7rem;padding:6px 12px;"
                onclick="deleteCard()">–£–¥–∞–ª–∏—Ç—å</button>
            </div>
          </div>
          <!-- No card state -->
          <div id="card-empty" style="display:none;flex-direction:column;gap:12px;">
            <div style="font-size:0.78rem;color:var(--text-dim);">–ö–∞—Ä—Ç–∞ –Ω–µ –ø—Ä–∏–≤—è–∑–∞–Ω–∞</div>
            <button class="s-btn s-btn-secondary" onclick="showAddCard()">+ –ü—Ä–∏–≤—è–∑–∞—Ç—å –∫–∞—Ä—Ç—É</button>
          </div>
          <!-- Add card form -->
          <div id="card-form" style="display:none;flex-direction:column;gap:10px;">
            <div class="s-field">
              <div class="s-label">–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã</div>
              <input class="s-input" id="card-number-input" placeholder="0000 0000 0000 0000" maxlength="19"
                oninput="formatCardNumber(this)">
            </div>
            <div style="display:flex;gap:10px;">
              <div class="s-field" style="flex:1;">
                <div class="s-label">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è</div>
                <input class="s-input" id="card-expiry-input" placeholder="–ú–ú/–ì–ì" maxlength="5"
                  oninput="formatExpiry(this)">
              </div>
              <div class="s-field" style="flex:1;">
                <div class="s-label">–î–µ—Ä–∂–∞—Ç–µ–ª—å –∫–∞—Ä—Ç—ã</div>
                <input class="s-input" id="card-name-input" placeholder="IVAN PETROV" style="text-transform:uppercase;">
              </div>
            </div>
            <div style="display:flex;gap:8px;">
              <button class="s-btn s-btn-primary" onclick="saveCard()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
              <button class="s-btn s-btn-secondary" onclick="cancelAddCard()">–û—Ç–º–µ–Ω–∞</button>
            </div>
          </div>
        </div>
        <div class="s-card">
          <div class="s-card-title">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</div>
          <table class="s-table">
            <thead>
              <tr>
                <th>–û–ø–µ—Ä–∞—Ü–∏—è</th>
                <th>–°—É–º–º–∞</th>
                <th>–î–∞—Ç–∞</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
              </tr>
            </thead>
            <tbody id="sb-history-body">
              <tr>
                <td colspan="4" style="text-align:center;color:var(--text-dim);padding:20px;">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ –õ–∏–º–∏—Ç—ã ‚îÄ‚îÄ -->
      <div class="s-section" id="ss-limits">
        <div class="s-title">–õ–∏–º–∏—Ç—ã</div>
        <div class="s-subtitle">–ß—Ç–æ –≤–∫–ª—é—á–µ–Ω–æ –≤ –≤–∞—à —Ç–µ–∫—É—â–∏–π —Ç–∞—Ä–∏—Ñ</div>
        <div class="s-card">
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
            <div class="s-card-title" style="margin:0;" id="sl-plan-title">Pro (–ø—Ä–æ–±–Ω—ã–π)</div>
            <span class="s-badge s-badge-green">–ê–∫—Ç–∏–≤–µ–Ω</span>
          </div>
          <div class="s-limit-row"><span style="color:var(--text-sec);">AI-–∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–µ—Å—è—Ü</span><b
              style="color:var(--text);" id="sl-ai-req">2 000</b></div>
          <div class="s-limit-row"><span style="color:var(--text-sec);">Telegram –±–æ—Ç–æ–≤</span><b
              style="color:var(--text);" id="sl-bots">1</b></div>
          <div class="s-limit-row"><span style="color:var(--text-sec);">–î–∏–∞–ª–æ–≥–æ–≤</span><b
              style="color:var(--green);">‚àû</b></div>
          <div class="s-limit-row"><span style="color:var(--text-sec);">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</span><b style="color:var(--text);"
              id="sl-kb">100 –∑–∞–ø–∏—Å–µ–π</b></div>
          <div class="s-limit-row"><span style="color:var(--text-sec);">AI-–º–æ–¥–µ–ª–∏</span><b style="color:var(--text);"
              id="sl-models">GPT / Gemini</b></div>
          <div class="s-limit-row"><span style="color:var(--text-sec);">–ì–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—è</span><b
              style="color:var(--red);">–ù–µ—Ç</b></div>
          <div class="s-limit-row"><span style="color:var(--text-sec);">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</span><b
              style="color:var(--green);">–î–∞</b></div>
          <div class="s-limit-row"><span style="color:var(--text-sec);">–ü–∞—Ä—Ç–Ω—ë—Ä—Å–∫–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</span><b
              style="color:var(--green);">–î–∞</b></div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ –ë–æ–Ω—É—Å—ã ‚îÄ‚îÄ -->
      <div class="s-section" id="ss-bonuses">
        <div class="s-title">–ë–æ–Ω—É—Å—ã</div>
        <div class="s-subtitle">–ê–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –±–æ–Ω—É—Å–∞</div>
        <div class="s-card">
          <div class="s-card-title">–ü—Ä–æ–º–æ–∫–æ–¥</div>
          <div style="font-size:0.78rem;color:var(--text-dim);margin-bottom:14px;">–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å
            –±–æ–Ω—É—Å ‚Äî –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã, –ø—Ä–æ–¥–ª–µ–Ω–∏–µ —Ç—Ä–∏–∞–ª–∞ –∏–ª–∏ —Å–∫–∏–¥–∫—É –Ω–∞ —Ç–∞—Ä–∏—Ñ.</div>
          <div style="display:flex;gap:10px;">
            <input class="s-input" id="s-promo-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥..."
              style="flex:1;text-transform:uppercase;" oninput="this.value=this.value.toUpperCase()">
            <button class="s-btn s-btn-primary" id="s-promo-btn" onclick="activatePromo()">–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>
          <div id="s-promo-result" style="margin-top:10px;font-size:0.78rem;"></div>
        </div>
        <div class="s-card">
          <div class="s-card-title">–ê–∫—Ç–∏–≤–Ω—ã–µ –±–æ–Ω—É—Å—ã</div>
          <div id="s-active-bonuses">
            <div style="text-align:center;color:var(--text-dim);font-size:0.78rem;padding:16px;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –±–æ–Ω—É—Å–æ–≤
            </div>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ‚îÄ‚îÄ -->
      <div class="s-section" id="ss-notifications">
        <div class="s-title">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</div>
        <div class="s-subtitle">–ü–æ–ª—É—á–∞–π—Ç–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –≤ Telegram –∫–æ–≥–¥–∞ –ø—Ä–æ–∏—Å—Ö–æ–¥—è—Ç –≤–∞–∂–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è</div>
        <div class="s-card">
          <div class="s-card-title">–í–∞—à Telegram ID</div>
          <div style="font-size:0.75rem;color:var(--text-dim);margin-bottom:10px;">–û—Ç–ø—Ä–∞–≤—å—Ç–µ <b
              style="color:var(--indigo);">/myid</b> –≤–∞—à–µ–º—É –±–æ—Ç—É, —á—Ç–æ–±—ã —É–∑–Ω–∞—Ç—å —Å–≤–æ–π Telegram ID</div>
          <div style="display:flex;gap:8px;">
            <input class="s-input" id="notif-owner-id" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 123456789" style="flex:1;">
            <button class="s-btn s-btn-primary" onclick="saveNotifSettings()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          </div>
        </div>
        <div class="s-card">
          <div class="s-card-title">–ß—Ç–æ –ø—Ä–∏—Å—ã–ª–∞—Ç—å</div>
          <div style="display:flex;flex-direction:column;gap:12px;margin-top:4px;">
            <label style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;">
              <div>
                <div style="font-size:0.82rem;font-weight:600;color:var(--text);">üë§ –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</div>
                <div style="font-size:0.7rem;color:var(--text-dim);">–ö–æ–≥–¥–∞ –∫—Ç–æ-—Ç–æ –≤–ø–µ—Ä–≤—ã–µ –ø–∏—à–µ—Ç –±–æ—Ç—É</div>
              </div>
              <div class="toggle-wrap" onclick="toggleNotif(this,'notifyNewUser')" style="cursor:pointer;">
                <span class="toggle-text on" id="notif-new-user-lbl">–í–∫–ª</span>
                <div class="toggle-sw on" id="notif-new-user-sw"></div>
              </div>
            </label>
            <label style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;">
              <div>
                <div style="font-size:0.82rem;font-weight:600;color:var(--text);">‚ö†Ô∏è –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–æ 80% –ª–∏–º–∏—Ç–∞</div>
                <div style="font-size:0.7rem;color:var(--text-dim);">–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ —Å–∫–æ—Ä–æ–º –∏—Å—á–µ—Ä–ø–∞–Ω–∏–∏ –∑–∞–ø—Ä–æ—Å–æ–≤</div>
              </div>
              <div class="toggle-wrap" onclick="toggleNotif(this,'notify80')" style="cursor:pointer;">
                <span class="toggle-text on" id="notif-80-lbl">–í–∫–ª</span>
                <div class="toggle-sw on" id="notif-80-sw"></div>
              </div>
            </label>
            <label style="display:flex;align-items:center;justify-content:space-between;cursor:pointer;">
              <div>
                <div style="font-size:0.82rem;font-weight:600;color:var(--text);">üî¥ –õ–∏–º–∏—Ç –∏—Å—á–µ—Ä–ø–∞–Ω (100%)</div>
                <div style="font-size:0.7rem;color:var(--text-dim);">–ö–æ–≥–¥–∞ –±–æ—Ç –ø–µ—Ä–µ—Å—Ç–∞—ë—Ç –æ—Ç–≤–µ—á–∞—Ç—å –∫–ª–∏–µ–Ω—Ç–∞–º</div>
              </div>
              <div class="toggle-wrap" onclick="toggleNotif(this,'notify100')" style="cursor:pointer;">
                <span class="toggle-text on" id="notif-100-lbl">–í–∫–ª</span>
                <div class="toggle-sw on" id="notif-100-sw"></div>
              </div>
            </label>
          </div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ –ü–∞—Ä—Ç–Ω—ë—Ä: –ì–ª–∞–≤–Ω–∞—è ‚îÄ‚îÄ -->
      <div class="s-section" id="ss-partner-main">
        <div class="s-title">–ö–∞–±–∏–Ω–µ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–∞</div>
        <div class="s-subtitle">–ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ, –ø—Ä–∏–≥–ª–∞—à–∞—è –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—É</div>
        <div class="s-stat-grid">
          <div class="s-stat-card">
            <div class="s-stat-val" id="sp-balance">$0</div>
            <div class="s-stat-lbl">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</div>
          </div>
          <div class="s-stat-card">
            <div class="s-stat-val" id="sp-earned">$0</div>
            <div class="s-stat-lbl">–í—Å–µ–≥–æ –∑–∞—Ä–∞–±–æ—Ç–∞–Ω–æ</div>
          </div>
          <div class="s-stat-card">
            <div class="s-stat-val" id="sp-clients">0</div>
            <div class="s-stat-lbl">–ü—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤</div>
          </div>
        </div>
        <div class="s-card">
          <div class="s-card-title">–°—Ç–∞—Ç—É—Å –ø–∞—Ä—Ç–Ω—ë—Ä–∞</div>
          <div
            style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:14px;">
            <div>
              <div style="font-size:0.9rem;font-weight:700;color:var(--text);">–ü–∞—Ä—Ç–Ω—ë—Ä</div>
              <div style="font-size:0.75rem;color:var(--text-dim);margin-top:2px;">25% –≤–æ–∑–Ω–∞–≥—Ä–∞–∂–¥–µ–Ω–∏–µ –Ω–∞ 24 –º–µ—Å—è—Ü–∞ —Å
                –∫–∞–∂–¥–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞</div>
            </div>
            <span class="s-badge s-badge-green">–ê–∫—Ç–∏–≤–µ–Ω</span>
          </div>
          <div class="s-card-title" style="margin-bottom:10px;">–†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞</div>
          <div class="s-copy-wrap">
            <input class="s-copy-input" id="sp-ref-link" readonly value="–ó–∞–≥—Ä—É–∑–∫–∞...">
            <button class="s-copy-btn" onclick="copyRefLink()">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
          </div>
          <div style="margin-top:12px;font-size:0.72rem;color:var(--indigo);cursor:pointer;"
            onclick="showToast('–£—Å–ª–æ–≤–∏—è –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã')">–£—Å–ª–æ–≤–∏—è –ø–∞—Ä—Ç–Ω—ë—Ä—Å–∫–æ–π –ø—Ä–æ–≥—Ä–∞–º–º—ã ‚Üí</div>
        </div>
      </div>

      <!-- ‚îÄ‚îÄ –ü–∞—Ä—Ç–Ω—ë—Ä: –ö–ª–∏–µ–Ω—Ç—ã ‚îÄ‚îÄ -->
      <div class="s-section" id="ss-partner-clients">
        <div class="s-title">–ü—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã</div>
        <div class="s-subtitle">–°–ø–∏—Å–æ–∫ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ –≤–∞—à–µ–π —Å—Å—ã–ª–∫–µ</div>
        <div class="s-card" style="padding:0;overflow:hidden;">
          <table class="s-table">
            <thead>
              <tr>
                <th>Email</th>
                <th>–¢–∞—Ä–∏—Ñ</th>
                <th>–°—É–º–º–∞</th>
                <th>–î–∞—Ç–∞</th>
                <th>–°—Ç–∞—Ç—É—Å</th>
              </tr>
            </thead>
            <tbody id="sp-clients-body">
              <tr>
                <td colspan="5" style="text-align:center;color:var(--text-dim);padding:24px;">–ù–µ—Ç –ø—Ä–∏–≥–ª–∞—à—ë–Ω–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

    </div><!-- /settings-content -->
  </div><!-- /settings-overlay -->

  <!-- ‚ïê‚ïê AUTH OVERLAY ‚ïê‚ïê -->
  <div class="auth-overlay" id="auth-overlay">
    <div id="auth-spinner-wrap">
      <div class="auth-spinner"></div>
      <div id="auth-tg-status" style="margin-top:14px;font-size:0.8rem;color:rgba(255,255,255,0.5);text-align:center;">
      </div>
    </div>
    <!-- Telegram auth error (shown when auto-login fails inside Telegram) -->
    <div id="auth-tg-error" style="display:none;text-align:center;padding:32px 24px;">
      <div style="font-size:2.5rem;margin-bottom:16px;">‚ö†Ô∏è</div>
      <div style="font-size:1.1rem;font-weight:700;color:#fff;margin-bottom:8px;">–ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ–π—Ç–∏</div>
      <div style="font-size:0.82rem;color:rgba(255,255,255,0.55);margin-bottom:20px;line-height:1.5;">–û—Ç–∫—Ä–æ–π—Ç–µ –ø–∞–Ω–µ–ª—å –≤
        –±—Ä–∞—É–∑–µ—Ä–µ –∏<br>–≤–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ email –∏–ª–∏ Google</div>
      <div style="font-size:0.9rem;color:#6366f1;font-weight:600;letter-spacing:0.3px;">chatbot-acd16.web.app</div>
    </div>

    <!-- ‚ïê‚ïê LANDING PAGE (shown in browser only) ‚ïê‚ïê -->
    <div id="landing-page" style="display:none;">

      <!-- Hero -->
      <section class="lp-hero">
        <div class="lp-badge">üöÄ –°–æ–∑–¥–∞–π—Ç–µ AI-–±–æ—Ç–∞ –∑–∞ 5 –º–∏–Ω—É—Ç</div>
        <h1 class="lp-title">–£–º–Ω—ã–π AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç<br>–¥–ª—è –≤–∞—à–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞</h1>
        <p class="lp-sub">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ Telegram-–±–æ—Ç–∞ —Å –∏—Å–∫—É—Å—Å—Ç–≤–µ–Ω–Ω—ã–º –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç–æ–º. –û–Ω –æ—Ç–≤–µ—Ç–∏—Ç –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –∫–ª–∏–µ–Ω—Ç–æ–≤ 24/7,
          –∏—Å–ø–æ–ª—å–∑—É—è –≤–∞—à—É –±–∞–∑—É –∑–Ω–∞–Ω–∏–π.</p>
        <button class="lp-cta" onclick="document.getElementById('lp-auth').scrollIntoView({behavior:'smooth'})">
          –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ ‚Üí
        </button>
        <div class="lp-scroll-hint">
          <span>‚Üì</span>
          –£–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ
        </div>
      </section>

      <!-- Integrations -->
      <div class="lp-integrations lp-reveal">
        <div class="lp-int-item"><span class="lp-int-icon">üí¨</span> Telegram</div>
        <div class="lp-int-item"><span class="lp-int-icon">üü¢</span> OpenAI GPT</div>
        <div class="lp-int-item"><span class="lp-int-icon">üîµ</span> Google Gemini</div>
        <div class="lp-int-item"><span class="lp-int-icon">üü†</span> Anthropic Claude</div>
      </div>

      <!-- Features -->
      <section class="lp-section lp-reveal">
        <div class="lp-section-title">–í—Å—ë —á—Ç–æ –Ω—É–∂–Ω–æ –≤ –æ–¥–Ω–æ–π –ø–∞–Ω–µ–ª–∏</div>
        <div class="lp-section-sub">–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –±–æ—Ç–∞ –æ–¥–∏–Ω —Ä–∞–∑ ‚Äî –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç –∑–∞ –≤–∞—Å –∫—Ä—É–≥–ª–æ—Å—É—Ç–æ—á–Ω–æ</div>
        <div class="lp-features">
          <div class="lp-feat-card">
            <div class="lp-feat-icon">üìö</div>
            <div class="lp-feat-title">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</div>
            <div class="lp-feat-desc">–ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª—ã, —Ç–µ–∫—Å—Ç—ã –∏–ª–∏ YouTube –≤–∏–¥–µ–æ ‚Äî AI –≤—ã—É—á–∏—Ç –≤–∞—à—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –∏ –±—É–¥–µ—Ç
              –æ—Ç–≤–µ—á–∞—Ç—å —Ç–æ—á–Ω–æ</div>
          </div>
          <div class="lp-feat-card">
            <div class="lp-feat-icon">üåç</div>
            <div class="lp-feat-title">–ú—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å</div>
            <div class="lp-feat-desc">–ë–æ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —è–∑—ã–∫ –∫–ª–∏–µ–Ω—Ç–∞ –∏ –æ—Ç–≤–µ—á–∞–µ—Ç –Ω–∞ –Ω—ë–º ‚Äî —Ä—É—Å—Å–∫–∏–π, —É–∑–±–µ–∫—Å–∫–∏–π,
              –∞–Ω–≥–ª–∏–π—Å–∫–∏–π –∏ –¥—Ä—É–≥–∏–µ</div>
          </div>
          <div class="lp-feat-card">
            <div class="lp-feat-icon">üé§</div>
            <div class="lp-feat-title">–ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</div>
            <div class="lp-feat-desc">–ö–ª–∏–µ–Ω—Ç—ã –º–æ–≥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≥–æ–ª–æ—Å–æ–≤—ã–µ ‚Äî –±–æ—Ç —Ä–∞—Å–ø–æ–∑–Ω–∞—ë—Ç —Ä–µ—á—å —á–µ—Ä–µ–∑ Whisper AI –∏
              –æ—Ç–≤–µ—á–∞–µ—Ç —Ç–µ–∫—Å—Ç–æ–º</div>
          </div>
          <div class="lp-feat-card">
            <div class="lp-feat-icon">üìä</div>
            <div class="lp-feat-title">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ —á–∞—Ç—ã</div>
            <div class="lp-feat-desc">–í–∏–¥—å—Ç–µ –≤—Å–µ –¥–∏–∞–ª–æ–≥–∏, –Ω–µ–æ—Ç–≤–µ—á–µ–Ω–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã, –∫–æ–Ω–≤–µ—Ä—Å–∏—é –∏ –∑–∞–≥—Ä—É–∑–∫—É AI –≤ —Ä–µ–∞–ª—å–Ω–æ–º
              –≤—Ä–µ–º–µ–Ω–∏</div>
          </div>
        </div>
      </section>

      <!-- Demo Chat -->
      <section class="lp-section lp-reveal">
        <div class="lp-section-title">–ö–∞–∫ —ç—Ç–æ –≤—ã–≥–ª—è–¥–∏—Ç</div>
        <div class="lp-section-sub">–í–∞—à –±–æ—Ç –æ–±—â–∞–µ—Ç—Å—è –∫–∞–∫ –∂–∏–≤–æ–π –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç</div>
        <div class="lp-demo">
          <div class="lp-demo-header">
            <div class="lp-demo-av">ü§ñ</div>
            <div>AI –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç <span style="opacity:.6;font-weight:400;font-size:.75rem;">‚Ä¢ –≤ —Å–µ—Ç–∏</span></div>
          </div>
          <div class="lp-demo-msgs">
            <div class="lp-demo-msg user">–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –ö–∞–∫–∏–µ —É –≤–∞—Å —Ü–µ–Ω—ã?</div>
            <div class="lp-demo-msg bot">–ü—Ä–∏–≤–µ—Ç! üëã –£ –Ω–∞—Å –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ç–∞—Ä–∏—Ñ–æ–≤. Pro ‚Äî $16/–º–µ—Å (2000 AI-–∑–∞–ø—Ä–æ—Å–æ–≤),
              Premium ‚Äî $40/–º–µ—Å (20 000 –∑–∞–ø—Ä–æ—Å–æ–≤, –≤—Å–µ –º–æ–¥–µ–ª–∏). –•–æ—Ç–∏—Ç–µ —É–∑–Ω–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω–µ–µ?</div>
            <div class="lp-demo-msg user">–ê –º–æ–∂–Ω–æ –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –±–µ—Å–ø–ª–∞—Ç–Ω–æ?</div>
            <div class="lp-demo-msg bot">–ö–æ–Ω–µ—á–Ω–æ! –ü—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ 14 –¥–Ω–µ–π Pro-—Ç–∞—Ä–∏—Ñ–∞ –±–µ—Å–ø–ª–∞—Ç–Ω–æ. –ù–∏–∫–∞–∫–æ–π
              –ø—Ä–∏–≤—è–∑–∫–∏ –∫–∞—Ä—Ç—ã üéâ</div>
            <div class="lp-demo-typing">
              <div class="lp-demo-dot"></div>
              <div class="lp-demo-dot"></div>
              <div class="lp-demo-dot"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Stats -->
      <div class="lp-stats lp-reveal">
        <div class="lp-stat">
          <div class="lp-stat-val">150+</div>
          <div class="lp-stat-lbl">–ë–æ—Ç–æ–≤ —Å–æ–∑–¥–∞–Ω–æ</div>
        </div>
        <div class="lp-stat">
          <div class="lp-stat-val">50K+</div>
          <div class="lp-stat-lbl">–°–æ–æ–±—â–µ–Ω–∏–π –≤ –º–µ—Å—è—Ü</div>
        </div>
        <div class="lp-stat">
          <div class="lp-stat-val">3</div>
          <div class="lp-stat-lbl">AI –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞</div>
        </div>
        <div class="lp-stat">
          <div class="lp-stat-val">24/7</div>
          <div class="lp-stat-lbl">–†–∞–±–æ—Ç–∞–µ—Ç –±–µ–∑ –ø–µ—Ä–µ—Ä—ã–≤–æ–≤</div>
        </div>
      </div>

      <!-- Pricing -->
      <section class="lp-section lp-reveal">
        <div class="lp-section-title">–¢–∞—Ä–∏—Ñ—ã</div>
        <div class="lp-section-sub">14 –¥–Ω–µ–π –±–µ—Å–ø–ª–∞—Ç–Ω–æ –Ω–∞ –ª—é–±–æ–º —Ç–∞—Ä–∏—Ñ–µ. –ë–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫–∞—Ä—Ç—ã.</div>
        <div class="lp-pricing">
          <div class="lp-price-card featured">
            <div class="lp-price-head">
              <div class="lp-price-tag">–ü–æ–ø—É–ª—è—Ä–Ω—ã–π</div>
              <div class="lp-price-name">Pro</div>
              <div class="lp-price-amount">$16 <span class="lp-price-period">/–º–µ—Å</span></div>
            </div>
            <div class="lp-price-body">
              <div>ü§ñ 1 Telegram –±–æ—Ç</div>
              <div>‚ö° 2 000 AI-–∑–∞–ø—Ä–æ—Å–æ–≤/–º–µ—Å</div>
              <div>üìö 100 –∑–∞–ø–∏—Å–µ–π –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π</div>
              <div>üß† GPT / Gemini</div>
              <div>üé§ –ì–æ–ª–æ—Å–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è</div>
            </div>
            <button class="lp-price-cta"
              onclick="document.getElementById('lp-auth').scrollIntoView({behavior:'smooth'})">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å
              –±–µ—Å–ø–ª–∞—Ç–Ω–æ</button>
          </div>
          <div class="lp-price-card">
            <div class="lp-price-head">
              <div class="lp-price-tag">AI Boost</div>
              <div class="lp-price-name">Premium</div>
              <div class="lp-price-amount">$40 <span class="lp-price-period">/–º–µ—Å</span></div>
            </div>
            <div class="lp-price-body">
              <div>ü§ñ ‚àû –±–æ—Ç–æ–≤</div>
              <div>‚ö° 20 000 AI-–∑–∞–ø—Ä–æ—Å–æ–≤/–º–µ—Å</div>
              <div>üìö ‚àû –∑–∞–ø–∏—Å–µ–π –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π</div>
              <div>üß† –í—Å–µ –º–æ–¥–µ–ª–∏ (GPT-4o, Claude, Gemini)</div>
              <div>üé§ –ì–æ–ª–æ—Å–æ–≤—ã–µ + –º—É–ª—å—Ç–∏—è–∑—ã—á–Ω–æ—Å—Ç—å</div>
            </div>
            <button class="lp-price-cta"
              onclick="document.getElementById('lp-auth').scrollIntoView({behavior:'smooth'})">–ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å
              –±–µ—Å–ø–ª–∞—Ç–Ω–æ</button>
          </div>
        </div>
      </section>

      <!-- Auth Section -->
      <section class="lp-auth-section" id="lp-auth">
        <div class="auth-box" id="auth-box" style="display:none;">
          <div class="auth-logo">
            <div class="auth-logo-icon">ü§ñ</div>
            <span class="auth-logo-text">BotPanel</span>
          </div>
          <div class="auth-title">–ù–∞—á–Ω–∏—Ç–µ –±–µ—Å–ø–ª–∞—Ç–Ω–æ</div>
          <div class="auth-sub">14 –¥–Ω–µ–π Pro-—Ç–∞—Ä–∏—Ñ–∞. –ë–µ–∑ –ø—Ä–∏–≤—è–∑–∫–∏ –∫–∞—Ä—Ç—ã.</div>

          <div class="auth-tabs">
            <button class="auth-tab active" onclick="setAuthTab('login',this)">–í–æ–π—Ç–∏</button>
            <button class="auth-tab" onclick="setAuthTab('register',this)">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
          </div>

          <div class="auth-error" id="auth-error"></div>

          <button class="btn-google" onclick="signInGoogle()">
            <svg width="18" height="18" viewBox="0 0 24 24">
              <path fill="#4285F4"
                d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" />
              <path fill="#34A853"
                d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" />
              <path fill="#FBBC05"
                d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z" />
              <path fill="#EA4335"
                d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" />
            </svg>
            –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
          </button>

          <div class="auth-divider">
            <div class="auth-divider-line"></div>
            <span class="auth-divider-text">–∏–ª–∏ –ø–æ email</span>
            <div class="auth-divider-line"></div>
          </div>

          <label class="form-label">Email</label>
          <input class="form-input" id="auth-email" type="email" placeholder="your@email.com"
            onkeydown="if(event.key==='Enter')authSubmit()">
          <label class="form-label">–ü–∞—Ä–æ–ª—å</label>
          <input class="form-input" id="auth-password" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
            onkeydown="if(event.key==='Enter')authSubmit()">
          <div id="auth-name-wrap" style="display:none;">
            <label class="form-label">–ò–º—è</label>
            <input class="form-input" id="auth-name" placeholder="–í–∞—à–µ –∏–º—è"
              onkeydown="if(event.key==='Enter')authSubmit()">
          </div>

          <button class="btn-auth" id="auth-submit-btn" onclick="authSubmit()">–í–æ–π—Ç–∏</button>
        </div>
      </section>

      <!-- Footer -->
      <footer class="lp-footer">
        <div class="lp-footer-links">
          <a href="https://t.me/createbotaiagent" target="_blank">üí¨ Telegram –∫–∞–Ω–∞–ª</a>
          <a href="mailto:support@createbotaiagent.com">üìß –ü–æ–¥–¥–µ—Ä–∂–∫–∞</a>
          <a href="#"
            onclick="event.preventDefault();document.getElementById('lp-auth').scrollIntoView({behavior:'smooth'})">üöÄ
            –ù–∞—á–∞—Ç—å</a>
        </div>
        <div>¬© 2025 BotPanel ‚Äî createbotaiagent.com</div>
      </footer>

    </div><!-- /landing-page -->
  </div>

  <!-- ‚ïê‚ïê ADD BOT MODAL ‚ïê‚ïê -->
  <div class="modal-overlay" id="modal-add">
    <div class="modal">
      <div class="modal-title">–ü–æ–¥–∫–ª—é—á–∏—Ç—å –±–æ—Ç–∞</div>
      <div class="modal-sub">–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ Telegram –±–æ—Ç–∞. –¢–æ–∫–µ–Ω –º–æ–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —É <a href="https://t.me/BotFather"
          target="_blank" style="color:var(--indigo);">@BotFather</a></div>

      <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –±–æ—Ç–∞</label>
      <input class="form-input" id="bot-name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–æ–π –º–∞–≥–∞–∑–∏–Ω –±–æ—Ç">

      <label class="form-label">Telegram Bot API —Ç–æ–∫–µ–Ω</label>
      <div style="display:flex;gap:6px;align-items:center;">
        <input class="form-input" id="bot-token" placeholder="1234567890:AAF..." style="flex:1;margin-bottom:0;">
        <button class="btn-ghost" onclick="pasteToInput('bot-token')" title="–í—Å—Ç–∞–≤–∏—Ç—å"
          style="padding:8px 10px;font-size:0.85rem;margin-bottom:0;white-space:nowrap;">üìã</button>
      </div>

      <label class="form-label">Username (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
      <input class="form-input" id="bot-username" placeholder="@mybotname">

      <div class="modal-footer">
        <button class="btn-ghost" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn-modal-ok" id="add-bot-btn" onclick="addBot()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê FILE UPLOAD MODAL ‚ïê‚ïê -->
  <div class="modal-overlay" id="modal-file">
    <div class="modal" style="width:480px;">
      <div class="modal-title">–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã</div>
      <div class="modal-sub">PDF, DOCX, TXT, MD, CSV ¬∑ –ú–∞–∫—Å–∏–º—É–º 3 —Ñ–∞–π–ª–∞ –∑–∞ —Ä–∞–∑</div>
      <div class="drop-zone" id="drop-zone" onclick="document.getElementById('file-input').click()"
        ondragover="e=>e.preventDefault()" ondrop="handleFileDrop(event)">
        <div class="drop-zone-ico">üì§</div>
        <div class="drop-zone-text">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã —Å—é–¥–∞</div>
        <div class="drop-zone-sub">–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ñ–∞–π–ª–æ–≤</div>
      </div>
      <input type="file" id="file-input" multiple accept=".pdf,.docx,.txt,.md,.csv" style="display:none;"
        onchange="handleFileSelect(event)">
      <div class="file-list" id="file-list"></div>
      <div class="modal-footer">
        <button class="btn-ghost" onclick="closeFileModal()">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn-modal-ok" onclick="uploadFiles()">–î–æ–±–∞–≤–∏—Ç—å –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê BROADCAST MODAL ‚ïê‚ïê -->
  <div class="modal-overlay" id="modal-broadcast">
    <div class="modal">
      <div class="modal-title">üì£ –†–∞—Å—Å—ã–ª–∫–∞</div>
      <div class="modal-sub">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –±–æ—Ç–∞</div>
      <label class="form-label">–°–µ–≥–º–µ–Ω—Ç</label>
      <div style="display:flex;gap:8px;margin-bottom:14px;flex-wrap:wrap;">
        <label class="bc-seg-label"><input type="radio" name="bc-filter" value="all" checked
            onchange="updateBroadcastCount()"> –í—Å–µ (<span id="bc-cnt-all">0</span>)</label>
        <label class="bc-seg-label"><input type="radio" name="bc-filter" value="month"
            onchange="updateBroadcastCount()"> –ó–∞ 30 –¥–Ω–µ–π (<span id="bc-cnt-month">0</span>)</label>
        <label class="bc-seg-label"><input type="radio" name="bc-filter" value="week" onchange="updateBroadcastCount()">
          –ó–∞ 7 –¥–Ω–µ–π (<span id="bc-cnt-week">0</span>)</label>
      </div>
      <label class="form-label">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</label>
      <textarea class="form-input" id="bc-text" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Ä–∞—Å—Å—ã–ª–∫–∏..." rows="4"
        style="resize:vertical;"></textarea>
      <div id="bc-status" style="font-size:0.75rem;color:var(--text-sec);margin-top:8px;min-height:18px;"></div>
      <div class="modal-footer">
        <button class="btn-ghost" onclick="closeBroadcastModal()">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn-modal-ok" id="bc-send-btn" onclick="sendBroadcast()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê KB TEXT MODAL ‚ïê‚ïê -->
  <div class="modal-overlay" id="modal-kb">
    <div class="modal">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
        <div class="modal-title" id="kb-modal-title" style="margin:0;">–î–æ–±–∞–≤–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</div>
        <button class="info-btn" id="kb-modal-info-btn" onclick="showInfoPopover('topics')"
          title="–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?">‚ìò</button>
      </div>
      <div class="modal-sub">–ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –ò–ò-–∞–≥–µ–Ω—Ç–æ–º –ø—Ä–∏ –æ—Ç–≤–µ—Ç–∞—Ö</div>
      <label class="form-label">–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
      <input class="form-input" id="kb-title" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –û –∫–æ–º–ø–∞–Ω–∏–∏">
      <label class="form-label">–°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ</label>
      <textarea class="form-input" id="kb-content" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç..." rows="5"
        style="resize:vertical;"></textarea>
      <div class="modal-footer">
        <button class="btn-ghost" onclick="closeKbModal()">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn-modal-ok" onclick="saveKb()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>
  <!-- ‚ïê‚ïê TRANSCRIBE MODAL ‚ïê‚ïê -->
  <div class="modal-overlay" id="modal-edit-answer">
    <div class="modal" style="width:560px;">
      <div class="modal-title" id="ea-modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞</div>

      <div id="ea-qa-display" style="margin-bottom:16px;">
        <div style="display:flex;align-items:flex-start;gap:10px;margin-bottom:10px;">
          <span style="font-size:18px;">üë§</span>
          <div id="ea-question" style="font-size:0.85rem;color:var(--text-sec);line-height:1.5;"></div>
        </div>
        <div id="ea-current-wrap" style="display:flex;align-items:flex-start;gap:10px;">
          <span style="font-size:18px;">ü§ñ</span>
          <div id="ea-current-answer" style="font-size:0.85rem;color:var(--text);line-height:1.5;"></div>
        </div>
      </div>

      <div id="ea-tabs" style="display:flex;gap:4px;margin-bottom:12px;">
        <button class="tab-btn active" id="ea-tab-replace" onclick="switchEaTab('replace')">–ó–∞–º–µ–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
        <button class="tab-btn" id="ea-tab-append" onclick="switchEaTab('append')">–î–æ–ø–æ–ª–Ω–∏—Ç—å –æ—Ç–≤–µ—Ç</button>
      </div>

      <div id="ea-hint"
        style="background:var(--surface2);border-radius:10px;padding:10px 14px;margin-bottom:12px;font-size:0.78rem;color:var(--text-sec);display:flex;align-items:center;gap:8px;">
        <span style="font-size:16px;">‚ÑπÔ∏è</span>
        <span id="ea-hint-text">–ó–∞–º–µ–Ω–∞ –æ—Ç–≤–µ—Ç–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä—É—é –ò–ò-–∞–≥–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ—Ç–≤–µ—á–∞—è –Ω–∞
          –≤–æ–ø—Ä–æ—Å</span>
      </div>

      <textarea class="form-input" id="ea-textarea" placeholder="–ù–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å" rows="5"
        style="resize:vertical;margin-bottom:0;"></textarea>

      <div style="display:flex;align-items:center;justify-content:space-between;margin-top:8px;margin-bottom:8px;">
        <button class="btn-secondary" id="ea-ai-btn" onclick="generateAIAnswer()"
          style="font-size:0.72rem;padding:5px 14px;gap:6px;display:flex;align-items:center;">
          ü§ñ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å AI
        </button>
        <button class="link-btn" id="ea-insert-btn" onclick="insertCurrentAnswer()"
          style="font-size:0.72rem;color:var(--indigo);">–í—Å—Ç–∞–≤–∏—Ç—å —Ç–µ–∫—É—â–∏–π –æ—Ç–≤–µ—Ç</button>
      </div>

      <div id="ea-confidence" style="display:none;font-size:0.7rem;color:var(--text-sec);margin-bottom:8px;">
        –£–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç—å: <span id="ea-confidence-val"></span>
      </div>

      <div id="ea-admin-note"
        style="display:none;font-size:0.72rem;color:var(--yellow);background:var(--surface2);border-radius:8px;padding:8px 12px;margin-bottom:8px;">
      </div>

      <div class="modal-footer">
        <button class="btn-ghost" onclick="closeEditAnswer()">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn-modal-ok" id="ea-save-btn" onclick="saveEditAnswer()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê TRANSCRIBE MODAL ‚ïê‚ïê -->
  <div class="modal-overlay" id="modal-transcribe">
    <div class="modal" style="width:520px;">
      <div class="modal-title">üé¨ –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä–æ–≤–∞—Ç—å YouTube</div>
      <div class="modal-sub">–í—Å—Ç–∞–≤—å—Ç–µ —Å—Å—ã–ª–∫—É –Ω–∞ YouTube –≤–∏–¥–µ–æ ‚Äî –ø–æ–ª—É—á–∏—Ç–µ –ø–æ–ª–Ω—É—é —Ç–µ–∫—Å—Ç–æ–≤—É—é —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫—É</div>

      <!-- Input state -->
      <div id="tr-input-wrap">
        <label class="form-label">–°—Å—ã–ª–∫–∞ –Ω–∞ YouTube –≤–∏–¥–µ–æ</label>
        <input class="form-input" id="tr-url" placeholder="https://www.youtube.com/watch?v=..."
          style="font-size:0.82rem;">
        <div style="font-size:0.72rem;color:var(--text-dim);margin-top:6px;">–†–∞–±–æ—Ç–∞–µ—Ç —Å –≤–∏–¥–µ–æ —É –∫–æ—Ç–æ—Ä—ã—Ö –µ—Å—Ç—å —Å—É–±—Ç–∏—Ç—Ä—ã
          (–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∏–ª–∏ –≤—Ä—É—á–Ω—É—é –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ)</div>
        <div id="tr-error"
          style="display:none;color:#ef4444;font-size:0.75rem;margin-top:8px;padding:8px 12px;background:#fef2f2;border-radius:8px;border:1px solid #fecaca;">
        </div>
      </div>

      <!-- Processing state -->
      <div id="tr-loading-wrap" style="display:none;text-align:center;padding:20px 0;">
        <div style="font-size:28px;margin-bottom:10px;">‚è≥</div>
        <div style="font-size:0.85rem;font-weight:600;">–ü–æ–ª—É—á–∞—é —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—é...</div>
        <div style="font-size:0.72rem;color:var(--text-dim);margin-top:4px;">–≠—Ç–æ –∑–∞–π–º—ë—Ç –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–µ–∫—É–Ω–¥</div>
      </div>

      <!-- Result state -->
      <div id="tr-result-wrap" style="display:none;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
          <div>
            <div id="tr-title" style="font-size:0.85rem;font-weight:700;"></div>
            <div id="tr-chars" style="font-size:0.7rem;color:var(--text-dim);margin-top:2px;"></div>
          </div>
          <span
            style="background:#dcfce7;color:#16a34a;font-size:0.68rem;font-weight:700;padding:3px 10px;border-radius:20px;">‚úì
            –ì–æ—Ç–æ–≤–æ</span>
        </div>
        <div id="tr-preview"
          style="background:var(--bg);border:1px solid var(--border);border-radius:10px;padding:12px;font-size:0.75rem;color:var(--text-sec);line-height:1.6;max-height:180px;overflow-y:auto;white-space:pre-wrap;">
        </div>
        <div style="font-size:0.72rem;color:var(--text-dim);margin-top:6px;">–ü–æ–∫–∞–∑–∞–Ω –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä. –ü–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω
          –≤ –±–∞–∑–µ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤.</div>
      </div>

      <div class="modal-footer" id="tr-footer-input">
        <button class="btn-ghost" onclick="closeTranscribeModal()">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn-modal-ok" onclick="runTranscribe()">üé¨ –¢—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä–æ–≤–∞—Ç—å</button>
      </div>
      <div class="modal-footer" id="tr-footer-result" style="display:none;">
        <button class="btn-ghost" onclick="closeTranscribeModal()">–ó–∞–∫—Ä—ã—Ç—å</button>
        <button class="btn-modal-ok" onclick="addTranscriptToKb()">‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê CHANGE PLAN MODAL ‚ïê‚ïê -->
  <div class="modal-overlay" id="modal-change-plan" style="z-index:10010;"
    onclick="if(event.target===this)closeBillingModal('modal-change-plan')">
    <div class="modal" style="width:680px;max-width:96vw;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
        <div class="modal-title" style="margin-bottom:0;">–í—ã–±—Ä–∞—Ç—å —Ç–∞—Ä–∏—Ñ</div>
        <button class="btn-ghost" style="padding:4px 10px;font-size:1rem;"
          onclick="closeBillingModal('modal-change-plan')">‚úï</button>
      </div>
      <div class="modal-sub">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–¥—Ö–æ–¥—è—â–∏–π –ø–ª–∞–Ω. –î–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –º—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏.</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:20px;">
        <!-- Pro -->
        <div style="border-radius:12px;overflow:hidden;border:2px solid var(--primary-brd);">
          <div style="background:linear-gradient(135deg,#4f2d7f,#3b1f6e);padding:18px;position:relative;">
            <div
              style="position:absolute;top:12px;right:12px;background:#a3e635;color:#1a1a2e;font-size:0.58rem;font-weight:700;padding:2px 8px;border-radius:20px;">
              –ü–æ–ø—É–ª—è—Ä–Ω—ã–π</div>
            <div style="font-size:1rem;font-weight:800;color:#fff;margin-bottom:2px;">Pro</div>
            <div style="font-size:1.6rem;font-weight:800;color:#fff;line-height:1.1;" id="cp-pro-price">$16 <span
                style="font-size:0.75rem;font-weight:400;opacity:0.7;">/–º–µ—Å</span></div>
            <div style="font-size:0.62rem;color:rgba(255,255,255,0.5);margin-top:2px;" id="cp-pro-note">–ø—Ä–∏ –æ–ø–ª–∞—Ç–µ –∑–∞
              –≥–æ–¥</div>
          </div>
          <div
            style="background:var(--surface2);border-top:1px solid var(--border);padding:14px;font-size:0.75rem;color:var(--text-sec);display:flex;flex-direction:column;gap:6px;">
            <div>ü§ñ 1 Telegram –±–æ—Ç</div>
            <div>‚ö° 2 000 AI-–∑–∞–ø—Ä–æ—Å–æ–≤/–º–µ—Å</div>
            <div>üìö 100 –∑–∞–ø–∏—Å–µ–π –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π</div>
            <div>üß† GPT / Gemini</div>
          </div>
          <div style="padding:12px;background:var(--surface2);border-top:1px solid var(--border);">
            <button id="cp-pro-btn"
              style="width:100%;padding:9px;border-radius:8px;border:none;font-size:0.8rem;font-weight:700;cursor:pointer;"
              onclick="selectPlan('pro')">–í—ã–±—Ä–∞—Ç—å Pro</button>
          </div>
        </div>
        <!-- Premium -->
        <div style="border-radius:12px;overflow:hidden;border:1px solid var(--border);">
          <div style="background:linear-gradient(135deg,#1a1a2e,#16213e);padding:18px;position:relative;">
            <div
              style="position:absolute;top:12px;right:12px;background:#3b82f6;color:#fff;font-size:0.58rem;font-weight:700;padding:2px 8px;border-radius:20px;">
              AI Boost</div>
            <div style="font-size:1rem;font-weight:800;color:#fff;margin-bottom:2px;">Premium</div>
            <div style="font-size:1.6rem;font-weight:800;color:#fff;line-height:1.1;" id="cp-prem-price">$40 <span
                style="font-size:0.75rem;font-weight:400;opacity:0.7;">/–º–µ—Å</span></div>
            <div style="font-size:0.62rem;color:rgba(255,255,255,0.5);margin-top:2px;" id="cp-prem-note">–ø—Ä–∏ –æ–ø–ª–∞—Ç–µ –∑–∞
              –≥–æ–¥</div>
          </div>
          <div
            style="background:var(--surface2);border-top:1px solid var(--border);padding:14px;font-size:0.75rem;color:var(--text-sec);display:flex;flex-direction:column;gap:6px;">
            <div>ü§ñ ‚àû –±–æ—Ç–æ–≤</div>
            <div>‚ö° 20 000 AI-–∑–∞–ø—Ä–æ—Å–æ–≤/–º–µ—Å</div>
            <div>üìö ‚àû –∑–∞–ø–∏—Å–µ–π –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π</div>
            <div>üß† –í—Å–µ –º–æ–¥–µ–ª–∏ (GPT-4o, Claude, Gemini)</div>
          </div>
          <div style="padding:12px;background:var(--surface2);border-top:1px solid var(--border);">
            <button id="cp-prem-btn"
              style="width:100%;padding:9px;border-radius:8px;border:none;font-size:0.8rem;font-weight:700;cursor:pointer;"
              onclick="selectPlan('premium')">–í—ã–±—Ä–∞—Ç—å Premium</button>
          </div>
        </div>
      </div>
      <div style="text-align:center;font-size:0.72rem;color:var(--text-dim);">–ü–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –º—ã —Å–≤—è–∂–µ–º—Å—è —Å –≤–∞–º–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ
        10 –º–∏–Ω—É—Ç</div>
    </div>
  </div>

  <!-- ‚ïê‚ïê BUY REQUESTS MODAL ‚ïê‚ïê -->
  <div class="modal-overlay" id="modal-buy-requests" style="z-index:10010;"
    onclick="if(event.target===this)closeBillingModal('modal-buy-requests')">
    <div class="modal" style="width:460px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:6px;">
        <div class="modal-title" style="margin-bottom:0;">–ö—É–ø–∏—Ç—å AI-–∑–∞–ø—Ä–æ—Å—ã</div>
        <button class="btn-ghost" style="padding:4px 10px;font-size:1rem;"
          onclick="closeBillingModal('modal-buy-requests')">‚úï</button>
      </div>
      <div class="modal-sub">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –∫ –≤–∞—à–µ–º—É –º–µ—Å—è—á–Ω–æ–º—É –ª–∏–º–∏—Ç—É</div>
      <div style="display:flex;flex-direction:column;gap:10px;margin-bottom:20px;" id="buy-req-packs">
        <!-- Filled by JS -->
      </div>
      <div style="text-align:center;font-size:0.72rem;color:var(--text-dim);">–ü–æ—Å–ª–µ –ø–æ–∫—É–ø–∫–∏ –∑–∞–ø—Ä–æ—Å—ã –∞–∫—Ç–∏–≤–∏—Ä—É—é—Ç—Å—è –≤
        —Ç–µ—á–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –º–∏–Ω—É—Ç</div>
    </div>
  </div>

  <!-- ‚ïê‚ïê PHONE VERIFY MODAL (For Telegram Users) ‚ïê‚ïê -->
  <div class="modal-overlay" id="modal-phone-verify" style="z-index:10010;background:rgba(0,0,0,0.85);">
    <div class="modal" style="width:400px;text-align:center;">
      <div style="font-size:3rem;margin-bottom:10px;">üì±</div>
      <div class="modal-title">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞</div>
      <div class="modal-sub" style="margin-bottom:20px;">
        –î–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∞–∫–∫–∞—É–Ω—Ç–∞ –∏ –ø–æ–ª—É—á–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, —É–∫–∞–∂–∏—Ç–µ –≤–∞—à –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.
      </div>
      <input type="tel" id="tg-phone-input" class="form-input" placeholder="+_ (___) ___-__-__"
        style="font-size:1.1rem;text-align:center;letter-spacing:1px;margin-bottom:20px;">
      <button class="btn-primary" id="tg-phone-save-btn" style="width:100%;"
        onclick="saveTgPhone()">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
    </div>
  </div>

  <!-- ‚ïê‚ïê ONBOARDING WIZARD ‚ïê‚ïê -->
  <!-- ‚ïê‚ïê CREATE WIZARD MODAL ‚ïê‚ïê -->
  <div class="modal-overlay" id="modal-create-wizard" style="z-index:10010;background:rgba(0,0,0,0.7);"
    onclick="if(event.target===this)closeCreateWizard()">
    <div class="modal" style="width:540px;max-width:96vw;padding:0;overflow:hidden;">
      <!-- Progress bar -->
      <div style="height:4px;background:var(--border);">
        <div id="wz-progress"
          style="height:100%;background:linear-gradient(90deg,var(--primary),#8b5cf6);transition:width 0.4s;width:25%;">
        </div>
      </div>
      <div style="padding:28px;">
        <!-- Step dots -->
        <div style="display:flex;gap:6px;margin-bottom:22px;">
          <div id="wz-dot-1"
            style="height:6px;flex:1;border-radius:3px;background:var(--primary);transition:background 0.3s;"></div>
          <div id="wz-dot-2"
            style="height:6px;flex:1;border-radius:3px;background:var(--border);transition:background 0.3s;"></div>
          <div id="wz-dot-3"
            style="height:6px;flex:1;border-radius:3px;background:var(--border);transition:background 0.3s;"></div>
          <div id="wz-dot-4"
            style="height:6px;flex:1;border-radius:3px;background:var(--border);transition:background 0.3s;"></div>
        </div>

        <!-- Step 1: Connect bot -->
        <div id="wz-step-1">
          <div style="font-size:32px;margin-bottom:10px;">ü§ñ</div>
          <div class="modal-title" style="margin-bottom:6px;">–®–∞–≥ 1: –ü–æ–¥–∫–ª—é—á–∏—Ç–µ Telegram –±–æ—Ç–∞</div>
          <div class="modal-sub" style="margin-bottom:18px;">–ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω —É <a href="https://t.me/BotFather"
              target="_blank" style="color:var(--indigo);">@BotFather</a>. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤–æ–≥–æ –±–æ—Ç–∞ –∫–æ–º–∞–Ω–¥–æ–π <b>/newbot</b>.
          </div>
          <div style="display:flex;flex-direction:column;gap:10px;">
            <div>
              <div class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –±–æ—Ç–∞ (–¥–ª—è –≤–∞—Å)</div>
              <input class="form-input" id="wz-name" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–æ–π –º–∞–≥–∞–∑–∏–Ω –±–æ—Ç" style="margin-bottom:0;">
            </div>
            <div>
              <div class="form-label">Telegram Bot API —Ç–æ–∫–µ–Ω</div>
              <div style="display:flex;gap:6px;align-items:center;">
                <input class="form-input" id="wz-token" placeholder="123456789:ABCdefGHIjklMNOpqrsTUVwxyz"
                  style="margin-bottom:0;flex:1;">
                <button class="btn-ghost" onclick="pasteToInput('wz-token')" title="–í—Å—Ç–∞–≤–∏—Ç—å"
                  style="padding:8px 10px;font-size:0.85rem;margin-bottom:0;white-space:nowrap;">üìã</button>
              </div>
            </div>
            <div>
              <div class="form-label">Username –±–æ—Ç–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</div>
              <input class="form-input" id="wz-username" placeholder="@mybot" style="margin-bottom:0;">
            </div>
          </div>
          <div id="wz-error" style="display:none;color:var(--red);font-size:0.78rem;margin-top:8px;"></div>
          <div style="display:flex;gap:8px;margin-top:18px;">
            <button class="btn-ghost" style="flex:1;" onclick="closeCreateWizard()">–ü–æ–∑–∂–µ</button>
            <button class="btn-primary" style="flex:2;" id="wz-step1-btn" onclick="wzStep1Next()">–î–∞–ª–µ–µ ‚Üí</button>
          </div>
        </div>

        <!-- Step 2: Communication style -->
        <div id="wz-step-2" style="display:none;">
          <div style="font-size:32px;margin-bottom:10px;">‚ò∞</div>
          <div class="modal-title" style="margin-bottom:6px;">–®–∞–≥ 2: –°—Ç–∏–ª—å –æ–±—â–µ–Ω–∏—è</div>
          <div class="modal-sub" style="margin-bottom:4px;">–í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω –¥–ª—è –≤–∞—à–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞. –í—ã —Å–º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å
            –ø—Ä–∞–≤–∏–ª–∞ –ø–æ–∑–∂–µ.</div>
          <div class="wz-tpl-grid">
            <div class="wz-tpl-card" id="wz-tpl-shop" onclick="wzSelectTemplate('shop')">
              <div class="wz-tpl-ico">üõçÔ∏è</div>
              <div class="wz-tpl-name">–ú–∞–≥–∞–∑–∏–Ω</div>
              <div class="wz-tpl-sub">–¢–æ–≤–∞—Ä—ã, —Ü–µ–Ω—ã, –¥–æ—Å—Ç–∞–≤–∫–∞</div>
            </div>
            <div class="wz-tpl-card" id="wz-tpl-restaurant" onclick="wzSelectTemplate('restaurant')">
              <div class="wz-tpl-ico">üçï</div>
              <div class="wz-tpl-name">–†–µ—Å—Ç–æ—Ä–∞–Ω</div>
              <div class="wz-tpl-sub">–ú–µ–Ω—é, –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
            </div>
            <div class="wz-tpl-card" id="wz-tpl-corporate" onclick="wzSelectTemplate('corporate')">
              <div class="wz-tpl-ico">üíº</div>
              <div class="wz-tpl-name">–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π</div>
              <div class="wz-tpl-sub">–£—Å–ª—É–≥–∏, –ø–∞—Ä—Ç–Ω—ë—Ä—Å—Ç–≤–æ</div>
            </div>
            <div class="wz-tpl-card" id="wz-tpl-medical" onclick="wzSelectTemplate('medical')">
              <div class="wz-tpl-ico">üè•</div>
              <div class="wz-tpl-name">–ú–µ–¥–∏—Ü–∏–Ω–∞</div>
              <div class="wz-tpl-sub">–ó–∞–ø–∏—Å—å, —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ</div>
            </div>
            <div class="wz-tpl-card" id="wz-tpl-education" onclick="wzSelectTemplate('education')">
              <div class="wz-tpl-ico">üéì</div>
              <div class="wz-tpl-name">–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ</div>
              <div class="wz-tpl-sub">–ö—É—Ä—Å—ã, –ø—Ä–æ–≥—Ä–∞–º–º—ã</div>
            </div>
            <div class="wz-tpl-card" id="wz-tpl-custom" onclick="wzSelectTemplate('custom')">
              <div class="wz-tpl-ico">‚úèÔ∏è</div>
              <div class="wz-tpl-name">–°–≤–æ–π —à–∞–±–ª–æ–Ω</div>
              <div class="wz-tpl-sub">–ù–∞–ø–∏—à—É —Å–∞–º –ø–æ–∑–∂–µ</div>
            </div>
          </div>
          <div style="display:flex;gap:8px;margin-top:6px;">
            <button class="btn-ghost" style="flex:1;" onclick="wzGoStep(1)">‚Üê –ù–∞–∑–∞–¥</button>
            <button class="btn-primary" style="flex:2;" onclick="wzStep2Next()">–î–∞–ª–µ–µ ‚Üí</button>
          </div>
        </div>

        <!-- Step 3: Knowledge base -->
        <div id="wz-step-3" style="display:none;">
          <div style="font-size:32px;margin-bottom:10px;">üìö</div>
          <div class="modal-title" style="margin-bottom:6px;">–®–∞–≥ 3: –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</div>
          <div class="modal-sub" style="margin-bottom:18px;">–î–æ–±–∞–≤—å—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–∞—à–µ–º –±–∏–∑–Ω–µ—Å–µ ‚Äî –±–æ—Ç –±—É–¥–µ—Ç –æ—Ç–≤–µ—á–∞—Ç—å
            —Ç–æ—á–Ω–µ–µ. –ú–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –∏ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–∑–∂–µ.</div>
          <div style="display:flex;flex-direction:column;gap:8px;">
            <button class="btn-secondary" style="text-align:left;padding:14px 16px;"
              onclick="closeCreateWizard();goAgentScreen('topics')">
              <div style="font-weight:700;margin-bottom:2px;">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª—ã</div>
              <div style="font-size:0.72rem;color:var(--text-dim);">PDF, DOCX, TXT, CSV</div>
            </button>
            <button class="btn-secondary" style="text-align:left;padding:14px 16px;"
              onclick="closeCreateWizard();goAgentScreen('topics')">
              <div style="font-weight:700;margin-bottom:2px;">‚úèÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å —Ç–µ–∫—Å—Ç</div>
              <div style="font-size:0.72rem;color:var(--text-dim);">–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ —Å–≤–æ–∏–º–∏ —Å–ª–æ–≤–∞–º–∏</div>
            </button>
          </div>
          <div style="display:flex;gap:8px;margin-top:14px;">
            <button class="btn-ghost" style="flex:1;" onclick="wzGoStep(4)">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å ‚Üí</button>
          </div>
        </div>

        <!-- Step 4: Done -->
        <div id="wz-step-4" style="display:none;">
          <div style="font-size:48px;margin-bottom:12px;text-align:center;">üéâ</div>
          <div class="modal-title" style="margin-bottom:8px;text-align:center;">–ê–≥–µ–Ω—Ç —Å–æ–∑–¥–∞–Ω!</div>
          <div class="modal-sub" style="text-align:center;margin-bottom:20px;">–ë–æ—Ç –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ. –ó–∞–ø—É—Å—Ç–∏—Ç–µ –µ–≥–æ –∏
            –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å.</div>
          <div style="display:flex;flex-direction:column;gap:8px;">
            <button class="btn-primary" style="width:100%;padding:12px;"
              onclick="closeCreateWizard();goAgentScreen('launch')">
              üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –±–æ—Ç–∞
            </button>
            <button class="btn-secondary" style="width:100%;padding:12px;"
              onclick="closeCreateWizard();goAgentScreen('testing')">
              ‚ñ∑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê LEGACY ONBOARDING COMPAT (hidden) ‚ïê‚ïê -->
  <div id="modal-onboarding" style="display:none;"></div>

  <!-- ‚ïê‚ïê CANCEL SUBSCRIPTION MODAL ‚ïê‚ïê -->
  <div class="modal-overlay" id="modal-cancel-sub" style="z-index:10010;"
    onclick="if(event.target===this)closeBillingModal('modal-cancel-sub')">
    <div class="modal" style="width:420px;">
      <div style="text-align:center;padding:10px 0 4px;">
        <div style="font-size:40px;margin-bottom:10px;">üòî</div>
        <div class="modal-title">–û—Ç–º–µ–Ω–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É?</div>
        <div class="modal-sub">–ü–æ—Å–ª–µ –æ—Ç–º–µ–Ω—ã –≤—ã –ø–æ—Ç–µ—Ä—è–µ—Ç–µ –¥–æ—Å—Ç—É–ø –∫ Pro-—Ñ—É–Ω–∫—Ü–∏—è–º –ø–æ –∏—Å—Ç–µ—á–µ–Ω–∏–∏ —Ç–µ–∫—É—â–µ–≥–æ –ø–µ—Ä–∏–æ–¥–∞. –î–ª—è –æ—Ç–º–µ–Ω—ã
          –Ω–∞–ø–∏—à–∏—Ç–µ –Ω–∞–º ‚Äî –º—ã –ø–æ–º–æ–∂–µ–º.</div>
      </div>
      <div style="display:flex;gap:8px;">
        <button class="btn-ghost" style="flex:1;" onclick="closeBillingModal('modal-cancel-sub')">–û—Å—Ç–∞–≤–∏—Ç—å
          –ø–æ–¥–ø–∏—Å–∫—É</button>
        <button class="s-btn s-btn-danger"
          style="flex:1;border:none;border-radius:8px;padding:9px 16px;font-size:0.8rem;font-weight:700;cursor:pointer;"
          onclick="confirmCancelSub()">–ù–∞–ø–∏—Å–∞—Ç—å –≤ –ø–æ–¥–¥–µ—Ä–∂–∫—É</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê CONFIRM MODAL ‚ïê‚ïê -->
  <div class="modal-overlay" id="modal-confirm" style="z-index:10020;background:rgba(0,0,0,0.6);"
    onclick="if(event.target===this)_confirmCancel()">
    <div class="modal" style="width:400px;max-width:94vw;">
      <div id="modal-confirm-icon" style="font-size:32px;margin-bottom:10px;text-align:center;"></div>
      <div class="modal-title" id="modal-confirm-title" style="text-align:center;"></div>
      <div class="modal-sub" id="modal-confirm-desc"
        style="text-align:center;margin-top:6px;margin-bottom:20px;line-height:1.55;"></div>
      <div style="display:flex;gap:8px;">
        <button class="btn-ghost" style="flex:1;" onclick="_confirmCancel()"
          id="modal-confirm-cancel-btn">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn-primary" style="flex:1;" onclick="_confirmOk()"
          id="modal-confirm-ok-btn">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- ‚ïê‚ïê TOAST ‚ïê‚ïê -->
  <div class="toast" id="toast"></div>

  <script>
    /* ‚ïê‚ïê FIREBASE ‚ïê‚ïê */
    const firebaseConfig = {
      apiKey: "AIzaSyBnQBiGjMGbIkeM31rZnxisiZUr-AsAqSU",
      authDomain: "chatbot-acd16.firebaseapp.com",
      projectId: "chatbot-acd16",
      storageBucket: "chatbot-acd16.firebasestorage.app",
      messagingSenderId: "236507228929",
      appId: "1:236507228929:web:4124a3c257e4edb3e4c900",
      measurementId: "G-EBTMN07KYF"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let currentUser = null;

    /* ‚ïê‚ïê STATE ‚ïê‚ïê */
    const STATE = window.AppState.createInitialState();

    /* ‚îÄ‚îÄ Firestore helpers ‚îÄ‚îÄ */
    function col(name) {
      return db.collection('users').doc(currentUser.uid).collection(name);
    }

    async function fsAdd(colName, data) {
      return col(colName).add({ ...data, _ts: firebase.firestore.FieldValue.serverTimestamp() });
    }

    async function fsDel(colName, id) {
      await col(colName).doc(id).delete();
    }

    async function fsUpdate(colName, id, data) {
      await col(colName).doc(id).update(data);
    }

    function listen(colName, cb) {
      const unsub = col(colName).orderBy('_ts', 'asc').onSnapshot(snap => {
        cb(snap.docs.map(d => ({ id: d.id, ...d.data() })));
      });
      STATE.unsubs.push(unsub);
    }

    function listenChats(cb) {
      const unsub = db.collection('users').doc(currentUser.uid).collection('chats')
        .onSnapshot(snap => {
          cb(snap.docs.map(d => ({ id: d.id, ...d.data() })));
        }, () => { });
      STATE.unsubs.push(unsub);
    }

    function stopListeners() {
      STATE.unsubs.forEach(u => u());
      STATE.unsubs = [];
    }

    function save() {
      localStorage.setItem('theme', STATE.theme);
    }

    /* ‚ïê‚ïê ONBOARDING GUIDE ‚ïê‚ïê */
    function dismissGuide(id) {
      const el = document.getElementById('guide-' + id);
      if (el) el.style.display = 'none';
      const dismissed = JSON.parse(localStorage.getItem('guideDismissed') || '{}');
      dismissed[id] = true;
      localStorage.setItem('guideDismissed', JSON.stringify(dismissed));
    }
    function initGuides() {
      const dismissed = JSON.parse(localStorage.getItem('guideDismissed') || '{}');
      Object.keys(dismissed).forEach(id => {
        const el = document.getElementById('guide-' + id);
        if (el) el.style.display = 'none';
      });
    }
    initGuides();

    /* ‚ïê‚ïê THEME ‚ïê‚ïê */
    function applyTheme() {
      document.documentElement.setAttribute('data-theme', STATE.theme);
      document.getElementById('theme-icon').textContent = STATE.theme === 'dark' ? 'üåô' : '‚òÄÔ∏è';
    }
    function toggleTheme() {
      STATE.theme = STATE.theme === 'dark' ? 'light' : 'dark';
      applyTheme(); save();
    }

    /* ‚ïê‚ïê TABS (unified ‚Äî single sidebar) ‚ïê‚ïê */
    function switchTab(tab) {
      // Unified layout: no separate tabs. Always in agent mode.
      STATE.currentTab = 'agent';
      if (tab === 'auto') goAgentScreen('automations');
      else goAgentScreen(STATE.currentAgentScreen || 'analytics');
    }

    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      const el = document.getElementById('screen-' + id);
      if (el) el.classList.add('active');
    }

    function goAgentScreen(id) {
      // Redirect aliases
      if (id === 'knowledge') id = 'topics';
      if (id === 'ai-usage') id = 'analytics'; // merged into analytics
      let kbTabTarget = null;
      if (id === 'unanswered') { id = 'topics'; kbTabTarget = 'unanswered'; }

      STATE.currentAgentScreen = id;
      STATE.currentTab = 'agent';
      localStorage.setItem('lastScreen', 'agent:' + id);
      showScreen(id);

      // Close mobile sidebar on navigation
      closeMobileSidebar();

      // Topbar: home/bot-overview hide switcher; automations shows count; others show bot-switcher
      if (id === 'home') {
        document.getElementById('topbar-title').style.display = '';
        document.getElementById('topbar-title').textContent = 'BotPanel';
        document.getElementById('topbar-count').textContent = '';
        document.getElementById('bot-switcher').style.display = 'none';
      } else if (id === 'design-v3') {
        document.getElementById('topbar-title').style.display = '';
        document.getElementById('topbar-title').textContent = I18n.t('newDesignV3');
        document.getElementById('topbar-count').textContent = '';
        document.getElementById('bot-switcher').style.display = 'none';
      } else if (id === 'bot-overview') {
        document.getElementById('topbar-title').style.display = 'none';
        document.getElementById('topbar-count').textContent = '';
        renderBotSwitcher();
        renderBotOverview();
        // Restore last active step tab
        const savedStep = localStorage.getItem('activeStep');
        if (savedStep && STEP_SCREENS.includes(savedStep)) {
          setTimeout(() => goStep(savedStep), 50);
        }
      } else if (id === 'automations') {
        document.getElementById('topbar-title').style.display = '';
        document.getElementById('topbar-title').textContent = I18n.t('botsTitle');
        document.getElementById('topbar-count').textContent = STATE.bots.length > 0 ? STATE.bots.length : '';
        document.getElementById('bot-switcher').style.display = 'none';
      } else {
        document.getElementById('topbar-title').style.display = 'none';
        document.getElementById('topbar-count').textContent = '';
        renderBotSwitcher();
      }

      // Highlight active nav items
      document.querySelectorAll('#nav-agent .nav-item').forEach(n => n.classList.remove('active'));
      document.getElementById('nav-overview')?.classList.toggle('active', id === 'bot-overview');
      document.getElementById('nav-testing-btn')?.classList.toggle('active', id === 'testing');
      document.getElementById('kb-nav-hd')?.classList.toggle('active', id === 'topics');
      document.getElementById('nav-analytics')?.classList.toggle('active', id === 'analytics');
      document.getElementById('nav-automations')?.classList.toggle('active', id === 'automations');
      document.getElementById('nav-designv3')?.classList.toggle('active', id === 'design-v3');

      // Open advanced nav when navigating to advanced screens
      const advancedScreens = ['analytics', 'chats', 'topics', 'automations', 'ai-settings', 'launch', 'rules', 'autoreplies', 'design-v3'];
      if (advancedScreens.includes(id)) {
        toggleAdvancedNav(true);
      }

      // Switch internal KB tab if needed
      if (id === 'topics') switchKbTab(kbTabTarget || STATE.kbTab || 'topics');

      if (id === 'rules') renderRulesScreen();
      if (id === 'analytics') { renderAnalytics(); renderAiUsage(); }
      if (id === 'ai-settings') { PROVIDERS.forEach(p => applyProviderUI(p)); }
      if (id === 'launch') renderLaunchScreen();
    }

    /* ‚ïê‚ïê‚ïê STEP NAVIGATION (SPA) ‚ïê‚ïê‚ïê */
    const STEP_SCREENS = ['rules', 'topics', 'testing', 'launch', 'autoreplies', 'flows', 'chats', 'analytics'];
    let _stepOrigParent = {}; // track original parent for cleanup

    function goStep(step) {
      // Save to localStorage
      localStorage.setItem('activeStep', step);

      // Update active tab styling
      document.querySelectorAll('.step-tab').forEach(t => {
        t.classList.toggle('active', t.dataset.step === step);
      });

      const contentArea = document.getElementById('step-content-area');
      const testWrap = document.getElementById('ov-test-wrap');

      // Return previously moved screen to its original parent
      STEP_SCREENS.forEach(s => {
        const screen = document.getElementById('screen-' + s);
        if (screen && _stepOrigParent[s] && screen.parentElement === contentArea) {
          _stepOrigParent[s].appendChild(screen);
          screen.classList.remove('active');
          screen.style.display = '';
        }
      });

      // Clear content area
      contentArea.innerHTML = '';
      if (testWrap) testWrap.style.display = 'none';

      // Ensure overview stays visible
      showScreen('bot-overview');

      if (step === 'testing') {
        // Show inline test chat
        if (testWrap) testWrap.style.display = '';
      } else {
        // Move target screen into content area
        const targetScreen = document.getElementById('screen-' + step);
        if (targetScreen) {
          if (!_stepOrigParent[step]) _stepOrigParent[step] = targetScreen.parentElement;
          contentArea.appendChild(targetScreen);
          targetScreen.classList.add('active');
          targetScreen.style.display = '';
        }
      }

      // Trigger render for the step
      if (step === 'rules') renderRulesScreen();
      if (step === 'analytics') { renderAnalytics(); renderAiUsage(); }
      if (step === 'launch') renderLaunchScreen();
      if (step === 'topics') switchKbTab(STATE.kbTab || 'topics');
      if (step === 'chats') { if (typeof renderChatList === 'function') renderChatList(); }
      if (step === 'flows') renderFlowsScreen();

      // Keep overview highlighted in sidebar
      document.querySelectorAll('#nav-agent .nav-item').forEach(n => n.classList.remove('active'));
      document.getElementById('nav-overview')?.classList.add('active');

      // Scroll content to top
      document.querySelector('.main-content')?.scrollTo(0, 0);
    }

    function switchKbTab(tab) {
      STATE.kbTab = tab;
      document.getElementById('kb-tab-topics')?.classList.toggle('active', tab === 'topics');
      document.getElementById('kb-tab-unans')?.classList.toggle('active', tab === 'unanswered');
      const topicsDiv = document.getElementById('kb-content-topics');
      const unansDiv = document.getElementById('kb-content-unans');
      if (topicsDiv) topicsDiv.style.display = tab === 'topics' ? '' : 'none';
      if (unansDiv) unansDiv.style.display = tab === 'unanswered' ? '' : 'none';
      // action buttons always visible ‚Äî no layout shift on tab switch
    }

    function setTab(el) {
      el.closest('.tab-row').querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
      el.classList.add('active');
      const txt = el.textContent.trim();
      if (txt === '7 –¥–Ω–µ–π') STATE.analyticsPeriod = 7;
      else if (txt === '30 –¥–Ω–µ–π') STATE.analyticsPeriod = 30;
      else STATE.analyticsPeriod = 90;
      renderAnalytics();
    }

    /* ‚ïê‚ïê AUTOMATIONS ‚ïê‚ïê */
    const BOT_COLORS = ['#6366f1', '#22c55e', '#f59e0b', '#ec4899', '#06b6d4', '#8b5cf6', '#ef4444'];

    function renderBots() {
      const grid = document.getElementById('auto-grid');
      // clear all except promo card
      while (grid.children.length > 0) grid.removeChild(grid.lastChild);

      STATE.bots.forEach((bot, i) => {
        const color = BOT_COLORS[i % BOT_COLORS.length];
        const initial = (bot.name || '?').charAt(0).toUpperCase();
        const card = document.createElement('div');
        card.className = 'auto-card';
        card.innerHTML = `
        <div class="auto-card-head">
          <div class="auto-name-row">
            <span class="auto-logo" style="color:${color};">‚¨°</span>
            <span class="auto-name">${esc(bot.name)}</span>
          </div>
          <span class="auto-more" onclick="removeBot('${bot.id}','${esc(bot.name)}',event)">¬∑¬∑¬∑</span>
        </div>
        <div class="auto-stats">
          <div><div class="auto-stat-label">–ö–æ–Ω—Ç–∞–∫—Ç—ã</div><div class="auto-stat-val">${bot.contacts || 0}</div></div>
          <div><div class="auto-stat-label">–ö–æ–Ω–≤–µ—Ä—Å–∏—è</div><div class="auto-stat-val">${bot.contacts ? Math.round((bot.converted || 0) / bot.contacts * 100) : 0}%</div></div>
        </div>
        <div class="auto-account">
          <div class="auto-acc-av" style="background:${color};">${initial}</div>
          <span>${esc(bot.username || bot.name)}</span>
        </div>`;
        card.addEventListener('click', () => setActiveBot(bot.id));
        grid.appendChild(card);
      });

      updateAccList();
      updateAutoCount();
      renderBotSwitcher();
      renderBotNavList();
      updateBotContextNav();
    }

    function updateAutoCount() {
      const n = STATE.bots.length;
      // Update topbar count when on automations screen
      if (STATE.currentAgentScreen === 'automations') {
        document.getElementById('topbar-count').textContent = n > 0 ? n : '';
      }
      // Update sidebar badge
      const badge = document.getElementById('auto-count-badge');
      if (badge) badge.textContent = n > 0 ? n : '';
    }

    /* ‚îÄ‚îÄ Bot switcher ‚îÄ‚îÄ */
    function setActiveBot(id) {
      STATE.currentBotId = id;
      renderBotSwitcher();
      renderBotNavList();
      updateBotContextNav();
      goAgentScreen('bot-overview');
    }

    async function fetchBotPhoto(bot) {
      if (!bot.token) return null;
      if (STATE.botPhotos[bot.id] !== undefined) return STATE.botPhotos[bot.id];
      STATE.botPhotos[bot.id] = null; // mark as in-progress
      try {
        const me = await fetch(`https://api.telegram.org/bot${bot.token}/getMe`).then(r => r.json());
        if (!me.ok) return null;
        const photos = await fetch(`https://api.telegram.org/bot${bot.token}/getUserProfilePhotos?user_id=${me.result.id}&limit=1`).then(r => r.json());
        if (!photos.ok || !photos.result.photos.length) return null;
        const fileId = photos.result.photos[0][0].file_id;
        const file = await fetch(`https://api.telegram.org/bot${bot.token}/getFile?file_id=${fileId}`).then(r => r.json());
        if (!file.ok) return null;
        const url = `https://api.telegram.org/file/bot${bot.token}/${file.result.file_path}`;
        STATE.botPhotos[bot.id] = url;
        return url;
      } catch { return null; }
    }

    function renderBotNavList() {
      const list = document.getElementById('bot-nav-list');
      if (!list) return;
      if (STATE.bots.length === 0) {
        list.innerHTML = '<div style="padding:8px 10px;font-size:0.72rem;color:var(--text-dim);">–ù–µ—Ç –±–æ—Ç–æ–≤</div>';
        return;
      }
      list.innerHTML = '';
      STATE.bots.forEach((bot, i) => {
        const color = BOT_COLORS[i % BOT_COLORS.length];
        const initial = (bot.name || '?').charAt(0).toUpperCase();
        const displayName = bot.username ? '@' + bot.username.replace(/^@/, '') : bot.name;
        const isActive = bot.id === STATE.currentBotId;
        const photoUrl = STATE.botPhotos[bot.id];
        const item = document.createElement('div');
        item.className = 'bot-nav-item' + (isActive ? ' active' : '');
        const avInner = photoUrl ? `<img src="${photoUrl}" alt="">` : initial;
        item.innerHTML = `<div class="bot-nav-av" style="background:${photoUrl ? 'transparent' : color};">${avInner}</div><span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${esc(displayName)}</span>`;
        item.onclick = () => setActiveBot(bot.id);
        list.appendChild(item);
      });
    }

    function updateBotContextNav() {
      const nav = document.getElementById('bot-context-nav');
      const hasBots = !!(STATE.currentBotId && STATE.bots.length > 0);
      if (nav) nav.style.display = hasBots ? '' : 'none';
      // Always show all features expanded when a bot is selected
      if (hasBots) toggleAdvancedNav(true);
    }

    function renderBotSwitcher() {
      const switcher = document.getElementById('bot-switcher');
      if (!switcher) return;

      const bot = STATE.bots.find(b => b.id === STATE.currentBotId) || STATE.bots[0];
      if (!bot) { switcher.style.display = 'none'; return; }

      // Auto-set currentBotId if not set
      if (!STATE.currentBotId) STATE.currentBotId = bot.id;

      const i = STATE.bots.indexOf(bot);
      const color = BOT_COLORS[i % BOT_COLORS.length];
      const initial = (bot.name || '?').charAt(0).toUpperCase();
      const name = bot.username ? '@' + bot.username.replace(/^@/, '') : bot.name;

      document.getElementById('sw-av').style.background = color;
      document.getElementById('sw-av').textContent = initial;
      document.getElementById('sw-name').textContent = name;
      switcher.style.display = 'block';

      // Render dropdown list
      const dropdown = document.getElementById('sw-dropdown');
      dropdown.innerHTML = STATE.bots.map((b, idx) => {
        const c = BOT_COLORS[idx % BOT_COLORS.length];
        const ini = (b.name || '?').charAt(0).toUpperCase();
        const bname = b.username ? '@' + b.username.replace(/^@/, '') : b.name;
        const isCurrent = b.id === STATE.currentBotId;
        return `<div class="bot-sw-item ${isCurrent ? 'current' : ''}" onclick="setActiveBot('${b.id}');closeBotDropdown();">
        <div class="bot-sw-av" style="background:${c};width:28px;height:28px;font-size:12px;">${ini}</div>
        <span>${esc(bname)}</span>
      </div>`;
      }).join('');
    }

    /* ‚ïê‚ïê MOBILE SIDEBAR ‚ïê‚ïê */
    function toggleMobileSidebar() {
      const sidebar = document.querySelector('.sidebar');
      const overlay = document.getElementById('mob-overlay');
      const isOpen = sidebar.classList.toggle('mob-open');
      overlay.classList.toggle('open', isOpen);
    }
    function closeMobileSidebar() {
      document.querySelector('.sidebar')?.classList.remove('mob-open');
      document.getElementById('mob-overlay')?.classList.remove('open');
    }

    function toggleBotDropdown(e) {
      e.stopPropagation();
      const dd = document.getElementById('sw-dropdown');
      const arrow = document.getElementById('sw-arrow');
      const isOpen = dd.classList.contains('visible');
      dd.classList.toggle('visible', !isOpen);
      arrow.classList.toggle('open', !isOpen);
      if (!isOpen) {
        setTimeout(() => document.addEventListener('click', closeBotDropdown, { once: true }), 0);
      }
    }

    function closeBotDropdown() {
      document.getElementById('sw-dropdown')?.classList.remove('visible');
      document.getElementById('sw-arrow')?.classList.remove('open');
    }

    function updateAccList() {
      const list = document.getElementById('acc-list');
      if (STATE.bots.length === 0) {
        list.innerHTML = `<div class="empty-state" style="padding:20px 10px;"><div class="empty-icon" style="font-size:24px;">üì°</div><div class="empty-sub" style="font-size:0.7rem;">–î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ API</div></div>`;
        return;
      }
      list.innerHTML = '';
      STATE.bots.forEach((bot, i) => {
        const color = BOT_COLORS[i % BOT_COLORS.length];
        const initial = (bot.name || '?').charAt(0).toUpperCase();
        const item = document.createElement('div');
        item.className = 'acc-item';
        item.innerHTML = `<div class="acc-av" style="background:${color};">${initial}</div><span class="acc-name">${esc(bot.username || bot.name)}</span>`;
        list.appendChild(item);
      });
      renderTariff();
    }

    function removeBot(id, name, e) {
      e.stopPropagation();
      showConfirm({
        icon: 'üóë',
        title: I18n.t('deleteBot'),
        desc: `–ë–æ—Ç ¬´${name}¬ª –±—É–¥–µ—Ç —É–¥–∞–ª—ë–Ω. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`,
        action: I18n.t('delete'),
        danger: true,
        onOk: () => fsDel('bots', id),
      });
    }

    /* ‚ïê‚ïê MODAL ADD BOT ‚ïê‚ïê */
    function openModal() {
      document.getElementById('modal-add').classList.add('open');
      setTimeout(() => document.getElementById('bot-name').focus(), 100);
    }
    function closeModal() {
      document.getElementById('modal-add').classList.remove('open');
      ['bot-name', 'bot-token', 'bot-username'].forEach(id => document.getElementById(id).value = '');
    }
    document.getElementById('modal-add').addEventListener('click', e => { if (e.target === e.currentTarget) closeModal(); });

    async function addBot() {
      const name = document.getElementById('bot-name').value.trim();
      const token = document.getElementById('bot-token').value.trim();
      const username = document.getElementById('bot-username').value.trim();
      if (!name) { document.getElementById('bot-name').focus(); return; }
      if (!token) { alert(I18n.t('invalidToken')); document.getElementById('bot-token').focus(); return; }
      const btn = document.getElementById('add-bot-btn');
      if (btn) { btn.disabled = true; btn.textContent = I18n.t('connecting') + '...'; }
      try {
        const ref = await fsAdd('bots', { name, token, username: username || '@' + name.toLowerCase().replace(/\s+/g, ''), contacts: 0, conversion: 0 });
        if (STATE.agentActive && currentUser) {
          registerTelegramWebhook(currentUser.uid, ref.id, token, false);
        }
        closeModal();
      } finally {
        if (btn) { btn.disabled = false; btn.textContent = I18n.t('connect'); }
      }
    }

    async function registerTelegramWebhook(uid, botId, token, remove) {
      try {
        const res = await window.AppApi.registerTelegramWebhook(uid, botId, token, remove);
        return res.ok ? res.data : null;
      } catch (e) { console.warn('registerWebhook error:', e); return null; }
    }

    async function activateAllBots() {
      if (!currentUser) return;
      const btn = document.getElementById('btn-activate-bots');
      const msg = document.getElementById('webhook-status-msg');
      btn.disabled = true;
      btn.textContent = '‚è≥ ' + I18n.t('connecting') + '...';
      msg.textContent = '';
      const botsSnap = await db.collection('users').doc(currentUser.uid).collection('bots').get();
      if (botsSnap.empty) {
        msg.textContent = '‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ –¥–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –≤ —Ä–∞–∑–¥–µ–ª–µ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏';
        btn.disabled = false; btn.textContent = '‚ö° –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–∞';
        return;
      }
      let ok = 0, fail = 0;
      for (const doc of botsSnap.docs) {
        const { token } = doc.data();
        if (!token) continue;
        const result = await registerTelegramWebhook(currentUser.uid, doc.id, token, false);
        if (result && result.ok) ok++; else fail++;
      }
      await db.collection('users').doc(currentUser.uid).collection('settings').doc('agent')
        .set({ active: true }, { merge: true });
      STATE.agentActive = true;
      applyAgentStatus();
      renderWebhookBots();
      btn.disabled = false;
      btn.textContent = '‚ö° –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –±–æ—Ç–∞';
      if (fail === 0) msg.textContent = `‚úÖ –ë–æ—Ç –ø–æ–¥–∫–ª—é—á—ë–Ω! –¢–µ–ø–µ—Ä—å –æ–Ω –±—É–¥–µ—Ç –æ—Ç–≤–µ—á–∞—Ç—å –≤ Telegram.`;
      else msg.textContent = `‚ö†Ô∏è –ü–æ–¥–∫–ª—é—á–µ–Ω–æ: ${ok}, –æ—à–∏–±–æ–∫: ${fail}. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞.`;
    }

    async function renderWebhookBots() {
      const el = document.getElementById('webhook-bots-list');
      if (!el || !currentUser) return;
      const botsSnap = await db.collection('users').doc(currentUser.uid).collection('bots').get();
      if (botsSnap.empty) {
        el.innerHTML = '<div style="font-size:0.8rem;color:var(--text-sec);">–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –±–æ—Ç–æ–≤</div>';
        return;
      }
      el.innerHTML = botsSnap.docs.map(doc => {
        const d = doc.data();
        const active = STATE.agentActive;
        return `<div style="display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:var(--surface2);border-radius:8px;font-size:0.85rem;">
        <span>ü§ñ ${d.name || d.username || I18n.t('emptyBot')}</span>
        <span style="color:${active ? '#22c55e' : 'var(--text-sec)'};">${active ? '‚óè –ê–∫—Ç–∏–≤–µ–Ω' : '‚óã –ù–µ –∞–∫—Ç–∏–≤–µ–Ω'}</span>
      </div>`;
      }).join('');
    }

    /* ‚ïê‚ïê KB MODAL ‚ïê‚ïê */
    function showKbModal(type) {
      document.getElementById('kb-modal-title').textContent = type === 'file' ? '–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª' : '–î–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç';
      document.getElementById('modal-kb').classList.add('open');
      setTimeout(() => document.getElementById('kb-title').focus(), 100);
    }
    function closeKbModal() {
      document.getElementById('modal-kb').classList.remove('open');
      document.getElementById('kb-title').value = '';
      document.getElementById('kb-content').value = '';
    }
    document.getElementById('modal-kb').addEventListener('click', e => { if (e.target === e.currentTarget) closeKbModal(); });

    async function saveKb() {
      const title = document.getElementById('kb-title').value.trim();
      const rawText = document.getElementById('kb-content').value.trim();
      if (!title || !rawText) { alert(I18n.t('fillAllFields')); return; }
      const sourceRef = await col('kbSources').add({
        title, rawText, type: 'text', status: 'queued',
        _ts: firebase.firestore.FieldValue.serverTimestamp(),
      });
      const jobRef = await col('jobs').add({
        sourceId: sourceRef.id, type: 'knowledge_ingest',
        status: 'queued', step: 'parse', progress: 0,
        _ts: firebase.firestore.FieldValue.serverTimestamp(),
      });
      startKnowledgeProcessing(sourceRef.id, jobRef.id);
      showToast(I18n.t('qaGenerating'));
      closeKbModal();
    }

    /* ‚ïê‚ïê EDIT ANSWER MODAL ‚ïê‚ïê */
    let _eaState = { id: null, question: '', answer: '', mode: 'replace', source: 'kb' };

    function openEditAnswer(id, question, answer, source = 'kb') {
      _eaState = { id, question, answer: answer || '', mode: 'replace', source };
      document.getElementById('ea-question').textContent = question;
      const curWrap = document.getElementById('ea-current-wrap');
      const curAnswer = document.getElementById('ea-current-answer');
      if (answer) {
        curWrap.style.display = '';
        curAnswer.textContent = answer;
      } else {
        curWrap.style.display = 'none';
      }
      document.getElementById('ea-textarea').value = '';
      document.getElementById('ea-textarea').placeholder = '–ù–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å';
      document.getElementById('ea-confidence').style.display = 'none';
      document.getElementById('ea-admin-note').style.display = 'none';
      document.getElementById('ea-insert-btn').style.display = answer ? '' : 'none';

      // Set title
      const title = source === 'unanswered' ? '–î–æ–±–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç' : '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞';
      document.getElementById('ea-modal-title').textContent = title;

      // Hide tabs for unanswered (only draft mode)
      document.getElementById('ea-tabs').style.display = source === 'unanswered' ? 'none' : '';
      document.getElementById('ea-hint').style.display = source === 'unanswered' ? 'none' : '';

      switchEaTab('replace');
      document.getElementById('modal-edit-answer').classList.add('open');
    }

    function switchEaTab(tab) {
      _eaState.mode = tab;
      document.getElementById('ea-tab-replace')?.classList.toggle('active', tab === 'replace');
      document.getElementById('ea-tab-append')?.classList.toggle('active', tab === 'append');
      const hintText = document.getElementById('ea-hint-text');
      if (tab === 'replace') {
        hintText.textContent = '–ó–∞–º–µ–Ω–∞ –æ—Ç–≤–µ—Ç–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä—É—é –ò–ò-–∞–≥–µ–Ω—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –æ—Ç–≤–µ—á–∞—è –Ω–∞ –≤–æ–ø—Ä–æ—Å';
        document.getElementById('ea-textarea').placeholder = '–ù–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å';
      } else {
        hintText.textContent = '–î–∞–π—Ç–µ –æ—Å–æ–±—ã–µ —É–∫–∞–∑–∞–Ω–∏—è –ø–æ –ø–æ–≤–µ–¥–µ–Ω–∏—é, —É—Å–ª–æ–≤–∏—è–º –∏ —Å—Ç–∏–ª—é –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å';
        document.getElementById('ea-textarea').placeholder = '–ö–∞–∫ –¥–æ–ø–æ–ª–Ω–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–≤–µ—Ç–∞?';
      }
    }

    async function generateAIAnswer() {
      const btn = document.getElementById('ea-ai-btn');
      const origText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É—é‚Ä¶';

      const mode = _eaState.source === 'unanswered' ? 'UNANSWERED_DRAFT'
        : _eaState.mode === 'replace' ? 'KB_EDIT_REPLACE' : 'KB_EDIT_APPEND';

      // Gather bot rules
      const botDoc = STATE.bots.find(b => b.id === STATE.currentBotId);
      const rules = botDoc?.rules || '';
      const provider = botDoc?.provider || 'openai';
      const model = botDoc?.model || 'gpt-4o-mini';

      // Gather kb_matches from similar KB items
      const kbMatches = STATE.kbQA
        .filter(qa => qa.id !== _eaState.id && qa.answer)
        .slice(0, 5)
        .map(qa => `Q: ${qa.question}\nA: ${qa.answer}`);

      try {
        const resp = await fetch('/api/generate-answer', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            question: _eaState.question,
            mode,
            existing_answer: _eaState.answer,
            kb_matches: kbMatches,
            bot_rules: rules,
            provider,
            model,
          }),
        });
        const data = await resp.json();
        if (data.error) throw new Error(data.error);

        document.getElementById('ea-textarea').value = data.answer_text || '';

        if (data.confidence != null) {
          const pct = Math.round(data.confidence * 100);
          document.getElementById('ea-confidence').style.display = '';
          document.getElementById('ea-confidence-val').textContent = `${pct}%`;
        }
        if (data.admin_note) {
          document.getElementById('ea-admin-note').style.display = '';
          document.getElementById('ea-admin-note').textContent = 'üí° ' + data.admin_note;
        }
      } catch (err) {
        showToast('‚ùå ' + I18n.t('error') + ': ' + err.message);
      } finally {
        btn.disabled = false;
        btn.innerHTML = origText;
      }
    }

    function insertCurrentAnswer() {
      const ta = document.getElementById('ea-textarea');
      ta.value = _eaState.answer;
      ta.focus();
    }

    async function saveEditAnswer() {
      const text = document.getElementById('ea-textarea').value.trim();
      if (!text) { showToast('‚ö†Ô∏è ' + I18n.t('enterAnswerText')); return; }

      const saveBtn = document.getElementById('ea-save-btn');
      saveBtn.disabled = true;
      saveBtn.textContent = I18n.t('saving');

      try {
        if (_eaState.source === 'unanswered') {
          // Save as new KB entry: create kbQA doc
          await col('kbQA').add({
            question: _eaState.question,
            answer: text,
            asked: 1,
            _ts: firebase.firestore.FieldValue.serverTimestamp(),
          });
          // Remove from unanswered
          if (_eaState.id) fsDel('unanswered', _eaState.id);
          showToast('‚úÖ ' + I18n.t('answerAdded'));
        } else {
          // Update existing kbQA doc
          let newAnswer;
          if (_eaState.mode === 'append') {
            newAnswer = (_eaState.answer ? _eaState.answer + '\n\n' : '') + text;
          } else {
            newAnswer = text;
          }
          await col('kbQA').doc(_eaState.id).update({
            answer: newAnswer,
            _ts: firebase.firestore.FieldValue.serverTimestamp(),
          });
          showToast('‚úÖ ' + I18n.t('answerUpdated'));
        }
        closeEditAnswer();
      } catch (err) {
        showToast('‚ùå ' + I18n.t('errorSaving') + ': ' + err.message);
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
      }
    }

    function closeEditAnswer() {
      document.getElementById('modal-edit-answer').classList.remove('open');
      _eaState = { id: null, question: '', answer: '', mode: 'replace', source: 'kb' };
    }
    document.getElementById('modal-edit-answer').addEventListener('click', e => { if (e.target === e.currentTarget) closeEditAnswer(); });

    function renderKb() {
      const el = document.getElementById('kb-items');
      el.innerHTML = '';

      const STEP_LABELS = { parse: I18n.t('processingFile'), chunk: I18n.t('chunkingFile'), qa_generate: I18n.t('generatingQA'), dedupe: I18n.t('checkingDuplicates'), save: I18n.t('savingData'), done: I18n.t('done') + '!' };

      // Active/queued jobs ‚Äî progress bars
      STATE.kbJobs.filter(j => j.status === 'running' || j.status === 'queued').forEach(job => {
        const div = document.createElement('div');
        div.className = 'auto-card';
        div.style.cssText = 'cursor:default;border-color:var(--primary-brd);';
        const prog = job.progress || 0;
        const label = STEP_LABELS[job.step] || I18n.t('processingFile');
        const meta = job.meta || {};
        div.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
          <span style="font-size:0.82rem;font-weight:700;">‚è≥ ${label}</span>
          <div style="display:flex;align-items:center;gap:10px;">
            <span style="font-size:0.75rem;color:var(--indigo);font-weight:700;">${prog}%</span>
            <button onclick="cancelJob('${job.id}','${job.sourceId || ''}')" style="background:none;border:1px solid var(--border);border-radius:6px;padding:2px 9px;font-size:0.68rem;cursor:pointer;color:var(--text-sec);">‚úï –û—Ç–º–µ–Ω–∏—Ç—å</button>
          </div>
        </div>
        <div style="height:5px;background:var(--border);border-radius:3px;overflow:hidden;">
          <div class="pb-fill" style="width:${prog}%;"></div>
        </div>
        ${meta.chunks ? `<div style="font-size:0.7rem;color:var(--text-dim);margin-top:6px;">–ß–∞–Ω–∫–æ–≤: ${meta.chunksDone || 0}/${meta.chunks} ¬∑ Q&A: ${meta.qaGenerated || 0}</div>` : ''}`;
        el.appendChild(div);
      });

      // Succeeded jobs ‚Äî result summary
      STATE.kbJobs.filter(j => j.status === 'succeeded').forEach(job => {
        const div = document.createElement('div');
        div.className = 'auto-card';
        div.style.cssText = 'cursor:default;border-color:#22c55e55;';
        const m = job.meta || {};
        div.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:space-between;">
          <span style="font-size:0.8rem;font-weight:700;color:#22c55e;">‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞</span>
          <button onclick="fsDel('jobs','${job.id}')" style="background:none;border:none;cursor:pointer;color:var(--text-dim);font-size:12px;">‚úï</button>
        </div>
        <div style="font-size:0.75rem;color:var(--text-sec);margin-top:4px;">
          –î–æ–±–∞–≤–ª–µ–Ω–æ: <b style="color:var(--text);">${m.added || 0}</b> –ø–∞—Ä Q&A &nbsp;¬∑&nbsp; –ü—Ä–æ–ø—É—â–µ–Ω–æ –¥—É–±–ª–∏–∫–∞—Ç–æ–≤: <b>${m.skipped || 0}</b>
        </div>`;
        el.appendChild(div);
      });

      // Failed jobs
      STATE.kbJobs.filter(j => j.status === 'failed').forEach(job => {
        const div = document.createElement('div');
        div.className = 'auto-card';
        div.style.cssText = 'cursor:default;border-color:#ef444455;';
        div.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:space-between;">
          <span style="font-size:0.8rem;font-weight:700;color:#ef4444;">‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏</span>
          <button onclick="fsDel('jobs','${job.id}')" style="background:none;border:none;cursor:pointer;color:var(--text-dim);font-size:12px;">‚úï</button>
        </div>
        <div style="font-size:0.72rem;color:var(--text-sec);margin-top:4px;">${esc(job.errorMessage || I18n.t('unknownError'))}</div>`;
        el.appendChild(div);
      });

      // Cancelled jobs
      STATE.kbJobs.filter(j => j.status === 'cancelled').forEach(job => {
        const div = document.createElement('div');
        div.className = 'auto-card';
        div.style.cssText = 'cursor:default;border-color:#f9731655;';
        div.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:space-between;">
          <span style="font-size:0.8rem;font-weight:700;color:#f97316;">‚õî –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞</span>
          <button onclick="fsDel('jobs','${job.id}')" style="background:none;border:none;cursor:pointer;color:var(--text-dim);font-size:12px;">‚úï</button>
        </div>
        <div style="font-size:0.72rem;color:var(--text-sec);margin-top:4px;">–û–±—Ä–∞–±–æ—Ç–∫–∞ –±—ã–ª–∞ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º.</div>`;
        el.appendChild(div);
      });

      // Q&A pairs header
      if (STATE.kbQA.length > 0) {
        const hdr = document.createElement('div');
        hdr.style.cssText = 'font-size:0.7rem;font-weight:700;color:var(--text-dim);letter-spacing:0.08em;text-transform:uppercase;margin:14px 0 6px;';
        hdr.textContent = `–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π ¬∑ ${STATE.kbQA.length} –ø–∞—Ä Q&A`;
        el.appendChild(hdr);

        STATE.kbQA.forEach(qa => {
          const div = document.createElement('div');
          div.className = 'auto-card';
          div.style.cursor = 'default';
          div.innerHTML = `
          <div style="display:flex;align-items:flex-start;justify-content:space-between;gap:8px;">
            <div style="font-size:0.8rem;font-weight:700;color:var(--text);line-height:1.4;">‚ùì ${esc(qa.question)}</div>
            <button onclick="fsDel('kbQA','${qa.id}')" style="background:none;border:none;cursor:pointer;color:var(--text-dim);font-size:13px;flex-shrink:0;">‚úï</button>
          </div>
          <div style="font-size:0.75rem;color:var(--text-sec);margin-top:5px;line-height:1.5;">üí¨ ${esc(qa.answer).slice(0, 160)}${qa.answer.length > 160 ? '‚Ä¶' : ''}</div>
          ${qa.topic ? `<div style="font-size:0.65rem;color:var(--text-dim);margin-top:4px;">üìÇ ${esc(qa.topic)}</div>` : ''}`;
          el.appendChild(div);
        });

      } else if (STATE.kbItems.length > 0) {
        // Legacy fallback
        STATE.kbItems.forEach(item => {
          const div = document.createElement('div');
          div.className = 'auto-card';
          div.style.cursor = 'default';
          div.innerHTML = `
          <div style="display:flex;align-items:center;justify-content:space-between;">
            <span style="font-size:0.82rem;font-weight:700;">${esc(item.title)}</span>
            <button onclick="fsDel('kbItems','${item.id}')" style="background:none;border:none;cursor:pointer;color:var(--text-dim);font-size:13px;">‚úï</button>
          </div>
          <div style="font-size:0.75rem;color:var(--text-sec);margin-top:6px;line-height:1.5;">${esc(item.content).slice(0, 120)}${item.content.length > 120 ? '‚Ä¶' : ''}</div>`;
          el.appendChild(div);
        });
      }

      // Transcripts section
      const transcripts = (STATE.kbSources || []).filter(s => s.type === 'transcript');
      if (transcripts.length > 0) {
        const hdr = document.createElement('div');
        hdr.style.cssText = 'font-size:0.7rem;font-weight:700;color:var(--text-dim);letter-spacing:0.08em;text-transform:uppercase;margin:18px 0 6px;';
        hdr.textContent = `üé¨ –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏ ¬∑ ${transcripts.length}`;
        el.appendChild(hdr);
        transcripts.forEach(src => {
          const div = document.createElement('div');
          div.className = 'auto-card';
          div.style.cssText = 'cursor:default;border-color:#f9731630;';
          const statusBadge = src.status === 'transcribed'
            ? `<span style="background:#fef3c7;color:#d97706;font-size:0.62rem;font-weight:700;padding:2px 7px;border-radius:20px;">–û–∂–∏–¥–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏</span>`
            : src.status === 'done'
              ? `<span style="background:#dcfce7;color:#16a34a;font-size:0.62rem;font-weight:700;padding:2px 7px;border-radius:20px;">–í –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π</span>`
              : `<span style="background:var(--bg);color:var(--text-dim);font-size:0.62rem;font-weight:700;padding:2px 7px;border-radius:20px;">${src.status}</span>`;
          div.innerHTML = `
          <div style="display:flex;align-items:center;justify-content:space-between;gap:8px;">
            <div style="flex:1;min-width:0;">
              <div style="font-size:0.8rem;font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">üé¨ ${esc(src.title || src.videoId || 'YouTube')}</div>
              <div style="font-size:0.68rem;color:var(--text-dim);margin-top:3px;">${(src.chars || 0).toLocaleString()} —Å–∏–º–≤–æ–ª–æ–≤${src.url ? ` ¬∑ <a href="${esc(src.url)}" target="_blank" style="color:var(--indigo);">–æ—Ç–∫—Ä—ã—Ç—å</a>` : ''}</div>
            </div>
            <div style="display:flex;align-items:center;gap:6px;flex-shrink:0;">
              ${statusBadge}
              ${src.status === 'transcribed' ? `<button onclick="addSourceToKb('${src.id}')" style="background:var(--primary);color:#fff;border:none;border-radius:6px;padding:3px 10px;font-size:0.68rem;font-weight:700;cursor:pointer;">‚ûï –í –±–∞–∑—É</button>` : ''}
              <button onclick="fsDel('kbSources','${src.id}')" style="background:none;border:none;cursor:pointer;color:var(--text-dim);font-size:13px;">‚úï</button>
            </div>
          </div>`;
          el.appendChild(div);
        });
      }

      renderSuggestions();
    }

    async function addSourceToKb(sourceId) {
      if (!currentUser) return;
      const jobRef = await col('jobs').add({
        sourceId,
        status: 'queued', step: 'parse', progress: 0,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      });
      await startKnowledgeProcessing(sourceId, jobRef.id);
      showToast(I18n.t('transcriptionStarted'));
    }

    /* ‚ïê‚ïê SUGGESTIONS from KB ‚ïê‚ïê */
    function renderSuggestions() {
      const list = document.getElementById('sug-list');
      const hasData = STATE.kbQA.length > 0 || STATE.kbItems.length > 0;
      if (!hasData) {
        list.innerHTML = `<div class="empty-state" style="padding:20px;text-align:center;"><div class="empty-sub">–î–æ–±–∞–≤—å—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π</div></div>`;
        return;
      }
      list.innerHTML = '';
      // Prefer kbQA questions as suggestions
      const items = STATE.kbQA.length > 0
        ? STATE.kbQA.slice(0, 6).map(qa => ({ label: qa.question, query: qa.question }))
        : STATE.kbItems.slice(0, 6).map(it => ({ label: `–†–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ: ${it.title}`, query: `–†–∞—Å—Å–∫–∞–∂–∏ –ø—Ä–æ ${it.title}` }));
      items.forEach(({ label, query }) => {
        const div = document.createElement('div');
        div.className = 'sug-item';
        div.innerHTML = `<span class="sug-ico">üí°</span>${esc(label)}`;
        div.onclick = () => { document.getElementById('chat-input').value = query; sendChat(); };
        list.appendChild(div);
      });
    }

    /* ‚ïê‚ïê CHAT ‚ïê‚ïê */
    function sendChat(inputId, msgsId) {
      const _inp = inputId || 'chat-input';
      const _msgs = msgsId || 'chat-msgs';
      const input = document.getElementById(_inp);
      const msgs = document.getElementById(_msgs);
      const text = input.value.trim();
      if (!text) return;

      if (!STATE.agentActive) {
        showToast('‚ö†Ô∏è ' + I18n.t('agentInactive') + '. ' + I18n.t('turnOnAgent'));
        return;
      }

      const time = new Date().toLocaleTimeString('ru', { hour: '2-digit', minute: '2-digit' });
      const typingId = _msgs + '-typing';

      const uRow = document.createElement('div');
      uRow.className = 'msg-row user';
      uRow.innerHTML = `<div class="bubble user">${esc(text)}</div><div class="msg-time">${time}</div>`;
      msgs.appendChild(uRow);
      input.value = '';
      msgs.scrollTop = msgs.scrollHeight;

      // show typing indicator
      const typingRow = document.createElement('div');
      typingRow.className = 'msg-row';
      typingRow.id = typingId;
      typingRow.innerHTML = `<div class="bubble" style="color:var(--text-dim);font-style:italic;">–ø–µ—á–∞—Ç–∞–µ—Ç...</div>`;
      msgs.appendChild(typingRow);
      msgs.scrollTop = msgs.scrollHeight;

      // –í—ã–∑—ã–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–π AI —á–µ—Ä–µ–∑ Firebase Function
      (async () => {
        try {
          // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ –∏ –º–æ–¥–µ–ª—å –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫
          const providersCfg = STATE.aiProviders || {};
          let provider = 'claude', model = '';
          for (const p of ['openai', 'gemini', 'claude']) {
            if (providersCfg[p]?.enabled) { provider = p; model = providersCfg[p].model || ''; break; }
          }

          const resp = await fetch('/api/ai-chat', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              question: text,
              history: STATE.chatHistory.slice(-10),
              kbItems: STATE.kbQA.length > 0
                ? STATE.kbQA.map(qa => ({ title: qa.question, content: qa.answer }))
                : STATE.kbItems,
              rules: STATE.rules,
              provider,
              model,
            }),
          });

          document.getElementById(typingId)?.remove();

          let reply;
          if (resp.ok) {
            const data = await resp.json();
            reply = data.answer || I18n.t('emptyAnswer');
          } else {
            reply = '‚ö†Ô∏è –û—à–∏–±–∫–∞ AI. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞.';
          }

          // Save to conversation history
          STATE.chatHistory.push({ role: 'user', content: text });
          STATE.chatHistory.push({ role: 'assistant', content: reply });
          if (STATE.chatHistory.length > 20) STATE.chatHistory = STATE.chatHistory.slice(-20);

          const bRow = document.createElement('div');
          bRow.className = 'msg-row';
          bRow.innerHTML = `<div class="bubble">${esc(reply)}</div><div class="msg-time">${time} <span style="color:var(--text-dim);font-size:0.58rem;">‚Ä¢ —Ç–µ—Å—Ç</span></div>`;
          msgs.appendChild(bRow);
          msgs.scrollTop = msgs.scrollHeight;

        } catch (e) {
          document.getElementById(typingId)?.remove();
          const bRow = document.createElement('div');
          bRow.className = 'msg-row';
          bRow.innerHTML = `<div class="bubble" style="color:var(--red);">‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ AI. ${e.message}</div><div class="msg-time">${time}</div>`;
          msgs.appendChild(bRow);
          msgs.scrollTop = msgs.scrollHeight;
        }
      })();
    }

    function clearChat(msgsId) {
      STATE.chatHistory = [];
      const msgs = document.getElementById(msgsId || 'chat-msgs');
      msgs.innerHTML = `<div class="date-sep">–°–µ–≥–æ–¥–Ω—è</div>
      <div class="msg-row">
        <div class="bubble">üëã –ü—Ä–∏–≤–µ—Ç! –Ø –≤–∞—à –ò–ò-–∞–≥–µ–Ω—Ç. –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–∞–∫ —è –æ—Ç–≤–µ—á–∞—é –∫–ª–µ–Ω—Ç–∞–º. –ù–∞–ø–∏—à–∏—Ç–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å.</div>
        <div class="msg-time">${new Date().toLocaleTimeString('ru', { hour: '2-digit', minute: '2-digit' })}</div>
      </div>`;
      showToast('üóë ' + I18n.t('dialogCleared'));
    }

    function restartAgent() {
      clearChat();
      renderSuggestions();
      showToast('‚Ü∫ ' + I18n.t('agentRestarted'));
    }

    function toggleOvTest() {
      const wrap = document.getElementById('ov-test-wrap');
      const btn = document.getElementById('ov-test-btn');
      const open = wrap.style.display !== 'none';
      wrap.style.display = open ? 'none' : 'block';
      if (btn) btn.textContent = open ? '‚ñ∑ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å' : '‚ñ≤ –ó–∞–∫—Ä—ã—Ç—å —Ç–µ—Å—Ç';
      if (!open) setTimeout(() => document.getElementById('ov-chat-input')?.focus(), 80);
    }

    /* ‚ïê‚ïê UNANSWERED ‚ïê‚ïê */
    function renderUnanswered() {
      const grid = document.getElementById('unans-grid');
      const badge = document.getElementById('unans-badge');
      const tabCount = document.getElementById('unans-count-tab');
      const n = STATE.unanswered.length;
      if (badge) { badge.textContent = n; badge.style.display = n > 0 ? '' : 'none'; }
      if (tabCount) tabCount.textContent = n > 0 ? `(${n})` : '';

      if (n === 0) {
        grid.innerHTML = `<div style="grid-column:1/-1;"><div class="empty-state"><div class="empty-icon">‚úÖ</div><div class="empty-title">–û—Ç–ª–∏—á–Ω–æ!</div><div class="empty-sub">–í—Å–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—É—á–∏–ª–∏ –æ—Ç–≤–µ—Ç</div></div></div>`;
        return;
      }
      grid.innerHTML = '';
      STATE.unanswered.forEach(q => {
        const card = document.createElement('div');
        card.className = 'unans-card';
        card.innerHTML = `
        <div class="unans-text">${esc(q.text)}</div>
        <div class="unans-foot">
          <span class="q-count">‚ñê 1 –∑–∞–ø—Ä–æ—Å</span>
          <div style="display:flex;gap:5px;">
            <button style="background:none;border:1px solid var(--border);border-radius:6px;padding:3px 9px;font-size:0.68rem;color:var(--text-sec);cursor:pointer;" onclick="rejectUnans('${q.id}')">‚úï –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
            <button class="btn-add" onclick="answerUnans('${q.id}')">‚úÖ –û–¥–æ–±—Ä–∏—Ç—å</button>
          </div>
        </div>`;
        grid.appendChild(card);
      });
    }

    function rejectUnans(id) {
      fsDel('unanswered', id);
      showToast('‚úï ' + I18n.t('questionRejected'));
    }

    function answerUnans(id) {
      const item = STATE.unanswered.find(q => q.id === id);
      if (!item) return;
      openEditAnswer(id, item.text, '', 'unanswered');
    }

    /* ‚ïê‚ïê JOBS INLINE (for topics screen) ‚ïê‚ïê */
    function renderJobsInline() {
      const el = document.getElementById('kb-jobs-inline');
      if (!el) return;
      const STEP_LABELS = { parse: I18n.t('processingFile'), chunk: I18n.t('chunkingFile'), qa_generate: I18n.t('generatingQA'), dedupe: I18n.t('checkingDuplicates'), save: I18n.t('savingData'), done: I18n.t('done') + '!' };
      const active = STATE.kbJobs.filter(j => j.status === 'running' || j.status === 'queued');
      el.style.display = active.length > 0 ? '' : 'none';
      el.innerHTML = '';
      active.forEach(job => {
        const prog = job.progress || 0;
        const label = STEP_LABELS[job.step] || I18n.t('processingFile');
        const div = document.createElement('div');
        div.style.cssText = 'background:var(--surface);border:1px solid var(--primary-brd);border-radius:10px;padding:12px 14px;';
        div.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:7px;">
          <span style="font-size:0.8rem;font-weight:700;">‚è≥ ${label}</span>
          <div style="display:flex;align-items:center;gap:10px;">
            <span style="font-size:0.72rem;color:var(--indigo);font-weight:700;">${prog}%</span>
            <button onclick="cancelJob('${job.id}','${job.sourceId || ''}')" style="background:none;border:1px solid var(--border);border-radius:6px;padding:2px 9px;font-size:0.65rem;cursor:pointer;color:var(--text-sec);">‚úï –û—Ç–º–µ–Ω–∏—Ç—å</button>
          </div>
        </div>
        <div style="height:4px;background:var(--border);border-radius:2px;overflow:hidden;">
          <div class="pb-fill" style="width:${prog}%;"></div>
        </div>`;
        el.appendChild(div);
      });
    }

    /* ‚ïê‚ïê AI USAGE STATS ‚ïê‚ïê */

    function fmtNum(n) {
      if (n >= 1_000_000) return (n / 1_000_000).toFixed(1) + 'M';
      if (n >= 1_000) return (n / 1_000).toFixed(1) + 'K';
      return String(n);
    }

    // ‚îÄ‚îÄ Model pricing (USD per 1M tokens) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const MODEL_PRICING = {
      'gpt-4o-mini': { input: 0.15, output: 0.60 },
      'gpt-4o': { input: 2.50, output: 10.00 },
      'gpt-3.5-turbo': { input: 0.50, output: 1.50 },
      'gemini-1.5-flash': { input: 0.075, output: 0.30 },
      'gemini-1.5-flash-8b': { input: 0.0375, output: 0.15 },
      'gemini-1.5-pro': { input: 1.25, output: 5.00 },
      'gemini-2.0-flash': { input: 0.10, output: 0.40 },
      'gemini-2.0-flash-lite': { input: 0.075, output: 0.30 },
      'claude-haiku-4-5': { input: 0.80, output: 4.00 },
      'claude-sonnet-4-5': { input: 3.00, output: 15.00 },
      'claude-opus-4': { input: 15.00, output: 75.00 },
      'claude-haiku-4-5-20251001': { input: 0.80, output: 4.00 },
      'claude-sonnet-4-6': { input: 3.00, output: 15.00 },
      'gpt-4.1': { input: 2.00, output: 8.00 },
    };
    const CURRENCIES = {
      USD: { symbol: '$', rate: 1, label: 'USD' },
      EUR: { symbol: '‚Ç¨', rate: 0.92, label: 'EUR' },
      RUB: { symbol: '‚ÇΩ', rate: 90, label: 'RUB' },
      UZS: { symbol: "so'm", rate: 12850, label: 'UZS' },
    };
    if (!STATE.aiCurrency) STATE.aiCurrency = 'USD';

    function calcCostUSD(inputTokens, outputTokens, model) {
      const price = MODEL_PRICING[model];
      if (!price) return 0;
      return (inputTokens / 1e6) * price.input + (outputTokens / 1e6) * price.output;
    }

    function fmtCost(usd) {
      const cur = CURRENCIES[STATE.aiCurrency] || CURRENCIES.USD;
      const val = usd * cur.rate;
      const code = STATE.aiCurrency;

      if (code === 'UZS') {
        // Symbol after number, whole numbers with thousands separator
        if (val === 0) return `0 so'm`;
        if (val < 1) return `${val.toFixed(1)} so'm`;
        return `${Math.round(val).toLocaleString('ru-RU')} so'm`;
      }
      if (code === 'RUB') {
        if (val === 0) return `0 ‚ÇΩ`;
        if (val < 1) return `${val.toFixed(2)} ‚ÇΩ`;
        if (val < 1000) return `${val.toFixed(1)} ‚ÇΩ`;
        return `${Math.round(val).toLocaleString('ru-RU')} ‚ÇΩ`;
      }
      // USD / EUR ‚Äî symbol before
      if (val === 0) return `${cur.symbol}0`;
      if (val < 0.001) return `${cur.symbol}${val.toFixed(5)}`;
      if (val < 0.01) return `${cur.symbol}${val.toFixed(4)}`;
      if (val < 1) return `${cur.symbol}${val.toFixed(3)}`;
      if (val < 1000) return `${cur.symbol}${val.toFixed(2)}`;
      return `${cur.symbol}${Math.round(val).toLocaleString()}`;
    }

    function setAiCurrency(code) {
      STATE.aiCurrency = code;
      Object.keys(CURRENCIES).forEach(c => {
        document.getElementById(`cur-btn-${c}`)?.classList.toggle('active', c === code);
      });
      renderAiUsage();
    }

    function getAiUsageFiltered() {
      const now = Date.now();
      const cutoffMs = STATE.aiUsagePeriod === 1
        ? now - 24 * 60 * 60 * 1000
        : now - STATE.aiUsagePeriod * 24 * 60 * 60 * 1000;
      return STATE.aiUsage.filter(e => {
        const ts = e.createdAt?.seconds
          ? e.createdAt.seconds * 1000
          : (e.createdAt?.toMillis ? e.createdAt.toMillis() : 0);
        return ts >= cutoffMs;
      });
    }

    function setAiUsagePeriod(days) {
      STATE.aiUsagePeriod = days;
      [1, 7, 30].forEach(d => {
        document.getElementById(`aiu-tab-${d}`)?.classList.toggle('active', d === days);
      });
      renderAiUsage();
    }

    const EMPTY_MSG = (cols) =>
      `<tr><td colspan="${cols}" style="text-align:center;color:var(--text-dim);padding:24px;font-size:0.75rem;">
      –î–∞–Ω–Ω—ã–µ –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ –¥–∏–∞–ª–æ–≥–∞ —Å –±–æ—Ç–æ–º –≤ Telegram
    </td></tr>`;

    function renderAiUsage() {
      if (!document.getElementById('aiu-total-tokens')) return; // elements not in DOM
      const events = getAiUsageFiltered();
      const allEvents = STATE.aiUsage;
      const totalTokens = events.reduce((s, e) => s + (e.totalTokens || 0), 0);
      const totalInput = events.reduce((s, e) => s + (e.inputTokens || 0), 0);
      const totalOutput = events.reduce((s, e) => s + (e.outputTokens || 0), 0);
      const totalCostUSD = events.reduce((s, e) => s + calcCostUSD(e.inputTokens || 0, e.outputTokens || 0, e.model || ''), 0);
      const requests = events.length;
      const errors = events.filter(e => e.status === 'error').length;
      const avg = requests > 0 ? Math.round(totalTokens / requests) : 0;

      const hasAny = allEvents.length > 0;
      document.getElementById('aiu-total-tokens').textContent = hasAny ? fmtNum(totalTokens) : '‚Äî';
      document.getElementById('aiu-token-sub').textContent = hasAny
        ? `‚Üë ${fmtNum(totalInput)} / ‚Üì ${fmtNum(totalOutput)}`
        : I18n.t('dataAfterChats');
      document.getElementById('aiu-requests').textContent = hasAny ? fmtNum(requests) : '‚Äî';
      document.getElementById('aiu-avg').textContent = avg > 0 ? fmtNum(avg) : '‚Äî';
      document.getElementById('aiu-cost').textContent = hasAny ? fmtCost(totalCostUSD) : '‚Äî';
      document.getElementById('aiu-cost-sub').textContent = CURRENCIES[STATE.aiCurrency]?.label || 'USD';
      document.getElementById('aiu-errors').textContent = errors > 0 ? errors : '‚Äî';

      // ‚îÄ‚îÄ Providers table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const provMap = {};
      events.forEach(e => {
        const p = e.provider || 'unknown';
        if (!provMap[p]) provMap[p] = { requests: 0, input: 0, output: 0, total: 0, costUSD: 0 };
        provMap[p].requests++;
        provMap[p].input += e.inputTokens || 0;
        provMap[p].output += e.outputTokens || 0;
        provMap[p].total += e.totalTokens || 0;
        provMap[p].costUSD += calcCostUSD(e.inputTokens || 0, e.outputTokens || 0, e.model || '');
      });
      const provBody = document.getElementById('aiu-providers-body');
      if (Object.keys(provMap).length === 0) {
        provBody.innerHTML = EMPTY_MSG(6);
      } else {
        provBody.innerHTML = Object.entries(provMap)
          .sort((a, b) => b[1].total - a[1].total)
          .map(([p, d]) => `<tr>
          <td style="font-weight:600;">${esc(p)}</td>
          <td>${fmtNum(d.requests)}</td>
          <td style="color:var(--text-sec);">${fmtNum(d.input)}</td>
          <td style="color:var(--text-sec);">${fmtNum(d.output)}</td>
          <td style="font-weight:700;color:var(--indigo);">${fmtNum(d.total)}</td>
          <td style="font-weight:700;color:#f59e0b;">${fmtCost(d.costUSD)}</td>
        </tr>`).join('');
      }

      // ‚îÄ‚îÄ Models table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const modMap = {};
      events.forEach(e => {
        const key = e.model || 'unknown';
        if (!modMap[key]) modMap[key] = { requests: 0, total: 0, input: 0, output: 0, costUSD: 0 };
        modMap[key].requests++;
        modMap[key].total += e.totalTokens || 0;
        modMap[key].input += e.inputTokens || 0;
        modMap[key].output += e.outputTokens || 0;
        modMap[key].costUSD += calcCostUSD(e.inputTokens || 0, e.outputTokens || 0, key);
      });
      const modBody = document.getElementById('aiu-models-body');
      if (Object.keys(modMap).length === 0) {
        modBody.innerHTML = EMPTY_MSG(5);
      } else {
        modBody.innerHTML = Object.entries(modMap)
          .sort((a, b) => b[1].total - a[1].total)
          .map(([m, d]) => {
            const avgTok = d.requests > 0 ? Math.round(d.total / d.requests) : 0;
            return `<tr>
            <td style="font-weight:600;font-size:0.75rem;">${esc(m)}</td>
            <td>${fmtNum(d.requests)}</td>
            <td style="font-weight:700;color:var(--indigo);">${fmtNum(d.total)}</td>
            <td style="color:var(--text-sec);">${fmtNum(avgTok)}</td>
            <td style="font-weight:700;color:#f59e0b;">${fmtCost(d.costUSD)}</td>
          </tr>`;
          }).join('');
      }

      // ‚îÄ‚îÄ Top chats table ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const chatMap = {};
      events.forEach(e => {
        const cid = e.chatId || 'unknown';
        if (!chatMap[cid]) chatMap[cid] = { name: e.chatName || cid, channel: e.channel || '‚Äî', requests: 0, input: 0, output: 0, total: 0, costUSD: 0, latSum: 0, latCnt: 0 };
        chatMap[cid].requests++;
        chatMap[cid].input += e.inputTokens || 0;
        chatMap[cid].output += e.outputTokens || 0;
        chatMap[cid].total += e.totalTokens || 0;
        chatMap[cid].costUSD += calcCostUSD(e.inputTokens || 0, e.outputTokens || 0, e.model || '');
        if (e.latencyMs) { chatMap[cid].latSum += e.latencyMs; chatMap[cid].latCnt++; }
      });
      const chatBody = document.getElementById('aiu-chats-body');
      const chatEntries = Object.values(chatMap).sort((a, b) => b.total - a.total).slice(0, 15);
      if (chatEntries.length === 0) {
        chatBody.innerHTML = EMPTY_MSG(8);
      } else {
        const CHAN_ICON = { telegram: '‚úà', web: 'üåê', api: '‚ö°' };
        chatBody.innerHTML = chatEntries.map(c => {
          const avgLat = c.latCnt > 0 ? Math.round(c.latSum / c.latCnt) : null;
          const latStr = avgLat ? `${avgLat} ms` : '‚Äî';
          const chanIco = CHAN_ICON[c.channel] || '‚Äî';
          return `<tr>
          <td style="font-weight:600;">${esc(c.name)}</td>
          <td style="color:var(--text-sec);">${chanIco} ${esc(c.channel)}</td>
          <td>${fmtNum(c.requests)}</td>
          <td style="color:var(--text-sec);">${fmtNum(c.input)}</td>
          <td style="color:var(--text-sec);">${fmtNum(c.output)}</td>
          <td style="font-weight:700;color:var(--indigo);">${fmtNum(c.total)}</td>
          <td style="font-weight:700;color:#f59e0b;">${fmtCost(c.costUSD)}</td>
          <td style="color:var(--text-dim);font-size:0.72rem;">${latStr}</td>
        </tr>`;
        }).join('');
      }
    }

    function exportAiUsageCsv() {
      const events = getAiUsageFiltered();
      if (events.length === 0) { showToast(I18n.t('noData')); return; }
      const cur = CURRENCIES[STATE.aiCurrency] || CURRENCIES.USD;
      const rows = [
        [I18n.t('date'), I18n.t('chats'), I18n.t('channel'), I18n.t('provider'), I18n.t('model'), I18n.t('inputTokens'), I18n.t('outputTokens'), I18n.t('totalTokens'), I18n.t('cost') + ' (' + cur.label + ')', I18n.t('latency'), I18n.t('status')],
        ...events.map(e => {
          const ts = e.createdAt?.seconds ? new Date(e.createdAt.seconds * 1000).toISOString() : '';
          const costUSD = calcCostUSD(e.inputTokens || 0, e.outputTokens || 0, e.model || '');
          const costVal = (costUSD * cur.rate).toFixed(6);
          return [ts, e.chatName || e.chatId || '', e.channel || '', e.provider || '', e.model || '',
            e.inputTokens || 0, e.outputTokens || 0, e.totalTokens || 0, costVal, e.latencyMs || '', e.status || 'ok'];
        })
      ];
      const csv = rows.map(r => r.map(v => `"${String(v).replace(/"/g, '""')}"`).join(',')).join('\n');
      const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `ai-usage-${STATE.aiUsagePeriod}d.csv`; a.click();
      URL.revokeObjectURL(url);
      showToast('‚úÖ ' + I18n.t('csvExported'));
    }

    /* ‚ïê‚ïê TOPICS ‚ïê‚ïê */
    const _topicExpanded = new Set();

    function toggleTopicExpand(id) {
      if (_topicExpanded.has(id)) _topicExpanded.delete(id);
      else _topicExpanded.add(id);
      renderTopics();
    }

    function renderTopics() {
      const tbody = document.getElementById('topics-body');
      const search = (document.getElementById('topic-search')?.value || '').toLowerCase();
      const count = document.getElementById('topics-count');

      // "–í—Å–µ —Ç–µ–º—ã" = only KB knowledge entries (upload / manual / YouTube)
      // Chat-originated questions from STATE.topics are NOT shown here
      const all = STATE.kbQA
        .filter(qa => qa.question)
        .map(qa => ({ id: qa.id, name: qa.question, answer: qa.answer, chats: qa.asked || 0, source: 'kb', lang: qa.lang || 'auto' }))
        .sort((a, b) => b.chats - a.chats);

      const filtered = all.filter(t => t.name.toLowerCase().includes(search));
      if (count) count.textContent = all.length;

      if (filtered.length === 0) {
        tbody.innerHTML = `<tr><td colspan="4"><div class="empty-state" style="padding:30px;"><div class="empty-icon" style="font-size:28px;">üìã</div><div class="empty-sub">–¢–µ–º –ø–æ–∫–∞ –Ω–µ—Ç. –î–æ–±–∞–≤—å—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π.</div></div></td></tr>`;
        return;
      }
      tbody.innerHTML = '';
      filtered.forEach(t => {
        const isExpanded = _topicExpanded.has(t.id);
        const hasAnswer = !!t.answer;
        const icon = `<span style="font-size:13px;margin-right:6px;">üìö</span>`;
        const countBadge = t.chats > 0
          ? `<span style="background:var(--primary-brd);color:var(--indigo);border-radius:20px;padding:2px 9px;font-size:0.7rem;font-weight:700;">${t.chats}√ó</span>`
          : `<span style="color:var(--text-dim);font-size:0.72rem;">‚Äî</span>`;
        const chevron = hasAnswer
          ? `<span style="color:var(--text-dim);font-size:11px;transition:transform 0.2s;display:inline-block;transform:rotate(${isExpanded ? 90 : 0}deg);">‚ñ∂</span>`
          : '';

        const langLabels = { auto: 'üåê', ru: 'üá∑üá∫ RU', en: 'üá∫üá∏ EN', uz: 'üá∫üáø UZ' };
        const langBadge = `<span style="font-size:0.65rem;padding:1px 6px;border-radius:4px;background:var(--bg-3);border:1px solid var(--border);color:var(--text-sec);cursor:pointer;" onclick="event.stopPropagation();cycleKbLang('${t.id}')" title="–Ø–∑—ã–∫ (–∫–ª–∏–∫–Ω–∏—Ç–µ —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å)">${langLabels[t.lang] || 'üåê'}</span>`;

        const menuId = `topic-menu-${t.id}`;
        const menuBtn = `<div style="position:relative;display:inline-block;">
          <span style="color:var(--text-dim);cursor:pointer;font-size:18px;letter-spacing:1px;" onclick="event.stopPropagation();toggleTopicMenu('${menuId}')">¬∑¬∑¬∑</span>
          <div id="${menuId}" class="topic-dropdown" style="display:none;">
            <button onclick="event.stopPropagation();editKbItem('${t.id}');closeAllTopicMenus()">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç</button>
            <button onclick="event.stopPropagation();fsDel('kbQA','${t.id}');closeAllTopicMenus()" style="color:var(--red);">üóë –£–¥–∞–ª–∏—Ç—å</button>
          </div>
        </div>`;

        const tr = document.createElement('tr');
        tr.style.cursor = hasAnswer ? 'pointer' : '';
        if (hasAnswer) tr.onclick = () => toggleTopicExpand(t.id);
        tr.innerHTML = `
        <td><div class="td-name" style="gap:6px;">${icon}<span style="flex:1;">${esc(t.name)}</span>${chevron}</div></td>
        <td>${countBadge}</td>
        <td class="td-muted" style="white-space:nowrap;">üìö –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π ${langBadge}</td>
        <td onclick="event.stopPropagation()">${menuBtn}</td>`;
        tbody.appendChild(tr);

        // Expanded answer row
        if (isExpanded && hasAnswer) {
          const expandTr = document.createElement('tr');
          expandTr.innerHTML = `
          <td colspan="4" style="padding:0;">
            <div style="background:var(--bg);border-top:1px solid var(--border);padding:12px 16px 14px 42px;font-size:0.78rem;color:var(--text-sec);line-height:1.6;white-space:pre-wrap;">${esc(t.answer)}
              <div style="margin-top:8px;"><button class="btn-secondary" style="font-size:0.68rem;padding:3px 10px;" onclick="event.stopPropagation();editKbItem('${t.id}')">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button></div>
            </div>
          </td>`;
          tbody.appendChild(expandTr);
        }
      });
    }

    function toggleTopicMenu(id) {
      closeAllTopicMenus();
      const el = document.getElementById(id);
      if (el) el.style.display = el.style.display === 'none' ? 'block' : 'none';
    }
    function closeAllTopicMenus() {
      document.querySelectorAll('.topic-dropdown').forEach(d => d.style.display = 'none');
    }
    document.addEventListener('click', closeAllTopicMenus);

    function editKbItem(id) {
      const item = STATE.kbQA.find(q => q.id === id);
      if (!item) { showToast('‚ö†Ô∏è ' + I18n.t('itemNotFound')); return; }
      openEditAnswer(id, item.question || '', item.answer || '', 'kb');
    }

    async function cycleKbLang(id) {
      if (!currentUser) return;
      const item = STATE.kbQA.find(q => q.id === id);
      if (!item) return;
      const langs = ['auto', 'ru', 'en', 'uz'];
      const cur = item.lang || 'auto';
      const next = langs[(langs.indexOf(cur) + 1) % langs.length];
      await col('kbQA').doc(id).update({ lang: next }).catch(() => {});
      // STATE updates via Firestore listener
    }

    function removeTopic(id) {
      fsDel('topics', id);
    }

    /* ‚ïê‚ïê KNOWLEDGE BASE DRAWER LOGIC (UX Pack v1) ‚ïê‚ïê */

    // ‚îÄ‚îÄ Status bar ‚îÄ‚îÄ
    function updateStatusBar({ activeBotName, kbCount, tgConnected } = {}) {
      const elBot = document.getElementById('cs-activebot');
      const elKb = document.getElementById('cs-kb');
      const elTg = document.getElementById('cs-tg');
      if (elBot) elBot.textContent = `‚óè Bot: ${activeBotName || '‚Äî'}`;
      if (elKb) elKb.textContent = `üìö KB: ${typeof kbCount === 'number' ? kbCount : '‚Äî'}`;
      if (elTg) elTg.textContent = '‚úà TG: ' + (tgConnected ? I18n.t('telegramConnected') : '‚Äî');
    }

    // ‚îÄ‚îÄ Drawer open / close ‚îÄ‚îÄ
    function openKBDrawer() {
      const drawer = document.getElementById('kb-drawer');
      const backdrop = document.getElementById('kb-backdrop');
      if (!drawer || !backdrop) return;
      drawer.classList.remove('hidden');
      backdrop.classList.remove('hidden');
      drawer.setAttribute('aria-hidden', 'false');
      loadKBListSafe();
    }
    function closeKBDrawer() {
      const drawer = document.getElementById('kb-drawer');
      const backdrop = document.getElementById('kb-backdrop');
      if (!drawer || !backdrop) return;
      drawer.classList.add('hidden');
      backdrop.classList.add('hidden');
      drawer.setAttribute('aria-hidden', 'true');
    }

    // ‚îÄ‚îÄ Render helpers ‚îÄ‚îÄ
    function renderKBList(items, botId) {
      const emptyEl = document.getElementById('kb-empty');
      const listEl = document.getElementById('kb-list');
      if (!emptyEl || !listEl) return;

      if (!items || items.length === 0) {
        emptyEl.classList.remove('hidden');
        listEl.classList.add('hidden');
        listEl.innerHTML = '';
        return;
      }
      emptyEl.classList.add('hidden');
      listEl.classList.remove('hidden');
      listEl.innerHTML = '';

      const frag = document.createDocumentFragment();
      items.forEach(it => {
        const card = document.createElement('div');
        card.className = 'kb-item';

        const titleEl = document.createElement('div');
        titleEl.className = 'kb-item-title';
        titleEl.textContent = it.title || it.name || it.url || I18n.t('noTitle');

        const subEl = document.createElement('div');
        subEl.className = 'kb-item-sub';
        const typeLabel = it.type === 'file' ? 'üìÑ —Ñ–∞–π–ª' : it.type === 'url' ? 'üîó —Å—Å—ã–ª–∫–∞' : 'üìù —Ç–µ–∫—Å—Ç';
        subEl.innerHTML = `<span>${typeLabel}</span><span>${it.createdAtText || ''}</span>`;

        const actEl = document.createElement('div');
        actEl.className = 'kb-item-actions';

        const btnOpen = document.createElement('button');
        btnOpen.className = 'kb-btn'; btnOpen.type = 'button';
        btnOpen.textContent = it.type === 'text' ? I18n.t('edit') : I18n.t('open');
        btnOpen.onclick = () => {
          if (it.type === 'text') {
            editKBItemText(botId || it._botId, it._id, it.title || it.name || '', it.content || it.text || '');
          } else {
            const link = it.fileUrl || it.downloadURL || it.url;
            if (link) window.open(link, '_blank', 'noopener,noreferrer');
          }
        }; const btnDel = document.createElement('button');
        btnDel.className = 'kb-btn kb-btn-delete'; btnDel.type = 'button'; btnDel.textContent = I18n.t('delete');
        btnDel.onclick = () => deleteKBItem(botId || it._botId, it._id);

        actEl.appendChild(btnOpen);
        actEl.appendChild(btnDel);
        card.appendChild(titleEl);
        card.appendChild(subEl);
        card.appendChild(actEl);
        frag.appendChild(card);
      });
      listEl.appendChild(frag);
    }

    // ‚îÄ‚îÄ Firestore load ‚îÄ‚îÄ
    async function loadKBListSafe() {
      if (!window.resolvedUid) { renderKBList([]); return; }
      try {
        const sessionSnap = await db.collection("users").doc(window.resolvedUid)
          .collection("chat_os_sessions").doc("default").get();
        const activeBotId = sessionSnap.exists ? sessionSnap.data().activeBotId : null;
        if (activeBotId) {
          await loadKBList(activeBotId);
          loadKbSuggestions(activeBotId); // load pending suggestions tab
        } else {
          renderKBList([]);
        }
      } catch (e) {
        console.error('[ChatOS][KB] loadKBListSafe error', e);
        renderKBList([]);
      }
    }

    async function loadKBList(botId) {
      renderKBList([]); // show empty while loading
      try {
        const snap = await db.collection("users").doc(window.resolvedUid)
          .collection("bots").doc(botId)
          .collection("knowledge_base")
          .orderBy("createdAt", "desc")
          .get();

        const items = snap.docs.map(doc => {
          const d = doc.data();
          const dateStr = d.createdAt ? d.createdAt.toDate().toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' }) : '';
          return { ...d, _id: doc.id, _botId: botId, createdAtText: dateStr };
        });
        renderKBList(items, botId);
      } catch (e) {
        console.error('[ChatOS][KB] loadKBList error', e);
        renderKBList([]);
      }
    }

    async function deleteKBItem(botId, itemId) {
      if (!botId || !itemId) return;
      const ok = await showInlineConfirm({
        title: I18n.t('deleteSourceTitle'),
        text: I18n.t('deleteSourceText'),
        okText: I18n.t('delete'), cancelText: I18n.t('cancel')
      });
      if (!ok) return;
      try {
        await db.collection("users").doc(window.resolvedUid)
          .collection("bots").doc(botId)
          .collection("knowledge_base").doc(itemId).delete();
        await loadKBList(botId);
        // Update KB count in status bar
        const snap = await db.collection("users").doc(window.resolvedUid)
          .collection("bots").doc(botId).collection("knowledge_base").get();
        const elKb = document.getElementById('cs-kb');
        if (elKb) elKb.textContent = `üìö KB: ${snap.size}`;
      } catch (e) {
        console.error('[ChatOS][KB] deleteKBItem error', e);
        showToast(I18n.t('errorDeleting'));
      }
    }

    // ‚îÄ‚îÄ Edit text KB item ‚îÄ‚îÄ
    function editKBItemText(botId, itemId, currentTitle, currentContent) {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay open';
      overlay.style.zIndex = '99999';

      // Basic escape utility for inserting values into HTML
      const escapeHtml = (str) => {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
      };

      overlay.innerHTML = `
        <div class="modal" style="display:flex; flex-direction:column; gap:16px;">
          <div class="modal-header">
            <h3>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç</h3>
            <button class="modal-close" id="edit-kb-close">‚úï</button>
          </div>
          <input type="text" id="edit-kb-title" class="input" value="${escapeHtml(currentTitle)}" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫" />
          <textarea id="edit-kb-content" class="input" rows="8" placeholder="–¢–µ–∫—Å—Ç">${escapeHtml(currentContent)}</textarea>
          <button id="edit-kb-save" class="btn btn-primary" style="width:100%">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
      `;
      document.body.appendChild(overlay);

      document.getElementById('edit-kb-close').onclick = () => overlay.remove();
      document.getElementById('edit-kb-save').onclick = async () => {
        const newTitle = document.getElementById('edit-kb-title').value.trim();
        const newContent = document.getElementById('edit-kb-content').value.trim();
        if (!newTitle || !newContent) return showToast(I18n.t('fillFields'));

        const btn = document.getElementById('edit-kb-save');
        btn.disabled = true;
        btn.textContent = '–°–æ—Ö—Ä–∞–Ω—è—é...';

        try {
          await db.collection("users").doc(window.resolvedUid)
            .collection("bots").doc(botId)
            .collection("knowledge_base").doc(itemId).update({
              title: newTitle,
              content: newContent,
              type: "text"
            });

          try {
            await db.collection("users").doc(window.resolvedUid)
              .collection("bots").doc(botId)
              .collection("knowledge_items").doc(itemId).update({
                title: newTitle,
                contentPreview: newContent.substring(0, 120),
                type: "text"
              });
          } catch (e) { }

          showToast('‚úÖ ' + I18n.t('updated'));
          overlay.remove();
          loadKBList(botId);
        } catch (e) {
          showToast('‚ùå ' + I18n.t('error') + ': ' + e.message);
          btn.disabled = false;
          btn.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        }
      };
    }

    // ‚îÄ‚îÄ In-chat confirm (replaces window.confirm) ‚îÄ‚îÄ
    let __confirmResolve = null;
    function showInlineConfirm({ title, text, okText, cancelText } = {}) {
      const modal = document.getElementById('chat-confirm');
      if (!modal) return Promise.resolve(false);
      const t = document.getElementById('cc-title');
      const d = document.getElementById('cc-text');
      const ok = document.getElementById('cc-ok');
      const cancel = document.getElementById('cc-cancel');
      if (t) t.textContent = title || '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –¥–µ–π—Å—Ç–≤–∏–µ';
      if (d) d.textContent = text || '–í—ã —É–≤–µ—Ä–µ–Ω—ã?';
      if (ok) ok.textContent = okText || '–û–ö';
      if (cancel) cancel.textContent = cancelText || '–û—Ç–º–µ–Ω–∞';
      modal.classList.remove('hidden');
      return new Promise(resolve => { __confirmResolve = resolve; });
    }
    function hideInlineConfirm(result) {
      const modal = document.getElementById('chat-confirm');
      if (modal) modal.classList.add('hidden');
      if (__confirmResolve) { __confirmResolve(!!result); __confirmResolve = null; }
    }
    // Bindings for confirm buttons (safe ‚Äî run after DOM ready)
    (function bindConfirmButtons() {
      const ok = document.getElementById('cc-ok');
      const cancel = document.getElementById('cc-cancel');
      if (ok) ok.addEventListener('click', () => hideInlineConfirm(true));
      if (cancel) cancel.addEventListener('click', () => hideInlineConfirm(false));
    })();
    // Bindings for KB drawer buttons
    (function bindKBButtons() {
      const btnKb = document.getElementById('btn-kb');
      const btnOpen = document.getElementById('btn-open-kb');
      const kbClose = document.getElementById('kb-close');
      const backdrop = document.getElementById('kb-backdrop');
      const refresh = document.getElementById('kb-refresh');
      if (btnKb) btnKb.addEventListener('click', openKBDrawer);
      if (btnOpen) btnOpen.addEventListener('click', openKBDrawer);
      if (kbClose) kbClose.addEventListener('click', closeKBDrawer);
      if (backdrop) backdrop.addEventListener('click', closeKBDrawer);
      if (refresh) refresh.addEventListener('click', loadKBListSafe);
    })();

    /* ‚ïê‚ïê CHATS ‚ïê‚ïê */
    let _chatViewUnsub = null;
    let _handoffTimerInterval = null;

    function updateHandoffStatus(mode, handoffAtSeconds) {
      const badge = document.getElementById('chat-mode-badge');
      const timerEl = document.getElementById('handoff-timer');
      const resumeBtn = document.getElementById('resume-ai-btn');
      if (!badge) return;

      if (_handoffTimerInterval) { clearInterval(_handoffTimerInterval); _handoffTimerInterval = null; }
      if (timerEl) timerEl.style.display = 'none';

      if (mode === 'human') {
        badge.className = 'mode-badge human';
        badge.textContent = 'üßë‚Äçüíº –û–ø–µ—Ä–∞—Ç–æ—Ä –æ—Ç–≤–µ—á–∞–µ—Ç';
        if (resumeBtn) resumeBtn.style.display = '';
        const HANDOFF_SEC = 5 * 60;
        const tick = () => {
          const elapsed = Date.now() / 1000 - handoffAtSeconds;
          const remaining = HANDOFF_SEC - elapsed;
          if (remaining <= 0) {
            clearInterval(_handoffTimerInterval); _handoffTimerInterval = null;
            badge.className = 'mode-badge ai'; badge.textContent = 'ü§ñ –ò–ò –æ—Ç–≤–µ—á–∞–µ—Ç';
            if (timerEl) timerEl.style.display = 'none';
            if (resumeBtn) resumeBtn.style.display = 'none';
            return;
          }
          const m = Math.floor(remaining / 60), s = Math.floor(remaining % 60);
          if (timerEl) { timerEl.style.display = ''; timerEl.textContent = `–ò–ò –≤–µ—Ä–Ω—ë—Ç—Å—è —á–µ—Ä–µ–∑ ${m}:${String(s).padStart(2, '0')}`; }
        };
        tick();
        _handoffTimerInterval = setInterval(tick, 1000);
      } else {
        badge.className = 'mode-badge ai';
        badge.textContent = 'ü§ñ –ò–ò –æ—Ç–≤–µ—á–∞–µ—Ç';
        if (resumeBtn) resumeBtn.style.display = 'none';
        if (timerEl) timerEl.style.display = 'none';
      }
    }

    async function resumeAI() {
      if (!STATE.selectedChatId || !currentUser) return;
      const btn = document.getElementById('resume-ai-btn');
      if (btn) btn.disabled = true;
      try {
        await db.collection('users').doc(currentUser.uid).collection('chats').doc(STATE.selectedChatId).update({
          mode: 'ai',
          handoffAt: firebase.firestore.FieldValue.delete(),
        });
        updateHandoffStatus('ai', null);
        showToast('ü§ñ ' + I18n.t('aiResumed'));
      } catch (e) {
        showToast('‚ö†Ô∏è ' + I18n.t('error') + ': ' + e.message);
      } finally {
        if (btn) btn.disabled = false;
      }
    }

    async function sendAdminMessage() {
      const input = document.getElementById('admin-reply-input');
      const text = input?.value.trim();
      if (!text || !STATE.selectedChatId || !currentUser) return;

      const chat = STATE.chats.find(c => c.id === STATE.selectedChatId);
      if (!chat?.botId) { showToast('‚ö†Ô∏è ' + I18n.t('botNotFound')); return; }

      input.value = '';
      input.style.height = '';

      try {
        const resp = await fetch('/api/admin-send-message', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ uid: currentUser.uid, chatId: STATE.selectedChatId, botId: chat.botId, text }),
        });
        if (!resp.ok) {
          const err = await resp.json().catch(() => ({}));
          showToast('‚ö†Ô∏è ' + (err.error || I18n.t('errorSending')));
        }
      } catch (e) {
        showToast('‚ö†Ô∏è ' + I18n.t('networkError'));
      }
    }

    function renderChats() {
      const el = document.getElementById('chat-list-panel');
      const countEl = document.getElementById('chats-count');
      if (countEl) countEl.textContent = STATE.chats.length;
      if (!el) return;

      if (STATE.chats.length === 0) {
        el.innerHTML = `<div class="empty-state" style="padding:30px 16px;"><div class="empty-icon" style="font-size:28px;">üí¨</div><div class="empty-sub" style="font-size:0.72rem;">–°–æ–æ–±—â–µ–Ω–∏–π –ø–æ–∫–∞ –Ω–µ—Ç. –ù–∞–ø–∏—à–∏—Ç–µ –±–æ—Ç—É –≤ Telegram.</div></div>`;
        return;
      }

      const sorted = [...STATE.chats].sort((a, b) => {
        const ta = a.lastTs?.seconds || 0, tb = b.lastTs?.seconds || 0;
        return tb - ta;
      });

      el.innerHTML = '';
      sorted.forEach(chat => {
        const initial = (chat.name || '?').charAt(0).toUpperCase();
        const ts = chat.lastTs?.seconds;
        const time = ts ? new Date(ts * 1000).toLocaleTimeString('ru', { hour: '2-digit', minute: '2-digit' }) : '';
        const isHuman = (chat.mode || 'ai') === 'human';
        const div = document.createElement('div');
        div.className = 'chat-list-item' + (STATE.selectedChatId === chat.id ? ' active' : '');
        div.onclick = () => openChatView(chat);
        div.innerHTML = `
        <div style="display:flex;align-items:center;gap:10px;">
          <div class="chat-list-av">${esc(initial)}</div>
          <div style="flex:1;min-width:0;">
            <div style="display:flex;align-items:center;justify-content:space-between;gap:6px;">
              <div class="chat-list-name">${esc(chat.name || I18n.t('userName'))}</div>
              <div style="display:flex;align-items:center;gap:4px;">
                ${isHuman ? '<span style="font-size:9px;background:rgba(34,197,94,0.2);color:var(--green);border-radius:20px;padding:1px 5px;font-weight:700;">–û–ü</span>' : ''}
                <div class="chat-list-time">${time}</div>
              </div>
            </div>
            <div class="chat-list-preview">${esc(chat.lastMessage || '')}</div>
          </div>
        </div>`;
        el.appendChild(div);
      });

      // Refresh mode indicator if selected chat's mode changed
      if (STATE.selectedChatId) {
        const selChat = STATE.chats.find(c => c.id === STATE.selectedChatId);
        if (selChat) updateHandoffStatus(selChat.mode || 'ai', selChat.handoffAt?.seconds || 0);
      }
    }

    function renderChatMessages(messages, chat) {
      const msgsEl = document.getElementById('chat-view-messages');
      if (!msgsEl) return;
      if (messages.length === 0) {
        msgsEl.innerHTML = `<div class="empty-state" style="margin:auto;"><div class="empty-sub">–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</div></div>`;
        return;
      }
      const wasAtBottom = msgsEl.scrollHeight - msgsEl.scrollTop - msgsEl.clientHeight < 60;
      msgsEl.innerHTML = '';
      const initial = (chat.name || '?').charAt(0).toUpperCase();
      messages.forEach(msg => {
        const isUser = msg.role === 'user';
        const isAdmin = msg.sentByAdmin === true;
        const cleanContent = (msg.content || '').replace(/\*\*(.+?)\*\*/gs, '$1').replace(/\*(.+?)\*/gs, '$1');
        const wrap = document.createElement('div');
        wrap.style.cssText = `display:flex;align-items:flex-end;gap:8px;${isUser ? 'flex-direction:row-reverse;' : ''}`;
        const av = isUser
          ? `<div style="width:28px;height:28px;border-radius:50%;background:var(--primary);color:#fff;display:flex;align-items:center;justify-content:center;font-size:0.72rem;font-weight:700;flex-shrink:0;">${esc(initial)}</div>`
          : isAdmin
            ? `<div style="width:28px;height:28px;border-radius:50%;background:rgba(34,197,94,0.15);border:1px solid rgba(34,197,94,0.3);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;">üßë‚Äçüíº</div>`
            : `<div style="width:28px;height:28px;border-radius:50%;background:var(--surface2);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;">ü§ñ</div>`;
        const bubbleClass = isUser ? 'msg-bubble-user' : 'msg-bubble-bot';
        const adminLabel = isAdmin ? `<div style="font-size:0.6rem;color:var(--green);margin-bottom:2px;font-weight:700;">–û–ø–µ—Ä–∞—Ç–æ—Ä</div>` : '';
        const bubble = `<div style="display:flex;flex-direction:column;max-width:68%;">${adminLabel}<div class="${bubbleClass}">${esc(cleanContent)}</div></div>`;
        wrap.innerHTML = `${av}${bubble}`;
        msgsEl.appendChild(wrap);
      });
      if (wasAtBottom || true) msgsEl.scrollTop = msgsEl.scrollHeight;
    }

    function openChatView(chat) {
      STATE.selectedChatId = chat.id;
      renderChats();

      const header = document.getElementById('chat-view-header');
      const nameEl = document.getElementById('chat-view-name');
      const usernameEl = document.getElementById('chat-view-username');
      const msgsEl = document.getElementById('chat-view-messages');
      const replyArea = document.getElementById('admin-reply-area');

      // User card
      nameEl.textContent = chat.name || I18n.t('userName');
      const uname = chat.username ? chat.username.replace(/^@/, '') : '';
      usernameEl.textContent = uname ? `@${uname}` : '';
      usernameEl.href = uname ? `https://t.me/${uname}` : '#';
      usernameEl.style.display = uname ? '' : 'none';

      // Avatar
      const avEl = document.getElementById('chat-card-av');
      if (avEl) {
        const colors = ['#6366f1', '#22c55e', '#f59e0b', '#ec4899', '#06b6d4'];
        avEl.style.background = colors[(chat.name || '').charCodeAt(0) % colors.length];
        avEl.textContent = (chat.name || '?').charAt(0).toUpperCase();
      }

      // Meta: date + message count
      const dateEl = document.getElementById('chat-card-date');
      if (dateEl) {
        const ts = chat._ts?.seconds || chat.lastTs?.seconds;
        dateEl.textContent = ts ? new Date(ts * 1000).toLocaleDateString('ru', { day: 'numeric', month: 'short', year: 'numeric' }) : '‚Äî';
      }
      const msgsCountEl = document.getElementById('chat-card-msgs');
      if (msgsCountEl) msgsCountEl.textContent = chat.msgCount || 1;

      // Notes
      const notesEl = document.getElementById('chat-notes-input');
      if (notesEl) { notesEl.value = chat.notes || ''; notesEl.style.height = 'auto'; }

      header.style.display = 'block';
      if (replyArea) replyArea.style.display = '';
      msgsEl.innerHTML = `<div style="text-align:center;color:var(--text-dim);font-size:0.75rem;padding:20px;">–ó–∞–≥—Ä—É–∂–∞—é...</div>`;

      // Set initial mode indicator
      updateHandoffStatus(chat.mode || 'ai', chat.handoffAt?.seconds || 0);

      // Unsubscribe from previous chat
      if (_chatViewUnsub) { _chatViewUnsub(); _chatViewUnsub = null; }

      // Real-time listener for this chat's history
      _chatViewUnsub = db.collection('users').doc(currentUser.uid)
        .collection('chatHistory').doc(chat.id)
        .onSnapshot(snap => {
          const messages = snap.exists ? (snap.data().messages || []) : [];
          renderChatMessages(messages, chat);
        }, () => {
          msgsEl.innerHTML = `<div class="empty-state" style="margin:auto;"><div class="empty-sub">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</div></div>`;
        });
    }

    function saveNotes(text) {
      if (!STATE.selectedChatId || !currentUser) return;
      col('chats').doc(STATE.selectedChatId).set({ notes: text }, { merge: true }).catch(() => { });
    }

    /* ‚ïê‚ïê BROADCAST ‚ïê‚ïê */
    function _broadcastCounts() {
      const bot = STATE.bots.find(b => b.id === STATE.currentBotId);
      if (!bot) return { all: 0, month: 0, week: 0 };
      const now = Date.now();
      const chats = STATE.chats.filter(c => c.botId === bot.id);
      return {
        all: chats.length,
        month: chats.filter(c => (c.lastTs?.seconds || 0) * 1000 >= now - 30 * 864e5).length,
        week: chats.filter(c => (c.lastTs?.seconds || 0) * 1000 >= now - 7 * 864e5).length,
      };
    }

    function updateBroadcastCount() {
      const counts = _broadcastCounts();
      document.getElementById('bc-cnt-all').textContent = counts.all;
      document.getElementById('bc-cnt-month').textContent = counts.month;
      document.getElementById('bc-cnt-week').textContent = counts.week;
      const filter = document.querySelector('input[name="bc-filter"]:checked')?.value || 'all';
      const n = counts[filter] || 0;
      document.getElementById('bc-send-btn').textContent = `–û—Ç–ø—Ä–∞–≤–∏—Ç—å (${n})`;
    }

    function openBroadcastModal() {
      document.getElementById('bc-text').value = '';
      document.getElementById('bc-status').textContent = '';
      document.getElementById('modal-broadcast').classList.add('open');
      updateBroadcastCount();
    }

    function closeBroadcastModal() {
      document.getElementById('modal-broadcast').classList.remove('open');
    }
    document.getElementById('modal-broadcast').addEventListener('click', e => { if (e.target === e.currentTarget) closeBroadcastModal(); });

    async function sendBroadcast() {
      const text = document.getElementById('bc-text').value.trim();
      if (!text) { document.getElementById('bc-status').textContent = '‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è'; return; }
      const bot = STATE.bots.find(b => b.id === STATE.currentBotId);
      if (!bot) { document.getElementById('bc-status').textContent = '‚ö†Ô∏è –í—ã–±–µ—Ä–∏—Ç–µ –±–æ—Ç–∞'; return; }
      const filter = document.querySelector('input[name="bc-filter"]:checked')?.value || 'all';

      const btn = document.getElementById('bc-send-btn');
      btn.disabled = true;
      document.getElementById('bc-status').textContent = '‚è≥ –û—Ç–ø—Ä–∞–≤–ª—è—é...';

      try {
        const resp = await fetch('/api/broadcast-message', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ uid: currentUser.uid, botId: bot.id, text, filter }),
        });
        const data = await resp.json();
        if (data.ok) {
          document.getElementById('bc-status').textContent = `‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: ${data.sent}, –æ—à–∏–±–æ–∫: ${data.failed}`;
          btn.disabled = false;
          setTimeout(closeBroadcastModal, 2000);
        } else {
          document.getElementById('bc-status').textContent = '‚ö†Ô∏è ' + (data.error || '–û—à–∏–±–∫–∞');
          btn.disabled = false;
        }
      } catch {
        document.getElementById('bc-status').textContent = '‚ö†Ô∏è –°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞';
        btn.disabled = false;
      }
    }

    /* ‚ïê‚ïê SEARCH ‚ïê‚ïê */
    function onSearch() {
      const q = document.getElementById('global-search').value.toLowerCase();
      if (STATE.currentTab === 'auto') {
        document.querySelectorAll('.auto-card').forEach(c => {
          const name = c.querySelector('.auto-name')?.textContent?.toLowerCase() || '';
          c.style.display = name.includes(q) || q === '' ? '' : 'none';
        });
      }
    }

    /* ‚ïê‚ïê AGENT STATUS TOGGLE ‚ïê‚ïê */
    async function toggleAgentStatus() {
      STATE.agentActive = !STATE.agentActive;
      applyAgentStatus();
      if (currentUser) {
        await db.collection('users').doc(currentUser.uid).collection('settings').doc('agent')
          .set({ active: STATE.agentActive }, { merge: true });
        // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∏–ª–∏ —É–¥–∞–ª—è–µ–º webhooks –¥–ª—è –≤—Å–µ—Ö –±–æ—Ç–æ–≤
        const botsSnap = await db.collection('users').doc(currentUser.uid).collection('bots').get();
        botsSnap.forEach(doc => {
          const { token } = doc.data();
          if (token) registerTelegramWebhook(currentUser.uid, doc.id, token, !STATE.agentActive);
        });
      }
      showToast(STATE.agentActive ? '‚úÖ –ê–≥–µ–Ω—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω' : '‚è∏ –ê–≥–µ–Ω—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
    }

    function applyAgentStatus() {
      const sw = document.getElementById('status-sw');
      const lbl = document.getElementById('status-lbl');
      const chatStatus = document.getElementById('chat-head-status');
      // Also sync overview status toggles
      const ovSw = document.getElementById('ov-status-sw');
      const ovLbl = document.getElementById('ov-status-lbl');
      if (STATE.agentActive) {
        sw?.classList.add('on');
        ovSw?.classList.add('on');
        if (lbl) { lbl.textContent = I18n.t('active'); lbl.className = 'toggle-text on'; }
        if (ovLbl) { ovLbl.textContent = I18n.t('active'); ovLbl.className = 'toggle-text on'; }
        if (chatStatus) { chatStatus.textContent = '‚óè –æ–Ω–ª–∞–π–Ω'; chatStatus.style.color = 'var(--green)'; }
      } else {
        sw?.classList.remove('on');
        ovSw?.classList.remove('on');
        if (lbl) { lbl.textContent = I18n.t('inactive'); lbl.className = 'toggle-text off'; }
        if (ovLbl) { ovLbl.textContent = I18n.t('inactive'); ovLbl.className = 'toggle-text off'; }
        if (chatStatus) { chatStatus.textContent = '‚óã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω'; chatStatus.style.color = 'var(--text-dim)'; }
      }
    }

    /* ‚ïê‚ïê RULES ‚ïê‚ïê */
    function renderRulesScreen() {
      const ta = document.getElementById('rules-ta');
      if (ta) ta.value = STATE.rules;
      const warn = document.getElementById('rules-no-rules-warn');
      if (warn) warn.style.display = STATE.rules.trim() ? 'none' : 'flex';
    }

    async function saveRules() {
      const text = document.getElementById('rules-ta')?.value.trim() || '';
      STATE.rules = text;
      if (currentUser) {
        await db.collection('users').doc(currentUser.uid).collection('settings').doc('rules')
          .set({ text }, { merge: true });
      }
      document.getElementById('rules-no-rules-warn').style.display = text ? 'none' : 'flex';
      showToast('üíæ ' + I18n.t('rulesSaved'));
    }

    async function autoGenerateRules() {
      const allKb = [...STATE.kbItems, ...STATE.kbQA];
      if (allKb.length === 0) {
        showToast('‚ö†Ô∏è ' + I18n.t('addKbFirst'));
        return;
      }

      const btn = document.querySelector('[onclick="autoGenerateRules()"]');
      if (btn) { btn.disabled = true; btn.textContent = '‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É—é...'; }

      // Build KB summary (max 30 items, truncated)
      const kbSummary = allKb.slice(0, 30).map(i => {
        const q = (i.title || i.question || '').slice(0, 100);
        const a = (i.content || i.answer || '').slice(0, 200);
        return `Q: ${q}\nA: ${a}`;
      }).join('\n\n');

      try {
        const resp = await fetch('/api/ai-chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            question: `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –±–∞–∑—É –∑–Ω–∞–Ω–∏–π –Ω–∏–∂–µ –∏ —Å–æ–∑–¥–∞–π –∏–¥–µ–∞–ª—å–Ω—ã–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –¥–ª—è –ò–ò-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞.

–¢–†–ï–ë–û–í–ê–ù–ò–Ø –ö –ü–†–û–ú–ü–¢–£:
1. –û–ø—Ä–µ–¥–µ–ª–∏ —Ç–µ–º–∞—Ç–∏–∫—É –±–∏–∑–Ω–µ—Å–∞ –ø–æ —Å–æ–¥–µ—Ä–∂–∞–Ω–∏—é –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π (—Ä–µ—Å—Ç–æ—Ä–∞–Ω, –º–∞–≥–∞–∑–∏–Ω, –æ–±—É—á–µ–Ω–∏–µ –∏ —Ç.–¥.)
2. –û–ø–∏—à–∏ —Ä–æ–ª—å –±–æ—Ç–∞ (–∫—Ç–æ –æ–Ω, –¥–ª—è –∫–æ–≥–æ —Ä–∞–±–æ—Ç–∞–µ—Ç)
3. –ó–∞–¥–∞–π —Ç–æ–Ω –æ–±—â–µ–Ω–∏—è (–¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∏ —Ç.–¥.)
4. –£–∫–∞–∂–∏ –ø—Ä–∞–≤–∏–ª–∞: –∫–∞–∫ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è, –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ —Ç–µ–º–µ, –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –Ω–µ –ø–æ —Ç–µ–º–µ
5. –£–∫–∞–∂–∏ –∑–∞–ø—Ä–µ—Ç—ã: –Ω–µ –ø—Ä–∏–¥—É–º—ã–≤–∞—Ç—å —Ü–µ–Ω—ã/—É—Å–ª–æ–≤–∏—è, –Ω–µ –¥–∞–≤–∞—Ç—å –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö/—é—Ä–∏–¥–∏—á–µ—Å–∫–∏—Ö —Å–æ–≤–µ—Ç–æ–≤ –µ—Å–ª–∏ –Ω–µ –ø–æ —Ç–µ–º–µ
6. –£–∫–∞–∂–∏ —á—Ç–æ –¥–µ–ª–∞—Ç—å –µ—Å–ª–∏ –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞ (–ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å —Å–≤—è–∑–∞—Ç—å—Å—è —Å –º–æ–¥–µ—Ä–∞—Ç–æ—Ä–æ–º —á–µ—Ä–µ–∑ https://t.me/–≤–∞—à_–ª–∏–Ω–∫)
7. –Ø–∑—ã–∫: –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —è–∑—ã–∫–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

–ù–ï –ü–ï–†–ï–ß–ò–°–õ–Ø–ô –≤–æ–ø—Ä–æ—Å—ã –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π! –°–æ–∑–¥–∞–π –∏–º–µ–Ω–Ω–æ –ü–†–ê–í–ò–õ–ê –ü–û–í–ï–î–ï–ù–ò–Ø –±–æ—Ç–∞.
–ü—Ä–æ–º–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å 10-15 —Å—Ç—Ä–æ–∫, –ª–∞–∫–æ–Ω–∏—á–Ω—ã–π –∏ —á—ë—Ç–∫–∏–π.

–ë–ê–ó–ê –ó–ù–ê–ù–ò–ô:
${kbSummary}`,
            provider: STATE.aiProvider || 'openai',
            model: STATE.aiModel || 'gpt-4o-mini'
          })
        });
        const data = await resp.json();
        if (data.answer) {
          document.getElementById('rules-ta').value = data.answer;
          showToast('‚ú® ' + I18n.t('promptGenerated') + ' ' + I18n.t('save') + '!');
        } else {
          showToast('‚ö†Ô∏è ' + I18n.t('error') + ' ' + I18n.t('generate') + '!');
        }
      } catch (e) {
        console.error(e);
        showToast('‚ö†Ô∏è ' + I18n.t('error') + ': ' + e.message);
      } finally {
        if (btn) { btn.disabled = false; btn.textContent = '‚ú® –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π'; }
      }
    }

    /* ‚ïê‚ïê ANALYTICS ‚ïê‚ïê */
    function renderAnalytics() {
      const days = STATE.analyticsPeriod;
      const cutoff = new Date();
      cutoff.setDate(cutoff.getDate() - days);

      // Use chats collection for dialog count (has lastTs, one doc per user)
      const filteredChats = STATE.chats.filter(c => {
        if (!c.lastTs) return true;
        const ts = c.lastTs.toDate ? c.lastTs.toDate() : new Date(c.lastTs.seconds * 1000);
        return ts >= cutoff;
      });

      // Topics from Telegram (each is one user message event)
      const filteredTopics = STATE.topics.filter(t => {
        const rawTs = t._ts || t.ts;
        if (!rawTs) return true;
        const ts = rawTs.toDate ? rawTs.toDate() : new Date(rawTs.seconds * 1000);
        return ts >= cutoff;
      });
      const filteredUnans = STATE.unanswered.filter(u => {
        if (!u._ts) return true;
        const ts = u._ts.toDate ? u._ts.toDate() : new Date(u._ts);
        return ts >= cutoff;
      });

      const totalAI = filteredChats.length;
      const totalUnans = filteredUnans.length;
      const totalDialogs = totalAI + totalUnans;
      const pct = totalDialogs > 0 ? Math.round(totalAI / totalDialogs * 100) : 0;

      const anPct = document.getElementById('an-pct');
      const anAI = document.getElementById('an-ai');
      const anManual = document.getElementById('an-manual');
      const anDialogs = document.getElementById('an-dialogs');
      const anMins = document.getElementById('an-mins');
      const anLeads = document.getElementById('an-leads');

      if (anPct) anPct.textContent = pct + '%';
      if (anAI) anAI.textContent = totalAI;
      if (anManual) anManual.textContent = totalUnans;
      if (anDialogs) anDialogs.textContent = totalDialogs;
      if (anMins) anMins.textContent = Math.round(totalAI * 2.5);
      if (anLeads) anLeads.textContent = Math.round(totalAI * 0.12);

      // Donut chart
      const circle = document.querySelector('#screen-analytics circle:last-child');
      if (circle) {
        const circumference = 2 * Math.PI * 44;
        const offset = circumference * (1 - pct / 100);
        circle.setAttribute('stroke-dashoffset', offset);
      }

      // Unanswered preview
      const unansCount = document.getElementById('an-unans-count');
      if (unansCount) unansCount.textContent = totalUnans > 0 ? `(${totalUnans})` : '';
      const unansPreview = document.getElementById('an-unans-preview');
      if (unansPreview) {
        if (filteredUnans.length === 0) {
          unansPreview.innerHTML = `<div class="q-card" style="grid-column:1/-1;"><div class="empty-state" style="padding:20px;"><div class="empty-sub">–ü–æ–∫–∞ –Ω–µ—Ç –≤–æ–ø—Ä–æ—Å–æ–≤ –±–µ–∑ –æ—Ç–≤–µ—Ç–∞</div></div></div>`;
        } else {
          unansPreview.innerHTML = '';
          filteredUnans.slice(0, 3).forEach(q => {
            const card = document.createElement('div');
            card.className = 'q-card';
            card.innerHTML = `<div class="q-text">${esc(q.text)}</div><div class="q-foot"><span class="q-count">1 –∑–∞–ø—Ä–æ—Å</span><button class="btn-sm" onclick="answerUnans('${q.id}','${esc(q.text)}')">+ –î–æ–±–∞–≤–∏—Ç—å</button></div>`;
            unansPreview.appendChild(card);
          });
        }
      }

      // Topics preview
      const topicsCount = document.getElementById('an-topics-count');
      if (topicsCount) topicsCount.textContent = filteredTopics.length > 0 ? `(${filteredTopics.length})` : '';
      const topicsPreview = document.getElementById('an-topics-preview');
      if (topicsPreview) {
        if (filteredTopics.length === 0) {
          topicsPreview.innerHTML = `<div class="q-card" style="grid-column:1/-1;"><div class="empty-state" style="padding:20px;"><div class="empty-sub">–¢–µ–º –ø–æ–∫–∞ –Ω–µ—Ç</div></div></div>`;
        } else {
          topicsPreview.innerHTML = '';
          filteredTopics.slice(0, 3).forEach(t => {
            const card = document.createElement('div');
            card.className = 'q-card';
            card.innerHTML = `<div class="q-text">${esc(t.name)}</div><div class="q-foot"><span class="q-count">${t.chats || 1} —á–∞—Ç</span><button class="btn-sm">–ü–æ–¥—Ä–æ–±–Ω–µ–µ</button></div>`;
            topicsPreview.appendChild(card);
          });
        }
      }
    }

    /* ‚ïê‚ïê FILE UPLOAD ‚ïê‚ïê */
    function openFileUpload() {
      STATE.pendingFiles = [];
      document.getElementById('file-list').innerHTML = '';
      document.getElementById('modal-file').classList.add('open');
    }

    function closeFileModal() {
      document.getElementById('modal-file').classList.remove('open');
      STATE.pendingFiles = [];
    }

    /* ‚ïê‚ïê TRANSCRIBE MODAL ‚ïê‚ïê */
    let _transcribeSourceId = null;

    function openTranscribeModal() {
      _transcribeSourceId = null;
      document.getElementById('tr-url').value = '';
      document.getElementById('tr-error').style.display = 'none';
      document.getElementById('tr-input-wrap').style.display = '';
      document.getElementById('tr-loading-wrap').style.display = 'none';
      document.getElementById('tr-result-wrap').style.display = 'none';
      document.getElementById('tr-footer-input').style.display = '';
      document.getElementById('tr-footer-result').style.display = 'none';
      document.getElementById('modal-transcribe').classList.add('open');
    }

    function closeTranscribeModal() {
      document.getElementById('modal-transcribe').classList.remove('open');
    }

    async function runTranscribe() {
      const url = document.getElementById('tr-url').value.trim();
      if (!url || !currentUser) return;

      document.getElementById('tr-error').style.display = 'none';
      document.getElementById('tr-input-wrap').style.display = 'none';
      document.getElementById('tr-loading-wrap').style.display = '';
      document.getElementById('tr-footer-input').style.display = 'none';

      try {
        const resp = await fetch('/api/transcribe', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url, uid: currentUser.uid }),
        });
        const data = await resp.json();

        document.getElementById('tr-loading-wrap').style.display = 'none';

        if (!resp.ok || !data.ok) {
          document.getElementById('tr-input-wrap').style.display = '';
          document.getElementById('tr-footer-input').style.display = '';
          document.getElementById('tr-error').style.display = '';
          document.getElementById('tr-error').textContent = data.error || '–û—à–∏–±–∫–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∞—Ü–∏–∏';
          return;
        }

        _transcribeSourceId = data.sourceId;
        document.getElementById('tr-title').textContent = data.title;
        document.getElementById('tr-chars').textContent = `${data.chars.toLocaleString()} —Å–∏–º–≤–æ–ª–æ–≤ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏`;
        document.getElementById('tr-preview').textContent = data.preview + (data.chars > 500 ? '‚Ä¶' : '');
        document.getElementById('tr-result-wrap').style.display = '';
        document.getElementById('tr-footer-result').style.display = '';
        showToast('‚úÖ ' + I18n.t('transcriptionReady'));
      } catch (e) {
        document.getElementById('tr-loading-wrap').style.display = 'none';
        document.getElementById('tr-input-wrap').style.display = '';
        document.getElementById('tr-footer-input').style.display = '';
        document.getElementById('tr-error').style.display = '';
        document.getElementById('tr-error').textContent = '–°–µ—Ç–µ–≤–∞—è –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.';
      }
    }

    async function addTranscriptToKb() {
      if (!_transcribeSourceId || !currentUser) return;
      const btn = document.querySelector('#tr-footer-result .btn-modal-ok');
      btn.disabled = true; btn.textContent = '–ó–∞–ø—É—Å–∫–∞—é –æ–±—Ä–∞–±–æ—Ç–∫—É...';

      try {
        const jobRef = await col('jobs').add({
          sourceId: _transcribeSourceId,
          status: 'queued', step: 'parse', progress: 0,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        });
        await startKnowledgeProcessing(_transcribeSourceId, jobRef.id);
        closeTranscribeModal();
        showToast('üöÄ ' + I18n.t('transcriptionProcessing'));
      } catch (e) {
        btn.disabled = false; btn.textContent = '‚ûï –î–æ–±–∞–≤–∏—Ç—å –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π';
        showToast('‚ö†Ô∏è ' + I18n.t('transcriptionError'));
      }
    }

    document.getElementById('modal-transcribe').addEventListener('click', e => {
      if (e.target === e.currentTarget) closeTranscribeModal();
    });
    document.getElementById('tr-url').addEventListener('keydown', e => {
      if (e.key === 'Enter') runTranscribe();
    });

    document.getElementById('modal-file').addEventListener('click', e => { if (e.target === e.currentTarget) closeFileModal(); });

    const dz = document.getElementById('drop-zone');
    dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('drag-over'); });
    dz.addEventListener('dragleave', () => dz.classList.remove('drag-over'));
    dz.addEventListener('drop', e => { e.preventDefault(); dz.classList.remove('drag-over'); handleFileDrop(e); });

    function handleFileSelect(e) { addFiles(Array.from(e.target.files)); e.target.value = ''; }
    function handleFileDrop(e) { addFiles(Array.from(e.dataTransfer.files)); }

    function addFiles(files) {
      const allowed = ['.pdf', '.docx', '.txt', '.md', '.csv'];
      for (const f of files) {
        if (STATE.pendingFiles.length >= 3) { showToast('‚ö†Ô∏è ' + I18n.t('maxFiles')); break; }
        const ext = '.' + f.name.split('.').pop().toLowerCase();
        if (!allowed.includes(ext)) { showToast(`‚ö†Ô∏è –§–æ—Ä–º–∞—Ç ${ext} –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. PDF, DOCX, TXT, MD, CSV`); continue; }
        if (!STATE.pendingFiles.find(pf => pf.name === f.name)) STATE.pendingFiles.push(f);
      }
      renderFileList();
    }

    async function extractTextFromFile(file) {
      const ext = '.' + file.name.split('.').pop().toLowerCase();
      if (ext === '.pdf') {
        return extractPDF(file);
      } else if (ext === '.docx') {
        return extractDOCX(file);
      } else {
        return file.text();
      }
    }

    async function extractPDF(file) {
      if (typeof pdfjsLib === 'undefined') throw new Error('PDF.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
      pdfjsLib.GlobalWorkerOptions.workerSrc =
        'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
      const arrayBuffer = await file.arrayBuffer();
      const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
      let text = '';
      for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const content = await page.getTextContent();
        text += content.items.map(item => item.str).join(' ') + '\n';
      }
      return text.trim();
    }

    async function extractDOCX(file) {
      if (typeof mammoth === 'undefined') throw new Error('Mammoth.js –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω');
      const arrayBuffer = await file.arrayBuffer();
      const result = await mammoth.extractRawText({ arrayBuffer });
      return result.value.trim();
    }

    function renderFileList() {
      const list = document.getElementById('file-list');
      list.innerHTML = '';
      STATE.pendingFiles.forEach((f, i) => {
        const size = f.size < 1024 ? f.size + ' B' : Math.round(f.size / 1024) + ' KB';
        const item = document.createElement('div');
        item.className = 'file-item';
        item.innerHTML = `<span>üìÑ</span><span class="file-item-name">${esc(f.name)}</span><span class="file-item-size">${size}</span><button class="file-item-rm" onclick="removeFile(${i})">‚úï</button>`;
        list.appendChild(item);
      });
    }

    function removeFile(i) { STATE.pendingFiles.splice(i, 1); renderFileList(); }

    async function uploadFiles() {
      if (STATE.pendingFiles.length === 0) { showToast('‚ö†Ô∏è ' + I18n.t('uploadFile') + '!'); return; }
      for (const f of STATE.pendingFiles) {
        let rawText;
        try {
          rawText = await extractTextFromFile(f);
        } catch (e) {
          showToast(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å ${f.name}: ${e.message}`);
          continue;
        }
        if (!rawText || rawText.length < 10) { showToast(`‚ö†Ô∏è –§–∞–π–ª ${f.name} –ø—É—Å—Ç–æ–π –∏–ª–∏ –Ω–µ—á–∏—Ç–∞–µ–º—ã–π`); continue; }
        const title = f.name.replace(/\.[^.]+$/, '');
        // Create source document
        const sourceRef = await col('kbSources').add({
          title, rawText, type: 'file', fileName: f.name, status: 'queued',
          _ts: firebase.firestore.FieldValue.serverTimestamp(),
        });
        // Create job document
        const jobRef = await col('jobs').add({
          sourceId: sourceRef.id, type: 'knowledge_ingest',
          status: 'queued', step: 'parse', progress: 0,
          _ts: firebase.firestore.FieldValue.serverTimestamp(),
        });
        // Fire-and-forget processing
        startKnowledgeProcessing(sourceRef.id, jobRef.id);
      }
      if (!STATE.rules.trim()) { autoGenerateRules(); await saveRules(); }
      showToast(`‚è≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—é ${STATE.pendingFiles.length} —Ñ–∞–π–ª(–∞)‚Ä¶ –°–ª–µ–¥–∏—Ç–µ –∑–∞ –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π`);
      closeFileModal();
    }

    async function startKnowledgeProcessing(sourceId, jobId) {
      try {
        await fetch('/api/process-knowledge', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ uid: currentUser.uid, jobId, sourceId }),
        });
      } catch (e) { console.warn('processKnowledge error:', e); }
    }

    async function cancelJob(jobId, sourceId) {
      if (!currentUser) return;
      const uid = currentUser.uid;
      await col('jobs').doc(jobId).set({ status: 'cancelled', updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
      if (sourceId) await col('kbSources').doc(sourceId).set({ status: 'cancelled' }, { merge: true });
      showToast('‚õî ' + I18n.t('uploadCancelled'));
    }

    /* ‚ïê‚ïê AI SETTINGS (multi-provider) ‚ïê‚ïê */
    const PROVIDERS = window.AppState.PROVIDERS;

    function toggleVis(id) {
      const inp = document.getElementById(id);
      if (inp) inp.type = inp.type === 'password' ? 'text' : 'password';
    }

    function toggleProviderEnabled(p) {
      if (!STATE.aiProviders) STATE.aiProviders = {};
      const cur = STATE.aiProviders[p]?.enabled || false;
      if (!STATE.aiProviders[p]) STATE.aiProviders[p] = {};
      STATE.aiProviders[p].enabled = !cur;
      applyProviderUI(p);
    }

    function applyProviderUI(p) {
      const enabled = STATE.aiProviders?.[p]?.enabled || false;
      const sw = document.getElementById(p + '-sw');
      const lbl = document.getElementById(p + '-lbl');
      const fields = document.getElementById(p + '-fields');
      if (sw) { sw.classList.toggle('on', enabled); }
      if (lbl) { lbl.textContent = enabled ? I18n.t('toggleOn') : I18n.t('toggleOff'); lbl.className = 'toggle-text ' + (enabled ? 'on' : 'off'); }
      if (fields) fields.style.display = enabled ? 'block' : 'none';
    }

    async function testProvider(p) {
      const key = document.getElementById(p + '-key')?.value.trim();
      const span = document.getElementById(p + '-test');
      if (!key) { if (span) span.textContent = '‚ö†Ô∏è –í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á'; return; }
      window.AppUI.setProviderTestStatus(span, '‚è≥...');
      try {
        if (p === 'claude') {
          window.AppUI.setProviderTestStatus(span, '‚ö†Ô∏è –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞', 'var(--yellow)');
          return;
        }

        const res = await window.AppApi.verifyProviderKey(p, key);
        if (res.ok && res.data && res.data.ok) {
          window.AppUI.setProviderTestStatus(span, '‚úÖ –ü–æ–¥–∫–ª—é—á—ë–Ω', 'var(--green)');
        } else {
          window.AppUI.setProviderTestStatus(span, '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π –∫–ª—é—á', 'var(--red)');
        }
      } catch (e) { window.AppUI.setProviderTestStatus(span, '‚ùå –û—à–∏–±–∫–∞', 'var(--red)'); }
    }

    async function saveAllProviders() {
      if (!currentUser) return;
      if (!STATE.aiProviders) STATE.aiProviders = {};
      PROVIDERS.forEach(p => {
        if (!STATE.aiProviders[p]) STATE.aiProviders[p] = {};
        STATE.aiProviders[p].model = document.getElementById(p + '-model')?.value || '';
      });
      await db.collection('users').doc(currentUser.uid).collection('settings').doc('ai')
        .set({ providers: STATE.aiProviders }, { merge: true });
      showToast('‚úÖ ' + I18n.t('settingsSaved'));
      renderLaunchConfig();
    }

    // ‚îÄ‚îÄ Plan helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const PLAN_LIMITS = { trial: 2000, starter: 5000, pro: 20000, business: 100000 };
    const PLAN_LABELS = { trial: 'Trial (–±–µ—Å–ø–ª–∞—Ç–Ω–æ)', starter: 'Starter', pro: 'Pro', business: 'Business' };

    function getPlanMonthlyLimit(plan) {
      if (!plan) return 0;
      return plan.monthlyLimit || PLAN_LIMITS[plan.type] || 0;
    }

    function isPlanActive(plan) {
      if (!plan) return false;
      const now = Date.now();
      if (plan.type === 'trial') {
        const te = plan.trialEnds?.seconds ? plan.trialEnds.seconds * 1000 : (plan.trialEnds?.toMillis?.() || 0);
        return te > now;
      }
      if (plan.type === 'starter' || plan.type === 'pro' || plan.type === 'business' || plan.type === 'premium') {
        const pu = plan.paidUntil?.seconds ? plan.paidUntil.seconds * 1000 : (plan.paidUntil?.toMillis?.() || 0);
        return pu > now;
      }
      return false;
    }

    function getMonthUsage() {
      const now = new Date();
      const prefix = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
      return STATE.aiUsage.filter(e => {
        const ts = e.createdAt?.seconds
          ? e.createdAt.seconds * 1000
          : (e.createdAt?.toMillis ? e.createdAt.toMillis() : 0);
        const d = new Date(ts);
        return d.getFullYear() === now.getFullYear() && d.getMonth() === now.getMonth();
      }).length;
    }

    function renderTariff() {
      const plan = STATE.plan;
      const active = isPlanActive(plan);
      const limit = getPlanMonthlyLimit(plan);
      const used = getMonthUsage();
      const pct = limit > 0 ? Math.min((used / limit) * 100, 100) : 0;
      const remaining = Math.max(0, limit - used);

      // Plan name & desc
      const typeName = plan ? (PLAN_LABELS[plan.type] || plan.type) : '‚Äî';
      const el = id => document.getElementById(id);
      if (el('plan-name-lbl')) el('plan-name-lbl').textContent = typeName;

      if (el('plan-desc-lbl')) {
        if (!plan) {
          el('plan-desc-lbl').textContent = '–ó–∞–≥—Ä—É–∑–∫–∞...';
        } else if (plan.type === 'trial') {
          const te = plan.trialEnds?.seconds ? new Date(plan.trialEnds.seconds * 1000) : null;
          const daysLeft = te ? Math.max(0, Math.ceil((te - Date.now()) / 86400000)) : 0;
          el('plan-desc-lbl').textContent = active
            ? `14 –¥–Ω–µ–π –±–µ—Å–ø–ª–∞—Ç–Ω–æ ¬∑ –æ—Å—Ç–∞–ª–æ—Å—å ${daysLeft} –¥–Ω.`
            : '–ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –∑–∞–≤–µ—Ä—à—ë–Ω';
        } else {
          el('plan-desc-lbl').textContent = `${limit.toLocaleString()} AI-–∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–µ—Å—è—Ü`;
        }
      }

      // Status badge
      if (el('plan-status-badge')) {
        el('plan-status-badge').textContent = active ? I18n.t('planActive') : I18n.t('planExpired');
        el('plan-status-badge').style.color = active ? 'var(--indigo)' : '#ef4444';
        el('plan-status-badge').style.borderColor = active ? 'var(--primary-brd)' : '#ef444440';
      }

      // Usage bar
      if (el('ai-count-used')) el('ai-count-used').textContent = used.toLocaleString('ru');
      if (el('ai-count-limit')) el('ai-count-limit').textContent = limit.toLocaleString('ru');
      if (el('ai-usage-bar')) el('ai-usage-bar').style.width = pct + '%';

      // Sidebar counter
      if (el('ai-count')) el('ai-count').textContent = remaining.toLocaleString('ru');
      if (el('ai-bar')) el('ai-bar').style.width = Math.min(pct, 100) + '%';
    }

    async function initUserPlan(uid) {
      const planRef = db.collection('users').doc(uid).collection('settings').doc('plan');
      try {
        const snap = await planRef.get();
        if (!snap.exists) {
          // First login ‚Äî create 14-day Pro trial
          const trialEnds = new firebase.firestore.Timestamp(
            Math.floor(Date.now() / 1000) + 14 * 24 * 3600, 0
          );
          const newPlan = {
            type: 'trial',
            trialEnds,
            monthlyLimit: 2000,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          };
          await planRef.set(newPlan);
          STATE.plan = { type: 'trial', trialEnds, monthlyLimit: 2000 };
        } else {
          STATE.plan = snap.data();
        }
      } catch (e) {
        console.warn('Plan load failed:', e);
      }
      renderTariff();
      // Re-render when aiUsage updates (usage counter changes)
      const origListen = STATE._aiUsageRenderHook;
      STATE._aiUsageRenderHook = true;
    }

    function loadAiSettings() {
      if (!currentUser) return;
      db.collection('users').doc(currentUser.uid).collection('settings').doc('ai').get().then(d => {
        let providers = {};
        if (!d.exists) {
          // If no settings exist (new user), set default OpenAI gpt-4o-mini and save to DB
          providers = {
            'openai': { enabled: true, model: 'gpt-4o-mini' }
          };
          db.collection('users').doc(currentUser.uid).collection('settings').doc('ai').set({ providers }, { merge: true });
        } else {
          providers = d.data().providers || {};
        }

        STATE.aiProviders = providers;
        PROVIDERS.forEach(p => {
          const cfg = STATE.aiProviders[p] || {};
          applyProviderUI(p);
          const modelEl = document.getElementById(p + '-model');
          if (modelEl && cfg.model) modelEl.value = cfg.model;
        });
        renderLaunchConfig();
      });
    }

    // —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º –∫–æ–¥–æ–º
    function selectProvider(p) { /* no-op: use applyProviderUI instead */ }
    function toggleKeyVisibility() { toggleVis('openai-key'); }

    /* ‚îÄ‚îÄ Tariff billing toggle ‚îÄ‚îÄ */
    const TARIFF_PRICES = {
      starter: { year: { price: '$15', old: '$19', note: '–ø—Ä–∏ –æ–ø–ª–∞—Ç–µ –∑–∞ –≥–æ–¥' }, month: { price: '$19', old: '', note: '–ø—Ä–∏ –æ–ø–ª–∞—Ç–µ –ø–æ–º–µ—Å—è—á–Ω–æ' } },
      pro: { year: { price: '$39', old: '$49', note: '–ø—Ä–∏ –æ–ø–ª–∞—Ç–µ –∑–∞ –≥–æ–¥' }, month: { price: '$49', old: '', note: '–ø—Ä–∏ –æ–ø–ª–∞—Ç–µ –ø–æ–º–µ—Å—è—á–Ω–æ' } },
      business: { year: { price: '$119', old: '$149', note: '–ø—Ä–∏ –æ–ø–ª–∞—Ç–µ –∑–∞ –≥–æ–¥' }, month: { price: '$149', old: '', note: '–ø—Ä–∏ –æ–ø–ª–∞—Ç–µ –ø–æ–º–µ—Å—è—á–Ω–æ' } },
    };
    function setTariffBilling(val) {
      document.getElementById('tbtn-year')?.classList.toggle('active', val === 'year');
      document.getElementById('tbtn-month')?.classList.toggle('active', val === 'month');
      ['starter', 'pro', 'business'].forEach(key => {
        const p = TARIFF_PRICES[key][val];
        const priceEl = document.getElementById(`${key}-price-t`);
        if (priceEl) {
          priceEl.innerHTML = `${p.price} <span style="font-size:0.8rem;font-weight:400;opacity:0.7;">/ –≤ –º–µ—Å—è—Ü</span>`;
          const oldEl = document.getElementById(`${key}-old-t`);
          const noteEl = document.getElementById(`${key}-note-t`);
          if (oldEl) oldEl.textContent = p.old;
          if (noteEl) noteEl.textContent = p.note;
        }
      });
    }

    /* ‚ïê‚ïê LAUNCH SCREEN ‚ïê‚ïê */
    function renderLaunchScreen() {
      const uid = currentUser?.uid || '‚Äî';
      const el = document.getElementById('launch-uid');
      if (el) el.textContent = uid;
      renderWebhookBots();
      renderLaunchConfig();
    }

    function renderLaunchConfig() {
      const el = document.getElementById('launch-config');
      if (!el) return;
      const botCount = STATE.bots.length;
      const kbCount = STATE.kbItems.length;
      const hasRules = STATE.rules.trim() ? '‚úÖ –ó–∞–¥–∞–Ω—ã' : '‚ö†Ô∏è –ù–µ –∑–∞–¥–∞–Ω—ã';
      const status = STATE.agentActive ? '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω' : '‚è∏ –ù–µ–∞–∫—Ç–∏–≤–µ–Ω';
      const pCfg = STATE.aiProviders || {};
      const providerRows = ['openai', 'gemini', 'claude'].map(p => {
        const cfg = pCfg[p] || {};
        const ico = p === 'openai' ? 'üü¢' : p === 'gemini' ? 'üîµ' : 'üü†';
        const name = p === 'openai' ? 'OpenAI' : p === 'gemini' ? 'Gemini' : 'Claude';
        const on = cfg.enabled ? '<span style="color:var(--green);">‚úÖ –í–∫–ª</span>' : '<span style="color:var(--text-dim);">‚≠ï –í—ã–∫–ª</span>';
        const model = cfg.model ? `<span style="color:var(--text-dim);font-size:0.7rem;">${cfg.model}</span>` : '';
        return `<div style="display:flex;justify-content:space-between;font-size:0.78rem;">${ico} ${name}<span style="display:flex;gap:10px;align-items:center;">${model}${on}</span></div>`;
      }).join('');

      el.innerHTML = `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:8px;">
        <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px;">
          <div style="font-size:0.6rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:.08em;margin-bottom:4px;">–ë–æ—Ç–æ–≤</div>
          <div style="font-size:1.2rem;font-weight:800;color:var(--cyan);">${botCount}</div>
        </div>
        <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px;">
          <div style="font-size:0.6rem;color:var(--text-dim);text-transform:uppercase;letter-spacing:.08em;margin-bottom:4px;">–ó–∞–ø–∏—Å–µ–π –≤ KB</div>
          <div style="font-size:1.2rem;font-weight:800;color:var(--green);">${kbCount}</div>
        </div>
      </div>
      <div style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:10px;display:flex;flex-direction:column;gap:7px;">
        ${providerRows}
        <div style="border-top:1px solid var(--border2);padding-top:6px;display:flex;justify-content:space-between;font-size:0.78rem;"><span>–ü—Ä–∞–≤–∏–ª–∞ –æ–±—â–µ–Ω–∏—è</span><b>${hasRules}</b></div>
        <div style="display:flex;justify-content:space-between;font-size:0.78rem;"><span>–°—Ç–∞—Ç—É—Å –∞–≥–µ–Ω—Ç–∞</span><b>${status}</b></div>
      </div>`;
    }

    function copyUID() {
      const uid = currentUser?.uid || '';
      navigator.clipboard.writeText(uid).then(() => showToast('‚úÖ ' + I18n.t('uidCopied')));
    }

    function copyRunCmd() {
      const cmd = document.getElementById('run-cmd')?.textContent || '';
      navigator.clipboard.writeText(cmd).then(() => showToast('‚úÖ ' + I18n.t('commandCopied')));
    }

    function copyText(text) {
      navigator.clipboard.writeText(text).then(() => showToast('‚úÖ ' + I18n.t('copiedToClipboard') + ': ' + text));
    }

    /* ‚ïê‚ïê TOAST ‚ïê‚ïê */
    let toastTimer = null;
    /* ‚îÄ‚îÄ Paste helper (for Telegram WebView where long-press doesn't work) ‚îÄ‚îÄ */
    async function pasteToInput(inputId) {
      const input = document.getElementById(inputId);
      if (!input) return;
      try {
        const text = await navigator.clipboard.readText();
        input.value = text;
        input.focus();
        input.dispatchEvent(new Event('input'));
        showToast('üìã ' + I18n.t('pasted'));
      } catch (e) {
        // Fallback: prompt user to paste manually
        input.focus();
        document.execCommand('paste');
      }
    }

    function showToast(msg) {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      clearTimeout(toastTimer);
      toastTimer = setTimeout(() => t.classList.remove('show'), 2500);
    }

    /* ‚ïê‚ïê CONFIRM MODAL ‚ïê‚ïê */
    let _confirmCallback = null;

    function showConfirm({ title, desc, action = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å', cancel = '–û—Ç–º–µ–Ω–∞', icon = '', danger = false, onOk }) {
      _confirmCallback = onOk || null;
      const iconEl = document.getElementById('modal-confirm-icon');
      const titleEl = document.getElementById('modal-confirm-title');
      const descEl = document.getElementById('modal-confirm-desc');
      const okBtn = document.getElementById('modal-confirm-ok-btn');
      const cancelBtn = document.getElementById('modal-confirm-cancel-btn');
      if (iconEl) iconEl.textContent = icon;
      if (iconEl) iconEl.style.display = icon ? '' : 'none';
      if (titleEl) titleEl.textContent = title;
      if (descEl) descEl.textContent = desc;
      if (okBtn) {
        okBtn.textContent = action;
        okBtn.style.background = danger ? 'var(--red)' : 'var(--primary)';
      }
      if (cancelBtn) cancelBtn.textContent = cancel;
      document.getElementById('modal-confirm')?.classList.add('open');
      // Keyboard: Esc closes
      document.addEventListener('keydown', _confirmEscHandler);
    }

    function _confirmCancel() {
      _confirmCallback = null;
      document.getElementById('modal-confirm')?.classList.remove('open');
      document.removeEventListener('keydown', _confirmEscHandler);
    }

    function _confirmOk() {
      const cb = _confirmCallback;
      _confirmCancel();
      if (cb) cb();
    }

    function _confirmEscHandler(e) {
      if (e.key === 'Escape') _confirmCancel();
    }

    /* ‚ïê‚ïê UTILS ‚ïê‚ïê */
    function esc(s) {
      return String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    /* ‚ïê‚ïê AUTH FUNCTIONS ‚ïê‚ïê */
    let authMode = 'login';

    function setAuthTab(mode, el) {
      authMode = mode;
      document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
      el.classList.add('active');
      document.getElementById('auth-name-wrap').style.display = mode === 'register' ? 'block' : 'none';
      document.getElementById('auth-submit-btn').textContent = mode === 'login' ? '–í–æ–π—Ç–∏' : '–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç';
      document.getElementById('auth-error').classList.remove('show');
    }

    function showAuthError(msg) {
      const el = document.getElementById('auth-error');
      el.textContent = msg;
      el.classList.add('show');
    }

    async function authSubmit() {
      const email = document.getElementById('auth-email').value.trim();
      const pass = document.getElementById('auth-password').value;
      if (!email || !pass) { showAuthError('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å'); return; }
      try {
        if (authMode === 'login') {
          await auth.signInWithEmailAndPassword(email, pass);
        } else {
          const name = document.getElementById('auth-name').value.trim();
          const cred = await auth.createUserWithEmailAndPassword(email, pass);
          if (name) await cred.user.updateProfile({ displayName: name });
        }
      } catch (e) {
        const msgs = {
          'auth/user-not-found': '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω',
          'auth/wrong-password': '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å',
          'auth/email-already-in-use': 'Email —É–∂–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è',
          'auth/weak-password': '–ü–∞—Ä–æ–ª—å —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π (–º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤)',
          'auth/invalid-email': '–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç email',
          'auth/invalid-credential': '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å',
        };
        showAuthError(msgs[e.code] || e.message);
      }
    }

    async function signInGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      try {
        await auth.signInWithPopup(provider);
      } catch (e) {
        if (e.code === 'auth/popup-blocked') {
          showAuthError('–ë—Ä–∞—É–∑–µ—Ä –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –æ–∫–Ω–æ –≤—Ö–æ–¥–∞. –†–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –¥–ª—è —ç—Ç–æ–≥–æ —Å–∞–π—Ç–∞ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
        } else if (e.code !== 'auth/popup-closed-by-user' && e.code !== 'auth/cancelled-popup-request') {
          showAuthError('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ Google: ' + e.message);
        }
      }
    }

    async function signOut() {
      showConfirm({
        icon: 'üö™',
        title: '–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?',
        desc: '–í—ã –±—É–¥–µ—Ç–µ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –≤—Ö–æ–¥–∞.',
        action: '–í—ã–π—Ç–∏',
        onOk: async () => {
          stopListeners();
          await auth.signOut();
        },
      });
    }

    function onUserLogin(user) {
      stopListeners(); // guard: clear any stale listeners if onUserLogin fires more than once
      currentUser = user;
      document.getElementById('auth-overlay').classList.add('hidden');
      document.getElementById('auth-overlay').classList.remove('has-landing');
      document.getElementById('auth-spinner-wrap').style.display = 'none';
      document.getElementById('auth-box').style.display = 'none';
      const lp = document.getElementById('landing-page');
      if (lp) lp.style.display = 'none';
      document.getElementById('user-pill').style.display = 'flex';
      const initial = (user.displayName || user.email || '?').charAt(0).toUpperCase();
      document.getElementById('user-av').textContent = initial;
      document.getElementById('user-email-lbl').textContent = user.displayName || user.email;
      const avName = document.getElementById('av-dd-name');
      const avEmail = document.getElementById('av-dd-email');
      if (avName) avName.textContent = user.displayName || user.email || '‚Äî';
      if (avEmail) avEmail.textContent = user.email || '';
      // Detect platform
      const isTg = !!(window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initData);
      const ua = navigator.userAgent || '';
      const isMobile = /Android|iPhone|iPad|iPod|Mobile/i.test(ua);
      const platform = isTg ? 'telegram' : (isMobile ? 'mobile' : 'desktop');

      // Extract Telegram username if available
      const tgUser = window._tgUser || (window.Telegram && window.Telegram.WebApp && window.Telegram.WebApp.initDataUnsafe?.user) || {};
      const tgUsername = tgUser.username || '';

      // Write user-level doc for super-admin discoverability
      db.collection('users').doc(user.uid).set({
        email: user.email || '',
        displayName: user.displayName || '',
        lastLogin: firebase.firestore.FieldValue.serverTimestamp(),
        platform: platform,
        userAgent: ua.substring(0, 200),
        ...(tgUsername && { tgUsername })
      }, { merge: true }).catch(() => { });

      // Check if TG user needs phone verification
      if (isTg) {
        // Fast path: UID-keyed localStorage cache (handles account switching automatically)
        const _phoneKey = 'phone_verified_' + user.uid;
        if (localStorage.getItem(_phoneKey) !== 'true') {
          // Slow path: single Firestore call ‚Äî cache result to skip on next session
          db.collection('users').doc(user.uid).get().then(doc => {
            const d = doc.exists ? doc.data() : {};
            if (!d.phone || d.phone_verified === false) {
              document.getElementById('modal-phone-verify').classList.add('open');
            } else {
              // Backfill cache for users who already have phone saved
              localStorage.setItem(_phoneKey, 'true');
            }
          }).catch(() => { /* silently skip on network error ‚Äî don't block UX */ });
        }
      }

      window.saveTgPhone = async function () {
        const input = document.getElementById('tg-phone-input');
        const btn = document.getElementById('tg-phone-save-btn');
        const phone = input.value.trim();
        if (phone.length < 9) {
          showToast('‚ùå ' + I18n.t('tryAgain'));
          input.focus();
          return;
        }
        if (btn) { btn.disabled = true; btn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ‚Ä¶'; }
        try {
          await db.collection('users').doc(currentUser.uid).set({
            phone,
            phone_verified: true,
            phone_updated_at: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
          // Cache so we skip the check on next login
          localStorage.setItem('phone_verified_' + currentUser.uid, 'true');
          // Update settings card if visible
          const sv = document.getElementById('s-phone-value');
          if (sv) sv.textContent = phone;
          document.getElementById('modal-phone-verify').classList.remove('open');
          showToast('‚úÖ ' + I18n.t('numberConfirmed') + '!');
        } catch (e) {
          showToast('‚ùå ' + I18n.t('errorSaving') + ': ' + e.message);
        } finally {
          if (btn) { btn.disabled = false; btn.textContent = '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å'; }
        }
      };

      window.openPhoneModal = function () {
        if (!currentUser) return;
        // Pre-fill with saved phone if any
        db.collection('users').doc(currentUser.uid).get().then(doc => {
          const ph = doc.exists ? (doc.data().phone || '') : '';
          const inp = document.getElementById('tg-phone-input');
          if (inp) inp.value = ph;
        }).catch(() => { });
        document.getElementById('modal-phone-verify').classList.add('open');
      };

      // Launch Chat Onboarding if needed (disabled in projects-only mode)
      if (!window.FORCE_PROJECTS_MAIN) {
        db.collection('users').doc(user.uid).collection('bots').get().then(botsSnap => {
          initChatOnboarding(user.uid, botsSnap.size);
        }).catch(() => {
          initChatOnboarding(user.uid, 0);
        });
      }

      // Projects-only mode: do not start legacy listeners/screens to keep UI fast and stable.
      if (window.FORCE_PROJECTS_MAIN) return;

      db.collection('users').doc(user.uid).collection('settings').doc('agent').get().then(d => {
        if (d.exists) { STATE.agentActive = d.data().active !== false; applyAgentStatus(); }
      });
      db.collection('users').doc(user.uid).collection('settings').doc('rules').get().then(d => {
        if (d.exists) { STATE.rules = d.data().text || ''; renderRulesScreen(); }
      });
      loadAiSettings();

      // Init plan (creates 14-day trial for new users)
      initUserPlan(user.uid);

      // Load user language preference
      db.collection('users').doc(user.uid).collection('settings').doc('profile').get().then(snap => {
        if (snap.exists && snap.data().lang) {
          LANG = snap.data().lang;
          localStorage.setItem('ui_lang', LANG);
          applyLang(LANG);
        }
      });

      // Load auto-reply rules, flows and notification settings
      db.doc(`users/${user.uid}/settings/autoReplies`).get().then(snap => {
        STATE.autoReplies = snap.exists ? (snap.data().rules || []) : [];
        renderAutoReplies();
      });
      loadFlows();
      loadNotifSettings();

      // Debounced render helpers ‚Äî collapse 4 simultaneous listener triggers into 1 render
      function _mkDebounce(fn, ms) { let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); }; }
      const _dRenderKb = _mkDebounce(renderKb, 40);
      const _dRenderAnalytics = _mkDebounce(renderAnalytics, 40);
      const _dRenderTopics = _mkDebounce(renderTopics, 40);
      const _dRenderSuggestions = _mkDebounce(renderSuggestions, 40);
      const _dRenderUnanswered = _mkDebounce(renderUnanswered, 40);
      const _dRenderJobsInline = _mkDebounce(renderJobsInline, 40);

      // Start Firestore real-time listeners
      listen('bots', data => {
        STATE.bots = data;
        // Auto-select first bot if none set
        if (data.length > 0 && !STATE.currentBotId) {
          STATE.currentBotId = data[0].id;
        }
        try { renderBots(); } catch (e) { console.error('renderBots:', e); }
        renderBotNavList();
        updateBotContextNav();
        // Fetch bot photos in background and re-render when ready
        data.forEach(bot => {
          if (STATE.botPhotos[bot.id] === undefined) {
            fetchBotPhoto(bot).then(url => {
              if (url) { renderBotNavList(); renderBotOverview(); }
            });
          }
        });
        // If on home screen and bots exist, navigate to bot overview
        if (STATE.currentAgentScreen === 'home' && data.length > 0) {
          goAgentScreen('bot-overview');
        }
        // Show wizard for new users after bots loaded
        setTimeout(checkOnboarding, 800);
      });
      listen('kbItems', data => { STATE.kbItems = data; _dRenderKb(); _dRenderAnalytics(); });
      listen('kbQA', data => { STATE.kbQA = data; _dRenderKb(); _dRenderSuggestions(); _dRenderAnalytics(); _dRenderTopics(); });
      listen('jobs', data => { STATE.kbJobs = data; _dRenderKb(); _dRenderJobsInline(); });
      listen('kbSources', data => { STATE.kbSources = data; _dRenderKb(); });
      listen('unanswered', data => { STATE.unanswered = data; _dRenderUnanswered(); _dRenderAnalytics(); });
      listen('topics', data => { STATE.topics = data; _dRenderTopics(); _dRenderAnalytics(); });
      listenChats(data => { STATE.chats = data; renderChats(); });
      listen('aiUsage', data => { STATE.aiUsage = data; renderTariff(); if (STATE.currentAgentScreen === 'ai-usage') renderAiUsage(); });

      // Restore last visited screen
      const lastScreen = localStorage.getItem('lastScreen');
      if (lastScreen && lastScreen.startsWith('agent:')) {
        goAgentScreen(lastScreen.replace('agent:', ''));
      } else {
        goAgentScreen('home');
      }
    }

    function onUserLogout() {
      stopListeners(); // unsubscribe all Firestore listeners on logout
      currentUser = null;
      STATE.bots = []; STATE.kbItems = []; STATE.unanswered = []; STATE.topics = [];
      document.getElementById('auth-overlay').classList.remove('hidden');
      document.getElementById('user-pill').style.display = 'none';
      // In Telegram Mini App: keep spinner visible while auto-auth is in progress
      if (typeof _isTelegramApp !== 'undefined' && _isTelegramApp) {
        // Don't show email/Google form ‚Äî auto-auth is still running
      } else {
        document.getElementById('auth-spinner-wrap').style.display = 'none';
        document.getElementById('auth-box').style.display = 'block';
        // Show landing page for browser users
        document.getElementById('landing-page').style.display = 'block';
        document.getElementById('auth-overlay').classList.add('has-landing');
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(e => { if (e.isIntersecting) { e.target.classList.add('visible'); observer.unobserve(e.target); } });
        }, { threshold: 0.15 });
        document.querySelectorAll('.lp-reveal').forEach(el => observer.observe(el));
      }
      renderBots(); renderKb(); renderUnanswered(); renderTopics();
    }

    /* ‚ïê‚ïê INIT ‚ïê‚ïê */
    applyTheme();
    document.getElementById('bot-first-time').textContent = new Date().toLocaleTimeString('ru', { hour: '2-digit', minute: '2-digit' });

    // Handle Google redirect result (Safari / popup-blocked fallback)
    auth.getRedirectResult().catch(() => { });

    // ‚îÄ‚îÄ Telegram Mini App auto-auth ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const _twa = window.Telegram?.WebApp;
    const _isTelegramApp = !!_twa?.initData;

    function _showTgError() {
      document.getElementById('auth-spinner-wrap').style.display = 'none';
      document.getElementById('auth-tg-error').style.display = 'block';
    }
    function _showLoginForm() {
      document.getElementById('auth-spinner-wrap').style.display = 'none';
      document.getElementById('auth-box').style.display = 'block';
      // Show landing page in browser (not Telegram)
      if (!_isTelegramApp) {
        document.getElementById('landing-page').style.display = 'block';
        document.getElementById('auth-overlay').classList.add('has-landing');
        // Scroll reveal for sections
        const observer = new IntersectionObserver((entries) => {
          entries.forEach(e => { if (e.isIntersecting) { e.target.classList.add('visible'); observer.unobserve(e.target); } });
        }, { threshold: 0.15 });
        document.querySelectorAll('.lp-reveal').forEach(el => observer.observe(el));
      }
    }

    if (_isTelegramApp) {
      _twa.expand();
      _twa.ready();
      // Show "–í—Ö–æ–¥–∏–º —á–µ—Ä–µ–∑ Telegram..." status
      document.getElementById('auth-tg-status').textContent = '–í—Ö–æ–¥–∏–º —á–µ—Ä–µ–∑ Telegram‚Ä¶';
      fetch('/api/telegram-auth', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ initData: _twa.initData })
      })
        .then(r => r.json())
        .then(d => { if (d.ok) auth.signInWithCustomToken(d.token); else _showTgError(); })
        .catch(() => _showTgError());
    }

    // Fallback: show login form (or Telegram error) if auth doesn't resolve in time
    let _authResolved = false;
    setTimeout(() => {
      if (!_authResolved) {
        if (_isTelegramApp) _showTgError(); else _showLoginForm();
      }
    }, _isTelegramApp ? 15000 : 3000);

    auth.onAuthStateChanged(user => {
      _authResolved = true;
      authReady = true;
      if (user) {
        resolvedUid = user.uid;
        window.resolvedUid = user.uid; // R2: explicit sync so handleChatObSend always reads correct uid
        onUserLogin(user);
      } else {
        resolvedUid = null;
        window.resolvedUid = null;
        onUserLogout(); // onUserLogout handles Telegram context internally
      }
    });

    // Clean up all Firestore listeners when the page is closed/navigated away
    window.addEventListener('beforeunload', stopListeners);

    /* ‚ïê‚ïê AVATAR DROPDOWN ‚ïê‚ïê */
    function toggleAvDropdown(e) {
      e.stopPropagation();
      document.getElementById('av-dropdown').classList.toggle('open');
    }
    function closeAvDropdown() {
      document.getElementById('av-dropdown').classList.remove('open');
    }
    document.addEventListener('click', () => closeAvDropdown());

    /* ‚ïê‚ïê SETTINGS ‚ïê‚ïê */
    const SETTINGS_SECTIONS = {
      account: 'ss-account',
      general: 'ss-general',
      billing: 'ss-billing',
      limits: 'ss-limits',
      bonuses: 'ss-bonuses',
      notifications: 'ss-notifications',
      partner: 'ss-partner-main',
      'partner-main': 'ss-partner-main',
      'partner-clients': 'ss-partner-clients',
    };
    const SETTINGS_NAV_MAP = {
      account: 'snav-account',
      general: 'snav-general',
      billing: 'snav-billing',
      limits: 'snav-limits',
      bonuses: 'snav-bonuses',
      notifications: 'snav-notifications',
      partner: 'snav-partner',
      'partner-clients': 'snav-partner-clients',
    };

    let _currentSettingsSection = 'account';

    function openSettings(section) {
      document.getElementById('settings-overlay').classList.add('open');
      goSettings(section || 'account');
      renderSettingsData();
      loadCard();
      loadActiveBonuses();
      loadNotifSettings();
    }

    function closeSettings() {
      document.getElementById('settings-overlay').classList.remove('open');
    }

    function goSettings(section) {
      _currentSettingsSection = section;
      // Hide all sections
      Object.values(SETTINGS_SECTIONS).forEach(id => {
        const el = document.getElementById(id);
        if (el) el.classList.remove('active');
      });
      // Show selected
      const targetId = SETTINGS_SECTIONS[section];
      if (targetId) document.getElementById(targetId)?.classList.add('active');
      // Update nav
      Object.values(SETTINGS_NAV_MAP).forEach(id => {
        document.getElementById(id)?.classList.remove('active');
      });
      const navId = SETTINGS_NAV_MAP[section];
      if (navId) document.getElementById(navId)?.classList.add('active');
      // Partner sub-items expand
      const isPartner = section === 'partner' || section === 'partner-clients';
      document.getElementById('snav-partner')?.classList.toggle('active', isPartner);
    }

    function renderSettingsData() {
      if (!currentUser) return;
      const plan = STATE.plan;
      const used = getMonthUsage();
      const limit = getPlanMonthlyLimit(plan);
      const pct = limit > 0 ? Math.min((used / limit) * 100, 100) : 0;
      const active = isPlanActive(plan);
      const typeName = plan ? (PLAN_LABELS[plan.type] || plan.type) : '‚Äî';

      // Account section
      const initial = (currentUser.displayName || currentUser.email || '?').charAt(0).toUpperCase();
      const el = id => document.getElementById(id);
      if (el('s-av-big')) el('s-av-big').textContent = initial;
      if (el('s-profile-name')) el('s-profile-name').textContent = currentUser.displayName || '‚Äî';
      if (el('s-profile-email')) el('s-profile-email').textContent = currentUser.email || '‚Äî';
      if (el('s-plan-badge')) el('s-plan-badge').textContent = typeName + (active ? ' ¬∑ –ê–∫—Ç–∏–≤–µ–Ω' : ' ¬∑ –ò—Å—Ç—ë–∫');
      if (el('s-plan-name')) el('s-plan-name').textContent = typeName;
      if (el('s-plan-info')) {
        if (plan?.type === 'trial') {
          const te = plan.trialEnds?.seconds ? new Date(plan.trialEnds.seconds * 1000) : null;
          const days = te ? Math.max(0, Math.ceil((te - Date.now()) / 86400000)) : 0;
          el('s-plan-info').textContent = active ? `–¢—Ä–∏–∞–ª ¬∑ –æ—Å—Ç–∞–ª–æ—Å—å ${days} –¥–Ω.` : '–ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –∑–∞–≤–µ—Ä—à—ë–Ω';
        } else {
          el('s-plan-info').textContent = active ? `–ê–∫—Ç–∏–≤–Ω–∞ –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–ª–∞—Ç—ë–∂–∞` : '–ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∞';
        }
      }
      if (el('s-used')) el('s-used').textContent = used.toLocaleString('ru');
      if (el('s-limit')) el('s-limit').textContent = limit.toLocaleString('ru');
      if (el('s-prog')) el('s-prog').style.width = pct + '%';

      // Phone card ‚Äî TG users only
      const isTgUser = !!window.Telegram?.WebApp?.initData;
      const phoneCard = el('s-phone-card');
      if (phoneCard && isTgUser) {
        phoneCard.style.display = '';
        db.collection('users').doc(currentUser.uid).get().then(doc => {
          const ph = doc.exists ? (doc.data().phone || '‚Äî') : '‚Äî';
          if (el('s-phone-value')) el('s-phone-value').textContent = ph;
        }).catch(() => { });
      }

      // Billing section
      if (el('sb-plan-name')) el('sb-plan-name').textContent = typeName;
      if (el('sb-plan-desc')) {
        if (plan?.type === 'trial') {
          const te = plan.trialEnds?.seconds ? new Date(plan.trialEnds.seconds * 1000) : null;
          const days = te ? Math.max(0, Math.ceil((te - Date.now()) / 86400000)) : 0;
          el('sb-plan-desc').textContent = active ? `14 –¥–Ω–µ–π –±–µ—Å–ø–ª–∞—Ç–Ω–æ ¬∑ –æ—Å—Ç–∞–ª–æ—Å—å ${days} –¥–Ω.` : '–ü—Ä–æ–±–Ω—ã–π –ø–µ—Ä–∏–æ–¥ –∑–∞–≤–µ—Ä—à—ë–Ω';
        } else {
          el('sb-plan-desc').textContent = active ? `${limit.toLocaleString()} –∑–∞–ø—Ä–æ—Å–æ–≤ / –º–µ—Å` : '–ù–µ–∞–∫—Ç–∏–≤–Ω–∞';
        }
      }
      if (el('sb-used')) el('sb-used').textContent = used.toLocaleString('ru');
      if (el('sb-limit')) el('sb-limit').textContent = limit.toLocaleString('ru');
      if (el('sb-prog')) el('sb-prog').style.width = pct + '%';

      // Limits section
      const isPremium = plan?.type === 'premium';
      if (el('sl-plan-title')) el('sl-plan-title').textContent = typeName;
      if (el('sl-ai-req')) el('sl-ai-req').textContent = (limit || 0).toLocaleString('ru');
      if (el('sl-bots')) el('sl-bots').textContent = isPremium ? '‚àû' : '1';
      if (el('sl-kb')) el('sl-kb').textContent = isPremium ? '‚àû' : '100 –∑–∞–ø–∏—Å–µ–π';
      if (el('sl-models')) el('sl-models').textContent = isPremium ? '–í—Å–µ –º–æ–¥–µ–ª–∏' : 'GPT / Gemini';

      // General section
      if (el('s-company-email')) el('s-company-email').value = currentUser.email || '';
      if (el('av-dd-name')) el('av-dd-name').textContent = currentUser.displayName || currentUser.email || '‚Äî';
      if (el('av-dd-email')) el('av-dd-email').textContent = currentUser.email || '';

      // Partner section
      const refLink = `https://createbotaiagent.com?ref=${currentUser.uid.slice(0, 8)}`;
      if (el('sp-ref-link')) el('sp-ref-link').value = refLink;
    }

    function saveGeneralSettings() {
      if (!currentUser) return;
      const name = document.getElementById('s-company-name')?.value?.trim();
      const newsletter = document.getElementById('s-newsletter')?.checked;
      db.collection('users').doc(currentUser.uid).collection('settings').doc('profile')
        .set({ companyName: name || '', newsletter: !!newsletter }, { merge: true })
        .then(() => showToast('‚úÖ ' + I18n.t('saved')))
        .catch(() => showToast(I18n.t('errorSaving')));
    }

    function changePassword() {
      const oldPass = document.getElementById('s-old-pass')?.value;
      const newPass = document.getElementById('s-new-pass')?.value;
      if (!oldPass) { showToast(I18n.t('oldPassword') + '!'); return; }
      if (!newPass || newPass.length < 6) { showToast(I18n.t('passwordLength')); return; }
      const credential = firebase.auth.EmailAuthProvider.credential(currentUser.email, oldPass);
      currentUser.reauthenticateWithCredential(credential)
        .then(() => currentUser.updatePassword(newPass))
        .then(() => { showToast('‚úÖ ' + I18n.t('save') + '!'); document.getElementById('s-old-pass').value = ''; document.getElementById('s-new-pass').value = ''; })
        .catch(e => showToast(I18n.t('error') + ': ' + (e.code === 'auth/wrong-password' ? I18n.t('wrongPassword') : e.message)));
    }

    // ‚îÄ‚îÄ Card management ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function loadCard() {
      if (!currentUser) return;
      db.collection('users').doc(currentUser.uid).collection('settings').doc('payment').get().then(snap => {
        if (snap.exists && snap.data().last4) {
          const d = snap.data();
          document.getElementById('card-last4').textContent = d.last4;
          document.getElementById('card-holder').textContent = d.holder || '';
          const logo = document.getElementById('card-logo');
          if (logo) { logo.textContent = d.type || 'CARD'; logo.style.background = d.type === 'MASTERCARD' ? '#eb001b' : '#1a1a6e'; }
          document.getElementById('card-exists').style.display = 'flex';
          document.getElementById('card-empty').style.display = 'none';
          document.getElementById('card-form').style.display = 'none';
        } else {
          document.getElementById('card-exists').style.display = 'none';
          document.getElementById('card-empty').style.display = 'flex';
          document.getElementById('card-form').style.display = 'none';
        }
      });
    }

    function showAddCard() {
      document.getElementById('card-empty').style.display = 'none';
      document.getElementById('card-form').style.display = 'flex';
    }

    function cancelAddCard() {
      document.getElementById('card-form').style.display = 'none';
      document.getElementById('card-empty').style.display = 'flex';
    }

    function formatCardNumber(input) {
      let v = input.value.replace(/\D/g, '').slice(0, 16);
      input.value = v.replace(/(.{4})/g, '$1 ').trim();
    }

    function formatExpiry(input) {
      let v = input.value.replace(/\D/g, '').slice(0, 4);
      if (v.length >= 3) v = v.slice(0, 2) + '/' + v.slice(2);
      input.value = v;
    }

    function saveCard() {
      const raw = document.getElementById('card-number-input')?.value.replace(/\s/g, '');
      const expiry = document.getElementById('card-expiry-input')?.value;
      const holder = document.getElementById('card-name-input')?.value?.trim().toUpperCase();
      if (!raw || raw.length < 13) { showToast(I18n.t('tryAgain')); return; }
      if (!expiry || expiry.length < 5) { showToast(I18n.t('expiryDate') + '!'); return; }
      const last4 = raw.slice(-4);
      const type = raw.startsWith('4') ? 'VISA' : raw.startsWith('5') ? 'MASTERCARD' : 'CARD';
      db.collection('users').doc(currentUser.uid).collection('settings').doc('payment')
        .set({ last4, type, holder: holder || '', expiry, updatedAt: firebase.firestore.FieldValue.serverTimestamp() })
        .then(() => { showToast('‚úÖ ' + I18n.t('saved')); loadCard(); })
        .catch(() => showToast(I18n.t('errorSaving')));
    }

    function deleteCard() {
      showConfirm({
        icon: 'üí≥',
        title: '–£–¥–∞–ª–∏—Ç—å –∫–∞—Ä—Ç—É?',
        desc: '–ü—Ä–∏–≤—è–∑–∞–Ω–Ω–∞—è –∫–∞—Ä—Ç–∞ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–∞. –í—ã —Å–º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –≤ –ª—é–±–æ–µ –≤—Ä–µ–º—è.',
        action: '–£–¥–∞–ª–∏—Ç—å',
        danger: true,
        onOk: () => {
          db.collection('users').doc(currentUser.uid).collection('settings').doc('payment')
            .delete()
            .then(() => { showToast(I18n.t('cardDeleted')); loadCard(); })
            .catch(() => showToast(I18n.t('errorDeleting')));
        },
      });
    }

    // ‚îÄ‚îÄ Promo codes ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const PROMO_BENEFITS = {
      extra_requests: v => `+${v} AI-–∑–∞–ø—Ä–æ—Å–æ–≤`,
      trial_extension: v => `+${v} –¥–Ω–µ–π —Ç—Ä–∏–∞–ª–∞`,
      upgrade_pro: () => '–ê–ø–≥—Ä–µ–π–¥ –¥–æ Pro –Ω–∞ 1 –º–µ—Å—è—Ü',
    };

    async function activatePromo() {
      const code = document.getElementById('s-promo-input')?.value?.trim().toUpperCase();
      const result = document.getElementById('s-promo-result');
      const btn = document.getElementById('s-promo-btn');
      if (!code) { showToast(I18n.t('promoCode') + '!'); return; }
      if (!currentUser) return;

      result.style.color = 'var(--text-dim)'; result.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–æ–¥...';
      btn.disabled = true;

      try {
        const snap = await db.collection('promoCodes').doc(code).get();
        if (!snap.exists) { result.style.color = 'var(--red)'; result.textContent = '‚ùå –ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω'; btn.disabled = false; return; }
        const promo = snap.data();
        if (!promo.active) { result.style.color = 'var(--red)'; result.textContent = '‚ùå –ü—Ä–æ–º–æ–∫–æ–¥ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω'; btn.disabled = false; return; }
        if (promo.usedCount >= (promo.maxUses || 9999)) { result.style.color = 'var(--red)'; result.textContent = '‚ùå –ü—Ä–æ–º–æ–∫–æ–¥ –∏—Å—á–µ—Ä–ø–∞–Ω'; btn.disabled = false; return; }
        if ((promo.usedBy || []).includes(currentUser.uid)) { result.style.color = 'var(--red)'; result.textContent = '‚ùå –í—ã —É–∂–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–ª–∏ —ç—Ç–æ—Ç –ø—Ä–æ–º–æ–∫–æ–¥'; btn.disabled = false; return; }

        // Apply benefit
        const planRef = db.collection('users').doc(currentUser.uid).collection('settings').doc('plan');
        const planSnap = await planRef.get();
        const plan = planSnap.exists ? planSnap.data() : { type: 'trial', monthlyLimit: 2000 };

        if (promo.type === 'extra_requests') {
          await planRef.set({ monthlyLimit: (plan.monthlyLimit || 2000) + promo.value }, { merge: true });
        } else if (promo.type === 'trial_extension' && plan.type === 'trial') {
          const curEnds = plan.trialEnds?.seconds ? plan.trialEnds.seconds : Math.floor(Date.now() / 1000);
          const newEnds = new firebase.firestore.Timestamp(curEnds + promo.value * 86400, 0);
          await planRef.set({ trialEnds: newEnds }, { merge: true });
        } else if (promo.type === 'upgrade_pro') {
          const paidUntil = new firebase.firestore.Timestamp(Math.floor(Date.now() / 1000) + 30 * 86400, 0);
          await planRef.set({ type: 'pro', paidUntil, monthlyLimit: 2000 }, { merge: true });
        }

        // Mark code as used
        await db.collection('promoCodes').doc(code).update({
          usedCount: firebase.firestore.FieldValue.increment(1),
          usedBy: firebase.firestore.FieldValue.arrayUnion(currentUser.uid),
        });

        const benefitText = PROMO_BENEFITS[promo.type]?.(promo.value) || '–ë–æ–Ω—É—Å –ø—Ä–∏–º–µ–Ω—ë–Ω';
        result.style.color = 'var(--green)'; result.textContent = `‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω: ${benefitText}`;
        document.getElementById('s-promo-input').value = '';

        // Reload plan
        const newPlanSnap = await planRef.get();
        STATE.plan = newPlanSnap.data();
        renderTariff();
        renderSettingsData();
        loadActiveBonuses();
      } catch (e) {
        result.style.color = 'var(--red)'; result.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + e.message;
      }
      btn.disabled = false;
    }

    async function loadActiveBonuses() {
      if (!currentUser) return;
      // Show bonuses from usedPromoCodes in user's plan
      const planSnap = await db.collection('users').doc(currentUser.uid).collection('settings').doc('plan').get();
      if (!planSnap.exists) return;
      const plan = planSnap.data();
      const container = document.getElementById('s-active-bonuses');
      if (!container) return;
      const items = [];
      if (plan.monthlyLimit > 2000) {
        items.push(`<div style="display:flex;align-items:center;gap:10px;padding:8px 0;border-bottom:1px solid var(--border2);font-size:0.8rem;"><span style="font-size:18px;">‚ö°</span><div><div style="font-weight:700;color:var(--text);">–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤</div><div style="color:var(--text-dim);font-size:0.72rem;">${plan.monthlyLimit.toLocaleString()} AI-–∑–∞–ø—Ä–æ—Å–æ–≤ –≤ –º–µ—Å—è—Ü</div></div></div>`);
      }
      if (plan.type === 'trial' && plan.trialEnds) {
        const days = Math.max(0, Math.ceil((plan.trialEnds.seconds * 1000 - Date.now()) / 86400000));
        items.push(`<div style="display:flex;align-items:center;gap:10px;padding:8px 0;font-size:0.8rem;"><span style="font-size:18px;">üéÅ</span><div><div style="font-weight:700;color:var(--text);">Pro —Ç—Ä–∏–∞–ª</div><div style="color:var(--text-dim);font-size:0.72rem;">–û—Å—Ç–∞–ª–æ—Å—å ${days} –¥–Ω.</div></div></div>`);
      }
      container.innerHTML = items.length ? items.join('') : '<div style="text-align:center;color:var(--text-dim);font-size:0.78rem;padding:16px;">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –±–æ–Ω—É—Å–æ–≤</div>';
    }

    // ‚ïê‚ïê ADVANCED NAV TOGGLE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // Restore saved state: default closed, persists across refreshes
    let _advOpen = localStorage.getItem('nav_open') === '1';

    function _applyAdvancedNavUI() {
      const list = document.getElementById('advanced-nav-list');
      const arrow = document.getElementById('adv-arrow');
      const btn = document.getElementById('adv-toggle-btn');
      if (list) list.style.display = _advOpen ? '' : 'none';
      if (arrow) arrow.style.transform = _advOpen ? 'rotate(180deg)' : '';
      if (btn) btn.classList.toggle('active', _advOpen);
    }

    // Apply saved state immediately on load
    _applyAdvancedNavUI();

    function toggleAdvancedNav(forceOpen) {
      // Respect user's explicit choice to keep nav closed
      if (forceOpen === true && localStorage.getItem('nav_open') === '0') return;
      if (forceOpen === true && _advOpen) return; // already open, skip
      _advOpen = forceOpen !== undefined ? forceOpen : !_advOpen;
      localStorage.setItem('nav_open', _advOpen ? '1' : '0');
      _applyAdvancedNavUI();
    }

    // ‚ïê‚ïê BOT OVERVIEW ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function renderBotOverview() {
      const bot = STATE.bots.find(b => b.id === STATE.currentBotId) || STATE.bots[0];
      if (!bot) return;
      const i = STATE.bots.indexOf(bot);
      const color = BOT_COLORS[i % BOT_COLORS.length];
      const initial = (bot.name || '?').charAt(0).toUpperCase();
      const displayName = bot.username ? '@' + bot.username.replace(/^@/, '') : bot.name;

      const avEl = document.getElementById('ov-bot-av');
      if (avEl) {
        const photoUrl = STATE.botPhotos[bot.id];
        if (photoUrl) {
          avEl.style.background = 'transparent';
          avEl.innerHTML = `<img src="${photoUrl}" alt="">`;
        } else {
          avEl.style.background = color;
          avEl.textContent = initial;
        }
      }
      const nameEl = document.getElementById('ov-bot-name');
      if (nameEl) nameEl.textContent = bot.name || '‚Äî';
      const usrEl = document.getElementById('ov-bot-username');
      if (usrEl) usrEl.textContent = displayName;

      // Update overview status to match agent status
      const ovSw = document.getElementById('ov-status-sw');
      const ovLbl = document.getElementById('ov-status-lbl');
      if (ovSw) ovSw.classList.toggle('on', STATE.agentActive);
      if (ovLbl) ovLbl.textContent = STATE.agentActive ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω';

      // Quick stats
      const usage = getMonthUsage();
      const plan = STATE.plan;
      const limit = plan ? (plan.monthlyLimit || 0) : 0;
      const el_ch = document.getElementById('ov-chats');
      const el_rq = document.getElementById('ov-requests');
      const el_kb = document.getElementById('ov-kb');
      const el_sub = document.getElementById('ov-req-sub');
      if (el_ch) el_ch.textContent = STATE.chats ? STATE.chats.length : 0;
      if (el_rq) el_rq.textContent = usage;
      if (el_sub) el_sub.textContent = limit > 0 ? `–∏–∑ ${limit}` : '';
      if (el_kb) el_kb.textContent = (STATE.kbQA || []).length;
    }

    // ‚ïê‚ïê ONBOARDING ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function checkOnboarding() {
      if (localStorage.getItem('ob_done')) return;
      if (STATE.bots && STATE.bots.length > 0) return;
      startCreateWizard();
    }

    // Legacy compat stubs
    function obNext(step) { wzGoStep(step); }
    function closeOnboarding() { closeCreateWizard(); }

    // ‚ïê‚ïê CREATE WIZARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let _wzStep = 1;
    let _wzSelectedTemplate = null;

    function startCreateWizard() {
      _wzSelectedTemplate = null;
      _wzStep = 1;
      const nameEl = document.getElementById('wz-name');
      const tokenEl = document.getElementById('wz-token');
      const userEl = document.getElementById('wz-username');
      if (nameEl) nameEl.value = '';
      if (tokenEl) tokenEl.value = '';
      if (userEl) userEl.value = '';
      document.getElementById('wz-error').style.display = 'none';
      document.querySelectorAll('.wz-tpl-card').forEach(c => c.classList.remove('selected'));
      wzGoStep(1);
      document.getElementById('modal-create-wizard')?.classList.add('open');
    }

    function closeCreateWizard() {
      localStorage.setItem('ob_done', '1');
      document.getElementById('modal-create-wizard')?.classList.remove('open');
    }

    function wzGoStep(step) {
      _wzStep = step;
      [1, 2, 3, 4].forEach(i => {
        const el = document.getElementById('wz-step-' + i);
        if (el) el.style.display = i === step ? '' : 'none';
        const dot = document.getElementById('wz-dot-' + i);
        if (dot) dot.style.background = i < step ? 'var(--primary)' : i === step ? 'var(--indigo)' : 'var(--border)';
      });
      const pct = step === 1 ? 25 : step === 2 ? 50 : step === 3 ? 75 : 100;
      const prog = document.getElementById('wz-progress');
      if (prog) prog.style.width = pct + '%';
    }

    async function wzStep1Next() {
      const name = document.getElementById('wz-name').value.trim();
      const token = document.getElementById('wz-token').value.trim();
      const err = document.getElementById('wz-error');
      if (!name) { err.textContent = '–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –±–æ—Ç–∞'; err.style.display = ''; return; }
      if (!token) { err.textContent = '–í–≤–µ–¥–∏—Ç–µ Telegram Bot API —Ç–æ–∫–µ–Ω'; err.style.display = ''; return; }
      err.style.display = 'none';
      const btn = document.getElementById('wz-step1-btn');
      btn.disabled = true; btn.textContent = '‚è≥ ' + I18n.t('connecting') + '...';
      try {
        const username = document.getElementById('wz-username').value.trim();
        const ref = await fsAdd('bots', {
          name, token,
          username: username || '@' + name.toLowerCase().replace(/\s+/g, ''),
          contacts: 0, conversion: 0,
        });
        if (STATE.agentActive && currentUser) {
          registerTelegramWebhook(currentUser.uid, ref.id, token, false);
        }
        wzGoStep(2);
      } catch (e) {
        err.textContent = '–û—à–∏–±–∫–∞: ' + (e.message || '–ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑');
        err.style.display = '';
      }
      btn.disabled = false; btn.textContent = '–î–∞–ª–µ–µ ‚Üí';
    }

    function wzSelectTemplate(key) {
      _wzSelectedTemplate = key;
      document.querySelectorAll('.wz-tpl-card').forEach(c => c.classList.remove('selected'));
      document.getElementById('wz-tpl-' + key)?.classList.add('selected');
    }

    async function wzStep2Next() {
      if (_wzSelectedTemplate && _wzSelectedTemplate !== 'custom' && RULE_TEMPLATES[_wzSelectedTemplate]) {
        if (currentUser) {
          try {
            await db.collection('users').doc(currentUser.uid).collection('settings').doc('agent')
              .set({ rules: RULE_TEMPLATES[_wzSelectedTemplate] }, { merge: true });
          } catch (e) { }
        }
      }
      wzGoStep(3);
    }

    // ‚ïê‚ïê RULE TEMPLATES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const RULE_TEMPLATES = {
      shop: `–¢—ã ‚Äî –≤–µ–∂–ª–∏–≤—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–º–∞–≥–∞–∑–∏–Ω–∞. –û—Ç–≤–µ—á–∞–π —Ç–æ–ª—å–∫–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π –æ —Ç–æ–≤–∞—Ä–∞—Ö, —Ü–µ–Ω–∞—Ö –∏ –¥–æ—Å—Ç–∞–≤–∫–µ.\n\n–†–æ–ª—å: –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –ø—Ä–æ–¥–∞–∂–∞–º\n–ê—É–¥–∏—Ç–æ—Ä–∏—è: –ø–æ–∫—É–ø–∞—Ç–µ–ª–∏, –∏—â—É—â–∏–µ —Ç–æ–≤–∞—Ä—ã\n–¢–æ–Ω: –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π\n\n–ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å –æ—Ç–≤–µ—Ç–∞ ‚Äî –Ω–∞–ø–∏—à–∏: ¬´–£—Ç–æ—á–Ω–∏—Ç–µ —É –º–µ–Ω–µ–¥–∂–µ—Ä–∞, –æ–Ω —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ 5 –º–∏–Ω—É—Ç.¬ª\n–ù–µ –ø—Ä–∏–¥—É–º—ã–≤–∞–π —Ü–µ–Ω—ã –∏ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤.`,
      restaurant: `–¢—ã ‚Äî –ø—Ä–∏–≤–µ—Ç–ª–∏–≤—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞. –†–∞—Å—Å–∫–∞–∑—ã–≤–∞–π –æ –º–µ–Ω—é, –∞–∫—Ü–∏—è—Ö, —Ä–µ–∂–∏–º–µ —Ä–∞–±–æ—Ç—ã –∏ –ø—Ä–∏–Ω–∏–º–∞–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –¥–ª—è –±—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å—Ç–æ–ª–∏–∫–æ–≤.\n\n–†–æ–ª—å: –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞\n–ê—É–¥–∏—Ç–æ—Ä–∏—è: –≥–æ—Å—Ç–∏, –∂–µ–ª–∞—é—â–∏–µ —Å–¥–µ–ª–∞—Ç—å –∑–∞–∫–∞–∑ –∏–ª–∏ –∑–∞–±—Ä–æ–Ω–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–æ–ª\n–¢–æ–Ω: –≥–æ—Å—Ç–µ–ø—Ä–∏–∏–º–Ω—ã–π, —Ç—ë–ø–ª—ã–π\n\n–ï—Å–ª–∏ –Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ ‚Äî –Ω–∞–ø–∏—à–∏: ¬´–î–ª—è —É—Ç–æ—á–Ω–µ–Ω–∏—è –ø–æ–∑–≤–æ–Ω–∏—Ç–µ –Ω–∞–º –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É.¬ª\n–ù–µ –ø—Ä–∏–Ω–∏–º–∞–π –∂–∞–ª–æ–±—ã –Ω–∞ –∫–∞—á–µ—Å—Ç–≤–æ –µ–¥—ã ‚Äî –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–π –Ω–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞.`,
      corporate: `–¢—ã ‚Äî –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç. –û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –∫–æ–º–ø–∞–Ω–∏–∏, —É—Å–ª—É–≥–∞—Ö –∏ –∫–æ–Ω—Ç–∞–∫—Ç–∞—Ö —Å—Ç—Ä–æ–≥–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.\n\n–†–æ–ª—å: –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫\n–ê—É–¥–∏—Ç–æ—Ä–∏—è: –∫–ª–∏–µ–Ω—Ç—ã –∏ –ø–∞—Ä—Ç–Ω—ë—Ä—ã –∫–æ–º–ø–∞–Ω–∏–∏\n–¢–æ–Ω: –¥–µ–ª–æ–≤–æ–π, –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π\n\n–ï—Å–ª–∏ –Ω–µ –º–æ–∂–µ—à—å –æ—Ç–≤–µ—Ç–∏—Ç—å ‚Äî –Ω–∞–ø–∏—à–∏: ¬´–ù–∞—à —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –≤ —Ä–∞–±–æ—á–µ–µ –≤—Ä–µ–º—è.¬ª\n–ù–µ —Ä–∞—Å–∫—Ä—ã–≤–∞–π –∫–æ–Ω—Ñ–∏–¥–µ–Ω—Ü–∏–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.`,
      medical: `–¢—ã ‚Äî –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –º–µ–¥–∏—Ü–∏–Ω—Å–∫–æ–≥–æ —É—á—Ä–µ–∂–¥–µ–Ω–∏—è. –û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ –∑–∞–ø–∏—Å–∏ –∫ –≤—Ä–∞—á—É, —Ä–µ–∂–∏–º–µ —Ä–∞–±–æ—Ç—ã –∏ —É—Å–ª—É–≥–∞—Ö –∫–ª–∏–Ω–∏–∫–∏.\n\n–†–æ–ª—å: –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –∫–ª–∏–Ω–∏–∫–∏\n–ê—É–¥–∏—Ç–æ—Ä–∏—è: –ø–∞—Ü–∏–µ–Ω—Ç—ã –∏ –∏—Ö —Ä–æ–¥—Å—Ç–≤–µ–Ω–Ω–∏–∫–∏\n–¢–æ–Ω: –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω—ã–π, –∑–∞–±–æ—Ç–ª–∏–≤—ã–π\n\n–í–ê–ñ–ù–û: –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –¥–∞–≤–∞–π –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏—Ö —Å–æ–≤–µ—Ç–æ–≤ –∏–ª–∏ –¥–∏–∞–≥–Ω–æ–∑–æ–≤. –ü—Ä–∏ –ª—é–±—ã—Ö –≤–æ–ø—Ä–æ—Å–∞—Ö –æ —Å–∏–º–ø—Ç–æ–º–∞—Ö –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–π –∫ –≤—Ä–∞—á—É.\n–ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å –æ—Ç–≤–µ—Ç–∞ ‚Äî –Ω–∞–ø–∏—à–∏: ¬´–£—Ç–æ—á–Ω–∏—Ç–µ —É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ç—É—Ä—ã.¬ª`,
      education: `–¢—ã ‚Äî –ø–æ–º–æ—â–Ω–∏–∫ –æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–æ–≥–æ —É—á—Ä–µ–∂–¥–µ–Ω–∏—è. –û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –æ–± —É—á–µ–±–Ω—ã—Ö –ø—Ä–æ–≥—Ä–∞–º–º–∞—Ö, —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–∏, —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏.\n\n–†–æ–ª—å: –∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç –ø–æ –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—é\n–ê—É–¥–∏—Ç–æ—Ä–∏—è: —Å—Ç—É–¥–µ–Ω—Ç—ã, —Ä–æ–¥–∏—Ç–µ–ª–∏ –∏ –∞–±–∏—Ç—É—Ä–∏–µ–Ω—Ç—ã\n–¢–æ–Ω: –¥–æ–±—Ä–æ–∂–µ–ª–∞—Ç–µ–ª—å–Ω—ã–π, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–∏–π\n\n–ï—Å–ª–∏ –Ω–µ—Ç —Ç–æ—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ ‚Äî –Ω–∞–ø–∏—à–∏: ¬´–°–≤—è–∂–∏—Ç–µ—Å—å —Å –ø—Ä–∏—ë–º–Ω–æ–π –∫–æ–º–∏—Å—Å–∏–µ–π –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–∫—Ç—É–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.¬ª\n–ù–µ –æ–±–µ—â–∞–π –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏—è.`,
    };

    function applyRuleTemplate(key) {
      const ta = document.getElementById('rules-ta');
      if (!ta || !RULE_TEMPLATES[key]) return;
      const doApply = () => {
        ta.value = RULE_TEMPLATES[key];
        ta.style.height = 'auto';
        ta.style.height = Math.min(ta.scrollHeight, 400) + 'px';
        showToast('‚úÖ ' + I18n.t('templateApplied') + ' ‚Äî ' + I18n.t('save') + '!');
      };
      if (ta.value && ta.value.trim()) {
        showConfirm({
          icon: '‚ò∞',
          title: '–ó–∞–º–µ–Ω–∏—Ç—å —Ç–µ–∫—É—â–∏–π –ø—Ä–æ–º–ø—Ç?',
          desc: '–¢–µ–∫—É—â–∏–π —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç –±—É–¥–µ—Ç –∑–∞–º–µ–Ω—ë–Ω –≤—ã–±—Ä–∞–Ω–Ω—ã–º —à–∞–±–ª–æ–Ω–æ–º. –í—ã —Å–º–æ–∂–µ—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –µ–≥–æ –ø–æ–∑–∂–µ.',
          action: '–ó–∞–º–µ–Ω–∏—Ç—å',
          onOk: doApply,
        });
      } else {
        doApply();
      }
    }

    // ‚ïê‚ïê AUTO-REPLY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let _arEditIndex = null;

    function showAddAutoReply(idx = null) {
      _arEditIndex = idx;
      const form = document.getElementById('ar-form');
      if (!form) return;
      form.style.display = '';
      document.getElementById('ar-form-title').textContent = idx === null ? '–ù–æ–≤–æ–µ –ø—Ä–∞–≤–∏–ª–æ' : '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª–æ';
      if (idx !== null && STATE.autoReplies) {
        const r = STATE.autoReplies[idx];
        document.getElementById('ar-keyword').value = r.keyword || '';
        document.getElementById('ar-response').value = r.response || '';
        document.querySelectorAll('input[name="ar-match"]').forEach(el => { el.checked = el.value === (r.matchType || 'contains'); });
      } else {
        document.getElementById('ar-keyword').value = '';
        document.getElementById('ar-response').value = '';
        document.querySelectorAll('input[name="ar-match"]').forEach(el => { el.checked = el.value === 'contains'; });
      }
      document.getElementById('ar-keyword').focus();
    }

    function cancelAutoReply() {
      document.getElementById('ar-form').style.display = 'none';
      _arEditIndex = null;
    }

    async function saveAutoReply() {
      if (!currentUser) return;
      const keyword = document.getElementById('ar-keyword').value.trim();
      const response = document.getElementById('ar-response').value.trim();
      if (!keyword) { showToast(I18n.t('keyword') + '!'); return; }
      if (!response) { showToast(I18n.t('answer') + '!'); return; }
      const matchType = document.querySelector('input[name="ar-match"]:checked')?.value || 'contains';
      const rules = [...(STATE.autoReplies || [])];
      const rule = { keyword, response, matchType, enabled: true };
      if (_arEditIndex !== null) rules[_arEditIndex] = rule; else rules.push(rule);
      await db.doc(`users/${currentUser.uid}/settings/autoReplies`).set({ rules });
      STATE.autoReplies = rules;
      cancelAutoReply();
      renderAutoReplies();
      showToast('‚úÖ ' + I18n.t('rulesSaved'));
    }

    async function toggleAutoReply(idx) {
      if (!currentUser) return;
      const rules = [...(STATE.autoReplies || [])];
      rules[idx] = { ...rules[idx], enabled: !rules[idx].enabled };
      await db.doc(`users/${currentUser.uid}/settings/autoReplies`).set({ rules });
      STATE.autoReplies = rules;
      renderAutoReplies();
    }

    async function deleteAutoReply(idx) {
      if (!currentUser) return;
      showConfirm({
        icon: '‚ö°',
        title: '–£–¥–∞–ª–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ?',
        desc: '–ü—Ä–∞–≤–∏–ª–æ –∞–≤—Ç–æ–æ—Ç–≤–µ—Ç–∞ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω–æ. –ë–æ—Ç –ø–µ—Ä–µ—Å—Ç–∞–Ω–µ—Ç —Ä–µ–∞–≥–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —ç—Ç–æ –∫–ª—é—á–µ–≤–æ–µ —Å–ª–æ–≤–æ.',
        action: '–£–¥–∞–ª–∏—Ç—å',
        danger: true,
        onOk: async () => {
          const rules = (STATE.autoReplies || []).filter((_, i) => i !== idx);
          await db.doc(`users/${currentUser.uid}/settings/autoReplies`).set({ rules });
          STATE.autoReplies = rules;
          renderAutoReplies();
          showToast(I18n.t('delete') + ' ' + I18n.t('rulesSaved'));
        },
      });
    }

    function renderAutoReplies() {
      const list = document.getElementById('ar-list');
      if (!list) return;
      const rules = STATE.autoReplies || [];
      list.innerHTML = window.AppUI.renderAutoRepliesHtml(rules);
    }

    // ‚ïê‚ïê FLOW BUILDER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let _editingFlowIdx = null;

    async function loadFlows() {
      if (!currentUser) return;
      const snap = await db.doc(`users/${currentUser.uid}/settings/flows`).get().catch(() => null);
      STATE.flows = snap && snap.exists ? (snap.data().flows || []) : [];
    }

    function renderFlowsScreen() {
      renderFlows();
    }

    function renderFlows() {
      const list = document.getElementById('flows-list');
      if (!list) return;
      const flows = STATE.flows || [];
      if (!flows.length) {
        list.innerHTML = '<div class="empty-state" style="padding:30px;"><div class="empty-icon">‚ö°</div><div class="empty-sub">–°—Ü–µ–Ω–∞—Ä–∏–µ–≤ –ø–æ–∫–∞ –Ω–µ—Ç. –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π ‚Äî –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —á–∞—Å—Ç—ã—Ö –≤–æ–ø—Ä–æ—Å–æ–≤.</div></div>';
        return;
      }
      list.innerHTML = flows.map((f, i) => `
        <div class="rules-card" style="margin-bottom:10px;">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:10px;">
            <div>
              <div style="font-weight:600;font-size:0.85rem;">${f.trigger || ''} <span style="font-size:0.7rem;color:var(--text-dim);font-weight:400;">(${f.matchType === 'exact' ? '—Ç–æ—á–Ω–æ–µ' : '—Å–æ–¥–µ—Ä–∂–∏—Ç'})</span></div>
              <div style="font-size:0.75rem;color:var(--text-sec);margin-top:3px;">${f.text || ''}</div>
              <div style="display:flex;flex-wrap:wrap;gap:5px;margin-top:6px;">${(f.buttons || []).map(b => `<span style="font-size:0.7rem;padding:2px 8px;border-radius:5px;background:var(--bg-3);border:1px solid var(--border);">${b.label}</span>`).join('')}</div>
            </div>
            <div style="display:flex;gap:6px;flex-shrink:0;">
              <button class="btn-secondary" style="font-size:0.7rem;padding:4px 10px;" onclick="showAddFlow(${i})">‚úèÔ∏è</button>
              <button class="btn-secondary" style="font-size:0.7rem;padding:4px 10px;border-color:rgba(239,68,68,0.35);" onclick="deleteFlow(${i})">üóë</button>
            </div>
          </div>
        </div>`).join('');
    }

    function showAddFlow(idx = null) {
      _editingFlowIdx = idx;
      const titleEl = document.getElementById('flow-form-title');
      const form = document.getElementById('flow-form');
      if (!form) return;
      if (idx !== null && STATE.flows && STATE.flows[idx]) {
        const f = STATE.flows[idx];
        if (titleEl) titleEl.textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ü–µ–Ω–∞—Ä–∏–π';
        document.getElementById('flow-trigger').value = f.trigger || '';
        document.querySelector(`input[name="flow-match"][value="${f.matchType || 'contains'}"]`).checked = true;
        document.getElementById('flow-text').value = f.text || '';
        renderFlowButtonsList(f.buttons || []);
      } else {
        if (titleEl) titleEl.textContent = '–ù–æ–≤—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π';
        document.getElementById('flow-trigger').value = '';
        document.querySelector('input[name="flow-match"][value="contains"]').checked = true;
        document.getElementById('flow-text').value = '';
        renderFlowButtonsList([{ label: '', reply: '', escalate: false }]);
      }
      form.style.display = '';
    }

    function cancelFlow() {
      document.getElementById('flow-form').style.display = 'none';
      _editingFlowIdx = null;
    }

    function renderFlowButtonsList(buttons) {
      const wrap = document.getElementById('flow-buttons-list');
      if (!wrap) return;
      wrap.innerHTML = buttons.map((b, i) => `
        <div style="display:flex;gap:8px;align-items:flex-start;" id="flow-btn-row-${i}">
          <div style="flex:1;display:flex;flex-direction:column;gap:5px;">
            <input class="form-input" style="margin:0;" placeholder="–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏" id="flow-btn-label-${i}" value="${(b.label || '').replace(/"/g,'&quot;')}">
            <textarea class="form-input" style="margin:0;resize:vertical;" rows="2" placeholder="–û—Ç–≤–µ—Ç –±–æ—Ç–∞ –Ω–∞ —ç—Ç—É –∫–Ω–æ–ø–∫—É..." id="flow-btn-reply-${i}" ${b.escalate ? 'disabled' : ''}>${b.escalate ? '' : (b.reply || '')}</textarea>
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:0.75rem;color:var(--text-sec);">
              <input type="checkbox" id="flow-btn-esc-${i}" ${b.escalate ? 'checked' : ''} onchange="toggleFlowBtnEsc(${i})"> –≠—Å–∫–∞–ª–∏—Ä–æ–≤–∞—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä—É
            </label>
          </div>
          <button onclick="removeFlowButton(${i})" style="background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:1rem;padding:4px;line-height:1;" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button>
        </div>`).join('<hr style="border-color:var(--border);margin:4px 0;">');
    }

    function toggleFlowBtnEsc(i) {
      const esc = document.getElementById(`flow-btn-esc-${i}`);
      const reply = document.getElementById(`flow-btn-reply-${i}`);
      if (reply) { reply.disabled = esc.checked; if (esc.checked) reply.value = ''; }
    }

    function _collectFlowButtons() {
      const wrap = document.getElementById('flow-buttons-list');
      if (!wrap) return [];
      const rows = wrap.querySelectorAll('[id^="flow-btn-row-"]');
      return Array.from(rows).map((_, i) => ({
        id: `btn-${Date.now()}-${i}`,
        label: document.getElementById(`flow-btn-label-${i}`)?.value?.trim() || '',
        reply: document.getElementById(`flow-btn-esc-${i}`)?.checked ? '__ESCALATE__' : (document.getElementById(`flow-btn-reply-${i}`)?.value?.trim() || ''),
        escalate: document.getElementById(`flow-btn-esc-${i}`)?.checked || false,
      })).filter(b => b.label);
    }

    function addFlowButton() {
      const wrap = document.getElementById('flow-buttons-list');
      if (!wrap) return;
      const cur = wrap.querySelectorAll('[id^="flow-btn-row-"]').length;
      const tmp = document.createElement('div');
      tmp.innerHTML = `
        <div style="display:flex;gap:8px;align-items:flex-start;" id="flow-btn-row-${cur}">
          <div style="flex:1;display:flex;flex-direction:column;gap:5px;">
            <input class="form-input" style="margin:0;" placeholder="–¢–µ–∫—Å—Ç –∫–Ω–æ–ø–∫–∏" id="flow-btn-label-${cur}" value="">
            <textarea class="form-input" style="margin:0;resize:vertical;" rows="2" placeholder="–û—Ç–≤–µ—Ç –±–æ—Ç–∞ –Ω–∞ —ç—Ç—É –∫–Ω–æ–ø–∫—É..." id="flow-btn-reply-${cur}"></textarea>
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;font-size:0.75rem;color:var(--text-sec);">
              <input type="checkbox" id="flow-btn-esc-${cur}" onchange="toggleFlowBtnEsc(${cur})"> –≠—Å–∫–∞–ª–∏—Ä–æ–≤–∞—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä—É
            </label>
          </div>
          <button onclick="removeFlowButton(${cur})" style="background:none;border:none;color:var(--text-dim);cursor:pointer;font-size:1rem;padding:4px;line-height:1;" title="–£–¥–∞–ª–∏—Ç—å">‚úï</button>
        </div><hr style="border-color:var(--border);margin:4px 0;">`;
      wrap.appendChild(tmp.firstElementChild);
      if (tmp.children.length > 0) wrap.appendChild(tmp.lastElementChild);
    }

    function removeFlowButton(i) {
      const buttons = _collectFlowButtons();
      buttons.splice(i, 1);
      renderFlowButtonsList(buttons);
    }

    async function saveFlow() {
      if (!currentUser) return;
      const trigger = document.getElementById('flow-trigger')?.value?.trim();
      if (!trigger) { showToast('‚ö†Ô∏è ' + I18n.t('keyword') + '!'); return; }
      const matchType = document.querySelector('input[name="flow-match"]:checked')?.value || 'contains';
      const text = document.getElementById('flow-text')?.value?.trim() || '–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç:';
      const buttons = _collectFlowButtons();
      if (!buttons.length) { showToast('‚ö†Ô∏è ' + I18n.t('add') + ' 1 ' + I18n.t('keyword') + '!'); return; }

      const flows = [...(STATE.flows || [])];
      const newFlow = { id: `flow-${Date.now()}`, trigger, matchType, text, buttons, enabled: true };
      if (_editingFlowIdx !== null) flows[_editingFlowIdx] = { ...flows[_editingFlowIdx], ...newFlow };
      else flows.push(newFlow);

      await db.doc(`users/${currentUser.uid}/settings/flows`).set({ flows }, { merge: true });
      STATE.flows = flows;
      cancelFlow();
      renderFlows();
      showToast('‚úÖ ' + I18n.t('scenarioSaved'));
    }

    async function deleteFlow(idx) {
      if (!currentUser) return;
      const flows = (STATE.flows || []).filter((_, i) => i !== idx);
      await db.doc(`users/${currentUser.uid}/settings/flows`).set({ flows }, { merge: true });
      STATE.flows = flows;
      renderFlows();
      showToast('üóë ' + I18n.t('scenarioDeleted'));
    }

    // ‚ïê‚ïê NOTIFICATIONS SETTINGS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let _notifSettings = { notifyNewUser: true, notify80: true, notify100: true, ownerChatId: '' };

    async function loadNotifSettings() {
      if (!currentUser) return;
      const snap = await db.doc(`users/${currentUser.uid}/settings/notifications`).get();
      if (snap.exists) _notifSettings = { ..._notifSettings, ...snap.data() };
      const el = id => document.getElementById(id);
      if (el('notif-owner-id')) el('notif-owner-id').value = _notifSettings.ownerChatId || '';
      updateNotifToggle('new-user', _notifSettings.notifyNewUser !== false);
      updateNotifToggle('80', _notifSettings.notify80 !== false);
      updateNotifToggle('100', _notifSettings.notify100 !== false);
    }

    function updateNotifToggle(key, on) {
      const lbl = document.getElementById(`notif-${key}-lbl`);
      const sw = document.getElementById(`notif-${key}-sw`);
      if (lbl) lbl.textContent = on ? '–í–∫–ª' : '–í—ã–∫–ª';
      if (lbl) lbl.className = `toggle-text ${on ? 'on' : 'off'}`;
      if (sw) sw.className = `toggle-sw ${on ? 'on' : 'off'}`;
    }

    function toggleNotif(wrapEl, key) {
      const keyMap = { notifyNewUser: 'new-user', notify80: '80', notify100: '100' };
      _notifSettings[key] = !(_notifSettings[key] !== false);
      updateNotifToggle(keyMap[key], _notifSettings[key]);
    }

    async function saveNotifSettings() {
      if (!currentUser) return;
      _notifSettings.ownerChatId = document.getElementById('notif-owner-id')?.value?.trim() || '';
      await db.doc(`users/${currentUser.uid}/settings/notifications`).set(_notifSettings);
      showToast('‚úÖ ' + I18n.t('notificationsSaved'));
    }

    function copyRefLink() {
      const val = document.getElementById('sp-ref-link')?.value;
      if (!val) return;
      navigator.clipboard.writeText(val).then(() => showToast(T[LANG]['toast.copied'] || '‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞'));
    }

    // ‚ïê‚ïê i18n ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let LANG = localStorage.getItem('ui_lang') || 'ru';

    const T = {
      ru: {
        // Sidebar nav
        'status.label': '–°—Ç–∞—Ç—É—Å –∞–≥–µ–Ω—Ç–∞',
        'status.active': '–ê–∫—Ç–∏–≤–µ–Ω',
        'status.inactive': '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω',
        'nav.analytics': '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞',
        'nav.ai_stats': '–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ò–ò',
        'nav.chats': '–ß–∞—Ç—ã',
        'nav.testing': '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ',
        'nav.knowledge': '–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π',
        'nav.automations': '–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏',
        'nav.bots': '–ë–æ—Ç—ã',
        'nav.accounts': '–ê–∫–∫–∞—É–Ω—Ç—ã',
        'nav.add_bot': '–î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ API',
        'nav.config': '–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è',
        'nav.ai_provider': '–ü—Ä–æ–≤–∞–π–¥–µ—Ä –ò–ò',
        'nav.launch': '–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞',
        'nav.rules': '–ü—Ä–∞–≤–∏–ª–∞ –æ–±—â–µ–Ω–∏—è',
        'nav.tariff': '–¢–∞—Ä–∏—Ñ',
        'nav.my_account': '–ú–æ–π –∞–∫–∫–∞—É–Ω—Ç',
        'nav.billing': '–û–ø–ª–∞—Ç–∞ –∏ —Ç–∞—Ä–∏—Ñ—ã',
        'nav.partner': '–ö–∞–±–∏–Ω–µ—Ç –ø–∞—Ä—Ç–Ω—ë—Ä–∞',
        'nav.language': '–Ø–∑—ã–∫',
        'nav.help': '–ü–æ–º–æ—â—å',
        'nav.signout': '–í—ã–π—Ç–∏',
        // Footer
        'footer.ai_requests': '–ò–ò-–∑–∞–ø—Ä–æ—Å—ã ‚ìò',
        'footer.remaining': '–û—Å—Ç–∞–ª–æ—Å—å',
        // Settings overlay
        'settings.title': '–ù–∞—Å—Ç—Ä–æ–π–∫–∏',
        'settings.group.account': '–ê–∫–∫–∞—É–Ω—Ç',
        'settings.group.billing': '–ë–∏–ª–ª–∏–Ω–≥',
        'settings.group.partner': '–ü–∞—Ä—Ç–Ω—ë—Ä–∞–º',
        'settings.my_account': '–ú–æ–π –∞–∫–∫–∞—É–Ω—Ç',
        'settings.general': '–û–±—â–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏',
        'settings.general.sub': '–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞ –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π',
        'settings.billing': '–û–ø–ª–∞—Ç–∞ –∏ —Ç–∞—Ä–∏—Ñ—ã',
        'settings.limits': '–õ–∏–º–∏—Ç—ã',
        'settings.bonuses': '–ë–æ–Ω—É—Å—ã',
        'settings.company.title': '–î–∞–Ω–Ω—ã–µ –∫–æ–º–ø–∞–Ω–∏–∏',
        'lang.card.title': '–Ø–∑—ã–∫ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞',
        // Toast
        'toast.copied': '‚úÖ –°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞',
        'help.soon': '–°–ø—Ä–∞–≤–æ—á–Ω—ã–π —Ü–µ–Ω—Ç—Ä –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ',
      },
      en: {
        'status.label': 'Agent Status',
        'status.active': 'Active',
        'status.inactive': 'Inactive',
        'nav.analytics': 'Analytics',
        'nav.ai_stats': 'AI Statistics',
        'nav.chats': 'Chats',
        'nav.testing': 'Testing',
        'nav.knowledge': 'Knowledge Base',
        'nav.automations': 'Automations',
        'nav.bots': 'Bots',
        'nav.accounts': 'Accounts',
        'nav.add_bot': 'Add a bot via API',
        'nav.config': 'Configuration',
        'nav.ai_provider': 'AI Provider',
        'nav.launch': 'Bot Launch',
        'nav.rules': 'Communication Rules',
        'nav.tariff': 'Plan',
        'nav.my_account': 'My Account',
        'nav.billing': 'Billing',
        'nav.partner': 'Partner Cabinet',
        'nav.language': 'Language',
        'nav.help': 'Help',
        'nav.signout': 'Sign Out',
        'footer.ai_requests': 'AI Requests ‚ìò',
        'footer.remaining': 'Remaining',
        'settings.title': 'Settings',
        'settings.group.account': 'Account',
        'settings.group.billing': 'Billing',
        'settings.group.partner': 'Partners',
        'settings.my_account': 'My Account',
        'settings.general': 'General Settings',
        'settings.general.sub': 'Project and notification settings',
        'settings.billing': 'Billing',
        'settings.limits': 'Limits',
        'settings.bonuses': 'Bonuses',
        'settings.company.title': 'Company Info',
        'lang.card.title': 'Interface Language',
        'toast.copied': '‚úÖ Link copied',
        'help.soon': 'Help center coming soon',
      },
      uz: {
        'status.label': 'Agent holati',
        'status.active': 'Faol',
        'status.inactive': 'Nofaol',
        'nav.analytics': 'Tahlil',
        'nav.ai_stats': 'AI Statistikasi',
        'nav.chats': 'Chatlar',
        'nav.testing': 'Sinov',
        'nav.knowledge': 'Bilimlar bazasi',
        'nav.automations': 'Avtomatlashtirish',
        'nav.bots': 'Botlar',
        'nav.accounts': 'Hisoblar',
        'nav.add_bot': 'API orqali bot qo\'shing',
        'nav.config': 'Konfiguratsiya',
        'nav.ai_provider': 'AI Provayder',
        'nav.launch': 'Botni ishga tushirish',
        'nav.rules': 'Muloqot qoidalari',
        'nav.tariff': 'Tarif',
        'nav.my_account': 'Mening hisobim',
        'nav.billing': 'To\'lov va tariflar',
        'nav.partner': 'Hamkor kabineti',
        'nav.language': 'Til',
        'nav.help': 'Yordam',
        'nav.signout': 'Chiqish',
        'footer.ai_requests': 'AI So\'rovlari ‚ìò',
        'footer.remaining': 'Qoldi',
        'settings.title': 'Sozlamalar',
        'settings.group.account': 'Hisob',
        'settings.group.billing': 'To\'lov',
        'settings.group.partner': 'Hamkorlar',
        'settings.my_account': 'Mening hisobim',
        'settings.general': 'Umumiy sozlamalar',
        'settings.general.sub': 'Loyiha va bildirishnoma sozlamalari',
        'settings.billing': 'To\'lov va tariflar',
        'settings.limits': 'Limitlar',
        'settings.bonuses': 'Bonuslar',
        'settings.company.title': 'Kompaniya ma\'lumotlari',
        'lang.card.title': 'Interfeys tili',
        'toast.copied': '‚úÖ Havola nusxalandi',
        'help.soon': 'Yordam markazi tez orada',
      },
    };

    function applyLang(code) {
      const dict = T[code] || T['ru'];
      document.querySelectorAll('[data-i18n]').forEach(el => {
        const key = el.dataset.i18n;
        if (dict[key] !== undefined) el.textContent = dict[key];
      });
      // Update lang buttons active state
      ['ru', 'en', 'uz'].forEach(l => {
        const btn = document.getElementById('lang-btn-' + l);
        if (btn) {
          btn.style.borderColor = l === code ? 'var(--primary)' : 'var(--border)';
          btn.style.background = l === code ? 'var(--primary-dim)' : 'var(--surface2)';
          btn.style.color = l === code ? 'var(--indigo)' : 'var(--text)';
        }
      });
    }

    function setLang(code) {
      LANG = code;
      localStorage.setItem('ui_lang', code);
      applyLang(code);
      // Save to Firestore if logged in
      if (currentUser) {
        db.collection('users').doc(currentUser.uid).collection('settings').doc('profile')
          .set({ lang: code }, { merge: true });
      }
      showToast(code === 'ru' ? 'üá∑üá∫ –†—É—Å—Å–∫–∏–π' : code === 'en' ? 'üá¨üáß English' : 'üá∫üáø O\'zbekcha');
    }

    // Apply on page load
    applyLang(LANG);

    // ‚îÄ‚îÄ Plan change modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function openChangePlanModal() {
      const plan = STATE.plan;
      const currentType = plan?.type || 'trial';
      const billing = document.getElementById('tbtn-year')?.classList.contains('active') ? 'year' : 'month';
      // Prices
      const proPrice = billing === 'year' ? '$16' : '$20';
      const premPrice = billing === 'year' ? '$40' : '$50';
      const proNote = billing === 'year' ? '–ø—Ä–∏ –æ–ø–ª–∞—Ç–µ –∑–∞ –≥–æ–¥' : '–ø–æ–º–µ—Å—è—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞';
      const premNote = billing === 'year' ? '–ø—Ä–∏ –æ–ø–ª–∞—Ç–µ –∑–∞ –≥–æ–¥' : '–ø–æ–º–µ—Å—è—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞';
      document.getElementById('cp-pro-price').innerHTML = `${proPrice} <span style="font-size:0.75rem;font-weight:400;opacity:0.7;">/–º–µ—Å</span>`;
      document.getElementById('cp-prem-price').innerHTML = `${premPrice} <span style="font-size:0.75rem;font-weight:400;opacity:0.7;">/–º–µ—Å</span>`;
      document.getElementById('cp-pro-note').textContent = proNote;
      document.getElementById('cp-prem-note').textContent = premNote;
      // Buttons state
      const proBtn = document.getElementById('cp-pro-btn');
      const premBtn = document.getElementById('cp-prem-btn');
      if (currentType === 'premium') {
        proBtn.textContent = '–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ Pro'; proBtn.style.cssText = 'width:100%;padding:9px;border-radius:8px;border:none;font-size:0.8rem;font-weight:700;cursor:pointer;background:rgba(99,102,241,0.15);color:#818cf8;';
        premBtn.textContent = '–¢–µ–∫—É—â–∏–π –ø–ª–∞–Ω'; premBtn.style.cssText = 'width:100%;padding:9px;border-radius:8px;border:none;font-size:0.8rem;font-weight:700;cursor:default;background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.4);';
      } else {
        proBtn.textContent = '–¢–µ–∫—É—â–∏–π –ø–ª–∞–Ω'; proBtn.style.cssText = 'width:100%;padding:9px;border-radius:8px;border:none;font-size:0.8rem;font-weight:700;cursor:default;background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.4);';
        premBtn.textContent = '–ü–µ—Ä–µ–π—Ç–∏ –Ω–∞ Premium'; premBtn.style.cssText = 'width:100%;padding:9px;border-radius:8px;border:none;font-size:0.8rem;font-weight:700;cursor:pointer;background:#fff;color:#1a1a2e;';
      }
      document.getElementById('modal-change-plan').classList.add('open');
    }

    function selectPlan(type) {
      const plan = STATE.plan;
      const currentType = plan?.type || 'trial';
      if (type === currentType || (currentType === 'trial' && type === 'pro')) {
        showToast(I18n.t('currentPlan')); return;
      }
      closeBillingModal('modal-change-plan');
      window.open('https://t.me/createbotaiagent', '_blank');
      showToast(I18n.t('gotoTelegram') + ' ' + I18n.t('save'));
    }

    // ‚îÄ‚îÄ Buy requests modal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function openBuyRequestsModal() {
      const plan = STATE.plan;
      const isPremium = plan?.type === 'premium';
      const pricePerK = isPremium ? 10 : 15;
      const packs = [
        { count: 1000, label: '1 000 –∑–∞–ø—Ä–æ—Å–æ–≤', price: pricePerK },
        { count: 5000, label: '5 000 –∑–∞–ø—Ä–æ—Å–æ–≤', price: Math.round(pricePerK * 5 * 0.9) },
        { count: 10000, label: '10 000 –∑–∞–ø—Ä–æ—Å–æ–≤', price: Math.round(pricePerK * 10 * 0.8) },
      ];
      const container = document.getElementById('buy-req-packs');
      container.innerHTML = packs.map(p => `
      <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:var(--surface2);border:1px solid var(--border);border-radius:10px;">
        <div>
          <div style="font-size:0.88rem;font-weight:700;color:var(--text);">‚ö° ${p.label}</div>
          <div style="font-size:0.7rem;color:var(--text-dim);margin-top:2px;">–î–æ–±–∞–≤–ª—è—é—Ç—Å—è –∫ —Ç–µ–∫—É—â–µ–º—É –º–µ—Å—è—Ü—É</div>
        </div>
        <div style="display:flex;align-items:center;gap:10px;">
          <div style="font-size:1rem;font-weight:800;color:var(--indigo);">$${p.price}</div>
          <button class="s-btn s-btn-primary" style="padding:6px 14px;font-size:0.75rem;" onclick="buyRequests(${p.count}, ${p.price})">–ö—É–ø–∏—Ç—å</button>
        </div>
      </div>
    `).join('');
      document.getElementById('modal-buy-requests').classList.add('open');
    }

    function buyRequests(count, price) {
      closeBillingModal('modal-buy-requests');
      window.open(`https://t.me/createbotaiagent?start=buy_${count}`, '_blank');
      showToast(`–ó–∞–ø—Ä–æ—Å –Ω–∞ ${count.toLocaleString()} –∑–∞–ø—Ä–æ—Å–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω`);
    }

    function closeBillingModal(id) {
      document.getElementById(id)?.classList.remove('open');
    }

    function confirmCancelSub() {
      closeBillingModal('modal-cancel-sub');
      window.open('https://t.me/createbotaiagent?start=cancel_sub', '_blank');
      showToast(I18n.t('gotoTelegram') + ' ' + I18n.t('cancel'));
    }

    /* ‚ïê‚ïê‚ïê CHAT OS LOGIC ‚ïê‚ïê‚ïê */
    const FILE_UPLOAD_ENABLED = true; // Feature flag for Phase 7 Telegram-style upload

    let authReady = false;
    let chatOsInitDone = false;
    window.resolvedUid = null; // Also bound to window for error logger

    let chatOsHistory = [];
    let isWaitingForAI = false;

    /* ‚ïê‚ïê CHAT-OS ATTACHMENT LOGIC ‚ïê‚ïê */
    let pendingChatAttachment = null;
    const CHAT_FILE_CAPABILITY = window.Telegram?.WebApp?.platform !== 'unknown'; // Optional checks for telegram mini app limitations

    function initAttachmentListeners() {
      const attachBtn = document.getElementById('chat-ob-attach-btn');
      const fileInput = document.getElementById('chat-ob-file-input');

      if (!FILE_UPLOAD_ENABLED) {
        if (attachBtn) attachBtn.style.display = 'none';
        return; // Disable attachment UI completely if flag is off
      }

      if (attachBtn && fileInput) {
        attachBtn.addEventListener('click', () => {
          if (!CHAT_OS.inputEl.disabled) {
            fileInput.click();
          }
        });

        fileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (!file) {
            e.target.value = ''; // Clear the input even if no file was selected
            return;
          }

          // Limit to 20MB
          if (file.size > 20 * 1024 * 1024) {
            showToast(I18n.t('fileTooBig'));
            e.target.value = '';
            return;
          }

          const allowedTypes = ['application/pdf', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'text/plain', 'text/csv', 'text/markdown', 'image/jpeg', 'image/png'];
          if (!allowedTypes.includes(file.type) && !file.name.endsWith('.md') && !file.name.endsWith('.csv')) {
            showToast(I18n.t('unsupportedFormat'));
            e.target.value = '';
            return;
          }
          // Guard: don't accept file during active test or AI response
          if (_testMode) {
            showToast(I18n.t('testInProgress'));
            e.target.value = '';
            return;
          }
          if (isWaitingForAI) {
            showToast(I18n.t('waitForResponse'));
            e.target.value = '';
            return;
          }
          pendingChatAttachment = file;
          e.target.value = '';
          // Notify KB panel if active
          if (_kbPanelActive) _kbPanelOnFileSelected(file.name);
          // Auto-send immediately when file is selected
          handleChatObSend();
        });
      }
    }

    // Call initialization safely
    document.addEventListener('DOMContentLoaded', initAttachmentListeners);

    function clearChatAttachment() {
      pendingChatAttachment = null;
      document.getElementById('chat-ob-attachment-pill').style.display = 'none';
      // Disable send button again if input is also empty
      if (!CHAT_OS.inputEl.value.trim()) CHAT_OS.sendBtn.disabled = true;
    }

    function fileToBase64(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = error => reject(error);
      });
    }

    const CHAT_OS = {
      container: document.getElementById('onboarding-chat-overlay'),
      messagesEl: document.getElementById('chat-ob-messages'),
      chipsEl: document.getElementById('chat-ob-chips'),
      inputEl: document.getElementById('chat-ob-input'),
      sendBtn: document.getElementById('chat-ob-send')
    };

    // Base URL for all chatOsHandler calls ‚Äî single source of truth
    const CHAT_OS_HANDLER_URL = 'https://us-central1-chatbot-acd16.cloudfunctions.net/chatOsHandler';

    // ‚îÄ‚îÄ Telegram verification helpers ‚îÄ‚îÄ
    function _showTgWaitingCard() {
      if (document.getElementById('tg-verify-ui')) return; // already shown
      const card = document.createElement('div');
      card.id = 'tg-verify-ui';
      card.className = 'tg-verify-card msg-bot';
      card.innerHTML = `
        <div class="tg-verify-header">
          <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69.01-.03.01-.14-.07-.19-.08-.05-.19-.02-.27 0-.12.03-1.98 1.26-5.59 3.7-.53.36-1.01.54-1.44.53-.47-.01-1.38-.27-2.06-.49-.83-.27-1.49-.41-1.43-.87.03-.23.36-.47 1-.72 3.92-1.7 6.53-2.83 7.84-3.37 3.73-1.55 4.51-1.82 5.02-1.83.11 0 .36.03.49.13.11.08.15.19.16.32-.01.07-.02.16-.02.19z"/></svg>
          Telegram –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
        </div>
        <div class="tg-step"><div class="tg-icon tg-check">‚úì</div> –¢–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω</div>
        <div class="tg-step"><div class="tg-icon tg-check">‚úì</div> Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</div>
        <div class="tg-step"><div class="tg-icon tg-spin"></div> –û–∂–∏–¥–∞–Ω–∏–µ /start —Å–æ–æ–±—â–µ–Ω–∏—è...</div>
      `;
      CHAT_OS.messagesEl.appendChild(card);
      scrollToBottomChatOs();
      // Timeout fallback after 60 seconds
      setTimeout(() => {
        const c = document.getElementById('tg-verify-ui');
        if (c && c.innerHTML.includes('tg-spin')) {
          c.innerHTML = `
            <div class="tg-verify-header" style="color:#ef4444;">
              <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/></svg>
              –ü—Ä–µ–≤—ã—à–µ–Ω–æ –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è
            </div>
            <div class="tg-step">–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ /start –∏–º–µ–Ω–Ω–æ —ç—Ç–æ–º—É –±–æ—Ç—É.</div>
          `;
          setTimeout(() => { handleChatObSend("–Ø –Ω–µ —Å–º–æ–≥ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å /start, –∏–ª–∏ –±–æ—Ç –µ–≥–æ –Ω–µ –ø–æ–ª—É—á–∏–ª. –ß—Ç–æ –¥–µ–ª–∞—Ç—å?"); }, 1000);
        }
      }, 60000);
    }

    function _showTgActiveCard(existingCard) {
      existingCard.innerHTML = `
        <div class="tg-verify-header">
          <svg fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
          –ë–æ—Ç —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω!
        </div>
        <div class="tg-step"><div class="tg-icon tg-check">‚úì</div> –¢–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω</div>
        <div class="tg-step"><div class="tg-icon tg-check">‚úì</div> Webhook —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω</div>
        <div class="tg-step"><div class="tg-icon tg-check">‚úì</div> –°–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ</div>
      `;
      if (window._tgListenerUnsub) { window._tgListenerUnsub(); window._tgListenerUnsub = null; }
      // Advance wizard to ACTIVE now that TG is connected
      if (_flowState && _flowState.stepId !== 'ACTIVE') advanceFlowStep('ACTIVE');
      // Auto-show welcome message editor so user can personalise /start reply
      setTimeout(() => showWelcomeConfigCard(), 1800);
    }

    // Collection-level TG listener ‚Äî watches ALL bots so it works for new users too
    function setupTgListener(uid) {
      if (window._tgListenerUnsub) { window._tgListenerUnsub(); window._tgListenerUnsub = null; }
      let _firstSnap = true;
      window._tgListenerUnsub = db.collection("users").doc(uid).collection("bots")
        .onSnapshot((snapshot) => {
          const isFirst = _firstSnap;
          _firstSnap = false;
          snapshot.docChanges().forEach((change) => {
            if (change.type === 'removed') return;
            const tg = (change.doc.data() || {}).telegram;
            if (!tg) return;
            // On first load: skip already-active bots (already working, don't re-show success)
            if (isFirst && tg.status === 'active') return;
            if (tg.status === 'waiting_first_update') {
              _showTgWaitingCard();
            } else if (tg.status === 'active') {
              const existingCard = document.getElementById('tg-verify-ui');
              if (existingCard) _showTgActiveCard(existingCard);
            }
          });
        });
    }

    // ‚îÄ‚îÄ FLOW ENGINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Each chip: { label (shown in UI), msg (sent to AI ‚Äî full sentence for natural response) }
    // Simplified flow: WELCOME ‚Üí BOT_NAME ‚Üí ACTIVE
    // The AI drives the conversation; chips are contextual shortcuts
    const FLOW_STEPS = {
      WELCOME: {
        chips: [
          { label: 'ü§ñ –°–æ–∑–¥–∞—Ç—å –±–æ—Ç–∞', msg: '–•–æ—á—É —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –±–æ—Ç–∞' },
          { label: 'üîß –£–ª—É—á—à–∏—Ç—å –±–æ—Ç–∞', msg: '–•–æ—á—É —É–ª—É—á—à–∏—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –±–æ—Ç–∞' },
          { label: 'üìö –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π', msg: '–•–æ—á—É –¥–æ–±–∞–≤–∏—Ç—å –∑–Ω–∞–Ω–∏—è –±–æ—Ç—É' },
          { label: '‚úàÔ∏è –ü–æ–¥–∫–ª—é—á–∏—Ç—å Telegram', msg: '–•–æ—á—É –ø–æ–¥–∫–ª—é—á–∏—Ç—å Telegram –∫ –±–æ—Ç—É' }
        ],
        next: { 'ü§ñ –°–æ–∑–¥–∞—Ç—å –±–æ—Ç–∞': 'BOT_NAME', 'üîß –£–ª—É—á—à–∏—Ç—å –±–æ—Ç–∞': 'ACTIVE', 'üìö –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π': 'ACTIVE', '‚úàÔ∏è –ü–æ–¥–∫–ª—é—á–∏—Ç—å Telegram': 'ACTIVE' }
      },
      BOT_NAME: {
        chips: [
          { label: '‚¨Ö –ù–∞–∑–∞–¥', action: 'go_back' }
        ],
        placeholder: '–û–ø–∏—à–∏—Ç–µ –±–æ—Ç–∞: –Ω–∞–∑–≤–∞–Ω–∏–µ + –¥–ª—è —á–µ–≥–æ –Ω—É–∂–µ–Ω + –¥–ª—è –∫–æ–≥–æ'
      },
      ACTIVE: {
        chips: [
          { label: 'üìé –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª', msg: null, action: 'file' },
          { label: 'üîó –î–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É', msg: '–•–æ—á—É –¥–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π –±–æ—Ç–∞' },
          { label: '‚úàÔ∏è Telegram', msg: '–•–æ—á—É –ø–æ–¥–∫–ª—é—á–∏—Ç—å Telegram –∫ –±–æ—Ç—É' },
          { label: 'üé® –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ', action: 'welcome_config' },
          { label: 'üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å', action: 'test_mode' },
          { label: 'üîç –°—Ç–∞—Ç—É—Å KB', action: 'debug_kb' },
        ]
      }
    };

    const FLOW_ORDER = ['WELCOME', 'BOT_NAME', 'ACTIVE'];

    let _flowState = { stepId: 'WELCOME', data: {}, active: false };
    let _pendingNextStep = null;
    let _flowUid = null;
    let _chatActiveBotId = null; // active bot ID for KB verify / status cards
    let _navHistory = []; // navigation stack: [{stepId, dynamicChips}]

    function getDefaultNextStep(stepId) {
      const idx = FLOW_ORDER.indexOf(stepId);
      if (idx === -1) return 'ACTIVE'; // unknown/removed step ‚Üí go to ACTIVE
      return (idx < FLOW_ORDER.length - 1) ? FLOW_ORDER[idx + 1] : 'ACTIVE';
    }

    // Extract label/msg from chip (supports string or {label, msg} format)
    function _chipLabel(chip) { return (typeof chip === 'string') ? chip : chip.label; }
    function _chipMsg(chip) { return (typeof chip === 'string') ? chip : (chip.msg !== undefined ? chip.msg : chip.label); }

    function renderFlowChips(stepId) {
      const step = FLOW_STEPS[stepId] || FLOW_STEPS.ACTIVE;
      const chipsEl = CHAT_OS.chipsEl;
      if (!chipsEl) return;
      chipsEl.innerHTML = '';
      if (step.chips && step.chips.length > 0) {
        step.chips.forEach(chip => {
          const btn = document.createElement('button');
          btn.className = 'ob-chip';
          btn.type = 'button';
          btn.textContent = _chipLabel(chip);
          btn.addEventListener('click', () => onFlowChipClick(chip, _flowState.stepId));
          chipsEl.appendChild(btn);
        });
        // Append dynamic "–ù–∞–∑–∞–¥" chip when history exists and step doesn't already have go_back
        if (_navHistory && _navHistory.length > 0 && stepId !== 'WELCOME' &&
          !step.chips.some(c => c.action === 'go_back')) {
          const backBtn = document.createElement('button');
          backBtn.className = 'ob-chip';
          backBtn.type = 'button';
          backBtn.textContent = '‚¨Ö –ù–∞–∑–∞–¥';
          backBtn.addEventListener('click', () => goBack());
          chipsEl.appendChild(backBtn);
        }
        chipsEl.style.display = 'flex';
      } else {
        // No static chips but there's history ‚Äî show just the "–ù–∞–∑–∞–¥" chip
        if (_navHistory && _navHistory.length > 0 && stepId !== 'WELCOME') {
          const backBtn = document.createElement('button');
          backBtn.className = 'ob-chip';
          backBtn.type = 'button';
          backBtn.textContent = '‚¨Ö –ù–∞–∑–∞–¥';
          backBtn.addEventListener('click', () => goBack());
          chipsEl.appendChild(backBtn);
          chipsEl.style.display = 'flex';
        } else {
          chipsEl.style.display = 'none';
        }
      }
      CHAT_OS.inputEl.placeholder = step.placeholder || '–ù–∞–ø–∏—à–∏—Ç–µ –æ—Ç–≤–µ—Ç...';
    }

    function onFlowChipClick(chip, stepId) {
      const label = _chipLabel(chip);
      const msg = _chipMsg(chip);   // full sentence ‚Üí AI responds naturally
      const step = FLOW_STEPS[stepId];
      let nextStep;
      if (step && step.next && label in step.next) {
        nextStep = step.next[label]; // null = stay, string = advance
      } else {
        nextStep = getDefaultNextStep(stepId);
      }
      if (nextStep !== null && nextStep !== undefined) _pendingNextStep = nextStep;

      // Special action chips
      if (chip.action === 'file' || label === 'üìé –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª') {
        document.getElementById('chat-ob-attach-btn')?.click();
        _pendingNextStep = 'ACTIVE'; // stay in ACTIVE after file sent
        return;
      }
      // TG wizard chips
      if (chip.action === 'open_botfather') {
        window.open('https://t.me/BotFather', '_blank');
        return;
      }
      if (chip.action === 'tg_wizard' || label === '‚úàÔ∏è –ü–æ–¥–∫–ª—é—á–∏—Ç—å Telegram' || label === '‚úàÔ∏è Telegram') {
        showTgInstructions();
        return;
      }
      if (chip.action === 'tg_exit') {
        exitTgWizard();
        return;
      }
      // Welcome message config
      if (chip.action === 'welcome_config' || label === 'üé® –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ') {
        showWelcomeConfigCard();
        return;
      }
      // Reset to default ACTIVE chips (back from KB method choice etc.)
      if (chip.action === 'reset_to_active') {
        _lastDynamicChips = null;
        renderFlowChips('ACTIVE');
        return;
      }
      // KB verify
      if (chip.action === 'kb_verify') {
        kbVerifyTest(_chatActiveBotId);
        return;
      }
      // Test mode
      if (chip.action === 'test_mode' || label === 'üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å') {
        showTestModeEntry();
        return;
      }
      if (chip.action === 'run_auto_test') { runAutoTest(); return; }
      if (chip.action === 'custom_test') { startCustomTestMode(); return; }
      if (chip.action === 'test_exit') { exitTestMode(); return; }
      if (chip.action === 'noop') { return; } // disabled chip
      if (chip.action === 'debug_kb') { showKbDebugInfo(); return; }
      if (chip.action === 'go_back') { goBack(); return; }
      // Post-reset choice chips
      if (chip.action === 'reset_continue') {
        const stepId = chip._savedStepId || 'ACTIVE';
        advanceFlowStep(stepId);
        const continueMsg = STEP_CONTINUE_MSGS[stepId] || '–ü—Ä–æ–¥–æ–ª–∂–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É –±–æ—Ç–∞.';
        handleChatObSend(continueMsg); // not hidden ‚Äî AI responds with step-specific guidance
        return;
      }
      if (chip.action === 'reset_restart') {
        _lastDynamicChips = null;
        _navHistory = [];
        _tgWizardStatus = 'idle';
        advanceFlowStep('WELCOME', {}, false);
        if (_flowUid) {
          db.collection('users').doc(_flowUid).collection('chatosState').doc('tgWizard')
            .set({ status: 'idle' }, { merge: true }).catch(() => { });
        }
        addChatOsMsg('bot', '–•–æ—Ä–æ—à–æ! –ù–∞—á–∏–Ω–∞–µ–º —Å –Ω—É–ª—è. –í—ã–±–µ—Ä–∏—Ç–µ, —á—Ç–æ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å:');
        return; // let user pick from freshly-rendered WELCOME chips
      }
      if (label === 'üìö –û—Ç–∫—Ä—ã—Ç—å –±–∞–∑—É –∑–Ω–∞–Ω–∏–π') { openKBDrawer(); }
      if (msg !== null) handleChatObSend(msg); // send contextual sentence, not bare label
    }

    async function advanceFlowStep(nextStepId, extraData = {}, pushToHistory = true) {
      const isNewStep = nextStepId !== _flowState.stepId;
      if (pushToHistory && isNewStep) {
        _navHistory.push({ stepId: _flowState.stepId, dynamicChips: _lastDynamicChips || null });
      }
      _flowState.stepId = nextStepId;
      _flowState.data = { ..._flowState.data, ...extraData };
      _flowState.active = nextStepId !== 'WELCOME';
      _lastDynamicChips = null; // reset dynamic chips on step change
      renderFlowChips(nextStepId);
      if (isNewStep && _flowUid) {
        try {
          await db.collection('users').doc(_flowUid)
            .collection('chatosState').doc('flow')
            .set({
              stepId: nextStepId, data: _flowState.data, active: _flowState.active,
              lastChips: null, // clear saved dynamic chips on step advance
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            }, { merge: true });
        } catch (_) { }
      }
    }

    function handleFlowAfterAIResponse() {
      if (_pendingNextStep) {
        const next = _pendingNextStep;
        _pendingNextStep = null;
        advanceFlowStep(next);
      }
    }

    async function initFlowEngine(uid) {
      _flowUid = uid;
      let savedLastChips = null;
      let restoredTgWaiting = false;
      try {
        const [flowDoc, tgDoc] = await Promise.all([
          db.collection('users').doc(uid).collection('chatosState').doc('flow').get(),
          db.collection('users').doc(uid).collection('chatosState').doc('tgWizard').get()
        ]);
        if (flowDoc.exists) {
          const d = flowDoc.data();
          _flowState = { stepId: d.stepId || 'WELCOME', data: d.data || {}, active: !!d.active };
          if (_flowState.stepId === 'ACTIVE' && Array.isArray(d.lastChips) && d.lastChips.length > 0) {
            savedLastChips = d.lastChips;
          }
        } else {
          _flowState = { stepId: 'WELCOME', data: {}, active: false };
        }
        if (tgDoc.exists && tgDoc.data().status === 'waiting_token') {
          _tgWizardStatus = 'waiting_token';
          restoredTgWaiting = true;
        }
      } catch (_) {
        _flowState = { stepId: 'WELCOME', data: {}, active: false };
      }
      if (restoredTgWaiting) {
        applyDynamicChips(TG_WIZARD_CHIPS, true); // restore wizard chips without re-saving
      } else if (savedLastChips) {
        applyDynamicChips(savedLastChips, true); // restore dynamic chips without re-saving
      } else {
        renderFlowChips(_flowState.stepId);
      }
    }

    // ‚îÄ‚îÄ TG WIZARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Guided Telegram token connection flow
    let _tgWizardStatus = 'idle'; // 'idle' | 'waiting_token' | 'verifying' | 'connected' | 'error'
    let _chipsBeforeTgWizard = null;

    const TG_WIZARD_CHIPS = [
      { label: 'üöÄ –û—Ç–∫—Ä—ã—Ç—å BotFather', action: 'open_botfather' },
      { label: 'üìñ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –µ—â—ë —Ä–∞–∑', action: 'tg_wizard' },
      { label: '‚¨Ö –ù–∞–∑–∞–¥', action: 'tg_exit' },
    ];

    function showTgInstructions() {
      addChatOsMsg('bot',
        'üì≤ **–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ Telegram**\n\n' +
        '1. –û—Ç–∫—Ä–æ–π—Ç–µ https://t.me/BotFather\n' +
        '2. –í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É: /newbot\n' +
        '3. –£–∫–∞–∂–∏—Ç–µ –∏–º—è –±–æ—Ç–∞\n' +
        '4. –£–∫–∞–∂–∏—Ç–µ username (–¥–æ–ª–∂–µ–Ω –∑–∞–∫–∞–Ω—á–∏–≤–∞—Ç—å—Å—è –Ω–∞ bot)\n' +
        '5. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—ã–¥–∞–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω\n\n' +
        'üìå –ó–∞—Ç–µ–º –≤—Å—Ç–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω —Å—é–¥–∞, –≤ —ç—Ç–æ—Ç —á–∞—Ç.\n\n' +
        '–Ø –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥–∫–ª—é—á—É –≤–∞—à–µ–≥–æ –±–æ—Ç–∞.'
      );
      _enterTgWaiting();
    }

    async function _enterTgWaiting() {
      _tgWizardStatus = 'waiting_token';
      // Snapshot chips before wizard so "–ù–∞–∑–∞–¥" can restore previous context.
      if (_chipsBeforeTgWizard === null) {
        _chipsBeforeTgWizard = (_lastDynamicChips && _lastDynamicChips.length > 0)
          ? [..._lastDynamicChips]
          : null;
      }
      applyDynamicChips(TG_WIZARD_CHIPS, true); // render wizard chips, skip re-save
      if (_flowUid) {
        try {
          await db.collection('users').doc(_flowUid)
            .collection('chatosState').doc('tgWizard')
            .set({ status: 'waiting_token', updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
        } catch (_) { }
      }
    }

    async function exitTgWizard() {
      _tgWizardStatus = 'idle';
      // Restore chips from before wizard entry.
      if (_chipsBeforeTgWizard && _chipsBeforeTgWizard.length > 0) {
        _lastDynamicChips = _chipsBeforeTgWizard;
        applyDynamicChips(_chipsBeforeTgWizard, true);
      } else {
        renderFlowChips(_flowState.stepId);
      }
      _chipsBeforeTgWizard = null;
      if (_flowUid) {
        try {
          await db.collection('users').doc(_flowUid)
            .collection('chatosState').doc('tgWizard')
            .set({ status: 'idle' }, { merge: true });
        } catch (_) { }
      }
    }

    async function connectTelegramToken(token) {
      isWaitingForAI = true;
      CHAT_OS.inputEl.disabled = true;
      CHAT_OS.sendBtn.disabled = true;
      document.getElementById('chat-ob-attach-btn').disabled = true;
      _tgWizardStatus = 'verifying';
      addChatOsMsg('bot', '...');

      try {
        // 1. Validate token via backend proxy
        const verifyRes = await window.AppApi.verifyTelegramToken(token);
        const meData = verifyRes.ok ? (verifyRes.data || {}) : { ok: false };

        if (!meData.ok) {
          removeTypingIndicator();
          addChatOsMsg('bot', '‚ùå –¢–æ–∫–µ–Ω –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–ª–∏ –µ–≥–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–∑ BotFather, –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
          _tgWizardStatus = 'waiting_token'; // allow retry
          return;
        }

        // 2. Get active bot ID from session
        const sessionSnap = await db.collection('users').doc(window.resolvedUid)
          .collection('chat_os_sessions').doc('default').get();
        const botId = sessionSnap.exists ? sessionSnap.data().activeBotId : null;

        if (!botId) {
          removeTypingIndicator();
          addChatOsMsg('bot', '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–æ—Ç–∞. –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –±–æ—Ç–∞, –∑–∞—Ç–µ–º –ø–æ–¥–∫–ª—é—á–∏—Ç–µ Telegram.');
          _tgWizardStatus = 'waiting_token';
          return;
        }

        // 3. Register webhook via backend
        const webhookResult = await registerTelegramWebhook(window.resolvedUid, botId, token, false);
        removeTypingIndicator();

        if (!webhookResult || !webhookResult.ok) {
          addChatOsMsg('bot', '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å webhook. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ç–æ–∫–µ–Ω –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
          _tgWizardStatus = 'waiting_token';
          return;
        }

        // 4. Success ‚Äî exit wizard, show confirmation
        _tgWizardStatus = 'connected';
        exitTgWizard();

        const botUsername = meData.result?.username ? `@${meData.result.username}` : '–±–æ—Ç—É';
        addChatOsMsg('bot',
          `‚úÖ Telegram —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á—ë–Ω!\n\n–ù–∞–ø–∏—à–∏—Ç–µ /start ${botUsername} –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.\n–Ø –ø–æ–∫–∞–∂—É –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ, –∫–æ–≥–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏–¥—ë—Ç.`
        );

        if (_flowUid) {
          await db.collection('users').doc(_flowUid)
            .collection('chatosState').doc('tgWizard')
            .set({ status: 'connected' }, { merge: true });
        }

      } catch (e) {
        removeTypingIndicator();
        console.error('[TgWizard] connectTelegramToken error:', e);
        addChatOsMsg('bot', '‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
        _tgWizardStatus = 'waiting_token';
      } finally {
        isWaitingForAI = false;
        CHAT_OS.inputEl.disabled = false;
        CHAT_OS.sendBtn.disabled = false;
        document.getElementById('chat-ob-attach-btn').disabled = false;
        CHAT_OS.inputEl.focus();
      }
    }

    // ‚îÄ‚îÄ WELCOME MESSAGE CONFIG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Generates a default welcome text from bot name + system prompt (no AI call needed)
    function _buildDefaultWelcome(botName, systemPrompt) {
      const name = botName || I18n.t('emptyBot');
      if (systemPrompt && systemPrompt.length > 20) {
        const excerpt = systemPrompt.split('\n')[0].replace(/^(—Ç—ã|–≤—ã|this bot|you are)\s*/i, '').slice(0, 130).trim();
        if (excerpt.length > 10) {
          return `üëã –ü—Ä–∏–≤–µ—Ç! –Ø ${name}.\n\n${excerpt}\n\n–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?`;
        }
      }
      return `üëã –ü—Ä–∏–≤–µ—Ç! –Ø ${name}.\n\n–ó–∞–¥–∞–π—Ç–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å ‚Äî –ø–æ—Å—Ç–∞—Ä–∞—é—Å—å –ø–æ–º–æ—á—å!\n\n–ß–µ–º –º–æ–≥—É –ø–æ–º–æ—á—å?`;
    }

    // ‚îÄ‚îÄ TEST MODE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let _testMode = false;
    let _testState = null; // { botId, botName, kbCount, tgStatus, systemPrompt, questions, answers }

    const TEST_ENTRY_CHIPS = [
      { label: 'üöÄ –ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ-—Ç–µ—Å—Ç', action: 'run_auto_test' },
      { label: '‚úè –°–≤–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π', action: 'custom_test' },
      { label: '‚¨Ö –ù–∞–∑–∞–¥', action: 'test_exit' },
    ];

    function _buildTestQuestions(kbCount) {
      return [
        '–ü—Ä–∏–≤–µ—Ç! –ß—Ç–æ —Ç—ã —É–º–µ–µ—à—å?',
        kbCount > 0 ? '–†–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ —Å–≤–æ–µ–π —Å–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏' : '–†–∞—Å—Å–∫–∞–∂–∏, —á–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –º–æ–∂–µ—à—å –ø–æ–º–æ—á—å',
        '–ê —á—Ç–æ –±—É–¥–µ—Ç, –µ—Å–ª–∏ —è —Å–ø—Ä–æ—à—É —Ç–µ–±—è –æ —á—ë–º-—Ç–æ –Ω–µ –ø–æ —Ç–µ–º–µ?',
        '–ö–∞–∫ —è –º–æ–≥—É –ø–æ–ª—É—á–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É –∏–ª–∏ —É—Ç–æ—á–Ω–∏—Ç—å —á—Ç–æ-—Ç–æ?',
      ];
    }

    async function showTestModeEntry() {
      if (!window.resolvedUid) return;
      try {
        const sessionSnap = await db.collection('users').doc(window.resolvedUid)
          .collection('chat_os_sessions').doc('default').get();
        const botId = sessionSnap.exists ? sessionSnap.data().activeBotId : null;
        if (!botId) {
          addChatOsMsg('bot', '‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –±–æ—Ç–∞, —á—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç.');
          return;
        }
        const botDoc = await db.collection('users').doc(window.resolvedUid)
          .collection('bots').doc(botId).get();
        const bot = botDoc.data() || {};
        const kbSnap = await db.collection('users').doc(window.resolvedUid)
          .collection('bots').doc(botId).collection('knowledge_base').get();
        const kbCount = kbSnap.size;
        const tgStatus = bot.telegram?.status || 'none';
        const hasPrompt = !!(bot.systemPrompt || bot.description);

        _testState = {
          botId, botName: bot.name || I18n.t('emptyBot'), kbCount, tgStatus,
          systemPrompt: bot.systemPrompt || bot.description || '',
          questions: [], answers: []
        };

        const kbLine = kbCount === 0 ? '–Ω–µ—Ç ‚ö†Ô∏è' : `${kbCount} ${kbCount === 1 ? '–¥–æ–∫—É–º–µ–Ω—Ç' : kbCount < 5 ? '–¥–æ–∫—É–º–µ–Ω—Ç–∞' : '–¥–æ–∫—É–º–µ–Ω—Ç–æ–≤'} ‚úÖ`;
        const tgLine = tgStatus === 'active' ? '–ø–æ–¥–∫–ª—é—á—ë–Ω ‚úÖ' : '–Ω–µ –ø–æ–¥–∫–ª—é—á—ë–Ω ‚ö†Ô∏è';
        const promptLine = hasPrompt ? '–∑–∞–¥–∞–Ω—ã ‚úÖ' : '–Ω–µ –∑–∞–¥–∞–Ω—ã ‚ö†Ô∏è';

        addChatOsMsg('bot',
          `üß™ **–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º**\n\n` +
          `–ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è **${bot.name || '–±–æ—Ç–∞'}**:\n` +
          `‚Ä¢ –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π: ${kbLine}\n` +
          `‚Ä¢ Telegram: ${tgLine}\n` +
          `‚Ä¢ –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏: ${promptLine}\n\n` +
          `–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–∏–º:\n` +
          `1Ô∏è‚É£ –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ —Ç–æ–Ω\n` +
          `2Ô∏è‚É£ ${kbCount > 0 ? '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π' : '–û—Ç–≤–µ—Ç—ã –±–µ–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π'}\n` +
          `3Ô∏è‚É£ –û–±—Ä–∞–±–æ—Ç–∫–∞ off-topic –∑–∞–ø—Ä–æ—Å–æ–≤\n` +
          `4Ô∏è‚É£ Fallback –∏ –≥—Ä–∞–Ω–∏—á–Ω—ã–µ —Å–ª—É—á–∞–∏\n\n` +
          `–ó–∞–ø—É—Å—Ç–∏—Ç—å –∞–≤—Ç–æ-—Ç–µ—Å—Ç?`
        );
        applyDynamicChips(TEST_ENTRY_CHIPS, true);
      } catch (e) {
        console.error('[Test] showTestModeEntry error:', e);
        addChatOsMsg('bot', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –±–æ—Ç–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
      }
    }

    async function runAutoTest() {
      if (!_testState) { await showTestModeEntry(); return; }
      if (isWaitingForAI) { showToast('‚è≥ ' + I18n.t('waitForResponse') + '.'); return; }
      const { kbCount, tgStatus } = _testState;
      _testMode = true;
      _testState.questions = _buildTestQuestions(kbCount);
      _testState.answers = [];

      // Lock input during test
      isWaitingForAI = true;
      CHAT_OS.inputEl.disabled = true;
      CHAT_OS.sendBtn.disabled = true;

      applyDynamicChips([{ label: '‚è≥ –¢–µ—Å—Ç –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...', action: 'noop' }], true);
      addChatOsMsg('bot', `üöÄ –ó–∞–ø—É—Å–∫–∞—é –∞–≤—Ç–æ-—Ç–µ—Å—Ç ‚Äî –∑–∞–¥–∞–º ${_testState.questions.length} –≤–æ–ø—Ä–æ—Å–∞ –±–æ—Ç—É.`);

      for (let i = 0; i < _testState.questions.length; i++) {
        const q = _testState.questions[i];
        addChatOsMsg('bot', `**–¢–µ—Å—Ç ${i + 1}/${_testState.questions.length}:** _${q}_`);
        addChatOsMsg('bot', '...'); // typing indicator
        try {
          const resp = await fetch(CHAT_OS_HANDLER_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              uid: window.resolvedUid,
              action: 'message',
              text: q,
              capabilities: { fileUpload: false, textPaste: true, urlInput: true }
            })
          });
          const d = await resp.json();
          removeTypingIndicator();
          const answer = d.reply || '(–ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç)';
          addChatOsMsg('bot', answer);
          _testState.answers.push({ q, a: answer, ok: !!d.reply });
        } catch (_) {
          removeTypingIndicator();
          addChatOsMsg('bot', '‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ.');
          _testState.answers.push({ q, a: '', ok: false });
        }
        await new Promise(r => setTimeout(r, 400));
      }

      isWaitingForAI = false;
      CHAT_OS.inputEl.disabled = false;
      CHAT_OS.sendBtn.disabled = false;
      _showTestReport();
    }

    function _showTestReport() {
      if (!_testState) return;
      const { answers, kbCount, tgStatus } = _testState;
      const okCount = answers.filter(a => a.ok).length;
      const total = answers.length || 1;
      const allOk = okCount === total;

      const recs = [];
      if (kbCount === 0) recs.push('üìö –î–æ–±–∞–≤—å—Ç–µ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π ‚Äî –±–æ—Ç —Å—Ç–∞–Ω–µ—Ç —Ç–æ—á–Ω–µ–µ');
      if (tgStatus !== 'active') recs.push('‚úàÔ∏è –ü–æ–¥–∫–ª—é—á–∏—Ç–µ Telegram –¥–ª—è –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –±–æ—Ç–∞');
      const avgLen = answers.reduce((s, a) => s + (a.a?.length || 0), 0) / total;
      if (avgLen < 80) recs.push('üìù –£—Ç–æ—á–Ω–∏—Ç–µ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º—Ç –¥–ª—è –±–æ–ª–µ–µ —Ä–∞–∑–≤—ë—Ä–Ω—É—Ç—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤');

      const recsHtml = recs.length > 0
        ? `<div class="tr-section"><div class="tr-label">–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏</div>${recs.map(r => `<div class="tr-rec">${esc(r)}</div>`).join('')}</div>`
        : `<div class="tr-section"><div class="tr-rec ok-text">‚úÖ –í—Å—ë –≤—ã–≥–ª—è–¥–∏—Ç —Ö–æ—Ä–æ—à–æ!</div></div>`;

      const kbVal = kbCount > 0 ? `${kbCount} ${kbCount < 5 ? '–¥–æ–∫—É–º–µ–Ω—Ç–∞' : '–¥–æ–∫—É–º–µ–Ω—Ç–æ–≤'}` : '–ù–µ—Ç';
      const tgVal = tgStatus === 'active' ? '–ü–æ–¥–∫–ª—é—á—ë–Ω' : '–ù–µ –ø–æ–¥–∫–ª—é—á—ë–Ω';

      const card = document.createElement('div');
      card.id = 'test-report-card';
      card.className = 'test-report-card';
      card.innerHTML = `
        <div class="tr-title">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∞</div>
        <div class="tr-stats">
          <div class="tr-stat">
            <span class="tr-stat-label">–û—Ç–≤–µ—Ç—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã</span>
            <span class="tr-stat-val ${allOk ? 'tr-ok' : 'tr-warn'}">${okCount}/${answers.length}</span>
          </div>
          <div class="tr-stat">
            <span class="tr-stat-label">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</span>
            <span class="tr-stat-val ${kbCount > 0 ? 'tr-ok' : 'tr-warn'}">${kbVal}</span>
          </div>
          <div class="tr-stat">
            <span class="tr-stat-label">Telegram webhook</span>
            <span class="tr-stat-val ${tgStatus === 'active' ? 'tr-ok' : 'tr-warn'}">${tgVal}</span>
          </div>
        </div>
        ${recsHtml}
        <div class="tr-actions">
          <button class="tr-btn tr-btn-primary" id="tr-done-btn">‚úÖ –ì–æ—Ç–æ–≤–æ</button>
          <button class="tr-btn" id="tr-retest-btn">üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å</button>
          ${kbCount === 0 ? '<button class="tr-btn" id="tr-kb-btn">üìö –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</button>' : ''}
        </div>
      `;

      const scrollBtn = document.getElementById('cos-scroll-btn');
      if (scrollBtn) CHAT_OS.messagesEl.insertBefore(card, scrollBtn);
      else CHAT_OS.messagesEl.appendChild(card);

      card.querySelector('#tr-done-btn').addEventListener('click', exitTestMode);
      card.querySelector('#tr-retest-btn').addEventListener('click', () => {
        card.remove();
        _testState.answers = [];
        runAutoTest();
      });
      card.querySelector('#tr-kb-btn')?.addEventListener('click', () => { openKBDrawer(); exitTestMode(); });

      applyDynamicChips([
        { label: 'üîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç—å —Ç–µ—Å—Ç', action: 'run_auto_test' },
        { label: '‚¨Ö –í—ã–π—Ç–∏', action: 'test_exit' },
      ], true);
      scrollToBottomChatOs();
    }

    function exitTestMode() {
      _testMode = false;
      _testState = null;
      document.getElementById('test-report-card')?.remove();
      renderFlowChips(_flowState.stepId);
      addChatOsMsg('bot', '–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º –∑–∞–≤–µ—Ä—à—ë–Ω. –ß–µ–º –∑–∞–π–º—ë–º—Å—è –¥–∞–ª—å—à–µ?');
    }

    function startCustomTestMode() {
      _testMode = true;
      if (!_testState) _testState = { questions: [], answers: [] };
      applyDynamicChips([{ label: '‚¨Ö –í—ã–π—Ç–∏ –∏–∑ —Ç–µ—Å—Ç–∞', action: 'test_exit' }], true);
      addChatOsMsg('bot',
        '‚úèÔ∏è **–°–≤–æ–π —Ç–µ—Å—Ç-—Å—Ü–µ–Ω–∞—Ä–∏–π**\n\n' +
        '–ù–∞–ø–∏—à–∏—Ç–µ –ª—é–±–æ–π –≤–æ–ø—Ä–æ—Å ‚Äî –∫–∞–∫ –µ—Å–ª–∏ –±—ã –≤—ã –±—ã–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –±–æ—Ç–∞.\n' +
        '–Ø –æ—Ç–≤–µ—á—É, –∏ –≤—ã —Å–º–æ–∂–µ—Ç–µ –æ—Ü–µ–Ω–∏—Ç—å –∫–∞—á–µ—Å—Ç–≤–æ.'
      );
      CHAT_OS.inputEl.placeholder = '–í–≤–µ–¥–∏—Ç–µ —Ç–µ—Å—Ç–æ–≤—ã–π –≤–æ–ø—Ä–æ—Å...';
      CHAT_OS.inputEl.focus();
    }

    async function showWelcomeConfigCard() {
      if (!window.resolvedUid) return;
      try {
        const sessionSnap = await db.collection('users').doc(window.resolvedUid)
          .collection('chat_os_sessions').doc('default').get();
        const botId = sessionSnap.exists ? sessionSnap.data().activeBotId : null;
        if (!botId) {
          addChatOsMsg('bot', '–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –±–æ—Ç–∞, —á—Ç–æ–±—ã –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ.');
          return;
        }
        const botDoc = await db.collection('users').doc(window.resolvedUid)
          .collection('bots').doc(botId).get();
        const bot = botDoc.data() || {};
        const savedMsg = bot.welcomeMessage || '';
        const savedKb = Array.isArray(bot.welcomeKeyboard) ? bot.welcomeKeyboard : [];
        const msgText = savedMsg || _buildDefaultWelcome(bot.name || '–ë–æ—Ç', bot.systemPrompt || bot.description || '');
        _insertWelcomeCard(botId, bot.name || '–ë–æ—Ç', msgText, savedKb);
      } catch (e) {
        console.error('[Welcome] showWelcomeConfigCard error:', e);
        addChatOsMsg('bot', '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞.');
      }
    }

    function _insertWelcomeCard(botId, botName, msgText, keyboard) {
      document.getElementById('welcome-config-card')?.remove();
      const card = document.createElement('div');
      card.id = 'welcome-config-card';
      card.className = 'welcome-config-card';

      const kbHtml = (chips) => chips.length > 0
        ? chips.map(k => `<span class="welcome-kb-btn">${esc(k)}</span>`).join('')
        : '<span style="opacity:.4;font-size:12px;">–ö–Ω–æ–ø–∫–∏ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</span>';

      card.innerHTML = `
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
          <div class="welcome-config-title" style="margin:0;">üé® –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ <span style="font-weight:400;opacity:.5">/start</span></div>
          <button class="info-btn" onclick="showInfoPopover('welcome')" title="–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç?">‚ìò</button>
          <button class="kap-back-link" style="margin-left:auto;" onclick="closeWelcomeConfigCard()">‚Üê –ù–∞–∑–∞–¥</button>
        </div>
        <div class="welcome-preview-label">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –≤ Telegram</div>
        <div class="welcome-tg-preview" id="wc-preview">${esc(msgText).replace(/\n/g, '<br>')}</div>
        <div class="welcome-kb-preview" id="wc-kb-preview">${kbHtml(keyboard)}</div>
        <div class="welcome-edit-section">
          <div class="welcome-field-label">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è:</div>
          <textarea class="welcome-edit-area" id="wc-textarea" rows="5">${esc(msgText)}</textarea>
          <div class="welcome-field-label" style="margin-top:8px;">–ë—ã—Å—Ç—Ä—ã–µ –∫–Ω–æ–ø–∫–∏ (–¥–æ 4):</div>
          <div class="welcome-kb-inputs">
            ${[0, 1, 2, 3].map(i => `<input class="welcome-kb-input" placeholder="–ö–Ω–æ–ø–∫–∞ ${i + 1}" value="${esc(keyboard[i] || '')}">`).join('')}
          </div>
        </div>
        <div class="welcome-actions">
          <button class="welcome-save-btn" id="wc-save">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button class="welcome-ai-btn" id="wc-ai">‚ú® –°–ø—Ä–æ—Å–∏—Ç—å AI</button>
        </div>
        <div class="welcome-status" id="wc-status">‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±–æ—Ç–∞</div>
      `;

      const scrollBtn = document.getElementById('cos-scroll-btn');
      if (scrollBtn) CHAT_OS.messagesEl.insertBefore(card, scrollBtn);
      else CHAT_OS.messagesEl.appendChild(card);

      const textarea = card.querySelector('#wc-textarea');
      const previewEl = card.querySelector('#wc-preview');
      const kbPreview = card.querySelector('#wc-kb-preview');
      const kbInputs = card.querySelectorAll('.welcome-kb-input');

      const refreshKb = () => {
        const labels = Array.from(kbInputs).map(i => i.value.trim()).filter(Boolean);
        kbPreview.innerHTML = kbHtml(labels);
      };
      const _dRefreshKb = _mkDebounce(refreshKb, 150);
      let _previewRaf = false;
      textarea.addEventListener('input', () => {
        if (!_previewRaf) {
          _previewRaf = true;
          requestAnimationFrame(() => {
            _previewRaf = false;
            previewEl.innerHTML = esc(textarea.value).replace(/\n/g, '<br>');
          });
        }
      });
      kbInputs.forEach(inp => inp.addEventListener('input', _dRefreshKb));

      card.querySelector('#wc-save').addEventListener('click', async () => {
        const msgVal = textarea.value.trim();
        const kbVal = Array.from(kbInputs).map(i => i.value.trim()).filter(Boolean).slice(0, 4);
        if (!msgVal) { textarea.focus(); return; }
        const btn = card.querySelector('#wc-save');
        btn.disabled = true; btn.textContent = '‚Ä¶';
        await saveWelcomeConfig(botId, msgVal, kbVal);
        btn.disabled = false; btn.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        const s = card.querySelector('#wc-status');
        s.classList.add('visible');
        setTimeout(() => s.classList.remove('visible'), 3000);
      });

      // Pre-fills input so user explicitly sends the generation request to AI
      card.querySelector('#wc-ai').addEventListener('click', () => {
        const prompt = `–°–≥–µ–Ω–µ—Ä–∏—Ä—É–π –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è Telegram –±–æ—Ç–∞ ¬´${botName}¬ª. ` +
          `–§–æ—Ä–º–∞—Ç: üëã –ü—Ä–∏–≤–µ—Ç! –Ø [–∏–º—è]. –ó–∞—Ç–µ–º 2‚Äì3 —Å—Ç—Ä–æ–∫–∏ —Å —ç–º–æ–¥–∑–∏ ‚Äî —á—Ç–æ —É–º–µ–µ—Ç –±–æ—Ç. ` +
          `–ü–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç—Ä–æ–∫–∞ ‚Äî –∫–æ—Ä–æ—Ç–∫–∏–π –ø—Ä–∏–∑—ã–≤ –∫ –¥–µ–π—Å—Ç–≤–∏—é. –¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç, –±–µ–∑ –æ–±—ä—è—Å–Ω–µ–Ω–∏–π.`;
        CHAT_OS.inputEl.value = prompt;
        CHAT_OS.inputEl.dispatchEvent(new Event('input'));
        CHAT_OS.inputEl.focus();
      });

      scrollToBottomChatOs();
    }

    async function saveWelcomeConfig(botId, msgText, keyboard) {
      if (!window.resolvedUid || !botId) return;
      try {
        await db.collection('users').doc(window.resolvedUid)
          .collection('bots').doc(botId)
          .update({
            welcomeMessage: msgText,
            welcomeKeyboard: keyboard,
            welcomeUpdatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
      } catch (e) {
        console.error('[Welcome] saveWelcomeConfig error:', e);
      }
    }

    // ‚îÄ‚îÄ KB VERIFY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

    function _showKbStatusCard(botId) {
      if (!botId || !window.resolvedUid) return;
      // Remove any existing card first
      document.getElementById('kb-status-card')?.remove();

      const card = document.createElement('div');
      card.id = 'kb-status-card';
      card.className = 'kb-status-card';
      card.innerHTML = `
        <div class="ksc-header">
          <span class="ksc-icon">üìö</span>
          <span class="ksc-title">–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π</span>
          <span class="ksc-badge pending" id="ksc-badge">‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞</span>
        </div>
        <div class="ksc-body" id="ksc-body">–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω. –ò–¥—ë—Ç –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è ‚Äî –æ–±—ã—á–Ω–æ 1‚Äì2 –º–∏–Ω—É—Ç—ã.</div>
        <div class="ksc-actions">
          <button class="ksc-btn" id="ksc-check-btn">üîÑ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å</button>
          <button class="ksc-btn ksc-btn-ghost" id="ksc-verify-btn" style="display:none">üß™ –¢–µ—Å—Ç-–≤–æ–ø—Ä–æ—Å</button>
        </div>
      `;

      const scrollBtn = document.getElementById('cos-scroll-btn');
      if (scrollBtn) CHAT_OS.messagesEl.insertBefore(card, scrollBtn);
      else CHAT_OS.messagesEl.appendChild(card);

      // Auto-check after 4 seconds
      setTimeout(() => _checkKbStatus(botId, card), 4000);

      card.querySelector('#ksc-check-btn').addEventListener('click', () => _checkKbStatus(botId, card));
      card.querySelector('#ksc-verify-btn').addEventListener('click', () => kbVerifyTest(botId));

      scrollToBottomChatOs();
    }

    async function _checkKbStatus(botId, card) {
      if (!card || !card.isConnected) return;
      const badge = card.querySelector('#ksc-badge');
      const body = card.querySelector('#ksc-body');
      const checkBtn = card.querySelector('#ksc-check-btn');
      const verifyBtn = card.querySelector('#ksc-verify-btn');
      if (badge) { badge.className = 'ksc-badge pending'; badge.textContent = '‚è≥ –ü—Ä–æ–≤–µ—Ä—è—é...'; }
      if (checkBtn) checkBtn.disabled = true;

      try {
        const kbSnap = await db.collection('users').doc(window.resolvedUid)
          .collection('bots').doc(botId).collection('knowledge_base').get();
        const count = kbSnap.size;

        // Check for running jobs in Firestore
        const jobsSnap = await db.collection('users').doc(window.resolvedUid)
          .collection('bots').doc(botId).collection('jobs')
          .where('status', 'in', ['running', 'queued']).limit(1).get();
        const stillProcessing = !jobsSnap.empty;

        if (stillProcessing) {
          if (badge) { badge.className = 'ksc-badge pending'; badge.textContent = '‚è≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è'; }
          if (body) body.textContent = `–ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ. –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: ${count} –∑–∞–ø–∏—Å–µ–π.`;
          // Auto-recheck in 5s
          setTimeout(() => _checkKbStatus(botId, card), 5000);
        } else if (count > 0) {
          if (badge) { badge.className = 'ksc-badge ready'; badge.textContent = '‚úÖ –ì–æ—Ç–æ–≤–∞'; }
          const noun = count === 1 ? '–∑–∞–ø–∏—Å—å' : count < 5 ? '–∑–∞–ø–∏—Å–∏' : '–∑–∞–ø–∏—Å–µ–π';
          if (body) body.textContent = `–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π —Å–æ–¥–µ—Ä–∂–∏—Ç ${count} ${noun}. –ë–æ—Ç –≥–æ—Ç–æ–≤ –æ—Ç–≤–µ—á–∞—Ç—å.`;
          if (verifyBtn) verifyBtn.style.display = '';
          // Update status bar
          const elKb = document.getElementById('cs-kb');
          if (elKb) elKb.textContent = `üìö KB: ${count}`;
        } else {
          if (badge) { badge.className = 'ksc-badge warn'; badge.textContent = '‚ö†Ô∏è –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö'; }
          if (body) body.textContent = '–î–∞–Ω–Ω—ã–µ –µ—â—ë –Ω–µ –ø–æ—è–≤–∏–ª–∏—Å—å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —á–µ—Ä–µ–∑ –º–∏–Ω—É—Ç—É.';
          // Auto-recheck in 10s
          setTimeout(() => _checkKbStatus(botId, card), 10000);
        }
      } catch (e) {
        console.error('[KbStatus] check error:', e);
        if (badge) { badge.className = 'ksc-badge error'; badge.textContent = '‚ùå –û—à–∏–±–∫–∞'; }
        if (body) body.textContent = '–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤—Ä—É—á–Ω—É—é.';
      } finally {
        if (checkBtn) checkBtn.disabled = false;
      }
    }

    async function kbVerifyTest(botId) {
      if (!window.resolvedUid || isWaitingForAI) return;
      const _botId = botId || _chatActiveBotId;
      if (!_botId) {
        addChatOsMsg('bot', '‚ö†Ô∏è –°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –±–æ—Ç–∞ –∏ –¥–æ–±–∞–≤—å—Ç–µ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π.');
        return;
      }

      addChatOsMsg('bot', 'üîç **–ü—Ä–æ–≤–µ—Ä—è—é –±–∞–∑—É –∑–Ω–∞–Ω–∏–π...**\n–ó–∞–¥–∞–º –±–æ—Ç—É –≤–æ–ø—Ä–æ—Å –∏ –æ—Ü–µ–Ω—é –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ KB.');

      // Pick a topic from KB for a targeted test
      let testQ = '–†–∞—Å—Å–∫–∞–∂–∏, —á–µ–º —Ç—ã –º–æ–∂–µ—à—å –ø–æ–º–æ—á—å –Ω–∞ –æ—Å–Ω–æ–≤–µ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π?';
      try {
        const snap = await db.collection('users').doc(window.resolvedUid)
          .collection('bots').doc(_botId).collection('knowledge_base').limit(3).get();
        if (!snap.empty) {
          const d = snap.docs[0].data();
          const title = d.title || d.name || d.source || '';
          if (title && title.length > 2) testQ = `–†–∞—Å—Å–∫–∞–∂–∏ –ø–æ–¥—Ä–æ–±–Ω–µ–µ –æ "${title.slice(0, 60)}"`;
        }
      } catch (_) { }

      addChatOsMsg('bot', `**–¢–µ—Å—Ç-–≤–æ–ø—Ä–æ—Å:** _${testQ}_`);
      addChatOsMsg('bot', '...');

      isWaitingForAI = true;
      CHAT_OS.inputEl.disabled = true;
      CHAT_OS.sendBtn.disabled = true;

      try {
        const resp = await fetch(CHAT_OS_HANDLER_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            uid: window.resolvedUid,
            action: 'message',
            text: testQ,
            capabilities: { fileUpload: false, textPaste: true, urlInput: true }
          })
        });
        const data = await resp.json();
        removeTypingIndicator();

        if (data.reply) {
          addChatOsMsg('bot', data.reply);
          // Heuristic: long reply + no "–Ω–µ –∑–Ω–∞—é" ‚Üí KB likely used
          const r = data.reply.toLowerCase();
          const kbUsed = data.reply.length > 120 &&
            !r.includes('–Ω–µ –∑–Ω–∞—é') && !r.includes('–Ω–µ –º–æ–≥—É –æ—Ç–≤–µ—Ç–∏—Ç—å') &&
            !r.includes('–Ω–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏');
          addChatOsMsg('bot', kbUsed
            ? '‚úÖ **KB —Ä–∞–±–æ—Ç–∞–µ—Ç** ‚Äî –±–æ—Ç –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ.'
            : '‚ö†Ô∏è **KB –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è** ‚Äî –¥–∞–Ω–Ω—ã–µ –µ—â—ë –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –∏–ª–∏ —Ç–µ–º–∞ –Ω–µ —Å–æ–≤–ø–∞–¥–∞–µ—Ç. –ü–æ–¥–æ–∂–¥–∏—Ç–µ 1‚Äì2 –º–∏–Ω –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.'
          );
        } else {
          addChatOsMsg('bot', '–ü—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
        }
      } catch (_) {
        removeTypingIndicator();
        addChatOsMsg('bot', '‚ö†Ô∏è –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Ç–µ—Å—Ç-–∑–∞–ø—Ä–æ—Å–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
      } finally {
        isWaitingForAI = false;
        CHAT_OS.inputEl.disabled = false;
        CHAT_OS.sendBtn.disabled = false;
      }
    }

    // ‚îÄ‚îÄ ACTION PANEL ROUTER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    function renderActionPanel(expectation) {
      if (!expectation) {
        hideKbAddPanel();
        if (CHAT_OS.inputEl.disabled && CHAT_OS.inputEl.placeholder === "–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –≤ –ø–∞–Ω–µ–ª–∏ –Ω–∏–∂–µ...") {
          CHAT_OS.inputEl.disabled = false;
          CHAT_OS.inputEl.placeholder = "–ù–∞–ø–∏—à–∏—Ç–µ –æ—Ç–≤–µ—Ç...";
        }
        return;
      }

      if (expectation.type === 'telegram_connect') {
        showTgConnectPanel();
      } else if (expectation.type === 'kb_add') {
        showKbAddPanel('kb-choose');
      } else if (expectation.type === 'settings') {
        // Future feature
      } else {
        hideKbAddPanel();
      }
    }

    function showTgConnectPanel() {
      const panel = document.getElementById('kb-add-panel');
      if (!panel) return;
      _kbPanelActive = true;
      panel.classList.remove('hidden');
      if (CHAT_OS.chipsEl) CHAT_OS.chipsEl.style.display = 'none';

      CHAT_OS.inputEl.value = '';
      CHAT_OS.inputEl.disabled = true;
      CHAT_OS.inputEl.placeholder = "–í–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –≤ –ø–∞–Ω–µ–ª–∏ –Ω–∏–∂–µ...";

      panel.innerHTML = `
        <div class="kap-btns" style="flex-direction: column;">
          <input type="text" id="kap-tg-token" class="kap-url-input" placeholder="1234567890:AAF..." style="margin-bottom: 8px;">
        </div>
        <div class="kap-actions-row">
          <button class="kap-submit-btn" onclick="_tgSubmitToken()">–ü–æ–¥–∫–ª—é—á–∏—Ç—å Telegram ‚Üí</button>
        </div>
        <div class="kap-hint-row" style="margin-top: 5px;">
          <span class="kap-hint">–ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω —É @BotFather –≤ Telegram</span>
          <button class="kap-help-btn" onclick="pasteToInput('kap-tg-token')">–í—Å—Ç–∞–≤–∏—Ç—å</button>
        </div>
      `;
      setTimeout(() => document.getElementById('kap-tg-token')?.focus(), 50);
    }

    function _tgSubmitToken() {
      const token = document.getElementById('kap-tg-token')?.value.trim();
      if (!token) return;
      const panel = document.getElementById('kb-add-panel');
      panel.innerHTML = `<div class="kap-status-bar kap-pending"><span>‚è≥</span><span>–ü—Ä–æ–≤–µ—Ä—è—é —Ç–æ–∫–µ–Ω, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ...</span></div>`;
      
      CHAT_OS.inputEl.disabled = false;
      CHAT_OS.inputEl.placeholder = "–ù–∞–ø–∏—à–∏—Ç–µ –æ—Ç–≤–µ—Ç...";
      handleChatObSend(token, { hidden: false });
    }

    // ‚îÄ‚îÄ KB ADD PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let _kbPanelActive = false;
    let _kbPanelCooldownTs = 0;

    function showKbAddPanel(step) {
      const panel = document.getElementById('kb-add-panel');
      if (!panel) return;
      if (step === 'kb-file' && isWaitingForAI) {
        showToast('‚è≥ ' + I18n.t('waitForResponse'));
        return;
      }
      _kbPanelActive = true;
      panel.classList.remove('hidden');
      if (CHAT_OS.chipsEl) CHAT_OS.chipsEl.style.display = 'none';

      if (step === 'kb-choose') {
        panel.innerHTML = window.AppUI.kbPanelMarkup('kb-choose');
      } else if (step === 'kb-file') {
        panel.innerHTML = window.AppUI.kbPanelMarkup('kb-file');
        document.getElementById('chat-ob-attach-btn')?.click();
      } else if (step === 'kb-link') {
        panel.innerHTML = window.AppUI.kbPanelMarkup('kb-link');
        setTimeout(() => document.getElementById('kap-link-input')?.focus(), 50);
      } else if (step === 'kb-text') {
        panel.innerHTML = window.AppUI.kbPanelMarkup('kb-text');
        setTimeout(() => document.getElementById('kap-text-input')?.focus(), 50);
      }
    }

    function _kbPanelSetDone(icon, line1, againLabel, againStep) {
      const panel = document.getElementById('kb-add-panel');
      if (!panel) return;
      panel.innerHTML = window.AppUI.kbDoneMarkup(icon, line1, againLabel, againStep);
    }

    function _kbPanelOnFileSelected(filename) {
      const panel = document.getElementById('kb-add-panel');
      if (!panel) return;
      panel.innerHTML = window.AppUI.kbUploadingMarkup(filename);
    }

    function _kbPanelOnFileUploaded() {
      _kbPanelSetDone('‚úÖ', '–§–∞–π–ª –ø–æ–ª—É—á–µ–Ω. –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º‚Ä¶', '–ó–∞–≥—Ä—É–∑–∏—Ç—å –µ—â—ë —Ñ–∞–π–ª', 'kb-file');
    }

    function hideKbAddPanel() {
      const wasActive = _kbPanelActive;
      _kbPanelActive = false;
      if (wasActive) _kbPanelCooldownTs = Date.now(); // only reset cooldown when panel was actually shown
      const panel = document.getElementById('kb-add-panel');
      if (panel) { panel.innerHTML = ''; panel.classList.add('hidden'); }
      renderFlowChips(_flowState.stepId);
    }

    function goBack() {
      _pendingNextStep = null; // cancel any pending AI-driven step advance (Bug #7)
      if (_kbPanelActive) hideKbAddPanel(); // close KB panel if open (Bug #6)
      if (_navHistory.length > 0) {
        const prev = _navHistory.pop();
        if (prev.dynamicChips && prev.dynamicChips.length > 0) {
          advanceFlowStep(prev.stepId, {}, false);
          applyDynamicChips(prev.dynamicChips, true);
        } else {
          advanceFlowStep(prev.stepId, {}, false);
        }
      } else {
        advanceFlowStep('WELCOME', {}, false);
      }
    }

    function closeWelcomeConfigCard() {
      document.getElementById('welcome-config-card')?.remove();
      renderFlowChips(_flowState.stepId);
    }

    async function showKbDebugInfo() {
      if (!window.resolvedUid || !_chatActiveBotId) {
        addChatOsMsg('bot', '‚ùå –ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–æ—Ç–∞');
        return;
      }
      addChatOsMsg('bot', '...');
      try {
        const [kbSnap, jobsSnap] = await Promise.all([
          db.collection(`users/${window.resolvedUid}/bots/${_chatActiveBotId}/knowledge_base`).get(),
          db.collection(`users/${window.resolvedUid}/bots/${_chatActiveBotId}/jobs`).orderBy('updatedAt', 'desc').limit(3).get().catch(() => ({ empty: true, docs: [] }))
        ]);
      const total = kbSnap.size;
      const withContent = kbSnap.docs.filter(d => d.data().content).length;
      const filesOnly = total - withContent;
      let jobInfo = '–Ω–µ—Ç';
      if (!jobsSnap.empty && jobsSnap.docs.length > 0) {
        const j = jobsSnap.docs[0].data();
        jobInfo = `${j.status || '?'} (—à–∞–≥: ${j.step || '‚Äî'}, –ø—Ä–æ–≥—Ä–µ—Å—Å: ${j.progress || 0}%)`;
      }
      removeTypingIndicator();
      addChatOsMsg('bot',
        `üìä **–°—Ç–∞—Ç—É—Å –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π**\n\n–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π: ${total}\n–° —Ç–µ–∫—Å—Ç–æ–º (–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –ø–æ–∏—Å–∫–æ–º): ${withContent}\n–¢–æ–ª—å–∫–æ —Ñ–∞–π–ª (–Ω–µ –∏–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞–Ω–æ): ${filesOnly}\n–ü–æ—Å–ª–µ–¥–Ω–∏–π job: ${jobInfo}`
      );
    } catch (e) {
      removeTypingIndicator();
      addChatOsMsg('bot', '‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: ' + e.message);
    }
    }

    function _kbLinkChange() {
      const inp = document.getElementById('kap-link-input');
      const btn = document.getElementById('kap-link-submit');
      if (!inp || !btn) return;
      try { new URL(inp.value.trim()); btn.disabled = false; inp.classList.remove('kap-error'); }
      catch { btn.disabled = true; }
    }

    async function _resolveActiveBotForKb() {
      if (!window.resolvedUid) return null;
      if (_chatActiveBotId) return _chatActiveBotId;
      try {
        const sessionSnap = await db.collection('users').doc(window.resolvedUid)
          .collection('chat_os_sessions').doc('default').get();
        const botId = sessionSnap.exists ? sessionSnap.data().activeBotId : null;
        if (botId) _chatActiveBotId = botId;
        return botId || null;
      } catch {
        return null;
      }
    }

    async function addKbLinkDirect(url) {
      const cleanUrl = (url || '').trim();
      try { new URL(cleanUrl); } catch { throw new Error('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π URL'); }
      if (!window.resolvedUid) throw new Error('–°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å');
      const botId = await _resolveActiveBotForKb();
      if (!botId) throw new Error('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ/—Å–æ–∑–¥–∞–π—Ç–µ –±–æ—Ç–∞');

      const resp = await fetch('/api/import-url', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ uid: window.resolvedUid, botId, url: cleanUrl }),
      });
      const data = await resp.json().catch(() => ({}));
      if (!resp.ok || !data.ok) throw new Error(data.error || '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É');
      return { ...data, url: cleanUrl };
    }

    async function addKbTextDirect(text) {
      const cleanText = (text || '').trim();
      if (cleanText.length < 10) throw new Error('–í–≤–µ–¥–∏—Ç–µ –Ω–µ –º–µ–Ω–µ–µ 10 —Å–∏–º–≤–æ–ª–æ–≤');
      if (!window.resolvedUid) throw new Error('–°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å');
      const botId = await _resolveActiveBotForKb();
      if (!botId) throw new Error('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ/—Å–æ–∑–¥–∞–π—Ç–µ –±–æ—Ç–∞');

      const ref = await db.collection('users').doc(window.resolvedUid)
        .collection('bots').doc(botId)
        .collection('knowledge_base').add({
          type: 'text',
          source: 'manual_text',
          title: cleanText.slice(0, 80),
          content: cleanText,
          status: 'active',
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        });
      return { id: ref.id, text: cleanText };
    }

    async function _kbAddLink() {
      const inp = document.getElementById('kap-link-input');
      if (!inp) return;
      const btn = document.getElementById('kap-link-submit');
      if (btn) { btn.disabled = true; btn.textContent = '–î–æ–±–∞–≤–ª—è—é‚Ä¶'; }
      try {
        const data = await addKbLinkDirect(inp.value.trim());
        _kbPanelSetDone('‚úÖ', '–°—Å—ã–ª–∫–∞ –ø–æ–ª—É—á–µ–Ω–∞. –ö–æ–Ω—Ç–µ–Ω—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è‚Ä¶', '–î–æ–±–∞–≤–∏—Ç—å –µ—â—ë —Å—Å—ã–ª–∫—É', 'kb-link');
        addChatOsMsg('bot', `‚úÖ –°—Å—ã–ª–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞ –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π: ${data.title || data.url}`);
      } catch (e) {
        inp.classList.add('kap-error');
        showToast(e.message || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏');
      } finally {
        if (btn) { btn.disabled = false; btn.textContent = '–î–æ–±–∞–≤–∏—Ç—å ‚Üí'; }
      }
    }

    async function _kbAddText() {
      const ta = document.getElementById('kap-text-input');
      if (!ta) return;
      try {
        await addKbTextDirect(ta.value.trim());
        _kbPanelSetDone('‚úÖ', '–¢–µ–∫—Å—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π', '–î–æ–±–∞–≤–∏—Ç—å –µ—â—ë —Ç–µ–∫—Å—Ç', 'kb-text');
        addChatOsMsg('bot', '‚úÖ –¢–µ–∫—Å—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π.');
      } catch (e) {
        showToast(e.message || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞');
      }
    }

    // ‚îÄ‚îÄ KB SUGGESTIONS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    async function submitKbSuggestion(assistantMsg, proposedFix) {
      if (!window.resolvedUid) return;
      try {
        const sessionSnap = await db.collection("users").doc(window.resolvedUid)
          .collection("chat_os_sessions").doc("default").get();
        const botId = sessionSnap.exists ? sessionSnap.data().activeBotId : null;
        if (!botId) {
          addChatOsMsg('bot', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –±–æ—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
          return;
        }
        await db.collection('users').doc(window.resolvedUid)
          .collection('bots').doc(botId)
          .collection('kb_suggestions').add({
            source: 'chat',
            assistantMsg: (assistantMsg || '').slice(0, 2000),
            proposedFix: (proposedFix || '').slice(0, 1000),
            status: 'pending',
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        addChatOsMsg('bot', '‚úÖ –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ. –ù–∞–π–¥—ë—Ç–µ –µ–≥–æ –≤ ¬´–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π ‚Üí –ù–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ¬ª.');
      } catch (e) {
        console.error('[ChatOS] submitKbSuggestion error', e);
        addChatOsMsg('bot', '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
      }
    }

    async function loadKbSuggestions(botId) {
      const listEl = document.getElementById('kb-suggestions-list');
      const section = document.getElementById('kb-suggestions-section');
      const divider = document.getElementById('kb-sug-divider');
      const titleEl = document.getElementById('kb-sug-title');
      if (!listEl || !section || !window.resolvedUid) return;
      try {
        const snap = await db.collection('users').doc(window.resolvedUid)
          .collection('bots').doc(botId)
          .collection('kb_suggestions')
          .where('status', '==', 'pending')
          .orderBy('createdAt', 'desc')
          .get();
        if (snap.empty) {
          section.classList.add('hidden');
          if (divider) divider.style.display = 'none';
          return;
        }
        section.classList.remove('hidden');
        if (divider) divider.style.display = '';
        if (titleEl) titleEl.textContent = `–ù–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ (${snap.size})`;
        listEl.innerHTML = '';
        const frag = document.createDocumentFragment();
        snap.docs.forEach(doc => {
          const d = doc.data();
          const card = document.createElement('div');
          card.className = 'kb-sug-card';
          card.innerHTML = `
            <div class="kb-sug-meta">üí¨ –ò–∑ —á–∞—Ç–∞ ¬∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</div>
            <div class="kb-sug-text">${esc(d.proposedFix || '')}</div>
            <div class="kb-sug-actions">
              <button class="kb-sug-btn approve">‚úì –î–æ–±–∞–≤–∏—Ç—å –≤ KB</button>
              <button class="kb-sug-btn reject">‚úï –û—Ç–∫–ª–æ–Ω–∏—Ç—å</button>
            </div>
          `;
          card.querySelector('.approve').addEventListener('click', () => approveSuggestion(botId, doc.id, d.proposedFix, card));
          card.querySelector('.reject').addEventListener('click', () => rejectSuggestion(botId, doc.id, card));
          frag.appendChild(card);
        });
        listEl.appendChild(frag);
      } catch (e) {
        console.error('[ChatOS] loadKbSuggestions error', e);
      }
    }

    async function approveSuggestion(botId, sugId, text, cardEl) {
      try {
        await db.collection('users').doc(window.resolvedUid)
          .collection('bots').doc(botId)
          .collection('knowledge_base').add({
            type: 'text', content: text, title: (text || '').slice(0, 60),
            source: 'suggestion', createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        await db.collection('users').doc(window.resolvedUid)
          .collection('bots').doc(botId)
          .collection('kb_suggestions').doc(sugId)
          .update({ status: 'approved' });
        cardEl.style.opacity = '0.4';
        cardEl.querySelector('.kb-sug-actions').innerHTML = '<span style="font-size:12px;color:#4caf50;font-weight:600;">‚úì –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π</span>';
      } catch (e) { console.error('[ChatOS] approveSuggestion error', e); }
    }

    async function rejectSuggestion(botId, sugId, cardEl) {
      try {
        await db.collection('users').doc(window.resolvedUid)
          .collection('bots').doc(botId)
          .collection('kb_suggestions').doc(sugId)
          .update({ status: 'rejected' });
        cardEl.style.opacity = '0';
        setTimeout(() => cardEl.remove(), 200);
      } catch (e) { console.error('[ChatOS] rejectSuggestion error', e); }
    }

    function showSuggestionForm(reactionsEl) {
      const existing = reactionsEl.nextElementSibling;
      if (existing && existing.classList.contains('cos-feedback-form')) existing.remove();
      const msgEl = reactionsEl.previousElementSibling;
      const form = document.createElement('div');
      form.className = 'cos-feedback-form';
      form.innerHTML = `
        <div class="cos-feedback-label">–ß—Ç–æ –∏—Å–ø—Ä–∞–≤–∏—Ç—å? –ù–∞–ø–∏—à–∏—Ç–µ 1‚Äì2 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è:</div>
        <textarea class="cos-feedback-input" placeholder="–ù–∞–ø—Ä.: ¬´–ù—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å, —á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ–º —Å 9 –¥–æ 18¬ª" rows="2"></textarea>
        <div class="cos-feedback-btns">
          <button class="cos-fb-send" type="button">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</button>
          <button class="cos-fb-cancel" type="button">–û—Ç–º–µ–Ω–∞</button>
        </div>
      `;
      reactionsEl.insertAdjacentElement('afterend', form);
      form.querySelector('.cos-feedback-input').focus();
      form.querySelector('.cos-fb-send').addEventListener('click', () => {
        const feedback = form.querySelector('.cos-feedback-input').value.trim();
        if (!feedback) return;
        submitKbSuggestion(msgEl?.dataset?.text || '', feedback);
        form.remove();
      });
      form.querySelector('.cos-fb-cancel').addEventListener('click', () => {
        form.remove();
        reactionsEl.querySelectorAll('.cos-react').forEach(b => b.classList.remove('active'));
      });
    }

    // ‚îÄ‚îÄ DYNAMIC CHIPS ENGINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Maps keywords in AI reply list items to contextual chip definitions
    const LIST_CHIP_MAP = [
      { test: /–±–∞–∑–∞ –∑–Ω–∞–Ω|–±–∞–∑—É –∑–Ω–∞–Ω|knowledge|–∑–Ω–∞–Ω–∏/i, chip: { label: 'üìö –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π', msg: '–•–æ—á—É –¥–æ–±–∞–≤–∏—Ç—å –±–∞–∑—É –∑–Ω–∞–Ω–∏–π –±–æ—Ç—É' } },
      { test: /–ø–æ–≤–µ–¥–µ–Ω|—Ç–æ–Ω|—Å—Ç–∏–ª—å|–ø—Ä–∞–≤–∏–ª|persona|–∏–Ω—Å—Ç—Ä—É–∫—Ü/i, chip: { label: 'üéõ –ü–æ–≤–µ–¥–µ–Ω–∏–µ', msg: '–•–æ—á—É –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ –∏ —Ç–æ–Ω –±–æ—Ç–∞' } },
      { test: /telegram|—Ç–æ–∫–µ–Ω|–ø–æ–¥–∫–ª—é—á|activat/i, chip: { label: '‚úàÔ∏è Telegram', msg: '–•–æ—á—É –ø–æ–¥–∫–ª—é—á–∏—Ç—å Telegram –∫ –±–æ—Ç—É' } },
      { test: /—Ç–µ—Å—Ç|—Å—Ü–µ–Ω–∞—Ä|–ø—Ä–æ–≤–µ—Ä–∏—Ç—å|test/i, chip: { label: 'üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å', action: 'test_mode' } },
      { test: /–∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª|upload|\b—Ñ–∞–π–ª\b/i, chip: { label: 'üìé –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª', msg: null, action: 'file' } },
      { test: /—Å—Å—ã–ª–∫|url|—Å–∞–π—Ç|link/i, chip: { label: 'üîó –°—Å—ã–ª–∫–∞', msg: '–•–æ—á—É –¥–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π' } },
      { test: /—Ç–µ–∫—Å—Ç.*–∑–Ω–∞–Ω|–¥–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç|–≤—Å—Ç–∞–≤–∏—Ç—å|\b—Ç–µ–∫—Å—Ç\b/i, chip: { label: '‚úèÔ∏è –¢–µ–∫—Å—Ç', msg: '–•–æ—á—É –¥–æ–±–∞–≤–∏—Ç—å —Ç–µ–∫—Å—Ç –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π' } },
      { test: /–∏–º—è|–Ω–∞–∑–≤–∞–Ω|–Ω–∞–∑–æ–≤–∏|name.*bot|bot.*name/i, chip: { label: '‚úèÔ∏è –ù–∞–∑–≤–∞—Ç—å –±–æ—Ç–∞', msg: '–•–æ—á—É –∑–∞–¥–∞—Ç—å –∏–º—è –∏ –æ–ø–∏—Å–∞–Ω–∏–µ –±–æ—Ç–∞' } },
      { test: /–∞—É–¥–∏—Ç–æ—Ä–∏|—Ü–µ–ª–µ–≤|–¥–ª—è –∫–æ–≥–æ/i, chip: { label: 'üéØ –ê—É–¥–∏—Ç–æ—Ä–∏—è', msg: '–•–æ—á—É –æ–ø–∏—Å–∞—Ç—å —Ü–µ–ª–µ–≤—É—é –∞—É–¥–∏—Ç–æ—Ä–∏—é –±–æ—Ç–∞' } },
      { test: /debug.kb|—Å—Ç–∞—Ç—É—Å.kb|—Å–æ—Å—Ç–æ—è–Ω–∏–µ.kb/i, chip: { label: 'üîç –°—Ç–∞—Ç—É—Å KB', action: 'debug_kb' } },
    ];

    // Extract numbered/bulleted list items from text
    function _parseListItems(text) {
      if (!text) return [];
      const lines = text.split('\n');
      const items = [];
      for (const line of lines) {
        const m = line.match(/^[\d]+[.)]\s+(.+)/) || line.match(/^[-‚Ä¢*]\s+(.+)/);
        if (m) items.push(m[1].trim());
      }
      return items;
    }

    let _lastDynamicChips = null;

    // Infer chips from AI reply: returns chip array or null if nothing matched
    function inferChipsFromReply(replyText, actionsFromApi) {
      // Priority 1: explicit actions from API backend
      if (Array.isArray(actionsFromApi) && actionsFromApi.length > 0) {
        return actionsFromApi.slice(0, 4).map(a =>
          (typeof a === 'string') ? { label: a, msg: a } : a
        );
      }
      // Priority 2: match list items from reply against keyword map
      const items = _parseListItems(replyText);
      const chips = [];
      const seen = new Set();
      for (const item of items) {
        for (const { test, chip } of LIST_CHIP_MAP) {
          if (test.test(item) && !seen.has(chip.label)) {
            seen.add(chip.label);
            chips.push(chip);
            break;
          }
        }
        if (chips.length >= 4) break;
      }
      // Priority 3: if few chips found, scan full reply for additional matches
      if (chips.length < 2) {
        for (const { test, chip } of LIST_CHIP_MAP) {
          if (test.test(replyText) && !seen.has(chip.label)) {
            seen.add(chip.label);
            chips.push(chip);
            if (chips.length >= 3) break;
          }
        }
      }
      // Special case: bot is asking HOW to add KB (text vs file vs link mentioned together)
      if (chips.length <= 1 && _flowState.stepId === 'ACTIVE') {
        const hasText = /\b—Ç–µ–∫—Å—Ç\b/i.test(replyText);
        const hasFile = /\b—Ñ–∞–π–ª\b/i.test(replyText);
        const hasLink = /\b—Å—Å—ã–ª–∫/i.test(replyText);
        if (hasText && hasFile && hasLink && !_kbPanelActive && (Date.now() - _kbPanelCooldownTs > 10000)) {
          setTimeout(() => showKbAddPanel('kb-choose'), 0);
          return null; // KB panel handles interaction
        }
      }

      const result = chips.length > 0 ? chips : null;
      // Diagnostic logging for ACTIVE mode
      if (_flowState.stepId === 'ACTIVE') {
        if (!result) {
          console.log('[DynChips] fallback ‚Äî no chips inferred. reply_len=%d', replyText?.length || 0);
        } else {
          console.log('[DynChips] chips=%d labels=[%s]', result.length, result.map(c => c.label).join(', '));
        }
      }
      return result;
    }

    // Render dynamic chips in the chip bar and persist them
    function applyDynamicChips(chips, skipSave = false) {
      if (!chips || !chips.length || !CHAT_OS.chipsEl) return;
      _lastDynamicChips = chips;
      const chipsEl = CHAT_OS.chipsEl;
      chipsEl.innerHTML = '';
      chips.forEach(chip => {
        const btn = document.createElement('button');
        btn.className = 'ob-chip'; btn.type = 'button';
        btn.textContent = _chipLabel(chip);
        btn.addEventListener('click', () => onFlowChipClick(chip, _flowState.stepId));
        chipsEl.appendChild(btn);
      });
      chipsEl.style.display = 'flex';
      if (!skipSave) _saveLastChips(chips);
    }

    async function _saveLastChips(chips) {
      if (!_flowUid) return;
      try {
        await db.collection('users').doc(_flowUid)
          .collection('chatosState').doc('flow')
          .set({ lastChips: chips || null, updatedAt: firebase.firestore.FieldValue.serverTimestamp() }, { merge: true });
      } catch (_) { }
    }

    // Modified to always stay open for all users and fetch history from backend
    // forceReload=true: re-fetches from backend (used after clear_chat) without page reload
    async function initChatOnboarding(uid, botsCount, forceReload) {
      if (window.FORCE_PROJECTS_MAIN) return;
      if (!uid) return;
      try {
        if (!forceReload) {
          // First-time init: show overlay and hide main UI
          CHAT_OS.container.style.display = 'flex';
          const mainContent = document.getElementById('main-content');
          const sidebar = document.querySelector('.sidebar');
          if (mainContent) mainContent.style.display = 'none';
          if (sidebar) sidebar.style.display = 'none';
        }

        // Show skeleton loader while fetching history (non-blocking, no text clutter)
        _showCosSkeleton();

        try {
          const res = await fetch(CHAT_OS_HANDLER_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ uid: uid, action: 'init' })
          });
          const data = await res.json();
          _clearCosSkeleton();
          chatOsInitDone = true;

          // Normalize roles: backend uses "assistant", frontend uses "bot"
          // Skip system/tool messages (not displayed in chat)
          chatOsHistory = (data.history || [])
            .filter(m => m.role !== 'system' && m.role !== 'tool')
            .map(m => {
              if (!m.role) {
                console.warn('[ChatOS] missing role in history message', m);
                return { ...m, role: 'bot' }; // safe fallback
              }
              return { ...m, role: m.role === 'assistant' ? 'bot' : m.role };
            });
          if (chatOsHistory.length > 0) {
            renderChatOsHistory();
          }

          // Update status bar asynchronously (non-blocking)
          ; (async () => {
            try {
              if (data.activeBotId) {
                _chatActiveBotId = data.activeBotId; // store for KB verify / status cards
                const botDoc = await db.collection("users").doc(uid).collection("bots").doc(data.activeBotId).get();
                const b = botDoc.data() || {};
                const kbSnap = await db.collection("users").doc(uid).collection("bots").doc(data.activeBotId).collection("knowledge_base").get();
                updateStatusBar({ activeBotName: b.name || 'Bot', kbCount: kbSnap.size, tgConnected: !!b.token });
              } else {
                updateStatusBar({ activeBotName: '‚Äî', kbCount: undefined, tgConnected: false });
              }
            } catch (_) {
              updateStatusBar({ activeBotName: '‚Äî', kbCount: undefined, tgConnected: false });
            }
          })();

          // Collection-level TG listener ‚Äî works for new users and existing ones
          setupTgListener(uid);

          // Enable UI after valid backend response
          CHAT_OS.inputEl.disabled = false;
          CHAT_OS.inputEl.placeholder = "–ù–∞–ø–∏—à–∏—Ç–µ –æ—Ç–≤–µ—Ç...";
          document.getElementById('chat-ob-attach-btn').disabled = false;
          // Init flow engine: reads saved step from Firestore, renders chips
          await initFlowEngine(uid);

          // Handle Assistant Expectation from backend
          if (data.assistant_expectation) {
            renderActionPanel(data.assistant_expectation);
          } else {
            renderActionPanel(null);
          }

          // Auto-start or post-reset UI when history is empty
          if (chatOsHistory.length === 0) {
            if (_pendingResetState !== null) {
              // After clearChatSmart: show "Continue / Restart" choice instead of generic greeting
              const savedStep = _pendingResetState;
              _pendingResetState = null;
              _showPostResetUI(savedStep);
            } else {
              // First-time open: let AI drive the conversation
              handleChatObSend('–ü—Ä–∏–≤–µ—Ç', { hidden: true });
            }
          }
        } catch (e) {
          _clearCosSkeleton();
          addChatOsMsg('bot', forceReload ? '–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.' : '–ü—Ä–∏–≤–µ—Ç. –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏, –Ω–æ —è –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ.');
          chatOsInitDone = true;
          CHAT_OS.inputEl.disabled = false;
          CHAT_OS.inputEl.placeholder = "–ù–∞–ø–∏—à–∏—Ç–µ –æ—Ç–≤–µ—Ç...";
          document.getElementById('chat-ob-attach-btn').disabled = false;
        }

        CHAT_OS.inputEl.focus();
      } catch (e) {
        console.error('[ChatOS] initChatOnboarding error:', e);
      }
    }

    // Smart Reset: clears history in Firestore (lastSeq stays monotonic), refreshes UI
    async function clearChatSmart() {
      // Auth guard ‚Äî retry if uid not ready
      if (!authReady || !window.resolvedUid) {
        addChatOsMsg('bot', '–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è‚Ä¶ —Å–µ–∫—É–Ω–¥—É.');
        setTimeout(() => { if (authReady && window.resolvedUid) clearChatSmart(); }, 800);
        return;
      }
      // Prevent clearing while AI is responding
      if (isWaitingForAI) {
        showToast(I18n.t('waitForResponse') + ' ' + I18n.t('clearChat'));
        return;
      }

      const ok = await showInlineConfirm({
        title: '–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ',
        text: '–û—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —á–∞—Ç–∞? –ë–æ—Ç –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Å—Ç–∞–Ω—É—Ç—Å—è.',
        okText: '–û—á–∏—Å—Ç–∏—Ç—å',
        cancelText: '–û—Ç–º–µ–Ω–∞'
      });
      if (!ok) return;

      // Lock input during operation
      CHAT_OS.inputEl.disabled = true;
      CHAT_OS.sendBtn.disabled = true;

      try {
        const resp = await fetch(CHAT_OS_HANDLER_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ uid: window.resolvedUid, action: 'clear_chat' })
        });

        let data = {};
        try { data = await resp.json(); } catch (_) { }

        if (!resp.ok || !data.success) {
          console.error('[ChatOS] clear_chat failed', { status: resp.status, data });
          addChatOsMsg('bot', '–ù–µ —É–¥–∞–ª–æ—Å—å –æ—á–∏—Å—Ç–∏—Ç—å —á–∞—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑.');
          return;
        }

        // Save current wizard step before reload so _showPostResetUI can offer "Continue/Restart"
        _pendingResetState = _flowState.stepId;

        // Reset all client-side transient state
        _lastDynamicChips = null;
        _tgWizardStatus = 'idle';
        _lastUserMsgEl = null;

        // Clear saved chips + tgWizard in Firestore BEFORE reload so initFlowEngine
        // doesn't restore stale dynamic chips or the old wizard state on reload
        try {
          await Promise.all([
            db.collection('users').doc(window.resolvedUid).collection('chatosState').doc('flow')
              .set({ lastChips: null }, { merge: true }),
            db.collection('users').doc(window.resolvedUid).collection('chatosState').doc('tgWizard')
              .set({ status: 'idle' }, { merge: true }),
          ]);
        } catch (_) { }

        // Reload session from backend ‚Äî no page refresh needed
        chatOsInitDone = false;
        _lastChatRole = null;
        await initChatOnboarding(window.resolvedUid, null, /*forceReload=*/true);

      } catch (e) {
        console.error('[ChatOS] clearChatSmart error:', e);
        addChatOsMsg('bot', '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —á–∞—Ç–∞.');
      } finally {
        CHAT_OS.inputEl.disabled = false;
        CHAT_OS.sendBtn.disabled = !CHAT_OS.inputEl.value.trim();
      }
    }

    // ‚îÄ‚îÄ Chat OS UX v2 state ‚îÄ‚îÄ
    let _lastChatRole = null;
    let _lastUserMsgEl = null; // tracks last user bubble for send-status updates

    // Skeleton loader shown during history fetch
    function _showCosSkeleton() {
      const frag = document.createDocumentFragment();
      // Three skeleton bubbles with different widths to look natural
      [[65, 85], [80, 50], [55, 72]].forEach(([w1, w2]) => {
        const wrap = document.createElement('div');
        wrap.className = 'cos-skeleton-wrap';
        wrap.innerHTML = `<div class="cos-skeleton-line" style="width:${w1}%"></div><div class="cos-skeleton-line" style="width:${w2}%"></div>`;
        frag.appendChild(wrap);
      });
      const scrollBtn = document.getElementById('cos-scroll-btn');
      const emptyEl = document.getElementById('cos-empty');
      if (emptyEl) emptyEl.classList.add('hidden');
      if (scrollBtn) CHAT_OS.messagesEl.insertBefore(frag, scrollBtn);
      else CHAT_OS.messagesEl.appendChild(frag);
    }

    function _clearCosSkeleton() {
      CHAT_OS.messagesEl.querySelectorAll('.cos-skeleton-wrap').forEach(el => el.remove());
    }

    // ‚îÄ‚îÄ POST-RESET FLOW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    // Human-readable labels for each wizard step
    const STEP_LABELS = {
      WELCOME: '–ù–∞—á–∞–ª–æ',
      BOT_NAME: '–°–æ–∑–¥–∞–Ω–∏–µ –±–æ—Ç–∞',
      ACTIVE: '–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –±–æ—Ç–∞',
    };
    // Message sent to AI when user picks "Continue" from a given step
    const STEP_CONTINUE_MSGS = {
      BOT_NAME: '–ü—Ä–æ–¥–æ–ª–∂–∏–º ‚Äî —è —Ö–æ—á—É —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –±–æ—Ç–∞.',
      ACTIVE: '–ü—Ä–æ–¥–æ–ª–∂–∏–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –±–æ—Ç–∞.',
    };
    // Set by clearChatSmart() before reload so initChatOnboarding shows the right post-reset UI
    let _pendingResetState = null;

    function _getStepLabel(stepId) {
      return STEP_LABELS[stepId] || stepId || '–ù–∞—Å—Ç—Ä–æ–π–∫–∞';
    }

    // Shows context-aware "History cleared" message + Continue/Restart chips
    function _showPostResetUI(savedStepId) {
      const hasProgress = savedStepId && savedStepId !== 'WELCOME';
      if (hasProgress) {
        const label = _getStepLabel(savedStepId);
        addChatOsMsg('bot',
          `‚úÖ –ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞.\n\n–ú—ã –æ—Å—Ç–∞–Ω–æ–≤–∏–ª–∏—Å—å –Ω–∞ —à–∞–≥–µ: **${label}**.\n–ü—Ä–æ–¥–æ–ª–∂–∏–º —Å —ç—Ç–æ–≥–æ –º–µ—Å—Ç–∞ –∏–ª–∏ –Ω–∞—á–Ω—ë–º –∑–∞–Ω–æ–≤–æ?`
        );
        applyDynamicChips([
          { label: '‚ñ∂ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å', action: 'reset_continue', _savedStepId: savedStepId },
          { label: 'üîÑ –ù–∞—á–∞—Ç—å –∑–∞–Ω–æ–≤–æ', action: 'reset_restart' },
        ], /*skipSave=*/true);
      } else {
        addChatOsMsg('bot', '‚úÖ –ò—Å—Ç–æ—Ä–∏—è –æ—á–∏—â–µ–Ω–∞.\n\n–í—ã–±–µ—Ä–∏—Ç–µ, —á—Ç–æ –¥–µ–ª–∞–µ–º:');
        renderFlowChips('WELCOME');
      }
    }

    // 5. Markdown renderer
    function renderCosMarkdown(text) {
      let s = esc(text);
      // Multiline code blocks
      s = s.replace(/```([\s\S]*?)```/g, (_, c) => `<pre class="cos-pre"><code>${c.trim()}</code></pre>`);
      // Inline code
      s = s.replace(/`([^`\n]+)`/g, '<code class="cos-code">$1</code>');
      // Bold
      s = s.replace(/\*\*(.+?)\*\*/g, '<b>$1</b>');
      // Italic
      s = s.replace(/\*([^*\n]+)\*/g, '<i>$1</i>');
      // Unordered list items
      s = s.replace(/(?:^|\n)[‚Ä¢\-] (.+)/g, (_, item) => `\n<li>${item}</li>`);
      s = s.replace(/(<li>[\s\S]*?<\/li>)/g, '<ul>$1</ul>');
      // Line breaks
      s = s.replace(/\n/g, '<br>');
      // Auto-link URLs (safe: esc() already escaped user content, only https/http allowed)
      s = s.replace(/https?:\/\/[^\s<"']{4,200}/g, url => `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`);
      return s;
    }

    // 9. Reaction toggle (üëé also shows suggestion form)
    function cosReactClick(e) {
      const btn = e.currentTarget;
      const container = btn.closest('.cos-reactions');
      const wasActive = btn.classList.contains('active');
      container.querySelectorAll('.cos-react').forEach(b => b.classList.remove('active'));
      // Remove any existing feedback form
      const existingForm = container.nextElementSibling;
      if (existingForm && existingForm.classList.contains('cos-feedback-form')) existingForm.remove();
      if (!wasActive) {
        btn.classList.add('active');
        if (btn.dataset.v === '-1') showSuggestionForm(container);
      }
    }

    function _buildMsgEl(role, content, isGroup) {
      const div = document.createElement('div');
      div.className = (role === 'bot' ? 'msg-bot' : 'msg-user') + (isGroup ? ' msg-grp' : '');
      const html = role === 'bot'
        ? renderCosMarkdown(content)
        : esc(content).replace(/\n/g, '<br>');
      const time = new Date().toLocaleTimeString('ru', { hour: '2-digit', minute: '2-digit' });
      div.dataset.text = content;
      div.innerHTML = `<div class="cos-content">${html}</div><div class="cos-time">${time}</div>`;
      if (role === 'bot') {
        const copyBtn = document.createElement('button');
        copyBtn.className = 'cos-copy-btn'; copyBtn.title = '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å'; copyBtn.textContent = '‚éò';
        copyBtn.addEventListener('click', () => {
          navigator.clipboard.writeText(content).then(() => {
            copyBtn.textContent = '‚úì';
            setTimeout(() => { copyBtn.textContent = '‚éò'; }, 1500);
          }).catch(() => { });
        });
        div.appendChild(copyBtn);
      }
      return div;
    }

    function renderChatOsHistory() {
      // Remove previous dynamic messages but keep #cos-empty and #cos-scroll-btn
      Array.from(CHAT_OS.messagesEl.children).forEach(ch => {
        if (ch.id !== 'cos-empty' && ch.id !== 'cos-scroll-btn') ch.remove();
      });
      _lastChatRole = null;
      const emptyEl = document.getElementById('cos-empty');
      const scrollBtn = document.getElementById('cos-scroll-btn');
      if (emptyEl) emptyEl.classList.toggle('hidden', chatOsHistory.length > 0);

      const frag = document.createDocumentFragment();
      chatOsHistory.forEach(msg => {
        // Normalize role: treat 'assistant' same as 'bot'; skip system/tool
        const role = msg.role === 'assistant' ? 'bot' : (msg.role || 'bot');
        if (role === 'system' || role === 'tool') return; // skip non-chat messages
        const isGroup = role === _lastChatRole;
        const div = document.createElement('div');
        div.className = (role === 'bot' ? 'msg-bot' : 'msg-user') + (isGroup ? ' msg-grp' : '');
        const html = role === 'bot'
          ? renderCosMarkdown(msg.content || '')
          : esc(msg.content || '').replace(/\n/g, '<br>');
        div.dataset.text = msg.content || '';
        div.innerHTML = `<div class="cos-content">${html}</div>`;
        if (role === 'bot') {
          const txt = msg.content || '';
          const copyBtn = document.createElement('button');
          copyBtn.className = 'cos-copy-btn'; copyBtn.title = '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å'; copyBtn.textContent = '‚éò';
          copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(txt).then(() => {
              copyBtn.textContent = '‚úì'; setTimeout(() => { copyBtn.textContent = '‚éò'; }, 1500);
            }).catch(() => { });
          });
          div.appendChild(copyBtn);
          frag.appendChild(div);
          const reactEl = document.createElement('div');
          reactEl.className = 'cos-reactions';
          reactEl.innerHTML = '<button class="cos-react" data-v="1">üëç</button><button class="cos-react" data-v="-1">üëé</button>';
          reactEl.querySelectorAll('.cos-react').forEach(b => b.addEventListener('click', cosReactClick));
          frag.appendChild(reactEl);
        } else {
          frag.appendChild(div);
        }
        _lastChatRole = role; // use normalized role for grouping
      });
      if (scrollBtn) CHAT_OS.messagesEl.insertBefore(frag, scrollBtn);
      else CHAT_OS.messagesEl.appendChild(frag);
      scrollToBottomChatOs();
    }

    function addChatOsMsg(role, content) {
      const isTyping = role === 'bot' && content === '...';
      if (!isTyping) chatOsHistory.push({ role, content });

      const scrollBtn = document.getElementById('cos-scroll-btn');
      const emptyEl = document.getElementById('cos-empty');
      if (emptyEl && !emptyEl.classList.contains('hidden')) emptyEl.classList.add('hidden');

      const isGroup = !isTyping && role === _lastChatRole;
      if (!isTyping) _lastChatRole = role;

      const div = document.createElement('div');
      div.className = (role === 'bot' ? 'msg-bot' : 'msg-user') + (isGroup ? ' msg-grp' : '');

      if (isTyping) {
        // 1. Animated typing indicator
        div.id = 'chat-os-typing';
        div.innerHTML = '<span class="cos-dot"></span><span class="cos-dot"></span><span class="cos-dot"></span>';
      } else {
        const html = role === 'bot'
          ? renderCosMarkdown(content)
          : esc(content).replace(/\n/g, '<br>');
        const time = new Date().toLocaleTimeString('ru', { hour: '2-digit', minute: '2-digit' });
        div.dataset.text = content;
        // User messages get a ‚è≥ send-status that updates to ‚úì after AI responds
        const statusHtml = role === 'user' ? '<span class="cos-send-status">‚è≥</span>' : '';
        div.innerHTML = `<div class="cos-content">${html}</div><div class="cos-time">${time}${statusHtml}</div>`;
        if (role === 'user') _lastUserMsgEl = div;
        if (role === 'bot') {
          const copyBtn = document.createElement('button');
          copyBtn.className = 'cos-copy-btn'; copyBtn.title = '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å'; copyBtn.textContent = '‚éò';
          copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(content).then(() => {
              copyBtn.textContent = '‚úì'; setTimeout(() => { copyBtn.textContent = '‚éò'; }, 1500);
            }).catch(() => { });
          });
          div.appendChild(copyBtn);
        }
      }

      if (scrollBtn) CHAT_OS.messagesEl.insertBefore(div, scrollBtn);
      else CHAT_OS.messagesEl.appendChild(div);

      // 9. Reactions (bot only, not typing)
      if (!isTyping && role === 'bot') {
        const reactEl = document.createElement('div');
        reactEl.className = 'cos-reactions';
        reactEl.innerHTML = '<button class="cos-react" data-v="1">üëç</button><button class="cos-react" data-v="-1">üëé</button>';
        reactEl.querySelectorAll('.cos-react').forEach(b => b.addEventListener('click', cosReactClick));
        if (scrollBtn) CHAT_OS.messagesEl.insertBefore(reactEl, scrollBtn);
        else CHAT_OS.messagesEl.appendChild(reactEl);
      }

      scrollToBottomChatOs();
    }

    function removeTypingIndicator() {
      const el = document.getElementById('chat-os-typing');
      if (el) el.remove();
      chatOsHistory = chatOsHistory.filter(m => m.content !== '...');
    }

    // 10. Smooth scroll + hide scroll button
    function scrollToBottomChatOs() {
      const el = CHAT_OS.messagesEl;
      setTimeout(() => {
        el.scrollTo({ top: el.scrollHeight, behavior: 'smooth' });
        const btn = document.getElementById('cos-scroll-btn');
        if (btn) btn.classList.add('hidden');
      }, 50);
    }

    async function handleChatObSend(overrideText, opts = {}) {
      if (!authReady || !chatOsInitDone || !window.resolvedUid) {
        // Queue retry ‚Äî preserve text and file so the message isn't lost
        const _savedText = overrideText || CHAT_OS.inputEl.value.trim();
        const _savedFile = pendingChatAttachment;
        // Show subtle loading note (not "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è" which is confusing during normal history load)
        if (!chatOsInitDone && authReady) {
          addChatOsMsg('bot', '–ó–∞–≥—Ä—É–∂–∞—é –∏—Å—Ç–æ—Ä–∏—é, –æ—Ç–ø—Ä–∞–≤–ª—é —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É‚Ä¶');
        } else {
          addChatOsMsg('bot', '–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è‚Ä¶ –ø–æ–≤—Ç–æ—Ä—é —á–µ—Ä–µ–∑ —Å–µ–∫—É–Ω–¥—É.');
        }
        const _retryTimer = setInterval(() => {
          if (authReady && chatOsInitDone && window.resolvedUid) {
            clearInterval(_retryTimer);
            if (_savedFile && !pendingChatAttachment) pendingChatAttachment = _savedFile;
            handleChatObSend(_savedText || undefined);
          }
        }, 500);
        return;
      }
      if (isWaitingForAI) return;
      const text = overrideText || CHAT_OS.inputEl.value.trim();

      // If flag is off, ensure we don't accidentally process attachments
      if (!FILE_UPLOAD_ENABLED && pendingChatAttachment) clearChatAttachment();

      if (!text && !pendingChatAttachment) return;

      // TG Wizard: intercept token input while waiting for Telegram token
      if (_tgWizardStatus === 'waiting_token' && text && !opts.hidden) {
        CHAT_OS.inputEl.value = '';
        CHAT_OS.inputEl.style.height = 'auto';
        addChatOsMsg('user', text);
        const TOKEN_RE = /^[0-9]{8,}:[A-Za-z0-9_-]{20,}$/;
        if (TOKEN_RE.test(text.trim())) {
          connectTelegramToken(text.trim());
        } else {
          addChatOsMsg('bot', '–ü–æ—Ö–æ–∂–µ, —ç—Ç–æ –Ω–µ —Ç–æ–∫–µ–Ω. –¢–æ–∫–µ–Ω –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫:\n123456789:AAHdqTcvfTBHRcTifIaAUe...\n\n–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –µ–≥–æ —Ü–µ–ª–∏–∫–æ–º –∏–∑ BotFather –∏ –≤—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞.');
        }
        return;
      }

      CHAT_OS.inputEl.value = '';
      CHAT_OS.inputEl.style.height = 'auto';
      CHAT_OS.inputEl.disabled = true;
      CHAT_OS.sendBtn.disabled = true;
      document.getElementById('chat-ob-attach-btn').disabled = true;
      isWaitingForAI = true;

      if (text && !opts.hidden) addChatOsMsg('user', text);

      // Flow engine: auto-advance for text-input steps (no chips shown)
      // WELCOME is chip-only; ACTIVE stays in ACTIVE
      if (!opts.hidden && text && _pendingNextStep === null &&
        _flowState.stepId !== 'ACTIVE' && _flowState.stepId !== 'WELCOME') {
        const _curStep = FLOW_STEPS[_flowState.stepId];
        if (_curStep && _curStep.chips && _curStep.chips.length === 0) {
          _pendingNextStep = getDefaultNextStep(_flowState.stepId);
        }
      }

      let attachmentMeta = null;
      let uploadBubble = null;

      if (pendingChatAttachment) {
        // Lock chips during file upload so tests/other actions can't start concurrently
        if (CHAT_OS.chipsEl) CHAT_OS.chipsEl.querySelectorAll('button').forEach(b => b.disabled = true);
        // Determine icon kind from file extension
        const _ext = pendingChatAttachment.name.split('.').pop().toLowerCase();
        const _iconMap = { pdf: 'pdf', jpg: 'img', jpeg: 'img', png: 'img', gif: 'img', webp: 'img', svg: 'img', zip: 'zip', rar: 'zip', '7z': 'zip', tar: 'zip', gz: 'zip', txt: 'txt', csv: 'csv', md: 'txt' };
        const _iconKind = _iconMap[_ext] || 'doc';
        const _iconLabel = _ext.toUpperCase().slice(0, 4);
        const _sizeMB = (pendingChatAttachment.size / 1024 / 1024).toFixed(1);

        // Create Telegram-style upload bubble
        uploadBubble = document.createElement('div');
        uploadBubble.className = 'upload-bubble';
        uploadBubble.dataset.state = 'uploading';
        uploadBubble.innerHTML = `
          <div class="ub-row">
            <div class="ub-icon" data-kind="${_iconKind}"><span>${_iconLabel}</span></div>
            <div class="ub-main">
              <div class="ub-title">${esc(pendingChatAttachment.name)}</div>
              <div class="ub-sub">
                <span class="ub-status">–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶</span>
                <span class="ub-meta"><span class="ub-percent">0%</span> ¬∑ <span class="ub-size">${_sizeMB} MB</span></span>
              </div>
              <div class="ub-bar" aria-label="upload progress"><div class="ub-bar-fill" style="width:0%"></div></div>
            </div>
            <button class="ub-x" title="–û—Ç–º–µ–Ω–∏—Ç—å" aria-label="cancel">‚úï</button>
          </div>
          <div class="ub-processing"><span class="ub-spinner"></span><span>–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ñ–∞–π–ª‚Ä¶</span></div>
          <div class="ub-done"><span class="ub-check">‚úì</span><span>–§–∞–π–ª —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π</span></div>
          <div class="ub-error"><span class="ub-warn">!</span><span class="ub-error-text">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.</span></div>
        `;
        CHAT_OS.messagesEl.appendChild(uploadBubble);
        scrollToBottomChatOs();

        const file = pendingChatAttachment;
        clearChatAttachment(); // remove pill from UI immediately

        // Direct Firebase Storage upload ‚Äî no bytes through Cloud Functions
        uploadBubble.dataset.state = 'uploading'; // show real progress bar
        try {
          const _safeName = file.name.replace(/[^\w.\-()\s]/g, '_').slice(0, 120);
          const _botId = (typeof STATE !== 'undefined' && STATE.currentBotId) ? STATE.currentBotId : 'default';
          const _storagePath = `users/${window.resolvedUid}/bots/${_botId}/uploads/${Date.now()}_${_safeName}`;
          const _storageRef = firebase.storage().ref().child(_storagePath);
          const _task = _storageRef.put(file, { contentType: file.type || 'application/octet-stream' });

          // Wire up cancel button
          const _cancelBtn = uploadBubble.querySelector('.ub-x');
          if (_cancelBtn) {
            _cancelBtn.addEventListener('click', () => {
              _task.cancel();
              uploadBubble.dataset.state = 'error';
              const _errText = uploadBubble.querySelector('.ub-error-text');
              if (_errText) _errText.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞.';
            });
          }

          const _fillEl = uploadBubble.querySelector('.ub-bar-fill');
          const _pctEl = uploadBubble.querySelector('.ub-percent');
          const _statusEl = uploadBubble.querySelector('.ub-status');

          await new Promise((resolve, reject) => {
            _task.on('state_changed',
              (snap) => {
                const pct = snap.totalBytes ? Math.round((snap.bytesTransferred / snap.totalBytes) * 100) : 0;
                if (_fillEl) _fillEl.style.width = pct + '%';
                if (_pctEl) _pctEl.textContent = pct + '%';
                if (_statusEl) _statusEl.textContent = '–ó–∞–≥—Ä—É–∑–∫–∞‚Ä¶';
              },
              (err) => reject(err),
              () => resolve()
            );
          });

          const _downloadURL = await _task.snapshot.ref.getDownloadURL();
          uploadBubble.dataset.state = 'processing'; // spinner while AI processes
          if (_kbPanelActive) _kbPanelOnFileUploaded();

          attachmentMeta = {
            type: 'file',
            name: _safeName,
            mimeType: file.type || 'application/octet-stream',
            size: file.size,
            storagePath: _storagePath,
            downloadURL: _downloadURL
          };

        } catch (uploadErr) {
          console.error('[ChatOS] Storage upload failed:', uploadErr);
          uploadBubble.dataset.state = 'error';
          uploadBubble.querySelector('.ub-error-text').textContent =
            uploadErr.code === 'storage/unauthorized' ? '–ù–µ—Ç –ø—Ä–∞–≤ –Ω–∞ –∑–∞–≥—Ä—É–∑–∫—É. –í–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞.' : '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏.';
          isWaitingForAI = false;
          CHAT_OS.inputEl.disabled = false;
          CHAT_OS.sendBtn.disabled = false;
          if (FILE_UPLOAD_ENABLED) document.getElementById('chat-ob-attach-btn').disabled = false;
          return; // Abort LLM call since file didn't make it
        }
      }

      // 4) Main LLM Request handling
      addChatOsMsg('bot', '...'); // typing indicator

      try {
        const response = await fetch(CHAT_OS_HANDLER_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            uid: window.resolvedUid,
            action: 'message',
            text: text,
            attachment: attachmentMeta,
            capabilities: {
              fileUpload: FILE_UPLOAD_ENABLED,
              textPaste: true,
              urlInput: true
            }
          })
        });

        const data = await response.json();
        removeTypingIndicator();

        // Switch upload bubble to done state and auto-hide it after a short delay
        if (uploadBubble) {
          uploadBubble.dataset.state = 'done';
          setTimeout(() => {
            if (uploadBubble && uploadBubble.isConnected && uploadBubble.dataset.state === 'done') {
              uploadBubble.remove();
            }
          }, 4500);
        }

        if (data.reply) {
          addChatOsMsg('bot', data.reply);
        } else {
          addChatOsMsg('bot', '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ (–ø—É—Å—Ç–æ–π –æ—Ç–≤–µ—Ç).');
        }
        // Update last user message: ‚è≥ ‚Üí ‚úì
        if (_lastUserMsgEl) {
          const s = _lastUserMsgEl.querySelector('.cos-send-status');
          if (s) s.textContent = '‚úì';
          _lastUserMsgEl = null;
        }
        handleFlowAfterAIResponse();

        // Handle Assistant Expectation first (if present, it overrides heuristic chips)
        if (data.assistant_expectation) {
          renderActionPanel(data.assistant_expectation);
        } else {
          renderActionPanel(null); // Clear panel if connection successful / no expectation
        }

        // Dynamic chips: infer contextual chips from AI reply (ACTIVE mode only)
        if (_flowState.stepId === 'ACTIVE' && data.reply && !data.assistant_expectation) {
          const dynChips = inferChipsFromReply(data.reply, data.actions);
          if (dynChips) {
            if (!dynChips.some(c => c.action === 'go_back' || c.action === 'reset_to_active')) {
              dynChips.push({ label: '‚¨Ö –ù–∞–∑–∞–¥', action: 'reset_to_active' });
            }
            applyDynamicChips(dynChips);
          }
        }
        // After file upload ‚Äî show KB processing status card in chat
        if (uploadBubble && _chatActiveBotId) {
          setTimeout(() => _showKbStatusCard(_chatActiveBotId), 700);
        }

      } catch (err) {
        removeTypingIndicator();
        if (uploadBubble) uploadBubble.dataset.state = 'error';
        clearChatAttachment();
        addChatOsMsg('bot', '–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑. –ï—Å–ª–∏ —Ñ–∞–π–ª –±–æ–ª—å—à–æ–π, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ç–µ–∫—Å—Ç/—Å—Å—ã–ª–∫—É.');
        // Update last user message: ‚è≥ ‚Üí ‚Üª –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
        if (_lastUserMsgEl) {
          const s = _lastUserMsgEl.querySelector('.cos-send-status');
          if (s) {
            const savedText = _lastUserMsgEl.dataset.text;
            s.textContent = '‚Üª –ü–æ–≤—Ç–æ—Ä–∏—Ç—å'; s.className = 'cos-send-status failed';
            s.title = '–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–Ω–æ–≤–∞';
            s.addEventListener('click', () => { s.remove(); handleChatObSend(savedText); }, { once: true });
          }
          _lastUserMsgEl = null;
        }
        console.error(err);
      } finally {
        CHAT_OS.inputEl.disabled = false;
        CHAT_OS.sendBtn.disabled = false;
        document.getElementById('chat-ob-attach-btn').disabled = false;
        if (CHAT_OS.chipsEl) CHAT_OS.chipsEl.querySelectorAll('button').forEach(b => b.disabled = false);
        isWaitingForAI = false;
        CHAT_OS.inputEl.focus();
      }
    }

    function handleChatObChipClick(chip) {
      // Optional: We can leave this empty or remove it,
      // since Chat OS doesn't use hardcoded chips anymore.
    }

    CHAT_OS.sendBtn.addEventListener('click', () => handleChatObSend());
    // 4. Shift+Enter = newline, Enter = send
    CHAT_OS.inputEl.addEventListener('keydown', (e) => {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleChatObSend(); }
    });
    CHAT_OS.inputEl.addEventListener('input', function () {
      CHAT_OS.sendBtn.disabled = !this.value.trim() && !pendingChatAttachment;
      // 4. Auto-grow textarea
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 120) + 'px';
    });
    document.getElementById('clear-chat-btn')?.addEventListener('click', clearChatSmart);
    // 6. Scroll-to-bottom button visibility
    CHAT_OS.messagesEl.addEventListener('scroll', () => {
      const el = CHAT_OS.messagesEl;
      const btn = document.getElementById('cos-scroll-btn');
      if (!btn) return;
      const atBottom = el.scrollHeight - el.scrollTop - el.clientHeight < 80;
      btn.classList.toggle('hidden', atBottom);
    });
    document.getElementById('cos-scroll-btn')?.addEventListener('click', scrollToBottomChatOs);

    // ‚Üª Refresh button: soft reload ‚Äî no full page reload
    document.getElementById('refresh-chat-btn')?.addEventListener('click', async () => {
      if (isWaitingForAI) { showToast(I18n.t('waitForResponse')); return; }
      if (!window.resolvedUid) return;
      const btn = document.getElementById('refresh-chat-btn');
      if (btn) { btn.style.opacity = '0.4'; btn.style.pointerEvents = 'none'; }
      chatOsInitDone = false;
      _lastChatRole = null;
      _lastUserMsgEl = null;
      try {
        await initChatOnboarding(window.resolvedUid, null, /*forceReload=*/true);
      } finally {
        if (btn) { btn.style.opacity = ''; btn.style.pointerEvents = ''; }
      }
    });

    // Online/offline reconnect status
    const _cosConnEl = document.getElementById('cos-conn-status');
    window.addEventListener('offline', () => {
      if (_cosConnEl) { _cosConnEl.textContent = 'üì° –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è‚Ä¶'; _cosConnEl.classList.add('visible'); }
    });
    window.addEventListener('online', () => {
      if (_cosConnEl) {
        _cosConnEl.textContent = '‚úì –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ';
        setTimeout(() => _cosConnEl.classList.remove('visible'), 2500);
      }
    });

    // We no longer need finishChatOnboarding because it's a persistent OS

    // ‚îÄ‚îÄ INFO POPOVER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const INFO_CONTENT = {
      rules: {
        title: 'üìã –ü—Ä–∞–≤–∏–ª–∞ –æ–±—â–µ–Ω–∏—è ‚Äî —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º—Ç',
        why: '–°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º—Ç ‚Äî –≥–ª–∞–≤–Ω–∞—è –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è –±–æ—Ç–∞. –û–Ω –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ª–∏—á–Ω–æ—Å—Ç—å, —Ç–æ–Ω –∏ –ø–æ–≤–µ–¥–µ–Ω–∏–µ: –∫–∞–∫ –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç, —á—Ç–æ –≥–æ–≤–æ—Ä–∏—Ç—å –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –æ—Ç–≤–µ—Ç–∞, —á—Ç–æ –∑–∞–ø—Ä–µ—â–µ–Ω–æ.',
        how: [
          '–û–ø–∏—à–∏—Ç–µ —Ä–æ–ª—å: –∫—Ç–æ –≤–∞—à –±–æ—Ç, –∫–∞–∫ –µ–≥–æ –∑–æ–≤—É—Ç.',
          '–£–∫–∞–∂–∏—Ç–µ –∞—É–¥–∏—Ç–æ—Ä–∏—é: –¥–ª—è –∫–æ–≥–æ –æ–Ω —Ä–∞–±–æ—Ç–∞–µ—Ç.',
          '–ó–∞–¥–∞–π—Ç–µ —Ç–æ–Ω: –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–π, —Å—Ç—Ä–æ–≥–∏–π –∏–ª–∏ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π.',
          '–î–æ–±–∞–≤—å—Ç–µ fallback-—Ñ—Ä–∞–∑—É ‚Äî —á—Ç–æ –ø–∏—Å–∞—Ç—å, –µ—Å–ª–∏ –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞.',
          '–ù–∞–∂–º–∏—Ç–µ ¬´üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª –¥–ª—è –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è.',
        ],
        result: '–í—Å–µ –Ω–æ–≤—ã–µ –æ—Ç–≤–µ—Ç—ã –±–æ—Ç–∞ –±—É–¥—É—Ç —Å–ª–µ–¥–æ–≤–∞—Ç—å –≤–∞—à–∏–º –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º. –ò–∑–º–µ–Ω–µ–Ω–∏—è –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ ‚Äî –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∂–µ —Å–æ–æ–±—â–µ–Ω–∏—è.',
      },
      topics: {
        title: 'üìö –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π',
        why: '–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π ‚Äî –∏—Å—Ç–æ—á–Ω–∏–∫ —Ç–æ—á–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤. –ë–µ–∑ –Ω–µ—ë –±–æ—Ç –æ—Ç–≤–µ—á–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ –æ–±—â–µ–º—É –ø—Ä–æ–º—Ç—É, –±–µ–∑ –¥–µ—Ç–∞–ª–µ–π –≤–∞—à–µ–≥–æ –±–∏–∑–Ω–µ—Å–∞, —Ç–æ–≤–∞—Ä–æ–≤ –∏–ª–∏ —É—Å–ª—É–≥.',
        how: [
          '–ù–∞–∂–º–∏—Ç–µ ¬´üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å¬ª –¥–ª—è —Ñ–∞–π–ª–∞ (PDF, DOCX, TXT).',
          '–ù–∞–∂–º–∏—Ç–µ ¬´‚úèÔ∏è –ù–∞–ø–∏—Å–∞—Ç—å¬ª –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞.',
          '–î–æ–±–∞–≤—å—Ç–µ YouTube-–≤–∏–¥–µ–æ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏–∏.',
          '–î–æ–∂–¥–∏—Ç–µ—Å—å –æ–±—Ä–∞–±–æ—Ç–∫–∏ (–æ–±—ã—á–Ω–æ 1‚Äì2 –º–∏–Ω—É—Ç—ã).',
          '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–æ–≤—ã–µ —Ç–µ–º—ã –≤ —Ç–∞–±–ª–∏—Ü–µ –Ω–∏–∂–µ.',
        ],
        result: '–ë–æ—Ç –Ω–∞—á–Ω—ë—Ç —Ç–æ—á–Ω–æ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–º –º–∞—Ç–µ—Ä–∏–∞–ª–∞–º. –ö–∞—á–µ—Å—Ç–≤–æ —Ä–∞—Å—Ç—ë—Ç —Å –∫–∞–∂–¥—ã–º –Ω–æ–≤—ã–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–º.',
      },
      launch: {
        title: '‚úàÔ∏è –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –≤ Telegram',
        why: '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Telegram –¥–∞—ë—Ç –±–æ—Ç—É —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –∫–∞–Ω–∞–ª –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–º–æ–≥—É—Ç –Ω–∞–ø–∏—Å–∞—Ç—å –±–æ—Ç—É –Ω–∞–ø—Ä—è–º—É—é ‚Äî –±–µ–∑ —Å–∞–π—Ç–∞ –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π.',
        how: [
          '–û—Ç–∫—Ä–æ–π—Ç–µ @BotFather –≤ Telegram.',
          '–°–æ–∑–¥–∞–π—Ç–µ –±–æ—Ç–∞ –∫–æ–º–∞–Ω–¥–æ–π /newbot.',
          '–ó–∞–¥–∞–π—Ç–µ –∏–º—è –∏ username (–∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –Ω–∞ bot).',
          '–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –≤—ã–¥–∞–Ω–Ω—ã–π —Ç–æ–∫–µ–Ω (–≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫ 123456:AAF...).',
          '–ù–∞–∂–º–∏—Ç–µ ¬´‚ö° –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å¬ª ‚Äî –±–æ—Ç –∑–∞–ø—É—Å—Ç–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.',
        ],
        result: '–ë–æ—Ç –Ω–∞—á–Ω—ë—Ç –ø–æ–ª—É—á–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ ‚Äî –Ω–∞–π–¥–∏—Ç–µ –±–æ—Ç–∞ –ø–æ username –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ /start.',
      },
      testing: {
        title: 'üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±–æ—Ç–∞',
        why: '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–∑–≤–æ–ª—è–µ—Ç —É–≤–∏–¥–µ—Ç—å –æ—Ç–≤–µ—Ç—ã –±–æ—Ç–∞ –¥–æ —Ä–µ–∞–ª—å–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞. –õ—É—á—à–µ –Ω–∞–π—Ç–∏ –ø—Ä–æ–±–ª–µ–º—ã –∑–¥–µ—Å—å, —á–µ–º —É –∫–ª–∏–µ–Ω—Ç–æ–≤.',
        how: [
          '–ù–∞–ø–∏—à–∏—Ç–µ –≤–æ–ø—Ä–æ—Å –≤ —á–∞—Ç, –∫–∞–∫ —ç—Ç–æ —Å–¥–µ–ª–∞–ª –±—ã –∫–ª–∏–µ–Ω—Ç.',
          '–û—Ü–µ–Ω–∏—Ç–µ –æ—Ç–≤–µ—Ç: —Ç–æ—á–Ω–æ—Å—Ç—å, —Ç–æ–Ω, –ø–æ–ª–Ω–æ—Ç—É –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.',
          '–ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –ø–ª–æ—Ö–æ–π ‚Äî –æ–±–Ω–æ–≤–∏—Ç–µ —Å–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º—Ç –∏–ª–∏ –¥–æ–±–∞–≤—å—Ç–µ –¥–∞–Ω–Ω—ã–µ –≤ KB.',
          '–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ ¬´üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å¬ª ‚Üí ¬´üöÄ –ê–≤—Ç–æ-—Ç–µ—Å—Ç¬ª –¥–ª—è –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏.',
          '–ü–æ–≤—Ç–æ—Ä—è–π—Ç–µ –¥–æ –ø–æ–ª—É—á–µ–Ω–∏—è –Ω—É–∂–Ω–æ–≥–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞.',
        ],
        result: '–í—ã —É–≤–∏–¥–∏—Ç–µ —Ç–æ—á–Ω–æ –∫–∞–∫ –±–æ—Ç –æ—Ç–≤–µ—Ç–∏—Ç —Ä–µ–∞–ª—å–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ‚Äî –±–µ–∑ –≤–ª–∏—è–Ω–∏—è –Ω–∞ –ø—Ä–æ–¥–∞–∫—à–Ω.',
      },
      analytics: {
        title: 'üìä –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∑–∞–ø—Ä–æ—Å–æ–≤',
        why: '–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π –æ–±—Ä–∞–±–æ—Ç–∞–ª –±–æ—Ç, –Ω–∞ —á—Ç–æ –æ–Ω –Ω–µ —Å–º–æ–≥ –æ—Ç–≤–µ—Ç–∏—Ç—å –∏ –≥–¥–µ –µ—Å—Ç—å –ø—Ä–æ–±–µ–ª—ã –≤ –±–∞–∑–µ –∑–Ω–∞–Ω–∏–π.',
        how: [
          '–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥: 7, 30 –∏–ª–∏ 90 –¥–Ω–µ–π.',
          '–ò–∑—É—á–∏—Ç–µ —Ä–∞–∑–¥–µ–ª ¬´–ë–µ–∑ –æ—Ç–≤–µ—Ç–æ–≤¬ª ‚Äî —ç—Ç–æ —Ç–µ–º—ã, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ KB.',
          '–ù–∞–∂–º–∏—Ç–µ –Ω–∞ —Ç–µ–º—É, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å –æ—Ç–≤–µ—Ç –ø—Ä—è–º–æ –∏–∑ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏.',
          '–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –∞–Ω–∞–ª–∏—Ç–∏–∫—É —Ä–∞–∑ –≤ –Ω–µ–¥–µ–ª—é –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –∫–∞—á–µ—Å—Ç–≤–∞.',
        ],
        result: '–ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤ –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π –±–æ—Ç –Ω–∞—á–Ω—ë—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —ç—Ç–∏ –∑–∞–ø—Ä–æ—Å—ã.',
      },
      welcome: {
        title: 'üé® –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ ‚Äî —Å–æ–æ–±—â–µ–Ω–∏–µ –ø—Ä–∏ /start',
        why: '–≠—Ç–æ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –±–æ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ. –•–æ—Ä–æ—à–µ–µ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –ø–æ–≤—ã—à–∞–µ—Ç –≤–æ–≤–ª–µ—á—ë–Ω–Ω–æ—Å—Ç—å –∏ –∑–∞–¥–∞—ë—Ç —Ç–æ–Ω —Ä–∞–∑–≥–æ–≤–æ—Ä–∞.',
        how: [
          '–ù–∞–ø–∏—à–∏—Ç–µ —Ç–µ–∫—Å—Ç ‚Äî –ø—Ä–µ–¥—Å—Ç–∞–≤—å—Ç–µ—Å—å –∏ —Ä–∞—Å—Å–∫–∞–∂–∏—Ç–µ —á—Ç–æ —É–º–µ–µ—Ç –±–æ—Ç.',
          '–î–æ–±–∞–≤—å—Ç–µ –¥–æ 4 –±—ã—Å—Ç—Ä—ã—Ö –∫–Ω–æ–ø–æ–∫ (—á–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ –¥–µ–π—Å—Ç–≤–∏—è).',
          '–ù–∞–∂–º–∏—Ç–µ ¬´üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å¬ª.',
          '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ ‚Äî –æ—Ç–ø—Ä–∞–≤—å—Ç–µ /start —Å–≤–æ–µ–º—É –±–æ—Ç—É –≤ Telegram.',
        ],
        result: '–ë–æ—Ç –±—É–¥–µ—Ç –≤—Å—Ç—Ä–µ—á–∞—Ç—å –∫–∞–∂–¥–æ–≥–æ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —ç—Ç–∏–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º. –ö–Ω–æ–ø–∫–∏ –ø–æ–º–æ–≥—É—Ç –±—ã—Å—Ç—Ä–æ –Ω–∞—á–∞—Ç—å –¥–∏–∞–ª–æ–≥.',
      },
      kb_url: {
        title: 'üîó –î–æ–±–∞–≤–∏—Ç—å —Å—Å—ã–ª–∫—É –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π',
        why: '–°—Å—ã–ª–∫–∞ –ø–æ–∑–≤–æ–ª—è–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –±–µ–∑ —Ä—É—á–Ω–æ–≥–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è. –ü–æ–¥—Ö–æ–¥–∏—Ç –¥–ª—è —Å–∞–π—Ç–æ–≤, –ª–µ–Ω–¥–∏–Ω–≥–æ–≤ –∏ –æ–Ω–ª–∞–π–Ω-–¥–æ–∫—É–º–µ–Ω—Ç–æ–≤.',
        how: [
          '–í—Å—Ç–∞–≤—å—Ç–µ URL —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å https://).',
          '–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –ø—É–±–ª–∏—á–Ω–æ –¥–æ—Å—Ç—É–ø–Ω–∞ –±–µ–∑ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏.',
          '–ù–∞–∂–º–∏—Ç–µ ¬´–ó–∞–≥—Ä—É–∑–∏—Ç—å¬ª ‚Äî —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–≤–ª–µ—á—ë—Ç —Ç–µ–∫—Å—Ç.',
          '–ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π¬ª.',
        ],
        result: '–¢–µ–∫—Å—Ç —Å—Ç—Ä–∞–Ω–∏—Ü—ã –¥–æ–±–∞–≤–∏—Ç—Å—è –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π. –ë–æ—Ç —Å–º–æ–∂–µ—Ç –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç—Ç–æ–≥–æ –∫–æ–Ω—Ç–µ–Ω—Ç–∞.',
      },
      kb_add_flow: {
        title: 'üìö –ö–∞–∫ –¥–æ–±–∞–≤–∏—Ç—å –±–∞–∑—É –∑–Ω–∞–Ω–∏–π',
        why: '–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π ‚Äî —ç—Ç–æ –º–∞—Ç–µ—Ä–∏–∞–ª—ã, –∏–∑ –∫–æ—Ç–æ—Ä—ã—Ö –±–æ—Ç —á–µ—Ä–ø–∞–µ—Ç –æ—Ç–≤–µ—Ç—ã. –ß–µ–º –ø–æ–ª–Ω–µ–µ –±–∞–∑–∞ ‚Äî —Ç–µ–º —Ç–æ—á–Ω–µ–µ –±–æ—Ç.',
        how: [
          '–¢–µ–∫—Å—Ç ‚Äî –≤—Å—Ç–∞–≤—å—Ç–µ FAQ, –ø—Ä–∞–≤–∏–ª–∞, –æ–ø–∏—Å–∞–Ω–∏–µ —É—Å–ª—É–≥ –ø—Ä—è–º–æ –≤ –ø–æ–ª–µ.',
          '–§–∞–π–ª ‚Äî –∑–∞–≥—Ä—É–∑–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç (PDF, DOCX, TXT –¥–æ 20MB).',
          '–°—Å—ã–ª–∫–∞ ‚Äî –≤—Å—Ç–∞–≤—å—Ç–µ URL, –º—ã –ø—Ä–æ—á–∏—Ç–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.',
          '–ü–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–æ—Ç –ø–æ–∫–∞–∂–µ—Ç —Å—Ç–∞—Ç—É—Å: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è ‚Üí –ì–æ—Ç–æ–≤–æ.',
        ],
        result: '–ë–æ—Ç –Ω–∞—á–Ω—ë—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã–µ –º–∞—Ç–µ—Ä–∏–∞–ª—ã –ø—Ä–∏ –æ—Ç–≤–µ—Ç–∞—Ö –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã.',
      },
    };

    function showInfoPopover(key) {
      const c = INFO_CONTENT[key];
      if (!c) return;
      document.getElementById('ip-title').textContent = c.title;
      document.getElementById('ip-why').textContent = c.why;
      const howEl = document.getElementById('ip-how');
      howEl.innerHTML = c.how.map(s => `<li>${window.AppUI.escHtml(s)}</li>`).join('');
      document.getElementById('ip-result').textContent = c.result;
      const overlay = document.getElementById('info-popover-overlay');
      overlay.classList.add('visible');
      document.body.style.overflow = 'hidden';
    }

    function closeInfoPopover() {
      document.getElementById('info-popover-overlay').classList.remove('visible');
      document.body.style.overflow = '';
    }

    function _closeInfoPopoverOnBg(e) {
      if (e.target.id === 'info-popover-overlay') closeInfoPopover();
    }

    function openDesignV3Preview() {
      const target = `${window.location.origin}/kb-design-v3.html`;
      if (window.Telegram?.WebApp?.openLink) {
        window.Telegram.WebApp.openLink(target);
      } else {
        window.open(target, '_blank');
      }
    }

    function openProjectsUiV1() {
      localStorage.setItem('projects_ui_v1', '1');
      const u = new URL(window.location.href);
      u.searchParams.set('projects', '1');
      window.location.href = u.toString();
    }

    async function _bridgeOpenChatOs() {
      if (!window.resolvedUid) throw new Error('–°–Ω–∞—á–∞–ª–∞ –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å');
      if (!chatOsInitDone) {
        await initChatOnboarding(window.resolvedUid, null, false);
      } else {
        CHAT_OS.container.style.display = 'flex';
        const mainContent = document.getElementById('main-content');
        const sidebar = document.querySelector('.sidebar');
        if (mainContent) mainContent.style.display = 'none';
        if (sidebar) sidebar.style.display = 'none';
      }
    }

    // Bridge for kb-design-v3 iframe -> real app logic
    window.ChatOSBridge = {
      async sendMessage(text) {
        await _bridgeOpenChatOs();
        handleChatObSend(text || '');
        return true;
      },
      async openKbFile() {
        await _bridgeOpenChatOs();
        showKbAddPanel('kb-file');
        return true;
      },
      async openKbText() {
        await _bridgeOpenChatOs();
        showKbAddPanel('kb-text');
        return true;
      },
      async openKbLink() {
        await _bridgeOpenChatOs();
        showKbAddPanel('kb-link');
        return true;
      },
      async addKbText(text) {
        try {
          await addKbTextDirect(text || '');
          showToast('‚úÖ ' + I18n.t('textAdded'));
          return true;
        } catch (e) {
          showToast(e.message || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞');
          return false;
        }
      },
      async addKbLink(url) {
        try {
          const data = await addKbLinkDirect(url || '');
          showToast(`‚úÖ –°—Å—ã–ª–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞: ${data.title || data.url}`);
          return true;
        } catch (e) {
          showToast(e.message || '–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å—Å—ã–ª–∫–∏');
          return false;
        }
      },
      async openTelegram() {
        await _bridgeOpenChatOs();
        showTgInstructions();
        return true;
      },
      async openTestMode() {
        await _bridgeOpenChatOs();
        showTestModeEntry();
        return true;
      },
      async showKbStatus() {
        await _bridgeOpenChatOs();
        await showKbDebugInfo();
        return true;
      },
      async saveRules(text) {
        const ta = document.getElementById('rules-ta');
        if (!ta) return false;
        ta.value = text || '';
        await saveRules();
        return true;
      },
    };

    document.getElementById('info-popover-overlay')
      ?.addEventListener('click', _closeInfoPopoverOnBg);
  </script>

  <!-- ‚îÄ‚îÄ Info Popover (bottom sheet) ‚îÄ‚îÄ -->
  <div class="info-popover-overlay" id="info-popover-overlay">
    <div class="info-popover">
      <div class="ip-handle"></div>
      <div class="ip-header">
        <div class="ip-title" id="ip-title"></div>
        <button class="ip-close" onclick="closeInfoPopover()">√ó</button>
      </div>
      <div class="ip-section">
        <div class="ip-section-label">‚ñ∏ –ó–∞—á–µ–º —ç—Ç–æ –Ω—É–∂–Ω–æ</div>
        <div class="ip-section-body" id="ip-why"></div>
      </div>
      <hr class="ip-divider">
      <div class="ip-section">
        <div class="ip-section-label">‚ñ∏ –ö–∞–∫ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å</div>
        <div class="ip-section-body">
          <ol id="ip-how"></ol>
        </div>
      </div>
      <hr class="ip-divider">
      <div class="ip-section">
        <div class="ip-section-label">‚ñ∏ –ß—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç –ø–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è</div>
        <div class="ip-section-body" id="ip-result"></div>
      </div>
    </div>
  </div>
  <script>
    (function () {
      const qp = new URLSearchParams(window.location.search);
      const forcedOff = qp.get('projects') === '0';
      const enabled = !forcedOff;
      if (!enabled) return;

      if (!document.getElementById('projects-mode-force-hide-style')) {
        const st = document.createElement('style');
        st.id = 'projects-mode-force-hide-style';
        st.textContent = 'body.projects-mode .sidebar,body.projects-mode .main,body.projects-mode #main-content,body.projects-mode #onboarding-chat-overlay,body.projects-mode #mob-overlay,body.projects-mode .mob-cta{display:none !important;} body.projects-mode #projects-ui-root{display:block !important;position:fixed;inset:0;z-index:99999;background:#f6f7fb;}';
        document.head.appendChild(st);
      }
      document.body.classList.add('projects-mode');

      const root = document.getElementById('projects-ui-root');
      const onboarding = document.getElementById('onboarding-chat-overlay');
      const main = document.getElementById('main-content');
      const mainShell = document.querySelector('.main');
      const side = document.querySelector('.sidebar');
      const mob = document.getElementById('mob-overlay');
      const cta = document.querySelector('.mob-cta');
      if (onboarding) onboarding.style.display = 'none';
      if (main) main.style.display = 'none';
      if (mainShell) mainShell.style.display = 'none';
      if (side) side.style.display = 'none';
      if (mob) mob.style.display = 'none';
      if (cta) cta.style.display = 'none';
      root.style.display = 'block';
      root.innerHTML = '<div style="height:100vh;display:flex;align-items:center;justify-content:center;color:#6b7280;font:500 14px/1.4 Inter,sans-serif">–ó–∞–≥—Ä—É–∂–∞—é Projects...</div>';

      function loadScript(src) {
        return new Promise((resolve, reject) => {
          const s = document.createElement('script');
          const v = encodeURIComponent(window.BUILD_VERSION || 'dev');
          s.src = src + (src.includes('?') ? '&' : '?') + 'v=' + v;
          s.onload = () => resolve();
          s.onerror = () => reject(new Error(`Failed to load ${src}`));
          document.body.appendChild(s);
        });
      }

      function waitForProjectsAuth(timeoutMs = 12000) {
        return new Promise((resolve) => {
          try {
            if (window.firebase?.auth?.().currentUser) {
              resolve(true);
              return;
            }
            const started = Date.now();
            const unsub = window.firebase?.auth?.().onAuthStateChanged((u) => {
              if (u) {
                try { unsub && unsub(); } catch (_) { }
                resolve(true);
              }
            });
            const timer = setInterval(() => {
              if (window.firebase?.auth?.().currentUser) {
                clearInterval(timer);
                try { unsub && unsub(); } catch (_) { }
                resolve(true);
                return;
              }
              if (Date.now() - started >= timeoutMs) {
                clearInterval(timer);
                try { unsub && unsub(); } catch (_) { }
                resolve(false);
              }
            }, 180);
          } catch (_) {
            resolve(false);
          }
        });
      }

      (async () => {
        try {
          await loadScript('/js/projects-api.js');
          await loadScript('/js/projects-ui.js');
          if (!window.ProjectsUI) throw new Error('Projects UI module not loaded');
          // In Telegram Mini App auth can lag; wait for user token before mounting API-driven UI.
          await waitForProjectsAuth(12000);
          window.__projectsUiMounted = window.ProjectsUI.mount(root, {});
        } catch (e) {
          console.error('[ProjectsUI] init failed:', e);
          root.innerHTML = '<div style="height:100vh;display:flex;align-items:center;justify-content:center;color:#ef4444;font:600 14px/1.4 Inter,sans-serif">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å Projects UI. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.</div>';
        }
      })();
    })();
  </script>
  <script>document.addEventListener('DOMContentLoaded', function(){ if(typeof I18n !== 'undefined' && I18n.initPlaceholders) I18n.initPlaceholders(); });</script>
</body>

</html>
