# Roadmap: CreateBot AI (Projects Workspace)

## Цель продукта
Сделать рабочую веб-панель для создания и управления AI-ботами в формате **Проекты → Чаты / Источники / Настройки**, с подключением Telegram-бота, базой знаний и режимом оператора.

---

## Этап 0. Инициализация архитектуры
- [ ] Зафиксировать целевую структуру данных: `projects`, `project_sources`, `project_chats`, `messages`.
- [ ] Зафиксировать контракт API (REST): список endpoint-ов, входные/выходные поля, коды ошибок.
- [ ] Определить единый формат сущностей в UI (Project, Source, Chat, Message).
- [ ] Подготовить feature flags: `FORCE_PROJECTS_MAIN`, `projects_ui_v1`, `MINIAPP_IOS_FIX`.

## Этап 1. Базовый backend-контур (Cloud Functions + Firestore)
- [ ] Реализовать авторизованный вход в API по Firebase ID Token.
- [ ] Реализовать `GET /projects`.
- [ ] Реализовать `POST /projects`.
- [ ] Реализовать `GET /projects/:id`.
- [ ] Реализовать `PATCH /projects/:id`.
- [ ] Реализовать `DELETE /projects/:id`.
- [ ] Реализовать `GET /projects/:id/sources`.
- [ ] Реализовать `POST /projects/:id/sources`.
- [ ] Реализовать `DELETE /sources/:id`.
- [ ] Реализовать `GET /projects/:id/chats`.
- [ ] Реализовать `GET /chats/:id/messages`.

## Этап 2. Совместимость со старыми данными
- [ ] Реализовать `ensureDefaultProject(uid)` для lazy-миграции.
- [ ] При первом входе переносить legacy KB в `project_sources`.
- [ ] При первом входе переносить legacy chats/history в `project_chats/messages`.
- [ ] Добавить fallback-чтение legacy-коллекций, если новых данных нет.
- [ ] Зафиксировать метку миграции, чтобы не создавать default-project повторно.

## Этап 3. Защита от дублей и гонок
- [ ] Добавить idempotency для создания проекта через `requestId`.
- [ ] Сохранить `project_create_requests/{requestId}` и возвращать существующий проект при повторе.
- [ ] На frontend блокировать повторный submit во время `createInFlight`.
- [ ] Добавить защиту от race-condition при переключении проекта/вкладок (request sequence).

## Этап 4. Projects UI (frontend)
- [ ] Подключить отдельные модули `projects-api.js` и `projects-ui.js`.
- [ ] Реализовать левый sidebar: логотип, список проектов, кнопка «Новый проект».
- [ ] Реализовать модалку «Создать проект» (name + botHost + режим KB).
- [ ] Реализовать верхний хедер активного проекта (метаданные + быстрые действия).
- [ ] Реализовать переключение вкладок без reload: `Chats`, `Sources`, `Settings`.
- [ ] Реализовать empty states для отсутствующих данных.

## Этап 5. Вкладка Chats
- [ ] Подключить загрузку чатов по `projectId`.
- [ ] Добавить серверный поиск (`q`) и сортировку (`newest/oldest`).
- [ ] Реализовать пагинацию `limit + cursor`.
- [ ] Реализовать виртуализацию списка для больших объёмов.
- [ ] Реализовать переход в детальный диалог (`/chats/:id/messages`).

## Этап 6. Вкладка Sources (база знаний)
- [ ] Подключить получение источников по `projectId`.
- [ ] Реализовать поиск и фильтрацию по типу (`file|url|text|document`).
- [ ] Реализовать добавление источников (текст, URL, файл).
- [ ] Для файлов реализовать локальное извлечение текста (TXT/PDF/DOCX/PPTX).
- [ ] Реализовать удаление источника и обновление счётчиков проекта.
- [ ] Отображать статусы обработки источника (`pending|ready|error`).

## Этап 7. Вкладка Settings
- [ ] Реализовать редактирование названия проекта.
- [ ] Реализовать редактирование `IP/домен/Telegram token`.
- [ ] Реализовать редактирование `instructions` (system behavior).
- [ ] Реализовать удаление проекта с confirm-модалкой.
- [ ] Добавить переименование/шаринг/удаление проекта через контекстное меню в sidebar.

## Этап 8. Интеграция Telegram
- [ ] Реализовать backend-проверку токена (`verifyTelegramToken`).
- [ ] Реализовать backend-регистрацию webhook (`registerWebhook`).
- [ ] При сохранении token в Settings автоматически подключать Telegram-бота.
- [ ] Обновлять проект метаданными подключения (`telegramConnected`, `telegramUsername`, `telegramBotId`).
- [ ] В `telegramWebhook` маршрутизировать апдейты в нужный `uid/botId`.

## Этап 9. AI-слой и ответы бота
- [ ] Реализовать backend-прокси вызовов AI (`aiChat`, `generateAnswer`).
- [ ] Реализовать выбор провайдера (OpenAI/Gemini/Claude).
- [ ] Реализовать логику prompt + KB контекст + правила.
- [ ] Реализовать автоответы по ключевым словам до вызова AI.
- [ ] Реализовать сохранение истории сообщений и usage-метрик.

## Этап 10. Telegram Mini App UX
- [ ] Инициализировать Telegram WebApp (`ready`, `expand`).
- [ ] Реализовать управление высотой через `viewportHeight/viewportStableHeight`.
- [ ] Ввести `--app-height` и ограничить скролл страницы (`body overflow hidden`).
- [ ] Скролл оставить только внутри контентных областей.
- [ ] Учесть safe-area (`env(safe-area-inset-*)`).
- [ ] На iOS исключить auto-zoom у input/textarea/select (font-size ≥ 16px).

## Этап 11. Производительность и устойчивость
- [ ] Добавить клиентский кеш GET-ответов (TTL).
- [ ] Инвалидировать кеш после мутаций.
- [ ] Ограничить запросы (`limit`) во всех больших списках.
- [ ] Добавить Firestore composite indexes под сортировки и поиск.
- [ ] Денормализовать счётчики `sourcesCount/chatsCount` в проект.
- [ ] Очистить/останавливать realtime listeners при logout/screen switch/unload.

## Этап 12. Режимы интерфейса и миграция UX
- [ ] Включить Projects UI как основной режим по флагу.
- [ ] Сохранить возможность мягкого отката на legacy UI (`?projects=0`).
- [ ] Удалить дублирующие действия в UI (например, `Add Knowledge` vs `Добавить источник`).
- [ ] Упростить хедер и навигацию для одного очевидного сценария работы.

## Этап 13. Контент и продуктовая логика
- [ ] Подготовить дефолтные инструкции бота для новых проектов.
- [ ] Подготовить сценарий первого запуска: создание проекта → подключение Telegram → добавление KB.
- [ ] Подготовить подсказки в empty states для ускорения онбординга.
- [ ] Подготовить интерфейс управления человеческим оператором (handoff mode).

## Этап 14. Финализация рабочего продукта
- [ ] Пройти весь пользовательский поток вручную: создать проект, подключить Telegram, добавить KB, получить сообщение от клиента, ответить.
- [ ] Проверить, что legacy-пользователь открывает default-project без потери данных.
- [ ] Проверить, что новые проекты не дублируются при нестабильной сети.
- [ ] Подготовить короткую пользовательскую документацию внутри интерфейса (tooltip/help).

---

## Результат после выполнения roadmap
- [ ] Рабочая панель управления ботами в формате Projects Workspace.
- [ ] Корректная работа чатов, источников и настроек без перезагрузки страницы.
- [ ] Telegram-бот подключается и начинает обрабатывать сообщения из одного интерфейса.
- [ ] Legacy-данные и новые проекты работают в единой модели без потерь.
