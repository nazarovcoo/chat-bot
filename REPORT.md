# Knowledge Base Panel MVP (v1)

## Что было сделано

1. **Backend (Metadata Writer)**:
   - В функции `chatOsHandler` (внутри `functions/index.js`), когда успешно отправляются файлы или добавляется текст через вызов инструмента `add_knowledge`, мы теперь **параллельно** записываем читабельные метаданные в подколлекцию `knowledge_items`.
   - **Путь:** `users/{uid}/bots/{botId}/knowledge_items/{itemId}`
   - Эта коллекция специально спроектирована для Frontend UI, чтобы не трогать и не ломать старую логику RAG: `knowledge_base`. Запросы RAG и векторный поиск не пострадают, так как они читают только то, что им нужно. Добавлено поле `status: "active"`.

2. **Frontend UI (Chat OS)**:
   - В `admin.html` добавлена кнопка «База знаний» в шапку (#onboarding-chat-overlay).
   - При клике плавно выезжает Drawer-панель (#kb-drawer) с бекдропом (#kb-backdrop).
   - Добавлена функция `loadKBList(botId)`, которая делает легкий Firebase запрос к `knowledge_items` со статусом `active` и рисует список документов, файлов и картинок с датой и размером.
   - Для каждого элемента есть кнопки **Открыть** (в новой вкладке) и **Удалить** (soft-delete, только обновляет `status = "deleted"` в базе, что скроет его из UI, но оставит физически, чтобы не ломать логику бэкенда).

## Как тестировать

1. Зайдите в проект, откройте сайт. В полноэкранном чате-настройщике должна быть видна новая кнопка «База знаний» сверху рядом с крестиком и кнопкой «Очистить чат».
2. Закиньте любой файл (картинку / ПДФ) или напишите ИИ "Добавь в базу знаний следующий факт: [ваша фраза]".
3. Нажмите кнопку «База знаний» в шапке. Откроется панель с вашим новым документом.
4. Нажмите «Открыть», чтобы убедиться, что файл скачивается/открывается.
5. Нажмите «Удалить» — элемент должен исчезнуть.

## Как откатить (Rollback)

Если возникнут проблемы:
1. Восстановите предыдущую версию `deploy/admin.html` и задеплойте Firebase (`firebase deploy --only hosting`).
2. В Firebase Functions (`index.js`) удалите строчки с `// Parallel write to unified knowledge_items for frontend UI` и задеплойте снова (`firebase deploy --only functions`).
3. Новая подколлекция `knowledge_items` не помешает старым скриптам. Ее можно просто оставить или удалить вручную в консоли Firestore.

*Комиты не были выполнены через агента, так как рабочая папка не является GIT репозиторием. Все изменения сохранены в файлах рабочей директории и отправлены в хостинг.*
